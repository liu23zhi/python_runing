# 代码审查发现的问题汇总

## 安全问题（高优先级）🔴

### 1. 密码明文存储（严重）
- **位置**: main.py 行999
- **问题**: 默认配置使用plaintext存储密码
- **风险**: 数据库或文件泄露导致密码直接暴露
- **修复**: 强制使用encrypted模式，或更改默认值

### 2. SHA256不加盐（严重）
- **位置**: main.py 行1009
- **问题**: 密码哈希未使用salt，同密码同哈希
- **风险**: 彩虹表攻击可快速反查密码
- **修复**: 使用bcrypt或argon2，自动处理盐值
- **代码示例**:
```python
import bcrypt
hashed = bcrypt.hashpw(password.encode(), bcrypt.gensalt())
bcrypt.checkpw(password.encode(), hashed)  # 验证
```

### 3. 时序攻击风险（中等）
- **位置**: main.py 行1020, 1025
- **问题**: 使用==比较字符串，时间与内容相关
- **风险**: 攻击者可通过响应时间推测密码
- **修复**: 使用secrets.compare_digest()
```python
import secrets
result = secrets.compare_digest(hash1, hash2)
```

### 4. Session存储无过期（中等）
- **位置**: main.py 行832-834
- **问题**: 会话文件永久保留，无自动清理
- **风险**: 旧会话可能被利用，磁盘空间占用
- **修复**: 实现会话过期机制和定期清理

### 5. 日志无限增长（低）
- **位置**: main.py 行1044
- **问题**: login_history.jsonl无轮转机制
- **风险**: 磁盘空间耗尽
- **修复**: 使用RotatingFileHandler

### 6. 敏感信息明文记录（低）
- **位置**: main.py 行1032-1040
- **问题**: 登录日志包含用户名、IP等敏感信息
- **风险**: 日志泄露导致隐私暴露
- **修复**: 敏感字段脱敏或加密

## 代码质量问题 🟡

### 7. hashlib重复导入
- **位置**: main.py 行12, 31
- **问题**: 同一模块导入两次
- **影响**: 代码冗余，违反PEP8
- **修复**: 删除第31行

### 8. Semaphore性能问题
- **位置**: main.py 行909
- **问题**: 使用Semaphore(1)代替Lock
- **影响**: 性能略差（虽然功能相同）
- **修复**: 
```python
self.lock = threading.Lock()
```

### 9. 距离计算精度问题
- **位置**: main.py 行3987
- **问题**: 简化公式假设平面，大距离误差大
- **影响**: >100km误差显著，极地区域不适用
- **修复**: 使用Haversine公式（见注释中的代码）

### 10. 经度系数假设纬度
- **位置**: main.py 行3987, 3992
- **问题**: 102834.74基于纬度30度
- **影响**: 其他纬度有偏差（赤道111km，高纬度更小）
- **修复**: 根据实际纬度动态计算系数
```python
meters_per_degree_lon = 111320 * cos(radians(lat))
```

### 11. 嵌套循环性能
- **位置**: main.py 行4019-4044
- **问题**: 三层循环处理路径，复杂度高
- **影响**: 超长路径（>1000点）可能卡顿
- **修复**: 分段处理或使用numpy向量化

### 12. 速度随机可能异常
- **位置**: main.py 行4022-4023
- **问题**: 速度完全随机，可能突变
- **影响**: 轨迹看起来不自然
- **修复**: 添加速度平滑算法（移动平均）

## 统计

| 类别 | 数量 | 严重度分布 |
|------|------|-----------|
| 安全问题 | 6 | 高:2, 中:2, 低:2 |
| 质量问题 | 6 | 中:5, 低:1 |
| **总计** | **12** | - |

## 优先级修复顺序

1. 🔴 问题#2: SHA256加盐（30分钟）
2. 🔴 问题#1: 强制加密（10分钟）
3. 🟡 问题#3: 时序攻击（15分钟）
4. 🟡 问题#4: Session过期（1小时）
5. 🟢 问题#7: 删除重复导入（1分钟）
6. 🟢 问题#8: 改用Lock（1分钟）
