# 后台任务执行功能说明

## 功能概述

本系统实现了服务器端后台任务执行功能，允许用户在关闭浏览器后，任务仍在服务器端持续执行。

## 核心特性

### 1. 服务器端执行
- ✅ 任务在服务器端的 Playwright Chrome 中执行
- ✅ 不依赖前端浏览器，避免前端干扰
- ✅ 使用无头Chrome模式，提高执行效率

### 2. 持久化进度
- ✅ 任务进度实时保存到磁盘
- ✅ 支持跨浏览器会话恢复
- ✅ 每5秒自动保存一次状态

### 3. 进度追踪
任务状态包含以下信息：
- 总任务数 (total_tasks)
- 已完成任务数 (completed_tasks)
- 总进度百分比 (progress_percent)
- 当前任务进度 (current_task_progress)
- 任务状态 (status: running/completed/stopped/error)

### 4. 前端监控
- ✅ 每3秒自动轮询任务状态
- ✅ 实时更新进度条和统计信息
- ✅ 页面重新加载后自动恢复监控

## 使用方法

### 1. 启动后台任务

#### 在单账号模式下：
1. 登录账号
2. 在任务列表中选择任务
3. （可选）勾选"忽略已完成状态"和"自动生成路径"
4. 点击 **"后台执行所有"** 按钮

#### 操作说明：
- 系统会自动筛选符合条件的任务（未过期、未开始的任务会被跳过）
- 如果勾选"自动生成路径"，系统会为没有路径的任务自动规划路线
- 任务将在服务器端按顺序执行

### 2. 监控进度

启动后台任务后，界面会显示：

```
┌─────────────────────────────────┐
│      后台任务进度               │
├─────────────────────────────────┤
│ 已完成: 2 / 4                   │
│ 总进度: 50%                     │
│ 当前任务: 75%                   │
│ ▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░            │
└─────────────────────────────────┘
```

### 3. 关闭浏览器

- ✅ 可以安全关闭浏览器
- ✅ 任务继续在服务器端执行
- ✅ 进度自动保存到磁盘

### 4. 重新打开浏览器

1. 打开原来的URL（包含UUID的地址）
2. 系统自动检测后台任务
3. 恢复进度显示和监控
4. 查看更新后的进度（如：已完成 2/4 → 3/4）

### 5. 停止后台任务

如需停止正在执行的后台任务：
1. 点击 **"停止后台任务"** 按钮
2. 系统会停止当前任务的执行
3. 已完成的任务不受影响

## 技术实现

### 后端架构

#### BackgroundTaskManager (main.py)
```python
class BackgroundTaskManager:
    - save_task_state()      # 保存任务状态到文件
    - load_task_state()      # 从文件加载任务状态
    - start_background_task() # 启动后台任务
    - _execute_tasks_background() # 后台执行线程
    - get_task_status()      # 查询任务状态
    - stop_task()            # 停止任务
    - cleanup_old_tasks()    # 清理旧任务文件
```

#### API接口
- `POST /api/background_task/start`
  - 请求参数: `{task_indices: [0,1,2], auto_generate: true}`
  - 返回: `{success: true, message: "..."}`

- `GET /api/background_task/status`
  - 返回: `{success: true, task_status: {...}}`

- `POST /api/background_task/stop`
  - 返回: `{success: true, message: "..."}`

#### 数据持久化
- 任务状态保存在 `background_tasks/` 目录
- 文件名为 session_id 的 SHA256 哈希值
- 格式为 JSON，包含完整的任务状态信息

### 前端架构

#### UI组件 (index.html)
```html
<button id="start-background-button">后台执行所有</button>
<button id="stop-background-button">停止后台任务</button>

<div id="background-task-status">
  <!-- 进度显示 -->
</div>
```

#### JavaScript函数
```javascript
startBackgroundTasks()      // 启动后台任务
stopBackgroundTasks()       // 停止后台任务
pollBackgroundTaskStatus()  // 轮询任务状态
checkBackgroundTaskOnLoad() // 页面加载时检查任务
```

## 工作流程示例

### 场景：执行4个任务

#### 时间点 T0 (初始状态)
```
用户操作：
1. 打开页面，登录账号
2. 选择4个任务
3. 点击"后台执行所有"

系统状态：
- 总任务: 4
- 已完成: 0
- 总进度: 0%
- 当前任务进度: 10%
```

#### 时间点 T1 (关闭浏览器，N分钟后)
```
后台执行：
- 任务1: 已完成 ✓
- 任务2: 已完成 ✓  
- 任务3: 执行中...
- 任务4: 等待中

系统状态：
- 总任务: 4
- 已完成: 2
- 总进度: 50%
- 当前任务进度: 20%
```

#### 时间点 T2 (重新打开浏览器)
```
用户操作：
1. 打开原URL
2. 页面自动恢复监控

显示状态：
- 总任务: 4
- 已完成: 2
- 总进度: 50%
- 当前任务进度: 20%
```

#### 时间点 T3 (所有任务完成)
```
最终状态：
- 总任务: 4
- 已完成: 4
- 总进度: 100%
- 当前任务进度: 100%

系统提示："后台任务全部完成！"
```

## 注意事项

### 1. 会话管理
- ⚠️ 必须使用包含UUID的URL访问
- ⚠️ 不要清除浏览器Cookie（非游客用户需要auth_token）
- ⚠️ 建议收藏或保存带UUID的URL

### 2. 服务器要求
- ✅ 服务器必须持续运行
- ✅ 需要足够的系统资源（内存、CPU）
- ✅ 确保网络连接稳定

### 3. 任务限制
- 每个用户的后台任务是独立的
- 任务按顺序执行（不并行）
- 如果某个任务失败，会继续执行下一个任务

### 4. 数据清理
- 系统自动清理24小时前的旧任务文件
- 可通过 `cleanup_old_tasks()` 方法手动清理

## 故障排查

### 问题1：后台任务没有执行
**可能原因：**
- 服务器未运行或重启
- 任务路径未生成
- 网络连接问题

**解决方法：**
1. 检查服务器日志
2. 确认任务是否有路径
3. 勾选"自动生成路径"重试

### 问题2：进度不更新
**可能原因：**
- 浏览器到服务器的连接断开
- session_id 无效

**解决方法：**
1. 刷新页面
2. 检查URL中的UUID是否正确
3. 重新登录

### 问题3：无法恢复进度
**可能原因：**
- URL中的UUID丢失
- 服务器重启后任务状态文件丢失

**解决方法：**
1. 使用原始的带UUID的URL
2. 检查 `background_tasks/` 目录是否存在
3. 查看服务器日志

## 开发说明

### 添加新功能
1. 在 `BackgroundTaskManager` 类中添加方法
2. 在 Flask 中添加对应的API路由
3. 在前端添加调用代码

### 调试技巧
```python
# 启用详细日志
logging.basicConfig(level=logging.DEBUG)

# 查看后台任务状态
import json
with open('background_tasks/<hash>.json', 'r') as f:
    print(json.dumps(json.load(f), indent=2))
```

### 性能优化
- 调整状态保存频率（默认每5秒）
- 调整前端轮询间隔（默认3秒）
- 限制并发后台任务数量

## 版本历史

### v1.0 (Current)
- ✅ 基础后台任务执行
- ✅ 进度持久化
- ✅ 前端监控
- ✅ 自动恢复

### 未来计划
- [ ] 支持任务优先级
- [ ] 支持并行执行多个任务
- [ ] 添加邮件/推送通知
- [ ] 任务执行历史记录
- [ ] 更详细的错误报告

## 许可证

本功能遵循项目主许可证。
