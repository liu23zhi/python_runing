# 系统架构图

## Web模式工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户浏览器                                │
│                                                                 │
│  1. 访问: http://localhost:5000/                                │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Flask Web服务器                             │
│                                                                 │
│  2. 检查 session['uuid']                                         │
│     ├─ 无UUID → 生成新的 (uuid.uuid4())                         │
│     └─ 有UUID → 使用现有的                                       │
│                                                                 │
│  3. 重定向到: http://localhost:5000/uuid=abc123...              │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      UUID会话管理                                │
│                                                                 │
│  active_sessions = {                                            │
│      "abc123...": {                                             │
│          "api": <Api实例>,                                      │
│          "data": { 用户数据 }                                   │
│      },                                                         │
│      "def456...": {                                             │
│          "api": <Api实例>,                                      │
│          "data": { 用户数据 }                                   │
│      }                                                          │
│  }                                                              │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      渲染 index.html                             │
│                                                                 │
│  4. 注入 SESSION_UUID 到页面                                     │
│     <script>                                                    │
│       window.SESSION_UUID = "abc123...";                        │
│     </script>                                                   │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                   JS 调用 Python API                             │
│                                                                 │
│  5. fetch('/api/login', {                                       │
│       method: 'POST',                                           │
│       body: JSON.stringify({...})                               │
│     })                                                          │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 代理层                                  │
│                                                                 │
│  6. 验证 session['uuid']                                         │
│  7. 从 active_sessions 获取对应的 API 实例                        │
│  8. 调用 api.login(username, password)                          │
│  9. 返回 JSON 结果                                               │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Python 后端                                 │
│                                                                 │
│  10. 处理业务逻辑                                                │
│  11. 调用外部API                                                │
│  12. 返回结果                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## JS引擎选择

### 选项1: Pywebview (默认)

```
┌─────────────────────────────────────────────────────────────────┐
│                      Flask服务器                                 │
│                     (端口 5000)                                  │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                 隐藏的 Pywebview 窗口                            │
│                  (JS 执行引擎)                                   │
│                                                                 │
│  - 轻量级                                                       │
│  - 无需额外依赖                                                 │
│  - 适合本地开发                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 选项2: Chrome/Chromium (推荐生产)

```
┌─────────────────────────────────────────────────────────────────┐
│                      Flask服务器                                 │
│                     (端口 5000)                                  │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                 Selenium WebDriver                               │
│                        ↓                                         │
│              无头 Chrome 浏览器                                  │
│                  (JS 执行引擎)                                   │
│                                                                 │
│  - 更稳定可靠                                                   │
│  - 真实浏览器环境                                               │
│  - 适合生产部署                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 多用户并发场景

```
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  用户A浏览器  │      │  用户B浏览器  │      │  用户C浏览器  │
│              │      │              │      │              │
│ uuid=aaa...  │      │ uuid=bbb...  │      │ uuid=ccc...  │
└──────┬───────┘      └──────┬───────┘      └──────┬───────┘
       │                     │                     │
       └─────────────────────┼─────────────────────┘
                             │
                             ▼
                   ┌──────────────────┐
                   │  Flask Web服务器  │
                   │                  │
                   │  多线程处理请求   │
                   └────────┬─────────┘
                            │
                ┌───────────┼───────────┐
                │           │           │
                ▼           ▼           ▼
         ┌──────────┐ ┌──────────┐ ┌──────────┐
         │ Session A│ │ Session B│ │ Session C│
         │          │ │          │ │          │
         │ 独立数据 │ │ 独立数据 │ │ 独立数据 │
         └──────────┘ └──────────┘ └──────────┘

特点:
- 每个用户有独立的UUID
- 数据完全隔离
- 一个用户卡顿不影响其他用户
- 支持同时多人使用
```

## 会话持久化

```
第一次访问:
┌─────────────────────────────────────────────────────────────────┐
│ 1. 用户访问 http://localhost:5000/                              │
│ 2. 系统生成 UUID: abc123...                                     │
│ 3. 重定向到 http://localhost:5000/uuid=abc123...               │
│ 4. 用户进行操作，数据保存在 active_sessions["abc123..."]       │
└─────────────────────────────────────────────────────────────────┘

关闭浏览器

再次访问:
┌─────────────────────────────────────────────────────────────────┐
│ 1. 用户直接访问 http://localhost:5000/uuid=abc123...           │
│ 2. 系统检查 active_sessions["abc123..."]                       │
│ 3. 如果存在，恢复之前的数据                                     │
│ 4. 如果不存在（服务器重启），创建新会话                         │
└─────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
python_runing/
├── main.py                      # 主程序
├── web_mode.py                  # Web模式实现
├── index.html                   # 前端页面
├── requirements.txt             # 依赖列表
│
├── 文档/
│   ├── README_WEB_MODE.md       # Web模式详细文档
│   ├── QUICKSTART.md            # 快速开始指南
│   ├── IMPLEMENTATION_SUMMARY.md # 实现总结
│   ├── CHANGELOG.md             # 更新日志
│   └── ARCHITECTURE.md          # 本文件
│
├── 工具/
│   ├── examples.py              # 使用示例
│   └── test_web_mode.py         # 测试套件
│
└── build.bat                    # 构建脚本
```

## 数据流向

```
┌─────────┐  HTTP请求   ┌────────┐  方法调用  ┌──────────┐
│ 浏览器   │ ────────→  │ Flask  │ ────────→ │ Python   │
│         │             │ 路由   │            │ API      │
│         │ ←──────── │        │ ←──────── │          │
└─────────┘  JSON响应   └────────┘  返回结果  └──────────┘
     ↑                       │                      │
     │                       ▼                      ▼
     │              ┌──────────────┐      ┌──────────────┐
     │              │ 会话管理      │      │ 外部API      │
     │              │ (UUID)       │      │ (服务器)     │
     │              └──────────────┘      └──────────────┘
     │
     └── JS引擎 (Pywebview 或 Chrome)
```

## 安全边界

```
┌─────────────────────────────────────────────────────────────────┐
│                        互联网                                    │
└───────────────────────┬─────────────────────────────────────────┘
                        │ HTTPS (建议)
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Nginx 反向代理                               │
│                  (认证, 限流, 缓存)                              │
└───────────────────────┬─────────────────────────────────────────┘
                        │ HTTP
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Flask 应用                                   │
│                  (UUID验证, 会话管理)                            │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Python 后端                                  │
│                  (业务逻辑, 数据处理)                            │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                     外部服务                                     │
│                  (API, 数据库等)                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 扩展性

### 横向扩展 (多实例)

```
                    ┌─────────────┐
                    │  负载均衡器  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Flask实例 1   │  │ Flask实例 2   │  │ Flask实例 3   │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         │
                         ▼
                ┌─────────────────┐
                │  Redis (共享)    │
                │  会话存储        │
                └─────────────────┘
```

### 纵向扩展 (功能模块)

```
┌─────────────────────────────────────────────────────────────────┐
│                         Web层                                    │
│                   (Flask + UUID管理)                             │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       业务逻辑层                                  │
│              (用户管理, 任务处理, 数据分析)                       │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据访问层                                  │
│              (数据库, 缓存, 外部API)                              │
└─────────────────────────────────────────────────────────────────┘
```

---

这个架构设计具有:
- ✅ 高可用性
- ✅ 可扩展性
- ✅ 安全性
- ✅ 易维护性
