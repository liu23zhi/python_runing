# 短信测试功能说明文档

## 功能概述

在管理面板的短信配置中新增了"测试发送"功能，允许管理员向指定手机号发送测试短信，验证短信服务配置是否正确。

## 功能位置

**路径：** 管理面板 → 短信配置 → 操作区 → 🧪 测试发送

## UI界面展示

### 1. 短信配置面板 - 测试按钮位置

```
┌──────────────────────────────────────────────────────┐
│  📱 短信服务配置                            [刷新]   │
├──────────────────────────────────────────────────────┤
│                                                      │
│  [功能开关配置区]                                    │
│  [短信宝配置区]                                      │
│  [速率限制配置区]                                    │
│  [Webhook配置区]                                     │
│                                                      │
│  ┌────────────────────────────────────────────────┐ │
│  │ 操作区                                         │ │
│  ├────────────────────────────────────────────────┤ │
│  │ [ 💰 查询余额 ]  [ 💾 保存配置 ]               │ │
│  ├────────────────────────────────────────────────┤ │
│  │ [ 📋 短信发送历史 ] [ 🔑 验证码管理 ]          │ │
│  │ [ 🧪 测试发送 ] ← ← ← 新增的测试按钮           │ │
│  └────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
```

### 2. 测试发送模态对话框

```
┌────────────────────────────────────────────────┐
│  🧪 短信测试发送                    [×]       │
├────────────────────────────────────────────────┤
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │ 💡 功能说明：                            │ │
│  │ • 此功能用于测试短信配置是否正确         │ │
│  │ • 系统将向指定手机号发送随机验证码       │ │
│  │ • 验证码将同时显示在界面上，便于验证     │ │
│  │ • 测试记录会保存在短信发送历史中         │ │
│  └──────────────────────────────────────────┘ │
│                                                │
│  📱 目标手机号                                 │
│  ┌──────────────────────────────────────────┐ │
│  │ 请输入要测试的手机号（11位）...          │ │
│  └──────────────────────────────────────────┘ │
│  ⚠️ 请输入真实有效的手机号，确保能收到短信  │
│                                                │
│  [隐藏状态：测试结果显示区]                   │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │          [ 取消 ]  [ 📤 发送测试短信 ]    │ │
│  └──────────────────────────────────────────┘ │
│                                                │
│  测试记录会自动保存到"短信发送历史"中        │
└────────────────────────────────────────────────┘
```

### 3. 测试成功后的结果显示

```
┌────────────────────────────────────────────────┐
│  🧪 短信测试发送                    [×]       │
├────────────────────────────────────────────────┤
│                                                │
│  [功能说明区域...]                             │
│                                                │
│  📱 目标手机号                                 │
│  ┌──────────────────────────────────────────┐ │
│  │ 13800138000                              │ │
│  └──────────────────────────────────────────┘ │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │ ✅ 测试短信发送成功！                     │ │
│  │                                          │ │
│  │ 验证码：  123456  ← 大号显示             │ │
│  │ 手机号：  13800138000                    │ │
│  │                                          │ │
│  │ 💡 请检查手机是否收到包含上述验证码       │ │
│  │    的短信。如果收到，说明短信配置正确。   │ │
│  └──────────────────────────────────────────┘ │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │          [ 取消 ]  [ ✓ 已发送 ]          │ │
│  └──────────────────────────────────────────┘ │
└────────────────────────────────────────────────┘
```

## 使用步骤

### 步骤 1：打开测试对话框
1. 以管理员身份登录系统
2. 点击右上角头像 → "管理面板"
3. 切换到"短信配置"标签页
4. 滚动到底部的"操作区"
5. 点击 **🧪 测试发送** 按钮

### 步骤 2：输入手机号
1. 在"目标手机号"输入框中输入11位手机号
2. 确保手机号格式正确（1开头，共11位数字）

### 步骤 3：发送测试短信
1. 点击 **📤 发送测试短信** 按钮
2. 等待发送（按钮显示"发送中..."）
3. 发送成功后，验证码会显示在界面上

### 步骤 4：验证短信
1. 检查手机是否收到短信
2. 对比短信中的验证码与界面显示的验证码
3. 如果一致，说明短信配置正确

## 短信内容格式

测试短信的内容格式为：
```
【电科大跑步助手】【测试短信】您的验证码是：123456，5分钟内有效。这是一条测试短信。
```

其中：
- `【电科大跑步助手】` - 短信签名（可配置）
- `【测试短信】` - 标记这是测试短信
- `123456` - 随机生成的6位验证码
- `5分钟` - 验证码有效期（可配置）

## 技术实现

### 后端API

**端点：** `POST /api/sms/test_send`

**权限：** 仅管理员可访问

**请求参数：**
```json
{
  "phone": "13800138000"
}
```

**响应成功：**
```json
{
  "success": true,
  "message": "测试短信发送成功！验证码：123456",
  "code": "123456",
  "phone": "13800138000"
}
```

**响应失败：**
```json
{
  "success": false,
  "message": "发送失败：余额不足"
}
```

### 前端函数

- **openSMSTestModal()** - 打开测试对话框
- **closeSMSTestModal()** - 关闭测试对话框  
- **sendTestSMS()** - 发送测试短信

## 功能特性

### ✅ 安全性
- **权限控制**：仅管理员可使用
- **手机号验证**：严格验证手机号格式
- **错误处理**：完善的异常处理机制

### ✅ 易用性
- **清晰提示**：详细的功能说明
- **即时反馈**：验证码立即显示
- **状态指示**：按钮状态实时更新

### ✅ 可追溯性
- **历史记录**：测试记录保存到短信发送历史
- **场景标记**：标记为 `admin_test` 便于筛选
- **完整信息**：记录时间、IP、验证码等信息

## 常见问题

### Q1: 点击测试按钮没反应？
**A:** 请确认：
1. 已保存短信配置（用户名、API Key、签名）
2. 短信服务已启用（主开关打开）
3. 当前用户是管理员身份

### Q2: 提示"余额不足"？
**A:** 请登录短信宝官网充值，或使用"查询余额"按钮检查账户余额。

### Q3: 手机收不到短信？
**A:** 请检查：
1. 手机号输入是否正确
2. 短信签名是否已在短信宝审核通过
3. 手机是否有信号/是否欠费
4. 短信是否被拦截（查看垃圾短信）

### Q4: 验证码显示但手机未收到？
**A:** 可能原因：
1. 运营商延迟（稍等1-2分钟）
2. 手机信号问题
3. 号码被运营商标记为停机
4. 查看短信宝后台是否有错误记录

### Q5: 在哪里查看测试记录？
**A:** 点击"📋 短信发送历史"按钮，筛选场景为 `admin_test` 的记录。

## 注意事项

1. **测试会消耗短信条数**：每次测试会扣除1条短信费用
2. **不要频繁测试**：避免浪费短信条数和骚扰用户
3. **使用真实手机号**：确保能收到短信进行验证
4. **检查配置完整性**：发送前确保用户名、API Key、签名都已配置

## 更新日志

### v1.0.0 (2025-11-16)
- ✅ 初始版本发布
- ✅ 支持发送测试短信到指定手机号
- ✅ 界面显示验证码便于验证
- ✅ 测试记录保存到历史
- ✅ 完整的错误处理和提示

---

**开发者：** GitHub Copilot  
**日期：** 2025-11-16  
**版本：** 1.0.0
