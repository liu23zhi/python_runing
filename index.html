<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <script>
      function handleCdnError(resourceName) {
        resourceName = resourceName || "未指定";
        cdnErrorCount++;
        console.warn(
          "CDN资源[" + resourceName + "]加载失败 (" + cdnErrorCount + "/3)"
        );

        if (cdnErrorTimer) {
          clearTimeout(cdnErrorTimer);
        }

        cdnErrorTimer = setTimeout(function () {
          if (!appInitialized && cdnErrorCount > 0) {
            var errorOverlay = document.getElementById("cdn-error-overlay");
            if (errorOverlay) {
              errorOverlay.style.display = "flex";
              errorOverlay.classList.remove("hidden");
              console.error(
                "应用初始化超时，CDN资源加载失败，已显示错误提示。"
              );
            }
          }
        }, 3000);
      }
      // 新增：返回管理员会话逻辑
      function returnToAdminSession() {
        const originSession = localStorage.getItem("admin_return_origin");
        if (originSession) {
          // 清除记录并跳转回原会话
          localStorage.removeItem("admin_return_origin");
          window.location.href = `/uuid=${originSession}`;
        } else {
          // 异常情况，回首页
          window.location.href = "/";
        }
      }

      // 新增：检查是否需要显示返回按钮
      function checkAdminReturnState() {
        const originSession = localStorage.getItem("admin_return_origin");
        const overlay = document.getElementById("admin-return-overlay");

        logMessage_Info(
          "[上帝模式] 检查管理员返回按钮显示状态，来源会话UUID：" +
            originSession
        );
        logMessage_Info("[上帝模式] 当前页面URL：" + window.location.pathname);

        if (!overlay) return;

        // 从URL提取当前UUID，确保比对准确
        const match = window.location.pathname.match(/\/uuid=([a-f0-9-]{36})/i);
        const currentUUID = match ? match[1] : null;

        // 只有当存在来源记录，且当前页面UUID与来源UUID不一致时才显示
        if (
          originSession &&
          currentUUID &&
          originSession !== currentUUID &&
          originSession !== "null" &&
          originSession !== "undefined" &&
          originSession !== "" &&
          originSession !== "NaN"
        ) {
          overlay.classList.remove("hidden");
          console.log("[上帝模式] 检测到管理员查看他人会话，显示返回按钮");
          // 初始化拖拽功能
          initDraggableAdminBtn();
        } else {
          overlay.classList.add("hidden");
          // 修正：如果当前就在来源会话（管理员自己的会话），则清理掉localStorage标记
          // 防止脏数据导致逻辑混乱
          if (originSession && currentUUID && originSession === currentUUID) {
            localStorage.removeItem("admin_return_origin");
            console.log(
              "[上帝模式] 检测到已位于管理员原会话，自动清除返回记录"
            );
          }
        }
      }

      // 新增：使管理员按钮可拖拽
      function initDraggableAdminBtn() {
        const overlay = document.getElementById("admin-return-overlay");
        const btn = document.getElementById("admin-return-btn");
        if (!overlay || !btn || overlay.dataset.initDrag) return;

        overlay.dataset.initDrag = "true"; // 防止重复绑定

        let isDragging = false;
        let hasMoved = false; // 用于区分点击和拖拽
        let startX, startY, initialLeft, initialTop;

        // 获取当前位置 (兼容 touch 和 mouse)
        const getClientXY = (e) => {
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          return { x: clientX, y: clientY };
        };

        const onStart = (e) => {
          // 如果是鼠标右键，不触发
          if (e.type === "mousedown" && e.button !== 0) return;

          isDragging = true;
          hasMoved = false;

          const { x, y } = getClientXY(e);
          startX = x;
          startY = y;

          // 获取当前计算后的样式位置
          const rect = overlay.getBoundingClientRect();
          initialLeft = rect.left;
          initialTop = rect.top;

          // 移除 fixed 的定位类（top-4 left-4），改为直接操作 style
          // 这样拖拽时更平滑
          overlay.classList.remove("top-4", "left-4", "bottom-4", "right-4");
          overlay.style.left = `${initialLeft}px`;
          overlay.style.top = `${initialTop}px`;
          overlay.style.right = "auto";
          overlay.style.bottom = "auto";

          // 绑定移动和结束事件到 document，防止拖出元素范围失效
          document.addEventListener("mousemove", onMove, { passive: false });
          document.addEventListener("touchmove", onMove, { passive: false });
          document.addEventListener("mouseup", onEnd);
          document.addEventListener("touchend", onEnd);
        };

        const onMove = (e) => {
          if (!isDragging) return;

          const { x, y } = getClientXY(e);
          const dx = x - startX;
          const dy = y - startY;

          // 只有移动超过 5px 才视为拖拽，防止手抖误触
          if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
            hasMoved = true;
            // 阻止默认滚动行为（仅在移动时）
            if (e.cancelable) e.preventDefault();
          }

          // 更新位置
          let newLeft = initialLeft + dx;
          let newTop = initialTop + dy;

          // 边界限制 (防止拖出屏幕)
          const maxLeft = window.innerWidth - overlay.offsetWidth;
          const maxTop = window.innerHeight - overlay.offsetHeight;

          newLeft = Math.max(0, Math.min(newLeft, maxLeft));
          newTop = Math.max(0, Math.min(newTop, maxTop));

          overlay.style.left = `${newLeft}px`;
          overlay.style.top = `${newTop}px`;
        };

        const onEnd = () => {
          isDragging = false;
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("touchmove", onMove);
          document.removeEventListener("mouseup", onEnd);
          document.removeEventListener("touchend", onEnd);
        };

        // 绑定开始事件
        overlay.addEventListener("mousedown", onStart);
        overlay.addEventListener("touchstart", onStart, { passive: false });

        // 绑定点击事件
        btn.addEventListener("click", (e) => {
          // 如果发生了拖拽移动，则拦截点击事件
          if (hasMoved) {
            e.preventDefault();
            e.stopPropagation();
            console.log("拖拽结束，拦截点击");
          } else {
            // 纯点击，执行原有逻辑
            returnToAdminSession();
          }
        });
      }
    </script>

    <script
      src="https://cdn.socket.io/4.7.4/socket.io.min.js"
      onerror="handleCdnError('Socket.IO')"
    ></script>
    <meta charset="UTF-8" />
    <title>跑步助手</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script
      src="https://cdn.tailwindcss.com"
      onerror="handleCdnError()"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@600;700&family=Noto+Sans+SC:wght@400;600;700&display=swap"
      rel="stylesheet"
      onerror="handleCdnError()"
    />

    <script
      src="https://webapi.amap.com/loader.js"
      onerror="handleCdnError()"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
      if (typeof tailwind !== "undefined") {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ["Noto Sans SC", "system-ui", "sans-serif"],
                display: ["Zilla Slab", "serif"],
              },
              colors: { base: "#7dd3fc" },
            },
          },
        };
      } else {
        console.error("Tailwind CSS 未加载，跳过配置。");
        if (typeof handleCdnError === "function") handleCdnError("TailwindCSS");
      }
    </script>
    <style>
      body {
        background: linear-gradient(
          180deg,
          rgba(245, 250, 255, 1) 0%,
          rgba(235, 245, 255, 1) 40%,
          rgba(250, 240, 255, 1) 100%
        );
        background-attachment: fixed;
      }

      .panel {
        backdrop-filter: blur(16px);
        background-color: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.45);
        box-shadow: 0 10px 24px rgba(16, 24, 40, 0.12);
      }

      body.theme-anime {
        background-image: url("https://api.paugram.com/wallpaper");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
      }

      body.theme-anime .panel {
        background-color: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(20px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      }

      body.theme-minimalist {
        background: #f8f9fa;
      }

      body.theme-minimalist .panel {
        background-color: #ffffff;
        backdrop-filter: none;
        border: 1px solid #e9ecef;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-radius: 12px;
      }

      body.dark-mode {
        background: linear-gradient(
          180deg,
          rgba(17, 24, 39, 1) 0%,
          rgba(31, 41, 55, 1) 40%,
          rgba(55, 48, 68, 1) 100%
        );
        background-attachment: fixed;
        color: #e5e7eb;
      }

      body.dark-mode .panel {
        background-color: rgba(31, 41, 55, 0.8);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(75, 85, 99, 0.5);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      }

      body.dark-mode .input-field,
      body.dark-mode .select-field,
      body.dark-mode input[type="text"],
      body.dark-mode input[type="password"],
      body.dark-mode input[type="email"],
      body.dark-mode input[type="tel"],
      body.dark-mode input[type="number"],
      body.dark-mode textarea,
      body.dark-mode select {
        background-color: rgba(55, 65, 81, 0.8);
        border-color: rgba(107, 114, 128, 0.5);
        color: #e5e7eb;
      }

      body.dark-mode .input-field:focus,
      body.dark-mode .select-field:focus,
      body.dark-mode input:focus,
      body.dark-mode textarea:focus,
      body.dark-mode select:focus {
        border-color: rgba(96, 165, 250, 0.8);
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
      }

      body.dark-mode .btn {
        background-color: rgba(55, 65, 81, 0.9);
        color: #e5e7eb;
        border-color: rgba(107, 114, 128, 0.5);
      }

      body.dark-mode .btn:hover {
        background-color: rgba(75, 85, 99, 1);
      }

      body.dark-mode .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
      }

      body.dark-mode .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
      }

      body.dark-mode .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      body.dark-mode .btn-success:hover {
        background: linear-gradient(135deg, #059669, #047857);
      }

      body.dark-mode .btn-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      body.dark-mode .modal-content {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.95),
          rgba(55, 65, 81, 0.95)
        );
        border: 1px solid rgba(107, 114, 128, 0.5);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      }

      body.dark-mode .modal-content h3 {
        color: #e5e7eb;
      }

      body.dark-mode table {
        background-color: rgba(31, 41, 55, 0.5);
        color: #e5e7eb;
      }

      body.dark-mode table th {
        background-color: rgba(55, 65, 81, 0.8);
        color: #f3f4f6;
        border-bottom: 2px solid rgba(107, 114, 128, 0.5);
      }

      body.dark-mode table td {
        border-bottom: 1px solid rgba(75, 85, 99, 0.3);
      }

      body.dark-mode table tr:hover {
        background-color: rgba(55, 65, 81, 0.6);
      }

      body.dark-mode .bg-slate-50 {
        background-color: rgba(55, 65, 81, 0.5) !important;
      }

      body.dark-mode .border-slate-200 {
        border-color: rgba(107, 114, 128, 0.5) !important;
      }

      body.dark-mode .text-slate-700 {
        color: #d1d5db !important;
      }

      body.dark-mode .text-slate-600 {
        color: #e5e7eb !important;
      }

      body.dark-mode .text-slate-400 {
        color: #9ca3af !important;
      }

      body.dark-mode a {
        color: #60a5fa;
      }

      body.dark-mode a:hover {
        color: #93c5fd;
      }

      body.dark-mode ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      body.dark-mode ::-webkit-scrollbar-track {
        background: rgba(31, 41, 55, 0.5);
      }

      body.dark-mode ::-webkit-scrollbar-thumb {
        background: rgba(107, 114, 128, 0.8);
        border-radius: 5px;
      }

      body.dark-mode ::-webkit-scrollbar-thumb:hover {
        background: rgba(156, 163, 175, 0.9);
      }

      body.dark-mode #login-container .bg-gradient-to-br {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.8),
          rgba(55, 65, 81, 0.8)
        ) !important;
      }

      body.dark-mode .bg-red-50 {
        background-color: rgba(127, 29, 29, 0.3) !important;
      }

      body.dark-mode .bg-green-50 {
        background-color: rgba(6, 78, 59, 0.3) !important;
      }

      body.dark-mode .bg-blue-50 {
        background-color: rgba(30, 58, 138, 0.3) !important;
      }

      body.dark-mode .bg-yellow-50 {
        background-color: rgba(120, 53, 15, 0.3) !important;
      }

      body.dark-mode .border-red-200 {
        border-color: rgba(220, 38, 38, 0.5) !important;
      }

      body.dark-mode .border-green-200 {
        border-color: rgba(34, 197, 94, 0.5) !important;
      }

      body.dark-mode .border-blue-200 {
        border-color: rgba(59, 130, 246, 0.5) !important;
      }

      body.dark-mode .border-yellow-200 {
        border-color: rgba(234, 179, 8, 0.5) !important;
      }

      body.dark-mode .modal-content.neumorphic,
      body.dark-mode .neumorphic-modal .modal-content {
        background: #2d3748;
        box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.6),
          -12px -12px 24px rgba(74, 85, 104, 0.4);
      }

      body.dark-mode .modal-content.neumorphic input,
      body.dark-mode .neumorphic-modal .modal-content input,
      body.dark-mode .modal-content.neumorphic select,
      body.dark-mode .neumorphic-modal .modal-content select,
      body.dark-mode .modal-content.neumorphic textarea,
      body.dark-mode .neumorphic-modal .modal-content textarea {
        background: #2d3748;
        color: #e5e7eb;
        box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.5),
          inset -4px -4px 8px rgba(74, 85, 104, 0.3);
      }

      body.dark-mode .modal-content.neumorphic button,
      body.dark-mode .neumorphic-modal .modal-content button {
        background: #2d3748;
        color: #e5e7eb;
        box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.6),
          -6px -6px 12px rgba(74, 85, 104, 0.4);
      }

      body.dark-mode.theme-anime {
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.4),
            rgba(0, 0, 0, 0.4)
          ),
          url("https://api.paugram.com/wallpaper");
      }

      body.dark-mode.theme-minimalist {
        background: #1a202c;
      }

      body.dark-mode.theme-minimalist .panel {
        background-color: #2d3748;
        border: 1px solid #4a5568;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      #multi-config-user-select {
        white-space: nowrap;
        overflow-x: auto;
        max-width: 100%;
      }

      select.select-field {
        padding: 0.45rem 0.6rem;
      }

      #multi-config-user-select option {
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: auto;
        background-color: rgba(0, 0, 0, 0.4);
        align-items: center;
        justify-content: center;
      }

      .modal-content.neumorphic,
      .neumorphic-modal .modal-content {
        background: #e8ecf4;
        box-shadow: 12px 12px 24px rgba(163, 177, 198, 0.6),
          -12px -12px 24px rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 20px;
      }

      .modal-content.neumorphic input,
      .neumorphic-modal .modal-content input,
      .modal-content.neumorphic select,
      .neumorphic-modal .modal-content select,
      .modal-content.neumorphic textarea,
      .neumorphic-modal .modal-content textarea {
        background: #e8ecf4;
        border: none;
        box-shadow: inset 4px 4px 8px rgba(163, 177, 198, 0.5),
          inset -4px -4px 8px rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        padding: 10px 14px;
        transition: all 0.3s ease;
      }

      .modal-content.neumorphic input:focus,
      .neumorphic-modal .modal-content input:focus,
      .modal-content.neumorphic select:focus,
      .neumorphic-modal .modal-content select:focus,
      .modal-content.neumorphic textarea:focus,
      .neumorphic-modal .modal-content textarea:focus {
        outline: none;
        box-shadow: inset 6px 6px 12px rgba(163, 177, 198, 0.7),
          inset -6px -6px 12px rgba(255, 255, 255, 0.5);
      }

      .modal-content.neumorphic button,
      .neumorphic-modal .modal-content button {
        background: #e8ecf4;
        border: none;
        box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.6),
          -6px -6px 12px rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 10px 20px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .modal-content.neumorphic button:hover,
      .neumorphic-modal .modal-content button:hover {
        transform: translateY(-2px);
        box-shadow: 8px 8px 16px rgba(163, 177, 198, 0.7),
          -8px -8px 16px rgba(255, 255, 255, 0.9);
      }

      .modal-content.neumorphic button:active,
      .neumorphic-modal .modal-content button:active {
        transform: translateY(0);
        box-shadow: inset 4px 4px 8px rgba(163, 177, 198, 0.6),
          inset -4px -4px 8px rgba(255, 255, 255, 0.7);
      }

      .modal-content.neumorphic button.btn-primary,
      .neumorphic-modal .modal-content button.btn-primary {
        background: linear-gradient(145deg, #7aa3ff, #6b8ee6);
        color: white;
        font-weight: 600;
      }

      .modal-content.neumorphic button.btn-primary:hover,
      .neumorphic-modal .modal-content button.btn-primary:hover {
        background: linear-gradient(145deg, #8ab3ff, #7b9ef6);
      }

      .modal-content {
        background: linear-gradient(135deg, #ffffff, #f7f9ff);
        padding: 24px 28px;
        border-radius: 16px;
        width: 360px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25),
          0 0 12px rgba(120, 160, 255, 0.4);
        animation: fadeIn 0.35s ease, scaleIn 0.35s ease;
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        position: relative;
        pointer-events: auto;
      }

      .modal-content h3 {
        margin-top: 0;
        text-align: center;
        font-size: 20px;
        color: #3a4a7a;
        letter-spacing: 1px;
      }

      .close {
        position: absolute;
        right: 14px;
        top: 10px;
        font-size: 22px;
        cursor: pointer;
        color: #888;
        transition: color 0.2s;
      }

      .close:hover {
        color: #ff5c8a;
      }

      .form-group {
        margin: 14px 0;
      }

      .form-group label {
        display: inline-block;
        width: 70px;
        font-weight: bold;
        color: #4a4a6a;
      }

      .form-group input {
        width: 230px;
        padding: 8px 10px;
        border: 1px solid #ccd2f0;
        border-radius: 8px;
        outline: none;
        transition: all 0.25s;
        background: #fff;
      }

      .form-group input:focus {
        border-color: #7a9dff;
        box-shadow: 0 0 6px rgba(122, 157, 255, 0.6);
      }

      .modal-actions {
        text-align: right;
        margin-top: 18px;
      }

      .modal-actions button {
        margin-left: 10px;
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.25s;
      }

      #newUserCancel {
        background: #e0e4f7;
        color: #444;
      }

      #newUserCancel:hover {
        background: #d0d6f0;
      }

      #newUserConfirm {
        background: linear-gradient(135deg, #7a9dff, #5c7cff);
        color: #fff;
        box-shadow: 0 3px 8px rgba(92, 124, 255, 0.4);
      }

      #newUserConfirm:hover {
        background: linear-gradient(135deg, #5c7cff, #4a68e0);
        box-shadow: 0 4px 10px rgba(92, 124, 255, 0.55);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
        }

        to {
          transform: scale(1);
        }
      }

      :root {
        --base-color: #7dd3fc;
        --base-color-600: #0891b2;
        --base-color-500: #22d3ee;
        --base-color-300: #a5f3fc;
        --card-bg: rgba(255, 255, 255, 0.85);
        --glass: rgba(255, 255, 255, 0.65);
        --ink: #0f172a;
      }

      html,
      body {
        height: 100%;
      }

      body {
        background: linear-gradient(
          180deg,
          rgba(245, 250, 255, 1) 0%,
          rgba(235, 245, 255, 1) 40%,
          rgba(250, 240, 255, 1) 100%
        );
        background-attachment: fixed;
      }

      .bg-anime {
        background-image: url("");
        background-size: cover;
        background-position: center;
      }

      .panel {
        backdrop-filter: blur(16px);
        background-color: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.45);
        box-shadow: 0 10px 24px rgba(16, 24, 40, 0.12);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.65rem 1rem;
        border-radius: 999px;
        font-weight: 700;
        transition: all 0.25s ease;
        box-shadow: 0 6px 16px rgba(2, 132, 199, 0.15);
      }

      .btn:hover {
        transform: none;
        box-shadow: 0 12px 28px rgba(2, 132, 199, 0.22);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        color: #fff;
        background: linear-gradient(
          135deg,
          var(--base-color),
          var(--base-color-600)
        );
      }

      .btn-secondary {
        color: #fff;
        background: linear-gradient(135deg, #a855f7, #7c3aed);
      }

      .btn-danger {
        color: #fff;
        background: linear-gradient(135deg, #ef4444, #b91c1c);
      }

      .btn-warning {
        color: #fff;
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }

      .btn-success {
        color: #fff;
        background: linear-gradient(135deg, #10b981, #059669);
      }

      .btn-ghost {
        color: #334155;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .input-field,
      .select-field {
        width: 100%;
        border-radius: 14px;
        padding: 0.7rem 0.9rem;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.95),
          rgba(255, 255, 255, 0.85)
        );
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6),
          0 8px 14px rgba(16, 24, 40, 0.06);
        color: #0f172a;
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
      }

      .input-field:focus,
      .select-field:focus {
        outline: none;
        border-color: var(--base-color-600);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.25);
      }

      .phone-input-wrapper {
        display: flex;
        align-items: center;
        width: 100%;
        border-radius: 14px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.95),
          rgba(255, 255, 255, 0.85)
        );
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6),
          0 8px 14px rgba(16, 24, 40, 0.06);
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
        overflow: hidden;
      }

      .phone-input-wrapper:focus-within {
        border-color: var(--base-color-600);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.25);
      }

      .phone-prefix {
        padding: 0.7rem 0 0.7rem 0.9rem;
        color: #64748b;
        font-weight: 500;
        user-select: none;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .phone-input-wrapper .input-field {
        border: none;
        background: transparent;
        box-shadow: none;
        padding-left: 0;
        padding-right: 0.9rem;
        flex: 1;
        min-width: 0;
      }

      .phone-input-wrapper .input-field:focus {
        outline: none;
        border: none;
        box-shadow: none;
      }

      .phone-input-wrapper.prefix-hidden .input-field {
        padding-left: 0.9rem;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-weight: 700;
        background: rgba(34, 211, 238, 0.18);
        color: var(--base-color-600);
      }

      .card-title {
        font-family: "Zilla Slab", serif;
        letter-spacing: 0.5px;
      }

      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(226, 232, 240, 0.6);
      }

      ::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.8);
        border-radius: 6px;
        border: 2px solid rgba(226, 232, 240, 0.6);
      }

      ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(100, 116, 139, 0.9);
      }

      .tab-button {
        padding: 0.5rem 0.75rem;
        font-weight: 700;
        color: #64748b;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .tab-button.active {
        color: var(--base-color-600);
        border-bottom-color: var(--base-color-600);
      }

      #task-list > div.selected {
        background: rgba(34, 211, 238, 0.14);
        border-left: 4px solid var(--base-color-600);
      }

      #map-container.drawing .amap-marker,
      #map-container.drawing .amap-text,
      #map-container.drawing .amap-overlay-text,
      #map-container.drawing .amap-overlay {
        pointer-events: none !important;
      }

      .pulsing-marker {
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(0.98);
          box-shadow: 0 0 0 0 rgba(2, 132, 199, 0.7);
        }

        70% {
          transform: scale(1);
          box-shadow: 0 0 0 12px rgba(2, 132, 199, 0);
        }

        100% {
          transform: scale(0.98);
          box-shadow: 0 0 0 0 rgba(2, 132, 199, 0);
        }
      }

      .hero-overlay {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.2) 0%,
          rgba(255, 255, 255, 0.85) 60%
        );
      }

      .theme-dot {
        width: 20px;
        height: 20px;
        border-radius: 100%;
        border: 2px solid #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .theme-dot:hover {
        transform: scale(1.05);
      }

      #amap-key-modal:not(.hidden) ~ #map-container .amap-logo,
      #amap-key-modal:not(.hidden) ~ #map-container .amap-copyright,
      #amap-key-modal:not(.hidden) ~ main > #multi-map-container .amap-logo,
      #amap-key-modal:not(.hidden)
        ~ main
        > #multi-map-container
        .amap-copyright,
      #user-details-modal:not(.hidden) ~ #map-container .amap-logo,
      #user-details-modal:not(.hidden) ~ #map-container .amap-copyright,
      #task-details-modal:not(.hidden) ~ #map-container .amap-logo,
      #task-details-modal:not(.hidden) ~ #map-container .amap-copyright,
      #user-details-modal:not(.hidden) ~ main > #multi-map-container .amap-logo,
      #user-details-modal:not(.hidden)
        ~ main
        > #multi-map-container
        .amap-copyright,
      #task-details-modal:not(.hidden) ~ main > #multi-map-container .amap-logo,
      #task-details-modal:not(.hidden)
        ~ main
        > #multi-map-container
        .amap-copyright,
      #account-params-modal:not(.hidden)
        ~ main
        > #multi-map-container
        .amap-logo,
      #account-params-modal:not(.hidden)
        ~ main
        > #multi-map-container
        .amap-copyright {
        display: none !important;
      }

      body.modal-visible .amap-logo,
      body.modal-visible .amap-copyright {
        display: none !important;
      }

      #admin-modal-close-btn:hover {
        transform: translateY(-50%);
      }

      html.swal2-shown,
      body.swal2-shown:not(.swal2-toast-shown) {
        padding-right: 0;
      }

      /* ============================================================ */
      /* 任务29-30：移动端优化CSS */
      /* ============================================================ */

      @media (max-width: 768px) {
        .modal-content,
        .panel.rounded-2xl {
          width: 90% !important;
          max-width: 90% !important;
          margin: 0 auto;
        }

        button,
        input[type="submit"],
        input[type="button"],
        .btn {
          min-height: 44px;
          padding: 12px 16px;
          font-size: 16px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select {
          min-height: 44px;
          font-size: 16px;
          padding: 10px 12px;
        }

        input[type="tel"] {
          font-size: 16px !important;
        }

        .flex.gap-3,
        .flex.gap-4 {
          flex-direction: column;
          gap: 12px;
        }

        [class*="admin-tab"] {
          padding: 14px 20px;
          font-size: 15px;
        }

        .border.rounded-lg {
          padding: 16px;
        }

        .overflow-y-auto {
          -webkit-overflow-scrolling: touch;
        }

        [id^="avatar-"] {
          width: 48px;
          height: 48px;
        }

        .grid.grid-cols-2,
        .grid.grid-cols-3,
        .grid.grid-cols-4 {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .modal-content,
        .panel.rounded-2xl {
          width: 95% !important;
          max-width: 95% !important;
          padding: 16px;
        }

        h1,
        .text-xl {
          font-size: 20px;
        }

        h2,
        .text-lg {
          font-size: 18px;
        }

        h3,
        .text-base {
          font-size: 16px;
        }

        .flex.gap-1,
        .flex.gap-2 {
          flex-direction: column;
          width: 100%;
        }

        .flex.gap-1 > button,
        .flex.gap-2 > button {
          width: 100%;
        }
      }

      /* ============================================================ */
      /* 移动端专用UI容器样式 */
      /* ============================================================ */

      #mobile-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        background: linear-gradient(
          180deg,
          rgba(245, 250, 255, 1) 0%,
          rgba(235, 245, 255, 1) 40%,
          rgba(250, 240, 255, 1) 100%
        );
        background-attachment: fixed;
        padding: 0;
        margin: 0;
        z-index: 10000;
      }

      #desktop-container {
        display: block;
        width: 100%;
        height: 100%;
      }

      body.mobile-mode {
        font-size: 16px;
        -webkit-text-size-adjust: 100%;
        -moz-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        text-size-adjust: 100%;
        overflow-x: hidden;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: pan-y;
      }

      .mobile-mode .phone-input-wrapper {
        display: flex;
        align-items: center;
        width: 100%;
        border-radius: 10px;
        border: 2px solid rgba(148, 163, 184, 0.3);
        background-color: rgba(255, 255, 255, 0.9);
        overflow: hidden;
        min-height: 44px;
        transition: all 0.2s ease;
      }

      .mobile-mode .phone-input-wrapper:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: scale(1.02);
      }

      .mobile-mode .phone-prefix {
        padding: 12px 0 12px 16px;
        font-size: 16px;
        color: #64748b;
        font-weight: 500;
        user-select: none;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .mobile-mode .phone-input-wrapper .input-field {
        border: none;
        background: transparent;
        box-shadow: none;
        padding-left: 0;
        padding-right: 16px;
        font-size: 16px;
        flex: 1;
        min-width: 0;
        min-height: 44px;
        padding-top: 12px;
        padding-bottom: 12px;
      }

      .mobile-mode .phone-input-wrapper .input-field:focus {
        outline: none;
        border: none;
        box-shadow: none;
        transform: none;
      }

      .mobile-mode .phone-input-wrapper.prefix-hidden .input-field {
        padding-left: 16px;
      }

      body.mobile-mode #desktop-container,
      body.mobile-mode #auth-login-container,
      body.mobile-mode #login-container,
      body.mobile-mode #main-app,
      body.mobile-mode #multi-account-app {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: -1 !important;
      }

      body.mobile-mode .modal,
      body.mobile-mode #admin-panel-modal,
      body.mobile-mode #session-picker-modal {
        z-index: 9999 !important;
      }

      .mobile-mode .btn,
      .mobile-mode button {
        min-height: 44px;
        min-width: 44px;
        font-size: 16px;
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
        touch-action: manipulation;
        cursor: pointer;
      }

      .mobile-mode .btn:active,
      .mobile-mode button:active {
        transform: scale(0.95);
        opacity: 0.8;
      }

      .mobile-mode input,
      .mobile-mode select,
      .mobile-mode textarea {
        min-height: 44px;
        font-size: 16px;
        padding: 12px 16px;
        border-radius: 10px;
        border: 2px solid rgba(148, 163, 184, 0.3);
        background-color: rgba(255, 255, 255, 0.9);
        transition: all 0.2s ease;
        touch-action: manipulation;
      }

      .mobile-mode input:focus,
      .mobile-mode select:focus,
      .mobile-mode textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
        transform: scale(1.02);
      }

      .mobile-mode .mobile-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 56px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
      }

      .mobile-mode .mobile-content {
        padding-top: 56px;
        padding-bottom: 80px;
        min-height: 100vh;
      }

      .mobile-mode .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 64px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding: 0 8px;
        padding-bottom: env(safe-area-inset-bottom, 0);
      }

      .mobile-mode .mobile-nav-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 8px;
        min-height: 44px;
        color: #64748b;
        text-decoration: none;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        touch-action: manipulation;
      }

      .mobile-mode .mobile-nav-btn.active {
        color: #3b82f6;
        font-weight: 600;
      }

      .mobile-mode .mobile-nav-btn svg {
        width: 24px;
        height: 24px;
        margin-bottom: 4px;
      }

      .mobile-mode .mobile-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 20px;
        margin: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      .mobile-mode .mobile-form-group {
        margin-bottom: 20px;
      }

      .mobile-mode .mobile-form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #334155;
        margin-bottom: 8px;
      }

      .mobile-mode .mobile-primary-btn {
        width: 100%;
        height: 50px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 700;
        text-align: center;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        transition: all 0.2s ease;
        touch-action: manipulation;
        cursor: pointer;
      }

      .mobile-mode .mobile-primary-btn:active {
        transform: scale(0.97);
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
      }

      .mobile-mode .mobile-secondary-btn {
        width: 100%;
        height: 50px;
        background: white;
        color: #3b82f6;
        border: 2px solid #3b82f6;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s ease;
        touch-action: manipulation;
        cursor: pointer;
      }

      .mobile-mode .mobile-secondary-btn:active {
        transform: scale(0.97);
        background: rgba(59, 130, 246, 0.1);
      }

      .mobile-mode .mobile-list-item {
        display: flex;
        align-items: center;
        padding: 16px;
        background: white;
        border-radius: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        min-height: 60px;
        transition: all 0.2s ease;
        cursor: pointer;
        touch-action: manipulation;
      }

      .mobile-mode .mobile-list-item:active {
        transform: scale(0.98);
        background: rgba(59, 130, 246, 0.05);
      }

      .mobile-mode .mobile-divider {
        height: 1px;
        background: rgba(148, 163, 184, 0.2);
        margin: 20px 0;
      }

      .mobile-mode .mobile-title {
        font-size: 24px;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 8px;
      }

      .mobile-mode .mobile-subtitle {
        font-size: 16px;
        font-weight: 400;
        color: #64748b;
        margin-bottom: 24px;
      }

      .mobile-mode .mobile-empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #94a3b8;
        font-size: 15px;
      }

      .mobile-mode .mobile-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #64748b;
      }

      .mobile-mode .mobile-switch {
        position: relative;
        width: 50px;
        height: 28px;
        background: #e2e8f0;
        border-radius: 14px;
        transition: all 0.3s ease;
        cursor: pointer;
        touch-action: manipulation;
      }

      .mobile-mode .mobile-switch.active {
        background: #3b82f6;
      }

      .mobile-mode .mobile-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .mobile-mode .mobile-switch.active::after {
        left: 24px;
      }

      .mobile-mode .mobile-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 20000;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .mobile-mode .mobile-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .mobile-mode .mobile-modal-content {
        background: white;
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        padding: 24px;
        padding-bottom: calc(24px + env(safe-area-inset-bottom, 0));
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }

      .mobile-mode .mobile-modal.show .mobile-modal-content {
        transform: translateY(0);
      }

      /* ============================================================ */
      /* 移动端新增容器专用样式 */
      /* ============================================================ */

      .mobile-mode #mobile-notification-panel {
        position: relative;
      }

      .mobile-mode #mobile-all-notifications-list .mobile-list-item,
      .mobile-mode #mobile-attendance-notifications-list .mobile-list-item {
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .mobile-mode
        #mobile-all-notifications-list
        .mobile-list-item:not(.opacity-60) {
        border-left-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
      }

      .mobile-mode #mobile-all-notifications-list .mobile-list-item:active,
      .mobile-mode
        #mobile-attendance-notifications-list
        .mobile-list-item:active {
        background: rgba(59, 130, 246, 0.1);
        transform: scale(0.98);
      }

      .mobile-mode #mobile-task-panel .mobile-list-item {
        border-left: 3px solid #10b981;
        background: rgba(16, 185, 129, 0.03);
      }

      .mobile-mode #mobile-map-container {
        touch-action: pan-x pan-y;
        -webkit-overflow-scrolling: touch;
      }

      .mobile-mode #mobile-map-container .text-slate-400 svg {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      .mobile-mode #mobile-control-panel button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #cbd5e1 !important;
        color: #64748b !important;
      }

      .mobile-mode #mobile-status-indicator {
        animation: fadeIn 0.3s ease;
      }

      .mobile-mode #mobile-status-indicator.status-idle {
        background: #e2e8f0;
        color: #64748b;
      }

      .mobile-mode #mobile-status-indicator.status-running {
        background: #dcfce7;
        color: #16a34a;
      }

      .mobile-mode #mobile-status-indicator.status-paused {
        background: #fef3c7;
        color: #d97706;
      }

      .mobile-mode #mobile-status-indicator.status-error {
        background: #fee2e2;
        color: #dc2626;
      }

      .mobile-mode #mobile-progress-bar {
        transition: width 0.5s ease-out;
      }

      .mobile-mode #mobile-multi-account-list .mobile-list-item {
        position: relative;
        padding-left: 48px;
      }

      .mobile-mode #mobile-multi-account-list input[type="checkbox"] {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
      }

      .mobile-mode .account-status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .mobile-mode .account-status-running {
        background: #dcfce7;
        color: #16a34a;
      }

      .mobile-mode .account-status-stopped {
        background: #f1f5f9;
        color: #64748b;
      }

      .mobile-mode .account-status-error {
        background: #fee2e2;
        color: #dc2626;
      }

      @media (orientation: landscape) and (max-height: 500px) {
        .mobile-mode .mobile-header {
          height: 48px;
        }

        .mobile-mode .mobile-content {
          padding-top: 48px;
          padding-bottom: 60px;
        }

        .mobile-mode .mobile-bottom-nav {
          height: 56px;
        }

        .mobile-mode .mobile-card {
          padding: 16px;
          margin: 12px;
        }

        .mobile-mode #mobile-map-container {
          height: 200px !important;
        }

        .mobile-mode #mobile-all-notifications-list,
        .mobile-mode #mobile-attendance-notifications-list,
        .mobile-mode #mobile-task-list,
        .mobile-mode #mobile-multi-account-list {
          max-height: 30vh !important;
        }
      }

      @media (prefers-color-scheme: dark) {
        .mobile-mode #mobile-container {
          background: linear-gradient(
            180deg,
            #0f172a 0%,
            #1e293b 50%,
            #334155 100%
          );
        }

        .mobile-mode-auth #mobile-container .mobile-header,
        .mobile-mode-auth #mobile-container .mobile-bottom-nav {
          display: none !important;
        }

        .mobile-mode-auth #mobile-container .mobile-content {
          padding-top: 0;
          padding-bottom: 0;
        }

        .mobile-mode .mobile-card {
          background: rgba(30, 41, 59, 0.85);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #e2e8f0;
        }

        .mobile-mode .mobile-header,
        .mobile-mode .mobile-bottom-nav {
          background: rgba(15, 23, 42, 0.95);
          border-color: rgba(255, 255, 255, 0.1);
        }

        .mobile-mode .mobile-title {
          color: #f1f5f9;
        }

        .mobile-mode .mobile-subtitle {
          color: #94a3b8;
        }

        .mobile-mode input,
        .mobile-mode select,
        .mobile-mode textarea {
          background: rgba(30, 41, 59, 0.8);
          color: #e2e8f0;
          border-color: rgba(148, 163, 184, 0.3);
        }
      }
      /* ============================================================ */
      /* 移动端侧边栏导航样式 */
      /* ============================================================ */

      .mobile-sidebar-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .mobile-sidebar-backdrop.show {
        opacity: 1;
        visibility: visible;
      }

      .mobile-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 280px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        padding-bottom: env(safe-area-inset-bottom, 0);
      }
      .mobile-sidebar.show {
        transform: translateX(0);
      }
      .mobile-sidebar-header {
        padding: 24px 20px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .mobile-sidebar-header svg {
        width: 32px;
        height: 32px;
        flex-shrink: 0;
      }
      .mobile-sidebar-header .sidebar-title {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .mobile-sidebar-menu {
        flex: 1;
        padding: 8px 0;
        overflow-y: auto;
      }
      .mobile-sidebar-item {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        color: #334155;
        text-decoration: none;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        touch-action: manipulation;
        border-left: 3px solid transparent;
        gap: 12px;
      }
      .mobile-sidebar-item:hover {
        background: rgba(59, 130, 246, 0.08);
        border-left-color: #3b82f6;
      }

      .mobile-sidebar-item:active {
        background: rgba(59, 130, 246, 0.15);
        transform: scale(0.98);
      }

      .mobile-sidebar-item svg {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
        stroke-width: 2;
      }

      .mobile-sidebar-item span {
        flex: 1;
      }

      .mobile-sidebar-item.danger {
        color: #dc2626;
      }

      .mobile-sidebar-item.danger:hover {
        background: rgba(220, 38, 38, 0.08);
        border-left-color: #dc2626;
      }

      .mobile-sidebar-item.danger:active {
        background: rgba(220, 38, 38, 0.15);
      }

      .mobile-bottom-nav {
        display: none !important;
      }

      .mobile-mode .mobile-content {
        padding-bottom: 80px !important;
      }

      @media (prefers-color-scheme: dark) {
        .mobile-sidebar {
          background: rgba(15, 23, 42, 0.98);
          box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5);
        }

        .mobile-sidebar-item {
          color: #e2e8f0;
        }

        .mobile-sidebar-item:hover {
          background: rgba(59, 130, 246, 0.15);
        }

        .mobile-sidebar-item:active {
          background: rgba(59, 130, 246, 0.25);
        }

        .mobile-sidebar-backdrop.show {
          background: rgba(0, 0, 0, 0.7);
        }
      }

      @media (orientation: landscape) and (max-height: 500px) {
        .mobile-sidebar-header {
          padding: 16px 20px;
        }

        .mobile-sidebar-item {
          padding: 12px 20px;
        }
      }

      .mobile-mode .mobile-card-fullscreen {
        height: calc(100vh - 60px);
        margin: 0;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 16px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
    </style>
  </head>

  <body class="text-slate-800 font-sans h-screen overflow-hidden antialiased">
    <div
      id="admin-return-overlay"
      class="fixed top-4 left-4 z-[10000] hidden"
      style="touch-action: none; user-select: none"
    >
      <button
        id="admin-return-btn"
        class="flex items-center gap-2 px-4 py-2 bg-slate-800/90 text-white rounded-full shadow-xl border border-slate-600 backdrop-blur-sm hover:bg-slate-700 transition-colors font-bold text-sm cursor-move"
      >
        <!-- <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg> -->
        <span>返回管理员会话</span>
      </button>
    </div>

    <button
      id="exit-app-btn"
      class="fixed bottom-4 right-4 z-[9999] btn btn-ghost !py-2 !px-4 bg-white/80 backdrop-blur-sm shadow-lg hover:bg-red-50 hover:text-red-600 transition-all duration-300 rounded-xl border border-slate-200 touch-none select-none"
      title="退出应用"
    >
      <svg
        class="w-5 h-5 mr-1"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
        />
      </svg>
      退出应用
    </button>

    <div
      id="cdn-error-overlay"
      class="fixed inset-0 z-9999 hidden flex-col items-center justify-center bg-[#f8fafc] p-8 text-center text-[#475569]"
      style="font-family: sans-serif"
    >
      <div style="max-width: 500px">
        <h1
          style="
            font-size: 1.875rem;
            font-weight: bold;
            color: #be123c;
            margin-bottom: 1rem;
          "
        >
          界面资源加载失败
        </h1>
        <p style="font-size: 1.125rem; margin-bottom: 1.5rem">
          应用程序无法连接到外部网络服务器（CDN）来下载必要的界面文件（如样式和地图库）。
        </p>
        <div
          style="
            background-color: #f1f5f9;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            line-height: 1.5;
          "
        >
          <h2
            style="
              font-weight: 600;
              color: #1e293b;
              margin-top: 0;
              margin-bottom: 0.75rem;
            "
          >
            可能的原因及解决方法：
          </h2>
          <ul style="list-style-type: disc; padding-left: 1.25rem; margin: 0">
            <li style="margin-bottom: 0.5rem">
              <strong>检查您的网络连接</strong>：请确保您的设备已连接到互联网。
            </li>
            <li style="margin-bottom: 0.5rem">
              <strong>检查防火墙或代理</strong
              >：系统防火墙、杀毒软件或网络代理可能阻止了程序访问网络。
            </li>
            <li>
              <strong>网络环境问题</strong
              >：您当前的网络环境可能无法稳定访问所需的外部资源。
            </li>
          </ul>
        </div>
        <p style="margin-top: 1.5rem; font-size: 0.875rem; color: #64748b">
          请检查网络后，完全关闭并重启本程序。如果问题持续存在，您可能需要更换网络环境。
        </p>
      </div>
    </div>

    <div
      id="guest_warning_overlay"
      class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden"
    ></div>

    <div
      id="guest-warning-toast"
      class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl p-5 z-[1001] rounded-2xl hidden shadow-2xl transition-all duration-300 ease-out border-4 border-red-500"
      style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)"
    >
      <div class="flex items-start gap-4" id="guest_warning">
        <div class="flex-shrink-0 w-10 h-10 text-red-600 mt-1 animate-pulse">
          <svg
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="text-xl font-bold text-red-700 mb-2">
            ⚠️ 游客模式重要提示
          </h3>
          <div class="text-base text-slate-800 space-y-2 font-medium">
            <p class="bg-white/60 px-3 py-2 rounded-lg">
              <strong class="text-red-600">⚠️ 请立即保存当前网址！</strong>
              丢失URL将无法恢复您的数据！
            </p>
            <p class="bg-white/60 px-3 py-2 rounded-lg">
              <strong>功能限制：</strong
              >无法标记通知已读、无法使用签到功能、无法执行多账号任务
            </p>
            <p class="bg-white/60 px-3 py-2 rounded-lg">
              <strong class="text-amber-700">⏰ 自动清理：</strong
              >5分钟不活跃会话将被自动清理
            </p>
            <p class="mt-3 text-sm text-slate-600">
              💡 建议：<span class="text-blue-600 font-semibold"
                >请注册账号以获得完整功能和永久数据保存</span
              >
            </p>
          </div>
        </div>
        <button
          id="guest-warning-close-btn"
          class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-slate-600 hover:text-red-600 hover:bg-white/80 rounded-full transition-colors duration-200 -mt-2 -mr-2 font-bold text-xl"
        >
          <svg
            class="w-6 h-6"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>
      </div>
    </div>
    <div id="newUserModal" class="modal">
      <div
        class="panel rounded-2xl w-full max-w-md p-6 space-y-4 relative bg-white/95 shadow-xl"
      >
        <button
          id="newUserClose"
          class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all"
        >
          <svg
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>

        <h3 class="text-xl font-bold text-sky-700 text-center card-title">
          添加新用户
        </h3>

        <div>
          <label
            for="newUsername"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >账号</label
          >
          <input
            type="text"
            id="newUsername"
            placeholder="请输入账号（3-20字符，不含中文）"
            class="input-field mt-1"
          />
        </div>

        <div>
          <label
            for="newUserPhone"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >手机号（可选）</label
          >
          <input
            type="tel"
            id="newUserPhone"
            placeholder="请输入手机号"
            inputmode="numeric"
            pattern="[0-9]*"
            class="input-field mt-1"
          />
        </div>

        <div id="newUserSmsGroup" style="display: none">
          <label
            for="newUserSmsCode"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >验证码（可选）</label
          >
          <div class="flex gap-2 mt-1">
            <input
              type="text"
              id="newUserSmsCode"
              placeholder="请输入验证码"
              maxlength="6"
              inputmode="numeric"
              pattern="[0-9]{6}"
              class="input-field flex-1"
            />
            <button
              type="button"
              id="newUserSendCode"
              class="btn btn-primary whitespace-nowrap"
              style="min-height: 44px"
            >
              发送验证码
            </button>
          </div>
        </div>

        <div>
          <label
            for="newUserNickname"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >昵称</label
          >
          <input
            type="text"
            id="newUserNickname"
            placeholder="请输入昵称（可含中文）"
            class="input-field mt-1"
          />
        </div>

        <div>
          <label
            for="newPassword"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >密码</label
          >
          <input
            type="password"
            id="newPassword"
            placeholder="请输入密码（至少6字符）"
            class="input-field mt-1"
          />
        </div>

        <div>
          <label
            for="newPasswordConfirm"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >确认密码</label
          >
          <input
            type="password"
            id="newPasswordConfirm"
            placeholder="请再次输入密码"
            class="input-field mt-1"
          />
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
          <button id="newUserCancel" class="btn btn-ghost">取消</button>
          <button id="newUserConfirm" class="btn btn-primary">确认</button>
        </div>
      </div>
    </div>

    <div id="multi-add-user-modal" class="modal">
      <div
        class="panel rounded-2xl w-full max-w-md p-6 space-y-4 relative bg-white/95 shadow-xl"
      >
        <button
          id="multi-add-user-close"
          class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all"
        >
          <svg
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>
        <h3 class="text-xl font-bold text-sky-700 text-center card-title">
          添加新账号
        </h3>

        <div>
          <label
            for="multi-add-username"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >账号 (必填)</label
          >
          <input
            type="text"
            id="multi-add-username"
            placeholder="请输入账号（例如学号）"
            class="input-field mt-1"
          />
        </div>
        <div>
          <label
            for="multi-add-password"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >密码 (必填)</label
          >
          <input
            type="password"
            id="multi-add-password"
            placeholder="请输入密码 (至少6字符)"
            class="input-field mt-1"
          />
        </div>
        <div>
          <label
            for="multi-add-tag"
            class="block text-sm font-semibold leading-6 text-slate-700"
            >标记 (可选)</label
          >
          <input
            type="text"
            id="multi-add-tag"
            placeholder="可选，用于分组 (例如: 'A组')"
            class="input-field mt-1"
          />
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
          <button id="multi-add-user-cancel" class="btn btn-ghost">取消</button>
          <button id="multi-add-user-confirm" class="btn btn-primary">
            确认添加
          </button>
        </div>
      </div>
    </div>

    <div id="school-accounts-modal" class="modal">
      <div
        class="panel rounded-2xl w-full max-w-4xl p-6 space-y-4 relative bg-white/95 shadow-xl"
      >
        <button
          id="school-accounts-close"
          class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all"
        >
          <svg
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>
        <h3 class="text-xl font-bold text-sky-700 text-center card-title">
          School Accounts 管理
        </h3>
        <p class="text-sm text-slate-500 text-center -mt-2">
          查看所有认证用户的学校账户密码
        </p>

        <div
          id="school-accounts-content"
          class="space-y-4 max-h-[60vh] overflow-y-auto"
        >
          <p class="text-slate-400 text-center py-10">加载中...</p>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
          <button id="school-accounts-refresh" class="btn btn-ghost">
            刷新
          </button>
          <button id="school-accounts-ok" class="btn btn-primary">确定</button>
        </div>
      </div>
    </div>

    <div
      id="edit-school-account-modal"
      class="fixed inset-0 hidden z-[1055] flex items-center justify-center p-4"
      style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px)"
    >
      <div
        class="bg-gradient-to-br from-slate-50 to-white rounded-3xl shadow-2xl max-w-[560px] w-full transform transition-all"
        style="
          box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.1),
            -12px -12px 24px rgba(255, 255, 255, 0.9);
        "
        onclick="event.stopPropagation()"
      >
        <div class="p-6 pb-4 border-b border-slate-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-sky-400 to-blue-500 flex items-center justify-center flex-shrink-0"
                style="
                  box-shadow: 4px 4px 8px rgba(56, 189, 248, 0.3),
                    -2px -2px 8px rgba(255, 255, 255, 0.8);
                "
              >
                <svg
                  class="w-6 h-6 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  />
                </svg>
              </div>
              <h3
                class="text-xl font-bold text-slate-800"
                id="edit-school-account-modal-title"
              >
                编辑 School Account
              </h3>
            </div>
            <button
              onclick="closeEditSchoolAccountModal()"
              class="text-slate-400 hover:text-slate-600 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="p-6 space-y-4">
          <form id="edit-school-account-form" class="space-y-4">
            <div class="space-y-2">
              <label
                for="edit-school-account-auth-username"
                class="block text-sm font-medium text-slate-700"
              >
                认证用户 (Auth Username)
              </label>
              <input
                type="text"
                id="edit-school-account-auth-username"
                name="auth_username"
                class="w-full px-4 py-2.5 text-slate-700 bg-slate-100 border border-slate-300 rounded-lg cursor-not-allowed"
                readonly
                placeholder="认证用户名"
                style="box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.1)"
              />
            </div>

            <div class="space-y-2">
              <label
                for="edit-school-account-school-username"
                class="block text-sm font-medium text-slate-700"
              >
                学校账号用户名 (School Username)
                <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="edit-school-account-school-username"
                name="school_username"
                class="w-full px-4 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition"
                placeholder="请输入学校账号用户名"
                required
                style="box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05)"
              />
            </div>

            <div class="space-y-2">
              <label
                for="edit-school-account-password"
                class="block text-sm font-medium text-slate-700"
              >
                密码 (Password) <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="edit-school-account-password"
                name="password"
                class="w-full px-4 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition font-mono"
                placeholder="请输入密码"
                required
                style="box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05)"
              />
            </div>

            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <label
                  for="edit-school-account-ua"
                  class="block text-sm font-medium text-slate-700"
                >
                  User Agent (UA)
                </label>
                <button
                  type="button"
                  onclick="generateRandomUAForSchoolAccount()"
                  class="px-3 py-1 text-xs font-medium text-sky-600 bg-sky-50 border border-sky-200 rounded-lg hover:bg-sky-100 transition-all flex items-center gap-1"
                  title="点击生成随机User-Agent"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  随机UA
                </button>
              </div>
              <textarea
                id="edit-school-account-ua"
                name="ua"
                rows="3"
                class="w-full px-4 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition font-mono text-sm resize-none"
                placeholder="（可选）请输入 User Agent"
                style="box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05)"
              ></textarea>
              <p class="text-xs text-slate-500">
                如果不填写，将使用系统默认 User
                Agent。点击"随机UA"按钮可自动生成。
              </p>
            </div>

            <input
              type="hidden"
              id="edit-school-account-original-username"
              name="original_username"
            />
          </form>
        </div>

        <div class="px-6 pb-6 flex gap-3 justify-end">
          <button
            type="button"
            onclick="closeEditSchoolAccountModal()"
            class="px-6 py-2.5 rounded-lg font-medium text-slate-600 bg-white border border-slate-300 hover:bg-slate-50 transition-all"
            style="
              box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1),
                -1px -1px 2px rgba(255, 255, 255, 0.8);
            "
          >
            取消
          </button>
          <button
            type="button"
            onclick="submitSchoolAccount()"
            class="px-6 py-2.5 rounded-lg font-medium text-white bg-gradient-to-br from-sky-400 to-blue-500 hover:from-sky-500 hover:to-blue-600 transition-all"
            style="
              box-shadow: 2px 2px 4px rgba(56, 189, 248, 0.4),
                -1px -1px 2px rgba(255, 255, 255, 0.6);
            "
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <div
      id="loading-overlay"
      class="absolute inset-0 z-50 flex flex-col items-center justify-center gap-6 bg-white/80"
    >
      <div class="loader"></div>
      <p class="text-base font-bold text-sky-600">正在加载资源中...</p>
    </div>

    <div
      id="captcha-verification-modal"
      class="fixed inset-0 hidden z-[10001] flex items-center justify-center p-4"
      style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px)"
    >
      <div
        class="bg-gradient-to-br from-slate-50 to-white rounded-3xl shadow-2xl max-w-[560px] w-full transform transition-all"
        style="
          box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.1),
            -12px -12px 24px rgba(255, 255, 255, 0.9);
        "
        onclick="event.stopPropagation()"
      >
        <div class="p-6 pb-4 border-b border-slate-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-sky-400 to-blue-500 flex items-center justify-center flex-shrink-0"
                style="
                  box-shadow: 4px 4px 8px rgba(56, 189, 248, 0.3),
                    -2px -2px 8px rgba(255, 255, 255, 0.8);
                "
              >
                <svg
                  class="w-6 h-6 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                  />
                </svg>
              </div>
              <h3 class="text-xl font-bold text-slate-800">安全验证</h3>
            </div>
            <button
              onclick="closeCaptchaModal()"
              class="text-slate-400 hover:text-slate-600 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="p-6 space-y-4">
          <p class="text-slate-600 text-sm">
            为保护您的账号安全，请完成以下验证
          </p>

          <div class="space-y-2">
            <label class="block text-sm font-semibold text-slate-700"
              >图形验证码</label
            >
            <div class="relative w-full">
              <div
                id="captcha-modal-display"
                class="w-auto h-auto flex items-center justify-center border-2 border-slate-300 rounded-lg bg-white cursor-pointer hover:border-sky-400 transition-colors"
                onclick="refreshCaptchaModal()"
                title="点击刷新验证码"
                style="min-height: 64px"
              >
                <span class="text-slate-400 text-xs">加载中...</span>
              </div>
              <button
                onclick="refreshCaptchaModal()"
                class="absolute top-2 right-2 btn btn-ghost !p-2 text-slate-500 hover:text-sky-600 transition-colors"
                title="刷新验证码"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-semibold text-slate-700"
              >请输入验证码</label
            >
            <input
              type="text"
              id="captcha-modal-input"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-sky-400 focus:outline-none transition-colors"
              placeholder="请输入图形验证码"
              maxlength="6"
              autocomplete="off"
            />
          </div>
        </div>

        <div class="p-6 pt-0 flex gap-3">
          <button
            onclick="closeCaptchaModal()"
            class="flex-1 py-3 px-4 rounded-xl font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all"
            style="
              box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.08),
                -2px -2px 8px rgba(255, 255, 255, 0.9);
            "
          >
            取消
          </button>
          <button
            id="captcha-modal-confirm-btn"
            onclick="confirmCaptchaAndSendSMS()"
            class="flex-1 py-3 px-4 rounded-xl font-semibold text-white bg-gradient-to-br from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 transition-all"
            style="
              box-shadow: 4px 4px 12px rgba(56, 189, 248, 0.3),
                -2px -2px 8px rgba(255, 255, 255, 0.1);
            "
          >
            确认发送
          </button>
        </div>
      </div>
    </div>

    <div
      id="auth-login-container"
      class="hidden w-full h-full flex items-center justify-center"
    >
      <div class="panel rounded-2xl w-full max-w-[600px] p-6 space-y-6">
        <div class="text-center">
          <h2 class="text-3xl font-bold text-sky-700 card-title mb-2">
            跑步助手
          </h2>
          <p class="text-sm text-slate-500">请登录或注册以继续使用</p>
        </div>

        <div class="flex border-b border-slate-200">
          <button
            id="auth-tab-login"
            class="flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition"
          >
            登录
          </button>
          <button
            id="auth-tab-register"
            class="flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition hover:text-slate-600"
          >
            注册
          </button>
        </div>

        <div
          id="auth-login-form"
          class="space-y-4 overflow-y-auto max-h-[60vh] p-1"
        >
          <div
            id="auth-login-type-toggle"
            class="flex justify-center gap-2 pb-2"
          >
            <button
              id="auth-login-username-btn"
              class="px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm"
            >
              用户名登录
            </button>
            <button
              id="auth-login-phone-btn"
              class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm"
            >
              手机号登录
            </button>
          </div>

          <div>
            <label
              class="block text-sm font-semibold leading-6 text-slate-700"
              id="auth-login-label"
              >用户名</label
            >
            <div id="auth-username-container">
              <input
                type="text"
                id="auth-username"
                class="input-field mt-1"
                placeholder="请输入用户名"
                autocomplete="username"
              />
            </div>
          </div>

          <div id="auth-password-section">
            <div class="flex justify-between items-center">
              <label
                class="block text-sm font-semibold leading-6 text-slate-700"
                >密码</label
              >
              <button
                type="button"
                id="auth-switch-to-sms"
                class="text-xs text-sky-600 hover:text-sky-700 hidden"
              >
                使用验证码登录
              </button>
            </div>
            <input
              type="password"
              id="auth-password"
              class="input-field mt-1"
              placeholder="请输入密码"
              autocomplete="current-password"
            />
          </div>

          <div id="auth-sms-section" class="hidden">
            <div class="flex justify-between items-center">
              <label
                class="block text-sm font-semibold leading-6 text-slate-700"
                >验证码</label
              >
              <button
                type="button"
                id="auth-switch-to-password"
                class="text-xs text-sky-600 hover:text-sky-700"
              >
                使用密码登录
              </button>
            </div>
            <div class="flex gap-2 mt-1">
              <input
                type="text"
                id="auth-sms-code"
                class="input-field flex-1"
                placeholder="请输入验证码"
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
              />
              <button
                type="button"
                id="auth-send-login-code"
                class="btn btn-primary whitespace-nowrap"
                style="min-height: 44px"
              >
                发送验证码
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >验证码</label
            >
            <div class="flex gap-2 mt-1 items-center">
              <div
                id="auth-login-captcha-display"
                class="flex-shrink-0 w-auto h-auto flex items-center justify-center border border-slate-300 rounded bg-white cursor-pointer hover:border-sky-400 transition-colors"
                title="点击刷新验证码"
                style="min-height: 64px"
              >
                <span class="text-slate-400 text-xs">加载中...</span>
              </div>
              <button
                type="button"
                id="auth-login-captcha-refresh"
                class="btn btn-ghost !p-2"
                title="刷新验证码"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
              </button>
            </div>
            <div class="mt-2">
              <input
                type="text"
                id="auth-login-captcha"
                class="input-field w-full"
                placeholder="请输入验证码"
                maxlength="6"
                autocomplete="off"
              />
            </div>
          </div>

          <button
            id="auth-login-btn"
            class="btn btn-primary w-full py-3"
            style="min-height: 44px"
          >
            登录
          </button>
          <div id="guest-login-section" class="text-center hidden">
            <div class="relative flex py-2 items-center">
              <div class="flex-grow border-t border-slate-200"></div>
              <span class="flex-shrink mx-4 text-slate-400 text-xs">或</span>
              <div class="flex-grow border-t border-slate-200"></div>
            </div>
            <button id="auth-guest-btn" class="btn btn-ghost w-full">
              以游客身份继续
            </button>
            <div
              class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-left"
            >
              <div class="flex items-start gap-2">
                <svg
                  class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                  />
                </svg>
                <div class="text-xs text-amber-800">
                  <p class="font-semibold mb-1">⚠️ 游客模式提示</p>
                  <ul class="space-y-1">
                    <li>• 游客使用UUID恢复状态，请务必保存地址</li>
                    <li>• 丢失URL将无法恢复您的数据和进度</li>
                    <li>• 5分钟不活跃会话将被自动清理</li>
                    <li>• 建议注册账号以获得更好的体验</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          id="auth-register-form"
          class="hidden space-y-4 overflow-y-auto max-h-[60vh] p-1"
        >
          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >用户名</label
            >
            <input
              type="text"
              id="auth-reg-username"
              class="input-field mt-1"
              placeholder="请输入用户名（3-20字符，不含中文）"
              autocomplete="username"
            />
          </div>

          <div id="auth-reg-phone-wrapper">
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >手机号</label
            >
            <div class="phone-input-wrapper mt-1">
              <span class="phone-prefix">+86 </span>
              <input
                type="tel"
                id="auth-reg-phone"
                class="input-field"
                placeholder="请输入手机号"
                autocomplete="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="11"
              />
            </div>
          </div>

          <div id="auth-reg-sms-wrapper">
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >验证码</label
            >
            <div class="flex gap-2">
              <input
                type="text"
                id="auth-reg-sms-code"
                class="input-field mt-1 flex-1"
                placeholder="请输入验证码"
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
              />
              <button
                id="auth-reg-send-code-btn"
                class="btn btn-primary mt-1 whitespace-nowrap"
                style="min-height: 44px"
              >
                发送验证码
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >昵称</label
            >
            <input
              type="text"
              id="auth-reg-nickname"
              class="input-field mt-1"
              placeholder="请输入昵称（可含中文）"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >头像</label
            >
            <div class="flex items-center gap-3 mt-1">
              <img
                id="auth-reg-avatar-preview"
                src="/static/default_avatar.png"
                class="w-16 h-16 rounded-full object-cover border-2 border-slate-200"
              />
              <input
                type="file"
                id="auth-reg-avatar"
                accept="image/*"
                class="hidden"
              />
              <button
                class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm"
                onclick="document.getElementById('auth-reg-avatar').click(); return false;"
              >
                <svg
                  class="w-4 h-4 mr-1.5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                  ></path>
                </svg>
                上传头像
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >密码</label
            >
            <input
              type="password"
              id="auth-reg-password"
              class="input-field mt-1"
              placeholder="请输入密码（至少6字符）"
              autocomplete="new-password"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >确认密码</label
            >
            <input
              type="password"
              id="auth-reg-password-confirm"
              class="input-field mt-1"
              placeholder="请再次输入密码"
              autocomplete="new-password"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >验证码</label
            >
            <div class="flex gap-2 mt-1 items-center">
              <div
                id="auth-register-captcha-display"
                class="flex-shrink-0 w-auto h-auto flex items-center justify-center border border-slate-300 rounded bg-white cursor-pointer hover:border-sky-400 transition-colors"
                title="点击刷新验证码"
                style="min-height: 64px"
              >
                <span class="text-slate-400 text-xs">加载中...</span>
              </div>
              <button
                type="button"
                id="auth-register-captcha-refresh"
                class="btn btn-ghost !p-2"
                title="刷新验证码"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
              </button>
            </div>
            <div class="mt-2">
              <input
                type="text"
                id="auth-register-captcha"
                class="input-field w-full"
                placeholder="请输入验证码"
                maxlength="6"
                autocomplete="off"
              />
            </div>
          </div>

          <button
            id="auth-register-btn"
            class="btn btn-success w-full py-3"
            style="min-height: 44px"
          >
            注册
          </button>
        </div>

        <div id="auth-2fa-form" class="hidden space-y-4">
          <div class="text-center mb-4">
            <h3 class="text-xl font-bold text-sky-700 mb-2">双因素认证</h3>
            <p class="text-sm text-slate-500">
              请输入您的验证器应用中的6位验证码
            </p>
          </div>
          <div id="auth-reg-sms-wrapper">
            <label class="block text-sm font-semibold leading-6 text-slate-700"
              >验证码</label
            >
            <input
              type="text"
              id="auth-2fa-code"
              class="input-field mt-1"
              placeholder="输入6位验证码"
              maxlength="6"
              inputmode="numeric"
              pattern="[0-9]{6}"
              autocomplete="one-time-code"
            />
          </div>
          <button id="auth-2fa-verify-btn" class="btn btn-primary w-full py-3">
            验证
          </button>
          <button id="auth-2fa-back-btn" class="btn btn-ghost w-full">
            返回登录
          </button>
        </div>

        <div
          id="auth-error-msg"
          class="hidden text-sm text-center p-3 rounded-lg bg-red-50 border border-red-200 text-red-600"
        ></div>
        <div
          id="auth-success-msg"
          class="hidden text-sm text-center p-3 rounded-lg bg-green-50 border border-green-200 text-green-600"
        ></div>
      </div>
    </div>

    <!-- ========================================
       【桌面端容器】Desktop Container
       ======================================== -->
    <div id="desktop-container">
      <!-- 登录界面 -->
      <div
        id="login-container"
        class="w-full h-full grid grid-cols-1 lg:grid-cols-3"
      >
        

        <div
          class="flex flex-col items-center justify-center p-8 lg:p-12 bg-gradient-to-br from-purple-50 via-violet-50 to-purple-100 relative overflow-hidden"
        >
          <div
            class="absolute top-0 right-0 w-64 h-64 bg-violet-200 rounded-full opacity-20 blur-3xl -translate-y-1/2 translate-x-1/2"
          ></div>
          <div
            class="absolute bottom-0 left-0 w-48 h-48 bg-purple-300 rounded-full opacity-20 blur-2xl translate-y-1/2 -translate-x-1/2"
          ></div>

          <div
            class="relative text-center w-full max-w-sm space-y-7 panel rounded-3xl p-10 bg-white/60 backdrop-blur-xl shadow-2xl border border-white/50 hover:shadow-violet-200/50 transition-all duration-500 hover:scale-[1.02]"
          >
            <div class="relative inline-block">
              <div
                class="absolute inset-0 bg-violet-400 rounded-full blur-2xl opacity-30 animate-pulse"
              ></div>

              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="relative w-20 h-20 mx-auto text-violet-600 drop-shadow-lg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"
                />
              </svg>
            </div>

            <h2
              class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-violet-600 to-purple-600 bg-clip-text text-transparent card-title leading-tight"
            >
              掌上莲峰<br />多账号模式
            </h2>

            <div class="space-y-3">
              <p class="text-slate-600 text-base leading-relaxed">
                ✨ 支持批量导入账号<br />
                🎯 统一管理所有任务<br />
                ⚡ 一键执行全部流程
              </p>
            </div>

            <button
              id="multi-account-btn"
              class="btn btn-secondary w-full py-3.5 text-lg font-bold shadow-xl shadow-violet-300/40 hover:shadow-2xl hover:shadow-violet-400/50 transition-all duration-300"
            >
              <span>进入多账号控制台</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
        </div>

        <div
          class="flex items-center justify-center p-6 lg:p-8 bg-gradient-to-br from-white via-sky-50/30 to-cyan-50/40 relative overflow-hidden"
        >
          <div
            class="absolute top-0 right-0 w-64 h-64 bg-sky-300 rounded-full opacity-10 blur-3xl translate-x-1/3 -translate-y-1/3"
          ></div>
          <div
            class="absolute bottom-0 left-0 w-48 h-48 bg-cyan-200 rounded-full opacity-15 blur-2xl -translate-x-1/4 translate-y-1/4"
          ></div>

          <div
            class="relative panel rounded-3xl w-full max-w-md p-10 space-y-7 shadow-2xl border border-white/60 hover:shadow-sky-200/40 transition-all duration-300"
          >
            <div class="flex items-center justify-center gap-3 pb-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-8 h-8 text-sky-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
              <h2
                class="text-3xl lg:text-4xl font-bold text-sky-700 card-title"
              >
                单账号登录
              </h2>
            </div>

            <div class="text-center">
              <p class="text-slate-500 text-sm">掌上莲峰跑步助手</p>
            </div>

            <div class="space-y-5 w-full">
              <div class="space-y-2">
                <label
                  class="block text-sm font-bold leading-6 text-slate-700 flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4 text-slate-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                    />
                  </svg>
                  选择账号
                </label>
                <select
                  id="user-combo"
                  class="select-field hover:border-sky-400 focus:border-sky-600 cursor-pointer transition-all duration-200"
                  title="选择已保存的账号或创建新账号"
                  aria-label="选择账号"
                ></select>
              </div>

              <div class="space-y-2">
                <label
                  class="block text-sm font-bold leading-6 text-slate-700 flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4 text-slate-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    />
                  </svg>
                  用户名
                </label>
                <input
                  type="text"
                  id="username-entry"
                  class="input-field hover:border-sky-400 focus:border-sky-600 transition-all duration-200"
                  placeholder="请输入学号或工号"
                  autocomplete="username"
                />
              </div>

              <div class="space-y-2">
                <label
                  class="block text-sm font-bold leading-6 text-slate-700 flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4 text-slate-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                    />
                  </svg>
                  密码
                </label>
                <input
                  type="password"
                  id="password-entry"
                  class="input-field hover:border-sky-400 focus:border-sky-600 transition-all duration-200"
                  placeholder="请输入密码"
                  autocomplete="current-password"
                />
              </div>
            </div>

            <button
              id="login-button"
              class="btn btn-primary w-full py-3.5 text-lg font-bold shadow-xl shadow-sky-300/40 hover:shadow-2xl hover:shadow-sky-400/50 transition-all duration-300"
            >
              <span>立即登录</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>

            <div class="relative flex py-3 items-center">
              <div class="flex-grow border-t border-slate-300"></div>
              <span class="flex-shrink mx-5 text-slate-400 text-sm font-medium"
                >或者</span
              >
              <div class="flex-grow border-t border-slate-300"></div>
            </div>

            <button
              id="import-button"
              class="btn btn-success w-full py-3 font-bold shadow-lg shadow-green-300/30 hover:shadow-xl hover:shadow-green-400/40 transition-all duration-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              <span>导入离线文件</span>
            </button>

            <div class="pt-4 space-y-3 border-t border-slate-200">
              <div class="flex justify-between items-center">
                <span
                  class="text-sm font-semibold text-slate-600 flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4 text-slate-400"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  User-Agent 标识
                </span>

                <button
                  id="random-ua-btn"
                  title="随机生成新的User-Agent，用于模拟不同设备和浏览器"
                  class="btn btn-ghost !py-1.5 !px-3 text-xs hover:bg-sky-100 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  <span>随机</span>
                </button>
              </div>

              <p
                id="ua-label"
                class="text-xs text-slate-600 break-all bg-gradient-to-br from-white to-slate-50 border border-slate-300 p-3 rounded-xl leading-relaxed shadow-inner"
              >
                (未加载)
              </p>
            </div>
          </div>
        </div>

        <div
          class="flex flex-col items-center justify-center p-6 md:p-10 lg:p-12 bg-gradient-to-br from-sky-50 via-white to-cyan-50 relative overflow-hidden"
          id="admin-panel-modal-Inline"
        >
          <div
            class="absolute top-0 left-0 w-72 h-72 bg-sky-200 rounded-full opacity-10 blur-3xl -translate-y-1/3 -translate-x-1/3"
          ></div>
          <div
            class="absolute bottom-0 right-0 w-56 h-56 bg-cyan-300 rounded-full opacity-10 blur-2xl translate-y-1/3 translate-x-1/3"
          ></div>

          <div
            class="relative panel rounded-3xl w-full max-w-2xl p-8 space-y-5 bg-white/80 backdrop-blur-xl flex flex-col overflow-x-hidden shadow-2xl border border-white/60 hover:shadow-sky-200/50 transition-shadow duration-300"
            style="max-height: calc(100vh - 12rem)"
          >
            <div
              class="flex items-center justify-center gap-2 pb-2 border-b border-sky-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-sky-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              <h3 class="text-2xl font-bold text-sky-700 text-center">
                会话管理
              </h3>
            </div>

            <div
              id="admin-sessions-panel"
              class="space-y-4 overflow-y-auto overflow-x-hidden flex-grow min-h-0 pr-2"
            >
              <div
                class="flex justify-between items-center bg-gradient-to-r from-sky-50 to-transparent p-4 rounded-xl"
              >
                <h4 class="font-bold text-slate-700 text-lg">会话列表</h4>

                <div class="flex items-center gap-4">
                  <label
                    id="god-mode-toggle"
                    class="flex items-center gap-2 cursor-pointer bg-red-50 px-3 py-1.5 rounded-full hover:bg-red-100 transition-colors"
                    style="display: none"
                  >
                    <input
                      type="checkbox"
                      id="god-mode-checkbox"
                      class="w-4 h-4 accent-red-600 rounded cursor-pointer"
                    />
                    <span class="text-sm font-bold text-red-600"
                      >⚠️ 上帝模式</span
                    >
                  </label>

                  <div
                    id="admin-session-count-display-inline"
                    class="text-sm font-medium text-slate-600 bg-white/70 px-3 py-1.5 rounded-full border border-slate-200"
                  ></div>

                  <button
                    id="admin-refresh-sessions-inline"
                    class="btn btn-ghost !py-1.5 !px-3 hover:bg-sky-100 transition-colors"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                    <span>刷新</span>
                  </button>
                </div>
              </div>

              <div
                id="admin-sessions-list-inline"
                class="space-y-3 max-h-[50vh] overflow-y-auto pr-1"
              >
                <p class="text-slate-400 text-center py-12 text-base">
                  <svg
                    class="animate-spin h-8 w-8 mx-auto mb-3 text-sky-500"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  正在加载会话数据...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <main
        id="main-app"
        class="hidden h-screen w-screen grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4"
      >
        <div
          class="lg:col-span-1 xl:col-span-1 flex flex-col gap-4 h-full min-h-0 min-w-[320px]"
        >
          <div class="panel rounded-xl p-4 flex items-center gap-4">
            <div class="flex-1">
              <p id="user-name-label" class="font-bold text-slate-800 truncate">
                姓名: NULL
              </p>
              <p id="user-id-label" class="text-sm text-slate-500">
                学号: NULL
              </p>
            </div>

            <button
              id="show-notifications-btn"
              class="btn btn-ghost !py-2 !px-3 relative"
              title="查看通知"
            >
              <span>通知</span>
              <span
                id="notification-badge"
                class="hidden absolute -top-1 -right-1 w-4 h-4 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center"
                >0</span
              >
            </button>
            <button
              id="show-user-details"
              class="btn btn-ghost !py-2 !px-3"
              title="查看用户详情"
            >
              详情
            </button>
            <button
              id="show-admin-panel"
              class="btn btn-ghost !py-2 !px-3 hidden"
              title="管理面板"
            >
              管理
            </button>
            <button
              id="logout-button"
              class="btn btn-ghost !py-2 !px-3 !text-red-600"
              title="注销"
            >
              退出
            </button>
          </div>
          <div class="panel rounded-xl p-4 flex-grow flex flex-col min-h-0">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-lg font-bold text-slate-800">任务列表</h2>
              <div class="flex gap-2">
                <button
                  id="show-task-details"
                  class="btn btn-ghost !py-1 !px-3"
                >
                  任务详情
                </button>
                <button id="refresh-button" class="btn btn-ghost !py-1 !px-3">
                  刷新
                </button>
              </div>
            </div>
            <div
              id="task-list"
              class="flex-grow overflow-y-auto -mr-2 pr-2"
            ></div>
          </div>
          <div class="panel rounded-xl p-4">
            <div class="flex border-b border-slate-200 -mx-4 px-2 space-x-2">
              <button
                class="tab-button active"
                onclick="showTab('run-control', this)"
              >
                执行
              </button>
              <button class="tab-button" onclick="showTab('path-tools', this)">
                路径
              </button>
              <button class="tab-button" onclick="showTab('checkpoints', this)">
                打卡点
              </button>
              <button class="tab-button" onclick="showTab('attendance', this)">
                签到
              </button>
              <button class="tab-button" onclick="showTab('history', this)">
                历史
              </button>
              <button class="tab-button" onclick="showTab('params', this)">
                参数
              </button>
              <button class="tab-button" onclick="showTab('log', this)">
                日志
              </button>
            </div>
            <div class="h-56 overflow-y-auto">
              <div id="run-control-tab" class="pt-4 space-y-3">
                <div
                  id="run-stats-block"
                  class="text-center p-3 rounded-lg border border-slate-200 bg-white/80"
                >
                  <p class="text-sm text-slate-500">已选任务总览</p>
                  <p
                    id="run-stats-label"
                    class="font-bold text-2xl text-sky-600"
                  >
                    -- km / --:--
                  </p>
                </div>

                <div id="single-progress-block" class="mt-2">
                  <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div
                      id="single-progress-fill"
                      class="h-2 bg-sky-500"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div class="flex justify-between text-xs mt-1">
                    <span id="single-progress-text" class="text-slate-600"
                      >未开始</span
                    >
                    <span
                      id="single-progress-extra"
                      class="text-slate-400"
                    ></span>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <button id="start-run-button" class="btn btn-primary">
                    开始执行
                  </button>
                  <button id="start-all-button" class="btn btn-secondary">
                    执行所有
                  </button>
                </div>

                <div class="flex items-center justify-center space-x-4 pt-1">
                  <label
                    class="flex items-center gap-1.5 text-xs text-slate-700 cursor-pointer"
                    ><input
                      type="checkbox"
                      id="run-completed-check"
                      class="w-4 h-4 accent-sky-600 rounded"
                    /><span class="font-semibold">忽略已完成状态</span></label
                  >
                  <label
                    class="flex items-center gap-1.5 text-xs text-slate-700 cursor-pointer"
                    ><input
                      type="checkbox"
                      id="auto-gen-all-check"
                      class="w-4 h-4 accent-sky-600 rounded"
                    /><span class="font-semibold">自动生成路径</span></label
                  >
                </div>
              </div>
              <div id="path-tools-tab" class="hidden pt-4 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <button id="record-button" class="btn btn-success">
                    录制路径
                  </button>
                  <button id="auto-gen-button" class="btn btn-secondary">
                    自动生成
                  </button>
                  <button id="process-button" class="btn btn-primary">
                    处理路径
                  </button>
                  <button id="clear-button" class="btn btn-warning">
                    清除路径
                  </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="export-button"
                    class="btn btn-ghost border border-slate-300 col-span-1"
                  >
                    导出
                  </button>
                  <div class="col-span-1"></div>
                </div>
              </div>
              <div id="checkpoints-tab" class="hidden pt-2">
                <div id="target-points-text" class="h-48 overflow-y-auto"></div>
              </div>

              <div
                id="attendance-tab"
                class="hidden pt-2 space-y-2 h-56 flex flex-col"
              >
                <div class="flex-shrink-0 space-y-2 border-b pb-2">
                  <label
                    class="flex items-center gap-2 cursor-pointer"
                    title="开启后，将在后台自动刷新通知并尝试签到"
                  >
                    <input
                      type="checkbox"
                      id="param-auto_attendance_enabled"
                      data-key="auto_attendance_enabled"
                      class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0"
                    />
                    <span class="text-slate-700 font-semibold"
                      >开启自动签到</span
                    >
                  </label>

                  <div class="flex items-center gap-2">
                    <label
                      class="text-sm text-slate-700 font-semibold flex-shrink-0"
                      >刷新间隔(秒)</label
                    >
                    <input
                      type="number"
                      step="30"
                      id="param-auto_attendance_refresh_s"
                      data-key="auto_attendance_refresh_s"
                      class="input-field !py-1 w-full"
                      title="自动刷新通知的间隔时间（秒），建议不低于60"
                    />
                  </div>
                  <div class="flex items-center gap-2">
                    <label
                      class="text-sm text-slate-700 font-semibold flex-shrink-0"
                      >随机半径(米)</label
                    >
                    <input
                      type="number"
                      step="1"
                      id="param-attendance_user_radius_m"
                      data-key="attendance_user_radius_m"
                      class="input-field !py-1 w-full"
                      title="自动签到时，在服务器允许范围内的最大随机偏移半径。设为0为精确签到。"
                    />
                  </div>
                </div>
                <div
                  class="flex justify-between items-center border-t pt-2 mt-2"
                >
                  <h4 class="text-sm font-semibold text-slate-700">
                    签到任务列表
                  </h4>
                  <button
                    id="refresh-attendance-list-btn"
                    class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600"
                    onclick="refreshNotificationsUI(true, true)"
                  >
                    刷新
                  </button>
                </div>

                <div
                  id="attendance-list"
                  class="flex-grow overflow-y-auto pr-1"
                >
                  <p class="text-slate-400 text-center py-10 text-xs">
                    点击“刷新”按钮查看签到任务
                  </p>
                </div>
              </div>

              <div id="history-tab" class="hidden pt-2">
                <div id="history-list-container">
                  <p
                    id="history-placeholder"
                    class="text-slate-400 text-center py-16"
                  >
                    选择任务后显示历史记录
                  </p>
                  <div id="history-list"></div>
                </div>
              </div>
              <div id="params-tab" class="hidden space-y-3">
                <div id="params-container"></div>
              </div>
              <div id="log-tab" class="hidden pt-2">
                <div class="h-48">
                  <textarea
                    id="log-text"
                    readonly
                    class="w-full h-full bg-white/80 border border-slate-200 rounded-md p-2 text-xs text-slate-700 resize-none focus:outline-none leading-snug"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="lg:col-span-2 xl:col-span-3 flex flex-col gap-4 h-full min-h-0"
        >
          <div
            id="map-container"
            class="flex-grow bg-slate-200 rounded-xl relative overflow-hidden border border-slate-200"
          >
            <div
              class="absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200"
            >
              <button
                id="zoom-in"
                class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700"
              >
                +
              </button>
              <span
                id="zoom-level"
                class="text-xs font-mono select-none w-8 text-center"
                >17</span
              >
              <button
                id="zoom-out"
                class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700"
              >
                -
              </button>
              <button
                id="reset-view-btn"
                class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700"
                title="复位视角"
              >
                🎯
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 gap-4">
            <div class="panel rounded-xl p-4 flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <h3 class="font-bold text-slate-800">实时状态</h3>
                <p
                  class="text-sm font-mono text-slate-500"
                  id="current-location-label"
                >
                  当前位置GPS坐标: --, --
                </p>
              </div>
              <div
                class="grid grid-cols-4 divide-x divide-slate-200 text-center pt-2"
              >
                <div>
                  <p class="text-sm text-slate-500">已跑距离</p>
                  <p
                    id="live-dist-label"
                    class="font-bold text-xl text-slate-700"
                  >
                    0.00 km
                  </p>
                </div>
                <div>
                  <p class="text-sm text-slate-500">总距离</p>
                  <p
                    id="total-dist-label"
                    class="font-bold text-xl text-slate-700"
                  >
                    0.00 km
                  </p>
                </div>
                <div>
                  <p class="text-sm text-slate-500">已用时间</p>
                  <p
                    id="live-time-label"
                    class="font-bold text-xl text-slate-700"
                  >
                    00:00
                  </p>
                </div>
                <div>
                  <p class="text-sm text-slate-500">预计时间</p>
                  <p
                    id="total-time-label"
                    class="font-bold text-xl text-slate-700"
                  >
                    00:00
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <main
        id="multi-account-app"
        class="hidden h-screen w-screen grid grid-cols-1 lg:grid-cols-[530px,1fr] xl:grid-cols-[530px,1fr] gap-4 p-4"
      >
        <div class="flex flex-col gap-4 h-full min-h-0">
          <div class="panel rounded-xl p-4 flex-shrink-0">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-lg font-bold text-slate-800 card-title">
                多账号控制台
              </h2>
              <div class="flex gap-2">
                <button
                  id="show-admin-panel-multi"
                  class="btn btn-ghost !py-1 !px-3"
                  title="管理面板"
                >
                  管理面板
                </button>
                <button
                  id="exit-multi-mode-btn"
                  class="btn btn-ghost !py-1 !px-3"
                >
                  返回登录页
                </button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button id="multi-start-all-btn" class="btn btn-primary">
                全部开始
              </button>
              <button id="multi-stop-all-btn" class="btn btn-danger">
                全部停止
              </button>
            </div>
            <div class="mt-4 space-y-2 text-sm border-t pt-3">
              <label
                class="flex items-center gap-2 cursor-pointer font-semibold text-slate-700"
              >
                <input
                  type="checkbox"
                  id="multi-use-delay-check"
                  checked
                  class="w-4 h-4 accent-sky-600 rounded"
                />
                启用随机启动延迟
                <div class="flex items-center gap-2 pl-6">
                  <input
                    type="number"
                    id="multi-min-delay-input"
                    value="0"
                    class="input-field !py-1 w-20 text-center"
                  />
                  <span>-</span>
                  <input
                    type="number"
                    id="multi-max-delay-input"
                    value="300"
                    class="input-field !py-1 w-20 text-center"
                  />
                  <span>秒</span>
                </div>
              </label>
              <label
                class="flex items-center gap-2 cursor-pointer font-semibold text-slate-700 mt-2"
              >
                <input
                  type="checkbox"
                  id="multi-run-only-incomplete-check"
                  checked
                  class="w-4 h-4 accent-sky-600 rounded"
                />
                仅执行未完成的任务
              </label>
            </div>
          </div>
          <div class="panel rounded-xl p-4 flex-grow flex flex-col min-h-0">
            <div class="flex justify-between items-center mb-1">
              <div class="flex items-center gap-2">
                <h2 class="text-lg font-bold text-slate-800">
                  账号列表 (<span id="multi-account-count">0</span>)
                </h2>
                <input
                  type="checkbox"
                  id="multi-select-all-check"
                  class="w-4 h-4 accent-sky-600 rounded"
                  title="全选/取消全选"
                  style="display: none"
                />
              </div>
              <div class="flex gap-2">
                <button
                  id="multi-import-excel-btn"
                  class="btn btn-ghost !py-1 !px-3"
                  title="从文件导入"
                >
                  导入
                </button>
                <button
                  id="multi-export-excel-btn"
                  class="btn btn-ghost !py-1 !px-3"
                  title="导出汇总"
                >
                  导出
                </button>
                <button
                  id="multi-download-template-btn"
                  class="btn btn-ghost !py-1 !px-3"
                  title="下载导入模板"
                >
                  下载模板
                </button>
              </div>
            </div>

            <div
              class="flex items-center justify-between mb-3 text-xs border-b pb-2"
            >
              <!-- 左侧：刷新 -->
              <div class="flex items-center gap-2">
                <button
                  id="multi-refresh-selected-btn"
                  class="btn btn-ghost !py-0.5 !px-2 text-sm text-blue-600"
                >
                  刷新选中
                </button>
                <button
                  id="multi-refresh-all-btn"
                  class="btn btn-ghost !py-0.5 !px-2 text-sm text-blue-600"
                >
                  刷新全部
                </button>
              </div>

              <!-- 中央：控制 -->
              <div class="flex items-center gap-2">
                <button
                  id="multi-start-selected-btn"
                  class="btn btn-ghost !py-0.5 !px-2 text-sm text-green-600"
                >
                  开始选中
                </button>
                <button
                  id="multi-stop-selected-btn"
                  class="btn btn-ghost !py-0.5 !px-2 text-sm text-green-600"
                >
                  停止选中
                </button>
              </div>

              <!-- 右侧：移除 -->
              <div class="flex items-center gap-2">
                <button
                  id="multi-remove-selected-btn"
                  class="btn btn-ghost !py-0.5 !px-2 text-sm text-red-600"
                >
                  移除选中
                </button>
                <button
                  id="multi-remove-all-btn"
                  class="btn btn-ghost !py-0.5 !px-2 text-sm text-red-600"
                >
                  移除全部
                </button>
              </div>
            </div>

            <div
              id="multi-account-list"
              class="flex-grow overflow-y-auto -mr-2 pr-2"
              style="max-height: 42vh"
            >
              <p class="text-slate-400 text-center py-10">请先添加或导入账号</p>
            </div>
            <div class="mt-2 border-t pt-3 flex items-center gap-2">
              <select
                id="multi-config-user-select"
                class="select-field !py-1 flex-grow"
              ></select>
              <button
                id="multi-add-from-config-btn"
                class="btn btn-ghost !py-1 !px-2 flex-shrink-0"
              >
                添加
              </button>
              <button
                id="multi-load-all-from-config-btn"
                class="btn btn-ghost !py-1 !px-2 flex-shrink-0"
              >
                添加全部
              </button>
            </div>
          </div>
          <div class="panel rounded-xl p-4 flex-shrink-0">
            <h3 class="font-bold text-slate-800 mb-2">全局参数</h3>
            <div
              id="multi-global-params-container"
              class="h-40 overflow-y-auto pr-1"
            ></div>
          </div>
        </div>
        <div class="flex flex-col gap-4 h-full min-h-0">
          <div
            id="multi-map-container"
            class="flex-grow bg-slate-200 rounded-xl relative overflow-hidden border border-slate-200"
          >
            <div
              class="absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200"
            >
              <button
                id="multi-zoom-in"
                class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700"
              >
                +
              </button>
              <span
                id="multi-zoom-level"
                class="text-xs font-mono select-none w-8 text-center"
                >17</span
              >
              <button
                id="multi-zoom-out"
                class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700"
              >
                -
              </button>
              <button
                id="multi-reset-view-btn"
                class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700"
                title="复位视角"
              >
                🎯
              </button>
            </div>
          </div>
          <div class="panel rounded-xl p-4 h-48 flex flex-col">
            <h3 class="font-bold text-slate-800 mb-2">全局日志</h3>
            <textarea
              id="multi-log-text"
              readonly
              class="w-full flex-grow bg-white/80 border border-slate-200 rounded-md p-2 text-xs text-slate-700 resize-none focus:outline-none leading-snug"
            ></textarea>
          </div>
        </div>
      </main>

      <div
        id="amap-key-modal"
        class="fixed inset-0 flex items-center justify-center hidden z-50"
      >
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
          <h3 class="text-xl font-bold text-red-600 text-center">
            缺少地图API Key
          </h3>
          <p class="text-sm text-slate-600 text-center">
            程序需要一个有效的高德地图JS API Key才能使用地图功能。请前往
            <a
              href="https://console.amap.com/dev/key/app"
              target="_blank"
              class="text-sky-600 hover:underline"
              >高德开放平台</a
            >
            申请一个Key（类型选择“Web端(JS API)”），然后粘贴到下方。
          </p>
          <div class="space-y-2">
            <label class="w-full text-slate-700 font-semibold">API Key:</label>
            <input
              id="amap-key-input"
              type="text"
              class="input-field w-full"
              placeholder="请在此处粘贴你的API Key"
            />
          </div>
          <div class="flex justify-end gap-3 pt-4">
            <button id="confirm-amap-key-btn" class="btn btn-primary">
              确认并保存
            </button>
          </div>
        </div>
      </div>

      <div
        id="auto-gen-modal"
        class="fixed inset-0 flex items-center justify-center hidden z-50"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
          <h3 class="text-xl font-bold text-sky-600 text-center">
            自动生成路线配置
          </h3>
          <div class="space-y-4">
            <div class="flex items-center">
              <label class="w-32 text-slate-700 font-semibold"
                >最短时间(分钟)</label
              >
              <input
                id="min-time-input"
                type="number"
                value="20"
                class="input-field w-full"
              />
            </div>
            <div class="flex items-center">
              <label class="w-32 text-slate-700 font-semibold"
                >最长时间(分钟)</label
              >
              <input
                id="max-time-input"
                type="number"
                value="30"
                class="input-field w-full"
              />
            </div>
            <div class="flex items-center">
              <label class="w-32 text-slate-700 font-semibold"
                >最短距离(米)</label
              >
              <input
                id="min-dist-input"
                type="number"
                value="2000"
                class="input-field w-full"
              />
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-4">
            <button
              id="cancel-gen-button"
              class="btn btn-ghost border border-slate-300"
            >
              取消
            </button>
            <button id="confirm-gen-button" class="btn btn-primary">
              生成
            </button>
          </div>
        </div>
      </div>
      <div
        id="user-details-modal"
        class="fixed inset-0 hidden items-center justify-center z-50"
      >
        <div
          class="absolute inset-0 bg-black/40"
          onclick="toggleUserDetails(false)"
        ></div>
        <div class="panel rounded-2xl p-6 w-[32rem] space-y-4 relative">
          <div class="flex items-center justify-center gap-2">
            <h3 class="text-xl font-bold text-sky-600 text-center">用户详情</h3>
          </div>
          <div
            id="user-details-content"
            class="text-sm space-y-1 max-h-[70vh] overflow-y-auto"
          ></div>
          <div class="flex justify-end pt-2">
            <button
              class="btn btn-ghost border border-slate-300"
              onclick="toggleUserDetails(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>
      <div
        id="task-details-modal"
        class="fixed inset-0 hidden items-center justify-center z-50"
      >
        <div
          class="absolute inset-0 bg-black/40"
          onclick="toggleTaskDetails(false)"
        ></div>
        <div class="panel rounded-2xl p-6 w-[36rem] space-y-4 relative">
          <div class="flex items-center justify-center gap-2">
            <h3 class="text-xl font-bold text-sky-600 text-center">任务详情</h3>
          </div>
          <div
            id="task-details-content"
            class="text-sm space-y-1 max-h-[70vh] overflow-y-auto"
          ></div>
          <div class="flex justify-end pt-2">
            <button
              class="btn btn-ghost border border-slate-300"
              onclick="toggleTaskDetails(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================================
       【移动端容器】Mobile Container
       ======================================== -->
    <div id="mobile-container">
      <header
        class="mobile-header hidden relative flex items-center w-full h-14 px-2 bg-white shadow-sm"
        id="mobile-header"
        style="display: none"
      >
        <button
          id="mobile-menu-btn"
          class="p-2 -ml-5 text-slate-700 hover:bg-slate-100 rounded-md"
          aria-label="菜单"
          style="display: none"
          onclick="toggleMobileSidebar()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>

        <div
          class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center whitespace-nowrap"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 text-sky-600"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"
            />
          </svg>
          <span class="ml-2 text-lg font-bold text-slate-800">跑步助手</span>
        </div>
      </header>
      <main class="mobile-content">
        <div id="mobile-auth-login-container" class="space-y-4">
          <div class="mobile-card">
            <div class="text-center mb-6">
              <h1 class="mobile-title">欢迎使用跑步助手</h1>
              <p class="mobile-subtitle">请登录或注册以继续使用</p>
            </div>

            <div class="flex border-b border-slate-200 mb-4">
              <button
                id="mobile-auth-tab-login"
                class="flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition"
              >
                登录
              </button>
              <button
                id="mobile-auth-tab-register"
                class="flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition"
              >
                注册
              </button>
            </div>

            <div id="mobile-login-form" class="space-y-4">
              <div class="flex justify-center gap-2 pb-2">
                <button
                  id="mobile-login-username-btn"
                  class="px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm"
                >
                  用户名登录
                </button>
                <button
                  id="mobile-login-phone-btn"
                  class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm"
                >
                  手机号登录
                </button>
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label" id="mobile-login-label"
                  >用户名</label
                >
                <div id="mobile-username-container" class="mt-1">
                  <input
                    type="text"
                    id="mobile-auth-username"
                    class="w-full"
                    placeholder="请输入用户名"
                    autocomplete="username"
                  />
                </div>
              </div>

              <div id="mobile-password-section" class="mobile-form-group">
                <div class="flex justify-between items-center mb-2">
                  <label class="mobile-form-label !mb-0">密码</label>
                  <button
                    type="button"
                    id="mobile-switch-to-sms"
                    class="text-sm text-sky-600 hover:text-sky-700 hidden"
                  >
                    使用验证码
                  </button>
                </div>
                <input
                  type="password"
                  id="mobile-auth-password"
                  class="w-full"
                  placeholder="请输入密码"
                  autocomplete="current-password"
                />
              </div>

              <div id="mobile-sms-section" class="mobile-form-group hidden">
                <div class="flex justify-between items-center mb-2">
                  <label class="mobile-form-label !mb-0">验证码</label>
                  <button
                    type="button"
                    id="mobile-switch-to-password"
                    class="text-sm text-sky-600 hover:text-sky-700"
                  >
                    使用密码
                  </button>
                </div>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="mobile-auth-sms-code"
                    class="w-full flex-1"
                    placeholder="6位验证码"
                    maxlength="6"
                    inputmode="numeric"
                  />
                  <button
                    type="button"
                    id="mobile-auth-send-login-code"
                    class="btn btn-primary whitespace-nowrap !py-0 !px-4 !text-base"
                  >
                    发送
                  </button>
                </div>
              </div>

              <!-- ========================================
                 【验证码区域】移动端登录表单验证码
                 ======================================== -->
              <div class="mobile-form-group">
                <label class="mobile-form-label">验证码</label>
                <div class="mt-1">
                  <div
                    id="mobile-login-captcha-display"
                    class="w-full h-auto flex items-center justify-center border border-slate-300 rounded bg-white cursor-pointer hover:border-sky-400 transition-colors"
                    title="点击刷新验证码"
                    style="min-height: 64px"
                    onclick="refreshCaptcha('mobile-login')"
                  >
                    <span class="text-slate-400 text-xs">加载中...</span>
                  </div>
                </div>
                <div class="mt-2">
                  <button
                    type="button"
                    id="mobile-login-captcha-refresh"
                    class="w-full py-2 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium"
                    title="刷新验证码"
                    onclick="refreshCaptcha('mobile-login')"
                  >
                    刷新验证码
                  </button>
                </div>
                <div class="mt-2">
                  <input
                    type="text"
                    id="mobile-login-captcha"
                    class="w-full"
                    placeholder="请输入验证码"
                    maxlength="6"
                    autocomplete="off"
                  />
                </div>
              </div>

              <button id="mobile-login-btn" class="mobile-primary-btn">
                登录
              </button>

              <div id="mobile-guest-login-section" class="text-center hidden">
                <div class="relative flex py-2 items-center">
                  <div class="flex-grow border-t border-slate-200"></div>
                  <span class="flex-shrink mx-4 text-slate-400 text-xs"
                    >或</span
                  >
                  <div class="flex-grow border-t border-slate-200"></div>
                </div>
                <button id="mobile-guest-btn" class="mobile-secondary-btn">
                  以游客身份继续
                </button>
              </div>
            </div>

            <div id="mobile-register-form" class="space-y-4 hidden">
              <div class="mobile-form-group">
                <label class="mobile-form-label">用户名</label>
                <input
                  type="text"
                  id="mobile-reg-username"
                  class="w-full"
                  placeholder="3-20字符，不含中文"
                  autocomplete="username"
                />
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label">手机号</label>
                <div class="phone-input-wrapper mt-1">
                  <span class="phone-prefix">+86 </span>
                  <input
                    type="tel"
                    id="mobile-reg-phone"
                    class="input-field"
                    placeholder="请输入手机号"
                    autocomplete="tel"
                    inputmode="numeric"
                    maxlength="11"
                  />
                </div>
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label">验证码</label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="mobile-reg-sms-code"
                    class="w-full flex-1"
                    placeholder="6位验证码"
                    maxlength="6"
                    inputmode="numeric"
                  />
                  <button
                    id="mobile-reg-send-code-btn"
                    class="btn btn-primary whitespace-nowrap !py-0 !px-4 !text-base"
                  >
                    发送
                  </button>
                </div>
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label">昵称</label>
                <input
                  type="text"
                  id="mobile-reg-nickname"
                  class="w-full"
                  placeholder="请输入昵称（可含中文）"
                />
              </div>

              <div class="mobile-form-group" id="mobile-reg-avatar-group">
                <label class="mobile-form-label">头像</label>
                <div class="flex items-center gap-3 mt-1">
                  <img
                    id="mobile-reg-avatar-preview"
                    src="/static/default_avatar.png"
                    class="w-16 h-16 rounded-full object-cover border-2 border-slate-200"
                  />
                  <input
                    type="file"
                    id="mobile-reg-avatar"
                    accept="image/*"
                    class="hidden"
                  />
                  <button
                    class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm"
                    id="mobile-reg-upload-avatar-btn"
                    onclick="document.getElementById('mobile-reg-avatar').click(); return false;"
                  >
                    <svg
                      class="w-4 h-4 mr-1.5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                      ></path>
                    </svg>
                    上传头像
                  </button>
                </div>
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label">密码</label>
                <input
                  type="password"
                  id="mobile-reg-password"
                  class="w-full"
                  placeholder="请输入密码（至少6字符）"
                  autocomplete="new-password"
                />
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label">确认密码</label>
                <input
                  type="password"
                  id="mobile-reg-password-confirm"
                  class="w-full"
                  placeholder="请再次输入密码"
                  autocomplete="new-password"
                />
              </div>

              <!-- ========================================
                 【验证码区域】移动端注册表单验证码
                 ======================================== -->
              <div class="mobile-form-group">
                <label class="mobile-form-label">验证码</label>
                <div class="mt-1">
                  <div
                    id="mobile-register-captcha-display"
                    class="w-full h-auto flex items-center justify-center border border-slate-300 rounded bg-white cursor-pointer hover:border-sky-400 transition-colors"
                    title="点击刷新验证码"
                    style="min-height: 64px"
                    onclick="refreshCaptcha('mobile-register')"
                  >
                    <span class="text-slate-400 text-xs">加载中...</span>
                  </div>
                </div>
                <div class="mt-2">
                  <button
                    type="button"
                    id="mobile-register-captcha-refresh"
                    class="w-full py-2 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium"
                    title="刷新验证码"
                    onclick="refreshCaptcha('mobile-register')"
                  >
                    刷新验证码
                  </button>
                </div>
                <div class="mt-2">
                  <input
                    type="text"
                    id="mobile-register-captcha"
                    class="w-full"
                    placeholder="请输入验证码"
                    maxlength="6"
                    autocomplete="off"
                  />
                </div>
              </div>

              <button
                id="mobile-register-btn"
                class="mobile-primary-btn"
                style="
                  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                "
              >
                注册
              </button>
            </div>

            <div id="mobile-auth-2fa-form" class="space-y-4 hidden">
              <div class="text-center mb-4">
                <h3 class="font-bold text-lg text-slate-800">两步验证</h3>
                <p class="text-sm text-slate-600 mt-2">请输入您的验证码</p>
              </div>

              <div class="mobile-form-group">
                <label class="mobile-form-label">验证码</label>
                <input
                  type="text"
                  id="mobile-2fa-code"
                  class="w-full"
                  placeholder="请输入6位验证码"
                  maxlength="6"
                  inputmode="numeric"
                  autocomplete="one-time-code"
                />
              </div>

              <button id="mobile-2fa-submit-btn" class="mobile-primary-btn">
                验证
              </button>

              <div class="text-center">
                <button
                  id="mobile-2fa-back-btn"
                  class="text-sky-600 text-sm font-medium"
                >
                  返回登录
                </button>
              </div>
            </div>

            <div
              id="mobile-auth-error"
              class="hidden mt-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-600 text-sm text-center"
            ></div>

            <div
              id="mobile-auth-success"
              class="hidden mt-4 p-3 rounded-lg bg-green-50 border border-green-200 text-green-600 text-sm text-center"
            ></div>
          </div>
        </div>

        <!-- ========================================
           【容器2】移动端登录容器（三栏布局）
           ======================================== -->
        <div id="mobile-login-container" class="space-y-4 hidden">
          <!-- ========================================
             【区域1】单账号登录面板卡片（已调整顺序，原为区域3）
             ======================================== -->
          <div class="mobile-card" id="mobile-single-login-card">
            <h3 class="text-lg font-bold text-slate-800 mb-4">单账号登录</h3>

            <div class="mobile-form-group">
              <label class="mobile-form-label">选择用户</label>
              <select id="mobile-user-combo" class="w-full">
                <option value="">请选择用户</option>
              </select>
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">用户名</label>
              <input
                type="text"
                id="mobile-username-entry"
                class="w-full"
                placeholder="或直接输入用户名"
                autocomplete="username"
              />
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">密码</label>
              <input
                type="password"
                id="mobile-password-entry"
                class="w-full"
                placeholder="请输入密码"
                autocomplete="current-password"
              />
            </div>

            <button id="mobile-single-login-btn" class="mobile-primary-btn">
              登录
            </button>

            <!-- ========================================
               【分隔线】用于视觉区分主要操作和次要操作
               ======================================== -->
            <div class="relative flex py-2 items-center">
              <div class="flex-grow border-t border-slate-300"></div>
            </div>

            <!-- ========================================
               【导入离线文件按钮】移动端版本
               ======================================== -->
            <button
              id="mobile-import-button"
              class="w-full py-3 px-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-bold shadow-lg transition-all duration-300 flex items-center justify-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              <span>导入离线文件</span>
            </button>

            <!-- ========================================
               【User-Agent 显示区域】移动端版本
               ======================================== -->
            <div class="pt-4 space-y-3 border-t border-slate-200">
              <div class="flex justify-between items-center">
                <span
                  class="text-sm font-semibold text-slate-600 flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4 text-slate-400"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  User-Agent 标识
                </span>

                <button
                  id="mobile-random-ua-btn"
                  title="随机生成新的User-Agent，用于模拟不同设备和浏览器"
                  class="py-1.5 px-3 text-xs bg-slate-100 hover:bg-sky-100 text-slate-700 rounded-lg transition-colors flex items-center gap-1"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  <span>随机</span>
                </button>
              </div>

              <p
                id="mobile-ua-label"
                class="text-xs text-slate-600 break-all bg-gradient-to-br from-white to-slate-50 border border-slate-300 p-3 rounded-xl leading-relaxed shadow-inner"
              >
                (未加载)
              </p>
            </div>
          </div>

          <!-- ========================================
             【区域2】多账号模式入口卡片
             ======================================== -->
          <div class="mobile-card" id="mobile-multi-account-card">
            <div class="text-center mb-4">
              <div class="inline-block p-4 bg-violet-100 rounded-full">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-12 h-12 text-violet-600"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"
                  />
                </svg>
              </div>
            </div>

            <h2 class="mobile-title text-center">多账号模式</h2>
            <p class="mobile-subtitle text-center">
              批量管理多个账号，一键执行任务
            </p>

            <div class="space-y-3 mb-6">
              <div class="flex items-center">
                <span class="text-2xl mr-3">✨</span>
                <span class="text-slate-700">支持批量导入账号</span>
              </div>
              <div class="flex items-center">
                <span class="text-2xl mr-3">🎯</span>
                <span class="text-slate-700">统一管理所有任务</span>
              </div>
              <div class="flex items-center">
                <span class="text-2xl mr-3">⚡</span>
                <span class="text-slate-700">一键执行全部流程</span>
              </div>
            </div>

            <button
              id="mobile-multi-account-btn"
              class="mobile-primary-btn"
              style="
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
              "
            >
              进入多账号控制台
            </button>
          </div>

          <!-- ========================================
             【区域3】会话管理面板卡片
             ======================================== -->
          <div class="mobile-card" id="mobile-session-panel-card">
            <div
              class="flex items-center justify-between mb-4 pb-3 border-b border-sky-100"
            >
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-6 h-6 text-sky-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                  />
                </svg>
                <h3 class="text-xl font-bold text-sky-700">会话管理</h3>
              </div>

              <button
                id="mobile-refresh-sessions-btn"
                class="p-2 hover:bg-sky-50 rounded-lg transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-sky-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
              </button>
            </div>

            <div class="bg-sky-50 border border-sky-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-slate-700 mb-3">
                选择现有会话或创建新会话
              </p>
              <button
                class="mobile-primary-btn w-full"
                onclick="createNewSessionFromPicker()"
                id="mobile-create-session-btn"
              >
                <svg
                  class="w-5 h-5 inline-block mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                创建新会话
              </button>
            </div>

            <div
              id="mobile-session-count-display"
              class="text-sm text-slate-600 bg-sky-50 px-3 py-2 rounded-lg mb-4 text-center"
            ></div>

            <div
              id="mobile-sessions-list"
              class="space-y-3 max-h-[40vh] overflow-y-auto"
            >
              <p class="text-slate-400 text-center py-8">加载会话列表中...</p>
            </div>
          </div>

          <!-- ========================================
             【快速操作卡片】
             ======================================== -->
          <div class="mobile-card hidden" id="mobile-quick-actions">
            <h2 class="mobile-title">快速操作</h2>

            <div class="space-y-3">
              <button class="mobile-list-item justify-between">
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-sky-600 mr-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span class="font-medium">开始跑步</span>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-slate-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <button class="mobile-list-item justify-between">
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-green-600 mr-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span class="font-medium">查看任务</span>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-slate-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <button class="mobile-list-item justify-between">
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-purple-600 mr-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span class="font-medium">历史记录</span>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-slate-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <button class="mobile-list-item justify-between">
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-orange-600 mr-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                  <span class="font-medium">设置</span>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-slate-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- ========================================
           【容器3】移动端主应用界面
           ======================================== -->

        <div
          id="mobile-loading-overlay"
          class="fixed inset-0 z-50 flex flex-col items-center justify-center gap-6 bg-white/90 backdrop-blur-sm hidden"
        >
          <div class="flex flex-col items-center gap-4">
            <div
              class="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"
            ></div>
            <p class="text-slate-600 text-sm font-medium">加载中，请稍候...</p>
          </div>
        </div>

        <div id="mobile-main-app" class="space-y-4 hidden">
          <!-- ========================================
             【通知面板】- 显示系统通知和签到任务
             ======================================== -->
          <div
            class="mobile-card p-0 overflow-hidden h-screen flex flex-col max-h-full"
            id="mobile-notification-panel"
          >
            <div
              class="relative flex items-center justify-center mb-5 pb-4 border-b-2 border-sky-200"
            >
              <div class="flex items-center gap-3">
                <div
                  class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center shadow-lg relative"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-white"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2.5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                    ></path>
                  </svg>
                  <span
                    id="mobile-notification-badge"
                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-md animate-pulse"
                  >
                  </span>
                </div>
                <h3 class="text-2xl font-bold text-sky-700 tracking-tight">
                  通知中心
                </h3>
              </div>
            </div>

            <div
              id="mobile-all-notifications-list"
              class="space-y-3 h-full overflow-y-auto pr-2"
            >
              <div class="text-center py-12">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-20 h-20 mx-auto text-slate-300 mb-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
                <p class="text-slate-400 text-sm font-medium">暂无通知</p>
                <p class="text-slate-300 text-xs mt-1">
                  点击底部刷新按钮获取最新通知
                </p>
              </div>
            </div>

            <div class="flex gap-3 mt-5 pt-4 border-t-2 border-slate-100">
              <button
                id="mobile-refresh-notifications-btn"
                type="button"
                aria-label="刷新通知"
                class="flex-1 py-3 px-4 bg-gradient-to-r from-sky-500 to-sky-600 text-white rounded-xl text-sm font-bold hover:from-sky-600 hover:to-sky-700 transition-all duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                onclick="mobileRefreshNotifications()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新
              </button>

              <button
                id="mobile-mark-all-read-modal-btn"
                class="flex-1 py-3 px-4 bg-gradient-to-r from-slate-500 to-slate-600 text-white rounded-xl text-sm font-bold hover:from-slate-600 hover:to-slate-700 transition-all duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                onclick="mobileMarkAllAsRead()"
              >
                一键已读
              </button>

              <button
                class="flex-1 py-3 px-4 bg-gradient-to-r from-slate-100 to-slate-200 text-slate-700 rounded-xl text-sm font-bold hover:from-slate-200 hover:to-slate-300 transition-all duration-200 flex items-center justify-center gap-2 shadow-sm"
                style="display: none"
                onclick="expandMobileNotifications()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
                查看更多
              </button>
            </div>
          </div>

          <!-- ========================================
             【任务列表面板】
             ======================================== -->
          <div
            class="mobile-card p-0 overflow-hidden h-screen flex flex-col"
            id="mobile-task-panel"
          >
            <div
              class="flex items-center justify-between mb-4 pb-3 border-b border-green-100 p-4"
            >
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-6 h-6 text-green-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                  />
                </svg>
                <h3 class="text-xl font-bold text-green-700">任务列表</h3>
              </div>
              <div
                class="text-sm text-slate-600 bg-green-50 px-3 py-1 rounded-full"
                id="mobile-task-count"
              >
                0 个任务
              </div>
            </div>

            <div
              id="mobile-task-list"
              class="space-y-2 flex-1 overflow-y-auto px-4"
            >
              <p class="text-slate-400 text-center py-8 text-sm">暂无任务</p>
            </div>

            <div
              class="grid grid-cols-2 gap-2 mt-auto border-t border-slate-100 p-4"
            >
              <button
                class="py-2 px-4 bg-green-50 text-green-600 rounded-lg text-sm font-medium hover:bg-green-100 transition flex items-center justify-center gap-1"
                onclick="mobileRefreshTasks()"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新
              </button>
              <button
                class="py-2 px-4 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100 transition flex items-center justify-center gap-1"
                onclick="mobileAddTask()"
                style="display: none"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  />
                </svg>
                新增
              </button>
            </div>
          </div>

          <!-- ========================================
             【地图显示面板】
             ======================================== -->
          <div
            class="mobile-card p-0 overflow-hidden h-screen flex flex-col"
            id="mobile-map-panel"
          >
            <div
              id="mobile-map-container"
              class="w-full flex-1 relative bg-slate-100"
              style="height: calc(100vh - 60px)"
            >
              <div
                class="absolute inset-0 flex items-center justify-center text-slate-400"
              >
                <div class="text-center">
                  <svg
                    class="w-12 h-12 mx-auto mb-2 text-slate-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                    />
                  </svg>
                  <p class="text-sm">地图加载中...</p>
                </div>
              </div>

              <button
                id="mobile-map-reset-btn"
                class="absolute top-4 right-4 p-2 bg-white rounded-lg shadow-lg border border-slate-200 hover:bg-slate-50 transition z-10"
                style="display: none"
                onclick="resetMobileMapView()"
                title="复位视角"
              >
                <svg
                  class="w-5 h-5 text-slate-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                  />
                </svg>
              </button>
            </div>

            <div class="flex gap-2 p-3 bg-slate-50 flex-shrink-0">
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="mobileZoomIn()"
              >
                放大 +
              </button>
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="mobileZoomOut()"
              >
                缩小 -
              </button>
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="mobileFitView()"
              >
                适应 ⊡
              </button>
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="resetMobileMapView()"
              >
                复位 ⊙
              </button>
            </div>
          </div>

          <!-- ========================================
             【控制面板】- 任务执行控制
             ======================================== -->
          <div class="mobile-card" id="mobile-control-panel">
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-orange-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-orange-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                />
              </svg>
              <h3 class="text-xl font-bold text-orange-700">控制面板</h3>
            </div>

            <div class="mb-4 p-3 bg-slate-50 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-slate-600">当前状态</span>
                <span
                  id="mobile-status-indicator"
                  class="text-xs font-semibold px-2 py-1 rounded-full bg-slate-200 text-slate-600"
                >
                  未启动
                </span>
              </div>
              <div class="text-xs text-slate-500" id="mobile-status-detail">
                等待执行任务
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
              <button
                id="mobile-start-btn"
                class="py-3 px-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
                onclick="mobileStartTask()"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                    clip-rule="evenodd"
                  />
                </svg>
                开始
              </button>

              <button
                id="mobile-stop-btn"
                class="py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
                onclick="mobileStopTask()"
                disabled
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                    clip-rule="evenodd"
                  />
                </svg>
                停止
              </button>
            </div>

            <div class="grid grid-cols-3 gap-2" style="display: none">
              <button
                class="py-2 px-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-medium hover:bg-blue-100 transition flex flex-col items-center justify-center gap-1"
                onclick="mobilePauseTask()"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                    clip-rule="evenodd"
                  />
                </svg>
                暂停
              </button>
              <button
                class="py-2 px-2 bg-purple-50 text-purple-600 rounded-lg text-xs font-medium hover:bg-purple-100 transition flex flex-col items-center justify-center gap-1"
                onclick="mobileResumeTask()"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                    clip-rule="evenodd"
                  />
                </svg>
                继续
              </button>
              <button
                class="py-2 px-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-200 transition flex flex-col items-center justify-center gap-1"
                onclick="mobileResetTask()"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                重置
              </button>
            </div>

            <div
              class="mt-4 pt-3 border-t border-slate-100"
              style="display: none"
            >
              <div class="flex justify-between items-center mb-2">
                <span class="text-xs text-slate-600">任务进度</span>
                <span
                  id="mobile-progress-text"
                  class="text-xs font-semibold text-sky-600"
                  >0%</span
                >
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                <div
                  id="mobile-progress-bar"
                  class="bg-gradient-to-r from-sky-500 to-blue-600 h-2 rounded-full transition-all duration-300"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <!-- ========== 任务统计块 ========== -->
            <div
              id="mobile-run-stats-block"
              class="mt-4 p-3 bg-gradient-to-br from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl text-center"
            >
              <p class="text-xs text-slate-600 mb-1">已选任务总览</p>
              <p
                id="mobile-run-stats-label"
                class="font-bold text-lg text-emerald-600"
              >
                -- km / --:--
              </p>
            </div>

            <!-- ========== 单任务进度条 ========== -->
            <div
              id="mobile-single-progress-block"
              class="mt-3 p-3 bg-slate-50 rounded-xl"
            >
              <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-2">
                <div
                  id="mobile-single-progress-fill"
                  class="h-2 bg-gradient-to-r from-sky-500 to-blue-500 transition-all duration-300"
                  style="width: 0%"
                ></div>
              </div>
              <div class="flex justify-between text-xs">
                <span id="mobile-single-progress-text" class="text-slate-600"
                  >未开始</span
                >
                <span
                  id="mobile-single-progress-extra"
                  class="text-slate-400"
                ></span>
              </div>
            </div>

            <!-- ========== 执行选项复选框 ========== -->
            <div
              class="mt-4 pt-3 border-t border-slate-100 flex flex-col gap-2"
              style="display: none"
            >
              <label
                class="flex items-center gap-2 cursor-pointer p-2 bg-amber-50 rounded-lg hover:bg-amber-100 transition"
              >
                <input
                  type="checkbox"
                  id="mobile-run-completed-check"
                  class="w-4 h-4 accent-sky-600 rounded flex-shrink-0"
                />
                <span class="text-xs text-slate-700 font-semibold"
                  >忽略已完成状态</span
                >
              </label>
              <label
                class="flex items-center gap-2 cursor-pointer p-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition"
                style="display: none"
              >
                <input
                  type="checkbox"
                  id="mobile-auto-gen-all-check"
                  class="w-4 h-4 accent-sky-600 rounded flex-shrink-0"
                  checked
                />
                <span class="text-xs text-slate-700 font-semibold"
                  >自动生成路径</span
                >
              </label>
            </div>

            <!-- ========== 实时状态面板 ========== -->
            <div class="mt-4 pt-3 border-t border-slate-100">
              <h4
                class="text-xs font-semibold text-slate-700 mb-2 flex items-center gap-1"
              >
                <svg
                  class="w-4 h-4 text-green-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"
                  />
                </svg>
                实时状态
              </h4>
              <div class="grid grid-cols-2 gap-2" id="mobile-live-stats-grid">
                <div class="p-2 bg-blue-50 rounded-lg text-center">
                  <p class="text-xs text-slate-500 mb-1">已跑距离</p>
                  <p
                    id="mobile-live-dist-label"
                    class="font-bold text-sm text-blue-600"
                  >
                    0.00 km
                  </p>
                </div>
                <div class="p-2 bg-green-50 rounded-lg text-center">
                  <p class="text-xs text-slate-500 mb-1">总距离</p>
                  <p
                    id="mobile-total-dist-label"
                    class="font-bold text-sm text-green-600"
                  >
                    0.00 km
                  </p>
                </div>
                <div class="p-2 bg-purple-50 rounded-lg text-center">
                  <p class="text-xs text-slate-500 mb-1">已用时间</p>
                  <p
                    id="mobile-live-time-label"
                    class="font-bold text-sm text-purple-600"
                  >
                    00:00
                  </p>
                </div>
                <div class="p-2 bg-orange-50 rounded-lg text-center">
                  <p class="text-xs text-slate-500 mb-1">预计时间</p>
                  <p
                    id="mobile-total-time-label"
                    class="font-bold text-sm text-orange-600"
                  >
                    00:00
                  </p>
                </div>
              </div>
              <div class="mt-2 text-center">
                <p
                  id="mobile-current-location-label"
                  class="text-xs font-mono text-slate-500"
                >
                  当前位置: --, --
                </p>
              </div>
            </div>
          </div>

          <!-- ========================================
             【日志面板】
             ======================================== -->
          <div
            class="mobile-card mobile-card-fullscreen hidden"
            id="mobile-log-panel"
          >
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-slate-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-slate-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              <h3 class="text-xl font-bold text-slate-700">运行日志</h3>
            </div>
            <div class="flex-1 overflow-hidden rounded-lg p-3">
              <textarea
                id="mobile-log-text"
                readonly
                class="w-full h-full bg-white text-slate-800 font-mono text-xs border border-slate-300 rounded-lg resize-none outline-none p-3"
                placeholder="等待日志输出..."
              ></textarea>
            </div>

            <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
              <button
                class="flex-1 py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition flex items-center justify-center gap-1"
                onclick="clearMobileMultiLog()"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  />
                </svg>
                清空日志
              </button>
              <button
                class="flex-1 py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition flex items-center justify-center gap-1"
                onclick="scrollMobileMultiLogToBottom()"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 14l-7 7m0 0l-7-7m7 7V3"
                  />
                </svg>
                滚到底部
              </button>
            </div>
          </div>

          <!-- ========================================
            【打卡点面板】
             ======================================== -->
          <div
            class="mobile-card flex flex-col h-full"
            id="mobile-checkpoints-panel"
          >
            <div
              class="flex-none flex items-center justify-between mb-4 pb-3 border-b border-red-100"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="w-6 h-6 text-red-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  />
                </svg>
                <h3 class="text-xl font-bold text-red-700">打卡点</h3>
              </div>
            </div>

            <div
              class="flex-none mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200"
            >
              <p
                class="text-xs text-blue-700 font-medium"
                id="mobile-checkpoints-task-info"
              >
                请先选择一个任务以查看打卡点
              </p>
            </div>

            <div
              id="mobile-checkpoints-list"
              class="flex-1 overflow-y-auto space-y-2 min-h-0"
            >
              <p class="text-slate-400 text-center py-8 text-sm">
                开始任务后将显示打卡点
              </p>
            </div>

            <div class="flex-none mt-4 pt-3 border-t border-gray-100">
              <button
                onclick="renderMobileCheckpointsList(); showTempMessage('打卡点列表已刷新', 'success');"
                class="w-full py-3 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition flex items-center justify-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新列表
              </button>
            </div>
          </div>

          <div
            class="mobile-card h-full flex flex-col"
            id="mobile-task-history-panel"
          >
            <div
              class="flex-none flex items-center gap-2 mb-4 pb-3 border-b border-amber-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-amber-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <h3 class="text-xl font-bold text-amber-700">历史记录</h3>
            </div>

            <div
              class="flex-none mb-4 p-3 bg-amber-50 rounded-lg border border-amber-200"
            >
              <p
                class="text-xs text-amber-700 font-medium"
                id="mobile-history-task-info"
              >
                请先选择一个任务以查看历史记录
              </p>
            </div>

            <div
              id="mobile-task-history-list"
              class="flex-1 overflow-y-auto space-y-2 min-h-0"
            >
              <p class="text-slate-400 text-center py-8 text-sm">加载中...</p>
            </div>

            <div class="flex-none pt-3 mt-4 border-t border-amber-100">
              <button
                onclick="loadMobileTaskHistoryPanel()"
                class="w-full py-3 bg-amber-50 text-amber-600 rounded-lg text-sm font-bold hover:bg-amber-100 transition shadow-sm border border-amber-200 flex items-center justify-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新列表
              </button>
            </div>
          </div>

          <!-- ========================================
             【签到面板】- 单账号签到功能
             ======================================== -->
          <div class="mobile-card" id="mobile-attendance-panel">
            <div
              class="flex items-center gap-3 mb-5 pb-4 border-b-2 border-blue-200"
            >
              <div
                class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-6 h-6 text-white"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-blue-700 tracking-tight">
                自动签到
              </h3>
            </div>

            <div
              class="bg-white rounded-xl shadow-md p-4 mb-5 border border-blue-100"
            >
              <div class="flex items-center gap-2 mb-4">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-blue-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <h4 class="text-base font-bold text-slate-800">参数配置</h4>
              </div>

              <div class="space-y-4">
                <label
                  class="flex items-center gap-3 cursor-pointer p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl hover:from-blue-100 hover:to-blue-150 transition-all duration-200 shadow-sm"
                >
                  <input
                    type="checkbox"
                    id="mobile-param-auto_attendance_enabled"
                    data-key="auto_attendance_enabled"
                    class="w-6 h-6 accent-blue-600 rounded-md cursor-pointer flex-shrink-0 shadow-sm"
                  />
                  <div class="flex-1">
                    <span class="text-slate-800 font-bold block text-base"
                      >🎯 开启自动签到</span
                    >
                    <span class="text-xs text-slate-600 mt-1 block"
                      >后台自动刷新通知并尝试签到</span
                    >
                  </div>
                </label>

                <div class="bg-slate-50 rounded-xl p-4 space-y-2">
                  <div class="flex items-center gap-2 mb-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 text-blue-600"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                    <label class="text-sm text-slate-700 font-bold"
                      >⏰ 刷新间隔</label
                    >
                  </div>
                  <div class="flex items-center gap-3">
                    <input
                      type="number"
                      step="30"
                      id="mobile-param-auto_attendance_refresh_s"
                      data-key="auto_attendance_refresh_s"
                      class="flex-1 px-4 py-3 bg-white border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm font-semibold text-slate-700"
                      placeholder="60"
                      title="自动刷新通知的间隔时间（秒），建议不低于60"
                    />
                    <span
                      class="text-sm text-slate-600 font-semibold flex-shrink-0 bg-white px-3 py-2 rounded-lg border border-slate-200"
                      >秒</span
                    >
                  </div>
                </div>

                <div class="bg-slate-50 rounded-xl p-4 space-y-2">
                  <div class="flex items-center gap-2 mb-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 text-blue-600"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                    <label class="text-sm text-slate-700 font-bold"
                      >📍 随机半径</label
                    >
                  </div>
                  <div class="flex items-center gap-3">
                    <input
                      type="number"
                      step="1"
                      id="mobile-param-attendance_user_radius_m"
                      data-key="attendance_user_radius_m"
                      class="flex-1 px-4 py-3 bg-white border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm font-semibold text-slate-700"
                      placeholder="0"
                      title="自动签到时，在服务器允许范围内的最大随机偏移半径。设为0为精确签到。"
                    />
                    <span
                      class="text-sm text-slate-600 font-semibold flex-shrink-0 bg-white px-3 py-2 rounded-lg border border-slate-200"
                      >米</span
                    >
                  </div>
                </div>
              </div>
              <div class="flex gap-3 mt-4 pt-3 border-t border-slate-100">
                <button
                  onclick="switchMobileSinglePanel('mobile-attendance-panel')"
                  class="flex-1 py-2.5 px-4 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200 transition flex items-center justify-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  重置
                </button>
                <button
                  onclick="saveMobileAttendanceParams()"
                  class="flex-1 py-2.5 px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-bold hover:from-blue-600 hover:to-blue-700 transition shadow-md flex items-center justify-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                    />
                  </svg>
                  保存配置
                </button>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-md p-4 border border-blue-100"
            >
              <div
                class="flex justify-between items-center mb-4 pb-3 border-b-2 border-slate-100"
              >
                <div class="flex items-center gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-5 h-5 text-blue-600"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                    />
                  </svg>
                  <h4 class="text-base font-bold text-slate-800">
                    📋 签到任务
                  </h4>
                </div>
                <button
                  id="mobile-refresh-attendance-list-btn"
                  class="py-2 px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-bold hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex items-center gap-2 shadow-md hover:shadow-lg"
                  onclick="refreshNotificationsUI(true, true)"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2.5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  刷新
                </button>
              </div>

              <div
                id="mobile-attendance-list"
                class="max-h-[40vh] overflow-y-auto space-y-2"
              >
                <div class="text-center py-10">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-16 h-16 mx-auto text-slate-300 mb-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                    />
                  </svg>
                  <p class="text-slate-400 text-sm font-medium">
                    点击"刷新"按钮查看签到任务
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- ========================================
             【参数设置面板】- 单账号参数配置
             ======================================== -->
          <div
            class="mobile-card mobile-card-fullscreen hidden"
            id="mobile-settings-panel"
          >
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-indigo-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-indigo-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <h3 class="text-xl font-bold text-indigo-700">参数设置</h3>
            </div>

            <div
              id="mobile-params-container"
              class="space-y-3 overflow-y-auto"
            ></div>

            <div
              class="flex-shrink-0 pt-3 border-t border-indigo-100 flex gap-3 bg-white"
            >
              <button
                onclick="refreshMobileSettings()"
                class="flex-1 py-2.5 px-4 bg-slate-100 text-slate-700 rounded-xl text-sm font-bold hover:bg-slate-200 transition flex items-center justify-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新
              </button>
              <button
                onclick="saveMobileSettings()"
                class="flex-1 py-2.5 px-4 bg-indigo-500 text-white rounded-xl text-sm font-bold hover:bg-indigo-600 transition flex items-center justify-center gap-2 shadow-md"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                保存
              </button>
            </div>
          </div>

          <!-- ========================================
             任务详情面板
             ======================================== -->
          <div
            class="mobile-card h-screen w-full flex flex-col bg-white"
            id="mobile-task-details-panel"
          >
            <div
              class="flex-shrink-0 flex items-center justify-between p-4 border-b border-sky-100"
            >
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-6 h-6 text-sky-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <h3 class="text-xl font-bold text-sky-700">任务详情</h3>
              </div>
            </div>

            <div
              id="mobile-task-details-panel-content"
              class="flex-1 overflow-y-auto space-y-4 p-4"
            >
              <div
                id="mobile-task-details-empty"
                class="text-center py-10 h-full flex flex-col justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-16 h-16 mx-auto text-slate-300 mb-3"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <p class="text-slate-400 text-sm">请先选择一个任务</p>
              </div>

              <div
                id="mobile-task-details-basic"
                class="bg-sky-50 border border-sky-100 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-sky-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  基本信息
                </h5>
                <div
                  id="mobile-task-details-basic-list"
                  class="space-y-2 text-sm"
                ></div>
              </div>

              <div
                id="mobile-task-details-time"
                class="bg-green-50 border border-green-100 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-green-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  时间信息
                </h5>
                <div
                  id="mobile-task-details-time-list"
                  class="space-y-2 text-sm"
                ></div>
              </div>

              <div
                id="mobile-task-details-points"
                class="bg-purple-50 border border-purple-100 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-purple-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                  打卡点列表
                </h5>
                <div
                  id="mobile-task-details-points-list"
                  class="space-y-2"
                ></div>
              </div>

              <div
                id="mobile-task-details-history"
                class="bg-amber-50 border border-amber-100 rounded-xl p-4 space-y-3 hidden"
                style="display: none"
              >
                <h5
                  class="font-semibold text-amber-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  历史记录
                </h5>
                <div
                  id="mobile-task-details-history-list"
                  class="space-y-2 text-sm"
                ></div>
              </div>
            </div>

            <div class="flex-shrink-0 p-4 border-t border-sky-100 bg-white">
              <button
                onclick="loadMobileTaskDetails()"
                class="w-full py-3 px-4 bg-sky-50 text-sky-600 rounded-xl text-sm font-bold hover:bg-sky-100 active:scale-[0.98] transition flex items-center justify-center gap-2 shadow-sm"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新数据
              </button>
            </div>
          </div>
          <!-- ========================================
             【管理面板】
             ======================================== -->
          <div
            class="mobile-card mobile-card-fullscreen hidden"
            id="mobile-admin-panel"
          >
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-sky-100 flex-shrink-0"
            >
              <svg
                class="w-6 h-6 text-sky-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
              <h3 class="text-xl font-bold text-sky-600">管理面板</h3>
            </div>

            <div
              id="mobile-admin-tabs-nav-panel"
              class="flex border-b-2 border-slate-200 overflow-x-auto gap-1 pb-0 mb-4 flex-shrink-0"
              style="scrollbar-width: none; -webkit-overflow-scrolling: touch"
            ></div>

            <div
              id="mobile-admin-panel-content-panel"
              class="text-sm flex-1 overflow-y-auto min-h-0 pr-1"
            >
              <div id="mobile-admin-users-panel-panel" class="space-y-3">
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">用户列表</h4>
                  <div class="flex gap-2">
                    <button
                      id="mobile-admin-create-user-panel"
                      class="btn btn-primary !py-1 !px-2 text-xs"
                    >
                      新增
                    </button>
                    <button
                      id="mobile-admin-refresh-users-panel"
                      class="btn btn-ghost !py-1 !px-2 text-xs"
                    >
                      刷新
                    </button>
                  </div>
                </div>
                <div
                  id="mobile-admin-users-list-panel"
                  class="space-y-2 max-h-[50vh] overflow-y-auto"
                >
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div
                id="mobile-admin-groups-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">权限组列表</h4>
                  <div class="flex gap-2">
                    <button
                      id="mobile-admin-create-group-panel"
                      class="btn btn-primary !py-1 !px-2 text-xs"
                    >
                      新增
                    </button>
                    <button
                      id="mobile-admin-refresh-groups-panel"
                      class="btn btn-ghost !py-1 !px-2 text-xs"
                    >
                      刷新
                    </button>
                  </div>
                </div>
                <div
                  id="mobile-admin-groups-list-panel"
                  class="space-y-2 max-h-[50vh] overflow-y-auto"
                >
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div id="mobile-admin-logs-panel-panel" class="hidden space-y-3">
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">系统日志</h4>
                  <div class="flex gap-2">
                    <select
                      id="mobile-log-limit-select-panel"
                      class="text-xs border border-slate-300 rounded px-2 py-1"
                    >
                      <option value="100">100行</option>
                      <option value="200">200行</option>
                      <option value="500">500行</option>
                    </select>
                    <button
                      id="mobile-admin-refresh-logs-panel"
                      class="btn btn-ghost !py-1 !px-2 text-xs"
                    >
                      刷新
                    </button>
                  </div>
                </div>
                <div
                  class="bg-slate-900 text-green-400 rounded-lg p-3 font-mono text-xs overflow-auto max-h-[45vh]"
                >
                  <pre
                    id="mobile-admin-logs-content-panel"
                    class="whitespace-pre-wrap"
                  >
加载中...</pre
                  >
                </div>
                <div
                  id="mobile-admin-logs-pagination-panel"
                  class="flex justify-between items-center text-xs text-slate-600 pt-2 border-t border-slate-200"
                >
                  <button
                    id="mobile-log-prev-page-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    上一页
                  </button>
                  <div class="flex items-center gap-2">
                    <select
                      id="mobile-log-page-select-panel"
                      class="text-xs border border-slate-300 rounded px-2 py-1"
                    >
                      <option value="1">第 1 / 1 页</option>
                    </select>
                    <span
                      id="mobile-log-page-total-panel"
                      class="text-xs text-slate-500"
                      >(共 0 行)</span
                    >
                  </div>
                  <button
                    id="mobile-log-next-page-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    下一页
                  </button>
                </div>
              </div>

              <div
                id="mobile-admin-health-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">系统状态</h4>
                  <div class="flex items-center gap-2">
                    <label class="flex items-center gap-1 cursor-pointer">
                      <input
                        type="checkbox"
                        id="mobile-health-auto-refresh-toggle-panel"
                        class="w-3 h-3 accent-sky-600 rounded"
                        checked
                      />
                      <span class="text-xs text-slate-600"
                        >自动刷新
                        <span
                          id="mobile-health-countdown-display-panel"
                          class="font-semibold text-sky-600"
                        ></span>
                      </span>
                    </label>
                    <button
                      id="mobile-admin-refresh-health-panel"
                      class="btn btn-ghost !py-1 !px-2 text-xs"
                    >
                      刷新
                    </button>
                  </div>
                </div>
                <div id="mobile-admin-health-content-panel" class="space-y-3">
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div
                id="mobile-admin-profile-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">个人信息</h4>
                  <button
                    id="mobile-admin-refresh-profile-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div
                  id="mobile-admin-profile-content-panel"
                  class="space-y-3 text-slate-800"
                >
                  <div
                    class="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-2"
                  >
                    <h5 class="font-semibold text-slate-700 text-xs">头像</h5>
                    <div class="flex items-center gap-3">
                      <img
                        id="mobile-profile-avatar-display-panel"
                        src=""
                        alt="用户头像"
                        class="w-16 h-16 rounded-full border-2 border-slate-200"
                        onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3E👤%3C/text%3E%3C/svg%3E'"
                      />
                      <div class="flex-1">
                        <input
                          type="file"
                          id="mobile-profile-avatar-file-panel"
                          accept="image/*"
                          class="hidden"
                        />
                        <button
                          class="btn btn-ghost border border-slate-300 !py-1 !px-2 text-xs"
                          onclick="document.getElementById('mobile-profile-avatar-file-panel').click();"
                        >
                          选择图片
                        </button>
                      </div>
                    </div>
                  </div>
                  <div
                    id="mobile-profile-details-panel"
                    class="space-y-2"
                  ></div>
                </div>
              </div>

              <div
                id="mobile-admin-sessions-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">会话列表</h4>
                  <div class="flex items-center gap-2">
                    <label
                      id="mobile-god-mode-toggle-panel"
                      class="flex items-center gap-1 cursor-pointer"
                      style="display: none"
                    >
                      <input
                        type="checkbox"
                        id="mobile-god-mode-checkbox-panel"
                        class="w-3 h-3 accent-red-600 rounded"
                      />
                      <span class="text-xs font-semibold text-red-600"
                        >上帝模式</span
                      >
                    </label>
                    <div
                      id="mobile-admin-session-count-display-panel"
                      class="text-xs text-slate-600"
                    ></div>
                    <button
                      id="mobile-admin-refresh-sessions-panel"
                      class="btn btn-ghost !py-1 !px-2 text-xs"
                    >
                      刷新
                    </button>
                  </div>
                </div>
                <div
                  id="mobile-admin-sessions-list-panel"
                  class="space-y-2 max-h-[50vh] overflow-y-auto"
                >
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div
                id="mobile-admin-messages-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">留言板</h4>
                  <button
                    id="mobile-admin-refresh-messages-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-2"
                >
                  <h5 class="font-semibold text-slate-700 text-xs">发表留言</h5>
                  <div
                    id="mobile-message-guest-fields-panel"
                    class="space-y-2 hidden"
                  >
                    <input
                      type="text"
                      id="mobile-message-nickname-panel"
                      class="input-field text-xs"
                      placeholder="昵称"
                      maxlength="50"
                    />
                    <input
                      type="email"
                      id="mobile-message-email-panel"
                      class="input-field text-xs"
                      placeholder="邮箱"
                    />
                  </div>
                  <textarea
                    id="mobile-message-content-panel"
                    class="input-field text-xs"
                    rows="3"
                    placeholder="留言内容（最多1000字）"
                    maxlength="1000"
                  ></textarea>
                  <div class="text-xs text-slate-500 text-right">
                    <span id="mobile-message-char-count-panel">0</span> / 1000
                  </div>
                  <button
                    id="mobile-post-message-btn-panel"
                    class="btn btn-primary w-full !py-1 text-xs"
                  >
                    发表
                  </button>
                </div>
                <div
                  id="mobile-admin-messages-list-panel"
                  class="space-y-2 max-h-[40vh] overflow-y-auto"
                >
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div id="mobile-admin-ipban-panel-panel" class="hidden space-y-3">
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">IP封禁</h4>
                  <button
                    id="mobile-admin-refresh-ipban-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                  <h5 class="font-semibold text-slate-700 text-xs mb-2">
                    现有规则
                  </h5>
                  <div
                    id="mobile-ip-ban-list-panel"
                    class="space-y-2 max-h-[30vh] overflow-y-auto"
                  >
                    <p class="text-slate-400 text-center py-6 text-xs">
                      加载中...
                    </p>
                  </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <h5 class="font-semibold text-blue-900 text-xs mb-2">
                    添加规则
                  </h5>
                  <div class="space-y-2">
                    <select
                      id="mobile-ban-type-panel"
                      class="select-field text-xs"
                    >
                      <option value="ip">单个IP</option>
                      <option value="range">IP范围</option>
                    </select>
                    <input
                      type="text"
                      id="mobile-ban-target-panel"
                      class="input-field text-xs"
                      placeholder="IP地址"
                    />
                    <select
                      id="mobile-ban-scope-panel"
                      class="select-field text-xs"
                    >
                      <option value="all">封禁所有功能</option>
                      <option value="messages_only">仅封禁留言板</option>
                    </select>
                    <button
                      id="mobile-add-ipban-btn-panel"
                      class="btn btn-primary w-full !py-1 text-xs"
                    >
                      添加
                    </button>
                  </div>
                </div>
              </div>

              <div id="mobile-admin-sms-panel-panel" class="hidden space-y-3">
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">短信配置</h4>
                  <button
                    id="mobile-admin-refresh-sms-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div id="mobile-admin-sms-content-panel" class="space-y-3">
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div
                id="mobile-admin-config-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">系统配置</h4>
                  <button
                    id="mobile-admin-refresh-config-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div id="mobile-admin-config-content-panel" class="space-y-3">
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div
                id="mobile-admin-captcha-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">⚙️ 验证码设置</h4>
                </div>
                <p class="text-xs text-slate-500 bg-sky-50 p-2 rounded">
                  💡
                  使用本地验证码生成器，无需第三方API。请在桌面端控制面板中调整详细参数。
                </p>
                <div id="mobile-admin-captcha-list-panel" class="space-y-2">
                  <p class="text-slate-400 text-center py-4 text-xs">
                    请在桌面端查看和修改验证码设置
                  </p>
                </div>
              </div>

              <div
                id="mobile-admin-reminders-panel-panel"
                class="hidden space-y-3"
              >
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">定时提醒</h4>
                  <button
                    id="mobile-admin-refresh-reminders-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div
                  id="mobile-admin-reminders-content-panel"
                  class="space-y-3"
                >
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>

              <div id="mobile-admin-ssl-panel-panel" class="hidden space-y-3">
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold text-sm">HTTPS设置</h4>
                  <button
                    id="mobile-admin-refresh-ssl-panel"
                    class="btn btn-ghost !py-1 !px-2 text-xs"
                  >
                    刷新
                  </button>
                </div>
                <div id="mobile-admin-ssl-content-panel" class="space-y-3">
                  <p class="text-slate-400 text-center py-10 text-xs">
                    加载中...
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- ========================================
             我的资料面板
             ======================================== -->
          <div
            class="mobile-card flex flex-col h-full"
            id="mobile-profile-panel"
          >
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-sky-100 flex-shrink-0"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-sky-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
              <h3 class="text-xl font-bold text-sky-700">用户详情</h3>
            </div>

            <div
              id="mobile-user-details-content"
              class="space-y-4 flex-1 overflow-y-auto min-h-0 pr-1"
            >
              <div id="mobile-user-details-empty" class="text-center py-10">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-16 h-16 mx-auto text-slate-300 mb-3"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
                <p class="text-slate-400 text-sm">请先登录</p>
              </div>

              <div
                id="mobile-user-details-avatar"
                class="bg-sky-50 border border-sky-100 rounded-xl p-4 text-center hidden"
              >
                <img
                  id="mobile-user-details-avatar-img"
                  src=""
                  alt="用户头像"
                  class="w-24 h-24 rounded-full border-4 border-sky-200 object-cover mx-auto mb-2"
                  onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23e0f2fe%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22%3E👤%3C/text%3E%3C/svg%3E'"
                />
                <p
                  id="mobile-user-details-name"
                  class="text-lg font-bold text-sky-900"
                ></p>
              </div>

              <div
                id="mobile-user-details-basic"
                class="bg-slate-50 border border-slate-200 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-slate-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  基本信息
                </h5>
                <div
                  id="mobile-user-details-basic-list"
                  class="space-y-2 text-sm"
                ></div>
              </div>

              <div
                id="mobile-user-details-school"
                class="bg-green-50 border border-green-100 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-green-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                    />
                  </svg>
                  学校信息
                </h5>
                <div
                  id="mobile-user-details-school-list"
                  class="space-y-2 text-sm"
                ></div>
              </div>

              <div
                id="mobile-user-details-login"
                class="bg-purple-50 border border-purple-100 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-purple-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  登录信息
                </h5>
                <div
                  id="mobile-user-details-login-list"
                  class="space-y-2 text-sm"
                ></div>
              </div>

              <div
                id="mobile-user-details-ua"
                class="bg-amber-50 border border-amber-100 rounded-xl p-4 space-y-3 hidden"
              >
                <h5
                  class="font-semibold text-amber-900 text-sm flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                    />
                  </svg>
                  User-Agent
                </h5>
                <div
                  id="mobile-user-details-ua-text"
                  class="text-xs text-slate-600 break-all font-mono bg-white p-3 rounded-lg border border-amber-200"
                ></div>
              </div>

              <div class="flex gap-2 pt-2 pb-2">
                <button
                  onclick="mobileLogout()"
                  class="flex-1 py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition flex items-center justify-center gap-2"
                  style="display: none"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                    />
                  </svg>
                  退出登录
                </button>
              </div>
            </div>

            <div class="mt-auto pt-3 border-t border-sky-100 flex-shrink-0">
              <button
                onclick="loadMobileUserDetails()"
                class="w-full py-3 bg-sky-50 text-sky-600 rounded-xl font-medium hover:bg-sky-100 active:bg-sky-200 transition flex items-center justify-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                刷新信息
              </button>
            </div>
          </div>
        </div>

        <!-- ========================================
           移动端多账号模式界面
           ======================================== -->
        <div id="mobile-multi-account-app" class="space-y-4 hidden">
          <div class="mobile-card py-3" style="display: none">
            <button
              class="flex items-center gap-2 text-sky-600 font-medium"
              onclick="exitMobileMultiAccount()"
              id="multi_exit_account"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
              返回首页
            </button>
          </div>

          <div class="mobile-card" id="mobile-multi-account-panel">
            <div
              class="flex items-center justify-between mb-5 pb-4 border-b-2 border-purple-200"
            >
              <div class="flex items-center gap-3">
                <div
                  class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-white"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"
                    />
                  </svg>
                </div>
                <h3 class="text-2xl font-bold text-purple-700 tracking-tight">
                  账号管理
                </h3>
              </div>
              <div
                class="text-sm font-bold text-white bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-1.5 rounded-full shadow-md"
                id="mobile-multi-account-count"
              >
                0 个账号
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-md p-4 mb-5 border border-purple-100"
            >
              <div class="flex items-center gap-2 mb-4">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-purple-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"
                  />
                </svg>
                <h4 class="text-base font-bold text-slate-800">➕ 添加账号</h4>
              </div>

              <select
                id="multi-config-user-select"
                class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all mb-3 shadow-sm"
              >
                <option value="">-- 请选择配置文件 --</option>
              </select>

              <div class="grid grid-cols-3 gap-2">
                <button
                  class="py-2.5 px-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg text-sm font-bold hover:from-purple-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-1"
                  onclick="addMobileSelectedConfig()"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2.5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                  添加选中
                </button>
                <button
                  class="py-2.5 px-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg text-sm font-bold hover:from-purple-700 hover:to-purple-800 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-1"
                  onclick="addMobileAllConfigs()"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2.5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                  添加全部
                </button>
                <button
                  class="py-2.5 px-3 bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-lg text-sm font-bold hover:from-teal-600 hover:to-teal-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-1"
                  id="mobile_multi_account_manual_input_button"
                  onclick="openManualAccountModal()"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="2.5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                    />
                  </svg>
                  手动添加
                </button>
              </div>
            </div>

            <div
              class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 mb-5 border-2 border-purple-200 shadow-sm"
            >
              <div class="flex items-center justify-between">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    id="mobile-select-all-accounts"
                    class="w-6 h-6 text-purple-600 rounded-md shadow-sm cursor-pointer"
                    onchange="mobileToggleSelectAllAccounts()"
                  />
                  <span class="text-sm font-bold text-slate-800"
                    >✅ 全选账号</span
                  >
                </label>
                <div class="flex gap-2">
                  <button
                    class="py-2 px-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg text-sm font-bold hover:from-green-600 hover:to-green-700 transition-all shadow-md hover:shadow-lg"
                    onclick="mobileStartSelectedAccounts()"
                  >
                    ▶️ 启动
                  </button>
                  <button
                    class="py-2 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-sm font-bold hover:from-red-600 hover:to-red-700 transition-all shadow-md hover:shadow-lg"
                    onclick="mobileStopSelectedAccounts()"
                  >
                    ⏹️ 停止
                  </button>
                </div>
              </div>
            </div>

            <div
              id="mobile-multi-account-list"
              class="space-y-3 max-h-[50vh] overflow-y-auto pr-2 mb-5"
            >
              <div class="text-center py-12">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-20 h-20 mx-auto text-slate-300 mb-4"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"
                  />
                </svg>
                <p class="text-slate-400 text-sm font-medium">
                  暂无账号，请先添加
                </p>
                <p class="text-slate-300 text-xs mt-1">
                  从上方选择配置文件或手动添加
                </p>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-md p-4 border border-purple-100"
            >
              <div class="flex items-center gap-2 mb-4">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-purple-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                  />
                </svg>
                <h4 class="text-base font-bold text-slate-800">🔧 批量操作</h4>
              </div>

              <div class="space-y-2">
                <div class="grid grid-cols-4 gap-2">
                  <button
                    class="py-2.5 px-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition flex flex-col items-center justify-center gap-1 border-2 border-blue-200"
                    onclick="importMobileAccountList()"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"
                      />
                    </svg>
                    <span>导入</span>
                  </button>
                  <button
                    class="py-2.5 px-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold hover:bg-green-100 transition flex flex-col items-center justify-center gap-1 border-2 border-green-200"
                    onclick="exportMobileAccountList()"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      />
                    </svg>
                    <span>导出</span>
                  </button>
                  <button
                    class="py-2.5 px-2 bg-amber-50 text-amber-600 rounded-lg text-xs font-bold hover:bg-amber-100 transition flex flex-col items-center justify-center gap-1 border-2 border-amber-200"
                    onclick="downloadMobileAccountTemplate()"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <span>模板</span>
                  </button>
                  <button
                    class="py-2.5 px-2 bg-slate-50 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-100 transition flex flex-col items-center justify-center gap-1 border-2 border-slate-200"
                    onclick="mobileRefreshSelectedAccounts()"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                    <span>刷新</span>
                  </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <button
                    class="py-3 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition flex items-center justify-center gap-2 border-2 border-red-200"
                    onclick="deleteMobileSelectedAccounts()"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      />
                    </svg>
                    删除选中
                  </button>
                  <button
                    class="py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-sm font-bold hover:from-red-600 hover:to-red-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
                    onclick="deleteMobileAllAccounts()"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      />
                    </svg>
                    删除全部
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="mobile-card" id="mobile-multi-control-panel">
            <div
              class="flex items-center gap-3 mb-5 pb-4 border-b-2 border-orange-200"
            >
              <div
                class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center shadow-lg"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-6 h-6 text-white"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-orange-700 tracking-tight">
                批量控制
              </h3>
            </div>

            <div
              class="mb-5 p-4 bg-white rounded-xl shadow-md border border-orange-100"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-5 h-5 text-orange-600"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span class="text-sm font-bold text-slate-700"
                    >🎯 全局状态</span
                  >
                </div>
                <span
                  id="mobile-multi-global-status"
                  class="text-sm font-bold px-4 py-1.5 rounded-full bg-gradient-to-r from-slate-100 to-slate-200 text-slate-700 shadow-sm"
                >
                  就绪
                </span>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-md p-4 mb-5 border border-orange-100"
            >
              <div class="flex items-center gap-2 mb-4">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-orange-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <h4 class="text-base font-bold text-slate-800">快速操作</h4>
              </div>

              <div class="grid grid-cols-3 gap-3">
                <button
                  class="py-4 px-3 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 flex flex-col items-center justify-center gap-2"
                  onclick="mobileStartAllAccounts()"
                >
                  <div
                    class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <span>▶️ 全部启动</span>
                </button>

                <button
                  class="py-4 px-3 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:from-red-600 hover:to-red-700 transition-all duration-200 flex flex-col items-center justify-center gap-2"
                  onclick="mobileStopAllAccounts()"
                >
                  <div
                    class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <span>⏹️ 全部停止</span>
                </button>

                <button
                  class="py-4 px-3 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex flex-col items-center justify-center gap-2"
                  onclick="mobileRefreshAllAccounts()"
                >
                  <div
                    class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                  </div>
                  <span>🔄 全部刷新</span>
                </button>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-md p-4 mb-5 border border-orange-100"
            >
              <div class="flex items-center gap-2 mb-4">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-orange-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                <h4 class="text-base font-bold text-slate-800">📊 运行统计</h4>
              </div>

              <div class="grid grid-cols-3 gap-3">
                <div
                  class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border-2 border-green-200 shadow-sm"
                >
                  <div class="flex items-center justify-center mb-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-green-600"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <div
                    id="mobile-multi-running-count"
                    class="text-2xl font-bold text-green-600 mb-1"
                  >
                    0
                  </div>
                  <div class="text-xs text-green-700 font-semibold">运行中</div>
                </div>
                <div
                  class="text-center p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl border-2 border-yellow-200 shadow-sm"
                >
                  <div class="flex items-center justify-center mb-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-yellow-600"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <div
                    id="mobile-multi-paused-count"
                    class="text-2xl font-bold text-yellow-600 mb-1"
                  >
                    0
                  </div>
                  <div class="text-xs text-yellow-700 font-semibold">
                    已暂停
                  </div>
                </div>
                <div
                  class="text-center p-4 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200 shadow-sm"
                >
                  <div class="flex items-center justify-center mb-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-slate-600"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <div
                    id="mobile-multi-stopped-count"
                    class="text-2xl font-bold text-slate-600 mb-1"
                  >
                    0
                  </div>
                  <div class="text-xs text-slate-700 font-semibold">已停止</div>
                </div>
              </div>
            </div>

            <!-- ========== 批量执行选项 ========== -->
            <div class="mt-4 pt-3 border-t border-slate-100 space-y-3">
              <!-- ========== 【问题16修复】随机启动延迟配置 ========== -->
              <div class="p-3 bg-blue-50 rounded-lg space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="mobile-multi-random-delay-check"
                    checked
                    class="w-4 h-4 accent-orange-600 rounded flex-shrink-0"
                  />
                  <span class="text-sm text-slate-700 font-semibold"
                    >启用随机启动延迟</span
                  >
                </label>

                <div class="flex items-center gap-2 ml-6">
                  <label class="text-xs text-slate-600 whitespace-nowrap"
                    >延迟范围：</label
                  >
                  <div class="flex items-center gap-1 flex-1">
                    <input
                      type="number"
                      id="mobile-multi-random-delay-min"
                      class="input-field !py-1 !text-sm flex-1 min-w-0"
                      placeholder="最小"
                      value="0"
                      min="0"
                      max="300"
                      style="width: 70px"
                    />
                    <span class="text-xs text-slate-500">~</span>
                    <input
                      type="number"
                      id="mobile-multi-random-delay-max"
                      class="input-field !py-1 !text-sm flex-1 min-w-0"
                      placeholder="最大"
                      value="300"
                      min="0"
                      max="600"
                      style="width: 70px"
                    />
                    <span class="text-xs text-slate-500">秒</span>
                  </div>
                </div>
              </div>

              <label
                class="flex items-center gap-2 cursor-pointer p-2 bg-amber-50 rounded-lg hover:bg-amber-100 transition"
              >
                <input
                  type="checkbox"
                  id="mobile-multi-only-incomplete-check"
                  checked
                  class="w-4 h-4 accent-orange-600 rounded flex-shrink-0"
                />
                <span class="text-sm text-slate-700 font-semibold"
                  >仅启动未完成任务</span
                >
              </label>
            </div>
          </div>

          <!-- ========================================
             【地图面板】
             ======================================== -->
          <div
            class="mobile-card p-0 overflow-hidden h-screen flex flex-col"
            id="mobile-multi-map-panel"
          >
            <div
              id="mobile-multi-map-container"
              class="w-full flex-1 relative bg-slate-100"
              style="height: calc(100vh - 60px)"
            >
              <div
                class="absolute inset-0 flex items-center justify-center text-slate-400"
              >
                <div class="text-center">
                  <svg
                    class="w-12 h-12 mx-auto mb-2 text-slate-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                    />
                  </svg>
                  <p class="text-sm">地图加载中...</p>
                </div>
              </div>

              <button
                id="mobile-multi-map-reset-btn"
                class="absolute top-4 right-4 p-2 bg-white rounded-lg shadow-lg border border-slate-200 hover:bg-slate-50 transition z-10"
                style="display: none"
                onclick="resetMultiMapView()"
                title="复位视角"
              >
                <svg
                  class="w-5 h-5 text-slate-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                  />
                </svg>
              </button>
            </div>

            <div class="flex gap-2 p-3 bg-slate-50 flex-shrink-0">
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="mobileMultiZoomIn()"
              >
                放大 +
              </button>
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="mobileMultiZoomOut()"
              >
                缩小 -
              </button>
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="mobileMultiFitView()"
              >
                适应 ⊡
              </button>
              <button
                class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
                onclick="resetMultiMapView()"
              >
                复位 ⊙
              </button>
            </div>
          </div>

          <!-- ========================================
             【全局参数面板】
             ======================================== -->
          <div
            class="mobile-card mobile-card-fullscreen hidden"
            id="mobile-multi-settings-panel"
          >
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-teal-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-teal-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                />
              </svg>
              <h3 class="text-xl font-bold text-teal-700">全局参数</h3>
            </div>

            <div
              id="mobile-multi-global-params-container"
              class="space-y-3 max-h-[60vh] overflow-y-auto"
            ></div>

            <div class="pt-3 border-t border-teal-100">
              <button
                class="w-full py-2.5 bg-teal-500 text-white rounded-lg text-sm font-medium hover:bg-teal-600 transition flex items-center justify-center gap-2"
                onclick="saveMobileMultiGlobalSettings()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                保存全局设置
              </button>
            </div>
          </div>

          <div class="mobile-card" id="mobile-multi-admin-panel">
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-sky-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-sky-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <h3 class="text-xl font-bold text-sky-700">管理面板</h3>
            </div>

            <div
              id="mobile-multi-admin-tabs-nav-panel"
              class="flex border-b-2 border-slate-200 overflow-x-auto gap-1 pb-0 mb-4"
              style="scrollbar-width: none; -webkit-overflow-scrolling: touch"
            ></div>

            <div
              id="mobile-multi-admin-content-panel"
              class="text-sm space-y-2 min-h-[60vh] overflow-y-auto"
            >
              <p class="text-slate-400 text-center py-10">请选择管理功能</p>
            </div>
          </div>

          <div
            class="mobile-card mobile-card-fullscreen hidden"
            id="mobile-multi-log-panel"
          >
            <div
              class="flex items-center gap-2 mb-4 pb-3 border-b border-slate-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-slate-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              <h3 class="text-xl font-bold text-slate-700">全局日志</h3>
            </div>

            <div class="flex-1 overflow-hidden rounded-lg p-3">
              <textarea
                id="mobile-multi-log-text"
                readonly
                class="w-full h-full bg-white text-slate-800 font-mono text-xs border border-slate-300 rounded-lg resize-none outline-none p-3"
                placeholder="等待日志输出..."
              ></textarea>
            </div>

            <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
              <button
                class="flex-1 py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition flex items-center justify-center gap-1"
                onclick="clearMobileMultiLog()"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  />
                </svg>
                清空日志
              </button>
              <button
                class="flex-1 py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition flex items-center justify-center gap-1"
                onclick="scrollMobileMultiLogToBottom()"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 14l-7 7m0 0l-7-7m7 7V3"
                  />
                </svg>
                滚到底部
              </button>
            </div>
          </div>
        </div>
      </main>

      <!-- ========================================
         【移动端模态框区域】
         ======================================== -->

      <div
        id="mobile-user-details-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="toggleMobileUserDetails(false)"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <h3 class="text-xl font-bold text-sky-600 text-center">用户详情</h3>
          </div>
          <div
            id="mobile-user-details-content"
            class="text-sm space-y-1 max-h-[60vh] overflow-y-auto"
          ></div>

          <div class="flex justify-between gap-2 pt-2">
            <button
              class="py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition flex items-center gap-1"
              onclick="toggleMobileUserDetails(false); mobileLogout();"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                />
              </svg>
              返回登录
            </button>
            <button
              class="mobile-primary-btn"
              onclick="toggleMobileUserDetails(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-task-details-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="toggleMobileTaskDetails(false)"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <h3 class="text-xl font-bold text-sky-600 text-center">任务详情</h3>
          </div>
          <div
            id="mobile-task-details-content"
            class="text-sm space-y-1 max-h-[60vh] overflow-y-auto"
          ></div>
          <div class="flex justify-end pt-2">
            <button
              class="mobile-primary-btn"
              onclick="toggleMobileTaskDetails(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ========================================
         【移动端历史记录模态框】
         ======================================== -->
      <div
        id="mobile-history-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="closeMobileHistoryModal()"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-between pb-3 border-b border-slate-200"
          >
            <h3 class="text-xl font-bold text-purple-600">历史记录</h3>
            <span
              id="mobile-history-task-name"
              class="text-sm text-slate-600 bg-purple-50 px-3 py-1 rounded-full"
            ></span>
          </div>
          <div
            id="mobile-history-list-content"
            class="space-y-2 max-h-[60vh] overflow-y-auto"
          >
            <p class="text-slate-400 text-center py-10">加载中...</p>
          </div>
          <div class="flex justify-end pt-2">
            <button
              class="mobile-primary-btn"
              onclick="closeMobileHistoryModal()"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ========================================
         【移动端路径显示模态框】
         ======================================== -->
      <div
        id="mobile-track-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="closeMobileTrackModal()"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[90vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-between pb-3 border-b border-slate-200"
          >
            <h3 class="text-xl font-bold text-teal-600">跑步路径</h3>
            <span
              id="mobile-track-time"
              class="text-xs text-slate-600 bg-teal-50 px-2 py-1 rounded-full"
            ></span>
          </div>

          <div class="grid grid-cols-3 gap-2" id="mobile-track-summary">
            <div class="p-2 bg-blue-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">距离</p>
              <p
                id="mobile-track-distance"
                class="font-bold text-sm text-blue-600"
              >
                -- km
              </p>
            </div>
            <div class="p-2 bg-green-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">时长</p>
              <p
                id="mobile-track-duration"
                class="font-bold text-sm text-green-600"
              >
                --:--
              </p>
            </div>
            <div class="p-2 bg-purple-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">配速</p>
              <p
                id="mobile-track-pace"
                class="font-bold text-sm text-purple-600"
              >
                --:--
              </p>
            </div>
          </div>

          <div
            class="bg-slate-100 rounded-xl overflow-hidden border-2 border-slate-200"
          >
            <div
              id="mobile-track-map-container"
              class="w-full h-[300px] relative"
            >
              <div
                class="absolute inset-0 flex items-center justify-center text-slate-400"
              >
                <div class="text-center">
                  <svg
                    class="w-12 h-12 mx-auto mb-2 text-slate-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                    />
                  </svg>
                  <p class="text-sm">加载路径中...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-2">
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileTrackZoomIn()"
            >
              放大 +
            </button>
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileTrackZoomOut()"
            >
              缩小 -
            </button>
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileTrackFitView()"
            >
              适应 ⊡
            </button>
          </div>

          <div class="flex justify-end pt-2 border-t border-slate-100">
            <button
              class="mobile-primary-btn"
              onclick="closeMobileTrackModal()"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-map-attendance-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="closeMobileMapAttendanceModal()"
      >
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[90vh] flex flex-col shadow-2xl"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>

          <div
            class="flex items-center justify-between pb-3 border-b-2 border-purple-200"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-md"
              >
                <svg
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
              </div>
              <h3 class="text-xl font-bold text-purple-700">📍 地图选点签到</h3>
            </div>
          </div>

          <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-3">
            <div class="flex items-start gap-2">
              <svg
                class="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <div class="flex-1">
                <p class="text-sm font-bold text-purple-900 mb-1">操作提示</p>
                <p class="text-xs text-purple-700">
                  ① 点击地图选择签到位置<br />
                  ② 红色标记为选中位置<br />
                  ③ 点击"确认签到"提交
                </p>
              </div>
            </div>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <span class="text-sm font-bold text-slate-700">选中坐标：</span>
              <span
                id="mobile-map-attendance-coords"
                class="text-sm font-mono text-slate-600 bg-white px-3 py-1 rounded-md border border-slate-200"
              >
                未选择
              </span>
            </div>
          </div>

          <div
            class="flex-1 bg-slate-100 rounded-xl overflow-hidden border-2 border-slate-200 shadow-inner"
            style="min-height: 300px"
          >
            <div
              id="mobile-map-attendance-container"
              class="w-full h-full relative"
            >
              <div
                class="absolute inset-0 flex items-center justify-center text-slate-400 bg-slate-50"
              >
                <div class="text-center">
                  <svg
                    class="w-16 h-16 mx-auto mb-3 text-slate-300 animate-pulse"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                    />
                  </svg>
                  <p class="text-sm font-semibold">加载地图中...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-3 pt-3 border-t-2 border-slate-100">
            <button
              class="flex-1 py-3 px-4 bg-slate-100 text-slate-700 rounded-xl text-sm font-bold hover:bg-slate-200 transition-all border-2 border-slate-200"
              onclick="closeMobileMapAttendanceModal()"
            >
              取消
            </button>
            <button
              id="mobile-map-attendance-confirm-btn"
              class="flex-1 py-3 px-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl text-sm font-bold hover:from-purple-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
              onclick="confirmMobileMapAttendance()"
              disabled
            >
              <span class="flex items-center justify-center gap-2">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                确认签到
              </span>
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-notifications-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="toggleMobileNotifications(false)"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <h3 class="text-xl font-bold text-sky-600 text-center">通知中心</h3>
          </div>
          <div
            id="mobile-notifications-content"
            class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2"
          >
            <p class="text-slate-400 text-center py-10">正在加载...</p>
          </div>
          <div class="flex justify-between items-center pt-2">
            <div class="flex gap-2">
              <button
                id="mobile-refresh-notifications-modal-btn"
                class="py-2 px-4 bg-sky-50 text-sky-600 rounded-lg text-sm font-medium hover:bg-sky-100 transition"
              >
                刷新
              </button>
              <button
                id="mobile-mark-all-read-modal-btn"
                class="py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition"
              >
                一键已读
              </button>
            </div>
            <button
              class="mobile-primary-btn"
              onclick="toggleMobileNotifications(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-admin-panel-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="toggleMobileAdminPanel(false)"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <svg
              class="w-6 h-6 text-sky-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            <h3 class="text-xl font-bold text-sky-600 text-center">管理面板</h3>
          </div>
          <div
            id="mobile-admin-tabs-nav"
            class="flex border-b-2 border-slate-200 overflow-x-auto gap-1 pb-0 -mx-2 px-2"
            style="scrollbar-width: none"
          ></div>
          <div
            id="mobile-admin-panel-content"
            class="text-sm space-y-2 max-h-[60vh] overflow-y-auto"
          >
            <p class="text-slate-400 text-center py-10">加载中...</p>
          </div>
          <div class="flex justify-end pt-2">
            <button
              class="mobile-primary-btn"
              onclick="toggleMobileAdminPanel(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-account-params-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="closeMobileAccountParams()"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <h3
              id="mobile-account-params-title"
              class="text-xl font-bold text-sky-600 text-center"
            >
              账号参数设置
            </h3>
          </div>
          <div
            id="mobile-account-params-container"
            class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2"
          ></div>
          <div class="flex justify-end gap-3 pt-2">
            <button
              class="py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition"
              onclick="closeMobileAccountParams()"
            >
              取消
            </button>
            <button
              id="mobile-save-account-params-btn"
              class="mobile-primary-btn"
            >
              保存
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-multi-admin-panel-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="toggleMobileMultiAdminPanel(false)"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <svg
              class="w-6 h-6 text-sky-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            <h3 class="text-xl font-bold text-sky-600 text-center">管理面板</h3>
          </div>
          <div
            id="mobile-multi-admin-tabs-nav"
            class="flex border-b-2 border-slate-200 overflow-x-auto gap-1 pb-0 -mx-2 px-2"
            style="scrollbar-width: none"
          ></div>
          <div
            id="mobile-multi-admin-panel-content"
            class="text-sm space-y-2 max-h-[60vh] overflow-y-auto"
          >
            <p class="text-slate-400 text-center py-10">加载中...</p>
          </div>
          <div class="flex justify-end pt-2">
            <button
              class="mobile-primary-btn"
              onclick="toggleMobileMultiAdminPanel(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-manual-account-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="closeManualAccountModal()"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-teal-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
            <h3 class="text-xl font-bold text-teal-600 text-center">
              手动添加账号
            </h3>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2"
                >用户名</label
              >
              <input
                type="text"
                id="manual-account-username"
                class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none"
                placeholder="请输入学校账号用户名"
                autocomplete="username"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2"
                >密码</label
              >
              <input
                type="password"
                id="manual-account-password"
                class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none"
                placeholder="请输入密码"
                autocomplete="current-password"
              />
            </div>

            <div class="p-3 bg-teal-50 border border-teal-200 rounded-lg">
              <p class="text-xs text-teal-700">
                <strong>提示：</strong
                >手动添加的账号将使用默认配置。如需修改配置，请在账号列表中点击"参数设置"。
              </p>
            </div>
          </div>

          <div class="flex gap-3 pt-2">
            <button
              class="flex-1 py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition"
              onclick="closeManualAccountModal()"
            >
              取消
            </button>
            <button
              class="flex-1 py-2 px-4 bg-teal-500 text-white rounded-lg text-sm font-medium hover:bg-teal-600 transition"
              onclick="confirmManualAccountAdd()"
            >
              添加
            </button>
          </div>
        </div>
      </div>

      <div
        id="mobile-more-menu-modal"
        class="fixed inset-0 hidden mobile-modal z-50"
        onclick="toggleMobileMoreMenu(false)"
      >
        <div class="absolute inset-0 bg-black/40"></div>
        <div
          class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4"
          onclick="event.stopPropagation()"
        >
          <div class="flex justify-center mb-2">
            <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
          </div>
          <div
            class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200"
          >
            <h3 class="text-xl font-bold text-slate-700">更多功能</h3>
          </div>
          <div class="space-y-2">
            <button
              class="w-full flex items-center gap-3 p-4 bg-slate-50 hover:bg-slate-100 rounded-xl transition"
              onclick="toggleMobileMoreMenu(false); switchMobileSinglePanel('mobile-notification-panel'); setTimeout(() => switchMobileNotifTab('attendance'), 100);"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-blue-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <div class="flex-1 text-left">
                <div class="font-semibold text-slate-700">签到管理</div>
                <div class="text-xs text-slate-500">查看签到任务</div>
              </div>
            </button>

            <button
              class="w-full flex items-center gap-3 p-4 bg-slate-50 hover:bg-slate-100 rounded-xl transition"
              onclick="toggleMobileMoreMenu(false); toggleMobileAdminPanel(true);"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-purple-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <div class="flex-1 text-left">
                <div class="font-semibold text-slate-700">管理面板</div>
                <div class="text-xs text-slate-500">系统管理设置</div>
              </div>
            </button>

            <button
              class="w-full flex items-center gap-3 p-4 bg-slate-50 hover:bg-slate-100 rounded-xl transition"
              onclick="toggleMobileMoreMenu(false); toggleMobileUserDetails(true);"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-green-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
              <div class="flex-1 text-left">
                <div class="font-semibold text-slate-700">我的资料</div>
                <div class="text-xs text-slate-500">查看个人信息</div>
              </div>
            </button>

            <button
              class="w-full flex items-center gap-3 p-4 bg-red-50 hover:bg-red-100 rounded-xl transition"
              onclick="toggleMobileMoreMenu(false); mobileLogout();"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-red-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                />
              </svg>
              <div class="flex-1 text-left">
                <div class="font-semibold text-red-700">退出登录</div>
                <div class="text-xs text-red-500">安全退出系统</div>
              </div>
            </button>
          </div>
          <div class="flex justify-center pt-2">
            <button
              class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-medium hover:bg-slate-200 transition"
              onclick="toggleMobileMoreMenu(false)"
            >
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ========================================
         【移动端自定义确认对话框】
         ======================================== -->
      <div
        id="mobile-confirm-modal"
        class="fixed inset-0 hidden z-[60] flex items-center justify-center p-4"
        style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px)"
      >
        <div
          class="bg-gradient-to-br from-slate-50 to-white rounded-3xl shadow-2xl max-w-sm w-full transform transition-all"
          style="
            box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.1),
              -12px -12px 24px rgba(255, 255, 255, 0.9);
          "
          onclick="event.stopPropagation()"
        >
          <div class="p-6 pb-4 border-b border-slate-200">
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center flex-shrink-0"
                style="
                  box-shadow: 4px 4px 8px rgba(251, 146, 60, 0.3),
                    -2px -2px 8px rgba(255, 255, 255, 0.8);
                "
              >
                <svg
                  class="w-6 h-6 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                  />
                </svg>
              </div>
              <h3
                id="mobile-confirm-title"
                class="text-xl font-bold text-slate-800"
              >
                确认操作
              </h3>
            </div>
          </div>

          <div class="p-6 py-8">
            <p
              id="mobile-confirm-message"
              class="text-slate-600 text-base leading-relaxed"
            >
              确定要执行此操作吗？
            </p>
          </div>

          <div class="p-6 pt-0 flex gap-3">
            <button
              id="mobile-confirm-cancel-btn"
              class="flex-1 py-3 px-4 rounded-xl font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all"
              style="
                box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.08),
                  -2px -2px 8px rgba(255, 255, 255, 0.9);
              "
            >
              取消
            </button>
            <button
              id="mobile-confirm-ok-btn"
              class="flex-1 py-3 px-4 rounded-xl font-semibold text-white bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 transition-all"
              style="
                box-shadow: 4px 4px 12px rgba(239, 68, 68, 0.3),
                  -2px -2px 8px rgba(255, 255, 255, 0.1);
              "
            >
              确认
            </button>
          </div>
        </div>
      </div>

      <!-- ========================================
         【移动端底部导航栏区域】
         ======================================== -->

      <nav
        class="mobile-bottom-nav hidden"
        id="mobile-bottom-nav-single-account"
        style="display: none"
      >
        <a
          href="#"
          class="mobile-nav-btn active"
          data-nav="control"
          onclick="switchMobileSinglePanel('mobile-control-panel')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
            />
          </svg>
          <span>控制</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="map"
          onclick="switchMobileSinglePanel('mobile-map-panel')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
            />
          </svg>
          <span>地图</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="task"
          onclick="switchMobileSinglePanel('mobile-task-panel')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"
            />
          </svg>
          <span>任务</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="notifications"
          onclick="switchMobileSinglePanel('mobile-notification-panel')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"
            />
          </svg>
          <span>通知</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="attendance"
          onclick="switchMobileSinglePanel('mobile-attendance-panel')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z"
            />
          </svg>
          <span>签到</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="admin"
          onclick="toggleMobileAdminPanel(true)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
          <span>管理</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="settings"
          onclick="switchMobileSinglePanel('mobile-settings-panel')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"
            />
          </svg>
          <span>设置</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="profile"
          onclick="toggleMobileUserDetails(true)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
            />
          </svg>
          <span>我的</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="back"
          onclick="mobileLogout()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
          <span>返回</span>
        </a>
      </nav>

      <nav
        class="mobile-bottom-nav hidden"
        id="mobile-bottom-nav-multi-account"
        style="display: none"
      >
        <a
          href="#"
          class="mobile-nav-btn active"
          data-nav="control"
          onclick="switchMobilePanel('mobile-multi-control-panel', 'multi')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M13 10V3L4 14h7v7l9-11h-7z"
            />
          </svg>
          <span>控制</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="map"
          onclick="switchMobilePanel('mobile-multi-map-panel', 'multi')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
            />
          </svg>
          <span>地图</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="accounts"
          onclick="switchMobilePanel('mobile-multi-account-panel', 'multi')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"
            />
          </svg>
          <span>账号</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="admin"
          onclick="toggleMobileAdminPanel(true)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
          <span>管理</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="settings"
          onclick="switchMobilePanel('mobile-multi-settings-panel', 'multi')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"
            />
          </svg>
          <span>设置</span>
        </a>

        <a
          href="#"
          class="mobile-nav-btn"
          data-nav="back"
          onclick="exitMobileMultiAccount()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
          <span>返回</span>
        </a>
      </nav>

      <!-- ========================================
         【移动端侧边栏导航区域】
         ======================================== -->

      <div
        class="mobile-sidebar-backdrop"
        id="mobile-sidebar-backdrop"
        onclick="closeMobileSidebar()"
      ></div>

      <nav
        class="mobile-sidebar w-[200px] hidden"
        id="mobile-sidebar-single-account"
      >
        <div class="mobile-sidebar-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"
            />
          </svg>
          <div class="sidebar-title">跑步助手</div>
        </div>

        <div class="mobile-sidebar-menu">
          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-control-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
              />
            </svg>
            <span>控制</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-map-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
              />
            </svg>
            <span>地图</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-task-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"
              />
            </svg>
            <span>任务</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-task-details-panel'); closeMobileSidebar(); return false;"
            id="mobile-sidebar-task-details-link"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"
              />
            </svg>
            <span>任务详情</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-notification-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"
              />
            </svg>
            <span>通知</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-attendance-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z"
              />
            </svg>
            <span>签到</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-log-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <span>日志</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-checkpoints-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"
              />
            </svg>
            <span>打卡点</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-task-history-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span>历史记录</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-admin-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <span>管理</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-settings-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"
              />
            </svg>
            <span>设置</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item hidden"
            onclick="switchMobileSinglePanel('mobile-profile-panel'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
              />
            </svg>
            <span>我的资料</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobileSinglePanel('mobile-profile-panel'); closeMobileSidebar(); return false;"
            id="mobile-sidebar-user-details-link"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <span>我的</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item danger"
            onclick="closeMobileSidebar();showMobileConfirm('退出单账号模式', '确定要退出并返回会话选择吗？', async () => { await exitMobileSingleAccount(); closeMobileSidebar(); }); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
            <span>返回</span>
          </a>
        </div>
      </nav>

      <nav class="mobile-sidebar hidden" id="mobile-sidebar-multi-account">
        <div class="mobile-sidebar-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"
            />
          </svg>
          <div class="sidebar-title">跑步助手</div>
        </div>

        <div class="mobile-sidebar-menu">
          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobilePanel('mobile-multi-control-panel', 'multi'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
            <span>控制</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobilePanel('mobile-multi-map-panel', 'multi'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
              />
            </svg>
            <span>地图</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobilePanel('mobile-multi-account-panel', 'multi'); closeMobileSidebar(); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"
              />
            </svg>
            <span>账号</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobilePanel('mobile-multi-admin-panel', 'multi'); closeMobileSidebar(); return false;"
            id="mobile_multi_admin_panel_bnt"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <span>管理</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobilePanel('mobile-multi-settings-panel', 'multi'); closeMobileSidebar(); return false;"
            id="mobile_multi_settings_panel_bnt"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"
              />
            </svg>
            <span>设置</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item"
            onclick="switchMobilePanel('mobile-multi-log-panel', 'multi'); closeMobileSidebar(); return false;"
            id="mobile_multi_log_panel_bnt"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <span>日志</span>
          </a>

          <a
            href="#"
            class="mobile-sidebar-item danger"
            onclick="closeMobileSidebar(); showMobileConfirm('退出多账号模式', '确定要退出多账号模式并返回会话选择吗？', async () => { await exitMobileMultiAccountToSessions(); closeMobileSidebar(); }); return false;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              />
            </svg>
            <span>返回</span>
          </a>
        </div>
      </nav>
    </div>

    <div
      id="mobile-session-picker-modal"
      class="fixed inset-0 hidden mobile-modal"
      onclick="closeMobileSessionPicker()"
    >
      <div
        class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()"
      >
        <div class="flex justify-center mb-2">
          <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
        </div>

        <div
          class="flex items-center justify-between pb-3 border-b border-slate-200"
        >
          <h3 class="text-xl font-bold text-sky-600">会话管理</h3>
          <div
            id="mobile-session-picker-count-display"
            class="text-sm text-slate-600 bg-sky-50 px-3 py-1 rounded-full"
          ></div>
        </div>

        <div class="bg-sky-50 border border-sky-200 rounded-lg p-4">
          <p class="text-sm text-slate-700 mb-3">选择现有会话或创建新会话</p>
          <button
            class="mobile-primary-btn w-full"
            onclick="createNewSessionFromPicker()"
            id="mobile-create-session-picker-btn"
          >
            <svg
              class="w-5 h-5 inline-block mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              ></path>
            </svg>
            创建新会话
          </button>
        </div>

        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold text-slate-700">现有会话</h4>
            <button
              class="p-2 hover:bg-slate-100 rounded-lg transition-colors"
              onclick="refreshMobileSessionPicker()"
            >
              <svg
                class="w-5 h-5 text-slate-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
              </svg>
            </button>
          </div>

          <div id="mobile-session-picker-list" class="space-y-2">
            <p class="text-slate-400 text-center py-10">加载中...</p>
          </div>
        </div>

        <div class="border-t pt-4 text-xs text-slate-500 relative">
          <p>
            💡
            提示：每个会话都是独立的学校账号登录状态。您可以创建多个会话来管理不同的账号。
          </p>
        </div>
      </div>
    </div>

    <div
      id="account-params-modal"
      class="fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="absolute inset-0 bg-black/40"
        onclick="
    const modalElem = this.parentElement;
    modalElem.classList.add('hidden'); 
    modalElem.classList.remove('flex'); 
    document.body.classList.remove('modal-visible');
  "
      ></div>
      <div class="panel rounded-2xl p-6 w-[32rem] space-y-4 relative">
        <h3
          id="account-params-title"
          class="text-xl font-bold text-sky-600 text-center"
        >
          账号参数设置
        </h3>
        <div
          id="account-params-container"
          class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2"
        ></div>
        <div class="flex justify-end pt-2 gap-3">
          <button
            class="btn btn-ghost border border-slate-300"
            onclick="
        const m = this.closest('#account-params-modal');
        m.classList.add('hidden'); 
        m.classList.remove('flex'); 
        document.body.classList.remove('modal-visible');
      "
          >
            关闭
          </button>

          <button id="save-account-params-btn" class="btn btn-primary">
            保存
          </button>
        </div>
      </div>
    </div>

    <div
      id="notifications-modal"
      class="fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="absolute inset-0 bg-black/40"
        onclick="toggleNotifications(false)"
      ></div>
      <div class="panel rounded-2xl p-6 w-[36rem] space-y-4 relative">
        <h3 class="text-xl font-bold text-sky-600 text-center">通知中心</h3>
        <div
          id="notifications-content"
          class="text-sm space-y-2 max-h-[70vh] overflow-y-auto pr-2"
        >
          <p class="text-slate-400 text-center py-10">正在加载...</p>
        </div>
        <div class="flex justify-between items-center pt-2">
          <div class="flex gap-2">
            <button
              id="refresh-notifications-btn"
              class="btn btn-ghost !py-1 !px-3 text-sky-600"
            >
              刷新
            </button>
            <button
              id="mark-all-read-btn"
              class="btn btn-secondary !py-1 !px-3"
            >
              一键已读
            </button>
          </div>
          <button
            class="btn btn-ghost border border-slate-300"
            onclick="toggleNotifications(false)"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <div
      id="alert-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[50000]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeModalAlert()"
      ></div>
      <div class="panel rounded-2xl p-6 w-11/12 md:w-96 space-y-6 relative">
        <h3
          id="alert-modal-title"
          class="text-xl font-bold text-red-600 text-center"
        >
          操作失败
        </h3>
        <p
          id="alert-modal-message"
          class="text-sm text-slate-600 text-center py-4"
        >
          这是一个错误提示。
        </p>
        <div class="flex justify-center gap-3 pt-4">
          <button id="alert-modal-close-btn" class="btn btn-primary">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 
    ===================================================================
    管理面板模态框
    ===================================================================
  -->
    <div
      id="admin-panel-modal"
      class="fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="absolute inset-0 bg-gradient-to-br from-black/50 to-slate-900/60 backdrop-blur-sm"
        onclick="toggleAdminPanel(false)"
      ></div>

      <div
        class="panel rounded-3xl p-8 w-[65rem] max-h-[85vh] overflow-x-hidden space-y-5 relative flex flex-col shadow-2xl border-2 border-white/20"
      >
        <div class="relative mb-2 text-center flex-shrink-0">
          <div class="flex items-center justify-center gap-3">
            <svg
              class="w-8 h-8 text-sky-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            <h3
              class="text-3xl font-bold bg-gradient-to-r from-sky-600 to-blue-600 bg-clip-text text-transparent inline-block"
            >
              管理面板
            </h3>
          </div>

          <button
            id="admin-modal-close-btn"
            class="absolute top-1/2 right-0 transform -translate-y-1/2 btn btn-ghost !py-2 !px-4 hover:bg-red-50 hover:text-red-600 transition-all duration-200 rounded-xl"
            onclick="toggleAdminPanel(false)"
          >
            <svg
              class="w-5 h-5 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
            关闭
          </button>
        </div>

        <div
          class="flex border-b-2 border-slate-200 flex-shrink-0 overflow-x-auto gap-1 pb-0"
        >
          <button
            id="admin-tab-users_modal"
            class="px-5 py-3 font-semibold text-sky-600 border-b-3 border-sky-600 hover:bg-sky-50 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
              ></path>
            </svg>
            用户管理
          </button>

          <button
            id="admin-tab-groups_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              ></path>
            </svg>
            权限组
          </button>

          <button
            id="admin-tab-logs_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
            日志查看
          </button>

          <button
            id="admin-tab-health_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              ></path>
            </svg>
            系统状态
          </button>

          <button
            id="admin-tab-profile_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            个人信息
          </button>

          <button
            id="admin-tab-sessions_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            会话管理
          </button>

          <button
            id="admin-tab-messages_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
              ></path>
            </svg>
            留言板
          </button>

          <button
            id="admin-tab-ipban_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
              ></path>
            </svg>
            IP封禁
          </button>

          <button
            id="admin-tab-sms_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              ></path>
            </svg>
            短信配置
          </button>

          <button
            id="admin-tab-config_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
              ></path>
            </svg>
            系统配置
          </button>

          <button
            id="admin-tab-captcha_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            验证码管理
          </button>

          <button
            id="admin-tab-reminders_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            定时提醒
          </button>

          <button
            id="admin-tab-ssl_modal"
            class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
            style="display: none"
          >
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              ></path>
            </svg>
            HTTPS设置
          </button>
        </div>

        <div class="overflow-x-hidden flex-grow min-h-0">
          <div id="admin-users-panel_modal" class="space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">用户列表</h4>
              <div class="flex gap-2">
                <button
                  id="admin-view-school-accounts_modal"
                  class="btn btn-secondary !py-1 !px-2"
                  style="display: none"
                >
                  查看 School Accounts
                </button>
                <button
                  id="admin-create-user_modal"
                  class="btn btn-primary !py-1 !px-2"
                >
                  新增用户
                </button>
                <button
                  id="admin-refresh-users_modal"
                  class="btn btn-ghost !py-1 !px-2"
                >
                  刷新
                </button>
              </div>
            </div>
            <div
              id="admin-users-list_modal"
              class="space-y-2 max-h-[50vh] overflow-y-auto -mr-2 pr-2"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>
          </div>

          <div id="admin-groups-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">权限组列表</h4>
              <div class="flex gap-2">
                <button
                  id="admin-create-group_modal"
                  class="btn btn-primary !py-1 !px-2"
                >
                  新增权限组
                </button>
                <button
                  id="admin-refresh-groups_modal"
                  class="btn btn-ghost !py-1 !px-2"
                >
                  刷新
                </button>
              </div>
            </div>
            <div
              id="admin-groups-list_modal"
              class="space-y-2 max-h-[50vh] overflow-y-auto -mr-2 pr-2"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>
          </div>

          <div id="admin-logs-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">系统日志</h4>
              <div class="flex gap-2">
                <select
                  id="log-limit-select_modal"
                  class="text-sm border border-slate-300 rounded px-2 py-1"
                >
                  <option value="100">每页100行</option>
                  <option value="200">每页200行</option>
                  <option value="500">每页500行</option>
                  <option value="1000">每页1000行</option>
                </select>
                <button
                  id="admin-refresh-logs_modal"
                  class="btn btn-ghost !py-1 !px-2"
                >
                  刷新
                </button>
              </div>
            </div>
            <div
              class="bg-slate-900 text-green-400 rounded-lg p-4 font-mono text-xs overflow-auto max-h-[47vh]"
            >
              <pre
                id="admin-logs-content_modal"
                class="whitespace-pre-wrap overflow-visible"
              >
加载中...</pre
              >
            </div>
            <div
              id="admin-logs-pagination"
              class="flex justify-between items-center text-sm text-slate-600 pt-2 border-t border-slate-200"
            >
              <button
                id="log-prev-page"
                class="btn btn-ghost !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                上一页
              </button>

              <div class="flex items-center gap-2">
                <select
                  id="log-page-select"
                  class="text-sm border border-slate-300 rounded px-2 py-1 bg-white focus:border-sky-500 focus:ring-1 focus:ring-sky-500 focus:outline-none cursor-pointer"
                >
                  <option value="1">第 1 / 1 页</option>
                </select>
                <span
                  id="log-page-total"
                  class="text-sm text-slate-500 whitespace-nowrap"
                  >(共 0 行)</span
                >
              </div>

              <button
                id="log-next-page"
                class="btn btn-ghost !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                下一页
              </button>
            </div>
          </div>

          <div id="admin-sessions-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">会话列表</h4>
              <div class="flex items-center gap-3">
                <label
                  id="god-mode-toggle_modal"
                  class="flex items-center gap-2 cursor-pointer"
                  style="display: none"
                >
                  <input
                    type="checkbox"
                    id="god-mode-checkbox_modal"
                    class="w-4 h-4 accent-red-600 rounded cursor-pointer"
                  />
                  <span class="text-sm font-semibold text-red-600"
                    >查看所有会话</span
                  >
                </label>
                <div
                  id="admin-session-count-display"
                  class="text-sm text-slate-600"
                ></div>
                <button
                  id="admin-refresh-sessions_modal"
                  class="btn btn-ghost !py-1 !px-2"
                >
                  刷新
                </button>
              </div>
            </div>
            <div
              id="admin-sessions-list_modal"
              class="space-y-2 max-h-[50vh] overflow-y-auto"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>
          </div>

          <div id="admin-health-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">系统健康状态</h4>
              <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="health-auto-refresh-toggle"
                    class="w-4 h-4 accent-sky-600 rounded cursor-pointer"
                    checked
                  />
                  <span class="text-sm text-slate-600">
                    自动刷新(5秒)
                    <span
                      id="health-countdown-display"
                      class="font-semibold text-sky-600"
                    ></span>
                  </span>
                </label>
                <button
                  id="admin-refresh-health_modal"
                  class="btn btn-ghost !py-1 !px-2"
                >
                  手动刷新
                </button>
              </div>
            </div>
            <div id="admin-health-content_modal" class="space-y-4">
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>
          </div>

          <div id="admin-profile-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">个人信息</h4>
              <button
                id="admin-refresh-profile_modal"
                class="btn btn-ghost !py-1 !px-2"
              >
                刷新
              </button>
            </div>

            <div
              id="admin-profile-content_modal"
              class="space-y-6 text-slate-800"
            >
              <div
                class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3"
              >
                <h5 class="font-semibold text-slate-700 mb-2">头像</h5>
                <div class="flex items-center gap-4">
                  <img
                    id="profile-avatar-display"
                    src=""
                    alt="用户头像"
                    class="w-20 h-20 rounded-full border-2 border-slate-200"
                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3E👤%3C/text%3E%3C/svg%3E'"
                  />
                  <div class="flex-1 space-y-2">
                    <input
                      type="file"
                      id="profile-avatar-file"
                      accept="image/*"
                      class="hidden"
                      onchange="previewAvatar(event)"
                    />

                    <button
                      class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm"
                      onclick="document.getElementById('profile-avatar-file').click();"
                    >
                      <svg
                        class="w-4 h-4 mr-1.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                        ></path>
                      </svg>
                      上传头像
                    </button>
                  </div>
                </div>
              </div>

              <div
                class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3"
              >
                <h5 class="font-semibold text-slate-700 mb-3">基本信息</h5>
                <div class="space-y-3">
                  <div>
                    <label
                      class="block text-sm font-semibold text-slate-700 mb-1"
                      >昵称</label
                    >
                    <input
                      type="text"
                      id="profile-nickname"
                      class="input-field"
                      placeholder="输入昵称"
                    />
                  </div>
                  <div>
                    <label
                      class="block text-sm font-semibold text-slate-700 mb-1"
                      >手机号</label
                    >
                    <div class="flex gap-2">
                      <div class="phone-input-wrapper flex-1">
                        <span class="phone-prefix">+86 </span>
                        <input
                          type="tel"
                          id="profile-phone"
                          class="input-field"
                          placeholder="未绑定"
                          readonly
                          inputmode="numeric"
                        />
                      </div>
                      <button
                        onclick="modifyPhone()"
                        id="profile-modify-phone-btn"
                        class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm whitespace-nowrap"
                      >
                        修改手机号
                      </button>
                    </div>
                    <p
                      class="text-xs text-slate-500 mt-1"
                      id="profile-phone-hint"
                    >
                      💡 修改手机号需要短信验证
                    </p>
                  </div>
                  <div class="flex justify-end">
                    <button onclick="updateBasicInfo()" class="btn btn-primary">
                      保存基本信息
                    </button>
                  </div>
                </div>
              </div>

              <div
                class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3"
              >
                <h5 class="font-semibold text-slate-700 mb-3">修改密码</h5>
                <div class="space-y-3">
                  <div>
                    <label
                      class="block text-sm font-semibold text-slate-700 mb-1"
                      >当前密码</label
                    >
                    <input
                      type="password"
                      id="profile-current-password"
                      class="input-field"
                      placeholder="输入当前密码"
                    />
                  </div>
                  <div>
                    <label
                      class="block text-sm font-semibold text-slate-700 mb-1"
                      >新密码</label
                    >
                    <input
                      type="password"
                      id="profile-new-password"
                      class="input-field"
                      placeholder="输入新密码"
                    />
                  </div>
                  <div>
                    <label
                      class="block text-sm font-semibold text-slate-700 mb-1"
                      >确认新密码</label
                    >
                    <input
                      type="password"
                      id="profile-confirm-password"
                      class="input-field"
                      placeholder="再次输入新密码"
                    />
                  </div>
                  <div class="flex justify-end">
                    <button onclick="updatePassword()" class="btn btn-primary">
                      修改密码
                    </button>
                  </div>
                </div>
              </div>

              <div
                class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3"
              >
                <h5 class="font-semibold text-slate-700 mb-3">
                  双因素认证(2FA)
                </h5>
                <div id="profile-2fa-status" class="mb-3">
                  <p class="text-sm text-slate-600">
                    状态: <span id="profile-2fa-enabled">检测中...</span>
                  </p>
                </div>
                <div id="profile-2fa-setup" class="space-y-3 hidden">
                  <div
                    class="bg-slate-100 border border-slate-200 rounded-lg p-4 text-center"
                  >
                    <canvas id="profile-2fa-qr" class="mx-auto"></canvas>
                    <p class="text-xs text-slate-600 mt-2">
                      密钥:
                      <span id="profile-2fa-secret" class="font-mono"></span>
                    </p>
                    <p class="text-xs text-slate-600 mt-1">
                      请使用Google Authenticator或类似应用扫描此二维码
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-semibold text-slate-700 mb-1"
                      >验证码</label
                    >
                    <input
                      type="text"
                      id="profile-2fa-code"
                      class="input-field"
                      placeholder="输入6位验证码"
                    />
                  </div>
                  <div class="flex justify-end">
                    <button onclick="enable2FA()" class="btn btn-primary">
                      启用2FA
                    </button>
                  </div>
                </div>
                <div
                  id="profile-2fa-actions"
                  class="space-y-2 flex justify-end"
                >
                  <button onclick="generate2FA()" class="btn btn-primary">
                    生成2FA密钥
                  </button>
                </div>
                <div
                  id="profile-2fa-enabled-actions"
                  class="space-y-2 hidden flex justify-end gap-2"
                >
                  <button onclick="test2FA()" class="btn btn-ghost">
                    测试2FA
                  </button>
                  <button onclick="disable2FA()" class="btn btn-warning">
                    关闭2FA
                  </button>
                </div>
              </div>

              <div
                class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3"
              >
                <h5 class="font-semibold text-slate-700 mb-3">主题设置</h5>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-slate-700"
                    >主题风格</label
                  >
                  <select
                    id="profile-theme-select"
                    onchange="updateTheme()"
                    class="select-field"
                  >
                    <option value="light">浅色主题</option>
                    <option value="dark">深色主题</option>
                  </select>
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-slate-700"
                    >主题样式</label
                  >
                  <div class="grid grid-cols-3 gap-2">
                    <button
                      onclick="setThemeStyle('default')"
                      class="btn btn-ghost !py-2 text-sm border border-slate-300 hover:border-sky-500"
                    >
                      默认
                    </button>
                    <button
                      onclick="setThemeStyle('theme-anime')"
                      class="btn btn-ghost !py-2 text-sm border border-slate-300 hover:border-sky-500"
                    >
                      二次元
                    </button>
                    <button
                      onclick="setThemeStyle('theme-minimalist')"
                      class="btn btn-ghost !py-2 text-sm border border-slate-300 hover:border-sky-500"
                    >
                      简约
                    </button>
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-slate-700"
                    >主题基础颜色</label
                  >
                  <div class="flex gap-2 items-center">
                    <input
                      type="color"
                      id="profile-theme_base_color-picker"
                      value="#7dd3fc"
                      class="w-12 h-10 border border-slate-300 rounded cursor-pointer"
                      onchange="onColorPicked(this.value); updateParam('theme_base_color', this.value);"
                      title="点击选择颜色"
                    />

                    <input
                      type="text"
                      id="profile-theme_base_color"
                      value="#7dd3fc"
                      class="input-field flex-1 font-mono text-sm"
                      placeholder="#7dd3fc"
                      onchange="onColorPicked(this.value); updateParam('theme_base_color', this.value);"
                      pattern="^#[0-9A-Fa-f]{6}$"
                      title="输入16进制颜色值，如 #7dd3fc"
                    />

                    <button
                      onclick="resetBaseColorToDefault('profile')"
                      class="btn btn-ghost border border-slate-300 !py-2 !px-3 text-sm whitespace-nowrap hover:bg-slate-100"
                      title="恢复为默认颜色 #7dd3fc"
                    >
                      恢复默认
                    </button>
                  </div>
                  <p class="text-xs text-slate-500">
                    💡 自定义主题的主要色调，影响按钮、边框等元素颜色
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div id="admin-messages-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold">留言板</h4>
              <button
                id="admin-refresh-messages_modal"
                class="btn btn-ghost !py-1 !px-2"
              >
                刷新
              </button>
            </div>

            <div
              class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3"
            >
              <h5 class="font-semibold text-slate-700">发表留言</h5>
              <div id="message-guest-fields" class="space-y-2 hidden">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1"
                    >昵称 <span class="text-red-500">*</span></label
                  >
                  <input
                    type="text"
                    id="message-nickname"
                    class="input-field"
                    placeholder="请输入您的昵称"
                    maxlength="50"
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1"
                    >邮箱 <span class="text-red-500">*</span></label
                  >
                  <input
                    type="email"
                    id="message-email"
                    class="input-field"
                    placeholder="请输入您的邮箱"
                  />
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1"
                  >留言内容 <span class="text-red-500">*</span></label
                >
                <textarea
                  id="message-content"
                  class="input-field"
                  rows="4"
                  placeholder="请输入留言内容（最多1000字）"
                  maxlength="1000"
                ></textarea>
                <div class="text-xs text-slate-500 mt-1 text-right">
                  <span id="message-char-count">0</span> / 1000
                </div>
              </div>
              <button
                id="post-message-btn"
                onclick="postMessage()"
                class="btn btn-primary w-full"
              >
                发表留言
              </button>
            </div>

            <div
              id="admin-messages-list_modal"
              class="space-y-3 max-h-[19vh] overflow-y-auto"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- 用户日志查看l -->
          <!-- ============================================================ -->
          <div id="admin-user-logs-modal" class="hidden space-y-4">
            <h4 class="font-semibold">用户日志查看</h4>

            <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
              <p class="text-sm text-slate-700">
                当前查看用户:
                <span
                  id="current-log-username"
                  class="font-semibold text-sky-600"
                  >N/A</span
                >
              </p>
            </div>

            <div class="flex border-b border-slate-200">
              <button
                id="log-tab-login"
                class="px-4 py-2 font-semibold text-sky-600 border-b-2 border-sky-600"
              >
                登录记录
              </button>
              <button
                id="log-tab-audit"
                class="px-4 py-2 font-semibold text-slate-400 border-b-2 border-transparent"
              >
                操作记录
              </button>
            </div>

            <div
              id="log-login-content"
              class="space-y-2 max-h-[50vh] overflow-y-auto"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>

            <div
              id="log-audit-content"
              class="hidden space-y-2 max-h-[50vh] overflow-y-auto"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>

            <div class="flex justify-end">
              <button onclick="closeUserLogsModal()" class="btn btn-ghost">
                返回
              </button>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- IP封禁管理 -->
          <!-- ============================================================ -->
          <div id="admin-ip-ban-modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-lg">🚫 IP封禁管理</h4>
              <button
                id="admin-refresh-ipban_modal"
                class="btn btn-ghost !py-1 !px-2"
                onclick="loadIPBans()"
              >
                刷新
              </button>
            </div>

            <div
              class="bg-gradient-to-br from-slate-50 to-gray-50 border-2 border-slate-200 rounded-lg p-4 shadow-sm"
            >
              <h5 class="font-bold text-base text-slate-800 mb-3">
                📜 现有封禁规则
              </h5>
              <div
                id="ip-ban-list"
                class="space-y-2 max-h-[35vh] overflow-y-auto -mr-2 pr-2"
              >
                <p class="text-slate-400 text-center py-10">加载中...</p>
              </div>
            </div>

            <div
              class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg p-4 shadow-sm"
            >
              <h5 class="font-bold text-base text-blue-900 mb-3">
                ➕ 添加封禁规则
              </h5>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1"
                    >🏷️ 封禁类型</label
                  >
                  <select id="ban-type" class="select-field">
                    <option value="ip">单个IP</option>
                    <option value="range">IP范围(Range)</option>
                  </select>
                  <p class="mt-1 text-xs text-slate-500">
                    - <strong>单个IP</strong>: 封禁一个特定的IP地址 (例如:
                    1.2.3.4)<br />
                    - <strong>IP范围(Range)</strong>: 封禁一个IP地址范围 (例如:
                    192.168.1.1-192.168.1.100)
                  </p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1"
                    >🎯 封禁目标</label
                  >
                  <input
                    type="text"
                    id="ban-target"
                    class="input-field"
                    placeholder="请输入IP地址 (例如: 1.2.3.4)"
                  />
                  <p id="ban-target-hint" class="mt-1 text-xs text-slate-500">
                    示例: 1.2.3.4
                  </p>
                  <p
                    id="ban-target-error"
                    class="hidden mt-1 text-xs text-red-600 font-semibold"
                  ></p>
                </div>

                <div
                  class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end pt-2 border-t border-blue-100"
                >
                  <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1"
                      >🔒 封禁范围</label
                    >
                    <select id="ban-scope" class="select-field">
                      <option value="all">封禁所有功能</option>
                      <option value="messages_only">仅封禁留言板</option>
                    </select>
                  </div>
                  <button
                    onclick="addIPBan()"
                    class="btn btn-primary w-full min-h-[44px]"
                  >
                    添加封禁
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ============短信服务配置============ -->
          <div id="admin-sms-config-modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-lg">📱 短信服务配置</h4>
              <button
                id="admin-refresh-sms_modal"
                class="btn btn-ghost !py-1 !px-2"
                onclick="loadSMSConfig()"
              >
                刷新
              </button>
            </div>

            <div class="space-y-4">
              <!-- ========== 功能开关卡片 ========== -->
              <div
                class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 shadow-sm"
              >
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">🔌</span>
                  <h5 class="font-bold text-base text-purple-900">功能开关</h5>
                </div>

                <label
                  class="flex items-center gap-3 p-3 bg-white rounded-lg border border-purple-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                >
                  <input
                    type="checkbox"
                    id="sms-enabled"
                    class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500"
                    onchange="handleSmsMainSwitchChange()"
                  />
                  <div class="flex-1">
                    <span class="font-semibold text-slate-800 block"
                      >启用短信服务</span
                    >
                    <span class="text-xs text-slate-500"
                      >关闭此开关将禁用所有短信功能</span
                    >
                  </div>
                </label>

                <div
                  class="ml-8 mt-3 space-y-2 border-l-2 border-purple-200 pl-4"
                >
                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      id="sms-enable-phone-modification"
                      class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                    />
                    <div class="flex-1">
                      <span
                        class="text-sm text-slate-700 group-hover:text-slate-900"
                        >允许用户修改手机号</span
                      >
                      <span class="text-xs text-slate-400 block"
                        >用户可在个人资料中修改绑定的手机号</span
                      >
                    </div>
                  </label>

                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      id="sms-enable-phone-login"
                      class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                    />
                    <div class="flex-1">
                      <span
                        class="text-sm text-slate-700 group-hover:text-slate-900"
                        >允许手机号登录</span
                      >
                      <span class="text-xs text-slate-400 block"
                        >用户可使用手机号+密码进行登录</span
                      >
                    </div>
                  </label>

                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      id="sms-enable-phone-registration-verify"
                      class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                    />
                    <div class="flex-1">
                      <span
                        class="text-sm text-slate-700 group-hover:text-slate-900"
                        >注册时需要短信验证</span
                      >
                      <span class="text-xs text-slate-400 block"
                        >用户注册时必须填写手机号并验证</span
                      >
                    </div>
                  </label>
                </div>
              </div>

              <!-- ==========短信宝配置卡片 ========== -->
              <div
                class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg p-4 shadow-sm"
              >
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">📧</span>
                  <h5 class="font-bold text-base text-blue-900">短信宝配置</h5>
                </div>

                <div class="space-y-3">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        👤 用户名
                      </span>
                    </label>
                    <input
                      type="text"
                      id="sms-username"
                      class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                      placeholder="请输入短信宝用户名"
                    />
                    <p class="text-xs text-slate-500 mt-1">
                      在短信宝官网注册后获取
                    </p>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        🔑 API Key
                      </span>
                    </label>
                    <input
                      type="password"
                      id="sms-apikey"
                      class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                      placeholder="请输入短信宝 API Key"
                    />
                    <p class="text-xs text-slate-500 mt-1">
                      在短信宝后台的"API接口"页面获取
                    </p>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        ✍️ 短信签名
                      </span>
                    </label>
                    <input
                      type="text"
                      id="sms-signature"
                      class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                      placeholder="【您的签名】"
                      maxlength="12"
                    />
                    <p class="text-xs text-slate-500 mt-1">
                      签名长度3-12字，需在短信宝后台审核通过
                    </p>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        📝 短信模板
                      </span>
                    </label>
                    <textarea
                      id="sms-template"
                      class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                      rows="3"
                      placeholder="您的验证码是：{code}，{minutes}分钟内有效。"
                    ></textarea>
                    <p class="text-xs text-slate-500 mt-1">
                      使用 {code} 表示验证码，{minutes} 表示有效期分钟数
                    </p>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        ⏱️ 验证码有效期
                      </span>
                    </label>
                    <div class="flex items-center gap-2">
                      <input
                        type="number"
                        id="sms-code-expire"
                        class="flex-1 border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                        placeholder="5"
                        min="1"
                        max="60"
                      />
                      <span class="text-sm text-slate-600">分钟</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">
                      建议设置为5-10分钟，过长不安全，过短体验差
                    </p>
                  </div>
                </div>
              </div>

              <!-- ==========速率限制卡片 ========== -->
              <div
                class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 rounded-lg p-4 shadow-sm"
              >
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">⚡</span>
                  <h5 class="font-bold text-base text-orange-900">速率限制</h5>
                </div>
                <p class="text-xs text-slate-600 mb-3">
                  防止滥用和恶意攻击，保护系统安全
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        👤 账户限制
                      </span>
                    </label>
                    <div class="flex items-center gap-1">
                      <input
                        type="number"
                        id="sms-limit-account"
                        class="w-full border-2 border-orange-200 rounded-lg px-3 py-2 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
                        placeholder="10"
                        min="1"
                      />
                      <span class="text-sm text-slate-600 whitespace-nowrap"
                        >条/天</span
                      >
                    </div>
                    <p class="text-xs text-slate-500 mt-1">单个账号每天最多</p>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        🌐 IP限制
                      </span>
                    </label>
                    <div class="flex items-center gap-1">
                      <input
                        type="number"
                        id="sms-limit-ip"
                        class="w-full border-2 border-orange-200 rounded-lg px-3 py-2 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
                        placeholder="20"
                        min="1"
                      />
                      <span class="text-sm text-slate-600 whitespace-nowrap"
                        >条/天</span
                      >
                    </div>
                    <p class="text-xs text-slate-500 mt-1">单个IP每天最多</p>
                  </div>

                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <span class="inline-flex items-center gap-1">
                        📱 手机号限制
                      </span>
                    </label>
                    <div class="flex items-center gap-1">
                      <input
                        type="number"
                        id="sms-limit-phone"
                        class="w-full border-2 border-orange-200 rounded-lg px-3 py-2 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
                        placeholder="5"
                        min="1"
                      />
                      <span class="text-sm text-slate-600 whitespace-nowrap"
                        >条/天</span
                      >
                    </div>
                    <p class="text-xs text-slate-500 mt-1">
                      单个手机号每天最多
                    </p>
                  </div>
                </div>
              </div>

              <!-- ========== Webhook配置卡片 ========== -->
              <div
                class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4 shadow-sm"
              >
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">🔗</span>
                  <h5 class="font-bold text-base text-green-900">
                    Webhook 回调地址
                  </h5>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1"
                    >回调地址</label
                  >
                  <input
                    type="text"
                    id="sms-webhook-url"
                    class="w-full border-2 border-green-200 rounded-lg px-3 py-2 bg-green-50 text-slate-700 font-mono text-sm"
                    readonly
                  />
                  <p class="text-xs text-slate-600 mt-2 flex items-start gap-1">
                    <span>💡</span>
                    <span
                      >将此URL配置到短信宝后台的"短信回复"功能中，即可接收用户回复的短信</span
                    >
                  </p>
                </div>
              </div>

              <!-- ==========操作区卡片========== -->
              <div
                class="bg-gradient-to-br from-slate-50 to-gray-50 border-2 border-slate-200 rounded-lg p-4 shadow-sm"
              >
                <div class="flex flex-col sm:flex-row gap-3">
                  <button
                    id="btn-check-sms-balance"
                    onclick="checkSMSBalance()"
                    class="flex-1 btn btn-ghost min-h-[44px] border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-100 transition-all"
                  >
                    💰 查询余额
                  </button>
                  <button
                    onclick="saveSMSConfig()"
                    class="flex-1 btn btn-primary min-h-[44px] shadow-md hover:shadow-lg transition-all"
                  >
                    💾 保存配置
                  </button>
                </div>

                <div
                  class="flex flex-col sm:flex-row gap-3 mt-3 pt-3 border-t-2 border-slate-200"
                >
                  <button
                    onclick="openSMSHistoryModal()"
                    class="flex-1 btn btn-ghost min-h-[44px] border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-100 transition-all"
                  >
                    📋 短信发送历史
                  </button>
                  <button
                    onclick="openVerificationCodesModal()"
                    class="flex-1 btn btn-ghost min-h-[44px] border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-100 transition-all"
                  >
                    🔑 验证码管理
                  </button>
                  <button
                    onclick="openSMSTestModal()"
                    class="flex-1 btn btn-ghost min-h-[44px] border-2 border-green-300 hover:border-green-400 hover:bg-green-50 transition-all"
                  >
                    🧪 测试发送
                  </button>
                </div>

                <div
                  id="sms-balance-display"
                  class="hidden mt-3 border-2 border-blue-300 bg-blue-50 rounded-lg p-3"
                >
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <span class="text-2xl">💵</span>
                      <span class="font-medium text-slate-700">当前余额</span>
                    </div>
                    <div class="flex items-center gap-1">
                      <span
                        id="sms-balance-value"
                        class="text-2xl font-bold text-blue-600"
                        >--</span
                      >
                      <span class="text-sm text-slate-600">条</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="admin-config-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-lg">⚙️ 系统配置</h4>
              <div class="flex gap-2">
                <button
                  id="admin-refresh-config_modal"
                  class="btn btn-ghost !py-1 !px-2"
                  onclick="loadSystemConfig()"
                >
                  刷新
                </button>
                <button
                  id="admin-save-config_modal"
                  class="btn btn-primary !py-1 !px-2"
                  onclick="saveSystemConfig()"
                >
                  保存配置
                </button>
              </div>
            </div>
            <p class="text-xs text-amber-700 bg-amber-50 p-2 rounded-md">
              ⚠️
              警告：修改这些配置可能会影响系统稳定性。保存后，部分配置需要**重启程序**才能生效。
            </p>

            <div
              id="admin-config-form"
              class="space-y-4 max-h-[50vh] overflow-y-auto pr-2"
            >
              <p class="text-slate-400 text-center py-10">加载中...</p>
            </div>
          </div>

          <div id="admin-captcha-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-lg">⚙️ 验证码生成设置</h4>
            </div>

            <div
              class="bg-sky-50 border border-sky-200 rounded-lg p-4 mb-4"
              style="display: none"
            >
              <p class="text-sm text-slate-600 mb-2">
                <strong>本地验证码生成器</strong
                >：使用MicroPixelCaptcha生成黑白像素风格验证码，无需第三方API，更稳定、更安全、响应更快。
              </p>
              <p class="text-xs text-slate-500">
                💡
                提示：修改参数后需刷新验证码才能看到效果。建议scale_factor使用2或3，noise_level保持在0.05-0.15之间。
              </p>
            </div>

            <div class="space-y-4">
              <div class="flex items-center gap-4">
                <label
                  for="captcha-length"
                  class="text-sm font-medium text-slate-700 w-32"
                >
                  验证码长度：
                </label>
                <input
                  type="number"
                  id="captcha-length"
                  min="3"
                  max="6"
                  step="1"
                  value="4"
                  class="px-3 py-2 border border-slate-300 rounded-md text-sm w-24 focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                />
                <span class="text-xs text-slate-500">字符数（3-6），推荐4</span>
              </div>

              <div class="flex items-center gap-4">
                <label
                  for="captcha-scale-factor"
                  class="text-sm font-medium text-slate-700 w-32"
                >
                  细分倍数：
                </label>
                <input
                  type="number"
                  id="captcha-scale-factor"
                  min="2"
                  max="4"
                  step="1"
                  value="2"
                  class="px-3 py-2 border border-slate-300 rounded-md text-sm w-24 focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                />
                <span class="text-xs text-slate-500"
                  >像素细分（2-4），推荐2或3</span
                >
              </div>

              <div class="flex items-center gap-4">
                <label
                  for="captcha-noise-level"
                  class="text-sm font-medium text-slate-700 w-32"
                >
                  噪点比例：
                </label>
                <input
                  type="number"
                  id="captcha-noise-level"
                  min="0"
                  max="0.3"
                  step="0.01"
                  value="0.08"
                  class="px-3 py-2 border border-slate-300 rounded-md text-sm w-24 focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                />
                <span class="text-xs text-slate-500"
                  >噪点密度（0.0-0.3），推荐0.05-0.15</span
                >
              </div>

              <div class="flex gap-2 mt-6">
                <button
                  id="save-captcha-settings-btn"
                  class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-sm font-medium transition-colors duration-200 shadow-sm"
                >
                  💾 保存设置
                </button>
                <button
                  id="test-captcha-btn"
                  class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 text-sm font-medium transition-colors duration-200"
                >
                  🔄 测试生成
                </button>
                <button
                  id="view-captcha-history-btn"
                  class="px-4 py-2 bg-purple-50 text-purple-700 border border-purple-200 rounded-md hover:bg-purple-100 text-sm font-medium transition-colors duration-200 ml-auto"
                >
                  📜 查看历史
                </button>
              </div>

              <div
                id="captcha-test-preview"
                class="hidden mt-4 p-4 border border-slate-300 rounded-lg bg-white"
              >
                <p class="text-sm font-medium text-slate-700 mb-2">
                  预览效果：
                </p>
                <div
                  id="captcha-preview-display"
                  class="flex justify-center my-3"
                ></div>
                <p class="text-xs text-slate-500 mt-2">
                  验证码答案：
                  <span
                    id="captcha-preview-answer"
                    class="font-mono font-bold text-slate-900"
                  ></span>
                </p>
              </div>
            </div>

            <div
              class="mt-6 p-4 bg-slate-50 border border-slate-200 rounded-lg"
            >
              <p class="text-sm text-slate-600 font-medium mb-2">
                📖 参数说明：
              </p>
              <ul
                class="text-xs text-slate-600 space-y-1 list-disc list-inside"
              >
                <li>
                  <strong>验证码长度</strong
                  >：生成的验证码字符数，推荐4个字符（平衡安全性和用户体验）
                </li>
                <li>
                  <strong>细分倍数</strong
                  >：控制像素密度，值越大验证码越精细，但文件也越大。推荐2或3
                </li>
                <li>
                  <strong>噪点比例</strong
                  >：添加随机噪点的比例，增加机器识别难度。0.08表示8%的像素会反转颜色
                </li>
              </ul>
              <p class="text-xs text-slate-500 mt-3">
                ⚠️
                注意：如果验证码太难识别，请降低noise_level或length；如果加载慢，请降低scale_factor。
              </p>
            </div>
          </div>

          <div id="admin-captcha-history-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <button
                  id="back-to-captcha-settings-btn"
                  class="p-1 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"
                  title="返回设置"
                >
                  <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 19l-7-7 7-7"
                    ></path>
                  </svg>
                </button>
                <h4 class="font-semibold text-lg">📜 验证码历史记录</h4>
              </div>
              <div class="flex gap-2 items-center">
                <input
                  type="date"
                  id="captcha-history-date"
                  class="px-3 py-1 border border-slate-300 rounded-md text-sm"
                  value=""
                />
                <select
                  id="captcha-history-status"
                  class="px-3 py-1 border border-slate-300 rounded-md text-sm"
                >
                  <option value="">全部状态</option>
                  <option value="created">待验证</option>
                  <option value="verified_success">验证成功</option>
                  <option value="verified_failed">验证失败</option>
                  <option value="expired">已过期</option>
                  <option value="test_generated">测试生成</option>
                </select>
                <button
                  id="admin-refresh-captcha_modal"
                  class="btn btn-ghost !py-1 !px-2"
                  onclick="loadCaptchaHistory()"
                >
                  刷新
                </button>
              </div>
            </div>

            <div
              id="admin-captcha-list_modal"
              class="space-y-2 max-h-[47vh] overflow-y-auto pr-2"
            >
              <p class="text-slate-400 text-center py-10">
                请选择日期并点击刷新按钮查看验证码历史
              </p>
            </div>

            <div
              id="captcha-stats"
              class="grid grid-cols-6 gap-2 text-center text-sm"
            >
              <div class="p-2 bg-slate-100 rounded">
                <div class="text-slate-600">总计</div>
                <div id="captcha-stat-total" class="text-lg font-semibold">
                  0
                </div>
              </div>
              <div class="p-2 bg-green-100 rounded">
                <div class="text-green-700">成功</div>
                <div
                  id="captcha-stat-success"
                  class="text-lg font-semibold text-green-700"
                >
                  0
                </div>
              </div>
              <div class="p-2 bg-red-100 rounded">
                <div class="text-red-700">失败</div>
                <div
                  id="captcha-stat-failed"
                  class="text-lg font-semibold text-red-700"
                >
                  0
                </div>
              </div>
              <div class="p-2 bg-yellow-100 rounded">
                <div class="text-yellow-700">待验证</div>
                <div
                  id="captcha-stat-pending"
                  class="text-lg font-semibold text-yellow-700"
                >
                  0
                </div>
              </div>
              <div class="p-2 bg-gray-100 rounded">
                <div class="text-gray-700">已过期</div>
                <div
                  id="captcha-stat-expired"
                  class="text-lg font-semibold text-gray-700"
                >
                  0
                </div>
              </div>
              <div class="p-2 bg-blue-100 rounded">
                <div class="text-blue-700">测试生成</div>
                <div
                  id="captcha-stat-test"
                  class="text-lg font-semibold text-blue-700"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <div id="admin-reminders-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-lg">⏰ 定时提醒管理</h4>
              <div class="flex gap-2">
                <button
                  id="admin-refresh-reminders_modal"
                  class="btn btn-ghost !py-1 !px-2"
                  onclick="loadReminders()"
                >
                  刷新
                </button>
                <button
                  id="admin-add-reminder_modal"
                  class="btn btn-primary !py-2 !px-4"
                  onclick="openReminderEditModal()"
                >
                  <svg
                    class="w-4 h-4 inline mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                  添加提醒
                </button>
              </div>
            </div>

            <p class="text-xs text-blue-700 bg-blue-50 p-3 rounded-md">
              💡 <strong>功能说明：</strong><br />
              • 定时提醒会在设定的时间范围内自动弹出提示<br />
              • 支持跨天时间设置（例如：20:00 到次日 08:00）<br />
              • 禁用的提醒不会显示，但数据会保留<br />
              • 用户打开页面或每分钟检查一次是否有提醒需要显示
            </p>

            <div
              id="admin-reminders-list_modal"
              class="space-y-2 max-h-[55vh] overflow-y-auto pr-2"
            >
              <p class="text-slate-400 text-center py-10">
                暂无提醒，点击"添加提醒"创建新提醒
              </p>
            </div>

            <div class="grid grid-cols-3 gap-2 text-center text-sm">
              <div class="p-2 bg-slate-100 rounded">
                <div class="text-slate-600">总计</div>
                <div id="reminder-stat-total" class="text-lg font-semibold">
                  0
                </div>
              </div>
              <div class="p-2 bg-green-100 rounded">
                <div class="text-green-700">启用</div>
                <div
                  id="reminder-stat-enabled"
                  class="text-lg font-semibold text-green-700"
                >
                  0
                </div>
              </div>
              <div class="p-2 bg-slate-100 rounded">
                <div class="text-slate-600">禁用</div>
                <div
                  id="reminder-stat-disabled"
                  class="text-lg font-semibold text-slate-600"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <div id="admin-ssl-panel_modal" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-lg">🔒 HTTPS/SSL 设置</h4>
              <div class="flex items-center gap-2"></div>
              <div
                id="ssl-status-badge"
                class="px-3 py-1 rounded-full text-sm font-semibold"
              ></div>
              <button
                id="ssl-refresh-btn"
                class="btn btn-ghost !py-1 !px-2"
                onclick="loadSSLInfo()"
              >
                刷新
              </button>
            </div>

            <div class="text-xs text-blue-700 bg-blue-50 p-3 rounded-md">
              💡 <strong>功能说明：</strong><br />
              • 启用HTTPS可以加密客户端与服务器之间的通信，提高安全性<br />
              • 需要上传有效的SSL证书（.pem格式）和私钥文件（.key格式）<br />
              • 修改配置后需要重启服务器才能生效<br />
              • "仅HTTPS"模式会自动将HTTP请求重定向到HTTPS
            </div>

            <div class="space-y-4">
              <div
                class="flex items-center justify-between p-4 bg-slate-50 rounded-lg"
              >
                <div>
                  <div class="font-semibold text-slate-700">启用 HTTPS</div>
                  <div class="text-xs text-slate-500">使用SSL/TLS加密连接</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    id="ssl-enabled-toggle"
                    class="sr-only peer"
                  />
                  <div
                    class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"
                  ></div>
                </label>
              </div>

              <div
                class="flex items-center justify-between p-4 bg-slate-50 rounded-lg"
              >
                <div>
                  <div class="font-semibold text-slate-700">仅 HTTPS 模式</div>
                  <div class="text-xs text-slate-500">
                    自动重定向HTTP请求到HTTPS
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    id="https-only-toggle"
                    class="sr-only peer"
                  />
                  <div
                    class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"
                  ></div>
                </label>
              </div>

              <div
                id="ssl-cert-info-container"
                class="p-4 bg-white border border-slate-200 rounded-lg"
              >
                <h5 class="font-semibold text-slate-700 mb-3">📄 证书信息</h5>
                <div id="ssl-cert-info-content" class="space-y-2 text-sm">
                  <p class="text-slate-400 text-center py-4">暂无证书信息</p>
                </div>
              </div>

              <div class="p-4 bg-white border border-slate-200 rounded-lg">
                <h5 class="font-semibold text-slate-700 mb-3">
                  📤 上传SSL证书
                </h5>

                <div class="mb-3">
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    证书文件 (.pem, .crt)
                  </label>
                  <input
                    type="file"
                    id="ssl-cert-file-input"
                    accept=".pem,.crt"
                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 cursor-pointer"
                  />
                </div>

                <div class="mb-3">
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    私钥文件 (.key, .pem)
                  </label>
                  <input
                    type="file"
                    id="ssl-key-file-input"
                    accept=".key,.pem"
                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 cursor-pointer"
                  />
                </div>

                <button
                  id="ssl-upload-btn"
                  class="btn btn-primary w-full !py-2"
                  onclick="uploadSSLCertificate()"
                >
                  <svg
                    class="w-4 h-4 inline mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                    ></path>
                  </svg>
                  上传证书
                </button>
              </div>

              <div class="flex gap-2">
                <button
                  id="ssl-save-config-btn"
                  class="btn btn-primary flex-1 !py-2"
                  onclick="saveSSLConfig()"
                >
                  <svg
                    class="w-4 h-4 inline mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                    ></path>
                  </svg>
                  保存配置
                </button>
              </div>

              <div
                class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800"
              >
                ⚠️
                <strong>重要提示：</strong>修改SSL配置后需要重启服务器才能生效。
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="reminder-edit-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1055]"
    >
      <div
        class="absolute inset-0 bg-black/70"
        onclick="closeReminderEditModal()"
      ></div>

      <div
        class="panel rounded-2xl p-6 w-[90%] max-w-2xl max-h-[85vh] space-y-4 relative overflow-y-auto"
      >
        <div class="flex items-center justify-between">
          <h3 id="reminder-modal-title" class="text-xl font-bold text-sky-600">
            ⏰ 添加定时提醒
          </h3>
          <button
            onclick="closeReminderEditModal()"
            class="text-slate-400 hover:text-slate-600 text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <div class="space-y-4">
          <input type="hidden" id="reminder-id-field" />

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              📌 提醒标题 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="reminder-title-field"
              class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
              placeholder="例如：学校服务器关闭提醒"
              maxlength="50"
            />
            <p class="text-xs text-slate-500 mt-1">最多50个字符</p>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              📝 提醒内容 <span class="text-red-500">*</span>
            </label>
            <textarea
              id="reminder-message-field"
              rows="4"
              class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
              placeholder="例如：学校服务器将于20:00关闭，请各位注意时间"
              maxlength="500"
            ></textarea>
            <p class="text-xs text-slate-500 mt-1">最多500个字符</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                ⏰ 开始时间 <span class="text-red-500">*</span>
              </label>
              <input
                type="time"
                id="reminder-start-time-field"
                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
              />
              <p class="text-xs text-slate-500 mt-1">24小时制（如 19:00）</p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                ⏰ 结束时间 <span class="text-red-500">*</span>
              </label>
              <input
                type="time"
                id="reminder-end-time-field"
                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
              />
              <p class="text-xs text-slate-500 mt-1">24小时制（如 20:00）</p>
            </div>
          </div>

          <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
            <p class="text-sm text-blue-700">
              💡 <strong>跨天时间说明：</strong><br />
              • 如果结束时间小于开始时间，系统会自动识别为跨天<br />
              • 例如：开始 20:00，结束 08:00 → 表示从晚上20:00到次日早上08:00<br />
              • 正常时间：开始 09:00，结束 17:00 → 表示当天09:00到17:00
            </p>
          </div>

          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              id="reminder-enabled-field"
              class="w-4 h-4 text-sky-600 rounded focus:ring-sky-500"
              checked
            />
            <label
              for="reminder-enabled-field"
              class="text-sm font-semibold text-slate-700"
            >
              ✅ 启用此提醒（取消勾选则暂时禁用，不会删除数据）
            </label>
          </div>
        </div>

        <div class="flex gap-3 border-t pt-4">
          <button
            onclick="closeReminderEditModal()"
            class="btn btn-ghost flex-1"
          >
            取消
          </button>
          <button onclick="saveReminder()" class="btn btn-primary flex-1">
            <svg
              class="w-4 h-4 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
            保存提醒
          </button>
        </div>
      </div>
    </div>

    <div
      id="sms-balance-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1055]"
    >
      <div
        class="absolute inset-0 bg-black/70"
        onclick="closeSMSBalanceModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[90%] max-w-md max-h-[85vh] space-y-4 relative overflow-hidden"
      >
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">💰 短信余额</h3>
          <button
            onclick="closeSMSBalanceModal()"
            class="text-slate-400 hover:text-slate-600 text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <div class="space-y-3">
          <div class="text-center">
            <span class="text-sm text-slate-500">剩余条数</span>
            <p
              id="sms-balance-modal-value"
              class="text-4xl font-bold text-sky-600"
            >
              --
            </p>
          </div>
          <div class="text-center mt-2">
            <span class="text-sm text-slate-500">今日已发送</span>
            <p
              id="sms-balance-modal-sent"
              class="text-2xl font-semibold text-slate-700"
            >
              --
            </p>
          </div>
          <div class="mt-4 text-center">
            <p
              id="sms-balance-modal-message"
              class="text-xs text-slate-500 bg-slate-50 p-2 rounded-md"
            >
              查询中...
            </p>
          </div>
        </div>

        <div class="flex justify-end border-t pt-4">
          <button
            onclick="closeSMSBalanceModal()"
            class="btn btn-primary w-full"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- ========== 短信发送历史 ========== -->
    <div
      id="sms-history-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/70"
        onclick="closeSMSHistoryModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[90%] max-w-5xl max-h-[85vh] space-y-4 relative overflow-hidden"
      >
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">📋 短信发送历史</h3>
          <button
            onclick="closeSMSHistoryModal()"
            class="text-slate-400 hover:text-slate-600 text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <div class="flex gap-2 items-center">
          <input
            type="date"
            id="sms-history-date-filter"
            class="input-field flex-1"
            placeholder="按日期过滤"
          />
          <input
            type="text"
            id="sms-history-phone-filter"
            class="input-field flex-1"
            placeholder="按手机号过滤"
          />
          <button
            onclick="loadSMSHistory()"
            class="btn btn-primary whitespace-nowrap"
          >
            🔄 刷新
          </button>
        </div>

        <div
          id="sms-history-list"
          class="space-y-2 max-h-[55vh] overflow-y-auto"
        >
          <p class="text-slate-400 text-center py-10">加载中...</p>
        </div>

        <div class="flex justify-end border-t pt-4">
          <button onclick="closeSMSHistoryModal()" class="btn btn-ghost">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- ========== 验证码管理 ========== -->
    <div
      id="verification-codes-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/70"
        onclick="closeVerificationCodesModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[90%] max-w-4xl max-h-[85vh] space-y-4 relative overflow-hidden"
      >
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">🔑 验证码状态管理</h3>
          <button
            onclick="closeVerificationCodesModal()"
            class="text-slate-400 hover:text-slate-600 text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
          <h5 class="font-semibold mb-3 text-green-900">➕ 手动添加验证码</h5>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+86 </span>
              <input
                type="tel"
                id="manual-code-phone"
                class="input-field"
                placeholder="手机号"
                pattern="[0-9]*"
                maxlength="11"
              />
            </div>

            <input
              type="text"
              id="manual-code-value"
              class="input-field"
              placeholder="验证码（6位数字）"
              maxlength="6"
              pattern="[0-9]{6}"
            />
            <button
              onclick="addManualVerificationCode()"
              class="btn btn-primary"
            >
              添加验证码
            </button>
          </div>
          <p class="text-xs text-slate-600 mt-2">
            💡 此功能用于测试或紧急情况下手动添加验证码，不会实际发送短信
          </p>
        </div>

        <div class="flex justify-end">
          <button onclick="loadVerificationCodes()" class="btn btn-ghost">
            🔄 刷新列表
          </button>
        </div>

        <div
          id="verification-codes-list"
          class="space-y-2 max-h-[45vh] overflow-y-auto"
        >
          <p class="text-slate-400 text-center py-10">加载中...</p>
        </div>

        <div class="flex justify-end border-t pt-4">
          <button onclick="closeVerificationCodesModal()" class="btn btn-ghost">
            关闭
          </button>
        </div>
      </div>
    </div>

    <div
      id="admin-modify-nickname-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1053]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeAdminModifyNicknameModal()"
      ></div>
      <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">修改用户昵称</h3>
          <button
            onclick="closeAdminModifyNicknameModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            &times;
          </button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700"
              >用户名</label
            >
            <input
              type="text"
              id="admin-modify-nickname-username"
              class="input-field mt-1"
              readonly
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700"
              >新昵称</label
            >
            <input
              type="text"
              id="admin-modify-nickname-new"
              class="input-field mt-1"
              placeholder="请输入新昵称 (可含中文)"
            />
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button
            onclick="closeAdminModifyNicknameModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="submitAdminModifyNickname()" class="btn btn-primary">
            确认修改
          </button>
        </div>
      </div>
    </div>

    <div
      id="admin-modify-phone-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1053]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeAdminModifyPhoneModal()"
      ></div>
      <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">修改用户手机号</h3>
          <button
            onclick="closeAdminModifyPhoneModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            &times;
          </button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700"
              >用户名</label
            >
            <input
              type="text"
              id="admin-modify-phone-username"
              class="input-field mt-1"
              readonly
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700"
              >当前手机号</label
            >
            <div class="phone-input-wrapper mt-1">
              <span class="phone-prefix">+86 </span>
              <input
                type="tel"
                id="admin-modify-phone-current"
                class="input-field"
                readonly
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700"
              >新手机号</label
            >
            <div class="phone-input-wrapper mt-1">
              <span class="phone-prefix">+86 </span>
              <input
                type="tel"
                id="admin-modify-phone-new"
                class="input-field"
                placeholder="请输入新手机号"
                inputmode="numeric"
                pattern="[0-9]*"
              />
            </div>
          </div>

          <div id="admin-modify-phone-sms-group">
            <label class="block text-sm font-semibold text-slate-700"
              >验证码（可选）</label
            >
            <div class="flex gap-2 mt-1">
              <input
                type="text"
                id="admin-modify-phone-code"
                class="input-field flex-1"
                placeholder="验证码"
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
              />
              <button
                onclick="sendAdminModifyPhoneCode()"
                id="admin-modify-phone-send-btn"
                class="btn btn-primary whitespace-nowrap"
              >
                发送验证码
              </button>
            </div>
            <p
              class="text-xs text-slate-500 mt-1"
              id="admin-modify-phone-sms-hint"
            >
              管理员修改手机号不强制要求验证码
            </p>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button
            onclick="closeAdminModifyPhoneModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="submitAdminModifyPhone()" class="btn btn-primary">
            确认修改
          </button>
        </div>
      </div>
    </div>

    <div
      id="user-logs-secondary-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1053]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeUserLogsSecondaryModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[50rem] max-h-[81vh] space-y-4 relative overflow-y-auto"
      >
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">用户日志查看</h3>
          <button
            onclick="closeUserLogsSecondaryModal()"
            class="text-slate-400 hover:text-slate-600 text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
          <p class="text-sm text-slate-700">
            当前查看用户:
            <span
              id="current-log-username-secondary"
              class="font-semibold text-sky-600"
              >N/A</span
            >
          </p>
        </div>

        <div class="flex border-b border-slate-200">
          <button
            id="log-tab-login-secondary"
            class="px-4 py-2 font-semibold text-sky-600 border-b-2 border-sky-600"
            onclick="switchUserLogTab('login')"
          >
            登录记录
          </button>
          <button
            id="log-tab-audit-secondary"
            class="px-4 py-2 font-semibold text-slate-400 border-b-2 border-transparent"
            onclick="switchUserLogTab('audit')"
          >
            操作记录
          </button>
        </div>

        <div
          id="log-login-content-secondary"
          class="space-y-2 max-h-[50vh] overflow-y-auto"
        >
          <p class="text-slate-400 text-center py-10">加载中...</p>
        </div>

        <div
          id="log-audit-content-secondary"
          class="hidden space-y-2 max-h-[50vh] overflow-y-auto"
        >
          <p class="text-slate-400 text-center py-10">加载中...</p>
        </div>

        <div class="flex justify-end">
          <button onclick="closeUserLogsSecondaryModal()" class="btn btn-ghost">
            关闭
          </button>
        </div>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[50000]"
    >
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="panel rounded-2xl p-6 w-11/12 md:w-96 space-y-6 relative">
        <h3
          id="confirm-modal-title"
          class="text-xl font-bold text-amber-600 text-center"
        >
          请确认
        </h3>
        <p
          id="confirm-modal-message"
          class="text-sm text-slate-600 text-center py-4"
        >
          你确定要执行此操作吗？
        </p>
        <div class="flex justify-end gap-3 pt-4">
          <button
            id="confirm-modal-cancel-btn"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button id="confirm-modal-ok-btn" class="btn btn-primary">
            确认
          </button>
        </div>
      </div>
    </div>

    <script>
      async function loadMobileSessionPickerList() {
        const listEl = $("mobile-session-picker-list");
        if (!listEl) {
          logMessage_Error(
            "loadMobileSessionPickerList: 无法找到 'mobile-session-picker-list' 容器。"
          );
          return;
        }

        listEl.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const headers = { "X-Session-ID": sessionUUID || null };
          const response = await fetch("/auth/user/sessions", {
            headers: headers,
          });
          const result = await response.json();

          if (!result.success) {
            listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }

          const sessions = result.sessions || [];

          currentSessionInfo.maxSessions = result.max_sessions || 1;
          const validSessions = sessions.filter(
            (session) =>
              session.session_id &&
              session.session_id !== "null" &&
              session.session_id.trim() !== ""
          );
          currentSessionInfo.currentCount = validSessions.length;

          const countEl = $("mobile-session-picker-count-display");
          if (countEl) {
            const { currentCount, maxSessions } = currentSessionInfo;
            if (maxSessions === -1) {
              countEl.innerHTML = `<span class="text-green-600">会话数: ${currentCount} / 无限制</span>`;
            } else {
              const colorClass =
                currentCount >= maxSessions ? "text-red-600" : "text-slate-600";
              countEl.innerHTML = `<span class="${colorClass}">会话数: ${currentCount} / ${maxSessions}</span>`;
            }
          }

          if (validSessions.length === 0) {
            listEl.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无会话，请创建新会话</p>';
            return;
          }

          listEl.innerHTML = validSessions
            .map((session) => {
              const createdDate = session.created_at
                ? new Date(session.created_at * 1000).toLocaleString()
                : "未知";
              const isCurrent =
                session.is_current || session.session_id === sessionUUID;
              const sessionHash =
                session.session_hash || session.session_id.substring(0, 16);

              const is_multi_mode = session.is_multi_account_mode;
              const session_login_success = session.login_success;

              let statusStyles = "";
              let statusText = "";

              if (is_multi_mode) {
                statusStyles = session_login_success
                  ? "bg-purple-100 text-purple-700"
                  : "bg-gray-100 text-gray-700";
                statusText = session_login_success ? "✓ 已登录" : "○ 未登录";
              } else {
                statusStyles = session_login_success
                  ? "bg-green-100 text-green-700"
                  : "bg-gray-100 text-gray-700";
                statusText = session_login_success ? "✓ 已登录" : "○ 未登录";
              }

              return `
            <div class="mobile-list-item justify-between ${
              isCurrent ? "border-2 border-sky-500 bg-sky-50" : "bg-white"
            }" 
                 ${
                   !isCurrent
                     ? `onclick="selectSessionFromPicker('${session.session_id}')" style="cursor: pointer;"`
                     : 'style="cursor: default;"'
                 }
                 title="${!isCurrent ? "点击进入此会话" : "这是当前会话"}">
              
              <div class="flex-1 min-w-0 pr-3">
                <div class="flex items-center">
                  <p class="font-semibold text-slate-800 truncate" title="${
                    session.session_id
                  }">会话 ${sessionHash}...</p>
                  ${
                    isCurrent
                      ? '<span class="text-xs text-sky-600 ml-2 px-2 py-0.5 bg-sky-100 rounded-full flex-shrink-0">(当前)</span>'
                      : ""
                  }
                </div>
                <p class="text-xs text-slate-500 mt-1">${createdDate}</p>
                <p class="text-xs mt-2">
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${statusStyles}">
                    ${statusText}
                  </span>
                </p>
              </div>
              
              <div class="flex-shrink-0 flex items-center justify-center pl-2">
                ${
                  !isCurrent
                    ? `
                  <button class="btn btn-ghost !text-red-500 !py-3 !px-4 !rounded-lg" 
                          onclick="event.stopPropagation(); deleteSessionFromPicker('${session.session_id}');"
                          title="删除此会话">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                `
                    : `
                  <div class="px-4" title="这是当前会话">
                    <svg class="w-6 h-6 text-sky-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                  </div>
                `
                }
              </div>
            </div>
          `;
            })
            .join("");
        } catch (e) {
          logMessage_Error("加载会话列表失败:", e);
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      function showMobileSessionPicker() {
        const modal = $("mobile-session-picker-modal");
        if (!modal) {
          console.error("Mobile session picker modal DOM not found!");
          return;
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.classList.add("show");
        document.body.classList.add("modal-visible");

        loadMobileSessionPickerList();
      }

      function closeMobileSessionPicker() {
        const modal = $("mobile-session-picker-modal");
        if (!modal) return;

        modal.classList.remove("show");

        setTimeout(() => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }, 300);

        document.body.classList.remove("modal-visible");
      }

      function refreshMobileSessionPicker() {
        loadMobileSessionPickerList();
      }
    </script>

    <div
      id="session-picker-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1052]"
    >
      <div class="absolute inset-0 bg-black/60"></div>
      <div
        class="panel rounded-2xl p-6 w-[40rem] max-h-[70vh] space-y-4 relative"
      >
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-sky-600">会话管理</h3>
          <div id="session-count-display" class="text-sm text-slate-600"></div>
        </div>

        <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
          <p class="text-sm text-slate-700 mb-2">选择现有会话或创建新会话</p>
          <button
            class="btn btn-primary w-full"
            onclick="createNewSessionFromPicker()"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              ></path>
            </svg>
            创建新会话
          </button>
        </div>

        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold text-slate-700">现有会话</h4>
            <button
              class="btn btn-ghost !py-1 !px-2"
              onclick="refreshSessionPicker()"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
              </svg>
              刷新
            </button>
          </div>
          <div
            id="session-picker-list"
            class="max-h-[40vh] overflow-y-auto space-y-2"
          >
            <p class="text-slate-400 text-center py-10">加载中...</p>
          </div>
        </div>

        <div class="border-t pt-3 text-xs text-slate-500 relative">
          <p>
            💡
            提示：每个会话都是独立的学校账号登录状态。您可以创建多个会话来管理不同的账号。
          </p>
        </div>
      </div>
    </div>

    <div
      id="sms-test-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeSMSTestModal()"
      ></div>
      <div class="panel rounded-2xl p-6 w-[35rem] space-y-4 relative">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-green-600">🧪 短信测试发送</h3>
          <button
            onclick="closeSMSTestModal()"
            class="text-slate-400 hover:text-slate-600 transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-sm text-blue-800">
            <strong>💡 功能说明：</strong><br />
            • 此功能用于测试短信配置是否正确<br />
            • 可以发送随机验证码，或指定特定的验证码进行测试<br />
            • 验证码将同时显示在界面上，便于您验证短信是否收到<br />
            • 测试记录会保存在短信发送历史中
          </p>
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-semibold text-slate-700">
            <span class="inline-flex items-center gap-1"> 📱 目标手机号 </span>
          </label>
          <input
            type="tel"
            id="sms-test-phone"
            class="w-full border-2 border-green-200 rounded-lg px-4 py-3 focus:border-green-400 focus:ring-2 focus:ring-green-200 transition-all text-lg"
            placeholder="请输入要测试的手机号（11位）"
            maxlength="11"
            inputmode="numeric"
          />
          <p class="text-xs text-slate-500">
            ⚠️ 请输入真实有效的手机号，确保能收到短信
          </p>
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-semibold text-slate-700">
            <span class="inline-flex items-center gap-1">
              🔢 验证码（可选）
            </span>
          </label>
          <input
            type="text"
            id="sms-test-code-input"
            class="w-full border-2 border-blue-200 rounded-lg px-4 py-3 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all text-lg font-mono"
            placeholder="留空则自动生成随机验证码"
            maxlength="8"
            inputmode="numeric"
          />
          <p class="text-xs text-slate-500">
            💡 可输入4-8位数字作为测试验证码，留空则自动生成6位随机验证码
          </p>
        </div>

        <div id="sms-test-result" class="hidden">
          <div
            class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4"
          >
            <div class="flex items-start gap-3">
              <div class="text-3xl">✅</div>
              <div class="flex-1">
                <div class="font-semibold text-green-800 mb-2">
                  测试短信发送成功！
                </div>
                <div class="space-y-1 text-sm text-slate-700">
                  <div class="flex items-center gap-2">
                    <span class="font-medium">验证码：</span>
                    <span
                      id="sms-test-code"
                      class="font-mono text-2xl font-bold text-green-600"
                      >------</span
                    >
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-medium">手机号：</span>
                    <span id="sms-test-phone-display" class="font-mono"
                      >-----------</span
                    >
                  </div>
                </div>
                <div
                  class="mt-3 text-xs text-slate-600 bg-white/50 p-2 rounded"
                >
                  💡
                  请检查手机是否收到包含上述验证码的短信。如果收到，说明短信配置正确。
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-3 pt-3 border-t">
          <button
            onclick="closeSMSTestModal()"
            class="flex-1 btn btn-ghost min-h-[44px]"
          >
            取消
          </button>
          <button
            id="btn-send-test-sms"
            onclick="sendTestSMS()"
            class="flex-1 btn btn-success min-h-[44px]"
          >
            <svg
              class="w-5 h-5 inline mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              ></path>
            </svg>
            发送测试短信
          </button>
        </div>

        <div class="text-xs text-slate-500 text-center pt-2 border-t">
          测试记录会自动保存到"短信发送历史"中，场景标记为"admin_test"
        </div>
      </div>
    </div>

    <div
      id="captcha-detail-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeCaptchaDetailModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[40rem] max-h-[80vh] overflow-y-auto space-y-4 relative"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-blue-600">🔍 验证码详细信息</h3>
          <button
            onclick="closeCaptchaDetailModal()"
            class="text-slate-400 hover:text-slate-600 transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div id="captcha-detail-content" class="space-y-4">
          <div
            class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg p-4"
          >
            <h4
              class="font-semibold text-blue-900 mb-3 flex items-center gap-2"
            >
              <span class="text-xl">📋</span>
              基本信息
            </h4>
            <div class="space-y-2 text-sm">
              <div class="flex">
                <span class="text-slate-600 w-24">验证码ID:</span>
                <span
                  id="detail-captcha-id"
                  class="font-mono text-slate-800 flex-1 break-all"
                  >-</span
                >
              </div>
              <div class="flex">
                <span class="text-slate-600 w-24">验证码:</span>
                <span
                  id="detail-code"
                  class="font-mono text-2xl font-bold text-blue-600"
                  >-</span
                >
              </div>
              <div class="flex">
                <span class="text-slate-600 w-24">状态:</span>
                <span id="detail-status" class="px-2 py-1 text-xs rounded"
                  >-</span
                >
              </div>
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4"
          >
            <h4
              class="font-semibold text-green-900 mb-3 flex items-center gap-2"
            >
              <span class="text-xl">⏰</span>
              时间信息
            </h4>
            <div class="space-y-2 text-sm">
              <div class="flex">
                <span class="text-slate-600 w-24">创建时间:</span>
                <span id="detail-created-time" class="text-slate-800">-</span>
              </div>
              <div id="detail-verified-time-container" class="flex hidden">
                <span class="text-slate-600 w-24">验证时间:</span>
                <span id="detail-verified-time" class="text-slate-800">-</span>
              </div>
              <div id="detail-expired-time-container" class="flex hidden">
                <span class="text-slate-600 w-24">过期时间:</span>
                <span id="detail-expired-time" class="text-slate-800">-</span>
              </div>
            </div>
          </div>

          <div
            id="detail-verification-card"
            class="hidden bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4"
          >
            <h4
              class="font-semibold text-purple-900 mb-3 flex items-center gap-2"
            >
              <span class="text-xl">✅</span>
              验证信息
            </h4>
            <div class="space-y-2 text-sm">
              <div class="flex">
                <span class="text-slate-600 w-24">用户输入:</span>
                <span id="detail-user-input" class="font-mono font-bold"
                  >-</span
                >
              </div>
              <div class="flex">
                <span class="text-slate-600 w-24">验证结果:</span>
                <span id="detail-verification-result">-</span>
              </div>
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 rounded-lg p-4"
          >
            <h4
              class="font-semibold text-orange-900 mb-3 flex items-center gap-2"
            >
              <span class="text-xl">🌐</span>
              客户端信息
            </h4>
            <div class="space-y-2 text-sm">
              <div class="flex">
                <span class="text-slate-600 w-24">IP地址:</span>
                <span id="detail-client-ip" class="font-mono text-slate-800"
                  >-</span
                >
              </div>
              <div class="flex flex-col">
                <span class="text-slate-600 mb-1">User Agent:</span>
                <span
                  id="detail-user-agent"
                  class="text-xs text-slate-600 font-mono bg-white p-2 rounded break-all"
                  >-</span
                >
              </div>
            </div>
          </div>

          <div
            id="detail-captcha-image-card"
            class="hidden bg-gradient-to-br from-slate-50 to-gray-50 border-2 border-slate-200 rounded-lg p-4"
          >
            <h4
              class="font-semibold text-slate-900 mb-3 flex items-center gap-2"
            >
              <span class="text-xl">🖼️</span>
              验证码图片
            </h4>
            <div
              id="detail-captcha-html"
              class="flex items-center justify-center bg-white p-4 rounded-lg border border-slate-200"
            ></div>
          </div>
        </div>

        <div class="pt-4 border-t">
          <button
            onclick="closeCaptchaDetailModal()"
            class="w-full btn btn-ghost min-h-[44px]"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <div
      id="create-group-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeCreateGroupModal()"
      ></div>
      <div class="panel rounded-2xl p-6 w-[50rem] space-y-4 relative">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-sky-600">创建权限组</h3>
          <button
            onclick="closeCreateGroupModal()"
            class="btn btn-ghost !py-1 !px-3"
          >
            关闭
          </button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1"
              >权限组键名</label
            >
            <input
              type="text"
              id="new-group-key"
              class="input-field w-full"
              placeholder="例如: custom_group"
            />
            <p class="text-xs text-slate-500 mt-1">
              英文字母、数字、下划线，用于内部标识
            </p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1"
              >权限组名称</label
            >
            <input
              type="text"
              id="new-group-name"
              class="input-field w-full"
              placeholder="例如: 自定义权限组"
            />
            <p class="text-xs text-slate-500 mt-1">显示名称，用于界面展示</p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >权限设置</label
            >
            <div
              id="create-group-permissions"
              class="grid grid-cols-2 gap-2 max-h-[40vh] overflow-y-auto border border-slate-200 rounded-lg p-3"
            ></div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="closeCreateGroupModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="submitCreateGroup()" class="btn btn-primary">
            创建
          </button>
        </div>
      </div>
    </div>

    <div
      id="edit-group-permissions-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeEditGroupPermissionsModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-sky-600">
            编辑权限组: <span id="edit-group-name"></span>
          </h3>
          <button
            onclick="closeEditGroupPermissionsModal()"
            class="btn btn-ghost !py-1 !px-3"
          >
            关闭
          </button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >权限设置</label
            >
            <div
              id="edit-group-permissions-list"
              class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto border border-slate-200 rounded-lg p-3"
            ></div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="closeEditGroupPermissionsModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button
            onclick="submitEditGroupPermissions()"
            class="btn btn-primary"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <div
      id="manage-user-permissions-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeManageUserPermissionsModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-sky-600">
            管理用户权限: <span id="manage-user-name"></span>
          </h3>
          <button
            onclick="closeManageUserPermissionsModal()"
            class="btn btn-ghost !py-1 !px-3"
          >
            关闭
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <p class="text-sm text-blue-700">
            <strong>权限组:</strong>
            <span id="user-base-group" class="font-mono"></span>
          </p>
          <p class="text-xs text-slate-600 mt-1">
            💡
            以下为用户相对于权限组的差分化权限。绿色表示额外添加的权限，红色表示移除的权限。
          </p>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >权限调整</label
            >
            <div
              id="manage-user-permissions-list"
              class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto border border-slate-200 rounded-lg p-3"
            ></div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="closeManageUserPermissionsModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button
            onclick="submitManageUserPermissions()"
            class="btn btn-primary"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <div
      id="manage-school-accounts-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeManageSchoolAccountsModal()"
      ></div>

      <div
        class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-sky-600">
            管理学校账户:
            <span id="school-accounts-username" class="text-slate-700"></span>
          </h3>
          <button
            onclick="closeManageSchoolAccountsModal()"
            class="btn btn-ghost !py-1 !px-3"
          >
            关闭
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-blue-700">
                <strong>账户总数:</strong>
                <span id="school-accounts-count" class="font-mono">0</span>
              </p>
              <p class="text-xs text-slate-600 mt-1">
                💡 您可以查看、编辑或删除此用户的学校账户信息
              </p>
            </div>
            <button
              onclick="addNewSchoolAccount()"
              class="btn btn-primary !py-2 !px-4 !text-sm flex items-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                />
              </svg>
              新增账户
            </button>
          </div>
        </div>

        <div
          id="school-accounts-list"
          class="space-y-3 max-h-[50vh] overflow-y-auto"
        ></div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="closeManageSchoolAccountsModal()"
            class="btn btn-ghost border border-slate-300"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <div
      id="edit-school-account-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1055]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="closeEditSchoolAccountModal()"
      ></div>

      <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
        <h3 class="text-xl font-bold text-amber-600">编辑学校账户</h3>

        <div class="space-y-2">
          <p class="text-sm text-slate-600">
            认证用户:
            <span
              id="edit-auth-username"
              class="font-semibold text-slate-800"
            ></span>
          </p>
          <p class="text-sm text-slate-600">
            学校账户:
            <span
              id="edit-school-username"
              class="font-semibold text-slate-800"
            ></span>
          </p>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1"
              >密码</label
            >
            <input
              type="text"
              id="edit-school-password"
              class="input-field"
              placeholder="输入新密码"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1"
              >User-Agent（可选）</label
            >
            <textarea
              id="edit-school-ua"
              class="input-field"
              rows="3"
              placeholder="输入User-Agent（可选）"
            ></textarea>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="closeEditSchoolAccountModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="submitEditSchoolAccount()" class="btn btn-primary">
            保存
          </button>
        </div>
      </div>
    </div>

    <div
      id="set-max-sessions-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="hideModal('set-max-sessions-modal')"
      ></div>
      <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
        <h3 class="text-xl font-bold text-sky-600">设置会话限制</h3>

        <div class="space-y-2">
          <p class="text-sm text-slate-600">
            用户:
            <span
              id="sessions-username"
              class="font-semibold text-slate-800"
            ></span>
          </p>
          <p class="text-sm text-slate-600">
            当前限制:
            <span
              id="sessions-current-max"
              class="font-semibold text-slate-800"
            ></span>
          </p>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1"
            >新会话限制</label
          >
          <input
            type="number"
            id="new-max-sessions"
            min="0"
            class="input-field"
            placeholder="输入会话数量"
          />
          <p class="text-xs text-slate-500 mt-1">0 = 无限制</p>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="hideModal('set-max-sessions-modal')"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="submitSetMaxSessions()" class="btn btn-primary">
            确认
          </button>
        </div>
      </div>
    </div>

    <div
      id="reset-user-password-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1054]"
    >
      <div
        class="absolute inset-0 bg-black/60"
        onclick="hideModal('reset-user-password-modal')"
      ></div>
      <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
        <h3 class="text-xl font-bold text-amber-600">重置用户密码</h3>

        <div>
          <p class="text-sm text-slate-600">
            目标用户:
            <span
              id="reset-password-username"
              class="font-semibold text-slate-800"
            ></span>
          </p>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1"
              >新密码</label
            >
            <input
              type="password"
              id="reset-new-password"
              class="input-field"
              placeholder="输入新密码"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1"
              >确认密码</label
            >
            <input
              type="password"
              id="reset-confirm-password"
              class="input-field"
              placeholder="再次输入新密码"
            />
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button
            onclick="hideModal('reset-user-password-modal')"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="submitResetUserPassword()" class="btn btn-primary">
            重置密码
          </button>
        </div>
      </div>
    </div>

    <div
      id="avatar-crop-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-[1055]"
    >
      <div
        class="absolute inset-0 bg-black/80"
        onclick="closeCropModal()"
      ></div>
      <div
        class="panel rounded-2xl p-6 max-w-2xl w-full mx-4 space-y-4 relative"
      >
        <h3 class="text-xl font-bold text-sky-600">裁剪头像</h3>

        <div class="max-h-96 overflow-hidden bg-slate-100 rounded-lg">
          <img
            id="crop-image"
            src=""
            alt="待裁剪图片"
            style="max-width: 100%"
          />
        </div>

        <div class="flex gap-2 justify-end">
          <button
            onclick="closeCropModal()"
            class="btn btn-ghost border border-slate-300"
          >
            取消
          </button>
          <button onclick="confirmCropAndUpload()" class="btn btn-primary">
            确认并上传
          </button>
        </div>
      </div>
    </div>

    <script>
      // ==============================================================================
      // JavaScript代码部分
      // ==============================================================================

      let refreshUserListInterval = null;
      let isInNetworkErrorState = false;
      let cdnErrorCount = 0;
      let cdnErrorTimer = null;
      let appInitialized = false;

      let currentUserIsGuest = false;
      let currentAuthUsername = null;
      let healthAutoRefreshInterval = null;
      let multiAccountAutoRefreshInterval = null;
      let avatarCropper = null;
      let isRegistrationCrop = false;
      let registrationCroppedAvatarBlob = null;
      let currentLogPage = 1;
      let croppedAvatarFile = null;

      let currentSessionInfo = {
        maxSessions: 1,
        currentCount: 0,
      };

      // ============================================================
      // 移动端设备检测与UI容器切换功能
      // ============================================================

      let isMobileMode = false;

      function detectMobileDevice() {
        const userAgent =
          navigator.userAgent || navigator.vendor || window.opera;
        const mobileRegex =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i;
        const isMobile = mobileRegex.test(userAgent);

        console.log("[移动端检测] User-Agent:", userAgent);
        console.log(
          "[移动端检测] 最终判定:",
          isMobile ? "移动设备" : "桌面设备"
        );

        return isMobile;
      }

      function switchUIContainer() {
        const mobileContainer = document.getElementById("mobile-container");
        const desktopContainer = document.getElementById("desktop-container");

        if (!mobileContainer || !desktopContainer) {
          console.warn("[UI切换] 警告：移动端或桌面端容器未找到");
          return;
        }

        const isMobile = detectMobileDevice();
        isMobileMode = isMobile;

        if (isMobile) {
          console.log("[UI切换] 切换到移动端模式");

          const desktopLoginVisible =
            !$("login-container").classList.contains("hidden");
          const desktopAuthVisible = !$(
            "auth-login-container"
          ).classList.contains("hidden");
          const desktopMainAppVisible =
            !$("main-app").classList.contains("hidden");
          const desktopMultiAccountVisible =
            !$("multi-account-app").classList.contains("hidden");

          mobileContainer.style.display = "block";
          desktopContainer.style.setProperty("display", "none", "important");

          const desktopElements = [
            "auth-login-container",
            "login-container",
            "main-app",
            "multi-account-app",
          ];
          desktopElements.forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              el.style.setProperty("display", "none", "important");
              el.style.setProperty("visibility", "hidden", "important");
              el.style.setProperty("pointer-events", "none", "important");
            }
          });

          $("mobile-login-container").classList.add("hidden");
          $("mobile-auth-login-container").classList.add("hidden");
          $("mobile-main-app").classList.add("hidden");
          $("mobile-multi-account-app").classList.add("hidden");

          if (desktopMainAppVisible) {
            if (typeof destroyMobileMultiMap === "function") {
              destroyMobileMultiMap();
              console.log("[UI切换] 已销毁多账号地图（切换到单账号模式）");
            }

            const mobileLoadingOverlay = document.getElementById(
              "mobile-loading-overlay"
            );
            if (mobileLoadingOverlay) {
              mobileLoadingOverlay.classList.remove("hidden");
            }

            $("mobile-main-app").classList.remove("hidden");
            updateMobileNavVisibility(true, "single");
            console.log("[UI切换] PC端main-app可见，显示移动端mobile-main-app");
            switchMobileSinglePanel("mobile-control-panel");
            console.log("[UI切换] 已默认激活mobile-control-panel");

            setTimeout(() => {
              if (mobileLoadingOverlay) {
                mobileLoadingOverlay.classList.add("hidden");
              }
            }, 500);
          } else if (desktopMultiAccountVisible) {
            if (typeof destroyMobileSingleMap === "function") {
              destroyMobileSingleMap();
              console.log("[UI切换] 已销毁单账号地图（切换到多账号模式）");
            }

            $("mobile-multi-account-app").classList.remove("hidden");
            updateMobileNavVisibility(true, "multi");
            console.log(
              "[UI切换] PC端multi-account-app可见，显示移动端mobile-multi-account-app"
            );
            switchMobilePanel("mobile-multi-control-panel", "multi");
            console.log("[UI切换] 已默认激活mobile-multi-control-panel");
          } else if (desktopLoginVisible) {
            $("mobile-login-container").classList.remove("hidden");
            updateMobileNavVisibility(false);
            console.log(
              "[UI切换] PC端login-container可见，显示移动端mobile-login-container"
            );
          } else if (desktopAuthVisible) {
            $("mobile-auth-login-container").classList.remove("hidden");
            updateMobileNavVisibility(false);
            console.log(
              "[UI切换] PC端auth-login-container可见，显示移动端mobile-auth-login-container"
            );
          }

          const modalElements = ["admin-panel-modal", "session-picker-modal"];
          modalElements.forEach((id) => {
            const el = document.getElementById(id);
            if (el && !el.classList.contains("hidden")) {
              el.classList.add("hidden");
            }
          });

          document.body.classList.add("mobile-mode");

          initializeMobileUI();
        } else {
          console.log("[UI切换] 切换到桌面端模式");

          const mobileLoginVisible = !$(
            "mobile-login-container"
          ).classList.contains("hidden");
          const mobileAuthVisible = !$(
            "mobile-auth-login-container"
          ).classList.contains("hidden");
          const mobileMainAppVisible =
            !$("mobile-main-app").classList.contains("hidden");
          const mobileMultiAccountVisible = !$(
            "mobile-multi-account-app"
          ).classList.contains("hidden");

          mobileContainer.style.display = "none";
          desktopContainer.style.display = "block";

          document.body.classList.remove("mobile-mode");

          const desktopElements = [
            "auth-login-container",
            "login-container",
            "main-app",
            "multi-account-app",
          ];
          desktopElements.forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              el.style.removeProperty("display");
              el.style.removeProperty("visibility");
              el.style.removeProperty("pointer-events");
            }
          });

          $("login-container").classList.add("hidden");
          $("auth-login-container").classList.add("hidden");
          $("main-app").classList.add("hidden");
          $("multi-account-app").classList.add("hidden");

          if (mobileMainAppVisible) {
            $("main-app").classList.remove("hidden");
            $("main-app").classList.add("grid");
            console.log("[UI切换] 移动端mobile-main-app可见，显示PC端main-app");
          } else if (mobileMultiAccountVisible) {
            $("multi-account-app").classList.remove("hidden");
            $("multi-account-app").classList.add("grid");
            console.log(
              "[UI切换] 移动端mobile-multi-account-app可见，显示PC端multi-account-app"
            );
          } else if (mobileLoginVisible) {
            $("login-container").classList.remove("hidden");
            console.log(
              "[UI切换] 移动端mobile-login-container可见，显示PC端login-container"
            );
          } else if (mobileAuthVisible) {
            $("auth-login-container").classList.remove("hidden");
            console.log(
              "[UI切换] 移动端mobile-auth-login-container可见，显示PC端auth-login-container"
            );
          }
        }
      }

      async function saveMobileAttendanceParams() {
        const enabledInput = document.getElementById(
          "mobile-param-auto_attendance_enabled"
        );
        const refreshInput = document.getElementById(
          "mobile-param-auto_attendance_refresh_s"
        );
        const radiusInput = document.getElementById(
          "mobile-param-attendance_user_radius_m"
        );

        if (!enabledInput || !refreshInput || !radiusInput) {
          showTempMessage("无法获取参数输入框", "error");
          return;
        }

        const enabled = enabledInput.checked;
        const refresh = parseInt(refreshInput.value);
        const radius = parseInt(radiusInput.value);

        if (isNaN(refresh) || refresh < 15) {
          showTempMessage("刷新间隔不能小于15秒", "error");
          return;
        }

        try {
          await callPythonAPI(
            "update_param",
            "auto_attendance_enabled",
            enabled
          );
          await callPythonAPI(
            "update_param",
            "auto_attendance_refresh_s",
            refresh
          );
          await callPythonAPI(
            "update_param",
            "attendance_user_radius_m",
            radius
          );

          if (typeof pythonParams !== "undefined") {
            pythonParams["auto_attendance_enabled"] = enabled;
            pythonParams["auto_attendance_refresh_s"] = refresh;
            pythonParams["attendance_user_radius_m"] = radius;
          }

          showTempMessage("自动签到配置已保存", "success");

          if (enabled) {
          }
        } catch (e) {
          console.error("保存签到配置失败:", e);
          showTempMessage("保存失败: " + e.message, "error");
        }
      }

      function isSessionUUIDInvalid(uuid) {
        return !uuid || uuid.trim() === "" || uuid === "null";
      }

      function run_code_need_sessionuuid(codeToRun) {
        let isInvalid = isSessionUUIDInvalid(sessionUUID);

        if (isInvalid) {
          logMessage_Warning("sessionUUID 为空，尝试从 URL 中提取");
          sessionUUID = getUUIDFromURL();

          isInvalid = isSessionUUIDInvalid(sessionUUID);

          if (!isInvalid) {
            logMessage_Info("成功从 URL 中提取 sessionUUID: " + sessionUUID);
          }
        }

        if (isInvalid) {
          logMessage_Error("未找到有效的 sessionUUID，所需操作无法执行");
        } else {
          codeToRun();
        }
      }

      function run_code_not_need_sessionuuid(codeToRun) {
        let isInvalid = isSessionUUIDInvalid(sessionUUID);

        if (isInvalid) {
          logMessage_Warning("sessionUUID 为空，尝试从 URL 中提取");
          sessionUUID = getUUIDFromURL();

          isInvalid = isSessionUUIDInvalid(sessionUUID);

          if (!isInvalid) {
            logMessage_Success("成功从 URL 中提取 sessionUUID: " + sessionUUID);
          }
        }

        if (isInvalid) {
          logMessage_Error("未找到有效的 sessionUUID，所需操作无法执行");
          codeToRun();
        }
      }

      function initializeMobileUI() {
        console.log("[移动端UI] 初始化移动端UI功能 (重构版)");
        const loadingOverlayEl = document.getElementById("loading-overlay");
        if (loadingOverlayEl) loadingOverlayEl.classList.remove("hidden");

        function showMobileAuthForm(formToShow) {
          const loginTab = document.getElementById("mobile-auth-tab-login");
          const registerTab = document.getElementById(
            "mobile-auth-tab-register"
          );
          const loginForm = document.getElementById("mobile-login-form");
          const registerForm = document.getElementById("mobile-register-form");
          const tfaForm = document.getElementById("mobile-auth-2fa-form");

          if (loginForm) loginForm.classList.add("hidden");
          if (registerForm) registerForm.classList.add("hidden");
          if (tfaForm) tfaForm.classList.add("hidden");

          if (formToShow === "register") {
            if (registerForm) registerForm.classList.remove("hidden");
            if (loginTab)
              loginTab.className =
                "flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition";
            if (registerTab)
              registerTab.className =
                "flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition";

            loadCaptcha("register");
          } else {
            if (loginForm) loginForm.classList.remove("hidden");
            if (loginTab)
              loginTab.className =
                "flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition";
            if (registerTab)
              registerTab.className =
                "flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition";

            loadCaptcha("login");
          }

          showMobileMessage("", "clear");
        }

        const loginTabBtn = document.getElementById("mobile-auth-tab-login");
        const registerTabBtn = document.getElementById(
          "mobile-auth-tab-register"
        );
        if (loginTabBtn)
          loginTabBtn.addEventListener("click", () =>
            showMobileAuthForm("login")
          );
        if (registerTabBtn)
          registerTabBtn.addEventListener("click", () =>
            showMobileAuthForm("register")
          );

        const mobileUsernameBtn = document.getElementById(
          "mobile-login-username-btn"
        );
        const mobilePhoneBtn = document.getElementById(
          "mobile-login-phone-btn"
        );
        const mobileAuthInputContainer = document.getElementById(
          "mobile-username-container"
        );
        const mobileAuthLabel = document.getElementById("mobile-login-label");
        const mobileSwitchToSms = document.getElementById(
          "mobile-switch-to-sms"
        );

        if (
          mobileUsernameBtn &&
          mobilePhoneBtn &&
          mobileAuthInputContainer &&
          mobileAuthLabel &&
          mobileSwitchToSms
        ) {
          mobileUsernameBtn.addEventListener("click", function () {
            mobileUsernameBtn.className =
              "px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm";
            mobilePhoneBtn.className =
              "px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm";

            const currentValue =
              mobileAuthInputContainer.querySelector("input").value;
            mobileAuthLabel.textContent = "用户名";
            mobileAuthInputContainer.innerHTML = `
            <input type="text" id="mobile-auth-username" class="w-full" placeholder="请输入用户名" autocomplete="username" value="${
              currentValue || ""
            }">
          `;
            mobileSwitchToSms.classList.add("hidden");
            document
              .getElementById("mobile-password-section")
              .classList.remove("hidden");
            document
              .getElementById("mobile-sms-section")
              .classList.add("hidden");
          });

          mobilePhoneBtn.addEventListener("click", function () {
            mobilePhoneBtn.className =
              "px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm";
            mobileUsernameBtn.className =
              "px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm";

            const currentValue =
              mobileAuthInputContainer.querySelector("input").value;
            mobileAuthLabel.textContent = "手机号";
            mobileAuthInputContainer.innerHTML = `
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+86 </span>
              <input type="tel" id="mobile-auth-username" class="input-field" placeholder="请输入手机号" autocomplete="tel" inputmode="numeric" maxlength="11" value="${
                currentValue || ""
              }">
            </div>
          `;
            mobileSwitchToSms.classList.remove("hidden");
          });
        }

        const mobileSwitchToSmsBtn = document.getElementById(
          "mobile-switch-to-sms"
        );
        const mobileSwitchToPassBtn = document.getElementById(
          "mobile-switch-to-password"
        );
        const mobilePassSection = document.getElementById(
          "mobile-password-section"
        );
        const mobileSmsSection = document.getElementById("mobile-sms-section");

        if (mobileSwitchToSmsBtn)
          mobileSwitchToSmsBtn.addEventListener("click", () => {
            if (mobilePassSection) mobilePassSection.classList.add("hidden");
            if (mobileSmsSection) mobileSmsSection.classList.remove("hidden");
          });
        if (mobileSwitchToPassBtn)
          mobileSwitchToPassBtn.addEventListener("click", () => {
            if (mobileSmsSection) mobileSmsSection.classList.add("hidden");
            if (mobilePassSection) mobilePassSection.classList.remove("hidden");
          });

        const mobileSendLoginCodeBtn = document.getElementById(
          "mobile-auth-send-login-code"
        );
        if (mobileSendLoginCodeBtn) {
          mobileSendLoginCodeBtn.addEventListener("click", async function () {
            const phone = document.getElementById("mobile-auth-username").value;
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
              showModalAlert("请输入正确的手机号", "错误");
              return;
            }

            openCaptchaModal({
              phone: phone,
              button: mobileSendLoginCodeBtn,
              originalText: mobileSendLoginCodeBtn.textContent,
            });
          });
        }

        const mobileSendRegCodeBtn = document.getElementById(
          "mobile-reg-send-code-btn"
        );
        if (mobileSendRegCodeBtn) {
          mobileSendRegCodeBtn.addEventListener("click", async function () {
            const phone = document.getElementById("mobile-reg-phone").value;
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
              showModalAlert("请输入正确的手机号", "错误");
              return;
            }

            openCaptchaModal({
              phone: phone,
              button: mobileSendRegCodeBtn,
              originalText: mobileSendRegCodeBtn.textContent,
            });
          });
        }

        refreshCaptcha("mobile-login");
        refreshCaptcha("mobile-register");

        const mobileLoginBtn = document.getElementById("mobile-login-btn");
        if (mobileLoginBtn)
          mobileLoginBtn.addEventListener("click", async () => {
            setButtonLoading("mobile-login-btn", true, "登录中...");

            try {
              document.getElementById("auth-username").value =
                document.getElementById("mobile-auth-username").value;
              document.getElementById("auth-password").value =
                document.getElementById("mobile-auth-password").value;
              document.getElementById("auth-sms-code").value =
                document.getElementById("mobile-auth-sms-code").value;
              document.getElementById("auth-login-captcha").value =
                document.getElementById("mobile-login-captcha").value;

              if (
                !document
                  .getElementById("mobile-password-section")
                  .classList.contains("hidden")
              ) {
                document
                  .getElementById("auth-password-section")
                  .classList.remove("hidden");
                document
                  .getElementById("auth-sms-section")
                  .classList.add("hidden");
              } else {
                document
                  .getElementById("auth-password-section")
                  .classList.add("hidden");
                document
                  .getElementById("auth-sms-section")
                  .classList.remove("hidden");
              }

              if (
                !document
                  .getElementById("mobile-login-phone-btn")
                  .classList.contains("text-slate-600")
              ) {
                document
                  .getElementById("auth-login-phone-btn")
                  .classList.add("font-semibold");
              } else {
                document
                  .getElementById("auth-login-phone-btn")
                  .classList.remove("font-semibold");
              }

              await handleAuthLogin();

              const tfaForm = document.getElementById("auth-2fa-form");
              if (tfaForm && !tfaForm.classList.contains("hidden")) {
                document
                  .getElementById("mobile-login-form")
                  .classList.add("hidden");
                document
                  .getElementById("mobile-auth-2fa-form")
                  .classList.remove("hidden");
                document.getElementById("mobile-2fa-code").value = "";
                document.getElementById("mobile-2fa-code").focus();
                showMobileMessage("密码验证成功，请输入验证码", "success");

                setButtonLoading("mobile-login-btn", false);
              } else {
                showButtonSuccess("mobile-login-btn", "登录成功", 800);
              }
            } catch (e) {
              console.error("代理[登录]失败:", e);
              showMobileMessage(e.message || "登录时发生内部错误", "error");
              showButtonError("mobile-login-btn", "登录失败");
            } finally {
              const tfaForm = document.getElementById("auth-2fa-form");
              if (!tfaForm || tfaForm.classList.contains("hidden")) {
                setButtonLoading("auth-login-btn", false);
                setButtonLoading("mobile-login-btn", false);
              }
            }
          });

        const mobileRegisterBtn = document.getElementById(
          "mobile-register-btn"
        );
        if (mobileRegisterBtn)
          mobileRegisterBtn.addEventListener("click", async () => {
            try {
              document.getElementById("auth-reg-username").value =
                document.getElementById("mobile-reg-username").value;
              document.getElementById("auth-reg-phone").value =
                document.getElementById("mobile-reg-phone").value;
              document.getElementById("auth-reg-sms-code").value =
                document.getElementById("mobile-reg-sms-code").value;
              document.getElementById("auth-reg-nickname").value =
                document.getElementById("mobile-reg-nickname").value;
              document.getElementById("auth-reg-password").value =
                document.getElementById("mobile-reg-password").value;
              document.getElementById("auth-reg-password-confirm").value =
                document.getElementById("mobile-reg-password-confirm").value;
              document.getElementById("auth-register-captcha").value =
                document.getElementById("mobile-register-captcha").value;
              await handleAuthRegister();
            } catch (e) {
              console.error("代理[注册]失败:", e);
              showMobileMessage("注册时发生内部错误", "error");
            }
          });

        const mobileGuestBtn = document.getElementById("mobile-guest-btn");
        if (mobileGuestBtn)
          mobileGuestBtn.addEventListener("click", async () => {
            try {
              await handleGuestLogin();
            } catch (e) {
              console.error("代理[游客登录]失败:", e);
              showMobileMessage("游客登录时发生内部错误", "error");
            }
          });

        const mobile2faBtn = document.getElementById("mobile-2fa-submit-btn");
        if (mobile2faBtn)
          mobile2faBtn.addEventListener("click", async () => {
            try {
              document.getElementById("auth-2fa-code").value =
                document.getElementById("mobile-2fa-code").value;
              await handle2FAVerify();
            } catch (e) {
              console.error("代理[2FA验证]失败:", e);
              showMobileMessage("2FA验证时发生内部错误", "error");
            }
          });

        const mobile2faBackBtn = document.getElementById("mobile-2fa-back-btn");
        if (mobile2faBackBtn)
          mobile2faBackBtn.addEventListener("click", () => {
            showMobileAuthForm("login");
            try {
              document.getElementById("auth-2fa-back-btn").click();
            } catch (e) {}
          });

        const mobileAvatarInput = document.getElementById("mobile-reg-avatar");
        if (mobileAvatarInput) {
          mobileAvatarInput.addEventListener(
            "change",
            previewAvatarForRegistration
          );
        }

        const mobileGuestSection = document.getElementById(
          "mobile-guest-login-section"
        );
        if (mobileGuestSection) {
          const desktopGuestSection = document.getElementById(
            "guest-login-section"
          );
          if (
            desktopGuestSection &&
            !desktopGuestSection.classList.contains("hidden")
          ) {
            mobileGuestSection.classList.remove("hidden");
            console.log("[移动端UI] 游客登录已启用");
          } else {
            mobileGuestSection.classList.add("hidden");
            console.log("[移动端UI] 游客登录已禁用");
          }
        }

        const mobileSingleLoginBtn = document.getElementById(
          "mobile-single-login-btn"
        );
        if (mobileSingleLoginBtn) {
          mobileSingleLoginBtn.addEventListener("click", async function () {
            try {
              const username = document
                .getElementById("mobile-username-entry")
                .value.trim();
              const password = document.getElementById(
                "mobile-password-entry"
              ).value;

              if (!username || !password) {
                showMobileMessage("请输入用户名和密码", "error");
                return;
              }

              mobileSingleLoginBtn.disabled = true;

              const originalText = mobileSingleLoginBtn.textContent;
              mobileSingleLoginBtn.textContent = "登录中...";

              const mobileLoadingOverlay = document.getElementById(
                "mobile-loading-overlay"
              );
              if (mobileLoadingOverlay) {
                mobileLoadingOverlay.classList.remove("hidden");
              }

              document.getElementById("username-entry").value = username;
              document.getElementById("password-entry").value = password;

              logMessage_Info("[移动端UI] 触发单账号（学校）登录...");

              let result_mobile_login = false;
              (await result_mobile_login) == onLogin();

              if (result_mobile_login) {
                const desktopMainApp = document.getElementById("main-app");
                if (
                  desktopMainApp &&
                  !desktopMainApp.classList.contains("hidden")
                ) {
                  desktopMainApp.classList.add("hidden");
                  desktopMainApp.classList.remove("grid");
                }

                document
                  .getElementById("mobile-login-container")
                  .classList.add("hidden");

                const mobileMainApp =
                  document.getElementById("mobile-main-app");
                if (mobileMainApp) {
                  mobileMainApp.classList.remove("hidden");
                  logMessage_Info("[移动端UI] 已显示 mobile-main-app");
                  switchMobileSinglePanel("mobile-control-panel");

                  setTimeout(() => {
                    const mobileLoadingOverlay = document.getElementById(
                      "mobile-loading-overlay"
                    );
                    if (mobileLoadingOverlay) {
                      mobileLoadingOverlay.classList.add("hidden");
                    }
                  }, 500);
                }

                updateMobileNavVisibility(true, "single");

                if (typeof mobileRefreshNotifications === "function") {
                  await mobileRefreshNotifications();
                }
              } else {
                mobileSingleLoginBtn.disabled = false;
                mobileSingleLoginBtn.textContent = originalText;
                const mobileLoadingOverlay = document.getElementById(
                  "mobile-loading-overlay"
                );
                if (mobileLoadingOverlay) {
                  mobileLoadingOverlay.classList.add("hidden");
                }
              }
            } catch (e) {
              logMessage_Error("代理[学校登录]失败:", e);
              showMobileMessage("学校登录时发生内部错误", "error");
              mobileSingleLoginBtn.disabled = false;
              mobileSingleLoginBtn.textContent = "登录";
              const mobileLoadingOverlay = document.getElementById(
                "mobile-loading-overlay"
              );
              if (mobileLoadingOverlay) {
                mobileLoadingOverlay.classList.add("hidden");
              }
            }
          });
        }

        const mobileUserCombo = document.getElementById("mobile-user-combo");
        if (mobileUserCombo) {
          mobileUserCombo.addEventListener("change", onMobileUserChange);
        }

        const mobileUsernameEntry = document.getElementById(
          "mobile-username-entry"
        );
        if (mobileUsernameEntry && mobileUserCombo) {
          mobileUsernameEntry.addEventListener("input", async function () {
            const username = this.value.trim();
            const exists = [...mobileUserCombo.options].some(
              (o) => o.value === username
            );
            mobileUserCombo.value = exists ? username : "";

            const mobilePasswordEntry = document.getElementById(
              "mobile-password-entry"
            );
            if (mobilePasswordEntry) mobilePasswordEntry.value = "";

            if (exists && username) {
              try {
                const data = await callPythonAPI("on_user_selected", username);
                if (data) {
                  if (data.password && mobilePasswordEntry) {
                    mobilePasswordEntry.value = data.password;
                  }
                  if (data.ua) {
                    syncUAToMobile(data.ua);
                  } else {
                    syncUAToMobile("(新用户将在登录时自动生成)");
                  }
                }
              } catch (error) {
                console.error("[Mobile] 获取用户数据失败:", error);
              }
            } else {
              syncUAToMobile("(未加载)");
            }
          });
        }

        const navButtons = document.querySelectorAll(".mobile-nav-btn");
        navButtons.forEach(function (btn) {
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            navButtons.forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            const navTarget = this.getAttribute("data-nav");
            console.log("[移动端UI] 切换导航到:", navTarget);
          });
        });

        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener("click", function () {
            console.log("[移动端UI] 菜单按钮点击");
            toggleMobileAdminPanel(true);
          });
        }

        const mobileMultiAccountBtn = document.getElementById(
          "mobile-multi-account-btn"
        );
        if (mobileMultiAccountBtn) {
          mobileMultiAccountBtn.addEventListener("click", async function () {
            console.log("[移动端UI] 多账号模式按钮点击");

            const result = await callPythonAPI("enter_multi_account_mode");
            if (!result.success) {
              showModalAlert("进入多账号模式失败", "错误");
              return;
            }

            console.log("[移动端UI] 进入多账号模式成功");

            const mobileLoginContainer = document.getElementById(
              "mobile-login-container"
            );
            const mobileMultiApp = document.getElementById(
              "mobile-multi-account-app"
            );
            if (mobileLoginContainer)
              mobileLoginContainer.classList.add("hidden");
            if (mobileMultiApp) {
              mobileMultiApp.classList.remove("hidden");
              switchMobilePanel("mobile-multi-control-panel", "multi");
            }
            updateMobileNavVisibility(true, "multi");

            startMultiAccountAutoRefresh(500);
          });
        }

        const mobileRefreshSessionsBtn = document.getElementById(
          "mobile-refresh-sessions-btn"
        );
        if (mobileRefreshSessionsBtn) {
          mobileRefreshSessionsBtn.addEventListener("click", async function () {
            console.log("[移动端UI] 刷新会话列表");
            await loadMobileSessionsList();
          });
        }

        run_code_need_sessionuuid(() => {
          loadMobileUserCombo().catch((e) => {
            console.error("[Mobile UI] 移动端用户下拉框后台加载失败:", e);
          });
        });

        if (loadingOverlayEl) loadingOverlayEl.classList.add("hidden");

        console.log("[移动端UI] 移动端UI初始化完成");
      }

      async function loadMobileSessionsList() {
        const listEl = document.getElementById("mobile-sessions-list");
        const countEl = document.getElementById("mobile-session-count-display");

        if (!listEl) {
          console.error("[Mobile] 找不到 mobile-sessions-list 元素");
          return;
        }

        listEl.innerHTML =
          '<p class="text-slate-400 text-center py-8">加载中...</p>';

        try {
          const headers = { "X-Session-ID": sessionUUID || null };
          const response = await fetch("/auth/user/sessions", {
            headers: headers,
          });
          const result = await response.json();

          if (!result.success) {
            listEl.innerHTML = `<p class="text-red-500 text-center py-8">${result.message}</p>`;
            return;
          }

          const sessions = result.sessions || [];
          const validSessions = sessions.filter(
            (session) =>
              session.session_id &&
              session.session_id !== "null" &&
              session.session_id.trim() !== ""
          );

          if (countEl) {
            const maxSessions = result.max_sessions || 1;
            const currentCount = validSessions.length;
            if (maxSessions === -1) {
              countEl.innerHTML = `<span class="text-green-600">会话数: ${currentCount} / 无限制</span>`;
            } else {
              const colorClass =
                currentCount >= maxSessions ? "text-red-600" : "text-slate-600";
              countEl.innerHTML = `<span class="${colorClass}">会话数: ${currentCount} / ${maxSessions}</span>`;
            }
          }

          if (validSessions.length === 0) {
            listEl.innerHTML =
              '<p class="text-slate-400 text-center py-8">暂无会话</p>';
            return;
          }

          listEl.innerHTML = validSessions
            .map((session) => {
              const createdDate = session.created_at
                ? new Date(session.created_at * 1000).toLocaleString()
                : "未知";
              const isCurrent =
                session.is_current || session.session_id === sessionUUID;
              const sessionHash =
                session.session_hash || session.session_id.substring(0, 16);

              return `
            <div class="mobile-list-item ${
              isCurrent ? "border-l-4 border-sky-500 bg-sky-50" : ""
            }" 
                 onclick="switchToSession('${session.session_id}')">
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${
                    session.session_id
                  }</span>
                  ${
                    isCurrent
                      ? '<span class="text-xs px-2 py-1 rounded-full bg-sky-500 text-white">当前</span>'
                      : ""
                  }
                </div>
                <p class="text-xs text-slate-600">创建事件: ${createdDate}</p>
              </div>
            </div>
          `;
            })
            .join("");
        } catch (error) {
          console.error("[Mobile] 加载会话列表失败:", error);
          listEl.innerHTML =
            '<p class="text-red-500 text-center py-8">加载失败，请重试</p>';
        }
      }
      function getUUIDFromURL() {
        const urlPath = window.location.pathname;

        const match = urlPath.match(
          /\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i
        );

        if (match && match[1]) {
          return match[1];
        } else {
          return null;
        }
      }

      async function loadMobileUserCombo() {
        if (
          run_code_not_need_sessionuuid(() => {
            console.warn("[Mobile UI] sessionUUID 无效，跳过加载用户下拉框");
            return false;
          }) === false
        ) {
          return;
        }
        const mobileUserCombo = document.getElementById("mobile-user-combo");
        if (!mobileUserCombo) {
          logMessage_Error("[Mobile] 找不到 mobile-user-combo 元素");
          return;
        }

        try {
          const initialData = await callPythonAPI("get_initial_data");

          mobileUserCombo.innerHTML = '<option value="">(新用户)</option>';

          if (initialData.users && initialData.users.length > 0) {
            initialData.users.forEach((user) => {
              const option = document.createElement("option");
              option.value = option.textContent = user;
              mobileUserCombo.appendChild(option);
            });
          }

          if (initialData.lastUser) {
            mobileUserCombo.value = initialData.lastUser;
            await onMobileUserChange();
          }

          console.log("[Mobile] 用户下拉框已加载");
        } catch (error) {
          console.error("[Mobile] 加载用户列表失败:", error);
        }
      }

      async function onMobileUserChange() {
        const mobileUserCombo = document.getElementById("mobile-user-combo");
        const mobileUsernameEntry = document.getElementById(
          "mobile-username-entry"
        );
        const mobilePasswordEntry = document.getElementById(
          "mobile-password-entry"
        );

        if (!mobileUserCombo) return;

        const username = mobileUserCombo.value;

        if (mobileUsernameEntry) {
          mobileUsernameEntry.value = username;
        }

        if (mobilePasswordEntry) {
          mobilePasswordEntry.value = "";
        }

        if (username) {
          try {
            const data = await callPythonAPI("on_user_selected", username);
            if (data) {
              if (data.password && mobilePasswordEntry) {
                mobilePasswordEntry.value = data.password;
              }
              if (data.ua) {
                syncUAToMobile(data.ua);
              } else {
                syncUAToMobile("(新用户将在登录时自动生成)");
              }
            }
          } catch (error) {
            console.error("[Mobile] 获取用户数据失败:", error);
          }
        } else {
          syncUAToMobile("(未加载)");
        }
      }

      // ==================== 移动端侧边栏导航控制函数 ====================

      function toggleMobileSidebar() {
        const backdrop = document.getElementById("mobile-sidebar-backdrop");
        const sidebarSingle = document.getElementById(
          "mobile-sidebar-single-account"
        );
        const sidebarMulti = document.getElementById(
          "mobile-sidebar-multi-account"
        );

        const multiAccountApp = document.getElementById(
          "mobile-multi-account-app"
        );
        const isMultiMode =
          multiAccountApp && !multiAccountApp.classList.contains("hidden");

        const activeSidebar = isMultiMode ? sidebarMulti : sidebarSingle;

        if (activeSidebar && activeSidebar.classList.contains("show")) {
          closeMobileSidebar();
        } else {
          if (sidebarSingle) {
            sidebarSingle.classList.remove("show");
            sidebarSingle.classList.add("hidden");
          }
          if (sidebarMulti) {
            sidebarMulti.classList.remove("show");
            sidebarMulti.classList.add("hidden");
          }

          if (backdrop) {
            backdrop.classList.add("show");
          }

          if (activeSidebar) {
            activeSidebar.classList.remove("hidden");
            setTimeout(() => {
              activeSidebar.classList.add("show");
            }, 10);
          }
        }
      }

      function closeMobileSidebar() {
        const backdrop = document.getElementById("mobile-sidebar-backdrop");
        const sidebarSingle = document.getElementById(
          "mobile-sidebar-single-account"
        );
        const sidebarMulti = document.getElementById(
          "mobile-sidebar-multi-account"
        );

        if (backdrop) {
          backdrop.classList.remove("show");
        }

        if (sidebarSingle) {
          sidebarSingle.classList.remove("show");
          setTimeout(() => {
            sidebarSingle.classList.add("hidden");
          }, 300);
        }

        if (sidebarMulti) {
          sidebarMulti.classList.remove("show");
          setTimeout(() => {
            sidebarMulti.classList.add("hidden");
          }, 300);
        }
      }

      function updateMobileNavVisibility(show, mode = "single") {
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileHeader = document.getElementById("mobile-header");
        const sidebarSingle = document.getElementById(
          "mobile-sidebar-single-account"
        );
        const sidebarMulti = document.getElementById(
          "mobile-sidebar-multi-account"
        );

        if (show) {
          if (mobileMenuBtn) {
            mobileMenuBtn.style.display = "";
          }

          if (mobileHeader) {
            mobileHeader.classList.remove("hidden");
            mobileHeader.style.display = "";
          }

          if (mode === "single" && sidebarSingle) {
            sidebarSingle.classList.remove("hidden");
          }
          if (mode === "multi" && sidebarMulti) {
            sidebarMulti.classList.remove("hidden");
          }
        } else {
          if (mobileMenuBtn) {
            mobileMenuBtn.style.display = "none";
          }

          if (sidebarSingle) {
            sidebarSingle.classList.add("hidden");
            sidebarSingle.classList.remove("show");
          }
          if (sidebarMulti) {
            sidebarMulti.classList.add("hidden");
            sidebarMulti.classList.remove("show");
          }
        }

        const mobileBottomNavSingle = document.getElementById(
          "mobile-bottom-nav-single-account"
        );
        const mobileBottomNavMulti = document.getElementById(
          "mobile-bottom-nav-multi-account"
        );

        if (show) {
          if (mode === "single" && mobileBottomNavSingle) {
            mobileBottomNavSingle.classList.remove("hidden");
            mobileBottomNavSingle.style.display = "";
          }
          if (mode === "multi" && mobileBottomNavMulti) {
            mobileBottomNavMulti.classList.remove("hidden");
            mobileBottomNavMulti.style.display = "";
          }
        } else {
          if (mobileBottomNavSingle) {
            mobileBottomNavSingle.classList.add("hidden");
            mobileBottomNavSingle.style.display = "none";
          }
          if (mobileBottomNavMulti) {
            mobileBottomNavMulti.classList.add("hidden");
            mobileBottomNavMulti.style.display = "none";
          }
        }
      }

      function showMobileMessage(message, type = "info") {
        const errorDiv = document.getElementById("mobile-auth-error");
        const successDiv = document.getElementById("mobile-auth-success");

        if (type === "clear") {
          if (errorDiv) errorDiv.classList.add("hidden");
          if (successDiv) successDiv.classList.add("hidden");
          return;
        }

        if (errorDiv) errorDiv.classList.add("hidden");
        if (successDiv) successDiv.classList.add("hidden");

        if (type === "error") {
          if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove("hidden");
          }
        } else if (type === "success") {
          if (successDiv) {
            successDiv.textContent = message;
            successDiv.classList.remove("hidden");
          }
        } else {
          showModalAlert(message, "提示");
        }
      }
      document.addEventListener("DOMContentLoaded", function () {
        console.log("[页面加载] DOM内容已加载，开始执行设备检测和UI切换");

        switchUIContainer();

        console.log(
          "[页面加载] 移动端检测和UI切换完成（基于User-Agent，不监听窗口变化）"
        );
      });

      // ==============移动端设备检测与UI容器切换功能==================

      function handleCdnError(resourceName = "未指定") {
        cdnErrorCount++;
        logMessage_Warning(
          `CDN资源[${resourceName}]加载失败 (${cdnErrorCount}/3)，等待应用初始化...`
        );

        if (cdnErrorTimer) {
          clearTimeout(cdnErrorTimer);
        }

        cdnErrorTimer = setTimeout(() => {
          if (!appInitialized && cdnErrorCount > 0) {
            const errorOverlay = document.getElementById("cdn-error-overlay");
            if (errorOverlay) {
              try {
                errorOverlay.style.setProperty("display", "flex", "important");
              } catch (e) {
                errorOverlay.style.display = "flex";
              }
              errorOverlay.classList.remove("hidden");
              logMessage_Error(
                `应用初始化超时，CDN资源加载失败 (${cdnErrorCount}个资源)`
              );
            }
          }
        }, 3000);
      }

      function showModalAlert(message, title = "提示", onCloseCallback = null) {
        const modal = $("alert-modal");
        const titleEl = $("alert-modal-title");
        const msgEl = $("alert-modal-message");
        const closeBtn = $("alert-modal-close-btn");

        if (!modal || !titleEl || !msgEl || !closeBtn) {
          logMessage_Warning(
            "Alert modal DOM not found, falling back to native alert."
          );
          alert(`${title}:\n${message}`);
          if (onCloseCallback && typeof onCloseCallback === "function")
            onCloseCallback();
          return;
        }

        titleEl.textContent = title;
        msgEl.innerHTML = String(message).replace(/\n/g, "<br>");

        if (title.includes("失败") || title.includes("错误")) {
          titleEl.classList.remove("text-sky-600");
          titleEl.classList.add("text-red-600");
        } else {
          titleEl.classList.remove("text-red-600");
          titleEl.classList.add("text-sky-600");
        }

        closeBtn.onclick = () => {
          closeModalAlert();
          if (onCloseCallback && typeof onCloseCallback === "function")
            onCloseCallback();
        };

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.classList.add("modal-visible");
      }

      function closeModalAlert() {
        const modal = $("alert-modal");
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
        const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
        let stillVisible = false;
        otherModals.forEach((m) => {
          if (
            m.id !== "alert-modal" &&
            !m.classList.contains("hidden") &&
            (m.classList.contains("flex") || m.style.display === "flex")
          ) {
            stillVisible = true;
          }
        });
        if (!stillVisible) {
          document.body.classList.remove("modal-visible");
        }
      }

      function showModal(modalId) {
        const modal = $(modalId);
        if (modal) {
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.body.classList.add("modal-visible");
        }
      }

      function hideModal(modalId) {
        const modal = $(modalId);
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
        const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
        let stillVisible = false;
        otherModals.forEach((m) => {
          if (
            !m.classList.contains("hidden") &&
            (m.classList.contains("flex") || m.style.display === "flex")
          ) {
            stillVisible = true;
          }
        });
        if (!stillVisible) {
          document.body.classList.remove("modal-visible");
        }
      }

      let resolveConfirmPromise = null;

      function jsShowConfirm(title, message) {
        return new Promise((resolve) => {
          const modal = $("confirm-modal");
          const titleEl = $("confirm-modal-title");
          const msgEl = $("confirm-modal-message");
          const okBtn = $("confirm-modal-ok-btn");
          const cancelBtn = $("confirm-modal-cancel-btn");

          if (!modal || !titleEl || !msgEl || !okBtn || !cancelBtn) {
            logMessage_Error(
              "Confirm modal DOM not found. Falling back to native confirm."
            );
            resolve(confirm(`${title}:\n${message}`));
            return;
          }

          resolveConfirmPromise = resolve;

          titleEl.textContent = title || "请确认";
          msgEl.innerHTML = String(message).replace(/\n/g, "<br>");

          okBtn.onclick = null;
          cancelBtn.onclick = null;

          okBtn.onclick = () => handleConfirm(true);
          cancelBtn.onclick = () => handleConfirm(false);

          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.body.classList.add("modal-visible");
        });
      }

      function handleConfirm(result) {
        const modal = $("confirm-modal");
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }

        const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
        let stillVisible = false;
        otherModals.forEach((m) => {
          if (
            m.id !== "confirm-modal" &&
            !m.classList.contains("hidden") &&
            (m.classList.contains("flex") || m.style.display === "flex")
          ) {
            stillVisible = true;
          }
        });
        if (!stillVisible) {
          document.body.classList.remove("modal-visible");
        }

        if (resolveConfirmPromise) {
          resolveConfirmPromise(result);
          resolveConfirmPromise = null;
        }
      }

      let AMAP_API_KEY = "";
      let isRefreshingNotifications = false;

      let isRefreshingTasks = false;

      let IS_OFFLINE = false;
      let sessionUUID = null;

      function getUUIDFromURL() {
        const urlPath = window.location.pathname;

        const match = urlPath.match(
          /\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i
        );

        if (match && match[1]) {
          return match[1];
        } else {
          return null;
        }
      }

      async function callPythonAPI(method, ...args) {
        if (isInNetworkErrorState) {
          logMessage_Warning(
            `[API调用] ✗ 已跳过 (${method}): 网络错误状态已激活`
          );
          throw new Error("网络连接已断开。");
        }

        logMessage_Info(`[API调用] 方法: ${method}, 参数数量: ${args.length}`);
        const headers = {
          "Content-Type": "application/json",
        };

        if (sessionUUID) {
          headers["X-Session-ID"] = sessionUUID;
          logMessage_Info(`[API调用] 会话ID: ${sessionUUID}`);
        } else {
          logMessage_Warning(
            `[API调用] 警告: sessionUUID为空，可能导致会话无效错误，尝试从URL提取...`
          );
          sessionUUID = getUUIDFromURL();
          if (
            sessionUUID ||
            sessionUUID !== null ||
            sessionUUID !== undefined ||
            sessionUUID !== "null"
          ) {
            logMessage_Info(`[API调用] 从URL提取到会话ID: ${sessionUUID}`);
            headers["X-Session-ID"] = sessionUUID;
          } else {
            logMessage_Warning(`[API调用] 无法从URL提取会话ID`);
          }
        }

        logMessage_Info(`[API调用] 发送请求到 /api/${method}`);
        let response;
        try {
          response = await fetch(`/api/${method}`, {
            method: "POST",
            headers: headers,
            credentials: "include",
            body: JSON.stringify(
              args.length === 1 &&
                typeof args[0] === "object" &&
                args[0] !== null &&
                !Array.isArray(args[0])
                ? args[0]
                : args
            ),
          });
        } catch (networkError) {
          logMessage_Error(
            `[API调用] ✗ 网络请求失败 (${method}):`,
            networkError
          );

          if (!isInNetworkErrorState) {
            isInNetworkErrorState = true;
            logMessage_Info(
              "[API调用] 进入网络错误状态，停止后端日志发送和WebSocket"
            );

            if (refreshUserListInterval) {
              logMessage_Info("[API调用] 停止用户列表刷新定时器 (因网络错误)");
              clearInterval(refreshUserListInterval);
              refreshUserListInterval = null;
            }

            if (socket) {
              if (socket.io) {
                socket.io.opts.reconnection = false;
              }
              if (socket.connected) {
                socket.disconnect();
              }
              logMessage_Info(
                "[API调用] 已断开WebSocket连接并禁用自动重连 (因网络错误)"
              );
            }
          }

          showModalAlert(
            "无法连接到服务器，请检查您的网络连接或稍后重试。",
            "网络错误",
            () => {
              if (isInNetworkErrorState) {
                logMessage_Info("[API调用] 用户关闭网络错误弹窗，准备恢复连接");
                isInNetworkErrorState = false;

                setTimeout(() => {
                  if (!refreshUserListInterval) {
                    refreshUserListInterval = setInterval(
                      refreshUserList,
                      5000
                    );
                    logMessage_Info("[API调用] 用户列表刷新定时器已恢复");
                  }

                  if (socket && !socket.connected && sessionUUID) {
                    if (socket.io) {
                      socket.io.opts.reconnection = true;
                    }
                    socket.connect();
                    logMessage_Info(
                      "[API调用] 正在重新连接WebSocket（已重新启用自动重连）"
                    );
                  }
                }, 1000);
              }
            }
          );

          throw networkError;
        }

        if (!response.ok) {
          logMessage_Info(
            `[API调用] ✗ 响应错误: ${response.status} ${response.statusText}`
          );
          let errorData = null;
          try {
            errorData = await response.json();
          } catch (parseError) {
            logMessage_Warning(
              "[API调用] ✗ 无法解析错误响应体为 JSON:",
              parseError
            );
          }

          if (
            response.status === 401 &&
            errorData &&
            errorData.message &&
            errorData.message.includes("会话已过期或无效")
          ) {
            logMessage_Error("[API调用] ✗ 会话已过期或无效！");
            logMessage_Info("[系统] 您的会话已过期或无效，请重新登录。");

            if (refreshUserListInterval) {
              logMessage_Info("[API调用] 停止用户列表刷新定时器 (因会话过期)");
              clearInterval(refreshUserListInterval);
              refreshUserListInterval = null;
            }

            if (isMobileMode) {
              showMobileMessage("您的会话已过期或无效，请重新登录", "error");

              const mobileMainApp = document.getElementById("mobile-main-app");
              const mobileMultiApp = document.getElementById(
                "mobile-multi-account-app"
              );
              const mobileLoginContainer = document.getElementById(
                "mobile-login-container"
              );

              if (mobileMainApp) mobileMainApp.classList.add("hidden");
              if (mobileMultiApp) mobileMultiApp.classList.add("hidden");
              if (mobileLoginContainer)
                mobileLoginContainer.classList.remove("hidden");

              logMessage_Info("[移动端] 已切换到登录页面");
            } else {
              // ==================== 修改开始：使用全屏遮罩替代简单弹窗 ====================
              // 检查遮罩是否已存在，防止重复创建
              if (!document.getElementById("logout-elsewhere-overlay")) {
                const logoutOverlay = document.createElement("div");
                logoutOverlay.id = "logout-elsewhere-overlay";
                logoutOverlay.style.cssText = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0, 0, 0, 0.85); z-index: 9999;
                  display: flex; align-items: center; justify-content: center;
                `;

                const modalContent = document.createElement("div");
                modalContent.style.cssText = `
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  padding: 40px;
                  border-radius: 20px;
                  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                  max-width: 500px;
                  width: 90%;
                  text-align: center;
                  color: white;
                `;

                const icon = document.createElement("div");
                icon.innerHTML = `
                  <svg style="width: 80px; height: 80px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                `;

                const title = document.createElement("h2");
                title.textContent = "会话已失效";
                title.style.cssText = "font-size: 24px; font-weight: bold; margin: 0 0 20px 0;";

                const text = document.createElement("p");
                text.textContent = "您的会话已过期或无效，为了安全起见请重新登录。";
                text.style.cssText = "font-size: 16px; line-height: 1.6; margin: 0 0 30px 0; opacity: 0.95;";

                const countdown = document.createElement("div");
                countdown.style.cssText = "font-size: 24px; font-weight: bold; margin: 0 0 30px 0;";

                const button = document.createElement("button");
                button.textContent = "立即返回登录";
                button.style.cssText = `
                  background: white; color: #667eea; border: none; padding: 12px 30px;
                  border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;
                `;
                button.onmouseover = () => { button.style.transform = "scale(1.05)"; button.style.boxShadow = "0 5px 15px rgba(255, 255, 255, 0.3)"; };
                button.onmouseout = () => { button.style.transform = "scale(1)"; button.style.boxShadow = "none"; };

                modalContent.appendChild(icon);
                modalContent.appendChild(title);
                modalContent.appendChild(text);
                modalContent.appendChild(countdown);
                modalContent.appendChild(button);
                logoutOverlay.appendChild(modalContent);
                document.body.appendChild(logoutOverlay);

                let remainingSeconds = 120; // 设置为120秒倒计时
                const updateCountdown = () => {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                countdown.textContent = `${minutes}:${seconds
                  .toString()
                  .padStart(2, "0")}`;
              };
                updateCountdown();

                const countdownInterval = setInterval(() => {
                  remainingSeconds--;
                  updateCountdown();
                  if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = "/";
                  }
                }, 1000);

                button.onclick = () => {
                  clearInterval(countdownInterval);
                  window.location.href = "/";
                };
              }
              // ==================== 修改结束 ====================
            }

            throw new Error("会话已过期或无效");
          }
          if (errorData && errorData.need_login) {
            let errorMsg = errorData.message || "API调用失败";
            logMessage_Info(`[API调用] ✗ 需要重新登录: ${errorMsg}`);

            if (errorData.logged_out_elsewhere) {
              // ==================== 修复开始 ====================
              // 检查遮罩是否已存在，防止重复创建和倒计时重置
              if (document.getElementById("logout-elsewhere-overlay")) {
                return;
              }
              // ==================== 修复结束 ====================

              logMessage_Info(
                "[安全提示] 检测到账号在其他设备登录，已自动登出"
              );
              logMessage_Info("[API调用] ✗ 多设备登录检测");

              const logoutOverlay = document.createElement("div");
              logoutOverlay.id = "logout-elsewhere-overlay";
              logoutOverlay.style.cssText = `
                          position: fixed;
                          top: 0;
                          left: 0;
                          width: 100%;
                          height: 100%;
                          background: rgba(0, 0, 0, 0.85);
                          z-index: 9999;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        `;

              const modalContent = document.createElement("div");
              modalContent.style.cssText = `
                          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                          padding: 40px;
                          border-radius: 20px;
                          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                          max-width: 500px;
                          width: 90%;
                          text-align: center;
                          color: white;
                        `;

              const icon = document.createElement("div");
              icon.innerHTML = `
                          <svg style="width: 80px; height: 80px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                          </svg>
                        `;

              const title = document.createElement("h2");
              title.textContent = "多设备登录检测";
              title.style.cssText = `
                          font-size: 24px;
                          font-weight: bold;
                          margin: 0 0 20px 0;
                        `;

              const text = document.createElement("p");
              text.textContent =
                "您的账号已在其他设备登录，本设备已自动登出。2分钟后将自动跳转到登录页面。";
              text.style.cssText = `
                          font-size: 16px;
                          line-height: 1.6;
                          margin: 0 0 30px 0;
                          opacity: 0.95;
                        `;

              const countdown = document.createElement("div");
              countdown.style.cssText = `
                          font-size: 32px;
                          font-weight: bold;
                          margin: 0 0 30px 0;
                        `;

              const button = document.createElement("button");
              button.textContent = "立即返回登录";
              button.style.cssText = `
                          background: white;
                          color: #667eea;
                          border: none;
                          padding: 12px 30px;
                          border-radius: 25px;
                          font-size: 16px;
                          font-weight: bold;
                          cursor: pointer;
                          transition: all 0.3s;
                        `;
              button.onmouseover = () => {
                button.style.transform = "scale(1.05)";
                button.style.boxShadow = "0 5px 15px rgba(255, 255, 255, 0.3)";
              };
              button.onmouseout = () => {
                button.style.transform = "scale(1)";
                button.style.boxShadow = "none";
              };

              modalContent.appendChild(icon);
              modalContent.appendChild(title);
              modalContent.appendChild(text);
              modalContent.appendChild(countdown);
              modalContent.appendChild(button);
              logoutOverlay.appendChild(modalContent);
              document.body.appendChild(logoutOverlay);

              let remainingSeconds = 120;
              const updateCountdown = () => {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                countdown.textContent = `${minutes}:${seconds
                  .toString()
                  .padStart(2, "0")}`;
              };
              updateCountdown();

              const countdownInterval = setInterval(() => {
                remainingSeconds--;
                updateCountdown();

                if (remainingSeconds <= 0) {
                  clearInterval(countdownInterval);
                  window.location.href = "/";
                }
              }, 1000);

              // 修正：移除用户活动监听，强制执行倒计时
              button.onclick = () => {
                clearInterval(countdownInterval);
                window.location.href = "/";
              };
            } else {
              logMessage_Info(`[安全提示] ${errorMsg}`);

              if (isMobileMode) {
                showMobileMessage(errorMsg || "需要重新登录", "error");

                const mobileMainApp =
                  document.getElementById("mobile-main-app");
                const mobileMultiApp = document.getElementById(
                  "mobile-multi-account-app"
                );
                const mobileLoginContainer = document.getElementById(
                  "mobile-login-container"
                );

                if (mobileMainApp) mobileMainApp.classList.add("hidden");
                if (mobileMultiApp) mobileMultiApp.classList.add("hidden");
                if (mobileLoginContainer)
                  mobileLoginContainer.classList.remove("hidden");

                logMessage_Info("[移动端] 已切换到登录页面（因need_login）");
              } else {
                Swal.fire({
                  icon: "warning",
                  title: "需要重新登录",
                  text: errorMsg,
                  confirmButtonText: "返回登录",
                  allowOutsideClick: false,
                }).then(() => {
                  window.location.href = "/";
                });
              }
            }

            if (refreshUserListInterval) {
              logMessage_Info(
                "[API调用] 停止用户列表刷新定时器 (因需重新登录)"
              );
              clearInterval(refreshUserListInterval);
              refreshUserListInterval = null;
            }

            throw new Error(errorMsg);
          }

          if (response.status === 403 && errorData && errorData.message) {
            logMessage_Error(
              `[API调用] ✗ 权限不足 (${method}): ${errorData.message}`
            );
            showModalAlert(`操作失败: ${errorData.message}`, "权限不足");
            throw new Error(`权限不足: ${errorData.message}`);
          }

          const genericErrorMessage =
            errorData && errorData.message
              ? errorData.message
              : response.statusText;
          logMessage_Error(
            `[API调用] ✗ 未处理的错误 (${method}): ${genericErrorMessage}`
          );
          throw new Error(
            `API调用失败 (${response.status}): ${genericErrorMessage}`
          );
        }

        logMessage_Info(`[API调用] ✓ 请求成功 (${method})`);
        const result = await response.json();
        logMessage_Info(
          `[API调用] ✓ 返回结果 (${method}):`,
          result.success ? "成功" : "失败"
        );
        return result;
      }

      async function callPythonAPI_raw(path, method = "POST", data = null) {
        const headers = {
          "Content-Type": "application/json",
        };

        if (sessionUUID) {
          headers["X-Session-ID"] = sessionUUID;
        }

        const options = {
          method: method,
          headers: headers,
          credentials: "include",
        };

        if (data && method !== "GET") {
          options.body = JSON.stringify(data);
        }

        try {
          const response = await fetch(path, options);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          return result;
        } catch (error) {
          logMessage_Error(`API调用失败 (${path}):`, error);
          throw error;
        }
      }

      async function executeServerJS(script, ...args) {
        const headers = {
          "Content-Type": "application/json",
        };

        if (sessionUUID) {
          headers["X-Session-ID"] = sessionUUID;
        }

        const response = await fetch("/execute_js", {
          method: "POST",
          headers: headers,
          body: JSON.stringify({
            script: script,
            args: args,
          }),
        });

        if (!response.ok) {
          throw new Error(`服务器端JS执行失败: ${response.statusText}`);
        }

        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || "JS执行失败");
        }

        return data.result;
      }

      let singleProcessedPoints = 0;
      let singleTotalPoints = 0;

      let AMapInstance, map;
      let amapLoadingPromise = null;
      let AMapReady = false;

      let currentTasks = [];
      let selectedTaskIndex = -1;
      let currentUserData = {};
      let currentRunData = {};
      let polylines = {
        recommended: [],
        draft: null,
        run: null,
        history: null,
      };
      let markers = [];
      let runnerMarker = null;
      let drawingInfoMarker = null;
      let tempAttendanceMarker = null;
      let tempAttendanceCircle = null;
      let isDrawing = false;
      let isPathDrawing = false;
      let leftMouseDown = false;
      const $ = (id) => document.getElementById(id);

      let multiAccountMap;
      let multiAccountMarkers = {};
      const userColors = [
        "#F44336",
        "#E91E63",
        "#9C27B0",
        "#673AB7",
        "#3F51B5",
        "#2196F3",
        "#03A9F4",
        "#00BCD4",
        "#009688",
        "#4CAF50",
        "#8BC34A",
        "#CDDC39",
        "#FFEB3B",
        "#FFC107",
        "#FF9800",
        "#FF5722",
      ];
      let colorIndex = 0;
      let path_planning_queue = [];
      let is_planning_path = false;

      let currentSessionUA = "";

      let pendingMultiPositions = [];

      let mapReadyPromise = null;
      let resolveMapReady = null;

      const paramDefs = {
        interval_ms: {
          label: "采样间隔",
          unit: "ms",
          help: "相邻 GPS 点之间的时间间隔，用于模拟上报节奏。",
        },
        interval_random_ms: {
          label: "间隔随机范围",
          unit: "ms",
          help: "在采样间隔的基础上上下浮动的随机抖动幅度。",
        },
        speed_mps: {
          label: "平均速度",
          unit: "m/s",
          help: "生成/处理路径时的目标平均速度。",
        },
        speed_random_mps: {
          label: "速度随机范围",
          unit: "m/s",
          help: "速度的上下浮动范围，用于模拟自然波动。",
        },
        location_random_m: {
          label: "定位随机偏移半径",

          unit: "m",
          help: "对每个 GPS 点施加的随机偏移的半径，模拟定位噪声。",
        },

        task_gap_min_s: {
          label: "任务间隙下限",
          unit: "s",
          help: "连续执行任务之间的最短等待时间。",
        },
        task_gap_max_s: {
          label: "任务间隙上限",
          unit: "s",
          help: "连续执行任务之间的最长等待时间。",
        },

        api_fallback_line: {
          label: "规划失败时使用直线连接",
          unit: "",
          help: "启用后，当某段步行路径规划失败时，使用起终点直线代替。",
        },
        api_retries: {
          label: "API重试次数",
          unit: "次",
          help: "步行路径每一段失败后的重试次数。",
        },

        api_retry_delay_s: {
          label: "API重试间隔",
          unit: "s",
          help: "步行路径失败后发起下一次重试前的等待时间。",
        },
        ignore_task_time: {
          label: "忽略任务时间仅对比日期",
          unit: "",
          help: "勾选后，判断任务是否“未开始”或“已过期”时，只对比年月日，忽略具体时分秒。",
        },

        min_time_m: {
          label: "目标时长下限",
          unit: "分钟",
          help: "自动生成路径的总时长最小值。",
        },
        max_time_m: {
          label: "目标时长上限",
          unit: "分钟",
          help: "自动生成路径的总时长最大值。",
        },
        min_dist_m: {
          label: "目标距离下限",
          unit: "m",
          help: "自动生成路径的总距离下限。上限按 1.0–1.15 倍随机浮动。",
        },

        theme_style: {
          label: "界面主题风格",
          unit: "",
          help: "切换应用界面的外观。主题切换后将自动保存。",
          type: "theme_selector",
        },
        theme_base_color: {
          label: "主题基础颜色",
          unit: "",
          help: "界面主色调（点击颜色块进行选择）。",
          type: "color_picker",
        },
        auto_attendance_enabled: {
          label: "开启自动签到",
          unit: "",
          help: "开启后，将在后台自动刷新通知并尝试签到",
          type: "checkbox",
        },
        auto_attendance_refresh_s: {
          label: "刷新间隔",
          unit: "秒",
          help: "自动刷新通知的间隔时间（秒），建议不低于60",
        },
        attendance_user_radius_m: {
          label: "随机半径",
          unit: "米",
          help: "自动签到时，在服务器允许范围内的最大随机偏移半径。设为0为精确签到。",
        },
      };

      const paramGroups = [
        {
          title: "采样与速度",
          keys: [
            "interval_ms",
            "interval_random_ms",
            "speed_mps",
            "speed_random_mps",
            "location_random_m",
          ],
        },
        {
          title: "任务间隔",
          keys: ["task_gap_min_s", "task_gap_max_s", "ignore_task_time"],
        },
        {
          title: "路径规划重试策略",
          keys: ["api_fallback_line", "api_retries", "api_retry_delay_s"],
        },
        {
          title: "自动生成目标",
          keys: ["min_time_m", "max_time_m", "min_dist_m"],
        },
        {
          title: "自动签到",
          keys: [
            "auto_attendance_enabled",
            "auto_attendance_refresh_s",
            "attendance_user_radius_m",
          ],
        },
      ];

      let pythonParams = {};

      let cachedMultiAccounts = [];

      let runAccumulatedMs = 0;
      let draftTotalDist = 0;

      function destroySingleMap() {
        try {
          if (window.mapCleanup) {
            window.mapCleanup();
            window.mapCleanup = null;
          }
          if (map && typeof map.destroy === "function") {
            map.destroy();
          }
        } catch (e) {
          logMessage_Warning("destroySingleMap warning:", e);
        } finally {
          map = null;
          polylines.recommended = [];
          polylines.draft = null;
          polylines.run = null;
          polylines.history = null;
          markers = [];
          runnerMarker = null;
          drawingInfoMarker = null;

          try {
            const container = document.getElementById("map-container");
            if (container) container.classList.remove("drawing");
          } catch (_) {}
          isDrawing = false;
          isPathDrawing = false;
          leftMouseDown = false;
          pendingUnlockMap = false;
          draftPath = [];
          draftPathLngLat = [];
          pendingPoints = [];
          isUpdating = false;
          lastMouseMoveTime = 0;
          try {
            document.body.classList.remove("modal-visible");
          } catch (_) {}
        }
      }

      function updateMultiGlobalButtons(startDisabled, stopDisabled) {
        const startBtn = document.getElementById("multi-start-all-btn");
        const stopBtn = document.getElementById("multi-stop-all-btn");
        if (!startBtn || !stopBtn) return;
        startBtn.disabled = !!startDisabled;
        stopBtn.disabled = !!stopDisabled;
      }

      function safeResizeAndFitView() {
        try {
          map.resize();
          requestAnimationFrame(() => {
            resetMapView();
            if (markers.length > 0) {
              map.setFitView(markers, false, [50, 50, 50, 50]);
            }
          });
        } catch (e) {
          logMessage_Warning("safeResizeAndFitView error:", e);
        }
      }

      function setThemeStyle(styleName) {
        document.body.classList.remove("theme-anime", "theme-minimalist");

        if (styleName !== "default") {
          document.body.classList.add(styleName);
        }

        const themeButtons = document.querySelectorAll(
          '#admin-profile-panel_modal button[onclick^="setThemeStyle"]'
        );
        themeButtons.forEach((btn) => {
          const onclickValue = btn.getAttribute("onclick");
          if (onclickValue && onclickValue.includes(`'${styleName}'`)) {
            btn.classList.add("border-2", "border-sky-500");
          } else {
            btn.classList.remove("border-2", "border-sky-500");
          }
        });

        callPythonAPI("update_param", "theme_style", styleName);
        logMessage_Info(`主题样式已切换为: ${styleName}`);
      }

      function applyAndSaveTheme(theme) {
        if (theme === "dark") {
          document.body.classList.add("dark-mode");
          logMessage_Info("[主题] 已应用深色模式");
        } else {
          document.body.classList.remove("dark-mode");
          logMessage_Info("[主题] 已应用浅色模式");
        }

        try {
          fetch("/auth/user/update_theme", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ theme: theme }),
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.success) {
                logMessage_Info(`[主题] 主题设置已保存: ${theme}`);
              } else {
                logMessage_Warning(
                  `[主题] 保存主题设置失败: ${result.message}`
                );
              }
            });
        } catch (e) {
          logMessage_Error("[主题] 保存主题设置时出错:", e);
        }
      }

      function resetBaseColorToDefault(prefix) {
        const defaultColor = "#7dd3fc";
        const key = "theme_base_color";

        const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
        const textInput = document.getElementById(`${prefix}-${key}`);
        if (colorPicker) colorPicker.value = defaultColor;
        if (textInput) textInput.value = defaultColor;

        setBaseColor(defaultColor, defaultColor);

        if (pythonParams) {
          pythonParams[key] = defaultColor;
        }

        logMessage_Info("主题颜色已恢复为默认。");
      }

      function setBaseColor(c, deep) {
        document.documentElement.style.setProperty("--base-color", c);
        document.documentElement.style.setProperty("--base-color-600", deep);
        document.documentElement.style.setProperty("--base-color-300", c);
        callPythonAPI("update_param", "theme_base_color", c);
        if ($("base-color-input")) $("base-color-input").value = c;
      }
      function onColorPicked(val) {
        setBaseColor(val, val);
      }

      async function checkAuthStatus() {
        try {
          const result = await callPythonAPI("get_initial_data");
          if (result && result.is_authenticated) {
            return true;
          }
        } catch (e) {
          logMessage_Info("未认证或会话过期");
        }

        return false;
      }

      function showAuthLogin() {
        $("loading-overlay").classList.add("hidden");
        $("auth-login-container").classList.remove("hidden");
        $("login-container").classList.add("hidden");
        $("main-app").classList.add("hidden");

        // 新增：在认证登录界面隐藏退出应用按钮
        const exitBtn = $("exit-app-btn");
        if (exitBtn) exitBtn.classList.add("hidden");

        checkGuestLoginEnabled();
      }

      async function checkGuestLoginEnabled() {
        try {
          const result = await fetch("/auth/get_config");
          const data = await result.json();
          if (data.success && data.allow_guest_login) {
            $("guest-login-section").classList.remove("hidden");
          } else {
            $("guest-login-section").classList.add("hidden");
          }
        } catch (e) {
          logMessage_Error("获取配置失败:", e);
        }
      }

      function switchAuthTab(tab) {
        const loginTab = $("auth-tab-login");
        const registerTab = $("auth-tab-register");
        const loginForm = $("auth-login-form");
        const registerForm = $("auth-register-form");

        if (tab === "login") {
          loginTab.classList.add("text-sky-600", "border-sky-600");
          loginTab.classList.remove("text-slate-400", "border-transparent");
          registerTab.classList.remove("text-sky-600", "border-sky-600");
          registerTab.classList.add("text-slate-400", "border-transparent");
          loginForm.classList.remove("hidden");
          registerForm.classList.add("hidden");
        } else {
          registerTab.classList.add("text-sky-600", "border-sky-600");
          registerTab.classList.remove("text-slate-400", "border-transparent");
          loginTab.classList.remove("text-sky-600", "border-sky-600");
          loginTab.classList.add("text-slate-400", "border-transparent");
          registerForm.classList.remove("hidden");
          loginForm.classList.add("hidden");
        }

        $("auth-error-msg").classList.add("hidden");
        $("auth-success-msg").classList.add("hidden");
      }

      function showAuthError(message) {
        const errorMsg = $("auth-error-msg");
        errorMsg.textContent = message;
        errorMsg.classList.remove("hidden");
        $("auth-success-msg").classList.add("hidden");
      }

      function showAuthSuccess(message) {
        const successMsg = $("auth-success-msg");
        successMsg.textContent = message;
        successMsg.classList.remove("hidden");
        $("auth-error-msg").classList.add("hidden");
      }

      function setButtonLoading(buttonId, loading, originalText = "") {
        const btn = $(buttonId);
        if (!btn) return;

        if (loading) {
          btn.dataset.originalText = btn.textContent;
          btn.disabled = true;
          btn.innerHTML = `<span class="inline-block animate-spin mr-2">⏳</span>${
            originalText || "处理中..."
          }`;
          btn.classList.add("opacity-75", "cursor-not-allowed");
        } else {
          btn.disabled = false;
          btn.textContent = btn.dataset.originalText || originalText;
          btn.classList.remove("opacity-75", "cursor-not-allowed");
          delete btn.dataset.originalText;
        }
      }

      function showButtonSuccess(buttonId, message = "成功", duration = 1500) {
        const btn = $(buttonId);
        if (!btn) return;

        btn.disabled = false;
        btn.classList.remove("opacity-75", "cursor-not-allowed");

        const originalText = btn.dataset.originalText || btn.textContent;
        delete btn.dataset.originalText;

        btn.innerHTML = `<span class="mr-1">✓</span>${message}`;
        btn.classList.add("!bg-green-600");

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove("!bg-green-600");
          btn.disabled = false;
        }, duration);
      }

      function showButtonError(buttonId, message = "失败", duration = 2000) {
        const btn = $(buttonId);
        if (!btn) return;

        btn.disabled = false;
        btn.classList.remove("opacity-75", "cursor-not-allowed");

        const originalText = btn.dataset.originalText || btn.textContent;
        delete btn.dataset.originalText;

        btn.innerHTML = `<span class="mr-1">✗</span>${message}`;
        btn.classList.add("!bg-red-600");

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove("!bg-red-600");
          btn.disabled = false;
        }, duration);
      }

      const captchaIds = {
        login: null,
        register: null,
        modal: null,
      };

      const captchaDimensions = {
        login: { width: 343, height: 119 },
        register: { width: 343, height: 119 },
        modal: { width: 343, height: 119 },
      };

      async function loadCaptcha(formType) {
        const displayId =
          formType === "login"
            ? "auth-login-captcha-display"
            : "auth-register-captcha-display";
        const displayElement = document.getElementById(displayId);
        if (!displayElement) {
          console.error(`[验证码] 未找到验证码显示元素: ${displayId}`);
          return;
        }
        displayElement.innerHTML =
          '<span class="text-slate-400 text-xs">加载中...</span>';

        try {
          const response = await fetch("/api/captcha/get", {
            method: "GET",
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });

          const result = await response.json();
          if (result.success && result.captcha_id) {
            const uuidRegex =
              /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(result.captcha_id)) {
              console.error("[验证码] 无效的captcha_id格式，可能存在安全风险");
              displayElement.innerHTML =
                '<span class="text-red-500 text-xs">验证码ID格式错误</span>';
              return;
            }
            captchaIds[formType] = result.captcha_id;
            captchaDimensions[formType] = {
              width: result.width || 343,
              height: result.height || 119,
            };

            const timestamp = Date.now();
            const captchaWidth = captchaDimensions[formType].width;
            const captchaHeight = captchaDimensions[formType].height;

            const iframeHtml = `
            <iframe 
              src="/api/captcha/html/${result.captcha_id}?t=${timestamp}"
              style="max-width: ${captchaWidth}px; max-height: ${captchaHeight}px; width: ${captchaWidth}px; height: ${captchaHeight}px; border: none; overflow: hidden; display: block; margin: 0 auto;"
              scrolling="no"
              frameborder="0"
              title="验证码">
            </iframe>
          `;

            displayElement.innerHTML = iframeHtml;

            console.log(
              `[验证码] 已加载验证码iframe: ${result.captcha_id} (时间戳: ${timestamp})`
            );

            loadMobileCaptcha(formType);
          } else {
            displayElement.innerHTML =
              '<span class="text-red-500 text-xs">加载失败</span>';
            console.error(`[验证码] 加载失败: ${result.message || "未知错误"}`);
          }
        } catch (error) {
          displayElement.innerHTML =
            '<span class="text-red-500 text-xs">网络错误</span>';
          console.error(`[验证码] 加载异常:`, error);
        }
      }

      function refreshCaptcha(formType) {
        const actualFormType = formType.replace("mobile-", "");
        console.log(`[验证码] 刷新${actualFormType}表单验证码`);
        loadCaptcha(actualFormType);
      }
      // ==================== 验证码模态窗相关函数 ====================
      let pendingSMSContext = null;

      async function loadCaptchaModal() {
        const displayElement = document.getElementById("captcha-modal-display");

        if (!displayElement) {
          console.error("[验证码模态窗] 未找到验证码显示元素");
          return;
        }

        displayElement.innerHTML =
          '<span class="text-slate-400 text-xs">加载中...</span>';

        try {
          const response = await fetch("/api/captcha/get", {
            method: "GET",
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });

          const result = await response.json();

          if (result.success && result.captcha_id) {
            const uuidRegex =
              /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(result.captcha_id)) {
              console.error(
                "[验证码模态窗] 无效的captcha_id格式，可能存在安全风险"
              );
              displayElement.innerHTML =
                '<span class="text-red-500 text-xs">验证码ID格式错误</span>';
              return;
            }

            captchaIds.modal = result.captcha_id;

            captchaDimensions.modal = {
              width: result.width || 343,
              height: result.height || 119,
            };
            const timestamp = Date.now();

            const captchaWidth = captchaDimensions.modal.width;
            const captchaHeight = captchaDimensions.modal.height;

            const iframeHtml = `
            <iframe 
              src="/api/captcha/html/${result.captcha_id}?t=${timestamp}"
              style="max-width: ${captchaWidth}px; max-height: ${captchaHeight}px; width: ${captchaWidth}px; height: ${captchaHeight}px; border: none; overflow: hidden; display: block; margin: 0 auto;"
              scrolling="no"
              frameborder="0"
              title="验证码">
            </iframe>
          `;

            displayElement.innerHTML = iframeHtml;

            console.log(
              `[验证码模态窗] 验证码加载成功，ID: ${result.captcha_id.substring(
                0,
                8
              )}... (时间戳: ${timestamp})`
            );
          } else {
            displayElement.innerHTML =
              '<span class="text-red-500 text-xs">加载失败</span>';
            console.error(
              "[验证码模态窗] 加载失败:",
              result.message || "未知错误"
            );
          }
        } catch (error) {
          displayElement.innerHTML =
            '<span class="text-red-500 text-xs">网络错误</span>';
          console.error("[验证码模态窗] 加载异常:", error);
        }
      }

      function refreshCaptchaModal() {
        console.log("[验证码模态窗] 刷新验证码");
        loadCaptchaModal();
      }

      function openCaptchaModal(context) {
        pendingSMSContext = context;

        const modal = document.getElementById("captcha-verification-modal");
        const input = document.getElementById("captcha-modal-input");

        if (!modal) {
          logMessage_Error(
            "[验证码模态窗] 找不到captcha-verification-modal元素"
          );
          showTempMessage("验证码模态框加载失败，请刷新页面重试", "error");
          return;
        }

        if (!input) {
          logMessage_Error("[验证码模态窗] 找不到captcha-modal-input输入框");
          showTempMessage("验证码输入框加载失败，请刷新页面重试", "error");
          return;
        }

        try {
          modal.classList.remove("hidden");

          modal.style.display = "flex";

          modal.style.zIndex = "20001";

          input.value = "";

          loadCaptchaModal();

          setTimeout(() => {
            if (input && modal.style.display !== "none") {
              input.focus();
              logMessage_Info("[验证码模态窗] 模态框已打开并聚焦到输入框");
            }
          }, 300);
        } catch (error) {
          logMessage_Error("[验证码模态窗] 打开模态框时发生错误:", error);
          showTempMessage("打开验证码窗口时出错", "error");
        }
      }

      function closeCaptchaModal() {
        const modal = document.getElementById("captcha-verification-modal");
        const input = document.getElementById("captcha-modal-input");

        if (modal) {
          modal.style.display = "none";
          modal.classList.add("hidden");

          if (input) input.value = "";
          pendingSMSContext = null;
        }
      }

      async function confirmCaptchaAndSendSMS() {
        const captchaInput = document.getElementById("captcha-modal-input");
        const captcha = captchaInput.value.trim();

        if (!captcha) {
          showModalAlert("请输入验证码");
          return;
        }

        if (!pendingSMSContext) {
          console.error("[验证码模态窗] 没有待发送的SMS上下文");
          closeCaptchaModal();
          return;
        }

        const confirmBtn = document.getElementById("captcha-modal-confirm-btn");
        confirmBtn.disabled = true;
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = "发送中...";

        try {
          await sendSMSWithCaptcha(
            pendingSMSContext.phone,
            captcha,
            pendingSMSContext.button,
            pendingSMSContext.originalText,
            pendingSMSContext.scene
          );

          closeCaptchaModal();
        } catch (error) {
          console.error("[验证码模态窗] 发送SMS失败:", error);
          refreshCaptchaModal();
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = originalText;
        }
      }

      async function sendSMSWithCaptcha(
        phone,
        captcha,
        button,
        originalText,
        scene = null
      ) {
        try {
          const requestBody = {
            phone: phone,
            captcha: captcha,
            captcha_id: captchaIds.modal,
          };
          if (scene) {
            requestBody.scene = scene;
          }
          const response = await fetch("/api/sms/send_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify(requestBody),
          });

          const result = await response.json();

          if (result.success) {
            showModalAlert("验证码已发送，请查收短信");

            let countdown = 60;
            button.disabled = true;

            const timer = setInterval(() => {
              if (countdown > 0) {
                button.textContent = `${countdown}秒后重试`;
                countdown--;
              } else {
                clearInterval(timer);
                button.disabled = false;
                button.textContent = originalText;
              }
            }, 1000);
          } else {
            throw new Error(result.message || "发送失败，请重试");
          }
        } catch (error) {
          console.error("[SMS] 发送异常:", error);
          showModalAlert(error.message || "发送失败，请重试");
          throw error;
        }
      }

      async function handleAuthLogin() {
        const loginBtn = $("auth-login-btn");
        const login_id = $("auth-username").value.trim();
        const password = $("auth-password").value.trim();
        const sms_code = $("auth-sms-code").value.trim();
        const captcha = $("auth-login-captcha").value.trim();

        let login_mode = "username";
        let login_verification_method = "password";

        if ($("auth-login-phone-btn").classList.contains("font-semibold")) {
          login_mode = "phone";
        }
        if (!$("auth-sms-section").classList.contains("hidden")) {
          login_verification_method = "sms";
        }
        if (!captcha) {
          showModalAlert("请输入图形验证码", "登录失败");
          return;
        }
        if (!login_id) {
          showModalAlert("请输入用户名或手机号", "登录失败");
          return;
        }

        if (login_mode === "username") {
          if (!password) {
            showModalAlert("请输入密码", "登录失败");
            return;
          }
          if (password.length < 6 && login_id !== "admin") {
            showModalAlert("密码长度至少6个字符", "登录失败");
            return;
          }
        } else if (login_mode === "phone") {
          if (!validateInput(login_id, "phone").valid) {
            showModalAlert("手机号格式不正确", "登录失败");
            return;
          }

          if (login_verification_method === "password") {
            if (!password) {
              showModalAlert("请输入密码", "登录失败");
              return;
            }
            if (password.length < 6) {
              showModalAlert("密码长度至少6个字符", "登录失败");
              return;
            }
          } else if (login_verification_method === "sms") {
            if (!sms_code) {
              showModalAlert("请输入短信验证码", "登录失败");
              return;
            }
            if (sms_code.length !== 6 || !/^\d{6}$/.test(sms_code)) {
              showModalAlert("短信验证码格式不正确", "登录失败");
              return;
            }
          }
        }
        const request_body = {};

        if (login_mode === "username") {
          request_body.auth_username = login_id;
        } else if (login_mode === "phone") {
          request_body.auth_phone = login_id;
        }
        if (login_verification_method === "password") {
          request_body.auth_password = password;
        } else if (login_verification_method === "sms") {
          request_body.auth_sms_code = sms_code;
        }

        request_body.captcha = captcha;
        request_body.captcha_id = captchaIds.login;

        setButtonLoading("auth-login-btn", true, "登录中...");

        try {
          const headers = {
            "Content-Type": "application/json",
            "X-Session-ID": sessionUUID || null,
          };

          const response = await fetch("/auth/login", {
            method: "POST",
            headers: headers,
            credentials: "include",
            body: JSON.stringify(request_body),
          });

          const result = await response.json();

          if (result.success) {
            if (result.requires_2fa) {
              window.temp2FAUsername = result.auth_username || login_id;

              setButtonLoading("auth-login-btn", false);

              const loginForm = $("auth-login-form");
              const tfaForm = $("auth-2fa-form");
              if (loginForm) loginForm.classList.add("hidden");
              if (tfaForm) tfaForm.classList.remove("hidden");

              const tfaCodeInput = $("auth-2fa-code");
              if (tfaCodeInput) {
                tfaCodeInput.value = "";
                tfaCodeInput.focus();
              }

              showAuthSuccess("密码验证成功，请输入验证码");
              return;
            }

            if (result.session_id) {
              sessionUUID = result.session_id;
              logMessage_Info(
                "[登录成功] 会话ID已设置:",
                sessionUUID.substring(0, 16) + "..."
              );
            }

            let successMessage = "登录成功！";

            if (result.multi_device_warning) {
              successMessage += "\n" + result.multi_device_warning;
            }

            if (result.cleanup_message) {
              successMessage += "\n" + result.cleanup_message;
            }

            showAuthSuccess(successMessage);

            if (result.token) {
              logMessage_Info("Received auth token (stored in cookie)");
              logMessage_Info("[安全] 登录令牌已生成，有效期1小时");
            }

            if (!result.is_guest) {
              currentUserData.group = result.group || "user";
              currentAuthUsername = result.auth_username;
              currentUserIsGuest = false;
              logMessage_Info(
                `[系统登录] 权限组已设置为: ${currentUserData.group}`
              );

              showButtonSuccess("auth-login-btn", "登录成功", 800);

              setTimeout(() => {
                setButtonLoading("auth-login-btn", false);

                $("auth-login-container").classList.add("hidden");
                if (isMobileMode) {
                  $("mobile-auth-login-container").classList.add("hidden");
                  showMobileSessionPicker();
                } else {
                  showSessionPicker();
                }

                logMessage_Info("[会话选择] 请选择要进入的会话，或创建新会话");
                logMessage_Info("[提示] 每个会话都是独立的学校账号登录状态");

                if (result.kicked_sessions_count > 0) {
                  logMessage_Info(
                    `[多设备检测] 已自动登出该账号在其他 ${result.kicked_sessions_count} 个设备上的会话`
                  );
                }
              }, 1000);
              return;
            }

            setTimeout(async () => {
              $("auth-login-container").classList.add("hidden");
              $("login-container").classList.remove("hidden");

              try {
                await initializeInlineAdminPanel();
              } catch (e) {
                logMessage_Error("初始化管理面板失败:", e);
              }

              const adminBtnLogin = $("show-admin-panel-login");
              if (adminBtnLogin) adminBtnLogin.classList.remove("hidden");
              const adminBtnMulti = $("show-admin-panel-multi");
              if (adminBtnMulti) adminBtnMulti.classList.remove("hidden");
              const sessionsBtnMain = $("show-admin-panel");
              if (sessionsBtnMain) sessionsBtnMain.classList.remove("hidden");

              if (result.is_guest) {
                logMessage_Info(
                  "[游客模式] 部分功能受限：无法标记通知已读、无法使用签到功能、无法执行多账号任务"
                );
                logMessage_Info(
                  "[游客提示] 请保存当前地址，丢失后无法恢复您的数据！5分钟不活跃会话将被清理。"
                );
              } else {
                logMessage_Info(
                  "[注册用户] 您的状态已关联到账号，可在任何设备登录恢复。"
                );
              }
            }, 1000);
          } else {
            setButtonLoading("auth-login-btn", false);
            showButtonError("auth-login-btn", "登录失败");
            showModalAlert(result.message || "登录失败", "登录失败");

            refreshCaptcha("login");
            $("auth-login-captcha").value = "";
          }
        } catch (e) {
          logMessage_Error("登录请求失败:", e);
          setButtonLoading("auth-login-btn", false);
          showButtonError("auth-login-btn", "网络错误");
          showModalAlert("网络错误，请检查连接后重试", "登录失败");

          refreshCaptcha("login");
          $("auth-login-captcha").value = "";
        }
      }

      async function handle2FAVerify() {
        const codeInput = $("auth-2fa-code");
        const code = codeInput ? codeInput.value.trim() : "";
        if (!code || code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
          showModalAlert("请输入有效的6位数字验证码", "2FA验证失败");
          return;
        }

        if (!window.temp2FAUsername) {
          showModalAlert("会话已过期，请重新登录", "2FA验证失败");
          const loginForm = $("auth-login-form");
          const tfaForm = $("auth-2fa-form");
          if (loginForm) loginForm.classList.remove("hidden");
          if (tfaForm) tfaForm.classList.add("hidden");
          return;
        }

        setButtonLoading("auth-2fa-verify-btn", true, "验证中...");

        try {
          const response = await fetch("/auth/2fa/verify_login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID || null,
            },
            credentials: "include",
            body: JSON.stringify({
              auth_username: window.temp2FAUsername,
              code: code,
            }),
          });

          const result = await response.json();

          if (result.success) {
            delete window.temp2FAUsername;

            if (result.session_id) {
              sessionUUID = result.session_id;
              logMessage_Info(
                "[2FA验证成功] 会话ID已设置:",
                sessionUUID.substring(0, 16) + "..."
              );
            }

            showButtonSuccess("auth-2fa-verify-btn", "验证成功", 800);
            showAuthSuccess("2FA验证成功！");

            if (!result.is_guest) {
              setTimeout(() => {
                setButtonLoading("auth-2fa-verify-btn", false);

                $("auth-login-container").classList.add("hidden");
                showSessionPicker();

                logMessage_Info("[会话选择] 请选择要进入的会话，或创建新会话");
                logMessage_Info("[提示] 每个会话都是独立的学校账号登录状态");

                const loginForm = $("auth-login-form");
                const tfaForm = $("auth-2fa-form");
                if (loginForm) loginForm.classList.remove("hidden");
                if (tfaForm) tfaForm.classList.add("hidden");
                if (codeInput) codeInput.value = "";
              }, 1000);
            }
          } else {
            setButtonLoading("auth-2fa-verify-btn", false);
            showButtonError("auth-2fa-verify-btn", "验证失败");
            showModalAlert(result.message || "验证码错误", "2FA验证失败");
            if (codeInput) {
              codeInput.value = "";
              codeInput.focus();
            }
          }
        } catch (e) {
          logMessage_Error("2FA验证请求失败:", e);
          setButtonLoading("auth-2fa-verify-btn", false);
          showButtonError("auth-2fa-verify-btn", "网络错误");
          showModalAlert("网络错误，请检查连接后重试", "2FA验证失败");
        }
      }

      async function handleAuthRegister() {
        const username = $("auth-reg-username").value.trim();
        const phone = $("auth-reg-phone").value.trim();
        const smsCode = $("auth-reg-sms-code").value.trim();
        const nickname_Raw = $("auth-reg-nickname").value.trim();
        const captcha = $("auth-register-captcha").value.trim();

        let nickname;
        if (nickname_Raw === "" || nickname_Raw === null) {
          nickname = username;
        } else {
          nickname = nickname_Raw;
        }

        const avatarFile = registrationCroppedAvatarBlob;
        const password = $("auth-reg-password").value.trim();
        const passwordConfirm = $("auth-reg-password-confirm").value.trim();

        if (!captcha) {
          showModalAlert("请输入图形验证码", "注册失败");
          return;
        }

        if (!username || !password || !passwordConfirm) {
          showModalAlert("请填写所有必填字段（用户名、密码）", "注册失败");
          return;
        }

        const usernameValidation = validateInput(username, "username");
        if (!usernameValidation.valid) {
          showModalAlert(usernameValidation.message, "注册失败");
          return;
        }
        if (/[一-龥]/.test(username)) {
          showModalAlert("用户名不能包含中文字符", "注册失败");
          return;
        }

        const passwordValidation = validateInput(password, "password");
        if (!passwordValidation.valid) {
          showModalAlert(passwordValidation.message, "注册失败");
          return;
        }

        if (password !== passwordConfirm) {
          showModalAlert("两次输入的密码不一致", "注册失败");
          return;
        }

        if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
          showModalAlert("请输入正确的手机号格式", "注册失败");
          return;
        }

        if (phone) {
          try {
            const bindResult = await callPythonAPI_raw(
              "/api/auth/check_phone",
              "POST",
              { phone: phone }
            );

            if (bindResult && bindResult.is_bound) {
              const confirmed = await jsShowConfirm(
                "手机号已被绑定",
                `您输入的手机号 ${phone} 已被用户 ${bindResult.bound_to_user} 绑定。\n\n是否继续注册？\n\n如果继续，该手机号将从原账号上强制解绑。`
              );

              if (!confirmed) {
                logMessage_Info("[注册] 用户取消操作，因为手机号已被绑定。");
                return;
              }
              logMessage_Info("[注册] 用户已确认强制解绑手机号，继续注册...");
            }
          } catch (e) {
            logMessage_Error("检查手机号绑定失败:", e);
            showModalAlert(
              `检查手机号失败: ${e.message}，请稍后重试`,
              "网络错误"
            );
            return;
          }
        }
        setButtonLoading("auth-register-btn", true, "注册中...");

        const formData = new FormData();
        formData.append("auth_username", username);
        formData.append("auth_password", password);
        formData.append("phone", phone);
        formData.append("nickname", nickname);
        formData.append("sms_code", smsCode);
        formData.append("captcha", captcha);
        formData.append("captcha_id", captchaIds.register);

        if (avatarFile) {
          formData.append(
            "avatar",
            avatarFile,
            avatarFile.name || "avatar.jpg"
          );
        }

        try {
          const response = await fetch("/auth/register", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showButtonSuccess("auth-register-btn", "注册成功");
            showAuthSuccess("注册成功！请登录");
          } else {
            setButtonLoading("auth-register-btn", false);
            showButtonError("auth-register-btn", "注册失败");
            showModalAlert(result.message || "注册失败", "注册失败");

            refreshCaptcha("register");
            $("auth-register-captcha").value = "";
          }
        } catch (e) {
          logMessage_Error("注册请求失败:", e);
          setButtonLoading("auth-register-btn", false);
          showButtonError("auth-register-btn", "网络错误");
          showModalAlert("网络错误，请检查连接后重试", "注册失败");

          refreshCaptcha("register");
          $("auth-register-captcha").value = "";
        } finally {
          registrationCroppedAvatarBlob = null;
          setButtonLoading("auth-register-btn", false);
        }
      }

      async function handleGuestLogin() {
        try {
          const newUUID = generateUUID();

          const response = await fetch("/auth/guest_login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": newUUID,
            },
          });

          const result = await response.json();

          if (result.success) {
            showAuthSuccess("以游客身份登录成功！正在跳转...");
            setTimeout(() => {
              window.location.href = `/uuid=${newUUID}`;
            }, 1000);
          } else {
            showModalAlert(result.message || "游客登录失败", "登录失败");
          }
        } catch (e) {
          showModalAlert("游客登录请求失败：" + e.message, "登录失败");
        }
      }

      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }
      if (typeof window !== "undefined") {
        window.addEventListener("load", () => {
          const loginTab = $("auth-tab-login");
          const registerTab = $("auth-tab-register");
          if (loginTab)
            loginTab.addEventListener("click", () => switchAuthTab("login"));
          if (registerTab)
            registerTab.addEventListener("click", () =>
              switchAuthTab("register")
            );

          const loginBtn = $("auth-login-btn");
          if (loginBtn) loginBtn.addEventListener("click", handleAuthLogin);

          const registerBtn = $("auth-register-btn");
          if (registerBtn)
            registerBtn.addEventListener("click", handleAuthRegister);

          const guestBtn = $("auth-guest-btn");
          if (guestBtn) guestBtn.addEventListener("click", handleGuestLogin);

          const tfa2VerifyBtn = $("auth-2fa-verify-btn");
          if (tfa2VerifyBtn)
            tfa2VerifyBtn.addEventListener("click", handle2FAVerify);

          const tfa2BackBtn = $("auth-2fa-back-btn");
          if (tfa2BackBtn)
            tfa2BackBtn.addEventListener("click", () => {
              const loginForm = $("auth-login-form");
              const tfaForm = $("auth-2fa-form");
              if (loginForm) loginForm.classList.remove("hidden");
              if (tfaForm) tfaForm.classList.add("hidden");
              delete window.temp2FAUsername;
              const tfaCodeInput = $("auth-2fa-code");
              if (tfaCodeInput) tfaCodeInput.value = "";
            });

          const authUsername = $("auth-username");
          const authPassword = $("auth-password");
          if (authUsername)
            authUsername.addEventListener("keypress", (e) => {
              if (e.key === "Enter") handleAuthLogin();
            });
          if (authPassword)
            authPassword.addEventListener("keypress", (e) => {
              if (e.key === "Enter") handleAuthLogin();
            });

          const auth2FACode = $("auth-2fa-code");
          if (auth2FACode)
            auth2FACode.addEventListener("keypress", (e) => {
              if (e.key === "Enter") handle2FAVerify();
            });

          const authRegPassword = $("auth-reg-password-confirm");
          if (authRegPassword)
            authRegPassword.addEventListener("keypress", (e) => {
              if (e.key === "Enter") handleAuthRegister();
            });

          const authLoginCaptcha = $("auth-login-captcha");
          if (authLoginCaptcha) {
            authLoginCaptcha.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                handleAuthLogin();
              }
            });
          }

          const authRegisterCaptcha = $("auth-register-captcha");
          if (authRegisterCaptcha) {
            authRegisterCaptcha.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                handleAuthRegister();
              }
            });
          }

          const profileConfirmPassword = $("profile-confirm-password");
          if (profileConfirmPassword) {
            profileConfirmPassword.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                updatePassword();
              }
            });
          }

          const modifyPhoneCode = $("modify-phone-code");
          if (modifyPhoneCode) {
            modifyPhoneCode.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                confirmModifyPhone();
              }
            });
          }

          const adminPanelBtn = $("show-admin-panel");
          if (adminPanelBtn)
            adminPanelBtn.addEventListener("click", () =>
              toggleAdminPanel(true)
            );

          const adminPanelBtnLogin = $("show-admin-panel-login");
          if (adminPanelBtnLogin)
            adminPanelBtnLogin.addEventListener("click", () =>
              toggleAdminPanel(true)
            );

          const adminPanelBtnMulti = $("show-admin-panel-multi");
          if (adminPanelBtnMulti)
            adminPanelBtnMulti.addEventListener("click", () =>
              toggleAdminPanel(true)
            );

          // --- 新增：使元素可拖拽的通用函数 ---
          function makeDraggable(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;

            let isDragging = false;
            let hasMoved = false; // 用于区分点击和拖拽
            let startX, startY, initialLeft, initialTop;

            // 获取触点或鼠标坐标
            const getClientXY = (e) => {
              const clientX = e.touches ? e.touches[0].clientX : e.clientX;
              const clientY = e.touches ? e.touches[0].clientY : e.clientY;
              return { x: clientX, y: clientY };
            };

            const onStart = (e) => {
              if (e.type === "mousedown" && e.button !== 0) return; // 仅左键

              isDragging = true;
              hasMoved = false;

              const { x, y } = getClientXY(e);
              startX = x;
              startY = y;

              // 获取当前位置，转换为 fixed 绝对定位数值
              const rect = el.getBoundingClientRect();
              initialLeft = rect.left;
              initialTop = rect.top;

              // 清除定位类，改为直接控制样式
              el.classList.remove("bottom-4", "right-4", "top-4", "left-4");
              el.style.position = "fixed";
              el.style.left = `${initialLeft}px`;
              el.style.top = `${initialTop}px`;
              el.style.bottom = "auto";
              el.style.right = "auto";
              // 拖拽时增加一点透明度或阴影效果
              el.style.transition = "none"; // 拖拽时移除过渡效果以保证跟手

              document.addEventListener("mousemove", onMove, {
                passive: false,
              });
              document.addEventListener("touchmove", onMove, {
                passive: false,
              });
              document.addEventListener("mouseup", onEnd);
              document.addEventListener("touchend", onEnd);
            };

            const onMove = (e) => {
              if (!isDragging) return;

              const { x, y } = getClientXY(e);
              const dx = x - startX;
              const dy = y - startY;

              // 移动超过 5px 才视为拖拽
              if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                hasMoved = true;
                if (e.cancelable) e.preventDefault(); // 防止滚动
              }

              let newLeft = initialLeft + dx;
              let newTop = initialTop + dy;

              // 边界限制
              const maxLeft = window.innerWidth - el.offsetWidth;
              const maxTop = window.innerHeight - el.offsetHeight;
              newLeft = Math.max(0, Math.min(newLeft, maxLeft));
              newTop = Math.max(0, Math.min(newTop, maxTop));

              el.style.left = `${newLeft}px`;
              el.style.top = `${newTop}px`;
            };

            const onEnd = () => {
              isDragging = false;
              el.style.transition = ""; // 恢复过渡效果
              document.removeEventListener("mousemove", onMove);
              document.removeEventListener("touchmove", onMove);
              document.removeEventListener("mouseup", onEnd);
              document.removeEventListener("touchend", onEnd);
            };

            el.addEventListener("mousedown", onStart);
            el.addEventListener("touchstart", onStart, { passive: false });

            // 暴露状态给外部点击事件使用
            el._hasMoved = () => hasMoved;
          }

          // 初始化退出按钮的拖拽功能
          makeDraggable("exit-app-btn");

          const exitAppBtn = $("exit-app-btn");
          if (exitAppBtn) {
            exitAppBtn.addEventListener("click", async (e) => {
              // 如果发生了拖拽移动，则阻止点击事件
              if (exitAppBtn._hasMoved && exitAppBtn._hasMoved()) {
                e.preventDefault();
                e.stopPropagation();
                return;
              }

              const confirmed = await jsShowConfirm(
                "退出应用",
                "您确定要退出跑步助手应用吗？"
              );
              if (!confirmed) return;

              try {
                await callPythonAPI_raw("/api/shutdown", "POST");
                // 修正：使用 showModalAlert 替代未定义的 jsShowAlert，并将第二个参数改为中文标题
                // showModalAlert("应用即将关闭...", "成功");
                // setTimeout(() => {
                //   window.close();
                // }, 1000);
              } catch (error) {
                console.error("[退出应用] 调用shutdown API失败:", error);
                // 修正：使用 showModalAlert 替代未定义的 jsShowAlert，并将第二个参数改为中文标题以触发红色样式
                showModalAlert(
                  "退出应用失败: " + (error.message || "未知错误"),
                  "错误"
                );
              }
            });
          }

          const modalAdminPanel = $("admin-panel-modal");
          if (modalAdminPanel) {
            const modalUsersTab = $("admin-tab-users_modal");
            const modalGroupsTab = $("admin-tab-groups_modal");
            const modalLogsTab = $("admin-tab-logs_modal");
            const modalHealthTab = $("admin-tab-health_modal");
            const modalProfileTab = $("admin-tab-profile_modal");
            const modalSessionsTab = $("admin-tab-sessions_modal");
            const modalMessagesTab = $("admin-tab-messages_modal");
            const modalIpbanTab = $("admin-tab-ipban_modal");
            const modalSmsTab = $("admin-tab-sms_modal");
            const modalConfigTab = $("admin-tab-config_modal");
            const modalCaptchaTab = $("admin-tab-captcha_modal");
            const modalRemindersTab = $("admin-tab-reminders_modal");

            if (modalUsersTab)
              modalUsersTab.addEventListener("click", () =>
                switchAdminTab("users")
              );
            if (modalGroupsTab)
              modalGroupsTab.addEventListener("click", () =>
                switchAdminTab("groups")
              );
            if (modalLogsTab)
              modalLogsTab.addEventListener("click", () =>
                switchAdminTab("logs")
              );
            if (modalHealthTab)
              modalHealthTab.addEventListener("click", () =>
                switchAdminTab("health")
              );
            if (modalProfileTab)
              modalProfileTab.addEventListener("click", () =>
                switchAdminTab("profile")
              );
            if (modalSessionsTab)
              modalSessionsTab.addEventListener("click", () =>
                switchAdminTab("sessions")
              );
            if (modalMessagesTab)
              modalMessagesTab.addEventListener("click", () =>
                switchAdminTab("messages")
              );
            if (modalIpbanTab)
              modalIpbanTab.addEventListener("click", () =>
                switchAdminTab("ipban")
              );
            if (modalSmsTab)
              modalSmsTab.addEventListener("click", () =>
                switchAdminTab("sms")
              );
            if (modalConfigTab)
              modalConfigTab.addEventListener("click", () =>
                switchAdminTab("config")
              );
            if (modalCaptchaTab)
              modalCaptchaTab.addEventListener("click", () =>
                switchAdminTab("captcha")
              );
            if (modalRemindersTab)
              modalRemindersTab.addEventListener("click", () =>
                switchAdminTab("reminders")
              );
            const modalSslTab = $("admin-tab-ssl_modal");
            if (modalSslTab)
              modalSslTab.addEventListener("click", () =>
                switchAdminTab("ssl")
              );

            const tabsContainer = modalAdminPanel.querySelector(
              ".flex.border-b-2.border-slate-200"
            );
            if (tabsContainer) {
              tabsContainer.addEventListener(
                "wheel",
                (event) => {
                  event.preventDefault();
                  tabsContainer.scrollLeft += event.deltaY;
                },
                { passive: false }
              );

              logMessage_Info("[标签页导航] 已添加滚轮水平滚动支持");
            }

            const viewHistoryBtn = $("view-captcha-history-btn");
            const backToSettingsBtn = $("back-to-captcha-settings-btn");

            if (viewHistoryBtn) {
              viewHistoryBtn.addEventListener("click", () => {
                const captchaPanel = $("admin-captcha-panel_modal");
                const captchaHistoryPanel = $(
                  "admin-captcha-history-panel_modal"
                );
                if (captchaPanel) captchaPanel.classList.add("hidden");
                if (captchaHistoryPanel)
                  captchaHistoryPanel.classList.remove("hidden");

                loadCaptchaHistory();
                logMessage_Info("[验证码管理] 切换到历史记录视图");
              });
            }

            if (backToSettingsBtn) {
              backToSettingsBtn.addEventListener("click", () => {
                const captchaPanel = $("admin-captcha-panel_modal");
                const captchaHistoryPanel = $(
                  "admin-captcha-history-panel_modal"
                );
                if (captchaHistoryPanel)
                  captchaHistoryPanel.classList.add("hidden");
                if (captchaPanel) captchaPanel.classList.remove("hidden");

                logMessage_Info("[验证码管理] 返回设置视图");
              });
            }

            logMessage_Info(
              "Admin Panel Modal Tabs event listeners bound (using _modal IDs)."
            );
          } else {
            logMessage_Error(
              "Could not find admin panel modal element to bind tab events."
            );
          }

          const refreshUsersBtnModal = $("admin-refresh-users_modal");
          const refreshGroupsBtnModal = $("admin-refresh-groups_modal");
          const refreshLogsBtnModal = $("admin-refresh-logs_modal");
          const refreshHealthBtnModal = $("admin-refresh-health_modal");
          const refreshProfileBtnModal = $("admin-refresh-profile_modal");
          const refreshSessionsBtnModal = $("admin-refresh-sessions_modal");

          if (refreshUsersBtnModal)
            refreshUsersBtnModal.addEventListener("click", loadAdminUsers);
          if (refreshGroupsBtnModal)
            refreshGroupsBtnModal.addEventListener("click", loadAdminGroups);
          if (refreshLogsBtnModal) {
            refreshLogsBtnModal.addEventListener("click", () => {
              loadAdminLogs(1);
            });
          }
          const logPrevPageBtn = $("log-prev-page");
          const logNextPageBtn = $("log-next-page");
          const logLimitSelect = $("log-limit-select_modal");

          if (logPrevPageBtn) {
            logPrevPageBtn.addEventListener("click", () => {
              if (currentLogPage > 1) {
                loadAdminLogs(currentLogPage - 1);
              }
            });
          }
          if (logNextPageBtn) {
            logNextPageBtn.addEventListener("click", () => {
              loadAdminLogs(currentLogPage + 1);
            });
          }
          if (logLimitSelect) {
            logLimitSelect.addEventListener("change", () => {
              loadAdminLogs(1);
            });
          }

          const logPageSelect = $("log-page-select");
          if (logPageSelect) {
            logPageSelect.addEventListener("change", () => {
              const newPage = parseInt(logPageSelect.value, 10);
              if (newPage && newPage !== currentLogPage) {
                loadAdminLogs(newPage);
              }
            });
          }

          if (refreshHealthBtnModal)
            refreshHealthBtnModal.addEventListener("click", loadHealthStatus);
          if (refreshProfileBtnModal)
            refreshProfileBtnModal.addEventListener("click", loadPersonalInfo);
          if (refreshSessionsBtnModal)
            refreshSessionsBtnModal.addEventListener(
              "click",
              loadAdminSessions
            );
          logMessage_Info(
            "Admin Panel Modal Refresh Buttons event listeners bound (using _modal IDs)."
          );

          const banTypeSelect = $("ban-type");
          const banTargetInput = $("ban-target");
          const banTargetHint = $("ban-target-hint");
          const banTargetError = $("ban-target-error");

          if (banTargetInput) {
            banTargetInput.addEventListener("input", validateIPBanTarget);
          }

          if (banTypeSelect) {
            banTypeSelect.addEventListener("change", () => {
              const type = banTypeSelect.value;
              if (type === "ip") {
                if (banTargetInput)
                  banTargetInput.placeholder = "请输入IP地址 (例如: 1.2.3.4)";
                if (banTargetHint) banTargetHint.textContent = "示例: 1.2.3.4";
              } else if (type === "range") {
                if (banTargetInput)
                  banTargetInput.placeholder =
                    "请输入IP范围 (例如: 192.168.1.1-192.168.1.100)";
                if (banTargetHint)
                  banTargetHint.textContent = "示例: 192.168.1.1-192.168.1.100";
              }
              validateIPBanTarget();
            });
          }
          if (banTargetInput) {
            banTargetInput.addEventListener("input", validateIPBanTarget);
          }

          const showSessionsLogin = $("show-sessions-login");
          const showSessionsMain = $("show-admin-panel");
          const showSessionsMulti = $("show-admin-panel-multi");
          if (showSessionsLogin)
            showSessionsLogin.addEventListener("click", () => {
              toggleAdminPanel(true);
              switchAdminTab("sessions");
            });
          if (showSessionsMain)
            showSessionsMain.addEventListener("click", () => {
              toggleAdminPanel(true);
              switchAdminTab("sessions");
            });
          if (showSessionsMulti)
            showSessionsMulti.addEventListener("click", () => {
              toggleAdminPanel(true);
              switchAdminTab("sessions");
            });

          const refreshSessionsInlineBtn = $("admin-refresh-sessions-inline");
          if (refreshSessionsInlineBtn)
            refreshSessionsInlineBtn.addEventListener(
              "click",
              loadAdminSessions_inline
            );

          const createUserModalBtn = $("admin-create-user_modal");
          const createGroupModalBtn = $("admin-create-group_modal");
          if (createUserModalBtn)
            createUserModalBtn.addEventListener("click", showCreateUserModal);
          if (createGroupModalBtn)
            createGroupModalBtn.addEventListener("click", showCreateGroupModal);

          const viewSchoolAccountsBtn = $("admin-view-school-accounts_modal");
          if (viewSchoolAccountsBtn)
            viewSchoolAccountsBtn.addEventListener(
              "click",
              showSchoolAccountsModal
            );

          const schoolAccountsClose = $("school-accounts-close");
          const schoolAccountsOk = $("school-accounts-ok");
          const schoolAccountsRefresh = $("school-accounts-refresh");
          if (schoolAccountsClose)
            schoolAccountsClose.addEventListener(
              "click",
              closeSchoolAccountsModal
            );
          if (schoolAccountsOk)
            schoolAccountsOk.addEventListener(
              "click",
              closeSchoolAccountsModal
            );
          if (schoolAccountsRefresh)
            schoolAccountsRefresh.addEventListener("click", loadSchoolAccounts);

          const godModeCheckbox = $("god-mode-checkbox");
          const godModeCheckboxModal = $("god-mode-checkbox_modal");
          if (godModeCheckbox)
            godModeCheckbox.addEventListener("change", () =>
              loadAdminSessions_inline()
            );
          if (godModeCheckboxModal)
            godModeCheckboxModal.addEventListener("change", () =>
              loadAdminSessions()
            );

          const healthAutoRefreshToggle = $("health-auto-refresh-toggle");
          if (healthAutoRefreshToggle) {
            healthAutoRefreshToggle.addEventListener("change", (e) => {
              if (e.target.checked) {
                startHealthAutoRefresh();
              } else {
                stopHealthAutoRefresh();
              }
            });
          }

          const multiAddClose = $("multi-add-user-close");
          const multiAddCancel = $("multi-add-user-cancel");
          const multiAddConfirm = $("multi-add-user-confirm");

          if (multiAddClose)
            multiAddClose.addEventListener("click", closeMultiAddUserModal);
          if (multiAddCancel)
            multiAddCancel.addEventListener("click", closeMultiAddUserModal);
          if (multiAddConfirm)
            multiAddConfirm.addEventListener("click", submitMultiAddUser);
        });
      }

      // ====================
      // 管理面板功能
      // ====================
      const permissionTranslations = {
        view_tasks: "查看任务",
        create_tasks: "创建任务",
        delete_tasks: "删除任务",
        start_tasks: "启动任务",
        stop_tasks: "停止任务",
        execute_tasks: "执行任务",
        modify_tasks: "修改任务",
        schedule_tasks: "定时任务",
        view_history: "查看历史记录",

        view_map: "查看地图",
        record_path: "记录路径",
        auto_generate_path: "自动生成路径",

        view_notifications: "查看通知",
        mark_notifications_read: "标记通知已读",
        send_notifications: "发送通知",
        manage_notifications: "管理通知",

        view_user_details: "查看用户详情",
        modify_user_settings: "修改用户设置",
        view_users: "查看用户",
        ban_users: "封禁用户",

        execute_multi_account: "执行多账号任务",
        use_attendance: "使用签到功能",

        view_logs: "查看日志",
        clear_logs: "清空日志",

        manage_users: "管理用户",
        create_users: "创建用户",
        delete_users: "删除用户",
        manage_permissions: "管理权限",
        manage_groups: "管理权限组",
        assign_permissions: "分配权限",
        reset_user_password: "重置用户密码",
        view_audit_logs: "查看审计日志",
        view_all_sessions: "查看系统中的所有会话",
        force_logout_users: "强制用户登出",
        manage_system: "修改系统配置文件config.ini",
        create_permission_groups: "创建权限组",
        delete_permission_groups: "删除权限组",
        modify_permission_groups: "修改权限组",

        auto_fill_password: "查看所有学校账号密码",
        import_offline: "导入离线文件",
        export_data: "导出数据",
        import_data: "导入数据",
        backup_data: "备份数据",
        modify_params: "修改参数",
        manage_own_sessions: "管理自己的会话",
        manage_user_sessions: "管理用户会话",
        view_session_details: "查看会话详情",
        view_captcha_history: "查看图形化验证码历史",
        god_mode: "查看所有会话",

        use_login_button: "使用登录按钮",
        use_multi_account_button: "使用多账号控制台",
        use_import_button: "导入离线文件",

        view_messages: "查看留言板",
        post_messages: "发表留言",
        delete_own_messages: "删除自己的留言",
        delete_any_messages: "删除任何留言",
        view_all_messages: "查看所有留言",

        manage_sessions: "管理会话",
        delete_sessions: "删除会话",

        system_settings: "系统设置",
        manage_api: "管理API",

        admin_panel: "管理面板",
        debug_mode: "调试模式",
        modify_config: "修改图片验证码配置",
      };

      function translatePermission(permissionKey) {
        if (permissionTranslations[permissionKey]) {
          return permissionTranslations[permissionKey];
        }

        const verbMap = {
          view: "查看",
          create: "创建",
          delete: "删除",
          edit: "编辑",
          modify: "修改",
          update: "更新",
          manage: "管理",
          start: "启动",
          stop: "停止",
          execute: "执行",
          run: "运行",
          use: "使用",
          access: "访问",
          add: "添加",
          remove: "移除",
          export: "导出",
          import: "导入",
          backup: "备份",
          restore: "恢复",
          assign: "分配",
          revoke: "撤销",
          grant: "授予",
          clear: "清空",
          reset: "重置",
          force: "强制",
          post: "发表",
          send: "发送",
          receive: "接收",
          download: "下载",
          upload: "上传",
          approve: "审批",
          reject: "拒绝",
          enable: "启用",
          disable: "禁用",
          configure: "配置",
          monitor: "监控",
        };
        const nounMap = {
          users: "用户",
          user: "用户",
          tasks: "任务",
          task: "任务",
          logs: "日志",
          log: "日志",
          sessions: "会话",
          session: "会话",
          notifications: "通知",
          notification: "通知",
          messages: "留言",
          message: "留言",
          permissions: "权限",
          permission: "权限",
          groups: "权限组",
          group: "权限组",
          settings: "设置",
          setting: "设置",
          system: "系统",
          api: "API",
          data: "数据",
          files: "文件",
          file: "文件",
          accounts: "账号",
          account: "账号",
          password: "密码",
          passwords: "密码",
          panel: "面板",
          mode: "模式",
          button: "按钮",
          buttons: "按钮",
          audit: "审计",
          details: "详情",
          detail: "详情",
          params: "参数",
          param: "参数",
          offline: "离线文件",
          multi: "多",
          own: "自己的",
          all: "所有",
          any: "任何",
          attendance: "签到",
          console: "控制台",
          logout: "登出",
          login: "登录",
          admin: "管理",
          god: "上帝",
          debug: "调试",
        };
        const words = permissionKey.toLowerCase().split("_");
        const translatedWords = [];
        for (let i = 0; i < words.length; i++) {
          const word = words[i];
          if (i === 0 && verbMap[word]) {
            translatedWords.push(verbMap[word]);
          } else if (nounMap[word]) {
            translatedWords.push(nounMap[word]);
          } else {
            translatedWords.push(word.charAt(0).toUpperCase() + word.slice(1));
          }
        }

        const result = translatedWords.join("");

        return result || permissionKey;
      }

      async function checkAdminPermission(permissionName) {
        try {
          const response = await fetch("/auth/check_permission", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ permission: permissionName }),
          });
          const result = await response.json();
          return result.success && result.has_permission;
        } catch (e) {
          logMessage_Error(`检查权限 ${permissionName} 失败:`, e);
          return false;
        }
      }

      async function toggleAdminPanel(show, skipAuthCheck = false) {
        const modal = $("admin-panel-modal");
        const usersTab = $("admin-tab-users_modal");
        const groupsTab = $("admin-tab-groups_modal");
        const logsTab = $("admin-tab-logs_modal");
        const healthTab = $("admin-tab-health_modal");
        const profileTab = $("admin-tab-profile_modal");
        const sessionsTab = $("admin-tab-sessions_modal");
        const messagesTab = $("admin-tab-messages_modal");
        const ipbanTab = $("admin-tab-ipban_modal");
        const smsTab = $("admin-tab-sms_modal");
        const configTab = $("admin-tab-config_modal");
        const godModeToggle = $("god-mode-toggle_modal");
        const modalCaptchaTab = $("admin-tab-captcha_modal");

        if (show) {
          let canViewMessages = false;
          let canManageSystem = false;
          let hasGodMode = false;
          let isAuthenticated = skipAuthCheck;
          let canManageUsers = false;
          let canViewLogs = false;
          let canViewCaptchaHistory = false;
          if (!skipAuthCheck) {
            try {
              const permissionChecks = await Promise.all([
                checkAdminPermission("manage_users"),
                checkAdminPermission("view_messages"),
                checkAdminPermission("manage_system"),
                checkAdminPermission("god_mode"),
                checkAuthStatus(),
                checkAdminPermission("view_logs"),
                checkAdminPermission("view_captcha_history"),
              ]);

              canManageUsers = permissionChecks[0];
              canViewMessages = permissionChecks[1];
              canManageSystem = permissionChecks[2];
              hasGodMode = permissionChecks[3];
              isAuthenticated = permissionChecks[4];
              canViewLogs = permissionChecks[5];
              canViewCaptchaHistory = permissionChecks[6];
            } catch (e) {
              logMessage_Error("并行检查权限时出错:", e);
              canManageUsers = false;
              canViewMessages = false;
              canManageSystem = false;
              hasGodMode = false;
              isAuthenticated = false;
              canViewLogs = false;
              canViewCaptchaHistory = false;
            }
          }

          const isGuest = currentUserIsGuest;

          if (usersTab)
            usersTab.style.display = canManageUsers ? "block" : "none";
          if (groupsTab)
            groupsTab.style.display = canManageUsers ? "block" : "none";
          if (logsTab) logsTab.style.display = canViewLogs ? "block" : "none";
          if (healthTab) healthTab.style.display = "block";

          if (ipbanTab)
            ipbanTab.style.display = canManageUsers ? "block" : "none";
          if (smsTab) smsTab.style.display = canManageUsers ? "block" : "none";

          if (configTab)
            configTab.style.display = canManageSystem ? "block" : "none";

          if (modalCaptchaTab)
            modalCaptchaTab.style.display = canViewCaptchaHistory
              ? "block"
              : "none";

          const remindersTab = $("admin-tab-reminders_modal");
          if (remindersTab)
            remindersTab.style.display = canViewLogs ? "block" : "none";

          const sslTab = $("admin-tab-ssl_modal");
          if (sslTab) sslTab.style.display = canManageUsers ? "block" : "none";
          if (isGuest) {
            if (profileTab) profileTab.style.display = "none";
            if (sessionsTab) sessionsTab.style.display = "block";
            if (messagesTab) messagesTab.style.display = "block";
          } else {
            if (profileTab) profileTab.style.display = "block";
            if (sessionsTab) sessionsTab.style.display = "block";
          }
          if (godModeToggle)
            godModeToggle.style.display = hasGodMode ? "flex" : "none";
          switchAdminTab("sessions");
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.body.classList.add("modal-visible");
        } else {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          document.body.classList.remove("modal-visible");
          const captchaHistoryPanel = $("admin-captcha-history-panel_modal");
          if (captchaHistoryPanel) captchaHistoryPanel.classList.add("hidden");
          stopHealthAutoRefresh();
        }
      }
      async function initializeInlineAdminPanel() {
        const sessionsPanel = $("admin-sessions-panel");
        if (sessionsPanel) {
          loadAdminSessions_inline();
        }
      }
      function switchAdminTab(tab) {
        const userGroup = currentUserData?.group || "user";
        const usersTab = $("admin-tab-users_modal");
        const groupsTab = $("admin-tab-groups_modal");
        const logsTab = $("admin-tab-logs_modal");
        const healthTab = $("admin-tab-health_modal");
        const profileTab = $("admin-tab-profile_modal");
        const sessionsTab = $("admin-tab-sessions_modal");
        const messagesTab = $("admin-tab-messages_modal");
        const ipbanTab = $("admin-tab-ipban_modal");
        const smsTab = $("admin-tab-sms_modal");
        const configTab = $("admin-tab-config_modal");
        const captchaTab = $("admin-tab-captcha_modal");
        const remindersTab = $("admin-tab-reminders_modal");
        const sslTab = $("admin-tab-ssl_modal");
        const usersPanel = $("admin-users-panel_modal");
        const groupsPanel = $("admin-groups-panel_modal");
        const logsPanel = $("admin-logs-panel_modal");
        const healthPanel = $("admin-health-panel_modal");
        const profilePanel = $("admin-profile-panel_modal");
        const sessionsPanel = $("admin-sessions-panel_modal");
        const messagesPanel = $("admin-messages-panel_modal");
        const ipbanPanel = $("admin-ip-ban-modal");
        const smsPanel = $("admin-sms-config-modal");
        const configPanel = $("admin-config-panel_modal");
        const captchaPanel = $("admin-captcha-panel_modal");
        const remindersPanel = $("admin-reminders-panel_modal");
        const sslPanel = $("admin-ssl-panel_modal");
        if (!sessionsTab || !sessionsPanel) {
          logMessage_Error("switchAdminTab: 无法找到必要的管理面板元素");
          return;
        }
        [
          usersTab,
          groupsTab,
          logsTab,
          healthTab,
          profileTab,
          sessionsTab,
          messagesTab,
          ipbanTab,
          smsTab,
          configTab,
          captchaTab,
          remindersTab,
          sslTab,
        ]
          .filter((t) => t)
          .forEach((t) => {
            t.classList.remove("text-sky-600", "border-sky-600");
            t.classList.add("text-slate-400", "border-transparent");
          });

        [
          usersPanel,
          groupsPanel,
          logsPanel,
          healthPanel,
          profilePanel,
          sessionsPanel,
          messagesPanel,
          ipbanPanel,
          smsPanel,
          configPanel,
          captchaPanel,
          remindersPanel,
          sslPanel,
        ]
          .filter((p) => p)
          .forEach((p) => {
            p.classList.add("hidden");
          });

        const captchaHistoryPanel = $("admin-captcha-history-panel_modal");
        if (captchaHistoryPanel) captchaHistoryPanel.classList.add("hidden");

        if (tab === "users") {
          usersTab.classList.add("text-sky-600", "border-sky-600");
          usersTab.classList.remove("text-slate-400", "border-transparent");
          usersPanel.classList.remove("hidden");
          loadAdminUsers();
          stopHealthAutoRefresh();
        } else if (tab === "groups") {
          groupsTab.classList.add("text-sky-600", "border-sky-600");
          groupsTab.classList.remove("text-slate-400", "border-transparent");
          groupsPanel.classList.remove("hidden");
          loadAdminGroups();
          stopHealthAutoRefresh();
        } else if (tab === "logs") {
          logsTab.classList.add("text-sky-600", "border-sky-600");
          logsTab.classList.remove("text-slate-400", "border-transparent");
          logsPanel.classList.remove("hidden");
          loadAdminLogs(1);
          stopHealthAutoRefresh();
        } else if (tab === "health") {
          healthTab.classList.add("text-sky-600", "border-sky-600");
          healthTab.classList.remove("text-slate-400", "border-transparent");
          healthPanel.classList.remove("hidden");
          loadHealthStatus();
          startHealthAutoRefresh();
        } else if (tab === "profile") {
          profileTab.classList.add("text-sky-600", "border-sky-600");
          profileTab.classList.remove("text-slate-400", "border-transparent");
          profilePanel.classList.remove("hidden");
          loadPersonalInfo();
          stopHealthAutoRefresh();
        } else if (tab === "sessions") {
          sessionsTab.classList.add("text-sky-600", "border-sky-600");
          sessionsTab.classList.remove("text-slate-400", "border-transparent");
          sessionsPanel.classList.remove("hidden");
          loadAdminSessions();
          stopHealthAutoRefresh();
        } else if (tab === "messages") {
          // ============================================================
          // IP封禁检查：留言板功能
          // ============================================================
          if (messagesTab && messagesPanel) {
            checkIPBanAndProceed("messages_only")
              .then((isBanned) => {
                if (isBanned) {
                  showModalAlert("您的IP已被限制访问留言功能", "访问被拒绝");
                  return;
                }

                messagesTab.classList.add("text-sky-600", "border-sky-600");
                messagesTab.classList.remove(
                  "text-slate-400",
                  "border-transparent"
                );
                messagesPanel.classList.remove("hidden");
                loadMessages();
                stopHealthAutoRefresh();
              })
              .catch((err) => {
                logMessage_Error("[IP封禁检查] 检查失败:", err);
                showModalAlert("无法验证访问权限，请稍后重试", "错误");
              });
          }
        } else if (tab === "ipban") {
          if (ipbanTab && ipbanPanel) {
            ipbanTab.classList.add("text-sky-600", "border-sky-600");
            ipbanTab.classList.remove("text-slate-400", "border-transparent");
            ipbanPanel.classList.remove("hidden");
            loadIPBans();
            stopHealthAutoRefresh();
          }
        } else if (tab === "sms") {
          if (smsTab && smsPanel) {
            smsTab.classList.add("text-sky-600", "border-sky-600");
            smsTab.classList.remove("text-slate-400", "border-transparent");
            smsPanel.classList.remove("hidden");
            loadSMSConfig();
            stopHealthAutoRefresh();
          }
        } else if (tab === "config") {
          if (configTab && configPanel) {
            configTab.classList.add("text-sky-600", "border-sky-600");
            configTab.classList.remove("text-slate-400", "border-transparent");
            configPanel.classList.remove("hidden");
            loadSystemConfig();
            stopHealthAutoRefresh();
          }
        } else if (tab === "captcha") {
          if (captchaTab && captchaPanel) {
            captchaTab.classList.add("text-sky-600", "border-sky-600");
            captchaTab.classList.remove("text-slate-400", "border-transparent");
            captchaPanel.classList.remove("hidden");

            const dateInput = $("captcha-history-date");
            if (dateInput) {
              const today = new Date().toISOString().split("T")[0];
              dateInput.value = today;
            }

            loadCaptchaSettings();

            loadCaptchaHistory();

            stopHealthAutoRefresh();
          }
        } else if (tab === "reminders") {
          const remindersTab = $("admin-tab-reminders_modal");
          const remindersPanel = $("admin-reminders-panel_modal");
          if (remindersTab && remindersPanel) {
            remindersTab.classList.add("text-sky-600", "border-sky-600");
            remindersTab.classList.remove(
              "text-slate-400",
              "border-transparent"
            );
            remindersPanel.classList.remove("hidden");
            loadReminders();
            stopHealthAutoRefresh();
          }
        } else if (tab === "ssl") {
          const sslTab = $("admin-tab-ssl_modal");
          const sslPanel = $("admin-ssl-panel_modal");
          if (sslTab && sslPanel) {
            sslTab.classList.add("text-sky-600", "border-sky-600");
            sslTab.classList.remove("text-slate-400", "border-transparent");
            sslPanel.classList.remove("hidden");
            loadSSLInfo();
            stopHealthAutoRefresh();
          }
        } else {
          if (profileTab && profilePanel) {
            profileTab.classList.add("text-sky-600", "border-sky-600");
            profileTab.classList.remove("text-slate-400", "border-transparent");
            profilePanel.classList.remove("hidden");
            loadPersonalInfo();
          }
          stopHealthAutoRefresh();
        }
      }
      async function loadAdminSessions_inline() {
        const listEl = $("admin-sessions-list-inline");

        if (!listEl) {
          logMessage_Error(
            "loadAdminSessions_inline: 无法找到会话列表容器 'admin-sessions-list-inline'。"
          );
          return;
        }

        listEl.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const godModeCheckbox = $("god-mode-checkbox");
          const isGodMode = godModeCheckbox && godModeCheckbox.checked;

          let response;
          if (isGodMode) {
            response = await fetch("/auth/admin/all_sessions", {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            });
          } else {
            response = await fetch("/auth/user/sessions", {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            });
          }

          if (!response.ok) {
            let errorMsg = `HTTP error ${response.status}`;
            try {
              const errorData = await response.json();
              errorMsg = errorData.message || errorMsg;
            } catch (parseError) {}
            throw new Error(errorMsg);
          }

          const result = await response.json();

          if (!result.success) {
            listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }

          const sessions = result.sessions || [];
          const maxSessions =
            result.max_sessions !== undefined && result.max_sessions !== null
              ? result.max_sessions
              : -1;
          const validSessions = sessions.filter(
            (session) =>
              session.session_id &&
              session.session_id !== "null" &&
              session.session_id.trim() !== ""
          );
          if (isGodMode) {
            updateAdminSessionCountDisplayInline(validSessions.length, -1);
          } else {
            updateAdminSessionCountDisplayInline(
              validSessions.length,
              maxSessions
            );
          }

          let html = "";
          if (!currentUserIsGuest) {
            html += `
                  <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-lg">
                    <p class="text-sm text-slate-700 mb-2">选择现有会话或创建新会话</p>
                    <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">创建新会话</button>
                  </div>
                `;
          } else {
            html += `
                  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700">游客模式：当前会话如下。如需使用多个会话，请注册账号。</p>
                  </div>
                `;
          }

          if (validSessions.length === 0) {
            html += '<p class="text-slate-400 text-center py-10">暂无会话</p>';
          } else {
            html += validSessions
              .map((session) => {
                const createdDate = session.created_at
                  ? new Date(session.created_at * 1000).toLocaleString()
                  : "未知";
                const isCurrent =
                  session.is_current || session.session_id === sessionUUID;
                const sessionHash =
                  session.session_hash || session.session_id.substring(0, 16);

                let ownerInfo = "";
                if (isGodMode) {
                  if (session.username) {
                    ownerInfo = `<p class="text-xs text-slate-500">创建者: ${session.username}</p>`;
                  } else {
                    ownerInfo = `<p class="text-xs text-amber-600">创建者: 游客模式</p>`;
                  }
                }

                return `
                      <div class="border ${
                        isCurrent
                          ? "border-sky-500 bg-sky-50"
                          : "border-slate-200"
                      } rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <p class="font-semibold text-slate-800 break-all"> 会话 ${
                              session.session_id
                            } </p>
                             ${
                               isCurrent
                                 ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2">(当前会话)</span></p>'
                                 : ""
                             }
                            <p class="text-xs text-slate-500">创建时间: ${createdDate}</p>
                            <p class="text-xs text-slate-500">状态: ${
                              session.is_multi_account_mode
                                ? session.login_success
                                  ? '<span class="font-semibold text-green-600">已登录</span>'
                                  : '<span class="font-semibold ">未登录</span>'
                                : session.login_success
                                ? '<span class="font-semibold text-green-600">已登录</span>'
                                : "未登录"
                            }</p>
                            ${ownerInfo}
                          </div>
                          <div class="flex gap-2">
                            ${
                              !isCurrent
                                ? `
                              <button class="btn btn-ghost !py-1 !px-2 text-xs" onclick="selectSession('${session.session_id}')">选择</button>
                              <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" onclick="deleteSession('${session.session_id}')">删除</button>
                            `
                                : ""
                            }
                            ${
                              isGodMode
                                ? `<button class="btn btn-danger !py-1 !px-2 text-xs" onclick="destroySession('${session.session_id}')">销毁</button>`
                                : ""
                            }
                          </div>
                        </div>
                      </div>
                    `;
              })
              .join("");
          }

          listEl.innerHTML = html;
        } catch (e) {
          logMessage_Error("加载会话列表失败:", e);
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      function updateAdminSessionCountDisplayInline(currentCount, maxSessions) {
        const countEl = $("admin-session-count-display-inline");
        if (!countEl) return;

        if (currentUserIsGuest) {
          countEl.innerHTML = `<span class="text-blue-600">会话数: 1 / 游客仅限单会话</span>`;
        } else {
          if (maxSessions === -1) {
            countEl.innerHTML = `<span class="text-green-600">会话数: ${currentCount} / 无限制</span>`;
          } else {
            const isNearLimit = currentCount >= maxSessions * 0.8;
            const isAtLimit = currentCount >= maxSessions;
            const colorClass = isAtLimit
              ? "text-red-600"
              : isNearLimit
              ? "text-amber-600"
              : "text-slate-600";
            countEl.innerHTML = `<span class="${colorClass}">会话数: ${currentCount} / ${maxSessions}</span>`;
          }
        }
      }

      // ====================
      // 日志查看
      // ====================
      async function loadAdminLogs(newPage = 1) {
        currentLogPage = newPage;

        const contentEl = $("admin-logs-content_modal");
        const limitSelect = $("log-limit-select_modal");
        const pageSelect = $("log-page-select");
        const pageTotal = $("log-page-total");
        const prevBtn = $("log-prev-page");
        const nextBtn = $("log-next-page");

        if (
          !contentEl ||
          !limitSelect ||
          !pageSelect ||
          !pageTotal ||
          !prevBtn ||
          !nextBtn
        ) {
          logMessage_Error("loadAdminLogs: 无法找到日志面板的必要DOM元素");
          return;
        }

        contentEl.textContent = "加载中...";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        pageSelect.disabled = true;

        try {
          const limit = limitSelect ? limitSelect.value : 100;
          const response = await fetch(
            `/logs/view?page=${currentLogPage}&limit=${limit}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );
          const result = await response.json();

          if (!result.success) {
            contentEl.textContent = `加载失败: ${result.message}`;
            pageSelect.innerHTML = '<option value="1">1</option>';
            pageTotal.textContent = "(加载失败)";
            return;
          }

          if (result.logs.length === 0) {
            contentEl.textContent = "暂无日志";
            pageSelect.innerHTML = '<option value="1">第 1 / 1 页</option>';
            pageTotal.textContent = "(共 0 行)";
            return;
          }

          contentEl.textContent = result.logs.join("");

          const pagination = result.pagination;
          pageTotal.textContent = `(共 ${pagination.total_lines} 行)`;

          pageSelect.innerHTML = "";
          for (let i = 1; i <= pagination.total_pages; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = `第 ${i} / ${pagination.total_pages} 页`;
            if (i === pagination.current_page) {
              option.selected = true;
            }
            pageSelect.appendChild(option);
          }

          prevBtn.disabled = pagination.current_page <= 1;
          nextBtn.disabled = pagination.current_page >= pagination.total_pages;
          pageSelect.disabled = false;
        } catch (e) {
          logMessage_Error("加载日志失败:", e);
          contentEl.textContent = `加载失败: ${e.message}`;
          pageSelect.innerHTML = '<option value="1">1</option>';
          pageTotal.textContent = "(加载失败)";
        }
      }

      // ====================
      // 健康状态检测
      // ====================
      async function loadHealthStatus() {
        const contentEl = $("admin-health-content_modal");

        if (!contentEl) {
          logMessage_Error("loadHealthStatus: 无法找到健康状态容器");
          return;
        }

        contentEl.innerHTML =
          '<p class="text-slate-400 text-center py-10">检测中...</p>';

        try {
          const startTime = Date.now();
          const response = await fetch("/health");
          const responseTime = Date.now() - startTime;
          const result = await response.json();

          const statusColor = result.status === "ok" ? "green" : "red";
          const statusText = result.status === "ok" ? "运行正常" : "出现错误";

          contentEl.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-4">
              <h5 class="font-semibold text-${statusColor}-800 mb-2">服务器状态</h5>
              <p class="text-2xl font-bold text-${statusColor}-600">${statusText}</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h5 class="font-semibold text-blue-800 mb-2">响应时间</h5>
              <p class="text-2xl font-bold text-blue-600">${responseTime}ms</p>
            </div>
          </div>
          <div class="mt-4 bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h5 class="font-semibold text-slate-800 mb-2">系统信息</h5>
            <pre class="text-xs text-slate-600 whitespace-pre-wrap">${JSON.stringify(
              result,
              null,
              2
            )}</pre>
          </div>
        `;
        } catch (e) {
          logMessage_Error("加载健康状态失败:", e);
          contentEl.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      // ============================================================
      // 健康面板倒计时功能
      // ============================================================

      let healthCountdownInterval = null;
      let healthCountdownSeconds = 5;

      function startHealthAutoRefresh() {
        stopHealthAutoRefresh();

        const autoRefreshToggle = $("health-auto-refresh-toggle");
        if (!autoRefreshToggle || !autoRefreshToggle.checked) {
          return;
        }

        healthCountdownSeconds = 5;
        updateHealthCountdown();

        healthCountdownInterval = setInterval(() => {
          healthCountdownSeconds--;
          updateHealthCountdown();

          if (healthCountdownSeconds <= 0) {
            healthCountdownSeconds = 5;
          }
        }, 1000);

        healthAutoRefreshInterval = setInterval(() => {
          const toggle = $("health-auto-refresh-toggle");
          if (toggle && toggle.checked) {
            loadHealthStatus();
            healthCountdownSeconds = 5;
          } else {
            stopHealthAutoRefresh();
          }
        }, 5000);
      }

      function updateHealthCountdown() {
        const countdownDisplay = $("health-countdown-display");
        if (countdownDisplay) {
          if (healthCountdownSeconds > 0) {
            countdownDisplay.textContent = ` - ${healthCountdownSeconds}秒后刷新`;
          } else {
            countdownDisplay.textContent = " - 刷新中...";
          }
        }
      }

      function stopHealthAutoRefresh() {
        if (healthAutoRefreshInterval) {
          clearInterval(healthAutoRefreshInterval);
          healthAutoRefreshInterval = null;
        }
        if (healthCountdownInterval) {
          clearInterval(healthCountdownInterval);
          healthCountdownInterval = null;
        }
        const countdownDisplay = $("health-countdown-display");
        if (countdownDisplay) {
          countdownDisplay.textContent = "";
        }
      }

      // ====================
      // 个人信息管理
      // ====================
      async function loadPersonalInfo() {
        try {
          const response = await fetch("/auth/user/details", {
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();
          if (!result.success) {
            showModalAlert(`加载个人信息失败: ${result.message}`, "错误");
            return;
          }
          const user = result.user;
          if (user.auth_username) {
            currentAuthUsername = user.auth_username;
          }
          const nicknameInput = $("profile-nickname");
          const phoneInput = $("profile-phone");
          if (nicknameInput) nicknameInput.value = user.nickname || "";
          if (phoneInput) phoneInput.value = user.phone || "未绑定";

          const phoneWrapper = phoneInput
            ? phoneInput.closest(".phone-input-wrapper")
            : null;
          if (phoneWrapper) {
            const prefix = phoneWrapper.querySelector(".phone-prefix");
            const isUnbound =
              !phoneInput.value || phoneInput.value === "未绑定";

            if (prefix) {
              prefix.style.display = isUnbound ? "none" : "inline";
            }
            phoneWrapper.classList.toggle("prefix-hidden", isUnbound);
          }

          const modifyPhoneBtn = $("profile-modify-phone-btn");
          const phoneHint = $("profile-phone-hint");

          const config = window.APP_CONFIG || {
            enable_phone_modification: false,
          };

          if (config.enable_phone_modification) {
            if (modifyPhoneBtn) modifyPhoneBtn.style.display = "block";
            if (phoneHint) phoneHint.style.display = "block";
          } else {
            if (modifyPhoneBtn) modifyPhoneBtn.style.display = "none";
            if (phoneHint) phoneHint.style.display = "none";
            if (phoneInput) phoneInput.readOnly = true;
          }
          const avatarDisplay = $("profile-avatar-display");
          const avatarInput = $("profile-avatar-input");
          if (avatarDisplay) {
            const avatarUrl = user.avatar_url || user.avatar || "";
            logMessage_Info(
              "[loadPersonalInfo] Processing avatar URL:",
              avatarUrl
            );
            if (avatarUrl) {
              if (avatarUrl.startsWith("/api/avatar/")) {
                loadAvatarWithAuth(avatarUrl, avatarDisplay);
              } else {
                const timestamp = new Date().getTime();
                const urlWithTimestamp = avatarUrl.includes("?")
                  ? `${avatarUrl}&t=${timestamp}`
                  : `${avatarUrl}?t=${timestamp}`;
                logMessage_Info(
                  "[loadPersonalInfo] Setting avatar display src to:",
                  urlWithTimestamp
                );
                avatarDisplay.src = urlWithTimestamp;
              }
            } else {
              logMessage_Info(
                "[loadPersonalInfo] No avatar URL, using default icon"
              );
              avatarDisplay.src =
                "data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3E👤%3C/text%3E%3C/svg%3E";
            }
          }
          if (avatarInput) {
            avatarInput.value = user.avatar_url || user.avatar || "";
          }

          const tfaStatus = $("profile-2fa-enabled");
          const tfaActions = $("profile-2fa-actions");
          const tfaEnabledActions = $("profile-2fa-enabled-actions");
          const tfaSetup = $("profile-2fa-setup");

          const tfaEnabled = user["2fa_enabled"] || user.tfa_enabled || false;

          if (tfaStatus) {
            tfaStatus.textContent = tfaEnabled ? "已启用" : "未启用";
            tfaStatus.className = tfaEnabled
              ? "text-green-600 font-semibold"
              : "text-slate-600";
          }

          if (tfaEnabled) {
            if (tfaActions) tfaActions.classList.add("hidden");
            if (tfaSetup) tfaSetup.classList.add("hidden");
            if (tfaEnabledActions) tfaEnabledActions.classList.remove("hidden");
          } else {
            if (tfaActions) tfaActions.classList.remove("hidden");
            if (tfaEnabledActions) tfaEnabledActions.classList.add("hidden");
            if (tfaSetup) tfaSetup.classList.add("hidden");
          }

          const themeSelect = $("profile-theme-select");
          if (themeSelect && user.theme) {
            themeSelect.value = user.theme;
          }
          try {
            const paramsResult = await callPythonAPI("get_params");
            if (paramsResult && paramsResult.theme_base_color) {
              const themeColor = paramsResult.theme_base_color;
              const colorPicker = $("profile-theme_base_color-picker");
              const colorInput = $("profile-theme_base_color");
              if (colorPicker) colorPicker.value = themeColor;
              if (colorInput) colorInput.value = themeColor;
              onColorPicked(themeColor);
            }
            if (paramsResult && paramsResult.theme_style) {
              setThemeStyle(paramsResult.theme_style);
            }
            if (user.theme) {
              applyAndSaveTheme(user.theme);
            }
          } catch (e) {
            logMessage_Warning("[loadPersonalInfo] 加载主题设置失败:", e);
          }
        } catch (e) {
          logMessage_Error("加载个人信息失败:", e);
          showModalAlert(`加载失败: ${e.message}`, "错误");
        }
      }

      async function updateAvatar() {
        const avatarInput = $("profile-avatar-input");
        if (!avatarInput || !avatarInput.value.trim()) {
          showModalAlert("请输入头像URL", "提示");
          return;
        }

        try {
          const response = await fetch("/auth/user/update_avatar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              avatar_url: avatarInput.value.trim(),
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("头像更新成功！", "成功");
            loadPersonalInfo();
          } else {
            showModalAlert(`更新失败: ${result.message}`, "错误");
          }
        } catch (e) {
          logMessage_Error("更新头像失败:", e);
          showModalAlert(`更新失败: ${e.message}`, "错误");
        }
      }

      async function loadAvatarWithAuth(avatarUrl, imgElement) {
        try {
          logMessage_Info("[loadAvatarWithAuth] Fetching avatar:", avatarUrl);
          const response = await fetch(avatarUrl, {
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });

          if (!response.ok) {
            logMessage_Error(
              "[loadAvatarWithAuth] Failed to fetch avatar:",
              response.status
            );
            imgElement.src =
              "data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3E👤%3C/text%3E%3C/svg%3E";
            return;
          }

          const blob = await response.blob();

          const reader = new FileReader();
          reader.onloadend = function () {
            logMessage_Info("[loadAvatarWithAuth] Avatar loaded successfully");
            imgElement.src = reader.result;
          };
          reader.readAsDataURL(blob);
        } catch (e) {
          logMessage_Error("[loadAvatarWithAuth] Error loading avatar:", e);
          imgElement.src =
            "data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3E👤%3C/text%3E%3C/svg%3E";
        }
      }

      function previewAvatar(event) {
        isRegistrationCrop = false;
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          showModalAlert("请选择图片文件", "错误");
          event.target.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const cropImage = $("crop-image");
          if (cropImage) {
            cropImage.src = e.target.result;

            if (avatarCropper) {
              avatarCropper.destroy();
            }

            avatarCropper = new Cropper(cropImage, {
              aspectRatio: 1,
              viewMode: 1,
              minContainerWidth: 300,
              minContainerHeight: 300,
              autoCropArea: 0.8,
              responsive: true,
              guides: true,
              center: true,
              highlight: true,
              cropBoxResizable: true,
              cropBoxMovable: true,
              toggleDragModeOnDblclick: false,
            });
            showModal("avatar-crop-modal");
          }
        };
        reader.readAsDataURL(file);
      }
      function previewAvatarForRegistration(event) {
        isRegistrationCrop = true;
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          showModalAlert("请选择图片文件", "错误");
          event.target.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const cropImage = $("crop-image");
          if (cropImage) {
            cropImage.src = e.target.result;
            if (avatarCropper) avatarCropper.destroy();
            avatarCropper = new Cropper(cropImage, {
              aspectRatio: 1,
              viewMode: 1,
              minContainerWidth: 300,
              minContainerHeight: 300,
              autoCropArea: 0.8,
              responsive: true,
              guides: true,
              center: true,
              highlight: true,
              cropBoxResizable: true,
              cropBoxMovable: true,
              toggleDragModeOnDblclick: false,
            });
            showModal("avatar-crop-modal");
          }
        };
        reader.readAsDataURL(file);
      }
      function closeCropModal() {
        if (avatarCropper) {
          avatarCropper.destroy();
          avatarCropper = null;
        }
        const fileInput = $("profile-avatar-file");
        if (fileInput) fileInput.value = "";
        const regFileInput = $("auth-reg-avatar");
        if (regFileInput) regFileInput.value = "";
        const mobileRegFileInput = $("mobile-reg-avatar");
        if (mobileRegFileInput) mobileRegFileInput.value = "";
        isRegistrationCrop = false;
        hideModal("avatar-crop-modal");
      }
      async function confirmCropForRegistration() {
        if (!avatarCropper) {
          showModalAlert("裁剪器未初始化", "错误");
          return;
        }
        const canvas = avatarCropper.getCroppedCanvas({
          width: 200,
          height: 200,
          imageSmoothingQuality: "high",
        });
        if (!canvas) {
          showModalAlert("裁剪失败", "错误");
          return;
        }
        canvas.toBlob(
          function (blob) {
            registrationCroppedAvatarBlob = new File([blob], "avatar.jpg", {
              type: "image/jpeg",
            });
            const previewImg = $("auth-reg-avatar-preview");
            if (previewImg) {
              previewImg.src = URL.createObjectURL(
                registrationCroppedAvatarBlob
              );
            }
            const mobilePreviewImg = $("mobile-reg-avatar-preview");
            if (mobilePreviewImg) {
              mobilePreviewImg.src = URL.createObjectURL(
                registrationCroppedAvatarBlob
              );
            }
            closeCropModal();
          },
          "image/jpeg",
          0.9
        );
      }

      async function confirmCropAndUpload() {
        if (isRegistrationCrop) {
          await confirmCropForRegistration();
        } else {
          if (!avatarCropper) {
            showModalAlert("裁剪器未初始化", "错误");
            return;
          }

          const canvas = avatarCropper.getCroppedCanvas({
            width: 200,
            height: 200,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: "high",
          });

          if (!canvas) {
            showModalAlert("裁剪失败", "错误");
            return;
          }

          canvas.toBlob(
            async function (blob) {
              const avatarFile = new File([blob], "avatar.jpg", {
                type: "image/jpeg",
              });

              closeCropModal();

              const formData = new FormData();
              formData.append("avatar", avatarFile);

              try {
                const response = await fetch("/auth/user/upload_avatar", {
                  method: "POST",
                  headers: {
                    "X-Session-ID": sessionUUID,
                  },
                  body: formData,
                });
                const result = await response.json();

                if (result.success) {
                  showModalAlert("头像上传成功！", "成功");

                  croppedAvatarFile = null;

                  const fileInput = $("profile-avatar-file");
                  if (fileInput) {
                    fileInput.value = "";
                  }

                  await loadPersonalInfo();
                } else {
                  showModalAlert(`上传失败: ${result.message}`, "错误");
                }
              } catch (e) {
                logMessage_Error("上传头像失败:", e);
                showModalAlert(
                  `上传失败: ${e.message}\n\n⚠️ 此功能需要后端API /auth/user/upload_avatar 支持`,
                  "错误"
                );
              }
            },
            "image/jpeg",
            0.9
          );
        }
      }

      async function uploadAvatar() {
        let fileToUpload = croppedAvatarFile;

        if (!fileToUpload) {
          const fileInput = $("profile-avatar-file");
          if (!fileInput || !fileInput.files || !fileInput.files[0]) {
            showModalAlert("请先选择并裁剪图片文件", "提示");
            return;
          }
          fileToUpload = fileInput.files[0];
        }

        const formData = new FormData();
        formData.append("avatar", fileToUpload);

        try {
          const response = await fetch("/auth/user/upload_avatar", {
            method: "POST",
            headers: {
              "X-Session-ID": sessionUUID,
            },
            body: formData,
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("头像上传成功！", "成功");

            croppedAvatarFile = null;
            const fileInput = $("profile-avatar-file");
            if (fileInput) {
              fileInput.value = "";
            }
            await loadPersonalInfo();
          } else {
            showModalAlert(`上传失败: ${result.message}`, "错误");
          }
        } catch (e) {
          logMessage_Error("上传头像失败:", e);
          showModalAlert(`上传失败: ${e.message}`, "错误");
        }
      }
      async function updateBasicInfo() {
        const nickname = $("profile-nickname");
        const phone = $("profile-phone");

        if (!nickname || !phone) return;

        if (!nickname.value.trim()) {
          showModalAlert("昵称不能为空", "提示");
          return;
        }

        if (!currentAuthUsername) {
          showModalAlert("无法获取当前用户信息，请重新加载", "错误");
          return;
        }

        try {
          const response = await fetch(
            "/api/admin/users/" +
              encodeURIComponent(currentAuthUsername) +
              "/basic_info",
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "X-Session-ID": sessionUUID,
              },
              body: JSON.stringify({
                nickname: nickname.value.trim(),
              }),
            }
          );

          const result = await response.json();
          if (result.success) {
            showModalAlert("基本信息更新成功", "成功");
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (error) {
          logMessage_Error("更新基本信息失败", error);
          showModalAlert("网络错误，请稍后重试", "错误");
        }
      }
      async function modifyPhone() {
        showModalAlert("修改手机号功能需要短信验证，当前版本暂未开放", "提示");
      }

      async function updatePassword() {
        const confirmed = await jsShowConfirm(
          "确认修改密码",
          "您确定要修改您的登录密码吗？\n\n修改后需要使用新密码重新登录。"
        );
        if (!confirmed) {
          logMessage_Info("[修改密码] 用户取消了密码修改操作");
          return;
        }
        const currentPassword = $("profile-current-password");
        const newPassword = $("profile-new-password");
        const confirmPassword = $("profile-confirm-password");

        if (!currentPassword || !newPassword || !confirmPassword) return;

        if (
          !currentPassword.value ||
          !newPassword.value ||
          !confirmPassword.value
        ) {
          showModalAlert("请填写所有密码字段", "提示");
          return;
        }

        if (newPassword.value !== confirmPassword.value) {
          showModalAlert("两次输入的密码不一致", "错误");
          return;
        }

        if (newPassword.value.length < 6) {
          showModalAlert("密码长度至少为6个字符", "错误");
          return;
        }

        if (!currentAuthUsername) {
          showModalAlert("无法获取当前用户信息，请重新加载个人信息", "错误");
          return;
        }

        try {
          const response = await fetch("/auth/admin/reset_password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              username: currentAuthUsername,
              old_password: currentPassword.value,
              new_password: newPassword.value,
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("密码修改成功！", "成功");
            currentPassword.value = "";
            newPassword.value = "";
            confirmPassword.value = "";
          } else {
            showModalAlert(
              `修改失败: ${result.message || "请检查当前密码是否正确"}`,
              "错误"
            );
          }
        } catch (e) {
          logMessage_Error("修改密码失败:", e);
          showModalAlert(`修改失败: ${e.message}`, "错误");
        }
      }

      async function generate2FA() {
        try {
          const response = await fetch("/auth/2fa/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();

          if (!result.success) {
            showModalAlert(`生成2FA失败: ${result.message}`, "错误");
            return;
          }
          const setupDiv = $("profile-2fa-setup");
          const actionsDiv = $("profile-2fa-actions");
          if (setupDiv) setupDiv.classList.remove("hidden");
          if (actionsDiv) actionsDiv.classList.add("hidden");
          const secretSpan = $("profile-2fa-secret");
          if (secretSpan && result.secret) {
            secretSpan.textContent = result.secret;
          }
          const qrCanvas = $("profile-2fa-qr");
          if (qrCanvas && result.qr_uri) {
            if (typeof QRCode !== "undefined") {
              qrCanvas.width = 200;
              qrCanvas.height = 200;

              QRCode.toCanvas(
                qrCanvas,
                result.qr_uri,
                { width: 200 },
                function (error) {
                  if (error) {
                    logMessage_Error("QR Code generation error:", error);
                    showModalAlert("二维码生成失败", "错误");
                  } else {
                    logMessage_Info("QR Code generated successfully");
                  }
                }
              );
            } else {
              logMessage_Error("QRCode库未加载");
              showModalAlert("QRCode库未加载，请刷新页面重试", "错误");
            }
          }
        } catch (e) {
          logMessage_Error("生成2FA失败:", e);
          showModalAlert(`生成失败: ${e.message}`, "错误");
        }
      }

      async function enable2FA() {
        const codeInput = $("profile-2fa-code");
        if (!codeInput || !codeInput.value) {
          showModalAlert("请输入验证码", "提示");
          return;
        }

        try {
          const response = await fetch("/auth/2fa/enable", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              code: codeInput.value,
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("2FA启用成功！", "成功");
            const setupDiv = $("profile-2fa-setup");
            const actionsDiv = $("profile-2fa-actions");
            if (setupDiv) setupDiv.classList.add("hidden");
            if (actionsDiv) actionsDiv.classList.remove("hidden");
            loadPersonalInfo();
          } else {
            showModalAlert(`启用失败: ${result.message}`, "错误");
          }
        } catch (e) {
          logMessage_Error("启用2FA失败:", e);
          showModalAlert(`启用失败: ${e.message}`, "错误");
        }
      }

      async function disable2FA() {
        const confirmed = await jsShowConfirm(
          "确认关闭2FA",
          "关闭双因素认证后，账号安全性将降低。确定要继续吗？"
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/2fa/disable", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("2FA已关闭", "成功");
            loadPersonalInfo();
          } else {
            showModalAlert(`关闭失败: ${result.message}`, "错误");
          }
        } catch (e) {
          logMessage_Error("关闭2FA失败:", e);
          showModalAlert(`关闭失败: ${e.message}`, "错误");
        }
      }

      async function test2FA() {
        const testCode = await new Promise((resolve) => {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 flex items-center justify-center z-50";
          modal.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">测试2FA</h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 mb-2">请输入验证器中的6位验证码</label>
              <input type="text" id="test-2fa-code-input" class="input-field w-full" placeholder="输入6位验证码" maxlength="6" inputmode="numeric">
            </div>
            <div class="flex gap-2 justify-end">
              <button class="btn btn-ghost" onclick="this.closest('.fixed').remove()">取消</button>
              <button class="btn btn-primary" id="confirm-test-2fa">验证</button>
            </div>
          </div>
        `;
          document.body.appendChild(modal);

          const confirmBtn = modal.querySelector("#confirm-test-2fa");
          const codeInput = modal.querySelector("#test-2fa-code-input");

          confirmBtn.onclick = () => {
            const code = codeInput.value;
            if (!code || code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
              showModalAlert("请输入有效的6位数字验证码", "错误");
              return;
            }
            modal.remove();
            resolve(code);
          };
        });

        if (!testCode) return;

        try {
          const response = await fetch("/auth/2fa/verify", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              code: testCode,
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("2FA验证成功！您的双因素认证工作正常。", "成功");
          } else {
            showModalAlert(
              `验证失败: ${result.message || "验证码错误"}`,
              "错误"
            );
          }
        } catch (e) {
          logMessage_Error("测试2FA失败:", e);
          showModalAlert(`测试失败: ${e.message}`, "错误");
        }
      }

      async function updateTheme() {
        const themeSelect = $("profile-theme-select");
        if (!themeSelect) return;

        const selectedTheme = themeSelect.value;

        applyAndSaveTheme(selectedTheme);

        try {
          const response = await fetch("/auth/user/update_theme", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              theme: selectedTheme,
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("主题更新成功！", "成功");
          } else {
            showModalAlert(`更新失败: ${result.message}`, "错误");
            applyAndSaveTheme(selectedTheme === "dark" ? "light" : "dark");
          }
        } catch (e) {
          logMessage_Error("更新主题失败:", e);
          showModalAlert(`更新失败: ${e.message}`, "错误");
        }
      }

      // =======创建用户对话框
      function showCreateUserModal() {
        const modal = $("newUserModal");
        if (modal) {
          $("newUsername").value = "";
          $("newPassword").value = "";
          modal.style.display = "flex";

          const confirmBtn = $("newUserConfirm");
          confirmBtn.onclick = async () => {
            const inputUsername = $("newUsername").value.trim();
            const inputPassword = $("newPassword").value;

            if (!inputUsername || !inputPassword) {
              showModalAlert("账号和密码均不能为空");
              return;
            }
            if (!inputPassword || inputPassword.length < 6) {
              showModalAlert("密码长度至少为6个字符", "错误");
              return;
            }
            const group = "user";
            setButtonLoading("newUserConfirm", true, "创建中...");

            try {
              const response = await fetch("/auth/admin/create_user", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-Session-ID": sessionUUID,
                },
                body: JSON.stringify({
                  username: inputUsername,
                  password: inputPassword,
                  group: group,
                }),
              });

              const result = await response.json();

              if (result.success) {
                showModalAlert("用户创建成功！");
                closeNewUserModal();
                if (typeof loadAdminUsers === "function") {
                  loadAdminUsers();
                }
              } else {
                showModalAlert(`创建失败: ${result.message || "未知错误"}`);
              }
            } catch (e) {
              showModalAlert(`创建时发生错误: ${e.message}`);
              logMessage_Error("创建用户时发生错误:", e);
            } finally {
              setButtonLoading("newUserConfirm", false, "确认");
            }
          };
        }
      }

      // ======创建权限组对话框
      let currentEditGroupKey = null;
      let currentManageUsername = null;

      async function showCreateGroupModal() {
        const modal = $("create-group-modal");
        if (!modal) return;
        const keyInput = $("new-group-key");
        const nameInput = $("new-group-name");
        if (keyInput) keyInput.value = "";
        if (nameInput) nameInput.value = "";
        try {
          const response = await fetch("/auth/admin/list_groups", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();

          if (result.success && result.groups) {
            const firstGroup = Object.values(result.groups)[0];
            if (firstGroup && firstGroup.permissions) {
              const permissionsContainer = $("create-group-permissions");
              if (permissionsContainer) {
                permissionsContainer.innerHTML = Object.keys(
                  firstGroup.permissions
                )
                  .map(
                    (perm) => `
                <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}">
                  <span class="text-sm text-slate-700">${translatePermission(
                    perm
                  )}</span>
                </label>
              `
                  )
                  .join("");
              }
            }
          }
        } catch (e) {
          logMessage_Error("加载权限列表失败:", e);
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      function showSchoolAccountsModal() {
        const modal = $("school-accounts-modal");
        if (modal) {
          modal.style.display = "flex";
          loadSchoolAccounts();
        }
      }

      function closeSchoolAccountsModal() {
        const modal = $("school-accounts-modal");
        if (modal) {
          modal.style.display = "none";
        }
      }
      async function loadSchoolAccounts() {
        const content = $("school-accounts-content");
        if (!content) return;
        content.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch(
            "/auth/admin/get_all_users_school_accounts",
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const data = await response.json();
          if (!data.success) {
            content.innerHTML = `<p class="text-red-500 text-center py-10">${
              data.message || "加载失败"
            }</p>`;
            return;
          }
          const allAccounts = data.all_accounts;
          if (Object.keys(allAccounts).length === 0) {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无数据</p>';
            return;
          }
          let html = "";
          for (const [authUsername, accounts] of Object.entries(allAccounts)) {
            const accountCount = Object.keys(accounts).length;

            html += `
            <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
              <!-- 标题行：显示认证用户名和账户数量，以及"添加 School Account"按钮 -->
              <div class="flex justify-between items-center mb-3">
                <h4 class="font-semibold text-slate-800">
                  认证用户: ${escapeHtml(authUsername)} 
                  <span class="text-sm text-slate-500">(${accountCount} 个学校账户)</span>
                </h4>
                <!-- "添加 School Account" 按钮 - 使用拟态风格 -->
                <button 
                  onclick="openSchoolAccountModal('${escapeHtml(
                    authUsername
                  )}')"
                  class="px-4 py-2 rounded-lg text-sm font-medium text-sky-600 bg-white border border-sky-300 hover:bg-sky-50 hover:border-sky-400 transition-all flex items-center gap-2"
                  style="box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1), -1px -1px 2px rgba(255, 255, 255, 0.8);"
                  title="为此用户添加新的学校账号">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  添加账户
                </button>
              </div>
              
              <!-- 学校账户列表容器 -->
              <div class="space-y-2">
          `;

            if (accountCount === 0) {
              html +=
                '<p class="text-slate-400 text-sm">暂无学校账户，点击上方"添加账户"按钮开始添加</p>';
            } else {
              for (const [schoolUsername, accountData] of Object.entries(
                accounts
              )) {
                let password = "";
                let ua = "";

                if (typeof accountData === "string") {
                  password = accountData;
                } else if (
                  typeof accountData === "object" &&
                  accountData !== null
                ) {
                  password = accountData.password || "";
                  ua = accountData.ua || "";
                }

                html += `
                <div class="bg-white p-3 rounded border border-slate-200 space-y-2">
                  <!-- 顶部行：学校用户名 + 编辑和删除按钮 -->
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-slate-700">${escapeHtml(
                      schoolUsername
                    )}</span>
                    
                    <!-- 操作按钮组 -->
                    <div class="flex gap-2">
                      <!-- 编辑按钮 - 拟态风格 -->
                      <button 
                        onclick="openSchoolAccountModal('${escapeHtml(
                          authUsername
                        )}', '${escapeHtml(schoolUsername)}', '${escapeHtml(
                  password
                )}', '${escapeHtml(ua)}')"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium text-blue-600 bg-white border border-blue-300 hover:bg-blue-50 hover:border-blue-400 transition-all flex items-center gap-1"
                        style="box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.08), -0.5px -0.5px 1px rgba(255, 255, 255, 0.8);"
                        title="编辑此学校账号">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        编辑
                      </button>
                      
                      <!-- 删除按钮 - 拟态风格 -->
                      <button 
                        onclick="deleteSchoolAccount('${escapeHtml(
                          authUsername
                        )}', '${escapeHtml(schoolUsername)}')"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium text-red-600 bg-white border border-red-300 hover:bg-red-50 hover:border-red-400 transition-all flex items-center gap-1"
                        style="box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.08), -0.5px -0.5px 1px rgba(255, 255, 255, 0.8);"
                        title="删除此学校账号">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        删除
                      </button>
                    </div>
                  </div>
                  
                  <!-- 密码显示行 -->
                  <div class="text-sm">
                    <span class="text-slate-500">密码:</span>
                    <span class="font-mono text-slate-600 ml-2">${escapeHtml(
                      password
                    )}</span>
                  </div>
                  
                  <!-- UA 显示行（仅当 UA 存在时显示） -->
                  ${
                    ua
                      ? `
                  <div class="text-sm">
                    <span class="text-slate-500">UA:</span>
                    <span class="font-mono text-xs text-slate-600 ml-2 break-all">${escapeHtml(
                      ua
                    )}</span>
                  </div>
                  `
                      : ""
                  }
                </div>
              `;
              }
            }

            html += `
              </div>
            </div>
          `;
          }

          content.innerHTML = html;
        } catch (error) {
          console.error("加载 school accounts 失败:", error);
          content.innerHTML =
            '<p class="text-red-500 text-center py-10">加载失败，请检查网络连接</p>';
        }
      }

      function openSchoolAccountModal(
        authUsername,
        schoolUsername = "",
        password = "",
        ua = ""
      ) {
        const modal = $("edit-school-account-modal");
        if (!modal) {
          logMessage_Error("School Account 编辑模态框不存在");
          return;
        }

        const authUsernameInput = $("edit-school-account-auth-username");
        const schoolUsernameInput = $("edit-school-account-school-username");
        const passwordInput = $("edit-school-account-password");
        const uaInput = $("edit-school-account-ua");
        const originalUsernameInput = $(
          "edit-school-account-original-username"
        );
        const modalTitle = $("edit-school-account-modal-title");

        if (
          !authUsernameInput ||
          !schoolUsernameInput ||
          !passwordInput ||
          !uaInput ||
          !originalUsernameInput
        ) {
          logMessage_Error("School Account 编辑表单元素不完整");
          return;
        }

        authUsernameInput.value = authUsername;
        schoolUsernameInput.value = schoolUsername;
        passwordInput.value = password;
        uaInput.value = ua;
        originalUsernameInput.value = schoolUsername;
        if (schoolUsername) {
          if (modalTitle) modalTitle.textContent = "编辑 School Account";
          schoolUsernameInput.readOnly = true;
          schoolUsernameInput.classList.add(
            "bg-slate-100",
            "cursor-not-allowed"
          );
        } else {
          if (modalTitle) modalTitle.textContent = "添加 School Account";
          schoolUsernameInput.readOnly = false;
          schoolUsernameInput.classList.remove(
            "bg-slate-100",
            "cursor-not-allowed"
          );
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => {
          if (schoolUsername) {
            passwordInput.focus();
          } else {
            schoolUsernameInput.focus();
          }
        }, 300);
      }
      function closeEditSchoolAccountModal() {
        const modal = $("edit-school-account-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        const authUsernameInput = $("edit-school-account-auth-username");
        const schoolUsernameInput = $("edit-school-account-school-username");
        const passwordInput = $("edit-school-account-password");
        const uaInput = $("edit-school-account-ua");
        const originalUsernameInput = $(
          "edit-school-account-original-username"
        );

        if (authUsernameInput) authUsernameInput.value = "";
        if (schoolUsernameInput) {
          schoolUsernameInput.value = "";
          schoolUsernameInput.readOnly = false;
          schoolUsernameInput.classList.remove(
            "bg-slate-100",
            "cursor-not-allowed"
          );
        }
        if (passwordInput) passwordInput.value = "";
        if (uaInput) uaInput.value = "";
        if (originalUsernameInput) originalUsernameInput.value = "";
      }

      async function submitSchoolAccount() {
        const authUsernameInput = $("edit-school-account-auth-username");
        const schoolUsernameInput = $("edit-school-account-school-username");
        const passwordInput = $("edit-school-account-password");
        const uaInput = $("edit-school-account-ua");
        const originalUsernameInput = $(
          "edit-school-account-original-username"
        );
        if (
          !authUsernameInput ||
          !schoolUsernameInput ||
          !passwordInput ||
          !uaInput ||
          !originalUsernameInput
        ) {
          showModalAlert("表单元素不完整，无法提交", "错误");
          return;
        }
        const authUsername = authUsernameInput.value.trim();
        const schoolUsername = schoolUsernameInput.value.trim();
        const password = passwordInput.value.trim();
        const ua = uaInput.value.trim();
        const originalUsername = originalUsernameInput.value.trim();

        if (!authUsername) {
          showModalAlert("认证用户名不能为空", "验证失败");
          return;
        }

        if (!schoolUsername) {
          showModalAlert("学校账号用户名不能为空", "验证失败");
          schoolUsernameInput.focus();
          return;
        }

        if (!password) {
          showModalAlert("密码不能为空", "验证失败");
          passwordInput.focus();
          return;
        }
        const data = {
          auth_username: authUsername,
          school_username: schoolUsername,
          password: password,
          ua: ua || null,
        };
        if (originalUsername) {
          data.original_username = originalUsername;
        }

        try {
          const result = await callPythonAPI_raw(
            "/api/admin/school_account/save",
            "POST",
            data
          );
          if (result.success) {
            showModalAlert(
              originalUsername ? "学校账号更新成功" : "学校账号添加成功",
              "成功"
            );
            closeEditSchoolAccountModal();
            loadSchoolAccounts();
          } else {
            showModalAlert(result.message || "保存失败", "错误");
          }
        } catch (error) {
          logMessage_Error("保存 School Account 失败:", error);
          showModalAlert("保存失败，请检查网络连接: " + error.message, "错误");
        }
      }
      async function deleteSchoolAccount(authUsername, schoolUsername) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          `您确定要删除学校账号 "${schoolUsername}" 吗？\n此操作不可恢复。`
        );
        if (!confirmed) {
          return;
        }

        try {
          const result = await callPythonAPI_raw(
            "/api/admin/school_account/delete",
            "POST",
            {
              auth_username: authUsername,
              school_username: schoolUsername,
            }
          );

          if (result.success) {
            showModalAlert("学校账号删除成功", "成功");
            loadSchoolAccounts();
          } else {
            showModalAlert(result.message || "删除失败", "错误");
          }
        } catch (error) {
          logMessage_Error("删除 School Account 失败:", error);
          showModalAlert("删除失败，请检查网络连接: " + error.message, "错误");
        }
      }

      function closeCreateGroupModal() {
        const modal = $("create-group-modal");
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      }

      async function submitCreateGroup() {
        const keyInput = $("new-group-key");
        const nameInput = $("new-group-name");

        if (!keyInput || !nameInput) return;

        const groupKey = keyInput.value.trim();
        const groupName = nameInput.value.trim();

        if (!groupKey || !nameInput) {
          showModalAlert("请填写权限组键名和名称", "错误");
          return;
        }

        const permissionsContainer = $("create-group-permissions");
        if (!permissionsContainer) return;

        const permissions = {};
        const checkboxes = permissionsContainer.querySelectorAll(
          'input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => {
          const perm = cb.getAttribute("data-permission");
          permissions[perm] = cb.checked;
        });

        try {
          const response = await fetch("/auth/admin/create_group", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              group_key: groupKey,
              group_name: groupName,
              permissions: permissions,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`权限组 ${groupName} 创建成功`, "成功");
            closeCreateGroupModal();
            loadAdminGroups();
          } else {
            showModalAlert(result.message || "创建失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function loadAdminUsers() {
        try {
          const response = await fetch("/auth/admin/list_users", {
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();

          if (!result.success) {
            $(
              "admin-users-list"
            ).innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }

          const listEl = $("admin-users-list_modal");
          if (result.users.length === 0) {
            listEl.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无用户</p>';
            return;
          }
          const groupsResp = await fetch("/auth/admin/list_groups", {
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const groupsData = await groupsResp.json();
          const groups = groupsData.success
            ? Object.keys(groupsData.groups)
            : ["guest", "user", "admin"];

          listEl.innerHTML = result.users
            .map((user) => {
              const createdDate = new Date(
                user.created_at * 1000
              ).toLocaleString();
              const lastLoginDate = user.last_login
                ? new Date(user.last_login * 1000).toLocaleString()
                : "从未登录";
              const isBanned = user.banned || false;
              const bannedBadge = isBanned
                ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2">已封禁</span>'
                : "";

              const groupSelect = `
        <select class="text-sm border border-slate-300 rounded px-2 py-1" onchange="updateUserGroup('${
          user.auth_username
        }', this.value)">
          ${groups
            .map(
              (g) =>
                `<option value="${g}" ${
                  g === user.group ? "selected" : ""
                }>${g}</option>`
            )
            .join("")}
        </select>
      `;

              return `
        <div class="border border-slate-200 rounded-lg p-3 mb-2">
          <div class="flex justify-between items-start gap-3">
            <div class="flex items-start gap-3 flex-1">
              <div id="avatar-${
                user.auth_username
              }" class="flex-shrink-0 w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden border-2 border-slate-300">
                <span class="text-2xl text-slate-400">👤</span>
              </div>
              <div class="flex-1">
                <p class="font-semibold text-slate-800">${
                  user.auth_username
                }${bannedBadge}</p>
                <p class="text-xs text-slate-500">昵称: ${
                  user.nickname || "未设置"
                }</p>
                <p class="text-xs text-slate-500">手机号: ${
                  user.phone || "未绑定"
                }</p>
                <p class="text-xs text-slate-500">创建时间: ${createdDate}</p>
                <p class="text-xs text-slate-500">最后登录: ${lastLoginDate}</p>
                <p class="text-xs text-slate-500">登录IP: ${
                  user.last_login_ip || "无记录"
                } (${user.last_login_city || "未知"})</p>
                <p class="text-xs text-slate-500">会话限制: ${
                  user.max_sessions === -1 ? "无限制" : user.max_sessions + "个"
                }</p>
                <p class="text-xs ${
                  user["2fa_enabled"] || user.tfa_enabled
                    ? "text-green-600"
                    : "text-slate-400"
                }">2FA: ${
                user["2fa_enabled"] || user.tfa_enabled ? "已启用" : "未启用"
              }</p>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="text-xs text-slate-600">权限组:</span>
              ${groupSelect}
              <div class="flex flex-col gap-1.5 mt-2" id="user-actions-${
                user.auth_username
              }">
                <div class="flex gap-1 flex-wrap justify-end">
                  <button class="btn btn-secondary !py-0.5 !px-2 !text-xs" onclick="showUserSchoolAccounts('${
                    user.auth_username
                  }')">账户密码</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="showUserLogs('${
                    user.auth_username
                  }')">查看日志</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="manageUserPermissions('${
                    user.auth_username
                  }')">权限</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="setUserMaxSessions('${
                    user.auth_username
                  }', ${user.max_sessions || 1})">会话</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="modifyUserNickname('${
                    user.auth_username
                  }', '${escapeHtml(user.nickname || "")}')">修改昵称</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="modifyUserPhone('${
                    user.auth_username
                  }', '${user.phone || ""}')">修改手机</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="resetUserPassword('${
                    user.auth_username
                  }')">重置密码</button>
                  <button class="btn btn-warning !py-0.5 !px-2 !text-xs text-amber-700" onclick="forceLogoutUser('${
                    user.auth_username
                  }')">强制登出</button>
                </div>
                <div class="flex gap-1 flex-wrap justify-end">
                  ${
                    user["2fa_enabled"] || user.tfa_enabled
                      ? `<button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="forceDisable2FA('${user.auth_username}')">关闭2FA</button>`
                      : ""
                  }
                  ${
                    isBanned
                      ? `<button class="btn btn-success !py-0.5 !px-2 !text-xs" onclick="unbanUser('${user.auth_username}')">解封</button>`
                      : `<button class="btn btn-warning !py-0.5 !px-2 !text-xs" onclick="banUser('${user.auth_username}')">封禁</button>`
                  }
                  <button class="btn btn-warning !py-0.5 !px-2 !text-xs" onclick="clearUserAvatar('${
                    user.auth_username
                  }')">清除头像</button>
                  <button class="btn btn-danger !py-0.5 !px-2 !text-xs" onclick="deleteUser('${
                    user.auth_username
                  }')">删除</button>
                </div>
              </div>
          </div>
        </div>
      </div>
      `;
            })
            .join("");

          result.users.forEach((user) => {
            loadUserAvatar(user.auth_username);
          });
        } catch (e) {
          $(
            "admin-users-list"
          ).innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      async function updateUserGroup(username, newGroup) {
        try {
          const response = await fetch("/auth/admin/update_user_group", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              target_username: username,
              new_group: newGroup,
            }),
          });

          const result = await response.json();
          if (result.success) {
            logMessage_Info(`用户 ${username} 的权限组已更新为 ${newGroup}`);
          } else {
            showModalAlert(`更新失败: ${result.message}`, "操作失败");
            loadAdminUsers();
          }
        } catch (e) {
          showModalAlert(`更新失败: ${e.message}`, "网络错误");
          loadAdminUsers();
        }
      }

      // ====================
      // 用户管理功能函数
      // ====================
      async function banUser(username) {
        const confirmed = await jsShowConfirm(
          "确认封禁",
          `确定要封禁用户 ${username} 吗？`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/ban_user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 已被封禁`, "成功");
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "封禁失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function unbanUser(username) {
        const confirmed = await jsShowConfirm(
          "确认解封",
          `确定要解封用户 ${username} 吗？`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/unban_user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 已解封`, "成功");
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "解封失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function forceDisable2FA(username) {
        const confirmed = await jsShowConfirm(
          "强制关闭2FA",
          `确定要为用户 ${username} 关闭双因素认证吗？`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/force_disable_2fa", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              target_username: username,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 的2FA已关闭`, "成功");
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "操作失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function resetUserPassword(username) {
        const newPassword = await new Promise((resolve) => {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 flex items-center justify-center z-50";
          modal.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">重置密码 - ${username}</h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 mb-2">新密码（至少6位）</label>
              <input type="password" id="reset-password-input" class="input-field w-full" placeholder="输入新密码">
            </div>
            <div class="flex gap-2 justify-end">
              <button class="btn btn-ghost" onclick="this.closest('.fixed').remove()">取消</button>
              <button class="btn btn-primary" id="confirm-reset-password">确认重置</button>
            </div>
          </div>
        `;
          document.body.appendChild(modal);

          const confirmBtn = modal.querySelector("#confirm-reset-password");
          const passwordInput = modal.querySelector("#reset-password-input");

          confirmBtn.onclick = () => {
            const password = passwordInput.value;
            if (!password || password.length < 6) {
              showModalAlert("密码长度至少为6个字符", "错误");
              return;
            }
            modal.remove();
            resolve(password);
          };
        });

        if (!newPassword) return;

        try {
          const response = await fetch("/auth/admin/force_reset_password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              target_username: username,
              new_password: newPassword,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 的密码已重置`, "成功");
          } else {
            showModalAlert(result.message || "重置失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function deleteUser(username) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          `确定要删除用户 ${username} 吗？\n此操作不可恢复！`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/delete_user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 已删除`, "成功");
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "删除失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      // ============================================================
      // 新增：强制登出用户前端逻辑
      // ============================================================
      async function forceLogoutUser(username) {
        const confirmed = await jsShowConfirm(
          "确认强制登出",
          `确定要强制登出用户 <strong>${username}</strong> 吗？<br>该用户的所有活跃会话将被立即销毁。`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/force_logout_user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username: username }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(
              result.message || "用户已强制登出",
              "成功",
              "success"
            );
            loadAdminUsers(); // 刷新列表以更新状态（虽然登出不会立即改变列表显示，但刷新是个好习惯）
          } else {
            showModalAlert(result.message || "操作失败", "错误");
          }
        } catch (e) {
          console.error("强制登出失败:", e);
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function loadUserAvatar(username) {
        try {
          const response = await fetch(
            `/auth/user/avatar?username=${encodeURIComponent(username)}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const result = await response.json();
          const avatarDiv = document.getElementById(`avatar-${username}`);

          if (!avatarDiv) return;

          if (result.success && result.avatar_url) {
            const avatarUrlWithSession = `${result.avatar_url}?session_id=${sessionUUID}`;
            avatarDiv.innerHTML = `<img src="${avatarUrlWithSession}" alt="${username}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="text-2xl text-slate-400" style="display:none;">👤</span>`;
          } else {
            avatarDiv.innerHTML = `<span class="text-2xl text-slate-400">👤</span>`;
          }
        } catch (e) {
          logMessage_Error(`加载用户头像失败 ${username}:`, e);
        }
      }

      async function clearUserAvatar(username) {
        const confirmed = await jsShowConfirm(
          "确认清除头像",
          `确定要清除用户 ${username} 的头像吗？`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/clear_user_avatar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`已清除用户 ${username} 的头像`, "成功");
            loadUserAvatar(username);
          } else {
            showModalAlert(result.message || "清除失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      function setUserMaxSessions(username, currentMax) {
        $("sessions-username").textContent = username;
        $("sessions-current-max").textContent =
          currentMax === -1 ? "无限制" : currentMax;
        $("new-max-sessions").value = currentMax === -1 ? 0 : currentMax;

        showModal("set-max-sessions-modal");
      }

      async function submitSetMaxSessions() {
        const username = $("sessions-username").textContent;
        const newMaxInput = $("new-max-sessions");
        const newMax = parseInt(newMaxInput.value);

        if (isNaN(newMax) || newMax < 0) {
          showModalAlert("请输入有效的数字（0或更大）", "错误");
          return;
        }

        const maxSessions = newMax === 0 ? -1 : newMax;

        try {
          const response = await fetch("/auth/admin/update_max_sessions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username, max_sessions: maxSessions }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(
              `已更新用户 ${username} 的最大会话数为: ${
                maxSessions === -1 ? "无限制" : maxSessions
              }`,
              "成功"
            );
            hideModal("set-max-sessions-modal");
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function showUserSchoolAccounts(username) {
        // ========== 功能说明 ==========
        try {
          const response = await fetch(
            `/auth/admin/get_user_school_accounts?username=${encodeURIComponent(
              username
            )}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const result = await response.json();

          if (!result.success) {
            showModalAlert(result.message || "加载失败", "错误");
            return;
          }

          const accounts = result.accounts || {};
          const accountCount = Object.keys(accounts).length;

          // ========== 用户名和统计信息 ==========
          $("school-accounts-username").textContent = username;
          $("school-accounts-count").textContent = accountCount;
          const listContainer = $("school-accounts-list");
          if (accountCount === 0) {
            listContainer.innerHTML =
              '<p class="text-slate-400 text-center py-10">该用户暂无学校账户</p>';
          } else {
            let html = "";
            for (const [schoolUsername, accountData] of Object.entries(
              accounts
            )) {
              let password = "";
              let ua = "";
              if (typeof accountData === "string") {
                password = accountData;
              } else if (
                typeof accountData === "object" &&
                accountData !== null
              ) {
                password = accountData.password || "";
                ua = accountData.ua || "";
              }

              // ==========为安全传递数据，使用JSON编码 ==========
              const accountDataJson = JSON.stringify({
                authUsername: username,
                schoolUsername: schoolUsername,
                password: password,
                ua: ua,
              });

              // ==========生成账户卡片HTML ==========
              html += `
              <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                <!-- 学校账户用户名 -->
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-slate-800 text-lg">${escapeHtml(
                    schoolUsername
                  )}</div>
                  <!-- 操作按钮组 -->
                  <div class="flex gap-2">
                    <!-- 编辑按钮：打开编辑模态框 -->
                    <!-- 使用data属性存储JSON数据，点击时解析并调用函数 -->
                    <button 
                      class="btn btn-sm btn-primary !py-1 !px-3 !text-xs" 
                      data-account='${escapeHtml(accountDataJson)}'
                      onclick="(function(btn) { const data = JSON.parse(btn.getAttribute('data-account')); editSchoolAccount(data.authUsername, data.schoolUsername, data.password, data.ua); })(this)"
                      title="编辑此账户">
                      编辑
                    </button>
                    <!-- 删除按钮：确认后删除账户 -->
                    <!-- 同样使用data属性存储数据 -->
                    <button 
                      class="btn btn-sm btn-danger !py-1 !px-3 !text-xs" 
                      data-auth-username='${escapeHtml(username)}'
                      data-school-username='${escapeHtml(schoolUsername)}'
                      onclick="(function(btn) { deleteSchoolAccount(btn.getAttribute('data-auth-username'), btn.getAttribute('data-school-username')); })(this)"
                      title="删除此账户">
                      删除
                    </button>
                  </div>
                </div>
                
                <!-- 密码显示 -->
                <div class="text-sm">
                  <span class="text-slate-500">密码:</span>
                  <span class="font-mono text-slate-700 ml-2 select-all">${escapeHtml(
                    password
                  )}</span>
                </div>
                
                <!-- User-Agent显示（如果存在） -->
                ${
                  ua
                    ? `
                <div class="text-sm">
                  <span class="text-slate-500">User-Agent:</span>
                  <div class="font-mono text-xs text-slate-600 mt-1 p-2 bg-white rounded break-all select-all">${escapeHtml(
                    ua
                  )}</div>
                </div>
                `
                    : ""
                }
              </div>
            `;
            }

            listContainer.innerHTML = html;
          }

          // ==========显示模态框 ==========
          showModal("manage-school-accounts-modal");
        } catch (error) {
          // ========== 错误处理 ==========
          console.error("showUserSchoolAccounts error:", error);
          showModalAlert("加载失败: " + error.message, "错误");
        }
      }

      function closeManageSchoolAccountsModal() {
        hideModal("manage-school-accounts-modal");
      }
      function editSchoolAccount(authUsername, schoolUsername, password, ua) {
        const authUsernameField = $("edit-school-account-auth-username");
        const schoolUsernameField = $("edit-school-account-school-username");

        if (authUsernameField) {
          authUsernameField.value = authUsername;
        }

        if (schoolUsernameField) {
          schoolUsernameField.value = schoolUsername;
        }

        const passwordField = $("edit-school-account-password");
        const uaField = $("edit-school-account-ua");

        if (passwordField) {
          passwordField.value = password;
        }

        if (uaField) {
          uaField.value = ua || "";
        }

        const authUsernameSpan = $("edit-auth-username");
        const schoolUsernameSpan = $("edit-school-username");
        const passwordInput = $("edit-school-password");
        const uaTextarea = $("edit-school-ua");

        if (authUsernameSpan) {
          authUsernameSpan.textContent = authUsername;
        }

        if (schoolUsernameSpan) {
          schoolUsernameSpan.textContent = schoolUsername;
        }

        if (passwordInput) {
          passwordInput.value = password;
        }

        if (uaTextarea) {
          uaTextarea.value = ua || "";
        }

        showModal("edit-school-account-modal");
      }

      function addNewSchoolAccount() {
        const currentAuthUsername =
          $("school-accounts-username")?.textContent || "";

        const authUsernameField = $("edit-school-account-auth-username");
        const schoolUsernameField = $("edit-school-account-school-username");
        const passwordField = $("edit-school-account-password");
        const uaField = $("edit-school-account-ua");

        if (authUsernameField) {
          authUsernameField.value = currentAuthUsername;
        }

        if (schoolUsernameField) {
          schoolUsernameField.value = "";
          schoolUsernameField.readOnly = false;
        }

        if (passwordField) {
          passwordField.value = "";
        }

        if (uaField) {
          uaField.value = "";
        }
        const authUsernameSpan = $("edit-auth-username");
        const schoolUsernameSpan = $("edit-school-username");
        const passwordInput = $("edit-school-password");
        const uaTextarea = $("edit-school-ua");

        if (authUsernameSpan) {
          authUsernameSpan.textContent = currentAuthUsername;
        }

        if (schoolUsernameSpan) {
          schoolUsernameSpan.textContent = "";
        }

        if (passwordInput) {
          passwordInput.value = "";
        }

        if (uaTextarea) {
          uaTextarea.value = "";
        }
        const modalTitle = $("edit-school-account-modal-title");
        if (modalTitle) {
          modalTitle.textContent = "新增学校账户";
        }
        showModal("edit-school-account-modal");

        console.log("[学校账户管理] 已打开新增学校账户模态框");
      }
      async function generateRandomUAForSchoolAccount() {
        try {
          console.log("[学校账户管理] 开始生成随机User-Agent...");
          const result = await callPythonAPI("generate_new_ua");
          if (!result) {
            console.error("[学校账户管理] 生成UA失败：API返回空结果");
            showTempMessage("生成失败：无法连接到服务器", "error");
            return;
          }
          const newUA = typeof result === "string" ? result : result.ua;

          if (!newUA) {
            console.error("[学校账户管理] 生成UA失败：返回的UA为空");
            showTempMessage("生成失败：返回的User-Agent为空", "error");
            return;
          }
          const uaField = $("edit-school-account-ua");
          if (uaField) {
            uaField.value = newUA;
            console.log(
              "[学校账户管理] 已生成并填充随机UA:",
              newUA.substring(0, 50) + "..."
            );
          }
          const uaTextarea = $("edit-school-ua");
          if (uaTextarea) {
            uaTextarea.value = newUA;
          }
          showTempMessage("已生成随机User-Agent", "success");
        } catch (error) {
          console.error("[学校账户管理] 生成UA时发生错误:", error);
          showTempMessage("生成失败: " + error.message, "error");
        }
      }
      function closeEditSchoolAccountModal() {
        hideModal("edit-school-account-modal");
      }
      async function submitEditSchoolAccount() {
        const authUsername = $("edit-auth-username").textContent;
        const schoolUsername = $("edit-school-username").textContent;
        const password = $("edit-school-password").value.trim();
        const ua = $("edit-school-ua").value.trim();

        if (!password) {
          showModalAlert("密码不能为空", "错误");
          return;
        }

        try {
          const response = await fetch("/api/admin/school_account/update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              auth_username: authUsername,
              school_username: schoolUsername,
              password: password,
              ua: ua,
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert(result.message || "更新成功", "成功");
            closeEditSchoolAccountModal();
            await showUserSchoolAccounts(authUsername);
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (error) {
          console.error("submitEditSchoolAccount error:", error);
          showModalAlert("更新失败: " + error.message, "错误");
        }
      }

      async function deleteSchoolAccount(authUsername, schoolUsername) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          `确定要删除学校账户 <strong>${escapeHtml(
            schoolUsername
          )}</strong> 吗？此操作不可恢复。`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/api/admin/school_account/delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              auth_username: authUsername,
              school_username: schoolUsername,
            }),
          });
          const result = await response.json();
          if (result.success) {
            showModalAlert(result.message || "删除成功", "成功");
            await showUserSchoolAccounts(authUsername);
          } else {
            showModalAlert(result.message || "删除失败", "错误");
          }
        } catch (error) {
          console.error("deleteSchoolAccount error:", error);
          showModalAlert("删除失败: " + error.message, "错误");
        }
      }

      async function manageUserPermissions(username) {
        currentManageUsername = username;
        const modal = $("manage-user-permissions-modal");
        if (!modal) return;

        try {
          const response = await fetch("/auth/admin/get_user_permissions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ username: username }),
          });
          const result = await response.json();

          if (!result.success) {
            showModalAlert("无法加载用户权限信息", "错误");
            return;
          }

          const nameEl = $("manage-user-name");
          const groupEl = $("user-base-group");
          if (nameEl) nameEl.textContent = username;
          if (groupEl) groupEl.textContent = result.group || "guest";

          if (groupEl === "super_admin") {
            showModalAlert("无法修改超级管理员的权限", "错误");
          }
          const permissionsContainer = $("manage-user-permissions-list");
          if (permissionsContainer && result.all_permissions) {
            const groupPerms = result.group_permissions || {};
            const addedPerms = result.added_permissions || {};
            const removedPerms = result.removed_permissions || {};

            permissionsContainer.innerHTML = Object.keys(result.all_permissions)
              .map((perm) => {
                const groupHas = groupPerms[perm] || false;
                const isAdded = addedPerms[perm] === true;
                const isRemoved = removedPerms[perm] === true;
                const currentValue = result.all_permissions[perm];

                let statusClass = "";
                let statusText = "";
                if (isAdded) {
                  statusClass = "bg-green-50 border-green-200";
                  statusText = "(新增)";
                } else if (isRemoved) {
                  statusClass = "bg-red-50 border-red-200";
                  statusText = "(移除)";
                }

                return `
              <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer border ${statusClass}">
                <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}" data-group-value="${groupHas}" ${
                  currentValue ? "checked" : ""
                }>
                <span class="text-sm text-slate-700 flex-1">${translatePermission(
                  perm
                )}</span>
                ${
                  statusText
                    ? `<span class="text-xs ${
                        isAdded ? "text-green-600" : "text-red-600"
                      }">${statusText}</span>`
                    : ""
                }
              </label>
            `;
              })
              .join("");
          }

          modal.classList.remove("hidden");
          modal.classList.add("flex");
        } catch (e) {
          showModalAlert("加载失败: " + e.message, "错误");
        }
      }

      function closeManageUserPermissionsModal() {
        const modal = $("manage-user-permissions-modal");
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
        currentManageUsername = null;
      }

      async function submitManageUserPermissions() {
        if (!currentManageUsername) return;

        const permissionsContainer = $("manage-user-permissions-list");
        if (!permissionsContainer) return;

        const addedPermissions = {};
        const removedPermissions = {};

        const checkboxes = permissionsContainer.querySelectorAll(
          'input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => {
          const perm = cb.getAttribute("data-permission");
          const groupValue = cb.getAttribute("data-group-value") === "true";
          const currentValue = cb.checked;

          if (currentValue !== groupValue) {
            if (currentValue) {
              addedPermissions[perm] = true;
            } else {
              removedPermissions[perm] = true;
            }
          }
        });

        try {
          const response = await fetch("/auth/admin/set_user_permission", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              username: currentManageUsername,
              added_permissions: addedPermissions,
              removed_permissions: removedPermissions,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(
              `用户 ${currentManageUsername} 的权限已更新`,
              "成功"
            );
            closeManageUserPermissionsModal();
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      function showResetPasswordModal(username) {
        $("reset-password-username").textContent = username;
        $("reset-new-password").value = "";
        $("reset-confirm-password").value = "";
        showModal("reset-user-password-modal");
      }

      async function submitResetUserPassword() {
        const username = $("reset-password-username").textContent;
        const newPassword = $("reset-new-password").value;
        const confirmPassword = $("reset-confirm-password").value;

        if (!newPassword || !confirmPassword) {
          showModalAlert("请填写所有密码字段", "提示");
          return;
        }

        if (newPassword.length < 6) {
          showModalAlert("密码长度至少为6个字符", "错误");
          return;
        }

        if (newPassword !== confirmPassword) {
          showModalAlert("两次输入的密码不一致", "错误");
          return;
        }

        try {
          const response = await fetch("/auth/admin/reset_password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              username,
              new_password: newPassword,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 的密码已重置`, "成功");
            hideModal("reset-user-password-modal");
          } else {
            showModalAlert(result.message || "密码重置失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      function modifyUserPhone(username, currentPhone) {
        $("admin-modify-phone-username").value = username;
        $("admin-modify-phone-current").value = currentPhone || "未绑定";
        $("admin-modify-phone-new").value = "";
        $("admin-modify-phone-code").value = "";
        $("admin-modify-phone-modal").classList.remove("hidden");

        const adminCurrentPhoneInput = $("admin-modify-phone-current");
        const adminCurrentPhoneWrapper = adminCurrentPhoneInput
          ? adminCurrentPhoneInput.closest(".phone-input-wrapper")
          : null;
        if (adminCurrentPhoneWrapper) {
          const prefix =
            adminCurrentPhoneWrapper.querySelector(".phone-prefix");
          const isUnbound =
            !adminCurrentPhoneInput.value ||
            adminCurrentPhoneInput.value === "未绑定";

          if (prefix) {
            prefix.style.display = isUnbound ? "none" : "inline";
          }
          adminCurrentPhoneWrapper.classList.toggle("prefix-hidden", isUnbound);
        }
      }

      function closeAdminModifyPhoneModal() {
        $("admin-modify-phone-modal").classList.add("hidden");
      }

      async function sendAdminModifyPhoneCode() {
        const newPhone = $("admin-modify-phone-new").value.trim();
        if (!newPhone || !/^1[3-9]\d{9}$/.test(newPhone)) {
          showModalAlert("请输入正确的手机号");
          return;
        }

        const sendBtn = $("admin-modify-phone-send-btn");
        sendBtn.disabled = true;
        const originalText = sendBtn.textContent;

        try {
          const response = await fetch("/api/sms/send_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              phone: newPhone,
              scene: "modify",
            }),
          });
          const result = await response.json();

          if (result && result.success) {
            const expireMin = result.expire_minutes || 5;
            const retryAfter = result.retry_after || 180;
            showTempMessage(`验证码已发送，${expireMin}分钟内有效`, "success");

            let countdown = retryAfter;
            const timer = setInterval(() => {
              countdown--;
              sendBtn.textContent = `${countdown}秒后重试`;
              if (countdown <= 0) {
                clearInterval(timer);
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
              }
            }, 1000);
          } else {
            if (result?.retry_after) {
              let countdown = result.retry_after;
              sendBtn.textContent = `${countdown}秒后重试`;
              const timer = setInterval(() => {
                countdown--;
                sendBtn.textContent = `${countdown}秒后重试`;
                if (countdown <= 0) {
                  clearInterval(timer);
                  sendBtn.disabled = false;
                  sendBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              sendBtn.disabled = false;
            }
            showModalAlert(result?.message || "发送失败");
          }
        } catch (error) {
          sendBtn.disabled = false;
          showModalAlert("发送失败: " + error.message);
        }
      }

      async function submitAdminModifyPhone() {
        const username = $("admin-modify-phone-username").value;
        const newPhone = $("admin-modify-phone-new").value.trim();
        const code = $("admin-modify-phone-code").value.trim();

        if (!newPhone) {
          showModalAlert("请输入新手机号");
          return;
        }

        if (!/^1[3-9]\d{9}$/.test(newPhone)) {
          showModalAlert("请输入正确的手机号格式");
          return;
        }
        try {
          const bindResult = await callPythonAPI_raw(
            "/api/auth/check_phone",
            "POST",
            { phone: newPhone }
          );
          if (
            bindResult &&
            bindResult.is_bound &&
            bindResult.bound_to_user !== username
          ) {
            const confirmed = await jsShowConfirm(
              "手机号已被绑定",
              `您输入的新手机号 ${newPhone} 已被用户 ${bindResult.bound_to_user} 绑定。\n\n是否继续？\n\n如果继续，该手机号将从原账号上强制解绑并绑定到 ${username} 账号上。`
            );

            if (!confirmed) {
              logMessage_Info(
                "[管理员修改手机号] 用户取消操作，因为手机号已被绑定。"
              );
              return;
            }
            logMessage_Info(
              "[管理员修改手机号] 用户已确认强制解绑，继续操作..."
            );
          } else if (
            bindResult &&
            bindResult.is_bound &&
            bindResult.bound_to_user === username
          ) {
            showModalAlert("此手机号已绑定到该用户。", "提示");
            closeAdminModifyPhoneModal();
            return;
          }
        } catch (e) {
          logMessage_Error("检查手机号绑定失败:", e);
          showModalAlert(
            `检查手机号失败: ${e.message}，请稍后重试`,
            "网络错误"
          );
          return;
        }

        try {
          const response = await fetch("/auth/admin/update_user_phone", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              username: username,
              new_phone: newPhone,
              sms_code: code || "",
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 的手机号已更新`, "成功");
            closeAdminModifyPhoneModal();
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      function modifyUserNickname(username, currentNickname) {
        $("admin-modify-nickname-username").value = username;
        $("admin-modify-nickname-new").value = currentNickname || "";
        $("admin-modify-nickname-modal").classList.remove("hidden");
      }

      function closeAdminModifyNicknameModal() {
        $("admin-modify-nickname-modal").classList.add("hidden");
      }

      async function submitAdminModifyNickname() {
        const username = $("admin-modify-nickname-username").value;
        const newNickname = $("admin-modify-nickname-new").value.trim();

        if (!newNickname) {
          showModalAlert("请输入新昵称");
          return;
        }

        try {
          const response = await fetch("/auth/admin/update_user_nickname", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              username: username,
              nickname: newNickname,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`用户 ${username} 的昵称已更新`, "成功");
            closeAdminModifyNicknameModal();
            loadAdminUsers();
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }
      async function deleteGroup(groupKey) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          `确定要删除权限组 ${groupKey} 吗？\n此操作不可恢复！`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/delete_group", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ group_key: groupKey }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`权限组 ${groupKey} 已删除`, "成功");
            loadAdminGroups();
          } else {
            showModalAlert(result.message || "删除失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function editGroupPermissions(groupKey) {
        currentEditGroupKey = groupKey;
        if (groupKey === null || groupKey === undefined) return;
        if (groupKey === "super_admin") {
          showModalAlert("无法编辑超级管理员权限组", "错误");
          return;
        }
        const modal = $("edit-group-permissions-modal");
        if (!modal) return;

        try {
          const response = await fetch("/auth/admin/list_groups", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();

          if (!result.success || !result.groups || !result.groups[groupKey]) {
            showModalAlert("无法加载权限组信息", "错误");
            return;
          }

          const group = result.groups[groupKey];
          const nameEl = $("edit-group-name");
          if (nameEl) {
            nameEl.textContent = `${group.name} (${groupKey})`;
          }

          const permissionsContainer = $("edit-group-permissions-list");
          if (permissionsContainer && group.permissions) {
            permissionsContainer.innerHTML = Object.keys(group.permissions)
              .map(
                (perm) => `
            <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer">
              <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}" ${
                  group.permissions[perm] ? "checked" : ""
                }>
              <span class="text-sm text-slate-700">${translatePermission(
                perm
              )}</span>
            </label>
          `
              )
              .join("");
          }

          modal.classList.remove("hidden");
          modal.classList.add("flex");
        } catch (e) {
          showModalAlert("加载失败: " + e.message, "错误");
        }
      }

      function closeEditGroupPermissionsModal() {
        const modal = $("edit-group-permissions-modal");
        if (modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
        currentEditGroupKey = null;
      }

      async function submitEditGroupPermissions() {
        if (!currentEditGroupKey) return;

        const permissionsContainer = $("edit-group-permissions-list");
        if (!permissionsContainer) return;

        const permissions = {};
        const checkboxes = permissionsContainer.querySelectorAll(
          'input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => {
          const perm = cb.getAttribute("data-permission");
          permissions[perm] = cb.checked;
        });

        try {
          const response = await fetch("/auth/admin/update_group", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              group_key: currentEditGroupKey,
              permissions: permissions,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`权限组 ${currentEditGroupKey} 已更新`, "成功");
            closeEditGroupPermissionsModal();
            loadAdminGroups();
          } else {
            showModalAlert(result.message || "更新失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function loadAdminGroups() {
        try {
          const response = await fetch("/auth/admin/list_groups", {
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();

          if (!result.success) {
            $(
              "admin-groups-list"
            ).innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }

          const listEl = $("admin-groups-list_modal");
          const groups = result.groups;

          listEl.innerHTML = Object.keys(groups)
            .map((groupKey) => {
              const group = groups[groupKey];
              const perms = group.permissions;
              const isSystemGroup =
                group.system ||
                ["guest", "user", "admin", "super_admin"].includes(groupKey);
              const systemBadge = isSystemGroup
                ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-2">系统预设</span>'
                : "";
              const escapedGroupKey = groupKey
                .replace(/'/g, "&#39;")
                .replace(/"/g, "&quot;");
              const displayGroupKey = groupKey
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

              return `
        <div class="border border-slate-200 rounded-lg p-4 mb-2">
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-semibold text-slate-800">${
              group.name
            } (${displayGroupKey})${systemBadge}</h5>
            <div class="flex gap-2">
              <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="editGroupPermissions('${escapedGroupKey}')">编辑权限</button>
              ${
                !isSystemGroup
                  ? `<button class="btn btn-danger !py-0.5 !px-2 !text-xs" onclick="deleteGroup('${escapedGroupKey}')">删除</button>`
                  : ""
              }
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            ${Object.keys(perms)
              .map(
                (perm) => `
              <div class="flex items-center gap-2">
                <span class="${
                  perms[perm] ? "text-green-600" : "text-slate-400"
                }">${perms[perm] ? "✓" : "✗"}</span>
                <span class="text-slate-600">${translatePermission(perm)}</span>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;
            })
            .join("");
        } catch (e) {
          $(
            "admin-groups-list"
          ).innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      async function loadAdminSessions() {
        const listEl = $("admin-sessions-list_modal");

        if (!listEl) {
          logMessage_Error(
            "loadAdminSessions: 无法找到会话列表容器 'admin-sessions-list_modal'。"
          );
          showModalAlert("无法加载会话列表：界面元素丢失。", "错误");
          return;
        }

        try {
          listEl.innerHTML =
            '<p class="text-slate-400 text-center py-10">加载中...</p>';
          const godModeCheckbox = $("god-mode-checkbox_modal");
          const isGodMode = godModeCheckbox && godModeCheckbox.checked;

          let response;
          if (isGodMode) {
            response = await fetch("/auth/admin/all_sessions", {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            });
          } else {
            response = await fetch("/auth/user/sessions", {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            });
          }
          const result = await response.json();

          if (!result.success) {
            listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }
          const sessions = result.sessions || [];
          const maxSessions =
            result.max_sessions !== undefined && result.max_sessions !== null
              ? result.max_sessions
              : -1;
          const validSessions = sessions.filter(
            (session) =>
              session.session_id &&
              session.session_id !== "null" &&
              session.session_id.trim() !== ""
          );
          if (isGodMode) {
            updateAdminSessionCountDisplay(validSessions.length, -1);
          } else {
            updateAdminSessionCountDisplay(validSessions.length, maxSessions);
          }

          let html = "";
          const isGuest = currentUserIsGuest;
          if (!isGodMode) {
            if (!isGuest) {
              html = `
      <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-lg">
        <p class="text-sm text-slate-700 mb-2">选择现有会话或创建新会话</p>
        <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">创建新会话</button>
      </div>
    `;
            } else {
              html = `
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-700">游客模式：当前会话如下。如需使用多个会话，请注册账号。</p>
      </div>
    `;
            }
          }

          if (validSessions.length === 0) {
            html += '<p class="text-slate-400 text-center py-10">暂无会话</p>';
          } else {
            html += validSessions
              .map((session) => {
                const createdDate = session.created_at
                  ? new Date(session.created_at * 1000).toLocaleString()
                  : "未知";
                const isCurrent =
                  session.is_current || session.session_id === sessionUUID;
                const sessionHash =
                  session.session_hash || session.session_id.substring(0, 16);

                let ownerInfo = "";
                if (isGodMode) {
                  if (session.username) {
                    ownerInfo = `<p class="text-xs text-slate-500">创建者: ${session.username}</p>`;
                  } else {
                    ownerInfo = `<p class="text-xs text-amber-600">创建者: 游客模式</p>`;
                  }
                }

                return `
          <div class="border ${
            isCurrent ? "border-sky-500 bg-sky-50" : "border-slate-200"
          } rounded-lg p-3 mb-2">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold text-slate-800 break-all">会话 ${
                  session.session_id
                }</p>
                ${
                  isCurrent
                    ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2">(当前会话)</span></p>'
                    : ""
                }
                <p class="text-xs text-slate-500">创建时间: ${createdDate}</p>
                <p class="text-xs text-slate-500">状态: ${
                  session.is_multi_account_mode
                    ? session.login_success
                      ? '<span class="font-semibold text-green-600">已登录</span>'
                      : '<span class="font-semibold ">未登录</span>'
                    : session.login_success
                    ? '<span class="font-semibold text-green-600">已登录</span>'
                    : "未登录"
                }</p>
                ${ownerInfo}
              </div>
              <div class="flex gap-2">
                ${
                  !isCurrent
                    ? `
                  <button class="btn btn-ghost !py-1 !px-2 text-xs" onclick="selectSession('${session.session_id}')">选择</button>
                  <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" onclick="deleteSession('${session.session_id}')">删除</button>
                `
                    : ""
                }
                ${
                  isGodMode
                    ? `<button class="btn btn-danger !py-1 !px-2 text-xs" onclick="destroySession('${session.session_id}')">销毁</button>`
                    : ""
                }
              </div>
            </div>
          </div>
        `;
              })
              .join("");
          }
          listEl.innerHTML = html;
        } catch (e) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      // ========== 留言板功能 ========== //
      async function checkIPBanAndProceed(scope = "all") {
        try {
          const response = await fetch("/api/admin/check_ip_ban", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ scope: scope }),
          });

          const result = await response.json();

          return result.is_banned === true;
        } catch (err) {
          logMessage_Error("[IP封禁检查] 检查失败:", err);
          return false;
        }
      }

      async function loadMessages() {
        const listEl = $("admin-messages-list_modal");
        const guestFields = $("message-guest-fields");

        if (!listEl) {
          logMessage_Error("loadMessages: 无法找到留言列表容器");
          return;
        }
        const isGuest = currentUserIsGuest;
        if (guestFields) {
          guestFields.style.display = isGuest ? "block" : "none";
        }
        const contentInput = $("message-content");
        const charCount = $("message-char-count");
        if (contentInput && charCount) {
          contentInput.addEventListener("input", () => {
            charCount.textContent = contentInput.value.length;
          });
        }

        try {
          listEl.innerHTML =
            '<p class="text-slate-400 text-center py-10">加载中...</p>';

          const response = await fetch("/api/messages/list", {
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();

          if (!result.success) {
            listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }

          const messages = result.messages || [];

          if (messages.length === 0) {
            listEl.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无留言</p>';
            return;
          }
          const canDeleteAny = await checkAdminPermission(
            "delete_any_messages"
          );
          const canDeleteOwn = await checkAdminPermission(
            "delete_own_messages"
          );
          const currentUsername = currentAuthUsername;

          const html = messages
            .map((msg) => {
              const isOwnMessage =
                !msg.is_guest && msg.auth_username === currentUsername;
              const canDelete = canDeleteAny || (canDeleteOwn && isOwnMessage);
              const displayName =
                msg.nickname || msg.username || msg.auth_username || "匿名";
              const date = new Date(msg.timestamp * 1000);
              const dateStr = date.toLocaleString("zh-CN");
              const rawAvatarUrl = msg.avatar_url || "default_avatar.png";
              const ipCity = msg.ip_city || "";

              let finalAvatarSrc;
              if (rawAvatarUrl.startsWith("/api/avatar/")) {
                finalAvatarSrc = rawAvatarUrl;
              } else {
                finalAvatarSrc = `/api/avatar/${rawAvatarUrl}`;
              }
              if (typeof sessionUUID !== "undefined" && sessionUUID) {
                // 检查URL是否已有查询参数
                if (finalAvatarSrc.includes("?")) {
                  finalAvatarSrc += `&session_id=${sessionUUID}`;
                } else {
                  finalAvatarSrc += `?session_id=${sessionUUID}`;
                }
              }

              return `
            <div class="bg-white border border-slate-200 rounded-lg p-4 space-y-2">
              <div class="flex justify-between items-start gap-3">
                <!-- 左侧：头像和用户信息 -->
                <div class="flex gap-3 flex-1">
                  <!-- 用户头像 -->
                  <div class="flex-shrink-0 w-12 h-12 rounded-full bg-slate-200 overflow-hidden border-2 border-slate-300">
                    <img src="${finalAvatarSrc}" alt="头像" class="w-full h-full object-cover"
                      onerror="const p = this.parentElement; p.innerHTML='<span class=\\'text-2xl text-slate-400\\'>👤</span>'; p.classList.add('flex', 'items-center', 'justify-center');">
                  </div>
                  <!-- 用户信息 -->
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-semibold text-slate-700">${escapeHtml(
                        displayName
                      )}</span>
                      ${
                        msg.is_guest
                          ? '<span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded">游客</span>'
                          : ""
                      }
                      ${
                        ipCity
                          ? `<span class="text-xs text-slate-500">来自 ${escapeHtml(
                              ipCity
                            )}</span>`
                          : ""
                      }
                    </div>
                    ${
                      msg.email
                        ? `<p class="text-xs text-slate-500">${escapeHtml(
                            msg.email
                          )}</p>`
                        : ""
                    }
                    <p class="text-xs text-slate-400">${dateStr}</p>
                  </div>
                </div>
                <!-- 右侧：删除按钮 -->
                ${
                  canDelete
                    ? `
                  <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" 
                    onclick="deleteMessage('${msg.id}')">删除</button>
                `
                    : ""
                }
              </div>
              <!-- 留言内容 -->
              <p class="text-slate-700 whitespace-pre-wrap break-words pl-15">${escapeHtml(
                msg.content
              )}</p>
            </div>
          `;
            })
            .join("");
          listEl.innerHTML = html;
        } catch (e) {
          logMessage_Error("加载留言失败:", e);
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      async function postMessage() {
        // ============================================================
        // IP封禁检查：发表留言功能
        // ============================================================
        const isBanned = await checkIPBanAndProceed("messages_only");
        if (isBanned) {
          showModalAlert("您的IP已被限制访问留言功能", "访问被拒绝");
          return;
        }

        const contentInput = $("message-content");
        const nicknameInput = $("message-nickname");
        const emailInput = $("message-email");
        const postBtn = $("post-message-btn");

        if (!contentInput || !postBtn) return;

        const content = contentInput.value.trim();
        const nickname = nicknameInput ? nicknameInput.value.trim() : "";
        const email = emailInput ? emailInput.value.trim() : "";

        if (!content) {
          showModalAlert("请输入留言内容", "提示");
          return;
        }

        const isGuest = currentUserData?.is_guest;

        if (isGuest) {
          if (!nickname) {
            showModalAlert("游客必须填写昵称", "提示");
            return;
          }
          if (!email) {
            showModalAlert("游客必须填写邮箱", "提示");
            return;
          }
        }

        try {
          postBtn.disabled = true;
          postBtn.textContent = "发表中...";

          const response = await fetch("/api/messages/post", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              content: content,
              nickname: nickname,
              email: email,
            }),
          });

          const result = await response.json();

          if (result.success) {
            contentInput.value = "";
            if (nicknameInput) nicknameInput.value = "";
            if (emailInput) emailInput.value = "";
            const charCount = $("message-char-count");
            if (charCount) charCount.textContent = "0";

            showModalAlert("留言发表成功", "成功");
            await loadMessages();
          } else {
            showModalAlert(result.message || "发表留言失败", "错误");
          }
        } catch (e) {
          logMessage_Error("发表留言失败:", e);
          showModalAlert("发表留言失败: " + e.message, "错误");
        } finally {
          postBtn.disabled = false;
          postBtn.textContent = "发表留言";
        }
      }

      async function deleteMessage(messageId) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          "确定要删除这条留言吗？"
        );
        if (!confirmed) {
          return;
        }

        try {
          const response = await fetch("/api/messages/delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              message_id: messageId,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showModalAlert("留言已删除", "成功");
            await loadMessages();
          } else {
            showModalAlert(result.message || "删除留言失败", "错误");
          }
        } catch (e) {
          logMessage_Error("删除留言失败:", e);
          showModalAlert("删除留言失败: " + e.message, "错误");
        }
      }

      // =============用户日志查看功能================
      function showUserLogs(username) {
        $("user-logs-secondary-modal").classList.remove("hidden");
        const usernameDisplay = $("current-log-username-secondary");
        if (usernameDisplay) usernameDisplay.textContent = username;
        const loginTab = $("log-tab-login-secondary");
        const auditTab = $("log-tab-audit-secondary");
        const loginContent = $("log-login-content-secondary");
        const auditContent = $("log-audit-content-secondary");

        if (loginTab) {
          loginTab.classList.add("text-sky-600", "border-sky-600");
          loginTab.classList.remove("text-slate-400", "border-transparent");
        }
        if (auditTab) {
          auditTab.classList.add("text-slate-400", "border-transparent");
          auditTab.classList.remove("text-sky-600", "border-sky-600");
        }
        if (loginContent) loginContent.classList.remove("hidden");
        if (auditContent) auditContent.classList.add("hidden");
        loadUserLoginLogsSecondary(username);
      }

      function closeUserLogsSecondaryModal() {
        $("user-logs-secondary-modal").classList.add("hidden");
      }

      function switchUserLogTab(tab) {
        const loginTab = $("log-tab-login-secondary");
        const auditTab = $("log-tab-audit-secondary");
        const loginContent = $("log-login-content-secondary");
        const auditContent = $("log-audit-content-secondary");
        const username = $("current-log-username-secondary").textContent;

        if (tab === "login") {
          loginTab.classList.add("text-sky-600", "border-sky-600");
          loginTab.classList.remove("text-slate-400", "border-transparent");
          auditTab.classList.add("text-slate-400", "border-transparent");
          auditTab.classList.remove("text-sky-600", "border-sky-600");
          loginContent.classList.remove("hidden");
          auditContent.classList.add("hidden");
          loadUserLoginLogsSecondary(username);
        } else if (tab === "audit") {
          auditTab.classList.add("text-sky-600", "border-sky-600");
          auditTab.classList.remove("text-slate-400", "border-transparent");
          loginTab.classList.add("text-slate-400", "border-transparent");
          loginTab.classList.remove("text-sky-600", "border-sky-600");
          auditContent.classList.remove("hidden");
          loginContent.classList.add("hidden");
          loadUserAuditLogsSecondary(username);
        }
      }
      function getLoginStatusBadge(log) {
        if (log.success) {
          if (log.reason === "guest_login") {
            return '<span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-600">游客登录</span>';
          }
          return '<span class="text-xs px-2 py-1 rounded bg-green-100 text-green-600">登录成功</span>';
        }
        let reasonText = "登录失败";
        let reasonClass = "bg-red-100 text-red-700";

        switch (log.reason) {
          case "brute_force_locked":
            reasonText = "尝试过多";
            break;
          case "user_not_found":
            reasonText = "用户不存在";
            break;
          case "user_banned":
            reasonText = "账号已封禁";
            break;
          case "wrong_password":
            reasonText = "密码错误";
            break;
          case "2fa_failed":
            reasonText = "2FA验证失败";
            reasonClass = "bg-orange-100 text-orange-700";
            break;
        }
        return `<span class="text-xs px-2 py-1 rounded ${reasonClass}">${reasonText}</span>`;
      }
      async function loadUserLoginLogsSecondary(username) {
        const content = $("log-login-content-secondary");
        if (!content) return;
        content.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch(
            `/api/admin/logs/login_history?username=${encodeURIComponent(
              username
            )}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const data = await response.json();

          if (data.success && data.logs && data.logs.length > 0) {
            content.innerHTML = data.logs
              .map(
                (log) => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    登录时间: ${(log.datetime || "N/A").replace("T", " ")}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IP地址: ${log.ip_address || "N/A"}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    设备信息: ${log.user_agent || "N/A"}
                  </p>
                  ${
                    log.location
                      ? `<p class="text-sm text-slate-600 mt-1">位置: ${log.location}</p>`
                      : ""
                  }
                </div>
                <div class="flex-shrink-0">
                  ${getLoginStatusBadge(log)}
                </div>
              </div>
            </div>
          `
              )
              .join("");
          } else {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无登录记录</p>';
          }
        } catch (e) {
          content.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      async function loadUserAuditLogsSecondary(username) {
        const content = $("log-audit-content-secondary");
        if (!content) return;
        content.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch(
            `/api/admin/logs/audit?username=${encodeURIComponent(username)}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const data = await response.json();

          if (data.success && data.logs && data.logs.length > 0) {
            content.innerHTML = data.logs
              .map(
                (log) => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    时间: ${(log.datetime || "N/A").replace("T", " ")}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    操作类型: ${log.action || "N/A"}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    详情: ${log.details || "N/A"}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IP地址: ${log.ip_address || "N/A"}
                  </p>
                </div>
              </div>
            </div>
          `
              )
              .join("");
          } else {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无操作记录</p>';
          }
        } catch (e) {
          content.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }
      async function loadUserLoginLogs(username) {
        const content = $("log-login-content");
        if (!content) return;
        content.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch(
            `/api/admin/logs/login_history?username=${encodeURIComponent(
              username
            )}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const data = await response.json();

          if (data.success && data.logs && data.logs.length > 0) {
            content.innerHTML = data.logs
              .map(
                (log) => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    登录时间: ${(log.datetime || "N/A").replace("T", " ")}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IP地址: ${log.ip_address || "N/A"}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    设备信息: ${log.user_agent || "N/A"}
                  </p>
                  ${
                    log.location
                      ? `<p class="text-sm text-slate-600 mt-1">位置: ${log.location}</p>`
                      : ""
                  }
                </div>
                <div class="flex-shrink-0">
                  ${getLoginStatusBadge(log)}
                </div>
              </div>
            </div>
          `
              )
              .join("");
          } else {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无登录记录</p>';
          }
        } catch (e) {
          logMessage_Error("加载登录记录失败:", e);
          content.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }
      async function loadUserAuditLogs(username) {
        const content = $("log-audit-content");
        if (!content) return;
        content.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch(
            `/api/admin/logs/audit?username=${encodeURIComponent(username)}`,
            {
              headers: {
                "X-Session-ID": sessionUUID,
              },
            }
          );

          const data = await response.json();

          if (data.success && data.logs && data.logs.length > 0) {
            content.innerHTML = data.logs
              .map(
                (log) => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ${(log.datetime || "N/A").replace("T", " ")}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    操作: ${log.action || "N/A"}
                  </p>
                  ${
                    log.details
                      ? `<p class="text-sm text-slate-500 mt-1">${log.details}</p>`
                      : ""
                  }
                  ${
                    log.ip_address
                      ? `<p class="text-xs text-slate-400 mt-1">IP: ${log.ip_address}</p>`
                      : ""
                  }
                </div>
          `
              )
              .join("");
          } else {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无操作记录</p>';
          }
        } catch (e) {
          logMessage_Error("加载操作记录失败:", e);
          content.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }
      function closeUserLogsModal() {
        const logsModal = $("admin-user-logs-modal");
        if (logsModal) logsModal.classList.add("hidden");
        const usersPanel = $("admin-users-panel_modal");
        if (usersPanel) usersPanel.classList.remove("hidden");
      }

      // =======IP封禁管理函数==========
      async function loadIPBans() {
        try {
          const response = await fetch("/api/admin/ip_bans", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();

          const listEl = $("ip-ban-list");
          if (result.success && result.bans && result.bans.length > 0) {
            listEl.innerHTML = result.bans
              .map(
                (ban) => `
            <div class="border p-2 rounded flex justify-between items-center">
              <div>
                <span class="font-semibold">${escapeHtml(ban.target)}</span>
                <span class="text-xs text-slate-500 ml-2">[${ban.type}]</span>
                <span class="text-xs text-slate-500 ml-2">${
                  ban.scope === "all" ? "全部" : "仅留言板"
                }</span>
              </div>
              <button onclick="removeIPBan('${
                ban.id
              }')" class="btn btn-danger !py-1 !px-2 !text-xs min-h-[44px]">删除</button>
            </div>
          `
              )
              .join("");
          } else {
            listEl.innerHTML = '<p class="text-center py-4">暂无封禁规则</p>';
          }
        } catch (e) {
          showModalAlert("加载失败: " + e.message);
        }
      }
      // ====================
      // IP封禁管理函数
      // ====================
      const ipRegex =
        /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

      function ipToInt(ip) {
        try {
          return (
            ip
              .split(".")
              .reduce((int, octet) => (int << 8) + parseInt(octet, 10), 0) >>> 0
          );
        } catch (e) {
          return 0;
        }
      }
      // ============================================================
      // IP封禁模态框验证逻辑
      // ============================================================
      function validateIPBanTarget() {
        const banTypeSelect = $("ban-type");
        const banTargetInput = $("ban-target");
        const banTargetError = $("ban-target-error");

        if (!banTypeSelect || !banTargetInput || !banTargetError) {
          logMessage_Error(
            "validateIPBanTarget: 无法找到IP封禁模态框的DOM元素"
          );
          return false;
        }

        const type = banTypeSelect.value;
        const target = banTargetInput.value.trim();

        if (!target) {
          banTargetError.textContent = "封禁目标不能为空";
          banTargetError.classList.remove("hidden");
          banTargetInput.classList.add("border-red-500");
          return false;
        }

        if (type === "ip" && !ipRegex.test(target)) {
          banTargetError.textContent =
            "格式错误，请输入有效的单个IP地址 (例如: 1.2.3.4)";
          banTargetError.classList.remove("hidden");
          banTargetInput.classList.add("border-red-500");
          return false;
        }

        if (type === "range") {
          const parts = target.split("-");
          if (
            parts.length !== 2 ||
            !ipRegex.test(parts[0].trim()) ||
            !ipRegex.test(parts[1].trim())
          ) {
            banTargetError.textContent =
              "格式错误，请输入有效的IP范围 (例如: 192.168.1.1-192.168.1.100)";
            banTargetError.classList.remove("hidden");
            banTargetInput.classList.add("border-red-500");
            return false;
          }
          const startIpInt = ipToInt(parts[0].trim());
          const endIpInt = ipToInt(parts[1].trim());
          if (startIpInt > endIpInt) {
            banTargetError.textContent = "格式错误：起始IP必须小于或等于结束IP";
            banTargetError.classList.remove("hidden");
            banTargetInput.classList.add("border-red-500");
            return false;
          }
        }

        banTargetError.classList.add("hidden");
        banTargetInput.classList.remove("border-red-500");
        return true;
      }

      async function addIPBan() {
        if (!validateIPBanTarget()) {
          showModalAlert("输入格式不正确，请检查红色提示", "添加失败");
          return;
        }
        const target = $("ban-target").value.trim();
        const type = $("ban-type").value;
        const scope = $("ban-scope").value;

        try {
          const response = await fetch("/api/admin/ip_bans", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ target, type, scope }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert("封禁规则已添加");
            $("ban-target").value = "";

            const banTargetError = $("ban-target-error");
            const banTargetInput = $("ban-target");

            if (banTargetError) banTargetError.classList.add("hidden");

            banTargetError.classList.add("hidden");
            banTargetInput.classList.remove("border-red-500");
            loadIPBans();
          } else {
            showModalAlert(result.message || "添加失败");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message);
        }
      }

      async function removeIPBan(banId) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          "确定要删除此封禁规则吗？"
        );
        if (!confirmed) return;

        try {
          const response = await fetch(`/api/admin/ip_bans/${banId}`, {
            method: "DELETE",
            headers: { "X-Session-ID": sessionUUID },
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert("封禁规则已删除");
            loadIPBans();
          } else {
            showModalAlert(result.message || "删除失败");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message);
        }
      }

      // ====================
      // 任务20：短信服务配置函数
      // ====================
      async function loadSMSConfig() {
        try {
          const response = await fetch("/api/admin/sms/config", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();
          if (result.success) {
            $("sms-enabled").checked =
              result.config.enable_sms_service || false;
            $("sms-enable-phone-modification").checked =
              result.config.enable_phone_modification || false;
            $("sms-enable-phone-login").checked =
              result.config.enable_phone_login || false;
            $("sms-enable-phone-registration-verify").checked =
              result.config.enable_phone_registration_verify || false;
            $("sms-username").value = result.config.username || "";
            $("sms-apikey").value = result.config.api_key || "";
            $("sms-signature").value = result.config.signature || "";
            $("sms-template").value = result.config.template_register || "";
            $("sms-code-expire").value = result.config.code_expire_minutes || 5;
            $("sms-limit-account").value =
              result.config.rate_limit_per_account_day || 10;
            $("sms-limit-ip").value = result.config.rate_limit_per_ip_day || 20;
            $("sms-limit-phone").value =
              result.config.rate_limit_per_phone_day || 5;
            $(
              "sms-webhook-url"
            ).value = `${window.location.origin}/sms-reply-webhook`;
          }
        } catch (e) {
          showModalAlert("加载配置失败: " + e.message);
        }
      }
      async function saveSMSConfig() {
        const config = {
          enable_sms_service: $("sms-enabled").checked,
          enable_phone_modification: $("sms-enable-phone-modification").checked,
          enable_phone_login: $("sms-enable-phone-login").checked,
          enable_phone_registration_verify: $(
            "sms-enable-phone-registration-verify"
          ).checked,
          username: $("sms-username").value.trim(),
          api_key: $("sms-apikey").value.trim(),
          signature: $("sms-signature").value.trim(),
          template_register: $("sms-template").value.trim(),
          code_expire_minutes: parseInt($("sms-code-expire").value) || 5,
          rate_limit_per_account_day:
            parseInt($("sms-limit-account").value) || 10,
          rate_limit_per_ip_day: parseInt($("sms-limit-ip").value) || 20,
          rate_limit_per_phone_day: parseInt($("sms-limit-phone").value) || 5,
        };

        try {
          const response = await fetch("/api/admin/sms/config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify(config),
          });
          const result = await response.json();
          if (result.success) {
            showModalAlert("配置已保存");
          } else {
            showModalAlert(result.message || "保存失败");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message);
        }
      }
      function handleSmsMainSwitchChange() {
        const mainSwitchEnabled = $("sms-enabled").checked;
        if (!mainSwitchEnabled) {
          $("sms-enable-phone-modification").checked = false;
          $("sms-enable-phone-login").checked = false;
          $("sms-enable-phone-registration-verify").checked = false;
        }
      }
      async function checkSMSBalance() {
        const btn = $("btn-check-sms-balance");
        const originalText = "💰 查询余额";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "查询中...";
        }

        try {
          const response = await fetch("/api/admin/sms/check_balance", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();

          if (result.success) {
            const valEl = $("sms-balance-modal-value");
            const sentEl = $("sms-balance-modal-sent");
            const msgEl = $("sms-balance-modal-message");

            if (valEl) valEl.textContent = result.balance;
            if (sentEl) sentEl.textContent = result.sent_today;
            if (msgEl) {
              msgEl.textContent = result.message;
              if (
                result.message &&
                (result.message.includes("频繁") ||
                  result.message.includes("失败"))
              ) {
                msgEl.classList.add("text-amber-600", "bg-amber-50");
                msgEl.classList.remove("text-slate-500", "bg-slate-50");
              } else {
                msgEl.classList.remove("text-amber-600", "bg-amber-50");
                msgEl.classList.add("text-slate-500", "bg-slate-50");
              }
            }

            openSMSBalanceModal();
          } else {
            showModalAlert(result.message || "查询失败");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message);
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = originalText;
          }
        }
      }

      function openSMSBalanceModal() {
        showModal("sms-balance-modal");
      }

      function closeSMSBalanceModal() {
        hideModal("sms-balance-modal");
      }

      // ==================== 短信发送历史功能 ====================
      function openSMSHistoryModal() {
        $("sms-history-modal").classList.remove("hidden");
        loadSMSHistory();
      }

      function closeSMSHistoryModal() {
        $("sms-history-modal").classList.add("hidden");
      }
      async function loadSMSHistory() {
        try {
          const dateFilter = $("sms-history-date-filter").value;
          const phoneFilter = $("sms-history-phone-filter").value.trim();

          const params = new URLSearchParams();
          if (dateFilter) params.append("date", dateFilter);
          if (phoneFilter) params.append("phone", phoneFilter);

          const response = await fetch(
            `/api/admin/sms/history?${params.toString()}`,
            {
              headers: { "X-Session-ID": sessionUUID },
            }
          );
          const result = await response.json();

          const listContainer = $("sms-history-list");

          if (result.success && result.records && result.records.length > 0) {
            listContainer.innerHTML = result.records
              .map(
                (record) => `
            <div class="border-2 border-slate-200 rounded-lg p-4 hover:border-sky-300 transition-colors bg-white">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <span class="text-xs text-slate-500">📱 手机号</span>
                  <p class="font-semibold text-slate-700">+86 ${
                    record.phone || "N/A"
                  }</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">👤 用户名</span>
                  <p class="font-semibold text-slate-700">${
                    record.username || "未知"
                  }</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">🕐 时间</span>
                  <p class="text-sm text-slate-600">${
                    record.datetime || "N/A"
                  }</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">🌐 IP地址</span>
                  <p class="text-sm text-slate-600">${record.ip || "N/A"}</p>
                </div>
                <div class="md:col-span-2">
                  <span class="text-xs text-slate-500">💬 短信内容</span>
                  <p class="text-sm text-slate-600 bg-slate-50 p-2 rounded mt-1">${escapeHtml(
                    record.content || ""
                  )}</p>
                </div>
                ${
                  record.session_id &&
                  record.session_id !== "" &&
                  record.session_id !== "null"
                    ? `
                <div class="md:col-span-2">
                  <span class="text-xs text-slate-500">🔐 会话ID</span>
                  <p class="text-xs text-slate-400 font-mono">${record.session_id}</p>
                </div>
                `
                    : ""
                }
              </div>
            </div>
          `
              )
              .join("");
          } else {
            listContainer.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无记录</p>';
          }
        } catch (e) {
          showModalAlert("加载历史记录失败: " + e.message);
        }
      }

      // ==================== 短信测试发送功能 ====================
      function openSMSTestModal() {
        const modal = $("sms-test-modal");
        if (modal) {
          modal.classList.remove("hidden");
          document.body.classList.add("modal-visible");
          const phoneInput = $("sms-test-phone");
          if (phoneInput) {
            phoneInput.value = "";
          }
          const codeInput = $("sms-test-code-input");
          if (codeInput) {
            codeInput.value = "";
          }
          const resultDiv = $("sms-test-result");
          if (resultDiv) {
            resultDiv.classList.add("hidden");
          }
          const sendBtn = $("btn-send-test-sms");
          if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            发送测试短信
          `;
          }
        }
      }
      function closeSMSTestModal() {
        const modal = $("sms-test-modal");
        if (modal) {
          modal.classList.add("hidden");
        }
      }

      async function sendTestSMS() {
        const phoneInput = $("sms-test-phone");
        const codeInput = $("sms-test-code-input");
        const sendBtn = $("btn-send-test-sms");
        const resultDiv = $("sms-test-result");
        const codeDisplay = $("sms-test-code");
        const phoneDisplay = $("sms-test-phone-display");

        if (!phoneInput || !sendBtn) {
          showModalAlert("界面元素未找到，请刷新页面重试");
          return;
        }

        const phone = phoneInput.value.trim();
        const customCode = codeInput ? codeInput.value.trim() : "";

        if (!phone) {
          showModalAlert("请输入手机号");
          phoneInput.focus();
          return;
        }

        if (!/^1[3-9]\d{9}$/.test(phone)) {
          showModalAlert("手机号格式不正确，请输入11位有效手机号");
          phoneInput.focus();
          return;
        }

        if (customCode && !/^\d{4,8}$/.test(customCode)) {
          showModalAlert("自定义验证码格式不正确，仅支持4-8位数字");
          if (codeInput) codeInput.focus();
          return;
        }

        sendBtn.disabled = true;
        sendBtn.innerHTML = `
        <svg class="w-5 h-5 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        发送中...
      `;

        if (resultDiv) {
          resultDiv.classList.add("hidden");
        }

        try {
          const requestData = { phone };
          if (customCode) {
            requestData.code = customCode;
          }
          const response = await fetch("/api/sms/test_send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify(requestData),
          });

          const result = await response.json();

          if (result.success) {
            if (codeDisplay) {
              codeDisplay.textContent = result.code || "------";
            }
            if (phoneDisplay) {
              phoneDisplay.textContent = result.phone || phone;
            }
            if (resultDiv) {
              resultDiv.classList.remove("hidden");
            }
            showTempMessage("测试短信发送成功！请检查手机是否收到", "success");
            sendBtn.innerHTML = `
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 13l4 4L19 7"></path>
            </svg>
            已发送
          `;
            setTimeout(() => {
              if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                再次发送
              `;
              }
            }, 5000);
          } else {
            showModalAlert(result.message || "发送失败，请检查配置和余额");
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            发送测试短信
          `;
          }
        } catch (error) {
          console.error("[短信测试] 发送失败:", error);
          showModalAlert("网络错误：" + error.message);
          sendBtn.disabled = false;
          sendBtn.innerHTML = `
          <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          发送测试短信
        `;
        }
      }
      // ==================== 验证码管理功能 ====================
      let verificationCodesCountdownInterval = null;

      function updateVerificationCodeCountdowns() {
        const countdownElements = document.querySelectorAll(
          ".verification-code-countdown"
        );
        if (countdownElements.length === 0) {
          stopVerificationCodesCountdown();
          return;
        }

        const now = Math.floor(Date.now() / 1000);

        countdownElements.forEach((el) => {
          const expiresAt = parseInt(el.dataset.expiresAt, 10);
          if (isNaN(expiresAt)) {
            el.textContent = "已失效";
            return;
          }

          const expiresIn = Math.max(0, expiresAt - now);
          const minutes = Math.floor(expiresIn / 60);
          const seconds = expiresIn % 60;

          el.textContent = `${minutes}分${seconds}秒`;

          if (expiresIn <= 0) {
            el.textContent = "已失效";
            el.classList.add("text-red-600", "font-semibold");
          } else if (expiresIn < 120) {
            el.classList.add("text-red-600", "font-semibold");
            el.classList.remove("text-slate-600");
          }
        });
      }

      function startVerificationCodesCountdown() {
        stopVerificationCodesCountdown();
        updateVerificationCodeCountdowns();
        verificationCodesCountdownInterval = setInterval(
          updateVerificationCodeCountdowns,
          1000
        );
      }
      function stopVerificationCodesCountdown() {
        if (verificationCodesCountdownInterval) {
          clearInterval(verificationCodesCountdownInterval);
          verificationCodesCountdownInterval = null;
        }
      }
      function openVerificationCodesModal() {
        $("verification-codes-modal").classList.remove("hidden");
        loadVerificationCodes();
      }
      function closeVerificationCodesModal() {
        $("verification-codes-modal").classList.add("hidden");
        stopVerificationCodesCountdown();
      }
      async function loadVerificationCodes() {
        try {
          const response = await fetch("/api/admin/sms/verification_codes", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();

          const listContainer = $("verification-codes-list");

          if (result.success && result.codes && result.codes.length > 0) {
            listContainer.innerHTML = result.codes
              .map((item) => {
                const expiresIn = Math.max(0, Math.floor(item.expires_in / 60));
                const expiresSec = Math.max(0, item.expires_in % 60);
                return `
            <div class="border-2 border-slate-200 rounded-lg p-4 bg-white hover:border-sky-300 transition-colors">
              <div class="flex items-center justify-between gap-4">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <span class="text-xs text-slate-500">📱 手机号</span>
                    <p class="font-semibold text-slate-700">+86 ${
                      item.phone
                    }</p>
                  </div>
                  <div>
                    <span class="text-xs text-slate-500">🔢 验证码</span>
                    <p class="font-mono text-lg font-bold text-sky-600">${
                      item.code
                    }</p>
                  </div>
                  <div>
                    <span class="text-xs text-slate-500">⏰ 剩余时间</span>
                    <p class="verification-code-countdown text-sm ${
                      expiresIn < 2
                        ? "text-red-600 font-semibold"
                        : "text-slate-600"
                    }"
                       data-expires-at="${item.expires_at}">
                      ${expiresIn}分${expiresSec}秒
                    </p>
                  </div>
                </div>
                <button onclick="invalidateVerificationCode('${item.phone}')" 
                  class="btn btn-ghost border border-red-300 text-red-600 hover:bg-red-50 whitespace-nowrap">
                  ❌ 失效
                </button>
              </div>
            </div>
          `;
              })
              .join("");
          } else {
            listContainer.innerHTML =
              '<p class="text-slate-400 text-center py-10">当前没有有效的验证码</p>';
          }

          startVerificationCodesCountdown();
        } catch (e) {
          showModalAlert("加载验证码列表失败: " + e.message);
          stopVerificationCodesCountdown();
        }
      }
      async function invalidateVerificationCode(phone) {
        const confirmed = await jsShowConfirm(
          "确认失效",
          `确定要使手机号 +86 ${phone} 的验证码失效吗？`
        );
        if (!confirmed) {
          return;
        }

        try {
          const response = await fetch("/api/admin/sms/invalidate_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ phone: phone }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("验证码已失效", "成功");
            loadVerificationCodes();
          } else {
            showModalAlert(result.message || "操作失败");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message);
        }
      }
      async function addManualVerificationCode() {
        const phone = $("manual-code-phone").value.trim();
        let code = $("manual-code-value").value.trim();
        if (!code) {
          code = Math.floor(100000 + Math.random() * 900000).toString();
          $("manual-code-value").value = code;
        } else if (!/^\d{6}$/.test(code)) {
          showModalAlert("验证码必须是6位数字");
          return;
        }
        if (!code || !/^\d{6}$/.test(code)) {
          showModalAlert("请输入6位数字验证码");
          return;
        }

        try {
          const response = await fetch("/api/admin/sms/add_manual_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              phone: phone,
              code: code,
            }),
          });
          const result = await response.json();

          if (result.success) {
            showModalAlert("验证码已添加", "成功");
            $("manual-code-phone").value = "";
            $("manual-code-value").value = "";
            loadVerificationCodes();
          } else {
            showModalAlert(result.message || "添加失败");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message);
        }
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ========== 按钮权限校验 ========== //

      async function checkButtonPermission(buttonId, permissionName) {
        const hasPermission = await checkAdminPermission(permissionName);
        if (!hasPermission) {
          showModalAlert(`您没有权限使用此功能`, "权限不足");
          return false;
        }
        return true;
      }

      function updateAdminSessionCountDisplay(currentCount, maxSessions) {
        const countEl = $("admin-session-count-display");
        if (!countEl) return;

        if (currentUserIsGuest) {
          countEl.innerHTML = `<span class="text-blue-600">会话数: 1 / 游客仅限单会话</span>`;
        } else if (maxSessions === -1) {
          countEl.innerHTML = `<span class="text-green-600">会话数: ${currentCount} / 无限制</span>`;
        } else {
          const isNearLimit = currentCount >= maxSessions * 0.8;
          const isAtLimit = currentCount >= maxSessions;
          const colorClass = isAtLimit
            ? "text-red-600"
            : isNearLimit
            ? "text-amber-600"
            : "text-slate-600";
          countEl.innerHTML = `<span class="${colorClass}">会话数: ${currentCount} / ${maxSessions}</span>`;
        }
      }

      // ====================
      // 上帝模式：销毁会话
      // ====================
      async function destroySession(sessionId) {
        const sessionHash = sessionId.substring(0, 16);
        const confirmed = await jsShowConfirm(
          "确认销毁",
          `确定要销毁会话\n${sessionHash}...\n吗？\n此操作将强制终止该会话！`
        );
        if (!confirmed) return;

        try {
          const response = await fetch("/auth/admin/destroy_session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ session_id: sessionId }),
          });

          const result = await response.json();
          if (result.success) {
            showModalAlert(`会话 ${sessionId} 已销毁`, "成功");
            loadAdminSessions();
            loadAdminSessions_inline();
          } else {
            showModalAlert(result.message || "销毁失败", "错误");
          }
        } catch (e) {
          showModalAlert("操作失败: " + e.message, "错误");
        }
      }

      async function selectSession(sessionId) {
        const confirmed = await jsShowConfirm(
          "确认切换",
          `确定要切换到会话\n ${sessionId} \n吗？`
        );

        if (!confirmed) {
          logMessage_Info("[会话切换] 用户取消操作。");
          return;
        }

        // ========== 修改开始：上帝模式直接跳转 ==========
        // 检查当前用户是否为超级管理员
        if (currentUserData && currentUserData.group === "super_admin") {
          logMessage_Info(
            "[上帝模式] 识别到管理员身份，保留Token并直接跳转..."
          );

          // 保存当前管理员的会话ID作为返回点
          // 注意：如果已经是通过上帝模式进入的二级页面，不要覆盖原始的来源
          if (!localStorage.getItem("admin_return_origin")) {
            localStorage.setItem("admin_return_origin", sessionUUID);
          }

          Swal.fire({
            icon: "success",
            title: "上帝模式",
            text: "正在以管理员身份进入会话...",
            timer: 800,
            showConfirmButton: false,
          }).then(() => {
            window.location.href = `/uuid=${sessionId}`;
          });
          return; // 直接返回，不执行后续的 switch_session
        }

        Swal.fire({
          title: "正在切换会话...",
          text: "正在更新认证信息，请稍候",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        logMessage_Info(
          `[会话切换] 准备切换到会话 ${sessionId.substring(0, 16)}...`
        );

        try {
          const response = await fetch("/auth/switch_session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            credentials: "include",
            body: JSON.stringify({
              target_session_id: sessionId,
            }),
          });

          const result = await response.json();

          Swal.close();

          if (response.ok && result.success) {
            logMessage_Info(
              `[会话切换] ✓ 认证信息更新成功，准备跳转到 ${sessionId.substring(
                0,
                16
              )}...`
            );
            Swal.fire({
              icon: "success",
              title: "切换准备就绪",
              text: "即将跳转到目标会话...",
              timer: 1000,
              showConfirmButton: false,
            }).then(() => {
              window.location.href = `/uuid=${sessionId}`;
            });
          } else {
            logMessage_Info(`[会话切换] ✗ 切换失败: ${result.message}`);
            Swal.fire({
              icon: "error",
              title: "切换失败",
              text: result.message || "无法更新认证信息，请稍后重试。",
            });
            if (result.need_login) {
              Swal.fire({
                icon: "warning",
                title: "需要重新登录",
                text: result.message || "认证已失效，请重新登录",
                confirmButtonText: "返回登录",
                allowOutsideClick: false,
              }).then(() => {
                window.location.href = "/";
              });
            }
          }
        } catch (e) {
          Swal.close();
          logMessage_Info(
            `[会话切换] ✗ 切换时发生网络或脚本错误: ${e.message}`
          );
          Swal.fire({
            icon: "error",
            title: "切换出错",
            text: `网络或脚本错误: ${e.message}`,
          });
        }
      }

      async function deleteSession(sessionId) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          `确定要删除会话\n ${sessionId} \n吗？\n此操作不可恢复！`
        );

        if (!confirmed) {
          logMessage_Info("[会话删除] 用户取消操作。");
          return;
        }

        Swal.fire({
          title: "正在删除会话...",
          text: "请稍候",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        logMessage_Info(`[会话删除] 准备删除会话 ${sessionId}...`);

        try {
          const response = await fetch("/auth/user/delete_session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              session_id: sessionId,
            }),
          });

          const result = await response.json();

          Swal.close();

          if (result.success) {
            logMessage_Info(`[会话删除] ✓ 会话 ${sessionId} 已删除。`);
            Swal.fire({
              icon: "success",
              title: "删除成功",
              timer: 1500,
              showConfirmButton: false,
            }).then(() => {
              const adminModal = document.getElementById("admin-panel-modal");
              if (adminModal && !adminModal.classList.contains("hidden")) {
                loadAdminSessions();
              } else {
                loadAdminSessions_inline();
              }
            });
          } else {
            logMessage_Info(`[会话删除] ✗ 删除失败: ${result.message}`);
            Swal.fire({
              icon: "error",
              title: "删除失败",
              text: result.message || "无法删除会话，请稍后重试。",
            });
          }
        } catch (e) {
          Swal.close();
          logMessage_Info(
            `[会话删除] ✗ 删除时发生网络或脚本错误: ${e.message}`
          );
          Swal.fire({
            icon: "error",
            title: "删除出错",
            text: `网络或脚本错误: ${e.message}`,
          });
        }
      }

      // ====================
      // 会话选择器模态框函数
      // ====================

      function showSessionPicker() {
        const modal = $("session-picker-modal");
        if (!modal) return;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.classList.add("modal-visible");

        loadSessionPickerList();
      }

      function closeSessionPicker() {
        const modal = $("session-picker-modal");
        if (!modal) return;

        modal.classList.add("hidden");
        modal.classList.remove("flex");
        document.body.classList.remove("modal-visible");
      }

      async function loadSessionPickerList() {
        const listEl = $("session-picker-list");
        if (!listEl) return;

        listEl.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const headers = {
            "X-Session-ID": sessionUUID || null,
          };

          const response = await fetch("/auth/user/sessions", {
            headers: headers,
          });
          const result = await response.json();

          if (!result.success) {
            listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }

          const sessions = result.sessions || [];

          currentSessionInfo.maxSessions = result.max_sessions || 1;
          const validSessions = sessions.filter(
            (session) =>
              session.session_id &&
              session.session_id !== "null" &&
              session.session_id.trim() !== ""
          );

          currentSessionInfo.currentCount = validSessions.length;
          updateSessionCountDisplay();

          if (validSessions.length === 0) {
            listEl.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无会话，请创建新会话</p>';
            return;
          }

          listEl.innerHTML = validSessions
            .map((session) => {
              const createdDate = session.created_at
                ? new Date(session.created_at * 1000).toLocaleString()
                : "未知";
              const isCurrent =
                session.is_current || session.session_id === sessionUUID;
              const sessionHash =
                session.session_hash || session.session_id.substring(0, 16);

              return `
            <div class="border ${
              isCurrent ? "border-sky-500 bg-sky-50" : "border-slate-200"
            } rounded-lg p-3 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="font-semibold text-slate-800 break-all"> 会话 ${
                    session.session_id
                  }
                    
                  </p>
                  ${
                    isCurrent
                      ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2 px-2 py-0.5 bg-sky-100 rounded-full">(当前)</span></p>'
                      : ""
                  }
                  <p class="text-xs text-slate-500 mt-1">创建时间: ${createdDate}</p>
                  <p class="text-xs mt-1">
                    <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${
                      session.is_multi_account_mode
                        ? session.login_success
                          ? "bg-green-100 text-green-700"
                          : "bg-gray-100 text-gray-700"
                        : session.login_success
                        ? "bg-green-100 text-green-700"
                        : "bg-gray-100 text-gray-700"
                    }">
                      ${
                        session.is_multi_account_mode
                          ? session.login_success
                            ? "✓ 已登录"
                            : "○ 未登录"
                          : session.login_success
                          ? "✓ 已登录"
                          : "○ 未登录"
                      }
                    </span>
                  </p>
                </div>
                <div class="flex flex-col gap-2">
                  ${
                    !isCurrent
                      ? `
                    <button class="btn btn-primary !py-1 !px-3 text-xs" onclick="selectSessionFromPicker('${session.session_id}')">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                      </svg>
                      进入
                    </button>
                    <button class="btn btn-ghost !py-1 !px-3 !text-red-600 text-xs border border-red-200 hover:bg-red-50" onclick="deleteSessionFromPicker('${session.session_id}')">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                      删除
                    </button>
                  `
                      : '<span class="text-xs text-slate-400">当前会话</span>'
                  }
                </div>
              </div>
            </div>
          `;
            })
            .join("");
        } catch (e) {
          logMessage_Error("加载会话列表失败:", e);
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }

      function refreshSessionPicker() {
        loadSessionPickerList();
      }

      function updateSessionCountDisplay() {
        const countEl = $("session-count-display");
        if (!countEl) return;

        const { currentCount, maxSessions } = currentSessionInfo;

        if (maxSessions === -1) {
          countEl.innerHTML = `<span class="text-green-600">会话数: ${currentCount} / 无限制</span>`;
        } else {
          const isNearLimit = currentCount >= maxSessions * 0.8;
          const isAtLimit = currentCount >= maxSessions;
          const colorClass = isAtLimit
            ? "text-red-600"
            : isNearLimit
            ? "text-amber-600"
            : "text-slate-600";
          countEl.innerHTML = `<span class="${colorClass}">会话数: ${currentCount} / ${maxSessions}</span>`;
        }
      }

      async function selectSessionFromPicker(sessionId) {
        logMessage_Info(`准备切换到会话 ${sessionId.substring(0, 16)}...`);
        closeSessionPicker();

        // ========== 修改开始：上帝模式直接跳转 ==========
        if (currentUserData && currentUserData.group === "super_admin") {
          logMessage_Info(
            "[上帝模式-移动端] 识别到管理员身份，保留Token并直接跳转..."
          );
          if (!localStorage.getItem("admin_return_origin")) {
            localStorage.setItem("admin_return_origin", sessionUUID);
          }
          window.location.href = `/uuid=${sessionId}`;
          return;
        }
        // ========== 修改结束 ==========

        try {
          logMessage_Info(
            `正在为目标会话 ${sessionId.substring(0, 16)} 刷新认证令牌...`
          );

          const response = await fetch("/auth/switch_session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            credentials: "include",
            body: JSON.stringify({
              target_session_id: sessionId,
            }),
          });
          const result = await response.json();
          if (response.ok && result.success) {
            logMessage_Info(
              `令牌更新成功，正在跳转到会话 ${sessionId.substring(0, 16)}...`
            );
            window.location.href = `/uuid=${sessionId}`;
          } else {
            logMessage_Info(`[错误] 无法切换会话: ${result.message}`);
            showModalAlert(`无法切换会话: ${result.message}`, "切换失败");
            if (result.need_login) {
              Swal.fire({
                icon: "warning",
                title: "需要重新登录",
                text: result.message || "认证已失效，请重新登录",
                confirmButtonText: "返回登录",
                allowOutsideClick: false,
              }).then(() => {
                window.location.href = "/";
              });
            }
          }
        } catch (e) {
          logMessage_Error("切换会话失败:", e);
          logMessage_Info(`[错误] 切换会话时发生网络或脚本错误: ${e.message}`);
          showModalAlert(
            `切换会话时发生网络或脚本错误: ${e.message}`,
            "切换失败"
          );
        }
      }

      async function createNewSessionFromPicker() {
        try {
          logMessage_Info("[会话创建] 正在获取最新会话信息...");
          const response = await fetch("/auth/user/sessions", {
            headers: {
              "X-Session-ID": sessionUUID || null,
            },
          });
          const result = await response.json();

          if (result.success) {
            currentSessionInfo.maxSessions =
              result.max_sessions !== undefined && result.max_sessions !== null
                ? result.max_sessions
                : -1;
            const validSessions = (result.sessions || []).filter(
              (session) =>
                session.session_id &&
                session.session_id !== "null" &&
                session.session_id.trim() !== ""
            );
            currentSessionInfo.currentCount = validSessions.length;
            logMessage_Info(
              `[会话创建] 会话信息已更新: 当前 ${
                currentSessionInfo.currentCount
              } / 最大 ${
                currentSessionInfo.maxSessions === -1
                  ? "无限制"
                  : currentSessionInfo.maxSessions
              }`
            );
            updateSessionCountDisplay();
            updateAdminSessionCountDisplay(
              currentSessionInfo.currentCount,
              currentSessionInfo.maxSessions
            );
            updateAdminSessionCountDisplayInline(
              currentSessionInfo.currentCount,
              currentSessionInfo.maxSessions
            );
          } else {
            logMessage_Info(
              `[会话创建] 警告: 获取最新会话信息失败: ${result.message}`
            );
            showModalAlert(
              "无法获取最新的会话限制信息，将继续尝试创建。",
              "警告"
            );
          }
        } catch (error) {
          logMessage_Info(
            `[会话创建] 错误: 获取最新会话信息时发生网络错误: ${error}`
          );
          showModalAlert(
            `获取最新的会话限制信息时发生网络错误: ${error.message}，将继续尝试创建。`,
            "网络错误"
          );
        }
        if (
          currentSessionInfo.maxSessions !== -1 &&
          currentSessionInfo.currentCount >= currentSessionInfo.maxSessions
        ) {
          const result = await Swal.fire({
            title: "会话数量已达上限",
            html: `您已达到最大会话数量限制（${currentSessionInfo.maxSessions}个）。<br><br>是否要自动删除最早的会话并创建新会话？`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "确定，删除最旧会话",
            cancelButtonText: "取消",
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
          });

          if (!result.isConfirmed) {
            logMessage_Info("[会话创建] 用户取消操作：会话数已达上限。");
            return;
          }
          try {
            const response = await fetch("/auth/user/sessions", {
              headers: { "X-Session-ID": sessionUUID || null },
            });
            const sessionsResult = await response.json();

            if (
              sessionsResult.success &&
              sessionsResult.sessions &&
              sessionsResult.sessions.length > 0
            ) {
              const validSessions = sessionsResult.sessions.filter(
                (s) =>
                  s.session_id &&
                  s.session_id !== "null" &&
                  s.session_id.trim() !== "" &&
                  s.session_id !== sessionUUID
              );

              if (validSessions.length > 0) {
                validSessions.sort(
                  (a, b) => (a.created_at || 0) - (b.created_at || 0)
                );
                const oldestSession = validSessions[0];

                logMessage_Info(
                  `[会话管理] 正在删除最旧的会话: ${oldestSession.session_id.substring(
                    0,
                    16
                  )}...`
                );
                const deleteResponse = await fetch(
                  "/auth/user/delete_session",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "X-Session-ID": sessionUUID,
                    },
                    body: JSON.stringify({
                      session_id: oldestSession.session_id,
                    }),
                  }
                );

                const deleteResult = await deleteResponse.json();
                if (deleteResult.success) {
                  logMessage_Info(`[会话管理] 已删除最旧的会话`);
                } else {
                  logMessage_Info(
                    `[会话管理] 删除会话失败: ${deleteResult.message}`
                  );
                }
              }
            }
          } catch (e) {
            logMessage_Info(`[会话管理] 删除旧会话时出错: ${e.message}`);
          }
        }

        const newUUID = generateUUID();
        logMessage_Info(`正在创建新会话 ${newUUID}`);
        const confirmed = await jsShowConfirm(
          "确认操作",
          "您确定要创建一个新的会话吗？"
        );

        if (!confirmed) {
          logMessage_Info("[会话创建] 用户取消操作。");
          return;
        }
        let mobileButton = null;
        if (isMobileMode) {
          mobileButton = $("mobile-create-session-btn");
          if (mobileButton) {
            mobileButton.disabled = true;
            mobileButton.innerHTML = "正在创建...";
          }
        } else {
          Swal.fire({
            title: "正在创建新会话...",
            text: "请稍候",
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });
        }

        logMessage_Info(`[会话创建] 准备创建新会话...`);
        try {
          const response = await fetch(
            "/auth/user/create_session_persistence",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Session-ID": sessionUUID,
              },
              body: JSON.stringify({
                session_id: newUUID,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            logMessage_Info(`会话持久化文件已创建: ${result.message}`);
            if (result.cleanup_message) {
              logMessage_Info(`提示: ${result.cleanup_message}`);
            }
            if (isMobileMode) {
              closeMobileSessionPicker();
            } else {
              closeSessionPicker();
            }
            window.location.href = `/uuid=${newUUID}`;
          } else {
            logMessage_Info(`创建会话失败: ${result.message}`);
            if (isMobileMode) {
              showModalAlert(result.message, "创建失败");
              if (mobileButton) {
                mobileButton.disabled = false;
                mobileButton.innerHTML = `
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              创建新会话
            `;
              }
            } else {
              Swal.fire({
                icon: "error",
                title: "创建失败",
                text: result.message,
              });
            }
          }
        } catch (e) {
          logMessage_Info(`创建会话时发生错误: ${e.message}`);
          if (isMobileMode) {
            if (mobileButton) {
              mobileButton.disabled = false;
              mobileButton.innerHTML = `
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              创建新会话
            `;
            }
          } else {
            Swal.close();
          }
          showModalAlert(`创建会话失败: ${e.message}`, "创建失败");
        }
      }

      async function deleteSessionFromPicker(sessionId) {
        const confirmed = await jsShowConfirm(
          "确认删除",
          "确定要删除此会话吗？<br>此操作不可恢复！"
        );
        if (!confirmed) return;
        Swal.fire({
          title: "正在删除会话...",
          text: "请稍候",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const response = await fetch("/auth/user/delete_session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              session_id: sessionId,
            }),
          });

          const result = await response.json();
          Swal.close();

          if (result.success) {
            showModalAlert("会话已删除", "成功");
            const mobilePicker = $("mobile-session-picker-modal");
            const desktopPicker = $("session-picker-modal");

            if (mobilePicker && !mobilePicker.classList.contains("hidden")) {
              logMessage_Info("[会话删除] 正在刷新移动端会话列表...");
              loadMobileSessionPickerList();
            } else if (
              desktopPicker &&
              !desktopPicker.classList.contains("hidden")
            ) {
              logMessage_Info("[会话删除] 正在刷新桌面端会话列表...");
              loadSessionPickerList();
            } else {
              logMessage_Info("[会话删除] 正在刷新（兜底）...");
              if (isMobileMode) {
                loadMobileSessionPickerList();
              } else {
                loadSessionPickerList();
              }
            }
          } else {
            showModalAlert("删除失败: " + result.message, "错误");
          }
        } catch (e) {
          Swal.close();
          showModalAlert("删除失败: " + e.message, "错误");
        }
      }
      function validateInput(input, type) {
        if (!input || input.trim() === "") {
          return { valid: false, message: "输入不能为空" };
        }

        switch (type) {
          case "username":
            if (input.length < 3 || input.length > 50) {
              return { valid: false, message: "用户名长度应在3-50个字符之间" };
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(input)) {
              return {
                valid: false,
                message: "用户名只能包含字母、数字、下划线和连字符",
              };
            }
            break;
          case "password":
            if (input.length < 6) {
              return { valid: false, message: "密码长度至少6个字符" };
            }
            break;
          case "email":
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(input)) {
              return { valid: false, message: "请输入有效的邮箱地址" };
            }
            break;
        }

        return { valid: true };
      }
      let sessionValidityCheckInterval = null;
      async function checkSessionValidity() {
        if (!sessionUUID) {
          logMessage_Info("[会话检查] 无UUID，跳过检查");
          return;
        }

        try {
          const response = await fetch("/auth/check_uuid_type", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ uuid: sessionUUID }),
          });

          const result = await response.json();

          if (result.success && result.uuid_type === "unknown") {
            logMessage_Warning("[会话检查] 会话不存在，UUID类型为unknown");
            if (sessionValidityCheckInterval) {
              clearInterval(sessionValidityCheckInterval);
              sessionValidityCheckInterval = null;
            }

            // 检查遮罩是否已存在，防止重复创建
            if (document.getElementById("logout-elsewhere-overlay")) {
              return;
            }

            const logoutOverlay = document.createElement("div");
            logoutOverlay.id = "logout-elsewhere-overlay";
            logoutOverlay.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.85);
              z-index: 9999;
              display: flex;
              align-items: center;
              justify-content: center;
            `;

            const modalContent = document.createElement("div");
            modalContent.style.cssText = `
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              padding: 40px;
              border-radius: 20px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
              max-width: 500px;
              width: 90%;
              text-align: center;
              color: white;
            `;

            const icon = document.createElement("div");
            icon.innerHTML = `
              <svg style="width: 80px; height: 80px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
            `;

            const title = document.createElement("h2");
            title.textContent = "会话已失效";
            title.style.cssText = `
              font-size: 24px;
              font-weight: bold;
              margin: 0 0 20px 0;
            `;

            const text = document.createElement("p");
            text.textContent =
              "UUID不存在 (文件未找到)\n您的会话已过期或不存在，请重新登录";
            text.style.cssText = `
              font-size: 16px;
              line-height: 1.6;
              margin: 0 0 30px 0;
              opacity: 0.95;
              white-space: pre-wrap;
            `;

            const button = document.createElement("button");
            button.textContent = "返回登录";
            button.style.cssText = `
              background: white;
              color: #667eea;
              border: none;
              padding: 12px 30px;
              border-radius: 25px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              transition: all 0.3s;
            `;
            button.onmouseover = () => {
              button.style.transform = "scale(1.05)";
              button.style.boxShadow = "0 5px 15px rgba(255, 255, 255, 0.3)";
            };
            button.onmouseout = () => {
              button.style.transform = "scale(1)";
              button.style.boxShadow = "none";
            };

            button.onclick = () => {
              logMessage_Info("[会话检查] 用户确认会话失效，跳转到登录页面");
              window.location.href = "/";
            };

            modalContent.appendChild(icon);
            modalContent.appendChild(title);
            modalContent.appendChild(text);
            modalContent.appendChild(button);
            logoutOverlay.appendChild(modalContent);
            document.body.appendChild(logoutOverlay);
          } else if (!result.success) {
            logMessage_Warning("[会话检查] 检查失败:", result.message);
          } else {
            logMessage_Info("[会话检查] 会话有效，UUID类型:", result.uuid_type);
          }
        } catch (error) {
          logMessage_Error("[会话检查] 检查请求失败:", error);
        }
      }
      function startSessionValidityCheck() {
        if (sessionValidityCheckInterval) {
          logMessage_Info("[会话检查] 定期检查已在运行");
          return;
        }

        logMessage_Info("[会话检查] 启动定期检查，间隔5分钟");
        checkSessionValidity();
        sessionValidityCheckInterval = setInterval(
          checkSessionValidity,
          5 * 60 * 1000
        );
      }
      async function initializeApp() {
        function ShowMobileLoadingOverlay() {
          const isMobile = detectMobileDevice();
          if (isMobile) {
            $("mobile-loading-overlay").classList.remove("hidden");
          }
        }

        function HiddenMobileLoadingOverlay() {
          $("mobile-loading-overlay").classList.add("hidden");
        }

        function ShowLoadingOverlay() {
          const isMobile = detectMobileDevice();
          if (!isMobile) {
            $("loading-overlay").classList.remove("hidden");
          }
        }

        function HiddenLoadingOverlay() {
          $("loading-overlay").classList.add("hidden");
        }

        ShowLoadingOverlay();
        ShowMobileLoadingOverlay();

        try {
          function isValidUUID(uuid) {
            const uuidPattern =
              /^[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}$/i;
            return uuidPattern.test(uuid);
          }
          function showMobileLoadingOverlay() {
            const mobileLoadingOverlay = document.getElementById(
              "mobile-loading-overlay"
            );
            if (mobileLoadingOverlay) {
              mobileLoadingOverlay.classList.remove("hidden");
              console.log("[加载遮罩] 显示移动端加载遮罩");
            }
          }
          function hideMobileLoadingOverlay() {
            const mobileLoadingOverlay = document.getElementById(
              "mobile-loading-overlay"
            );
            if (mobileLoadingOverlay) {
              mobileLoadingOverlay.classList.add("hidden");
              console.log("[加载遮罩] 隐藏移动端加载遮罩");
            }
          }
          function hideLoadingOverlays() {
            $("loading-overlay").classList.add("hidden");
            $("cdn-error-overlay").classList.add("hidden");
            hideMobileLoadingOverlay();
          }
          function showUserFriendlyError(title, message, isWarning = false) {
            const type = isWarning ? "warning" : "error";
            Swal.fire({
              title: title,
              text: message,
              icon: type,
              confirmButtonText: "确定",
            });
          }
          $("loading-overlay").classList.remove("hidden");
          if (isMobileMode) {
            showMobileLoadingOverlay();
          }
          const urlPath = window.location.pathname;
          const match = urlPath.match(
            /\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i
          );

          ShowLoadingOverlay();
          if (match) {
            sessionUUID = match[1];

            if (!isValidUUID(sessionUUID)) {
              hideLoadingOverlays();
              hideLoadingOverlays();
              logMessage_Error("无效的UUID格式:", sessionUUID);
              Swal.fire({
                title: "无效的会话",
                text: "UUID格式不正确\n将跳转到登录页面",
                icon: "warning",
                confirmButtonText: "确定",
              }).then(() => {
                logMessage_Info("用户确认无效UUID弹窗，正在跳转到登录页面...");
                window.location.href = "/";
              });
              return;
            }
            $("loading-overlay").classList.remove("hidden");
            ShowLoadingOverlay();
            logMessage_Info("Web模式: 检测到有效UUID =", sessionUUID);
            let result = null;
            try {
              try {
                const response = await fetch("/auth/check_uuid_type", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ uuid: sessionUUID }),
                });

                result = await response.json();

                if (!result.success) {
                  logMessage_Error("检查UUID失败:", result.message);
                  hideLoadingOverlays();
                  let message = "无法通过UUID判断会话列席\n将跳转到登录页面";
                  if (result.message !== "") {
                    message =
                      "无法通过UUID判断会话列席\n" +
                      result.message +
                      "\n将跳转到登录页面";
                  }

                  Swal.fire({
                    title: "无效的会话类型",
                    text: message,
                    icon: "warning",
                    confirmButtonText: "确定",
                  }).then(() => {
                    logMessage_Info(
                      "用户确认检查UUID失败弹窗，正在跳转到登录页面..."
                    );
                    window.location.href = "/";
                  });

                  return;
                }
              } catch (e) {
                logMessage_Error("检查UUID请求失败:", e);
                throw e;
              }
              $("loading-overlay").classList.remove("hidden");
              try {
                if (result.uuid_type === "guest") {
                  try {
                    logMessage_Info("检测到游客UUID，直接恢复会话");
                    hideLoadingOverlays();
                    if (isMobileMode) {
                      const mobileHeader =
                        document.getElementById("mobile-header");
                      const mobileBottomNavSingle = document.getElementById(
                        "mobile-bottom-nav-single-account"
                      );
                      if (mobileHeader) {
                        mobileHeader.classList.remove("hidden");
                        mobileHeader.style.display = "";
                      }
                      if (mobileBottomNavSingle) {
                        mobileBottomNavSingle.classList.remove("hidden");
                        mobileBottomNavSingle.style.display = "";
                      }
                    }
                  } catch (e) {
                    logMessage_Error("处理游客UUID失败:", e);
                    throw e;
                  }
                } else if (result.uuid_type === "system_account") {
                  try {
                    logMessage_Info(
                      "检测到系统账号UUID，允许访问（后端将验证token）"
                    );
                    hideLoadingOverlays();
                    if (isMobileMode) {
                      const mobileHeader =
                        document.getElementById("mobile-header");
                      const mobileBottomNavSingle = document.getElementById(
                        "mobile-bottom-nav-single-account"
                      );
                      if (mobileHeader) {
                        mobileHeader.classList.remove("hidden");
                        mobileHeader.style.display = "";
                      }
                      if (mobileBottomNavSingle) {
                        mobileBottomNavSingle.classList.remove("hidden");
                        mobileBottomNavSingle.style.display = "";
                      }
                    }
                  } catch (e) {
                    logMessage_Error("处理系统账号UUID失败:", e);
                    throw e;
                  }
                } else {
                  try {
                    logMessage_Info(
                      "检测到未知UUID，准备弹窗提示后跳转到登录页面"
                    );

                    const loginContainer =
                      document.getElementById("login-container");
                    const mainApp = document.getElementById("main-app");
                    const multiApp =
                      document.getElementById("multi-account-app");
                    const authContainer = document.getElementById(
                      "auth-login-container"
                    );

                    if (loginContainer) loginContainer.classList.add("hidden");
                    if (mainApp) mainApp.classList.add("hidden");
                    if (multiApp) multiApp.classList.add("hidden");

                    if (authContainer) {
                      authContainer.classList.remove("hidden");
                      authContainer.classList.remove("h-full", "w-full");
                      authContainer.classList.add(
                        "fixed",
                        "inset-0",
                        "flex",
                        "items-center",
                        "justify-center"
                      );
                    }

                    const mobileAuthContainer = document.getElementById(
                      "mobile-auth-container"
                    );
                    if (mobileAuthContainer) {
                      mobileAuthContainer.classList.remove("hidden");
                      mobileAuthContainer.classList.add("fixed", "inset-0");
                    }

                    const inputsToDisable = [
                      "auth-username",
                      "auth-password",
                      "auth-reg-username",
                      "auth-reg-password",
                      "auth-reg-password-confirm",
                    ];
                    inputsToDisable.forEach((inputId) => {
                      const inputElement = document.getElementById(inputId);
                      if (inputElement) {
                        inputElement.disabled = true;
                      }
                    });

                    const mobileInputsToDisable = [
                      "mobile-auth-username",
                      "mobile-auth-password",
                      "mobile-reg-username",
                      "mobile-reg-password",
                      "mobile-reg-password-confirm",
                    ];
                    mobileInputsToDisable.forEach((inputId) => {
                      const inputElement = document.getElementById(inputId);
                      if (inputElement) {
                        inputElement.disabled = true;
                      }
                    });

                    if (authContainer) authContainer.classList.remove("hidden");

                    // 检查遮罩是否已存在，防止重复创建
                    if (document.getElementById("logout-elsewhere-overlay")) {
                      return;
                    }

                    const logoutOverlay = document.createElement("div");
                    logoutOverlay.id = "logout-elsewhere-overlay";
                    logoutOverlay.style.cssText = `
                      position: fixed;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      background: rgba(0, 0, 0, 0.85);
                      z-index: 9999;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    `;

                    const modalContent = document.createElement("div");
                    modalContent.style.cssText = `
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      padding: 40px;
                      border-radius: 20px;
                      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                      max-width: 500px;
                      width: 90%;
                      text-align: center;
                      color: white;
                    `;

                    const icon = document.createElement("div");
                    icon.innerHTML = `
                      <svg style="width: 80px; height: 80px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                      </svg>
                    `;

                    const title = document.createElement("h2");
                    title.textContent = "会话不存在";
                    title.style.cssText = `
                      font-size: 24px;
                      font-weight: bold;
                      margin: 0 0 20px 0;
                    `;

                    const text = document.createElement("p");
                    text.textContent = "该会话已过期或不存在，请重新登录";
                    text.style.cssText = `
                      font-size: 16px;
                      line-height: 1.6;
                      margin: 0 0 30px 0;
                      opacity: 0.95;
                      white-space: pre-wrap;
                    `;

                    // ==================== 修改开始：添加倒计时元素 ====================
                    const countdown = document.createElement("div");
                    countdown.style.cssText = `
                      font-size: 24px;
                      font-weight: bold;
                      margin: 0 0 30px 0;
                    `;
                    // ==================== 修改结束 ====================

                    const button = document.createElement("button");
                    button.textContent = "返回登录";
                    button.style.cssText = `
                      background: white;
                      color: #667eea;
                      border: none;
                      padding: 12px 30px;
                      border-radius: 25px;
                      font-size: 16px;
                      font-weight: bold;
                      cursor: pointer;
                      transition: all 0.3s;
                    `;
                    button.onmouseover = () => {
                      button.style.transform = "scale(1.05)";
                      button.style.boxShadow =
                        "0 5px 15px rgba(255, 255, 255, 0.3)";
                    };
                    button.onmouseout = () => {
                      button.style.transform = "scale(1)";
                      button.style.boxShadow = "none";
                    };

                    // ==================== 修改开始：倒计时逻辑与事件绑定 ====================
                    let remainingSeconds = 10; // 5秒倒计时
                    const updateCountdown = () => {
                      countdown.textContent = `${remainingSeconds}秒后自动跳转`;
                    };
                    updateCountdown();

                    const countdownInterval = setInterval(() => {
                      remainingSeconds--;
                      updateCountdown();

                      if (remainingSeconds <= 0) {
                        clearInterval(countdownInterval);
                        window.location.href = "/";
                      }
                    }, 1000);

                    button.onclick = () => {
                      clearInterval(countdownInterval); // 点击时清除定时器
                      logMessage_Info("用户确认弹窗，正在跳转到登录页面...");
                      window.location.href = "/";
                    };

                    modalContent.appendChild(icon);
                    modalContent.appendChild(title);
                    modalContent.appendChild(text);
                    modalContent.appendChild(countdown); // 添加倒计时元素到DOM
                    modalContent.appendChild(button);
                    logoutOverlay.appendChild(modalContent);
                    document.body.appendChild(logoutOverlay);
                    // ==================== 修改结束 ====================

                    return;
                  } catch (e) {
                    logMessage_Error("处理未知UUID失败:", e);
                    throw e;
                  }
                }
              } catch (e) {
                logMessage_Error("处理UUID类型失败:", e);
                throw e;
              }
            } catch (e) {
              logMessage_Error("检查UUID类型失败:", e);
              hideLoadingOverlays();
              Swal.fire({
                title: "网络错误",
                text: "无法验证会话状态，请检查网络连接后重试",
                icon: "warning",
                confirmButtonText: "确定",
              }).then(() => {
                logMessage_Info(
                  "用户确认检查UUID类型失败弹窗，正在跳转到登录页面..."
                );
                window.location.href = "/";
              });
              return;
            }
          } else {
            logMessage_Info("Web模式: 未检测到UUID，显示认证登录页面");
            hideLoadingOverlays();
            HiddenMobileLoadingOverlay();
            if (isMobileMode) {
              console.log("[Mobile Init] 无UUID，显示移动端认证页面");
              $("mobile-auth-login-container").classList.remove("hidden");
              $("mobile-login-container").classList.add("hidden");
              $("auth-login-container").classList.add("hidden");
              $("login-container").classList.add("hidden");
            } else {
              showAuthLogin();
            }
            return;
          }

          $("loading-overlay").classList.remove("hidden");
          ShowMobileLoadingOverlay();
          const isAuthenticated = await checkAuthStatus();
          if (!isAuthenticated) {
            hideLoadingOverlays();
            HiddenMobileLoadingOverlay();

            if (isMobileMode) {
              console.log("[Mobile Init] 未认证，显示移动端认证页面");
              $("mobile-auth-login-container").classList.remove("hidden");
              $("mobile-login-container").classList.add("hidden");
              $("auth-login-container").classList.add("hidden");
              $("login-container").classList.add("hidden");
            } else {
              console.log("[Desktop Init] 未认证，显示桌面端认证页面");
              showAuthLogin();
            }
            return;
          }
          $("loading-overlay").classList.remove("hidden");
          ShowMobileLoadingOverlay();
          appInitialized = true;

          if (sessionUUID) {
            connectWebSocket();
          }

          if (cdnErrorTimer) {
            clearTimeout(cdnErrorTimer);
            cdnErrorTimer = null;
          }

          logMessage_Info("应用初始化成功，CDN资源状态正常或可用替代方案");

          const initialData = await callPythonAPI("get_initial_data");

          currentUserIsGuest = initialData.is_guest || false;
          currentAuthUsername = initialData.auth_username || null;
          logMessage_Info(
            `initializeApp: currentUserIsGuest = ${currentUserIsGuest}, auth_username = ${currentAuthUsername}`
          );

          const userCombo = $("user-combo");
          userCombo.innerHTML = '<option value="">(新用户)</option>';
          initialData.users.forEach((user) => {
            const option = document.createElement("option");
            option.value = option.textContent = user;
            userCombo.appendChild(option);
          });

          const multiConfigUserSelect = $("multi-config-user-select");
          if (multiConfigUserSelect) {
            multiConfigUserSelect.innerHTML =
              '<option value="">(新用户/手动输入)</option>';
            initialData.users.forEach((user) => {
              const option = document.createElement("option");
              option.value = option.textContent = user;
              option.title = user;
              multiConfigUserSelect.appendChild(option);
            });
            logMessage_Info(
              `[初始化] multi-config-user-select 已更新，用户数: ${initialData.users.length}`
            );
          }

          createParamInputs($("params-container"), "param", onParamChange);
          if (initialData.lastUser) userCombo.value = initialData.lastUser;
          await onUserChange();

          const hasSchoolLogin = initialData.isLoggedIn && initialData.userInfo;
          const hasSystemAuth =
            initialData.is_authenticated && !initialData.is_guest;
          const isGuestMode =
            initialData.is_authenticated && initialData.is_guest;
          let sessionModeInfo = null;
          try {
            sessionModeInfo = await callPythonAPI("get_session_mode_info");
          } catch (e) {
            logMessage_Error("获取会话模式信息失败:", e);
            hideLoadingOverlays();
            Swal.fire({
              title: "网络错误",
              text: "获取会话模式信息失败，请检查网络连接后重试",
              icon: "warning",
              confirmButtonText: "确定",
            }).then(() => {
              logMessage_Info(
                "用户确认获取会话模式信息失败弹窗，正在跳转到登录页面..."
              );
              window.location.href = "/";
            });
            return;
          }

          const hasLoadedTasks = sessionModeInfo && sessionModeInfo.has_tasks;

          $("loading-overlay").classList.remove("hidden");
          ShowMobileLoadingOverlay();

          resetUI();
          if (sessionModeInfo && sessionModeInfo.is_multi_account_mode) {
            logMessage_Info("检测到会话之前处于多账号模式，正在恢复...");
            currentUserData.group = initialData.auth_group || "user";
            try {
              const result = await callPythonAPI("enter_multi_account_mode");
              if (!result.success) {
                logMessage_Error("无法进入多账号模式，返回登录界面");
                return;
              }
              if (!sessionModeInfo.global_params && result.params) {
                pythonParams = result.params;
              }
            } catch (e) {
              logMessage_Error("调用 enter_multi_account_mode 失败:", e);
              return;
            }

            hideLoadingOverlays();
            HiddenMobileLoadingOverlay();
            AMAP_API_KEY = initialData.amap_key || "";
            if (AMAP_API_KEY) {
              try {
                await loadAMapOnce();
              } catch (e) {
                logMessage_Error("地图加载失败（多账号模式恢复）", e);
              }
            }
            $("loading-overlay").classList.remove("hidden");
            ShowMobileLoadingOverlay();
            if (isMobileMode) {
              const mobileMultiApp = document.getElementById(
                "mobile-multi-account-app"
              );
              const mobileLoginContainer = document.getElementById(
                "mobile-login-container"
              );
              const mobileAuthContainer = document.getElementById(
                "mobile-auth-login-container"
              );
              if (mobileMultiApp) {
                mobileMultiApp.classList.remove("hidden");
                console.log("[会话恢复] 移动端：显示 mobile-multi-account-app");
              }
              if (mobileLoginContainer)
                mobileLoginContainer.classList.add("hidden");
              if (mobileAuthContainer)
                mobileAuthContainer.classList.add("hidden");
              updateMobileNavVisibility(true, "multi");
              switchMobilePanel("mobile-multi-control-panel", "multi");
              console.log(
                "[会话恢复] 移动端：已默认激活 mobile-multi-control-panel"
              );
              $("multi-account-app").classList.add("hidden");
              $("main-app").classList.add("hidden");
            } else {
              $("multi-account-app").classList.remove("hidden");
              $("multi-account-app").classList.add("grid");
              $("main-app").classList.add("hidden");
              console.log("[会话恢复] 桌面端：显示 multi-account-app");
            }
            if (!multiAccountMap && AMapInstance) {
              try {
                multiAccountMap = new AMapInstance.Map("multi-map-container", {
                  viewMode: "3D",
                  pitch: 55,
                  rotation: 0,
                  zoom: 17,
                  center: [113.390342, 22.527403],
                  renderOptions: {
                    willReadFrequently: true,
                  },
                });
                const ctrlBar = new AMapInstance.ControlBar({
                  position: { left: "12px", top: "12px" },
                  showZoomBar: false,
                  showControlButton: true,
                });
                multiAccountMap.addControl(ctrlBar);
                try {
                  const buildings = new AMapInstance.BuildingLayer();
                  buildings.setMap(multiAccountMap);
                } catch (e) {
                  logMessage_Warning("BuildingLayer not available (multi):", e);
                }

                multiAccountMap.on("zoomchange", () => {
                  if (!multiAccountMap) return;
                  const z = multiAccountMap.getZoom();
                  const zoomLevelEl = $("multi-zoom-level");
                  if (zoomLevelEl)
                    zoomLevelEl.textContent = String(z.toFixed(1));
                });
                if (window.multiMapCleanup) window.multiMapCleanup();
                window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

                multiAccountMap.setStatus({
                  doubleClickZoom: true,
                  dragEnable: true,
                  scrollWheel: true,
                  keyboardEnable: true,
                });
                ensureMultiControls();
              } catch (e) {
                logMessage_Error("初始化多账号地图失败:", e);
              }
              $("auth-login-container").classList.add("hidden");
              $("login-container").classList.add("hidden");
            }
            try {
              const configUsers = await callPythonAPI(
                "multi_get_all_config_users"
              );
              const select = $("multi-config-user-select");
              select.innerHTML = '<option value="">(新用户/手动输入)</option>';
              configUsers.users.forEach((u) => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = u;
                select.appendChild(opt);
              });
            } catch (e) {
              logMessage_Error("加载配置用户列表失败:", e);
            }
            if (sessionModeInfo.global_params) {
              pythonParams = sessionModeInfo.global_params;
            }
            try {
              const container = $("multi-global-params-container");
              container.innerHTML = "";
              createParamInputs(container, "multi-param", onGlobalParamChange);
              updateParamInputs(container, "multi-param", pythonParams);
            } catch (e) {
              logMessage_Error("初始化全局参数UI失败:", e);
            }
            try {
              bindImmediateRefreshForUserSelects();
              updateMultiGlobalButtons(true, true);
              await callPythonAPI(
                "set_multi_run_only_incomplete",
                document.getElementById("multi-run-only-incomplete-check")
                  .checked
              );
            } catch (e) {
              logMessage_Error("绑定多账号UI事件失败:", e);
            }
            try {
              const accountsResult = await callPythonAPI(
                "multi_get_all_accounts_status"
              );
              if (accountsResult && accountsResult.accounts) {
                renderMultiAccountList(accountsResult.accounts);
                logMessage(
                  `已恢复多账号模式，当前有 ${accountsResult.accounts.length} 个账号`
                );
              } else {
                logMessage(`已恢复多账号模式，当前有 0 个账号`);
              }
            } catch (e) {
              logMessage_Error("恢复账号列表失败:", e);
              logMessage(
                `已恢复多账号模式，当前有 ${
                  sessionModeInfo.multi_account_count || 0
                } 个账号（列表加载失败）`
              );
            }
            setTimeout(async () => {
              try {
                await initializeInlineAdminPanel();
              } catch (e) {
                logMessage_Error("初始化内嵌管理面板失败:", e);
              }
            }, 100);

            const base = pythonParams.theme_base_color || "#7dd3fc";
            setBaseColor(base, base);
            startMultiAccountAutoRefresh(500);

            hideLoadingOverlays();
            HiddenMobileLoadingOverlay();
          } else if (hasSchoolLogin || hasLoadedTasks) {
            currentUserData =
              initialData.userInfo ||
              (sessionModeInfo && sessionModeInfo.user_data) ||
              {};
            currentUserData.group = initialData.auth_group || "guest";

            if (initialData.device_ua) {
              currentSessionUA = initialData.device_ua;
              logMessage_Info(
                `[会话恢复] 成功恢复 User-Agent: ${currentSessionUA.substring(
                  0,
                  50
                )}...`
              );
            } else {
              logMessage_Warning(
                "[会话恢复] 未能从 initialData 中恢复 User-Agent。"
              );
              currentSessionUA = "NULL (Restored)";
            }

            hideLoadingOverlays();
            AMAP_API_KEY = initialData.amap_key || "";
            if (AMAP_API_KEY) {
              try {
                await loadAMapOnce();
              } catch (e) {
                logMessage_Error("地图加载失败（会话恢复）", e);
              }
            } else {
              hideLoadingOverlays();
              logMessage_Info("[警告] 未配置高德地图API Key，请在弹窗中输入。");
              $("amap-key-modal").classList.remove("hidden");
              $("amap-key-modal").classList.add("flex");
              document.body.classList.add("modal-visible");
            }
            $("loading-overlay").classList.remove("hidden");

            if (refreshUserListInterval) clearInterval(refreshUserListInterval);
            refreshUserListInterval = setInterval(refreshUserList, 5000);
            logMessage_Info("refreshUserList interval started.");

            showMainApp();
            const name = currentUserData.name || "离线模式";
            $("user-name-label").textContent = `姓名: ${name}`;
            $("user-id-label").textContent = `学号: ${
              currentUserData.student_id || "未登录"
            }`;
            updateDashboard();
            await refreshTasks();
            let isTaskRestored = false;
            try {
              isTaskRestored = await checkBackgroundTaskOnLoad();
            } catch (err) {
              logMessage_Warning("检查后台任务失败:", err);
            }
            const base = pythonParams.theme_base_color || "#7dd3fc";
            setBaseColor(base, base);
            setTimeout(async () => {
              try {
                await initializeInlineAdminPanel();
              } catch (e) {
                logMessage_Error("初始化内嵌管理面板失败:", e);
              }
            }, 100);
            const adminBtn = $("show-admin-panel");
            if (adminBtn) adminBtn.classList.remove("hidden");
            hideLoadingOverlays();
            await fetchNotifications();
          } else if (hasSystemAuth || isGuestMode) {
            currentUserData.group = initialData.auth_group || "guest";
            logMessage_Info(
              `[Auth Restore] 恢复系统权限组: ${currentUserData.group}`
            );

            $("loading-overlay").classList.remove("hidden");

            if (isMobileMode) {
              console.log(
                "[Mobile Init] 已认证，显示移动端学校账号登录/会话管理"
              );
              $("mobile-auth-login-container").classList.add("hidden");
              $("mobile-login-container").classList.remove("hidden");
              $("auth-login-container").classList.add("hidden");
              $("login-container").classList.add("hidden");
              updateMobileNavVisibility(false);
              setTimeout(async () => {
                try {
                  await loadMobileSessionsList();
                } catch (e) {
                  console.error("[Mobile Init] 加载移动端数据失败:", e);
                }
              }, 100);
            } else {
              console.log(
                "[Desktop Init] 已认证，显示桌面端学校账号登录/会话管理"
              );
              $("auth-login-container").classList.add("hidden");
              $("login-container").classList.remove("hidden");
            }
            await onUserChange();
            setTimeout(async () => {
              try {
                await initializeInlineAdminPanel();
              } catch (e) {
                logMessage_Error("初始化内嵌管理面板失败:", e);
              }
            }, 100);
            AMAP_API_KEY = initialData.amap_key || "";
            if (AMAP_API_KEY) {
              try {
                await loadAMapOnce();
              } catch (e) {
                logMessage_Error("地图加载失败（系统账号恢复）", e);
              }
            }

            hideLoadingOverlays();
            if (isGuestMode) {
              logMessage_Info(
                "[游客模式] 部分功能受限，请保存当前地址以便恢复会话"
              );
              const guestToast = $("guest-warning-toast");
              const guestOverlay = $("guest_warning_overlay");
              if (guestToast) {
                if (guestOverlay) {
                  guestOverlay.classList.remove("hidden");
                }
                guestToast.classList.remove("hidden");
              }
            }

            $("loading-overlay").classList.remove("hidden");

            const adminBtnLogin = $("show-admin-panel-login");
            if (adminBtnLogin) {
              adminBtnLogin.classList.remove("hidden");
            }
            const adminBtnMulti = $("show-admin-panel-multi");
            if (adminBtnMulti) adminBtnMulti.classList.remove("hidden");

            hideLoadingOverlays();
          } else {
            AMAP_API_KEY = initialData.amap_key || "";
            if (!AMAP_API_KEY) {
              logMessage_Info("[警告] 未配置高德地图API Key，请在弹窗中输入。");
              $("amap-key-modal").classList.remove("hidden");
              $("amap-key-modal").classList.add("flex");
            } else {
              try {
                await loadAMapOnce();
              } catch (e) {
                logMessage_Error("AMap SDK 加载失败（ready 阶段）", e);
              }
            }
            hideLoadingOverlays();
          }

          if (pythonParams.theme_style) {
            setThemeStyle(pythonParams.theme_style);
          }
          await refreshUserList();

          const loadingOverlay = $("loading-overlay");
          loadingOverlay.style.opacity = "0";
          setTimeout(() => {
            loadingOverlay.style.display = "none";
          }, 500);
          bindImmediateRefreshForUserSelects();

          const attEnabled = $("param-auto_attendance_enabled");
          const attRefresh = $("param-auto_attendance_refresh_s");
          const attRadius = $("param-attendance_user_radius_m");
          if (attEnabled) attEnabled.addEventListener("change", onParamChange);
          if (attRefresh) attRefresh.addEventListener("change", onParamChange);
          if (attRadius) attRadius.addEventListener("change", onParamChange);

          $("confirm-amap-key-btn").addEventListener("click", onConfirmAmapKey);
          if (sessionUUID) {
            startSessionValidityCheck();
          }
          if (isMobileMode) {
            setTimeout(() => {
              restoreMobileTaskState();
              hideMobileLoadingOverlay();
            }, 1000);
          }

          // 新增：检查是否显示返回管理员按钮
          checkAdminReturnState();
        } catch (err) {
          hideLoadingOverlays();
          showModalAlert("服务器无法连接，请检查网络或稍后重试。", "网络错误");
          IS_OFFLINE = true;
        }
      }
      async function restoreMobileTaskState() {
        try {
          logMessage_Info("[移动端状态恢复] 开始检查后端任务状态...");

          const statusRes = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );

          if (statusRes.success && statusRes.task_status) {
            const status = statusRes.task_status;
            if (status.status === "running" || status.status === "paused") {
              logMessage_Info(
                "[移动端状态恢复] 检测到后端任务正在执行，恢复状态..."
              );
              if (
                status.task_indices &&
                status.current_task_index !== undefined
              ) {
                const task_list = status.task_indices;
                const current_list_index = status.current_task_index;
                if (task_list.length > current_list_index) {
                  const global_task_index = task_list[current_list_index];
                  selectedTaskIndex = global_task_index;
                  logMessage_Info(
                    `[移动端状态恢复] 恢复任务索引: ${selectedTaskIndex}`
                  );

                  if (currentTasks && currentTasks[selectedTaskIndex]) {
                    await selectTask(selectedTaskIndex, false);
                  }
                }
              }

              if (status.status === "running") {
                mobileTaskRunning = true;
                mobileTaskPaused = false;
                updateMobileTaskUI("运行中", "任务执行中...");
                logMessage_Info("[移动端状态恢复] UI状态设置为运行中");
              } else if (status.status === "paused") {
                mobileTaskRunning = true;
                mobileTaskPaused = true;
                updateMobileTaskUI("已暂停", "任务已暂停");
                logMessage_Info("[移动端状态恢复] UI状态设置为已暂停");
              }

              startBackgroundTaskPolling();
              logMessage_Info("[移动端状态恢复] 已启动后台任务轮询");
            } else {
              logMessage_Info("[移动端状态恢复] 后端无正在执行的任务");
            }
          }
        } catch (error) {
          logMessage_Error("[移动端状态恢复] 恢复状态失败:", error);
        }
      }

      let socket = null;

      function connectWebSocket() {
        if (socket && socket.connected) {
          logMessage_Info("WebSocket 已连接.");
          return;
        }

        if (!sessionUUID) {
          logMessage_Warning("无法连接 WebSocket：缺少 sessionUUID。");
          return;
        }

        logMessage_Info("尝试连接 WebSocket...");
        socket = io({
          autoConexceptnect: false,
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5,
        });
        socket.connect();

        socket.on("connect", () => {
          logMessage_Info("WebSocket 连接成功。SID:", socket.id);
          socket.emit("join", { session_id: sessionUUID });
        });

        socket.on("disconnect", (reason) => {
          logMessage_Info("WebSocket 连接已断开:", reason);
          logMessage_Info("[System] WebSocket 连接已断开，尝试重连...");
        });

        socket.on("connect_error", (error) => {
          if (!isInNetworkErrorState) {
            logMessage_Error("WebSocket 连接错误:", error);
            logMessage_Info("[System-Error] WebSocket 连接失败");
          }
        });

        socket.on("log_message", (data) => {
          if (data && data.msg) {
            logMessage(data.msg, "INFO", "Backend");
          }
        });
        // ===============================================
        // === 监听后端推送的UI更新事件 ===
        // ===============================================
        socket.on("multi_status_update", (data) => {
          if (data && data.username && data.data) {
            logMessage_Debug(`[Socket] 收到 ${data.username} 状态更新`);
            multi_updateAccountStatus(data.username, data.data);
          }
        });

        socket.on("accounts_updated", (data) => {
          if (data && data.accounts) {
            logMessage(
              `[Socket] 收到账号列表更新，共 ${data.accounts.length} 个账号`,
              "INFO",
              "Socket"
            );
            onAccountsUpdated(data.accounts);
          }
        });

        socket.on("multi_global_buttons_update", (data) => {
          if (data) {
            logMessage_Debug(`[Socket] 收到全局按钮状态更新`);
            updateMultiGlobalButtons(data.start_disabled, data.stop_disabled);
            const exitBtn = document.getElementById("exit-multi-mode-btn");
            if (exitBtn) {
              exitBtn.disabled = !!data.exit_disabled;
            }
          }
        });

        socket.on("multi_position_update", (data) => {
          if (
            data &&
            data.username &&
            typeof data.lon === "number" &&
            typeof data.lat === "number"
          ) {
            multi_updateRunnerPosition(
              data.username,
              data.lon,
              data.lat,
              data.name || data.username
            );
          }
        });

        socket.on("runner_position_update_new", (data) => {
          logMessage_Debug("[Socket] 收到 runner_position_update 事件");
          if (data) {
            if (
              data.task_index !== undefined &&
              data.task_index !== selectedTaskIndex
            ) {
              logMessage_Info(
                `[Socket] 任务切换: 正在执行任务 #${data.task_index}`
              );
              selectedTaskIndex = data.task_index;

              renderTaskList();
            }

            updateRunnerPosition(
              data.lon,
              data.lat,
              data.distance,
              data.target_sequence,
              data.duration,
              data.center_now
            );
            logMessage_Debug(
              `[Socket] 收到当前位置更新: lon=${data.lon}, lat=${data.lat}`
            );
          }
        });

        socket.on("task_completed", (data) => {
          if (data && typeof data.task_index !== "undefined") {
            onTaskCompleted(data.task_index);
          }
        });

        socket.on("run_stopped", () => {
          onRunStopped();
        });
        socket.on("onNotificationsUpdated", (data) => {
          logMessage("收到后台推送的通知更新", "INFO", "Socket");
          if (data && data.success) {
            onNotificationsUpdated(data);
          }
        });

        socket.on("verification_codes_updated", () => {
          logMessage_Info("[Socket] 收到验证码列表更新推送");
          const modal = $("verification-codes-modal");
          if (modal && !modal.classList.contains("hidden")) {
            logMessage_Info("验证码模态框已打开，正在刷新列表...");
            loadVerificationCodes();
          } else {
            logMessage_Info("验证码模态框未打开，跳过刷新。");
          }
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          initializeApp().catch((err) => {
            logMessage_Error("应用初始化失败:", err);
            appInitialized = false;
            if (cdnErrorCount > 0) {
              if (cdnErrorTimer) clearTimeout(cdnErrorTimer);
              const errorOverlay = document.getElementById("cdn-error-overlay");
              if (errorOverlay) {
                errorOverlay.style.setProperty("display", "flex", "important");
              }
            }
          });
        });
      } else {
        initializeApp().catch((err) => {
          logMessage_Error("应用初始化失败:", err);
          appInitialized = false;
          if (cdnErrorCount > 0) {
            if (cdnErrorTimer) clearTimeout(cdnErrorTimer);
            const errorOverlay = document.getElementById("cdn-error-overlay");
            if (errorOverlay) {
              errorOverlay.style.setProperty("display", "flex", "important");
            }
          }
        });
      }

      function enhanceMapInteraction(mapInstance) {
        if (!mapInstance) return () => {};
        const container = mapInstance.getContainer();
        if (!container) return () => {};
        const handlers = [];

        const addManagedListener = (element, type, listener, options) => {
          element.addEventListener(type, listener, options);
          handlers.push({ element, type, listener, options });
        };

        const wheelHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!mapInstance) return;
          if (e.deltaY < 0) mapInstance.zoomIn();
          else mapInstance.zoomOut();
        };
        addManagedListener(container, "wheel", wheelHandler, {
          passive: false,
        });

        const contextMenuHandler = (e) => e.preventDefault();
        addManagedListener(container, "contextmenu", contextMenuHandler);

        const DRAG_SAME_DIRECTION = true;
        let rmbLongPressTimer = null,
          mmbLongPressTimer = null,
          rmbDragging = false,
          mmbDragging = false,
          lastClientX = 0,
          lastClientY = 0;

        function doPanBy(mouseX, mouseY) {
          if (!mapInstance) return;
          const dx = mouseX - lastClientX;
          const dy = mouseY - lastClientY;
          if (dx !== 0 || dy !== 0) {
            const panDx = DRAG_SAME_DIRECTION ? dx : -dx;
            const panDy = DRAG_SAME_DIRECTION ? dy : -dy;
            mapInstance.panBy(panDx, panDy);
            lastClientX = mouseX;
            lastClientY = mouseY;
          }
        }

        const mouseDownHandler = (e) => {
          if (e.button === 0) return;
          lastClientX = e.clientX;
          lastClientY = e.clientY;
          if (e.button === 1) {
            e.preventDefault();
            e.stopPropagation();
            mmbLongPressTimer = setTimeout(() => {
              mmbDragging = true;
            }, 0);
          }
          if (e.button === 2) {
            e.preventDefault();
            e.stopPropagation();
            rmbLongPressTimer = setTimeout(() => {
              rmbDragging = true;
            }, 0);
          }
        };
        addManagedListener(container, "mousedown", mouseDownHandler);

        const mouseMoveHandler = (e) => {
          if (rmbDragging || mmbDragging) {
            e.preventDefault();
            e.stopPropagation();
            doPanBy(e.clientX, e.clientY);
          }
        };
        addManagedListener(container, "mousemove", mouseMoveHandler);

        function endDrag(button) {
          if (button === 2) {
            clearTimeout(rmbLongPressTimer);
            rmbLongPressTimer = null;
            rmbDragging = false;
          }
          if (button === 1) {
            clearTimeout(mmbLongPressTimer);
            mmbLongPressTimer = null;
            mmbDragging = false;
          }
        }

        const mouseUpHandler = (e) => {
          endDrag(e.button);
          if (isDrawing && map) {
            map.setStatus({ dragEnable: false });
          }
        };
        addManagedListener(container, "mouseup", mouseUpHandler);

        const mouseLeaveHandler = () => {
          endDrag(1);
          endDrag(2);
        };
        addManagedListener(container, "mouseleave", mouseLeaveHandler);

        const windowMouseUpHandler = () => {
          leftMouseDown = false;
          isPathDrawing = false;
          endDrag(1);
          endDrag(2);
        };
        addManagedListener(window, "mouseup", windowMouseUpHandler, true);
        return () => {
          handlers.forEach(({ element, type, listener, options }) => {
            element.removeEventListener(type, listener, options);
          });
        };
      }
      function loadAMapOnce() {
        if (AMapReady && AMapInstance) return Promise.resolve(AMapInstance);
        if (amapLoadingPromise) return amapLoadingPromise;
        if (window.AMap && window.AMap.ControlBar) {
          AMapInstance = window.AMap;
          AMapReady = true;
          amapLoadingPromise = Promise.resolve(AMapInstance);
          return amapLoadingPromise;
        }
        if (!AMAP_API_KEY) {
          logMessage_Info("[错误] 尝试加载地图失败：API Key为空。");
          $("amap-key-modal").classList.remove("hidden");
          $("amap-key-modal").classList.add("flex");
          return Promise.reject("API Key is missing.");
        }
        amapLoadingPromise = AMapLoader.load({
          key: AMAP_API_KEY,
          version: "2.0",
          plugins: ["AMap.ControlBar", "AMap.BuildingLayer", "AMap.Walking"],
        })
          .then((AMap) => {
            AMapInstance = AMap;
            AMapReady = true;
            logMessage_Info("高德地图SDK及所有插件加载成功。");
            return AMapInstance;
          })
          .catch((err) => {
            logMessage_Error("AMap 加载失败", err);
            logMessage_Info(
              "[JS-Error] 高德地图SDK加载失败！地图功能将不可用。"
            );
            AMapReady = false;
            AMapInstance = null;
            amapLoadingPromise = null;
            throw err;
          });

        return amapLoadingPromise;
      }
      function ensureSingleMap() {
        if (map || !AMapReady || !AMapInstance) return;
        const container = document.getElementById("map-container");
        if (!container) return;
        const isHidden = container.offsetParent === null;
        if (isHidden) return;
        initMap(AMapInstance);
      }
      function forceProjectionRefresh() {
        if (!map) return;
        try {
          map.setStatus({ dragEnable: false });
          map.resize();
          requestAnimationFrame(() => {
            const overlays = [...polylines.recommended];
            if (polylines.draft) overlays.push(polylines.draft);
            if (polylines.run) overlays.push(polylines.run);
            if (polylines.history) overlays.push(polylines.history);

            if (overlays.length > 0) {
              map.setFitView(overlays, false, [60, 60, 60, 60]);
            } else if (
              currentRunData &&
              Array.isArray(currentRunData.target_points) &&
              currentRunData.target_points.length > 0
            ) {
              const pts = currentRunData.target_points.map(
                (p) => new AMapInstance.LngLat(p[0], p[1])
              );
              map.setFitView(pts, false, [60, 60, 60, 60]);
            } else {
              map.setZoomAndCenter(17, [113.390342, 22.527403]);
            }
            map.setStatus({ dragEnable: true });
          });
        } catch (e) {
          logMessage_Warning("forceProjectionRefresh warning:", e);
        }
      }
      async function refreshMobileSettings() {
        const container = document.getElementById("mobile-params-container");
        if (!container) return;

        showTempMessage("正在刷新参数...", "info");

        try {
          const params = await callPythonAPI("get_params");

          if (params) {
            pythonParams = params;
            if (typeof updateParamInputs === "function") {
              updateParamInputs(container, "mobile-param", pythonParams);
            }
            if (params.theme_base_color) {
              setBaseColor(params.theme_base_color, params.theme_base_color);
            }

            showTempMessage("参数已刷新", "success");
          } else {
            showTempMessage("刷新失败：未获取到数据", "error");
          }
        } catch (e) {
          console.error("[移动端] 刷新参数失败:", e);
          showTempMessage("刷新失败", "error");
        }
      }
      async function saveMobileSettings() {
        const container = document.getElementById("mobile-params-container");
        if (!container) return;

        showTempMessage("正在保存设置...", "info");

        try {
          const inputs = container.querySelectorAll("input, select");
          let savedCount = 0;
          for (const input of inputs) {
            const key = input.dataset.key;
            if (!key) continue;

            let value;
            if (input.type === "checkbox") {
              value = input.checked;
            } else if (input.type === "number") {
              value = parseFloat(input.value) || 0;
            } else {
              value = input.value;
            }
            pythonParams[key] = value;
            await callPythonAPI("update_param", key, value);
            savedCount++;
          }

          showTempMessage("设置已保存", "success");
        } catch (e) {
          console.error("[移动端] 保存参数失败:", e);
          showTempMessage("保存失败: " + e.message, "error");
        }
      }

      function ensureSingleControls() {
        const container = document.getElementById("map-container");
        if (!container) return;
        const hasZoomIn = !!document.getElementById("zoom-in");
        const hasZoomOut = !!document.getElementById("zoom-out");
        const hasReset = !!document.getElementById("reset-view-btn");

        if (hasZoomIn && hasZoomOut && hasReset) {
          attachSingleControlHandlers();
          return;
        }
        const overlay = document.createElement("div");
        overlay.className =
          "absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200";
        overlay.innerHTML = `
    <button id="zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="复位视角">🎯</button>
  `;
        container.appendChild(overlay);

        attachSingleControlHandlers();
      }

      function attachSingleControlHandlers() {
        const zi = document.getElementById("zoom-in");
        const zo = document.getElementById("zoom-out");
        const rv = document.getElementById("reset-view-btn");
        if (zi && !zi._bound) {
          zi.addEventListener("click", () => {
            if (map) map.zoomIn();
          });
          zi._bound = true;
        }
        if (zo && !zo._bound) {
          zo.addEventListener("click", () => {
            if (map) map.zoomOut();
          });
          zo._bound = true;
        }
        if (rv && !rv._bound) {
          rv.addEventListener("click", resetMapView);
          rv._bound = true;
        }
      }

      function ensureMultiControls() {
        const container = document.getElementById("multi-map-container");
        if (!container) return;

        const hasZoomIn = !!document.getElementById("multi-zoom-in");
        const hasZoomOut = !!document.getElementById("multi-zoom-out");
        const hasReset = !!document.getElementById("multi-reset-view-btn");

        if (hasZoomIn && hasZoomOut && hasReset) {
          attachMultiControlHandlers();
          return;
        }

        const overlay = document.createElement("div");
        overlay.className =
          "absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200";
        overlay.innerHTML = `
    <button id="multi-zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="multi-zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="multi-zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="multi-reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="复位视角">🎯</button>
  `;
        container.appendChild(overlay);

        attachMultiControlHandlers();
      }

      function attachMultiControlHandlers() {
        const zi = document.getElementById("multi-zoom-in");
        const zo = document.getElementById("multi-zoom-out");
        const rv = document.getElementById("multi-reset-view-btn");

        if (zi && !zi._bound) {
          zi.addEventListener("click", () => {
            if (multiAccountMap) multiAccountMap.zoomIn();
          });
          zi._bound = true;
        }
        if (zo && !zo._bound) {
          zo.addEventListener("click", () => {
            if (multiAccountMap) multiAccountMap.zoomOut();
          });
          zo._bound = true;
        }
        if (rv && !rv._bound) {
          rv.addEventListener("click", multi_resetMapView);
          rv._bound = true;
        }
      }
      function initMap(AMap) {
        if (map) {
          const container = map.getContainer();
          if (container && container.id === "map-container") {
            return;
          }
          try {
            map.destroy();
          } catch (e) {}
          map = null;
        }

        AMapInstance = AMap;
        map = new AMapInstance.Map("map-container", {
          viewMode: "3D",
          pitch: 55,
          rotation: 0,
          zoom: 17,
          center: [113.390342, 22.527403],
          renderOptions: {
            willReadFrequently: true,
          },
        });

        const ctrlBar = new AMapInstance.ControlBar({
          position: { left: "12px", top: "12px" },
          showZoomBar: false,
          showControlButton: true,
        });
        map.addControl(ctrlBar);

        try {
          const buildings = new AMapInstance.BuildingLayer();
          buildings.setMap(map);
        } catch (e) {
          logMessage_Warning("BuildingLayer not available:", e);
        }

        map.on("mousedown", onMapMouseDown);
        map.on("mousemove", onMapMouseMove);
        map.on("mouseup", onMapMouseUp);
        map.on("zoomchange", () => {
          if (!map) return;
          const z = map.getZoom();
          const zoomLevelEl = $("zoom-level");
          if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
        });

        if (window.mapCleanup) window.mapCleanup();
        window.mapCleanup = enhanceMapInteraction(map);
        map.setStatus({
          doubleClickZoom: true,
          dragEnable: true,
          scrollWheel: true,
          keyboardEnable: true,
        });

        map.on("complete", () => {
          logMessage_Info("地图实例已加载。");
          if (resolveMapReady) {
            resolveMapReady(map);
          }
        });
      }

      function showMainApp() {
        mapReadyPromise = new Promise((resolve) => {
          resolveMapReady = resolve;
        });

        // 新增：进入主应用时恢复显示退出应用按钮
        const exitBtn = $("exit-app-btn");
        if (exitBtn) exitBtn.classList.remove("hidden");

        if (isMobileMode) {
          const mobileMainApp = document.getElementById("mobile-main-app");
          const mobileLoginContainer = document.getElementById(
            "mobile-login-container"
          );
          const mobileAuthContainer = document.getElementById(
            "mobile-auth-login-container"
          );
          const mobileMultiApp = document.getElementById(
            "mobile-multi-account-app"
          );

          if (mobileMainApp) {
            mobileMainApp.classList.remove("hidden");
            console.log("[单账号模式] 移动端：显示 mobile-main-app");
          }
          if (mobileLoginContainer)
            mobileLoginContainer.classList.add("hidden");
          if (mobileAuthContainer) mobileAuthContainer.classList.add("hidden");
          if (mobileMultiApp) mobileMultiApp.classList.add("hidden");

          updateMobileNavVisibility(true, "single");

          switchMobileSinglePanel("mobile-control-panel");
          console.log("[单账号模式] 移动端：已默认激活 mobile-control-panel");

          $("main-app").classList.add("hidden");
          $("multi-account-app").classList.add("hidden");
          $("login-container").classList.add("hidden");
          $("auth-login-container").classList.add("hidden");
        } else {
          $("auth-login-container").classList.add("hidden");
          $("login-container").classList.add("hidden");
          $("main-app").classList.remove("hidden");
          $("main-app").classList.add("grid");
          console.log("[单账号模式] 桌面端：显示 main-app");
        }

        logMessage_Info("已进入单账号模式。");

        destroySingleMap();

        logMessage_Info("等待UI渲染稳定...");
        setTimeout(() => {
          logMessage_Info("UI稳定，开始初始化地图...");
          loadAMapOnce()
            .then(() => {
              initMap(AMapInstance);
              ensureSingleControls();
            })
            .catch((e) => logMessage_Error("AMap 加载失败（延迟创建阶段）", e));
        }, 100);
      }

      function resetUI() {

        // 新增：重置UI时恢复显示退出应用按钮
        const exitBtn = $("exit-app-btn");
        if (exitBtn) exitBtn.classList.remove("hidden");


        $("main-app").classList.add("hidden");
        $("main-app").classList.remove("grid");
        $("login-container").classList.remove("hidden");
        $("user-name-label").textContent = "姓名: NULL";
        $("user-id-label").textContent = "学号: NULL";
        const logoutBtn = $("logout-button");
        logoutBtn.classList.remove("!text-amber-500");
        logoutBtn.classList.add("!text-red-600");
        currentTasks = [];
        selectedTaskIndex = -1;
        currentUserData = {};
        currentRunData = {};
        $("task-list").innerHTML = "";
        $("history-list").innerHTML = "";
        $("target-points-text").innerHTML = "";

        IS_OFFLINE = false;
        const uaLabel = $("ua-label");
        if (uaLabel) uaLabel.textContent = " (未加载) ";
        const uaBtn = $("random-ua-btn");
        if (uaBtn) uaBtn.disabled = false;

        try {
          const container = document.getElementById("map-container");
          if (container) container.classList.remove("drawing");
        } catch (_) {}
        isDrawing = false;
        isPathDrawing = false;
        leftMouseDown = false;
        pendingUnlockMap = false;
        draftPath = [];
        draftPathLngLat = [];
        pendingPoints = [];
        isUpdating = false;
        lastMouseMoveTime = 0;
        try {
          document.body.classList.remove("modal-visible");
        } catch (_) {}

        $("start-run-button").textContent = "开始执行";
        $("start-run-button").classList.remove("btn-danger");
        $("start-run-button").classList.add("btn-primary");
        $("start-all-button").textContent = "执行所有";
        $("start-all-button").classList.remove("btn-danger");
        $("start-all-button").classList.add("btn-secondary");

        stopBackgroundTaskPolling();

        updateDashboard();

        destroySingleMap();

        onUserChange();
      }

      function clearMapOverlays() {
        if (!map) return;
        polylines.recommended.forEach((p) => map.remove(p));
        polylines.recommended = [];
        if (polylines.draft) map.remove(polylines.draft);
        if (polylines.run) map.remove(polylines.run);
        if (polylines.history) map.remove(polylines.history);
        polylines.draft = polylines.run = polylines.history = null;
        map.remove(markers);
        markers = [];
        if (runnerMarker) {
          map.remove(runnerMarker);
          runnerMarker = null;
        }
        if (drawingInfoMarker) {
          map.remove(drawingInfoMarker);
          drawingInfoMarker = null;
        }
      }

      function destroySingleMap() {
        try {
          if (map && typeof map.destroy === "function") {
            map.destroy();
          }
        } catch (e) {
          logMessage_Warning("destroySingleMap warning:", e);
        } finally {
          map = null;
          polylines.recommended = [];
          polylines.draft = null;
          polylines.run = null;
          polylines.history = null;
          markers = [];
          runnerMarker = null;
          drawingInfoMarker = null;

          try {
            const container = document.getElementById("map-container");
            if (container) container.classList.remove("drawing");
          } catch (_) {}
          isDrawing = false;
          isPathDrawing = false;
          leftMouseDown = false;
          pendingUnlockMap = false;
          draftPath = [];
          draftPathLngLat = [];
          pendingPoints = [];
          isUpdating = false;
          lastMouseMoveTime = 0;

          try {
            document.body.classList.remove("modal-visible");
          } catch (_) {}
        }
      }

      $("user-combo").addEventListener("change", onUserChange);
      $("username-entry").addEventListener("input", async (e) => {
        const loginBtn = $("login-button");
        if (loginBtn) {
          loginBtn.disabled = true;
        }

        try {
          const username = e.target.value.trim();
          $("password-entry").value = "";
          const userCombo = $("user-combo");
          const exists = [...userCombo.options].some(
            (o) => o.value === username
          );
          userCombo.value = exists ? username : "";
          const data = await callPythonAPI("on_user_selected", username);
          if (data && data.password) $("password-entry").value = data.password;
          logMessage_Info("获取到的data.ua:", data ? data.ua : "null");
          const ua_data =
            data && data.ua ? data.ua : "(新用户将在登录时自动生成)";
          $("ua-label").textContent = ua_data;
          syncUAToMobile(ua_data);
          logMessage_Info("User ua label set to:", ua_data);
          pythonParams = data && data.params ? data.params : pythonParams;
          updateParamInputs($("params-container"), "param", pythonParams);
          const base = pythonParams.theme_base_color || "#7dd3fc";
          setBaseColor(base, base);
        } finally {
          if (loginBtn) {
            loginBtn.disabled = false;
          }
        }
      });
      $("random-ua-btn").addEventListener("click", async () => {
        const newUA = await callPythonAPI("generate_new_ua");
        $("ua-label").textContent = newUA;
        // ================同步UA到移动端标签====================
        syncUAToMobile(newUA);
      });
      $("login-button").addEventListener("click", async (e) => {
        if (
          !(await checkButtonPermission("login-button", "use_login_button"))
        ) {
          return;
        }
        await onLogin();
      });
      $("logout-button").addEventListener("click", onLogout);
      $("refresh-button").addEventListener("click", refreshTasks);
      $("record-button").addEventListener("click", toggleRecordMode);
      $("clear-button").addEventListener("click", () => clearCurrentPath(true));
      $("process-button").addEventListener("click", processCurrentPath);
      $("start-run-button").addEventListener("click", toggleRun);
      $("start-all-button").addEventListener("click", toggleAllRuns);
      $("export-button").addEventListener("click", exportTask);
      $("import-button").addEventListener("click", async (e) => {
        if (
          !(await checkButtonPermission("import-button", "use_import_button"))
        ) {
          return;
        }
        await importTask();
      });
      $("show-user-details").addEventListener("click", (e) => {
        e.stopPropagation();
        showUserDetails();
      });
      $("show-task-details").addEventListener("click", (e) => {
        e.stopPropagation();
        showTaskDetails();
      });
      $("auto-gen-button").addEventListener("click", () => {
        $("auto-gen-modal").classList.remove("hidden");
        $("auto-gen-modal").classList.add("flex");
        document.body.classList.add("modal-visible");
      });
      $("cancel-gen-button").addEventListener("click", () => {
        $("auto-gen-modal").classList.add("hidden");
        $("auto-gen-modal").classList.remove("flex");
        document.body.classList.remove("modal-visible");
      });
      $("confirm-gen-button").addEventListener("click", onConfirmAutoGenerate);

      $("show-notifications-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        showNotifications();
      });

      $("mark-all-read-btn").addEventListener("click", markAllAsRead);
      $("refresh-notifications-btn").addEventListener("click", () =>
        refreshNotificationsUI(true, true)
      );

      $("multi-download-template-btn").addEventListener(
        "click",
        multi_downloadTemplate
      );
      async function onConfirmAmapKey() {
        const input = $("amap-key-input");
        const newKey = input.value.trim();
        if (!newKey) {
          showModalAlert("API Key 不能为空！");
          return;
        }

        const btn = $("confirm-amap-key-btn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = `<span class="inline-block animate-spin mr-2">⏳</span>保存中...`;

        try {
          const result = await callPythonAPI("save_amap_key", newKey);
          if (result.success) {
            AMAP_API_KEY = newKey;
            const modal = $("amap-key-modal");
            modal.classList.add("hidden");
            modal.classList.remove("flex");
            document.body.classList.remove("modal-visible");
            logMessage_Info("API Key已更新，正在尝试重新加载地图...");
            try {
              await loadAMapOnce();
              ensureSingleMap();
            } catch (e) {
              logMessage_Error("保存Key后加载AMap SDK失败", e);
              logMessage_Info(
                "[错误] 新的API Key似乎无效，地图加载失败。请检查后重试。"
              );
              modal.classList.remove("hidden");
              modal.classList.add("flex");
              document.body.classList.add("modal-visible");
            }
          } else {
            showModalAlert(`保存失败: ${result.message}`);
          }
        } catch (e) {
          logMessage_Error("保存API Key时发生网络错误:", e);
          showModalAlert(`保存失败: ${e.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      function bindImmediateRefreshForUserSelects() {
        const loginSelect = $("user-combo");
        const multiSelect = $("multi-config-user-select");

        if (loginSelect && !loginSelect._refreshBound) {
          loginSelect.addEventListener("focus", refreshUserList);
          loginSelect.addEventListener("click", refreshUserList);
          loginSelect._refreshBound = true;
        }

        if (multiSelect && !multiSelect._refreshBound) {
          multiSelect.addEventListener("focus", refreshUserList);
          multiSelect.addEventListener("click", refreshUserList);
          multiSelect._refreshBound = true;
        }
      }
      async function multi_downloadTemplate() {
        const result = await callPythonAPI("multi_download_import_template");
        if (!result || !result.success) {
          showModalAlert(result?.message || "模板下载失败");
          return;
        }
        if (result.content && result.filename) {
          const binaryString = atob(result.content);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const blob = new Blob([bytes], {
            type: result.mimetype || "application/octet-stream",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = result.filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          logMessage_Info(`模板已下载：${result.filename}`);
        }
      }
      async function refreshUserList() {
        // 如果已经显示了被踢出的遮罩，不再发送请求
        if (document.getElementById("logout-elsewhere-overlay")) {
          return;
        }
        if (isInNetworkErrorState) {
          return;
        }
        if (
          !sessionUUID ||
          sessionUUID === "null" ||
          sessionUUID.trim() === ""
        ) {
          return;
        }
        try {
          const initialData = await callPythonAPI("get_initial_data");
          const users = Array.isArray(initialData?.users)
            ? initialData.users
            : [];

          const select = document.getElementById("user-combo");
          const multiSelect = document.getElementById(
            "multi-config-user-select"
          );
          function updateSelect(selectElem, users) {
            if (!selectElem) return;
            const previousValue = selectElem.value;
            const previousScrollTop = selectElem.scrollTop;
            selectElem.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(新用户/手动输入)";
            selectElem.appendChild(opt);

            users.forEach((u) => {
              const o = document.createElement("option");
              o.value = u;
              o.textContent = u;
              o.title = u;
              selectElem.appendChild(o);
            });
            if (users.includes(previousValue)) {
              selectElem.value = previousValue;
            } else {
              selectElem.value = "";
            }
            selectElem.scrollTop = previousScrollTop;
          }

          updateSelect(select, users);
          updateSelect(multiSelect, users);
        } catch (err) {
          logMessage_Error("刷新用户列表失败", err);
        }
      }

      setInterval(refreshUserList, 5000);

      async function onUserChange() {
        const loginBtn = $("login-button");
        if (loginBtn) {
          loginBtn.disabled = true;
        }

        try {
          const username = $("user-combo").value;
          const data = await callPythonAPI("on_user_selected", username);
          $("username-entry").value = username;
          $("password-entry").value = data.password || "";

          const uaText = data.ua || "(新用户将在登录时自动生成)";
          $("ua-label").textContent = uaText;
          // ========================================
          // 【移动端同步】
          // ========================================
          syncUAToMobile(uaText);

          pythonParams = data.params || pythonParams;
          updateParamInputs($("params-container"), "param", pythonParams);

          const base = pythonParams.theme_base_color || "#7dd3fc";
          setBaseColor(base, base);

          const style = pythonParams.theme_style || "default";
          setThemeStyle(style);

          if (sessionUUID && currentAuthUsername) {
            try {
              const response = await fetch(
                "/auth/admin/get_user_school_accounts",
                {
                  method: "GET",
                  headers: {
                    "X-Session-ID": sessionUUID,
                  },
                }
              );

              if (response.ok) {
                const result = await response.json();

                if (result.success && result.accounts) {
                  const accountData = result.accounts[username];

                  let password = null;
                  let ua = null;

                  if (typeof accountData === "string") {
                    password = accountData;
                  } else if (
                    typeof accountData === "object" &&
                    accountData !== null
                  ) {
                    password = accountData.password;
                    ua = accountData.ua;
                  }

                  if (password) {
                    $("password-entry").value = password;

                    logMessage_Info(
                      `[用户选择] 已从 school_accounts 加载用户 ${username} 的密码`
                    );
                  }

                  if (ua) {
                    $("ua-label").textContent = ua;
                    syncUAToMobile(ua);
                    logMessage_Info(
                      `[用户选择] 已从 school_accounts 加载用户 ${username} 的UA`
                    );
                  }
                }
              }
            } catch (error) {
              logMessage_Warning(
                `[用户选择] 无法加载 school_accounts: ${error.message}`
              );
            }
          }
        } finally {
          if (loginBtn) {
            loginBtn.disabled = false;
          }
        }
      }

      async function onLogin() {
        logMessage_Info("[前端-登录] 开始登录流程...");
        const user = $("username-entry").value.trim();
        const pass = $("password-entry").value;

        logMessage_Info(`[前端-登录] 用户名: ${user}`);
        if (!user) {
          logMessage_Info("[前端-登录] 错误: 用户名为空");
          showModalAlert("请输入用户名");
          return;
        }

        IS_OFFLINE = false;
        const uaBtn = $("random-ua-btn");
        if (uaBtn) uaBtn.disabled = false;

        const uaOnLoginScreen = $("ua-label")?.textContent || "";
        logMessage_Info(
          `[前端-登录] 当前UA: ${uaOnLoginScreen.substring(0, 50)}...`
        );

        setButtonLoading("login-button", true, "登录中...");

        logMessage_Info("[前端-登录] 调用后端API进行登录验证...");
        const result = await callPythonAPI("login", user, pass);
        if (result.success) {
          logMessage_Info("[前端-登录] ✓ 登录成功！");
          showButtonSuccess("login-button", "登录成功");
          if (result.amap_key) {
            logMessage_Info("[前端-登录] 加载高德地图API...");
            AMAP_API_KEY = result.amap_key;
            try {
              await loadAMapOnce();
              logMessage_Info("[前端-登录] ✓ 地图加载成功");
            } catch (e) {
              logMessage_Error("[前端-登录] ✗ 地图加载失败:", e);
            }
          }

          logMessage_Info("[前端-登录] 显示主应用界面...");
          showMainApp();
          $("loading-overlay").classList.add("hidden");
          currentUserData = result.userInfo;
          currentUserData.group = result.auth_group || "user";
          currentSessionUA = uaOnLoginScreen;
          const name = currentUserData.name || "";
          $("user-name-label").textContent = `姓名: ${name}`;
          $(
            "user-id-label"
          ).textContent = `学号: ${currentUserData.student_id}`;
          logMessage_Info(
            `[前端-登录] 用户信息已更新: ${name} (${currentUserData.student_id})`
          );

          logMessage_Info("[前端-登录] 更新仪表盘...");
          updateDashboard();

          logMessage_Info("[前端-登录] 刷新任务列表...");
          await refreshTasks();

          logMessage_Info("[前端-登录] 获取通知...");
          const notificationBadge = $("notification-badge");
          if (notificationBadge) {
            notificationBadge.classList.add("hidden");
          }
          if (
            result.cached_notifications &&
            result.cached_notifications.notices.length > 0
          ) {
            logMessage_Info(
              `使用登录时预加载的 ${result.cached_notifications.notices.length} 条通知`
            );
            if (result.cached_notifications.unreadCount > 0) {
              notificationBadge.textContent =
                result.cached_notifications.unreadCount > 9
                  ? "9+"
                  : result.cached_notifications.unreadCount;
              notificationBadge.classList.remove("hidden");
            }
            window.currentNotifications = result.cached_notifications.notices;
          } else {
            await fetchNotifications();
          }

          const base = pythonParams.theme_base_color || "#7dd3fc";
          setBaseColor(base, base);
          const adminBtn = $("show-admin-panel");
          if (adminBtn) adminBtn.classList.remove("hidden");
          const adminBtnLogin = $("show-admin-panel-login");
          if (adminBtnLogin) adminBtnLogin.classList.remove("hidden");
          $("loading-overlay").classList.add("hidden");
          logMessage_Info("[前端-登录] ✓ 登录流程完成！");
          return true;
        } else {
          logMessage_Info(`[前端-登录] ✗ 登录失败: ${result.message}`);
          setButtonLoading("login-button", false);
          showButtonError("login-button", "登录失败");
          showModalAlert(result.message, "登录失败");
          return false;
        }
      }

      async function onLogout() {
        await callPythonAPI("logout");
        currentSessionUA = "";
        resetUI();

        if (refreshUserListInterval) {
          clearInterval(refreshUserListInterval);
          refreshUserListInterval = null;
          logMessage_Info("refreshUserList interval cleared on logout.");
        }

        await new Promise((resolve) => setTimeout(resolve, 500));
        loadAdminSessions_inline();
      }

      async function refreshTasks() {
        if (isRefreshingTasks) {
          return;
        }
        isRefreshingTasks = true;

        const btn = $("refresh-button");
        if (btn) btn.disabled = true;

        try {
          const taskResult = await callPythonAPI("load_tasks");
          if (taskResult && taskResult.success) {
            currentTasks = taskResult.tasks;
            renderTaskList();
            return;
          }

          await new Promise((r) => setTimeout(r, 300));
          const retry = await callPythonAPI("load_tasks");
          if (retry && retry.success) {
            currentTasks = retry.tasks;
            renderTaskList();

            await fetchNotifications();
          } else {
            logMessage_Info("加载任务列表失败，请点击左侧“刷新”重试。");
          }
        } finally {
          isRefreshingTasks = false;
          if (btn) btn.disabled = false;
        }
      }

      function renderTaskList() {
        const taskListDiv = $("task-list");
        taskListDiv.innerHTML = "";
        if (currentTasks.length === 0) {
          taskListDiv.innerHTML = `<div class="text-slate-400 text-center py-10">暂无任务</div>`;
          return;
        }
        currentTasks.forEach((task, index) => {
          const item = document.createElement("div");
          const pathStatus =
            task.run_coords?.length > 0
              ? "已生成"
              : task.draft_coords?.length > 0
              ? "草稿"
              : "无路径";
          let statusClass = "text-amber-600",
            statusText = "未完成",
            statusIcon = "🕒";

          if (task.status == 1) {
            statusClass = "text-emerald-600";
            statusText = "已完成";
            statusIcon = "✅";
          }

          if (task.info_text === "已过期") {
            statusClass = "text-red-600";
            statusText = "已过期";
            statusIcon = "⛔";
          }

          if (!(task.status == 1)) {
            if (
              typeof task.info_text === "string" &&
              task.info_text.startsWith("开始于")
            ) {
              statusClass = "text-slate-600";
              statusText = "未开始";
              statusIcon = "⏳";
            }
          }

          item.className =
            "p-3 rounded-xl cursor-pointer border border-transparent transition-colors duration-200 hover:bg-white/70";
          item.innerHTML = `
      <div class="flex items-center gap-3">
        <p class="font-bold text-slate-700 text-sm truncate">${
          task.run_name
        }</p>
      </div>
      <div class="flex justify-between items-center mt-2 text-xs">
        <span class="font-semibold ${statusClass} flex items-center gap-1">${statusIcon} ${statusText}</span>
        <span class="text-slate-500">${task.info_text || ""}</span>
        <span class="badge">${pathStatus}</span>
      </div>
    `;
          item.dataset.index = index;
          if (task.status === 1) item.classList.add("opacity-60");
          if (index === selectedTaskIndex) item.classList.add("selected");
          item.addEventListener("click", () => selectTask(index));
          taskListDiv.appendChild(item);
        });

        renderMobileTaskList();
      }
      function renderMobileTaskList() {
        const mobileTaskListDiv = $("mobile-task-list");
        if (!mobileTaskListDiv) return;
        mobileTaskListDiv.innerHTML = "";
        const taskCountElem = $("mobile-task-count");
        if (taskCountElem) {
          taskCountElem.textContent = `${currentTasks.length} 个任务`;
        }
        if (currentTasks.length === 0) {
          mobileTaskListDiv.innerHTML = `<p class="text-slate-400 text-center py-8 text-sm">暂无任务</p>`;
          return;
        }
        currentTasks.forEach((task, index) => {
          const item = document.createElement("div");
          let statusClass = "text-amber-600";
          let statusText = "未完成";
          let statusIcon = "🕒";
          if (task.status == 1) {
            statusClass = "text-emerald-600";
            statusText = "已完成";
            statusIcon = "✅";
          }

          if (task.info_text === "已过期") {
            statusClass = "text-red-600";
            statusText = "已过期";
            statusIcon = "⛔";
          }
          if (!(task.status == 1)) {
            if (
              typeof task.info_text === "string" &&
              task.info_text.startsWith("开始于")
            ) {
              statusClass = "text-slate-600";
              statusText = "未开始";
              statusIcon = "⏳";
            }
          }
          item.className =
            "bg-white rounded-lg p-3 border border-slate-200 cursor-pointer transition-all duration-200 hover:shadow-md active:scale-98 min-w-[300px]";
          item.id = `Mobile_Task_List_Sub_project${task.errand_id}`;
          item.innerHTML = `
          <div class="flex items-center justify-between mb-2"">
            <p class="font-semibold text-slate-800 text-sm truncate flex-1">${
              task.run_name
            }</p>
          </div>
          <div class="flex items-center justify-between text-xs">
            <span class="font-medium ${statusClass} flex items-center gap-1">
              <span>${statusIcon}</span>
              <span>${statusText}</span>
            </span>
            <span class="text-slate-500">${task.info_text || ""}</span>
          </div>
        `;

          item.dataset.index = index;
          if (task.status === 1) {
            item.style.opacity = "0.6";
          }
          if (index === selectedTaskIndex) {
            item.style.backgroundColor = "#eff6ff";
            item.style.border = "2px solid #3b82f6";
            item.style.borderLeft = "6px solid #2563eb";
            item.style.boxShadow =
              "0 4px 6px -1px rgba(59, 130, 246, 0.2), 0 2px 4px -1px rgba(59, 130, 246, 0.1)";
            item.style.transform = "scale(1.01)";
            item.style.zIndex = "10";
            item.style.position = "relative";
            item.querySelectorAll("p, span").forEach((el) => {
              if (el.classList.contains("text-slate-800"))
                el.style.color = "#1e40af";
            });
          } else {
            item.style.backgroundColor = "#ffffff";
            item.style.border = "1px solid #e2e8f0";
            item.style.borderLeft = "1px solid #e2e8f0";
            item.style.boxShadow = "none";
            item.style.transform = "none";
            item.style.zIndex = "auto";
            item.style.position = "static";
            item.querySelectorAll("p, span").forEach((el) => {
              if (el.classList.contains("text-slate-800")) el.style.color = "";
            });
          }

          item.addEventListener("click", async () => {
            if (index === selectedTaskIndex) {
              selectTask(index);
              return;
            }
            const statusRes = await callPythonAPI_raw(
              "/api/background_task/status",
              "GET",
              null
            );
            const isBackendRunning =
              statusRes.success &&
              statusRes.task_status &&
              statusRes.task_status.status === "running";

            if (isBackendRunning) {
              showTempMessage("任务正在运行中，禁止切换任务！", "error");
              mobileTaskRunning = true;
              updateMobileTaskUI("运行中", "任务执行中");
              return;
            }
            selectTask(index);
          });
          mobileTaskListDiv.appendChild(item);
        });
      }
      function renderMobileCheckpointsList() {
        const checkpointsListDiv = $("mobile-checkpoints-list");
        const taskInfoDiv = $("mobile-checkpoints-task-info");
        if (!checkpointsListDiv) return;

        if (
          selectedTaskIndex === -1 ||
          !currentRunData ||
          !currentRunData.target_points ||
          currentRunData.target_points.length === 0
        ) {
          checkpointsListDiv.innerHTML =
            '<p class="text-slate-400 text-center py-8 text-sm">请先选择一个有打卡点的任务</p>';

          if (taskInfoDiv) {
            if (selectedTaskIndex === -1) {
              taskInfoDiv.textContent = "请先选择一个任务以查看打卡点";
            } else {
              taskInfoDiv.textContent = "当前任务没有打卡点";
            }
          }
          return;
        }

        if (taskInfoDiv) {
          const taskName =
            currentTasks[selectedTaskIndex]?.run_name || "未知任务";
          taskInfoDiv.textContent = `任务: ${taskName}`;
        }

        checkpointsListDiv.innerHTML = "";

        const targetPoints = currentRunData.target_points;
        const targetNames = (currentRunData.target_point_names || "").split(
          "|"
        );
        const currentSequence = currentRunData.target_sequence || 1;

        targetPoints.forEach((point, index) => {
          const item = document.createElement("div");

          const seq = index + 1;
          const name = targetNames[index] || `打卡点${seq}`;
          const [lon, lat] = point;

          const isReached = currentSequence > seq;
          const isCurrent = currentSequence === seq;
          let statusClass = "bg-white border-slate-200";
          let statusBadge =
            '<span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">未到达</span>';

          if (isReached) {
            statusClass = "bg-green-50 border-green-200";
            statusBadge =
              '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-600 flex items-center gap-1"><span>✓</span><span>已到达</span></span>';
          } else if (isCurrent) {
            statusClass = "bg-blue-50 border-blue-400 ring-2 ring-blue-300";
            statusBadge =
              '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-600 flex items-center gap-1"><span>🎯</span><span>目标</span></span>';
          }
          item.className = `${statusClass} rounded-lg p-3 border transition-all duration-200 cursor-pointer hover:shadow-md`;
          item.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2 flex-1">
              <span class="text-lg font-bold ${
                isCurrent
                  ? "text-blue-600"
                  : isReached
                  ? "text-green-600"
                  : "text-slate-400"
              }">
                ${seq}
              </span>
              <div class="flex-1">
                <p class="font-semibold text-slate-800 text-sm">${name}</p>
                <p class="text-xs text-slate-500 mt-1">坐标: ${lat.toFixed(
                  6
                )}, ${lon.toFixed(6)}</p>
              </div>
            </div>
            ${statusBadge}
          </div>
        `;
          item.addEventListener("click", () => {
            if (window.map) {
              window.map.setCenter([lon, lat]);
              window.map.setZoom(16);
              showTempMessage(`已定位到 ${name}`, "success");
            } else {
              showTempMessage("地图未初始化", "error");
            }
          });
          checkpointsListDiv.appendChild(item);
        });
      }
      async function forceLoadTaskDataForPolling(taskIndex) {
        if (taskIndex < 0 || taskIndex >= currentTasks.length) return;
        if (currentRunData && currentRunData.task_index === taskIndex) return;

        logMessage_Info(`[Polling] 强制加载任务 #${taskIndex} 的数据...`);
        try {
          const result = await callPythonAPI("get_task_details", taskIndex);
          if (result.success) {
            currentRunData = result.details;
            currentRunData.task_index = taskIndex;
            updateDashboard();
            drawOnMap();
            loadHistory(taskIndex);
            singleProcessedPoints = 0;
            singleTotalPoints = currentRunData.run_coords?.length || 0;
            updateSingleProgress(0, "0 / " + singleTotalPoints + " 点");
          } else {
            logMessage_Error(
              `[Polling] 强制加载任务数据失败: ${result.message}`
            );
          }
        } catch (e) {
          logMessage_Error(`[Polling] 强制加载任务时出错: ${e}`);
        }
      }

      async function selectTask(index, Update_Dashboard = true) {
        logMessage_Info(`[任务选择] 开始选择任务，索引: ${index}`, "DEBUG");
        logMessage_Info(`[前端-任务选择] 选择任务 #${index}`);
        if (backgroundTaskPollInterval && selectedTaskIndex !== index) {
          logMessage_Warning("任务执行中，无法切换任务！请先停止当前任务。");
          showModalAlert("任务执行中，无法切换任务！请先停止当前任务。");
          return;
        }

        if (isDrawing) {
          logMessage_Info("请先结束当前路径绘制！", "WARN");
          return;
        }
        if (selectedTaskIndex === index) {
          logMessage_Info(
            `[任务选择] 任务已选中，无需重复选择: ${index}`,
            "DEBUG"
          );
          return;
        }

        const taskListDiv = $("task-list");
        if (selectedTaskIndex > -1 && taskListDiv.children[selectedTaskIndex]) {
          taskListDiv.children[selectedTaskIndex].classList.remove("selected");
          logMessage_Info(
            `[任务选择] 取消选中上一个任务: ${selectedTaskIndex}`,
            "DEBUG"
          );
        }
        selectedTaskIndex = index;
        if (taskListDiv.children[selectedTaskIndex]) {
          taskListDiv.children[selectedTaskIndex].classList.add("selected");
          logMessage_Info(`[任务选择] 高亮显示当前任务: ${index}`, "DEBUG");
        }
        if (isMobileMode) {
          renderMobileTaskList();
        }
        const selectedTask = currentTasks[index];
        if (selectedTask && selectedTask.info_text === "离线") {
          logMessage_Info(`[任务选择] 离线模式任务，使用本地数据`, "INFO");
          currentRunData = selectedTask;
          if (Update_Dashboard) {
            updateDashboard();
          }
          drawOnMap();
          loadHistory(index);
          singleProcessedPoints = 0;
          singleTotalPoints = currentRunData.run_coords?.length || 0;
          updateSingleProgress(0, "0 / " + singleTotalPoints + " 点");
          logMessage_Info(
            `[任务选择] ✓ 离线任务加载完成，总点数: ${singleTotalPoints}`,
            "INFO"
          );
        } else {
          logMessage_Info(`[任务选择] 在线模式，从后端获取任务详情...`, "INFO");
          const result = await callPythonAPI("get_task_details", index);
          if (result.success) {
            logMessage_Info(`[任务选择] ✓ 任务详情获取成功`, "INFO");
            currentRunData = result.details;
            updateDashboard();

            drawOnMap();
            loadHistory(index);
            singleProcessedPoints = 0;
            singleTotalPoints = currentRunData.run_coords?.length || 0;
            updateSingleProgress(0, "0 / " + singleTotalPoints + " 点");
            logMessage_Info(
              `[任务选择] ✓ 在线任务加载完成，总点数: ${singleTotalPoints}`,
              "INFO"
            );
          } else {
            logMessage_Info(
              `[任务选择] ✗ 获取任务详情失败: ${result.message}`,
              "ERROR"
            );
            logMessage_Info(result.message);
          }
        }
      }
      $("multi-account-btn").addEventListener("click", async (e) => {
        if (
          !(await checkButtonPermission(
            "multi-account-btn",
            "use_multi_account_button"
          ))
        ) {
          return;
        }
        await switchToMultiMode();
      });
      $("exit-multi-mode-btn").addEventListener("click", exitMultiMode);
      $("multi-start-all-btn").addEventListener("click", multi_startAll);
      $("multi-stop-all-btn").addEventListener("click", multi_stopAll);
      $("multi-load-all-from-config-btn").addEventListener(
        "click",
        multi_loadAllFromConfig
      );
      $("multi-add-from-config-btn").addEventListener(
        "click",
        multi_addFromConfig
      );
      $("multi-import-excel-btn").addEventListener(
        "click",
        multi_importFromExcel
      );
      $("multi-export-excel-btn").addEventListener(
        "click",
        multi_exportToExcel
      );
      $("multi-remove-all-btn").addEventListener("click", multi_removeAll);
      $("multi-remove-selected-btn").addEventListener(
        "click",
        multi_removeSelected
      );
      $("multi-refresh-all-btn").addEventListener("click", multi_refreshAll);
      $("multi-select-all-check").addEventListener(
        "change",
        multi_toggleSelectAll
      );
      $("multi-start-selected-btn").addEventListener(
        "click",
        multi_startSelected
      );
      $("multi-stop-selected-btn").addEventListener(
        "click",
        multi_stopSelected
      );
      $("multi-refresh-selected-btn").addEventListener(
        "click",
        multi_refreshSelected
      );

      $("admin-tab-users_modal")?.addEventListener("click", () =>
        switchAdminTab("users")
      );
      $("admin-tab-groups_modal")?.addEventListener("click", () =>
        switchAdminTab("groups")
      );
      $("admin-tab-logs_modal")?.addEventListener("click", () =>
        switchAdminTab("logs")
      );
      $("admin-tab-health_modal")?.addEventListener("click", () =>
        switchAdminTab("health")
      );
      $("admin-tab-profile_modal")?.addEventListener("click", () =>
        switchAdminTab("profile")
      );
      $("admin-tab-sessions_modal")?.addEventListener("click", () =>
        switchAdminTab("sessions")
      );
      $("admin-tab-messages_modal")?.addEventListener("click", () =>
        switchAdminTab("messages")
      );
      $("admin-tab-ipban_modal")?.addEventListener("click", () =>
        switchAdminTab("ipban")
      );
      $("admin-tab-sms_modal")?.addEventListener("click", () =>
        switchAdminTab("sms")
      );

      const loginTabBtn = $("log-tab-login");
      if (loginTabBtn) {
        loginTabBtn.addEventListener("click", () => {
          loginTabBtn.classList.add("text-sky-600", "border-sky-600");
          loginTabBtn.classList.remove("text-slate-400", "border-transparent");

          const auditTabBtn = $("log-tab-audit");
          if (auditTabBtn) {
            auditTabBtn.classList.remove("text-sky-600", "border-sky-600");
            auditTabBtn.classList.add("text-slate-400", "border-transparent");
          }

          const loginContent = $("log-login-content");
          const auditContent = $("log-audit-content");
          if (loginContent) loginContent.classList.remove("hidden");
          if (auditContent) auditContent.classList.add("hidden");

          const username = $("current-log-username")?.textContent;
          if (username && username !== "N/A") {
            loadUserLoginLogs(username);
          }
        });
      }
      const auditTabBtn = $("log-tab-audit");
      if (auditTabBtn) {
        auditTabBtn.addEventListener("click", () => {
          auditTabBtn.classList.add("text-sky-600", "border-sky-600");
          auditTabBtn.classList.remove("text-slate-400", "border-transparent");
          const loginTabBtn = $("log-tab-login");
          if (loginTabBtn) {
            loginTabBtn.classList.remove("text-sky-600", "border-sky-600");
            loginTabBtn.classList.add("text-slate-400", "border-transparent");
          }
          const loginContent = $("log-login-content");
          const auditContent = $("log-audit-content");
          if (loginContent) loginContent.classList.add("hidden");
          if (auditContent) auditContent.classList.remove("hidden");

          const username = $("current-log-username")?.textContent;
          if (username && username !== "N/A") {
            loadUserAuditLogs(username);
          }
        });
      }
      $("admin-refresh-messages_modal")?.addEventListener(
        "click",
        loadMessages
      );
      const guestWarningCloseBtn = $("guest-warning-close-btn");
      const guestWarningOverlay = $("guest_warning_overlay");
      if (guestWarningCloseBtn) {
        guestWarningCloseBtn.addEventListener("click", () => {
          const guestToast = $("guest-warning-toast");
          if (guestToast) {
            guestToast.classList.add("hidden");
          }
          if (guestWarningOverlay) {
            guestWarningOverlay.classList.add("hidden");
          }
        });
      }
      if (guestWarningOverlay) {
        guestWarningOverlay.addEventListener("click", () => {
          const guestToast = $("guest-warning-toast");
          if (guestToast) {
            guestToast.classList.add("hidden");
          }
          guestWarningOverlay.classList.add("hidden");
        });
      }
      async function switchToMultiMode() {
        $("multi-account-count").textContent = 0;


        // 新增：进入多账号模式时恢复显示退出应用按钮
        const exitBtn = $("exit-app-btn");
        if (exitBtn) exitBtn.classList.remove("hidden");


        const result = await callPythonAPI("enter_multi_account_mode");
        if (!result.success) return;
        if (isMobileMode) {
          if (typeof destroyMobileSingleMap === "function") {
            destroyMobileSingleMap();
            console.log("[切换模式] 移动端：已销毁单账号地图");
          }
          const mobileLoginContainer = document.getElementById(
            "mobile-login-container"
          );
          const mobileMultiApp = document.getElementById(
            "mobile-multi-account-app"
          );
          const mobileMainApp = document.getElementById("mobile-main-app");

          if (mobileLoginContainer)
            mobileLoginContainer.classList.add("hidden");
          if (mobileMainApp) mobileMainApp.classList.add("hidden");
          if (mobileMultiApp) {
            mobileMultiApp.classList.remove("hidden");
            switchMobilePanel("mobile-multi-control-panel", "multi");
            console.log("[切换模式] 移动端：显示 mobile-multi-account-app");
          }
          updateMobileNavVisibility(true, "multi");
          $("login-container").classList.add("hidden");
          $("main-app").classList.add("hidden");
          $("multi-account-app").classList.add("hidden");
        } else {
          $("login-container").classList.add("hidden");
          $("main-app").classList.add("hidden");
          $("multi-account-app").classList.remove("hidden");
          $("multi-account-app").classList.add("grid");
          console.log("[切换模式] 桌面端：显示 multi-account-app");
        }

        document.body.classList.remove("modal-visible");
        try {
          await loadAMapOnce();
        } catch (e) {
          logMessage_Error("AMap 未就绪，无法进入多账号地图", e);
          return;
        }
        if (!multiAccountMap && AMapInstance) {
          multiAccountMap = new AMapInstance.Map("multi-map-container", {
            viewMode: "3D",
            pitch: 55,
            rotation: 0,
            zoom: 17,
            center: [113.390342, 22.527403],
            renderOptions: {
              willReadFrequently: true,
            },
          });
          const ctrlBar = new AMapInstance.ControlBar({
            position: { left: "12px", top: "12px" },
            showZoomBar: false,
            showControlButton: true,
          });
          multiAccountMap.addControl(ctrlBar);
          try {
            const buildings = new AMapInstance.BuildingLayer();
            buildings.setMap(multiAccountMap);
          } catch (e) {
            logMessage_Warning("BuildingLayer not available (multi):", e);
          }

          multiAccountMap.on("zoomchange", () => {
            const z = multiAccountMap.getZoom();
            $("multi-zoom-level").textContent = String(z.toFixed(1));
          });

          multiAccountMap.on("zoomchange", () => {
            if (!multiAccountMap) return;
            const z = multiAccountMap.getZoom();
            const zoomLevelEl = $("multi-zoom-level");
            if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
          });
          if (window.multiMapCleanup) window.multiMapCleanup();
          window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

          multiAccountMap.setStatus({
            doubleClickZoom: true,
            dragEnable: true,
            scrollWheel: true,
            keyboardEnable: true,
          });
          ensureMultiControls();
        }

        const configUsers = await callPythonAPI("multi_get_all_config_users");
        const select = $("multi-config-user-select");
        select.innerHTML = '<option value="">(新用户/手动输入)</option>';
        configUsers.users.forEach((u) => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = u;
          select.appendChild(opt);
        });
        const container = $("multi-global-params-container");
        container.innerHTML = "";
        createParamInputs(container, "multi-param", onGlobalParamChange);
        pythonParams = result.params;
        updateParamInputs(container, "multi-param", pythonParams);

        await callPythonAPI(
          "set_multi_run_only_incomplete",
          document.getElementById("multi-run-only-incomplete-check").checked
        );
        bindImmediateRefreshForUserSelects();

        updateMultiGlobalButtons(true, true);

        const desktopCheckbox = document.getElementById(
          "multi-run-only-incomplete-check"
        );
        if (desktopCheckbox) {
          desktopCheckbox.removeEventListener(
            "change",
            updateAllAccountsStatusText
          );
          desktopCheckbox.addEventListener(
            "change",
            updateAllAccountsStatusText
          );
          console.log(
            '[事件监听器] 已为桌面端"仅执行未完成"复选框绑定change事件'
          );
        } else {
          console.warn(
            '[事件监听器] 未找到桌面端"仅执行未完成"复选框 (multi-run-only-incomplete-check)'
          );
        }
        const mobileCheckbox = document.getElementById(
          "mobile-multi-only-incomplete-check"
        );
        if (mobileCheckbox) {
          mobileCheckbox.removeEventListener(
            "change",
            updateAllAccountsStatusText
          );
          mobileCheckbox.addEventListener(
            "change",
            updateAllAccountsStatusText
          );

          console.log(
            '[事件监听器] 已为移动端"仅执行未完成"复选框绑定change事件'
          );
        } else {
          console.warn(
            '[事件监听器] 未找到移动端"仅执行未完成"复选框 (mobile-multi-only-incomplete-check)'
          );
        }
        const pcCheck = document.getElementById(
          "multi-run-only-incomplete-check"
        );
        const mbCheck = document.getElementById(
          "mobile-multi-only-incomplete-check"
        );

        if (pcCheck) {
          pcCheck.removeEventListener("change", updateAllAccountsStatusText);
          pcCheck.addEventListener("change", updateAllAccountsStatusText);
        }
        if (mbCheck) {
          mbCheck.removeEventListener("change", updateAllAccountsStatusText);
          mbCheck.addEventListener("change", updateAllAccountsStatusText);
        }
        try {
          console.log("[多账号模式] 初始加载账号列表...");
          const initialAccounts = await callPythonAPI(
            "multi_get_all_accounts_status"
          );
          if (initialAccounts && initialAccounts.accounts) {
            renderMultiAccountList(initialAccounts.accounts);
            console.log(
              `[多账号模式] 初始加载完成，当前有 ${initialAccounts.accounts.length} 个账号`
            );
          } else {
            console.log("[多账号模式] 初始加载完成，当前有 0 个账号");
            renderMultiAccountList([]);
          }
        } catch (error) {
          console.error("[多账号模式] 初始加载账号列表失败:", error);
          renderMultiAccountList([]);
        }
        updateAllAccountsStatusText();

        startMultiAccountAutoRefresh(500);
      }

      async function exitMultiMode() {
        stopMultiAccountAutoRefresh();

        path_planning_queue = [];
        is_planning_path = false;
        await callPythonAPI("exit_multi_account_mode");
        if (isMobileMode) {
          if (typeof destroyMobileMultiMap === "function") {
            destroyMobileMultiMap();
            console.log("[退出多账号] 移动端：已销毁多账号地图");
          }
          const mobileMultiApp = document.getElementById(
            "mobile-multi-account-app"
          );
          const mobileLoginContainer = document.getElementById(
            "mobile-login-container"
          );

          if (mobileMultiApp) mobileMultiApp.classList.add("hidden");
          if (mobileLoginContainer)
            mobileLoginContainer.classList.remove("hidden");
          updateMobileNavVisibility(false);

          console.log(
            "[退出多账号] 移动端：隐藏 mobile-multi-account-app，显示 mobile-login-container"
          );
        } else {
          $("multi-account-app").classList.add("hidden");
          $("multi-account-app").classList.remove("grid");
          $("login-container").classList.remove("hidden");
          console.log(
            "[退出多账号] 桌面端：隐藏 multi-account-app，显示 login-container"
          );
        }

        document.body.classList.remove("modal-visible");

        $("multi-account-list").innerHTML =
          '<p class="text-slate-400 text-center py-10">请先添加或导入账号</p>';
        if (multiAccountMap) {
          if (window.multiMapCleanup) {
            window.multiMapCleanup();
            window.multiMapCleanup = null;
          }
          try {
            multiAccountMap.remove(Object.values(multiAccountMarkers));
          } catch (_) {}
          try {
            if (typeof multiAccountMap.destroy === "function")
              multiAccountMap.destroy();
          } catch (e) {
            logMessage_Warning("destroy multiAccountMap warning:", e);
          }
        }
        multiAccountMarkers = {};
        multiAccountMap = null;

        resetUI();
        if (refreshUserListInterval) {
          clearInterval(refreshUserListInterval);
          refreshUserListInterval = null;
          logMessage_Info(
            "refreshUserList interval cleared on exiting multi mode."
          );
        }

        await new Promise((resolve) => setTimeout(resolve, 500));
        loadAdminSessions_inline();
      }

      async function multi_loadAllFromConfig() {
        const result = await callPythonAPI("multi_load_accounts_from_config");

        if (result && result.accounts) {
          if (sessionUUID && currentAuthUsername) {
            try {
              const response = await fetch(
                "/auth/admin/get_user_school_accounts",
                {
                  method: "GET",
                  headers: {
                    "X-Session-ID": sessionUUID,
                  },
                }
              );
              if (response.ok) {
                const schoolAccountsResult = await response.json();
                if (
                  schoolAccountsResult.success &&
                  schoolAccountsResult.accounts
                ) {
                  const accountDataMap = schoolAccountsResult.accounts;
                  let updatedCount = 0;
                  result.accounts.forEach((account) => {
                    if (account.username && accountDataMap[account.username]) {
                      const accountData = accountDataMap[account.username];
                      if (typeof accountData === "string") {
                        account.password = accountData;
                        updatedCount++;
                      } else if (
                        typeof accountData === "object" &&
                        accountData !== null
                      ) {
                        if (accountData.password) {
                          account.password = accountData.password;
                        }
                        if (accountData.ua) {
                          account.device_ua = accountData.ua;
                        }
                        updatedCount++;
                      }
                    }
                  });
                  if (updatedCount > 0) {
                    logMessage_Info(
                      `[多账号-加载全部] 已从 school_accounts 更新 ${updatedCount} 个账号的密码和UA`
                    );
                  }
                }
              }
            } catch (error) {
              logMessage_Warning(
                `[多账号-加载全部] 无法加载 school_accounts: ${error.message}`
              );
            }
          }
          renderMultiAccountList(result.accounts);
        }
        if (
          result &&
          result.accounts_missing_password &&
          result.accounts_missing_password.length > 0
        ) {
          const missingAccount = result.accounts_missing_password[0];
          showModalAlert(
            `检测到 ${result.accounts_missing_password.length} 个账号缺少密码。\n请先为以下账号补全密码： ${missingAccount.username}`,
            "提示"
          );
          openMultiAddUserModalForPassword(
            missingAccount.username,
            missingAccount.tag
          );
        }
      }

      function openNewUserModal() {
        $("newUsername").value = "";
        $("newPassword").value = "";
        $("newPasswordConfirm").value = "";
        $("newUserPhone").value = "";
        $("newUserNickname").value = "";
        $("newUserSmsCode").value = "";
        $("newUserSmsGroup").style.display = "none";
        $("newUserModal").style.display = "flex";
        const phoneInput = $("newUserPhone");
        phoneInput.oninput = () => {
          const phone = phoneInput.value.trim();
          if (phone) {
            $("newUserSmsGroup").style.display = "block";
          } else {
            $("newUserSmsGroup").style.display = "none";
          }
        };
      }

      function closeNewUserModal() {
        $("newUserModal").style.display = "none";
      }
      $("newUserClose").onclick = closeNewUserModal;
      $("newUserCancel").onclick = closeNewUserModal;

      function openMultiAddUserModal() {
        $("multi-add-username").value = "";
        $("multi-add-password").value = "";
        $("multi-add-tag").value = "";
        $("multi-add-user-modal").style.display = "flex";
      }

      function closeMultiAddUserModal() {
        const usernameInput = $("multi-add-username");
        const passwordInput = $("multi-add-password");
        if (usernameInput) {
          usernameInput.readOnly = false;
          usernameInput.classList.remove("bg-slate-100", "cursor-not-allowed");
        }
        if (passwordInput) {
          passwordInput.placeholder = "请输入密码 (至少6字符)";
        }

        $("multi-add-user-modal").style.display = "none";
      }

      function openMultiAddUserModalForPassword(username, tag) {
        const usernameInput = $("multi-add-username");
        const tagInput = $("multi-add-tag");
        const passwordInput = $("multi-add-password");

        if (usernameInput) {
          usernameInput.value = username;
          usernameInput.readOnly = true;
          usernameInput.classList.add("bg-slate-100", "cursor-not-allowed");
        }
        if (tagInput) {
          tagInput.value = tag || "";
        }
        if (passwordInput) {
          passwordInput.value = "";
          passwordInput.placeholder = "该账号缺少密码，请补全";
        }
        $("multi-add-user-modal").style.display = "flex";
        if (passwordInput) {
          passwordInput.focus();
        }
      }
      $("newUserSendCode").onclick = async function () {
        const phone = $("newUserPhone").value.trim();
        if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
          showModalAlert("请输入正确的手机号");
          return;
        }

        const sendCodeBtn = $("newUserSendCode");
        sendCodeBtn.disabled = true;
        const originalText = sendCodeBtn.textContent;

        try {
          const response = await fetch("/api/sms/send_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              phone: phone,
              scene: "register",
            }),
          });
          const result = await response.json();

          if (result && result.success) {
            const expireMin = result.expire_minutes || 5;
            const retryAfter = result.retry_after || 180;
            showTempMessage(`验证码已发送，${expireMin}分钟内有效`, "success");

            let countdown = retryAfter;
            const timer = setInterval(() => {
              countdown--;
              sendCodeBtn.textContent = `${countdown}秒后重试`;
              if (countdown <= 0) {
                clearInterval(timer);
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = originalText;
              }
            }, 1000);
          } else {
            if (result?.retry_after) {
              let countdown = result.retry_after;
              sendCodeBtn.textContent = `${countdown}秒后重试`;
              const timer = setInterval(() => {
                countdown--;
                sendCodeBtn.textContent = `${countdown}秒后重试`;
                if (countdown <= 0) {
                  clearInterval(timer);
                  sendCodeBtn.disabled = false;
                  sendCodeBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              sendCodeBtn.disabled = false;
            }
            showModalAlert(result?.message || "发送失败");
          }
        } catch (error) {
          sendCodeBtn.disabled = false;
          showModalAlert("发送失败: " + error.message);
        }
      };

      async function multi_addFromConfig() {
        const user = $("multi-config-user-select").value;

        if (!user) {
          openMultiAddUserModal();
          return;
        }
        let passwordToUse = "";
        let uaToUse = "";
        if (sessionUUID && currentAuthUsername) {
          try {
            const response = await fetch(
              "/auth/admin/get_user_school_accounts",
              {
                method: "GET",
                headers: {
                  "X-Session-ID": sessionUUID,
                },
              }
            );

            if (response.ok) {
              const result = await response.json();

              if (result.success && result.accounts) {
                const accountData = result.accounts[user];

                if (accountData) {
                  if (typeof accountData === "string") {
                    passwordToUse = accountData;
                    logMessage_Info(
                      `[多账号-添加] 已从 school_accounts 加载用户 ${user} 的密码（旧格式）`
                    );
                  } else if (
                    typeof accountData === "object" &&
                    accountData !== null
                  ) {
                    passwordToUse = accountData.password || "";
                    uaToUse = accountData.ua || "";
                    logMessage_Info(
                      `[多账号-添加] 已从 school_accounts 加载用户 ${user} 的密码和UA`
                    );
                  }
                }
              }
            }
          } catch (error) {
            logMessage_Warning(
              `[多账号-添加] 无法加载 school_accounts: ${error.message}`
            );
          }
        }
        const result = await callPythonAPI(
          "multi_add_account",
          user,
          passwordToUse
        );
        if (
          result &&
          result.success === false &&
          result.action === "request_password"
        ) {
          showModalAlert(
            `账号 ${result.username} 缺少密码，请在弹窗中补全。`,
            "缺少密码"
          );
          openMultiAddUserModalForPassword(result.username, result.tag);
        } else if (result && result.accounts) {
          renderMultiAccountList(result.accounts);
        }
      }
      async function submitMultiAddUser() {
        const inputUsername = $("multi-add-username");
        const inputPassword = $("multi-add-password");
        const inputTag = $("multi-add-tag");

        const usernameVal = inputUsername.value.trim();
        const passwordVal = inputPassword.value;
        const tagVal = inputTag.value.trim();
        if (!usernameVal || !passwordVal) {
          showModalAlert("账号和密码均不能为空");
          return;
        }
        if (passwordVal.length < 6) {
          showModalAlert("密码长度至少为6个字符", "错误");
          return;
        }
        setButtonLoading("multi-add-user-confirm", true, "添加中...");
        try {
          const result = await callPythonAPI(
            "multi_add_account",
            usernameVal,
            passwordVal,
            tagVal
          );

          if (result && result.accounts) {
            showModalAlert("账号添加成功", "成功");
            closeMultiAddUserModal();
            renderMultiAccountList(result.accounts);
          } else {
            showModalAlert(result?.message || "添加失败");
          }
        } catch (e) {
          showModalAlert(`添加时发生错误: ${e.message}`);
          logMessage_Error("添加新账号时发生错误:", e);
        } finally {
          setButtonLoading("multi-add-user-confirm", false, "确认添加");
          if (inputUsername && inputUsername.readOnly) {
            inputUsername.readOnly = false;
            inputUsername.classList.remove(
              "bg-slate-100",
              "cursor-not-allowed"
            );
            $("multi-add-password").placeholder = "请输入密码 (至少6字符)";
          }
        }
      }

      async function multi_importFromExcel() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".xlsx, .xls, .csv";

        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) {
            logMessage_Info("未选择文件。");
            return;
          }

          const fileName = file.name;
          const fileExt = fileName.split(".").pop().toLowerCase();
          if (!["xlsx", "xls", "csv"].includes(fileExt)) {
            showModalAlert(
              "文件格式不支持，请选择 .xlsx, .xls, 或 .csv 文件。"
            );
            return;
          }

          logMessage_Info(`正在读取文件: ${fileName}`);
          const reader = new FileReader();
          reader.readAsDataURL(file);

          reader.onload = async () => {
            try {
              const base64Content = reader.result.split(",")[1];
              const result = await callPythonAPI(
                "multi_import_accounts",
                fileName,
                base64Content
              );

              if (result && result.success) {
                logMessage_Info(
                  `成功导入 ${result.imported_count || 0} 个账号。`
                );
                if (result.skipped_count > 0) {
                  showModalAlert(
                    `导入完成：\n成功 ${result.imported_count} 个。\n跳过 ${result.skipped_count} 个（缺少密码）。\n\n详情：${result.message}`,
                    "导入提示"
                  );
                }
                if (result.accounts) {
                  renderMultiAccountList(result.accounts);
                }
              } else {
                showModalAlert(`导入失败: ${result.message || "未知错误"}`);
              }
            } catch (err) {
              logMessage_Error("导入文件时出错:", err);
              showModalAlert(`导入失败: ${err.message}`);
            }
          };

          reader.onerror = () => {
            logMessage_Error("读取文件失败。");
            showModalAlert("读取文件失败。");
          };
        };
        input.click();
      }

      async function multi_exportToExcel() {
        const result = await callPythonAPI("multi_export_accounts_summary");
        if (!result || !result.success) {
          showModalAlert(result?.message || "导出失败");
          return;
        }
        if (result.content && result.filename) {
          const binaryString = atob(result.content);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const blob = new Blob([bytes], {
            type: result.mimetype || "application/octet-stream",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = result.filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          logMessage_Info(`汇总已导出：${result.filename}`);
        }
      }
      async function multi_startAll() {
        const count = parseInt($("multi-account-count").textContent || "0", 10);
        if (!count || count <= 0) {
          showModalAlert("账号列表为空，无法开始。请先添加账号。");

          return;
        }
        const use_delay = $("multi-use-delay-check").checked;
        const min_delay = parseInt($("multi-min-delay-input").value) || 0;
        const max_delay = parseInt($("multi-max-delay-input").value) || 300;
        const run_only_incomplete = $(
          "multi-run-only-incomplete-check"
        ).checked;

        const result = await callPythonAPI(
          "multi_start_all_accounts",
          min_delay,
          max_delay,
          use_delay,
          run_only_incomplete
        );
        if (!result || !result.success) {
          showModalAlert(result?.message || "无法开始全部账号任务。");

          return;
        }
      }

      async function multi_stopAll() {
        await callPythonAPI("multi_stop_all_accounts");
      }

      function onAccountsUpdated(accounts) {
        try {
          renderMultiAccountList(accounts);
        } catch (e) {
          logMessage_Error("onAccountsUpdated render failed:", e);
        }
      }

      function calculateStatusText(
        account,
        onlyIncomplete = false,
        ignoreTaskTime = false
      ) {
        if (!account || !account.tasks || !Array.isArray(account.tasks)) {
          return "无任务数据";
        }

        let executableCount = 0;
        const now = new Date();
        const today = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate()
        );

        account.tasks.forEach((task) => {
          if (onlyIncomplete && task.status == 1) {
            return;
          }
          let isExpired = false;
          let isNotStarted = false;

          const startTimeStr = task.start_time
            ? task.start_time.replace(/-/g, "/")
            : null;
          const endTimeStr = task.end_time
            ? task.end_time.replace(/-/g, "/")
            : null;

          const startTime = startTimeStr ? new Date(startTimeStr) : null;
          const endTime = endTimeStr ? new Date(endTimeStr) : null;

          if (ignoreTaskTime) {
            if (startTime) {
              const startDate = new Date(
                startTime.getFullYear(),
                startTime.getMonth(),
                startTime.getDate()
              );
              if (today < startDate) isNotStarted = true;
            }
            if (endTime) {
              const endDate = new Date(
                endTime.getFullYear(),
                endTime.getMonth(),
                endTime.getDate()
              );
              if (today > endDate) isExpired = true;
            }
          } else {
            if (startTime && now < startTime) isNotStarted = true;
            if (endTime && now > endTime) isExpired = true;
          }

          if (isNotStarted || isExpired) {
            return;
          }

          executableCount++;
        });

        if (executableCount === 0) {
          return "无任务可执行";
        } else {
          return `有 ${executableCount} 个任务可执行`;
        }
      }
      function updateAllAccountsStatusText() {
        try {
          if (
            !cachedMultiAccounts ||
            !Array.isArray(cachedMultiAccounts) ||
            cachedMultiAccounts.length === 0
          ) {
            return;
          }
          let onlyIncomplete = true;
          const mbChk = document.getElementById(
            "mobile-multi-only-incomplete-check"
          );
          const pcChk = document.getElementById(
            "multi-run-only-incomplete-check"
          );
          if (typeof isMobileMode !== "undefined" && isMobileMode && mbChk) {
            onlyIncomplete = mbChk.checked;
            if (pcChk) pcChk.checked = onlyIncomplete;
          } else if (pcChk) {
            onlyIncomplete = pcChk.checked;
            if (mbChk) mbChk.checked = onlyIncomplete;
          }
          let ignoreTaskTime = true;
          if (typeof pythonParams !== "undefined") {
            if (pythonParams.hasOwnProperty("ignore_task_time")) {
              ignoreTaskTime = !!pythonParams.ignore_task_time;
            }
          }
          let updatedCount = 0;
          cachedMultiAccounts.forEach((account) => {
            const newStatusText = calculateStatusText(
              account,
              onlyIncomplete,
              ignoreTaskTime
            );
            account.status_text = newStatusText;
            const pcItem = document.getElementById(
              `multi-acc-${account.username}`
            );
            if (pcItem) {
              const statusEl = pcItem.querySelector(".status-text");
              if (statusEl) {
                statusEl.textContent = newStatusText;
                if (newStatusText.includes("无任务")) {
                  statusEl.className =
                    "status-text font-semibold text-slate-500 text-xs px-2 py-0.5 rounded-full bg-slate-100 flex-shrink-0 whitespace-nowrap";
                } else if (newStatusText.includes("有")) {
                  statusEl.className =
                    "status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap";
                }
                updatedCount++;
              }
            }
            const mobileItem = document.getElementById(
              `mobile-multi-acc-${account.username}`
            );
            if (mobileItem) {
              const statusEl = mobileItem.querySelector(".status-text");
              if (statusEl) {
                statusEl.textContent = newStatusText;
                if (newStatusText.includes("无任务")) {
                  statusEl.className =
                    "status-text font-semibold text-slate-500 text-xs px-2 py-0.5 rounded-full bg-slate-100 flex-shrink-0 whitespace-nowrap";
                } else if (newStatusText.includes("有")) {
                  statusEl.className =
                    "status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap";
                }
                updatedCount++;
              }
            }
          });
          console.log(
            `[状态刷新] 根据本地缓存已更新 ${updatedCount} 个账号状态 (OnlyIncomplete: ${onlyIncomplete}, IgnoreTime: ${ignoreTaskTime})`
          );
        } catch (error) {
          console.error("[更新账号状态] 更新状态文本时发生错误:", error);
        }
      }
      function renderMultiAccountList(accounts) {
        cachedMultiAccounts = accounts;
        const renderToContainer = (containerId, isMobile) => {
          const listDiv = document.getElementById(containerId);
          if (!listDiv) return;

          listDiv.innerHTML = "";
          const countId = isMobile
            ? "mobile-multi-account-count"
            : "multi-account-count";
          const countEl = document.getElementById(countId);
          if (countEl)
            countEl.textContent = isMobile
              ? `${accounts.length} 个账号`
              : accounts.length;

          if (accounts.length === 0) {
            listDiv.innerHTML =
              '<p class="text-slate-400 text-center py-10">请先添加或导入账号</p>';
            return;
          }

          accounts.forEach((acc) => {
            const s = acc.summary;
            const item = document.createElement("div");
            const prefix = isMobile ? "mobile-multi-acc-" : "multi-acc-";
            item.id = `${prefix}${acc.username}`;
            item.dataset.username = acc.username;
            item.className =
              "p-3 rounded-xl border border-slate-200 bg-white/80 mb-2 text-sm";
            item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-slate-800 flex items-start gap-2 truncate min-w-0">
                            <input type="checkbox" class="account-checkbox w-4 h-4 accent-sky-600 rounded flex-shrink-0 mt-1">
                            <div class="truncate">
                                <span class="account-name truncate">${
                                  acc.name
                                }</span>
                                <span class="text-xs text-slate-500 font-normal block">(${
                                  acc.username
                                })</span>
                                ${
                                  acc.tag
                                    ? `<span class="text-xs text-purple-600 font-medium block">🏷️ ${acc.tag}</span>`
                                    : ""
                                }
                            </div>
                        </div>
                        <span class="status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap">${
                          acc.status_text
                        }</span>
                    </div>

                    <div class="grid grid-cols-5 gap-2 text-center text-xs mt-2 pt-2 border-t text-slate-600">
                        <div>总数: <span class="summary-total font-bold">${
                          s.total
                        }</span></div>
                        <div>完成: <span class="summary-completed font-bold text-emerald-600">${
                          s.completed
                        }</span></div>
                        <div>未开始: <span class="summary-notstarted font-bold text-slate-600">${
                          s.not_started
                        }</span></div>
                        <div>可跑: <span class="summary-executable font-bold text-amber-600">${
                          s.executable
                        }</span></div>
                        <div>过期: <span class="summary-expired font-bold text-red-600">${
                          s.expired
                        }</span></div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center text-xs mt-2 pt-2 border-t border-slate-100 text-slate-600">
                        <div title="待签到任务">待签: <span class="summary-att-pending font-bold text-sky-600">${
                          s.att_pending || 0
                        }</span></div>
                        <div title="已签到任务">已签: <span class="summary-att-completed font-bold text-emerald-600">${
                          s.att_completed || 0
                        }</span></div>
                        <div title="已过期签到">过期: <span class="summary-att-expired font-bold text-red-600">${
                          s.att_expired || 0
                        }</span></div>
                    </div>

                    <div class="flex justify-end items-center gap-2 mt-2 pt-2 border-t">
                        <button class="btn-account-refresh btn btn-ghost !py-1 !px-3 !text-xs" data-username="${
                          acc.username
                        }">刷新</button>
                        <button class="btn-account-start btn btn-success !py-1 !px-3 !text-xs" data-username="${
                          acc.username
                        }">开始</button>
                        <button class="btn-account-stop btn btn-warning !py-1 !px-3 !text-xs" data-username="${
                          acc.username
                        }">停止</button>
                        <button class="btn-account-params btn btn-ghost !py-1 !px-3 !text-xs" data-username="${
                          acc.username
                        }" style="display:none">设置</button>
                    </div>
                    <div class="mt-2">
                        <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="progress-fill h-2 bg-sky-500" style="width:0%"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="progress-text text-slate-600">未开始</span>
                            <span class="progress-extra text-slate-400"></span>
                        </div>
                    </div>
                `;
            listDiv.appendChild(item);
          });

          listDiv.querySelectorAll(".btn-account-start").forEach(
            (b) =>
              (b.onclick = (e) => {
                const checkboxId = isMobile
                  ? "mobile-multi-only-incomplete-check"
                  : "multi-run-only-incomplete-check";
                const runOnly =
                  document.getElementById(checkboxId)?.checked ?? true;
                callPythonAPI(
                  "multi_start_single_account",
                  e.target.dataset.username,
                  runOnly
                );
              })
          );

          listDiv
            .querySelectorAll(".btn-account-stop")
            .forEach(
              (b) =>
                (b.onclick = (e) =>
                  callPythonAPI(
                    "multi_stop_single_account",
                    e.target.dataset.username
                  ))
            );

          listDiv.querySelectorAll(".btn-account-refresh").forEach((b) => {
            b.onclick = async (e) => {
              const u = e.currentTarget.dataset.username;
              const itemPrefix = isMobile ? "mobile-multi-acc-" : "multi-acc-";
              const item = document.getElementById(`${itemPrefix}${u}`);
              if (item) {
                const statusEl = item.querySelector(".status-text");
                if (statusEl) statusEl.textContent = "刷新中...";
              }
              const result = await callPythonAPI(
                "multi_refresh_single_status",
                u
              );
              if (!result || !result.success) {
                showModalAlert(result?.message || "刷新失败");
              }
            };
          });

          listDiv.querySelectorAll(".btn-account-params").forEach((b) => {
            b.onclick = (e) => {
              if (isMobile) {
                openMobileAccountParams(e.target.dataset.username);
              } else {
                openAccountParamsModal(e.target.dataset.username);
              }
            };
          });
        };

        renderToContainer("multi-account-list", false);

        renderToContainer("mobile-multi-account-list", true);

        if (typeof updateSelectAllCheckboxState === "function")
          updateSelectAllCheckboxState();
        if (typeof updateMobileSelectAllCheckboxState === "function")
          updateMobileSelectAllCheckboxState();
      }

      function multi_toggleSelectAll(event) {
        const isChecked = event.target.checked;
        const container = document.getElementById("multi-account-list");
        if (container) {
          container
            .querySelectorAll(".account-checkbox")
            .forEach((cb) => (cb.checked = isChecked));
        }
      }

      function updateSelectAllCheckboxState() {
        const container = document.getElementById("multi-account-list");
        if (!container) return;

        const allCheckboxes = container.querySelectorAll(".account-checkbox");
        const checkedCount = container.querySelectorAll(
          ".account-checkbox:checked"
        ).length;
        const selectAllCheckbox = $("multi-select-all-check");
        if (allCheckboxes.length > 0) {
          selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
          selectAllCheckbox.indeterminate =
            checkedCount > 0 && checkedCount < allCheckboxes.length;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
      }

      $("multi-account-list").addEventListener("change", (event) => {
        if (event.target.classList.contains("account-checkbox")) {
          updateSelectAllCheckboxState();
        }
      });

      async function multi_removeAll(confirm = false) {
        if (
          confirm &&
          typeof confirm === "object" &&
          confirm.type === "click"
        ) {
          confirm = false;
        }
        let isConfirmed = false;

        if (!confirm) {
          logMessage_Info("准备移除列表中的所有账号");
          isConfirmed = await jsShowConfirm(
            "确认移除全部",
            "确定要移除列表中的<span style='color:red;font-weight:bold;'>所有账号</span>吗？<br>此操作<span style='color:red;'>不可撤销</span>，所有账号数据将丢失！"
          );
        } else {
          logMessage_Info("移除列表中的所有账号");
          isConfirmed = true;
        }
        if (isConfirmed) {
          const result = await callPythonAPI("multi_remove_all_accounts");
          if (result && result.accounts)
            renderMultiAccountList(result.accounts);
        }
      }

      async function multi_removeSelected(confirm = false) {
        if (
          confirm &&
          typeof confirm === "object" &&
          confirm.type === "click"
        ) {
          confirm = false;
        }
        const container = document.getElementById("multi-account-list");
        if (!container) return;

        const selectedUsernames = Array.from(
          container.querySelectorAll(".account-checkbox:checked")
        ).map((cb) => cb.closest("[data-username]").dataset.username);
        if (selectedUsernames.length === 0) {
          showModalAlert("请至少选择一个要移除的账号。", "提示");
          return;
        }
        let isConfirmed = false;

        if (!confirm) {
          logMessage_Info(
            `准备移除选中的账号: ${selectedUsernames.join(", ")}`
          );
          isConfirmed = await jsShowConfirm(
            "确认移除选中",
            `确定要移除选中的 <span style='color:red;font-weight:bold;'>${
              selectedUsernames.length
            }</span> 个账号吗？<br>账号: ${selectedUsernames.join(", ")}`
          );
        } else {
          logMessage_Info(`移除选中的账号: ${selectedUsernames.join(", ")}`);
          isConfirmed = true;
        }
        if (isConfirmed) {
          const result = await callPythonAPI(
            "multi_remove_selected_accounts",
            selectedUsernames
          );
          if (result && result.accounts)
            renderMultiAccountList(result.accounts);
        }
      }

      function multi_getSelectedUsernames() {
        const container = document.getElementById("multi-account-list");
        if (!container) return [];

        return Array.from(
          container.querySelectorAll(".account-checkbox:checked")
        )
          .map((cb) => cb.closest("[data-username]")?.dataset?.username)
          .filter(Boolean);
      }

      async function multi_startSelected() {
        const usernames = multi_getSelectedUsernames();
        if (usernames.length === 0) {
          showModalAlert("请至少选择一个账号再执行“开始选中”。");
          return;
        }
        const use_delay = $("multi-use-delay-check")?.checked ?? true;
        const min_delay = parseInt($("multi-min-delay-input")?.value) || 0;
        const max_delay = parseInt($("multi-max-delay-input")?.value) || 300;
        const run_only_incomplete =
          $("multi-run-only-incomplete-check")?.checked ?? true;
        for (const u of usernames) {
          try {
            if (use_delay && max_delay >= min_delay) {
              const d = Math.random() * (max_delay - min_delay) + min_delay;
              await new Promise((res) => setTimeout(res, d * 10));
            }
            await callPythonAPI(
              "multi_start_single_account",
              u,
              run_only_incomplete
            );
          } catch (e) {
            logMessage_Error(`开始账号 ${u} 失败`, e);
          }
        }
      }

      async function multi_stopSelected() {
        const usernames = multi_getSelectedUsernames();
        if (usernames.length === 0) {
          showModalAlert("请至少选择一个账号再执行“停止选中”。");
          return;
        }
        for (const u of usernames) {
          try {
            await callPythonAPI("multi_stop_single_account", u);
          } catch (e) {
            logMessage_Error(`停止账号 ${u} 失败`, e);
          }
        }
      }

      async function multi_refreshSelected() {
        const usernames = multi_getSelectedUsernames();
        if (usernames.length === 0) {
          showModalAlert("请至少选择一个账号再执行“刷新选中”。");
          return;
        }
        for (const u of usernames) {
          try {
            const item = document.getElementById(`multi-acc-${u}`);
            if (item) {
              const statusEl = item.querySelector(".status-text");
              if (statusEl) statusEl.textContent = "刷新中...";
            }
            await callPythonAPI("multi_refresh_single_status", u);
          } catch (e) {
            logMessage_Error(`刷新账号 ${u} 失败`, e);
          }
        }
      }

      async function multi_refreshAll() {
        await callPythonAPI("multi_refresh_all_statuses");
      }

      let lastAccountListSignature = "";
      function startMultiAccountAutoRefresh(interval = 500) {
        if (multiAccountAutoRefreshInterval) {
          clearInterval(multiAccountAutoRefreshInterval);
          multiAccountAutoRefreshInterval = null;
        }
        multiAccountAutoRefreshInterval = setInterval(async () => {
          if (
            typeof isInNetworkErrorState !== "undefined" &&
            isInNetworkErrorState
          ) {
            return;
          }

          try {
            const pcMultiApp = document.getElementById("multi-account-app");
            const mobileMultiApp = document.getElementById(
              "mobile-multi-account-app"
            );
            const isVisible =
              (pcMultiApp && !pcMultiApp.classList.contains("hidden")) ||
              (mobileMultiApp && !mobileMultiApp.classList.contains("hidden"));

            if (!isVisible) {
              return;
            }

            const response = await callPythonAPI(
              "multi_get_all_accounts_status"
            );

            if (response && response.success && response.accounts) {
              const currentSignature = response.accounts
                .map((a) => a.username)
                .join("|");
              if (currentSignature !== lastAccountListSignature) {
                console.log("[多账号刷新] 账号列表结构变化，重绘 DOM");
                renderMultiAccountList(response.accounts);
                lastAccountListSignature = currentSignature;
              }
              response.accounts.forEach((acc) => {
                if (!acc.username) return;

                const updateData = {
                  status_text: acc.status_text,
                  name: acc.name,
                  summary: acc.summary,
                  progress_pct: acc.progress_pct,
                  progress_text: acc.progress_text,
                  progress_extra: acc.progress_extra,
                };
                multi_updateAccountStatus(acc.username, updateData);

                if (
                  acc.current_position &&
                  typeof acc.current_position.lon === "number" &&
                  typeof acc.current_position.lat === "number"
                ) {
                  multi_updateRunnerPosition(
                    acc.username,
                    acc.current_position.lon,
                    acc.current_position.lat,
                    acc.name || acc.username
                  );
                }
              });
            }
          } catch (error) {
            console.error("[多账号自动刷新] 轮询请求失败:", error);
            // 修正：检测到会话过期错误时，立即停止轮询，防止无限 401 循环
            if (error.message && (error.message.includes("会话已过期") || error.message.includes("无效") || error.message.includes("401"))) {
                console.warn("[多账号自动刷新] 检测到会话失效，自动停止轮询。");
                stopMultiAccountAutoRefresh();
            }
          }
        }, interval);

        console.log(`[多账号自动刷新] 已启动高频轮询 (间隔: ${interval}ms)`);
      }
      function stopMultiAccountAutoRefresh() {
        if (multiAccountAutoRefreshInterval) {
          clearInterval(multiAccountAutoRefreshInterval);
          multiAccountAutoRefreshInterval = null;
          console.log("[多账号自动刷新] 已停止定时自动刷新");
        }
      }

      async function process_path_queue() {
        if (is_planning_path || path_planning_queue.length === 0) return;
        is_planning_path = true;
        const { username, waypoints } = path_planning_queue.shift();
        try {
          logMessage_Info(`[JS-Queue] 开始处理 ${username} 的路径规划...`);
          const path = await getWalkingPath(waypoints);
          logMessage_Info(
            `[JS-Queue] 路径规划成功 for ${username}, 返回 ${path.length} 点给Python。`
          );
          callPythonAPI("multi_path_generation_callback", username, true, path);
        } catch (error) {
          logMessage_Info(`[JS-Queue] 路径规划失败 for ${username}: ${error}`);
          callPythonAPI(
            "multi_path_generation_callback",
            username,
            false,
            String(error)
          );
        } finally {
          is_planning_path = false;
          setTimeout(process_path_queue, 100);
        }
      }
      function triggerPathGenerationForPy(username, waypoints) {
        logMessage_Info(`收到 ${username} 的路径规划请求，已加入队列。`);
        path_planning_queue.push({ username, waypoints });
        process_path_queue();
      }

      function updateMobileSelectAllCheckboxState() {
        const container = document.getElementById("mobile-multi-account-list");
        if (!container) return;

        const allCheckboxes = container.querySelectorAll(".account-checkbox");
        const checkedCount = container.querySelectorAll(
          ".account-checkbox:checked"
        ).length;
        const selectAllCheckbox = document.getElementById(
          "mobile-select-all-accounts"
        );

        if (selectAllCheckbox) {
          if (allCheckboxes.length > 0) {
            selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
            selectAllCheckbox.indeterminate =
              checkedCount > 0 && checkedCount < allCheckboxes.length;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          }
        }
      }

      const mobileListDiv = document.getElementById(
        "mobile-multi-account-list"
      );
      if (mobileListDiv) {
        mobileListDiv.addEventListener("change", (event) => {
          if (event.target.classList.contains("account-checkbox")) {
            updateMobileSelectAllCheckboxState();
          }
        });
      }

      function multi_updateAccountStatus(username, data) {
        const ids = [`multi-acc-${username}`, `mobile-multi-acc-${username}`];

        ids.forEach((id) => {
          const item = document.getElementById(id);
          if (!item) return;

          if (data.status_text) {
            const statusEl = item.querySelector(".status-text");
            if (statusEl) statusEl.textContent = data.status_text;
          }
          if (data.name) {
            const nameEl = item.querySelector(".account-name");
            if (nameEl) nameEl.textContent = data.name;
          }

          if (data.summary) {
            const s = data.summary;
            const setVal = (sel, val) => {
              const el = item.querySelector(sel);
              if (el) el.textContent = val;
            };

            setVal(".summary-total", s.total);
            setVal(".summary-completed", s.completed);
            setVal(".summary-notstarted", s.not_started ?? 0);
            setVal(".summary-executable", s.executable);
            setVal(".summary-expired", s.expired);

            setVal(".summary-att-pending", s.att_pending || 0);
            setVal(".summary-att-completed", s.att_completed || 0);
            setVal(".summary-att-expired", s.att_expired || 0);
          }

          if (typeof data.progress_pct === "number") {
            const fill = item.querySelector(".progress-fill");
            if (fill)
              fill.style.width = `${Math.max(
                0,
                Math.min(100, data.progress_pct)
              )}%`;
          }
          if (typeof data.progress_text === "string") {
            const label = item.querySelector(".progress-text");
            if (label) label.textContent = data.progress_text;
          }
          if (typeof data.progress_extra === "string") {
            const extra = item.querySelector(".progress-extra");
            if (extra) extra.textContent = data.progress_extra;
          }
        });

        const currentStatus =
          typeof data.status_text === "string" && data.status_text.trim()
            ? data.status_text.trim()
            : "";
        const NON_RUNNING_STATUSES = new Set([
          "任务已完成",
          "全部完成",
          "无任务可执行",
          "无可执行任务",
          "已停止",
          "已中止",
          "待命",
        ]);

        if (NON_RUNNING_STATUSES.has(currentStatus)) {
          if (typeof multi_removeRunnerMarker === "function")
            multi_removeRunnerMarker(username);
          return;
        }

        const s = data.summary;
        if (s && typeof s.executable === "number" && s.executable <= 0) {
          const maybeRunning = [
            "登录中...",
            "分析任务",
            "运行",
            "等待",
            "排队登录...",
            "延迟",
          ];
          const isLikelyRunning = maybeRunning.some((k) =>
            currentStatus.includes(k)
          );
          if (!isLikelyRunning) {
            if (typeof multi_removeRunnerMarker === "function")
              multi_removeRunnerMarker(username);
          }
        }
      }

      function multi_updateRunnerPosition(username, lon, lat, name) {
        if (!multiAccountMap) return;
        const pos = new AMapInstance.LngLat(lon, lat);
        if (multiAccountMarkers[username]) {
          multiAccountMarkers[username].setPosition(pos);
        } else {
          const color = userColors[colorIndex++ % userColors.length];
          const markerContent = `<div style="background-color: ${color};" class="text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg text-white">${name}</div>`;
          multiAccountMarkers[username] = new AMapInstance.Marker({
            position: pos,
            content: markerContent,
            anchor: "bottom-center",
            zIndex: 110,
            title: `${name} (${username})`,
          });
          multiAccountMap.add(multiAccountMarkers[username]);
        }
      }

      function multi_removeRunnerMarker(username) {
        const marker = multiAccountMarkers[username];
        if (marker && multiAccountMap) {
          multiAccountMap.remove(marker);
        }
        delete multiAccountMarkers[username];
      }

      function multi_resetMapView() {
        if (!multiAccountMap) return;
        const overlays = Object.values(multiAccountMarkers).filter((m) =>
          m.getMap()
        );
        if (overlays.length > 0) {
          multiAccountMap.setFitView(overlays, false, [80, 80, 80, 80]);
        } else {
          multiAccountMap.setZoomAndCenter(17, [113.390342, 22.527403]);
        }
      }

      function selectTaskFromBackend(index) {
        if (selectedTaskIndex !== index) selectTask(index);
      }

      function updateDashboard() {
        if (!currentRunData || Object.keys(currentRunData).length === 0) {
          $("run-stats-label").textContent = `-- km / --:--`;
          $("live-dist-label").textContent = "0.00 km";
          $("total-dist-label").textContent = "0.00 km";
          $("live-time-label").textContent = "00:00";
          $("total-time-label").textContent = "00:00";
          $("target-points-text").innerHTML =
            '<p class="text-slate-400 text-center text-xs pt-4">请选择一个任务</p>';
          $("current-location-label").textContent = "当前位置GPS坐标: --, --";
          return;
        }
        const isDrawingNow = isDrawing && !currentRunData.run_coords?.length;
        if (isDrawingNow && draftTotalDist > 0) {
          const drawKm = (draftTotalDist / 1000).toFixed(2);
          const avgSpeed = pythonParams.speed_mps || 1.5;
          const estMin = avgSpeed > 0 ? draftTotalDist / avgSpeed / 60 : 0;
          $(
            "run-stats-block"
          ).innerHTML = `<p class="text-sm text-slate-500">当前绘制</p><p class="font-bold text-2xl text-emerald-600">${drawKm} km / ~${estMin.toFixed(
            1
          )} min</p>`;
        } else {
          const dist = (
            (currentRunData.total_run_distance_m || 0) / 1000
          ).toFixed(2);
          const timeMin = Math.floor(
            (currentRunData.total_run_time_s || 0) / 60
          );
          const timeSec = Math.floor(
            (currentRunData.total_run_time_s || 0) % 60
          );
          $(
            "run-stats-block"
          ).innerHTML = `<p class="text-sm text-slate-500">已选任务总览</p><p id="run-stats-label" class="font-bold text-2xl text-sky-600">${dist} km / ${String(
            timeMin
          ).padStart(2, "0")}:${String(timeSec).padStart(2, "0")}</p>`;
        }
        const liveKm = (
          (currentRunData.distance_covered_m || 0) / 1000
        ).toFixed(2);
        const liveMs = runAccumulatedMs || 0;
        const mm = String(Math.floor(liveMs / 60000)).padStart(2, "0");
        const ss = String(Math.floor((liveMs % 60000) / 1000)).padStart(2, "0");
        $("live-dist-label").textContent = `${liveKm} km`;
        $("live-time-label").textContent = `${mm}:${ss}`;

        const totalDistKm = (
          (currentRunData.total_run_distance_m || 0) / 1000
        ).toFixed(2);
        $("total-dist-label").textContent = `${totalDistKm} km`;
        const totalTimeMin = Math.floor(
          (currentRunData.total_run_time_s || 0) / 60
        );
        const totalTimeSec = Math.floor(
          (currentRunData.total_run_time_s || 0) % 60
        );
        $("total-time-label").textContent = `${String(totalTimeMin).padStart(
          2,
          "0"
        )}:${String(totalTimeSec).padStart(2, "0")}`;

        const targetDiv = $("target-points-text");
        targetDiv.innerHTML = "";
        const names = (currentRunData.target_point_names || "").split("|");
        const sequence = currentRunData.target_sequence || 0;
        if (names.length === 0 || (names.length === 1 && names[0] === "")) {
          targetDiv.innerHTML =
            '<p class="text-slate-400 text-center text-xs pt-4">此任务无打卡点</p>';
        } else {
          names.forEach((name, i) => {
            if (!name) return;
            const p = document.createElement("p");
            let textClass = "text-slate-500";
            if (sequence > 0) {
              if (i + 1 < sequence) textClass = "text-slate-400 line-through";
              else if (i + 1 === sequence) textClass = "font-bold text-sky-600";
            }
            p.className = `transition-colors p-1 rounded ${textClass}`;
            p.innerHTML = `<span class="font-mono w-6 inline-block">${
              i + 1
            }.</span>${name}`;
            targetDiv.appendChild(p);
          });
          centerTargetList(sequence);
        }
        const mobileRunStatsLabel = document.getElementById(
          "mobile-run-stats-label"
        );
        if (mobileRunStatsLabel) {
          if (isDrawingNow && draftTotalDist > 0) {
            const drawKm = (draftTotalDist / 1000).toFixed(2);
            const avgSpeed = pythonParams.speed_mps || 1.5;
            const estMin = avgSpeed > 0 ? draftTotalDist / avgSpeed / 60 : 0;
            mobileRunStatsLabel.textContent = `${drawKm} km / ~${estMin.toFixed(
              1
            )} min`;
          } else {
            const dist = (
              (currentRunData.total_run_distance_m || 0) / 1000
            ).toFixed(2);
            const timeMin = Math.floor(
              (currentRunData.total_run_time_s || 0) / 60
            );
            const timeSec = Math.floor(
              (currentRunData.total_run_time_s || 0) % 60
            );
            mobileRunStatsLabel.textContent = `${dist} km / ${String(
              timeMin
            ).padStart(2, "0")}:${String(timeSec).padStart(2, "0")}`;
          }
        }
        const mobileLiveDistLabel = document.getElementById(
          "mobile-live-dist-label"
        );
        const mobileLiveTimeLabel = document.getElementById(
          "mobile-live-time-label"
        );
        const mobileTotalDistLabel = document.getElementById(
          "mobile-total-dist-label"
        );
        const mobileTotalTimeLabel = document.getElementById(
          "mobile-total-time-label"
        );
        const mobileCurrentLocationLabel = document.getElementById(
          "mobile-current-location-label"
        );

        if (mobileLiveDistLabel) {
          mobileLiveDistLabel.textContent = `${liveKm} km`;
        }
        if (mobileLiveTimeLabel) {
          mobileLiveTimeLabel.textContent = `${mm}:${ss}`;
        }
        if (mobileTotalDistLabel) {
          mobileTotalDistLabel.textContent = `${totalDistKm} km`;
        }
        if (mobileTotalTimeLabel) {
          const totalTimeMin = Math.floor(
            (currentRunData.total_run_time_s || 0) / 60
          );
          const totalTimeSec = Math.floor(
            (currentRunData.total_run_time_s || 0) % 60
          );
          mobileTotalTimeLabel.textContent = `${String(totalTimeMin).padStart(
            2,
            "0"
          )}:${String(totalTimeSec).padStart(2, "0")}`;
        }
        if (mobileCurrentLocationLabel && currentRunData) {
          const currentLocationLabel = document.getElementById(
            "current-location-label"
          );
          if (currentLocationLabel) {
            const coordsText = currentLocationLabel.textContent.replace(
              "当前位置GPS坐标: ",
              ""
            );
            mobileCurrentLocationLabel.textContent = `当前位置: ${coordsText}`;
          }
        }
        renderMobileCheckpointsList();
      }
      function centerTargetList(sequence) {
        const targetDiv = $("target-points-text");
        if (
          !targetDiv ||
          !targetDiv.children ||
          targetDiv.children.length === 0
        )
          return;
        const idx = Math.max(
          0,
          Math.min(targetDiv.children.length - 1, (sequence || 1) - 1)
        );
        const child = targetDiv.children[idx];
        if (child && typeof child.scrollIntoView === "function") {
          try {
            child.scrollIntoView({ behavior: "smooth", block: "nearest" });
          } catch (_) {}
        }
      }
      function resetMapView() {
        if (!map) return;
        const overlays = [...polylines.recommended, ...markers];
        if (polylines.draft) overlays.push(polylines.draft);
        if (polylines.run) overlays.push(polylines.run);
        if (polylines.history) overlays.push(polylines.history);

        if (overlays.length > 0) {
          map.setFitView(overlays, false, [60, 60, 60, 60]);
        } else if (currentRunData && currentRunData.target_points?.length > 0) {
          const targetLngLats = currentRunData.target_points.map(
            (p) => new AMapInstance.LngLat(p[0], p[1])
          );
          map.setFitView(targetLngLats, false, [60, 60, 60, 60]);
        } else {
          map.setZoomAndCenter(17, [113.390342, 22.527403]);
        }
      }

      function forceProjectionRefresh() {
        if (!map) return;
        try {
          map.setStatus({ dragEnable: false });
          map.resize();
          requestAnimationFrame(() => {
            const overlays = [...polylines.recommended];
            if (polylines.draft) overlays.push(polylines.draft);
            if (polylines.run) overlays.push(polylines.run);
            if (polylines.history) overlays.push(polylines.history);
            if (overlays.length > 0) {
              map.setFitView(overlays, false, [60, 60, 60, 60]);
            } else if (
              currentRunData &&
              Array.isArray(currentRunData.target_points) &&
              currentRunData.target_points.length > 0
            ) {
              const pts = currentRunData.target_points.map(
                (p) => new AMapInstance.LngLat(p[0], p[1])
              );
              map.setFitView(pts, false, [60, 60, 60, 60]);
            } else {
              map.setZoomAndCenter(17, [113.390342, 22.527403]);
            }
            map.setStatus({ dragEnable: true });
          });
        } catch (e) {
          logMessage_Warning("forceProjectionRefresh warning:", e);
        }
      }
      function forceProjectionRefresh() {
        if (!map) return;
        try {
          map.setStatus({ dragEnable: false });
          map.resize();
          requestAnimationFrame(() => {
            const overlays = [...polylines.recommended];
            if (polylines.draft) overlays.push(polylines.draft);
            if (polylines.run) overlays.push(polylines.run);
            if (polylines.history) overlays.push(polylines.history);
            if (overlays.length > 0) {
              map.setFitView(overlays, false, [60, 60, 60, 60]);
            } else if (
              currentRunData &&
              Array.isArray(currentRunData.target_points) &&
              currentRunData.target_points.length > 0
            ) {
              const pts = currentRunData.target_points.map(
                (p) => new AMapInstance.LngLat(p[0], p[1])
              );
              map.setFitView(pts, false, [60, 60, 60, 60]);
            } else {
              map.setZoomAndCenter(17, [113.390342, 22.527403]);
            }
            map.setStatus({ dragEnable: true });
          });
        } catch (e) {
          logMessage_Warning("forceProjectionRefresh warning:", e);
        }
      }
      function drawOnMap_signature() {
        if (!map) return;
        clearMapOverlays();
        const data = currentRunData;
        if (!data) return;

        if (data.recommended_coords?.length > 0) {
          let segment = [];
          data.recommended_coords.forEach((p) => {
            if (p[0] === 0 && p[1] === 0) {
              if (segment.length > 1)
                polylines.recommended.push(
                  new AMapInstance.Polyline({
                    path: segment,
                    strokeColor: "#10b981",
                    strokeWeight: 5,
                    lineCap: "round",
                    strokeOpacity: 0.6,
                    zIndex: 40,
                  })
                );
              segment = [];
            } else {
              segment.push(new AMapInstance.LngLat(p[0], p[1]));
            }
          });
          if (segment.length > 1)
            polylines.recommended.push(
              new AMapInstance.Polyline({
                path: segment,
                strokeColor: "#10b981",
                strokeWeight: 5,
                lineCap: "round",
                strokeOpacity: 0.6,
                zIndex: 40,
              })
            );
          map.add(polylines.recommended);
        }
        if (data.draft_coords?.length > 0) {
          polylines.draft = new AMapInstance.Polyline({
            path: data.draft_coords.map(
              (p) => new AMapInstance.LngLat(p[0], p[1])
            ),
            strokeColor: "#1f2937",
            strokeWeight: 6,
            zIndex: 45,
          });
          map.add(polylines.draft);
        }
        if (data.run_coords?.length > 0) {
          polylines.run = new AMapInstance.Polyline({
            path: data.run_coords.map(
              (p) => new AMapInstance.LngLat(p[0], p[1])
            ),
            strokeColor: "#ef4444",
            strokeWeight: 5,
            strokeStyle: "dashed",
            zIndex: 50,
          });
          map.add(polylines.run);
        }
        drawMarkers();
        resetMapView();
      }

      function drawOnMap() {
        drawOnMap_signature();
        setTimeout(() => {
          logMessage_Info("执行二次渲染以修正初始位移...", "DEBUG");
          drawOnMap_signature();
        }, 100);
      }

      function drawMarkers() {
        if (!map) return;
        map.remove(markers);
        markers = [];
        const data = currentRunData;
        if (!data?.target_points?.length) return;
        const sequence =
          data.target_sequence ||
          (data.status == 1 ? data.target_points.length + 1 : 0);
        const names = (data.target_point_names || "").split("|");
        data.target_points.forEach((p, i) => {
          let bgColor = "bg-emerald-600",
            textColor = "text-white",
            zIndex = 100,
            pulseClass = "";
          if (i + 1 < sequence) {
            bgColor = "bg-slate-400";
          } else if (i + 1 === sequence) {
            bgColor = "bg-sky-600";
            zIndex = 110;
            pulseClass = "pulsing-marker";
          }
          const pointName = names[i] || `点 ${i + 1}`;
          const markerContent = `<div class="relative flex flex-col items-center pointer-events-none"><div class="${pulseClass} text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg ${bgColor} ${textColor}">${pointName}</div><div class="w-0 h-0 border-x-4 border-x-transparent border-t-4 ${bgColor.replace(
            "bg-",
            "border-t-"
          )}"></div></div>`;
          const marker = new AMapInstance.Marker({
            position: new AMapInstance.LngLat(p[0], p[1]),
            content: markerContent,
            anchor: "bottom-center",
            zIndex: zIndex,
          });
          markers.push(marker);
        });
        map.add(markers);
      }

      let draftPath = [],
        draftPathLngLat = [],
        pendingPoints = [],
        isUpdating = false,
        lastMouseMoveTime = 0;
      const MOUSE_MOVE_THROTTLE_MS = 70;
      const MIN_DRAW_DISTANCE_M = 12;

      function fastDistanceMeters(lon1, lat1, lon2, lat2) {
        return Math.sqrt(
          Math.pow((lon1 - lon2) * 102834.74, 2) +
            Math.pow((lat1 - lat2) * 111712.69, 2)
        );
      }

      function scheduleUpdate() {
        if (isUpdating) return;
        isUpdating = true;
        requestAnimationFrame(() => {
          if (pendingPoints.length > 0) {
            const batch = pendingPoints.splice(0, pendingPoints.length);
            batch.forEach((pt) => {
              const lngLat = new AMapInstance.LngLat(pt.lng, pt.lat);
              draftPath.push(pt);
              draftPathLngLat.push(lngLat);
              if (draftPathLngLat.length > 1) {
                const prev = draftPathLngLat[draftPathLngLat.length - 2];
                draftTotalDist += fastDistanceMeters(
                  prev.lng,
                  prev.lat,
                  pt.lng,
                  pt.lat
                );
              }
              checkTargetReachedOnDraw(lngLat, pt.isKey === 1);
            });
            if (!polylines.draft) {
              polylines.draft = new AMapInstance.Polyline({
                path: draftPathLngLat,
                strokeColor: "#1f2937",
                strokeWeight: 6,
                zIndex: 45,
              });
              map.add(polylines.draft);
            } else {
              polylines.draft.setPath(draftPathLngLat);
            }
            updateDrawingInfo(draftPathLngLat[draftPathLngLat.length - 1]);
            updateDashboard();
          }
          isUpdating = false;
          if (pendingPoints.length > 0) scheduleUpdate();
        });
      }

      function onMapMouseDown(e) {
        if (e.originEvent.button !== 0) return;
        leftMouseDown = true;
        if (isDrawing) {
          isPathDrawing = true;
          pendingPoints.push({
            lng: e.lnglat.lng,
            lat: e.lnglat.lat,
            isKey: 0,
          });
          scheduleUpdate();
        }
      }
      function onMapMouseMove(e) {
        const now = performance.now();
        if (now - lastMouseMoveTime < MOUSE_MOVE_THROTTLE_MS) return;
        lastMouseMoveTime = now;
        if (isDrawing && isPathDrawing && leftMouseDown) {
          const lastPos = draftPath[draftPath.length - 1];
          if (
            !lastPos ||
            fastDistanceMeters(
              lastPos.lng,
              lastPos.lat,
              e.lnglat.lng,
              e.lnglat.lat
            ) > MIN_DRAW_DISTANCE_M
          ) {
            pendingPoints.push({
              lng: e.lnglat.lng,
              lat: e.lnglat.lat,
              isKey: 0,
            });
            scheduleUpdate();
          } else {
            updateDrawingInfo(e.lnglat);
          }
        }
      }
      function onMapMouseUp(e) {
        leftMouseDown = false;
        if (isDrawing && isPathDrawing) {
          isPathDrawing = false;
          scheduleUpdate();
        }
        if (pendingUnlockMap) {
          map.setStatus({ dragEnable: true });
          pendingUnlockMap = false;
        }
      }
      function checkTargetReachedOnDraw(
        currentLngLat,
        isForcedKeyPoint = false
      ) {
        if (
          !currentRunData?.target_points ||
          currentRunData.target_points.length === 0
        )
          return;
        let seq = currentRunData.target_sequence || 1;
        if (seq > currentRunData.target_points.length) return;
        const [tarLon, tarLat] = currentRunData.target_points[seq - 1];
        const dist = fastDistanceMeters(
          currentLngLat.lng,
          currentLngLat.lat,
          tarLon,
          tarLat
        );
        const range = currentRunData.target_range_m || 0.0;
        if (dist <= range && !currentRunData.isInTargetZone) {
          currentRunData.isInTargetZone = true;
          const targetName =
            (currentRunData.target_point_names || "").split("|")[seq - 1] ||
            `打卡点${seq}`;
          logMessage_Info(`到达打卡点 ${seq}: ${targetName}`);
          if (isForcedKeyPoint) {
            pendingPoints.push({ lng: tarLon, lat: tarLat, isKey: 1 });
            scheduleUpdate();
          }
          if (seq < currentRunData.target_points.length) {
            currentRunData.target_sequence = seq + 1;
            updateDashboard();
            drawMarkers();
          } else {
            logMessage_Info("已到达所有打卡点！");
            if (isDrawing) {
              toggleRecordMode(true);
            }
          }
        } else if (dist > range && currentRunData.isInTargetZone) {
          currentRunData.isInTargetZone = false;
        }
      }
      function updateDrawingInfo(lnglat) {
        if (!isDrawing) {
          if (drawingInfoMarker) drawingInfoMarker.hide();
          return;
        }
        const avgSpeed = pythonParams.speed_mps || 1.5;
        const estTime = avgSpeed > 0 ? draftTotalDist / avgSpeed : 0;
        const timeStr = `${Math.floor(estTime / 60)
          .toString()
          .padStart(2, "0")}:${Math.floor(estTime % 60)
          .toString()
          .padStart(2, "0")}`;
        if (!drawingInfoMarker) {
          drawingInfoMarker = new AMapInstance.Text({
            anchor: "bottom-left",
            offset: new AMapInstance.Pixel(10, -10),
            style: {
              "background-color": "rgba(255, 255, 255, 0.9)",
              border: "1px solid #94a3b8",
              padding: "4px 8px",
              "border-radius": "10px",
              "font-size": "12px",
              color: "#1e293b",
            },
          });
          map.add(drawingInfoMarker);
        }
        drawingInfoMarker.setText(
          `距离: ${draftTotalDist.toFixed(0)} m | 预估: ~${timeStr}`
        );
        drawingInfoMarker.setPosition(lnglat);
        drawingInfoMarker.show();
      }

      let pendingUnlockMap = false;

      async function toggleRecordMode() {
        const btn = $("record-button");
        isDrawing = !isDrawing;
        if (isDrawing) {
          if (selectedTaskIndex === -1) {
            showModalAlert("请先选择一个任务！");
            isDrawing = false;
            return;
          }
          btn.innerHTML = "结束绘制";
          btn.classList.remove("btn-success");
          btn.classList.add("btn-danger");
          $("map-container").classList.add("drawing");
          clearCurrentPath(false);
          currentRunData.target_sequence = 1;
          currentRunData.isInTargetZone = false;
          draftTotalDist = 0;
          updateDashboard();
          drawMarkers();
          map.setStatus({ dragEnable: false });
          resetMapView();
          logMessage_Info("进入录制模式。请在地图上按下左键并拖动来绘制路径。");
        } else {
          btn.innerHTML = "录制路径";
          btn.classList.remove("btn-danger");
          btn.classList.add("btn-success");
          $("map-container").classList.remove("drawing");
          pendingUnlockMap = true;
          isPathDrawing = false;
          if (drawingInfoMarker) drawingInfoMarker.hide();

          // ========== 路径距离校验 ==========
          if (draftTotalDist > 50000) {
            showModalAlert(
              "路径过长（>" +
                (draftTotalDist / 1000).toFixed(2) +
                "km > 50km），请重新录制"
            );
            discardBlackDraftPolyline();
            logMessage_Warn(
              `路径录制失败：距离${(draftTotalDist / 1000).toFixed(
                2
              )}km超过50km限制`
            );
            currentRunData.target_sequence = 0;
            draftTotalDist = 0;
            updateDashboard();
            drawMarkers();
            resetMapView();
            return;
          }
          const totalTargets = currentRunData.target_points?.length || 0;
          const inLastZone =
            totalTargets > 0 &&
            currentRunData.target_sequence >= totalTargets &&
            currentRunData.isInTargetZone === true;
          if (inLastZone) {
            if (draftPath.length > 0) {
              await callPythonAPI("set_draft_path", draftPath);
              await processCurrentPath();
            }
          } else {
            discardBlackDraftPolyline();
            logMessage_Info("未达到最后打卡点，已舍弃路径。");
          }
          currentRunData.target_sequence = 0;
          draftTotalDist = 0;
          updateDashboard();
          drawMarkers();
          resetMapView();
        }
      }
      async function clearCurrentPath(confirm = true) {
        // 步骤1: 检查 currentRunData 中的 draft_coords 和 run_coords 是否同时为空或不存在
        // 如果两者都没有数据，则提示用户"当前任务没有可清除的路径"并返回
        const draftEmpty =
          !currentRunData?.draft_coords ||
          currentRunData.draft_coords.length === 0; // 检查 draft_coords 是否为空或不存在
        const runEmpty =
          !currentRunData?.run_coords || currentRunData.run_coords.length === 0; // 检查 run_coords 是否为空或不存在
        if (draftEmpty && runEmpty) {
          // 如果两者都为空，向用户显示提示信息
          showModalAlert("当前任务没有可清除的路径");
          return; // 提前返回，不执行后续清除逻辑
        }

        // 步骤2: 检查后台任务是否正在执行中
        // 调用 /api/background_task/status API 获取任务状态
        try {
          const statusRes = await callPythonAPI_raw(
            "/api/background_task/status", // 使用完整的API路径
            "GET", // HTTP GET 请求
            null // 无请求体
          );
          // 如果任务状态为 "running"，说明任务正在执行，无法清除路径
          if (
            statusRes?.success &&
            statusRes?.task_status?.status === "running"
          ) {
            showModalAlert("任务正在执行中，无法清除路径"); // 提示用户任务正在执行
            return; // 提前返回，不执行后续清除逻辑
          }
        } catch (e) {
          // 如果获取任务状态失败，使用项目统一的日志函数记录错误
          logMessage_Error("获取后台任务状态失败:", e);
          // 这里选择继续执行清除逻辑，因为无法确定任务状态
        }

        // 步骤3: 如果需要用户确认，则弹出确认对话框
        if (confirm) {
          const userConfirmed = await jsShowConfirm(
            "确认操作",
            "确认清除当前任务已生成的路径吗？"
          );
          if (!userConfirmed) return; // 用户取消操作，提前返回
        }

        // 步骤4: 调用后端API清除当前任务的草稿数据
        await callPythonAPI("clear_current_task_draft");

        // 步骤5: 清除地图上的各种折线图层
        if (polylines.draft) {
          map.remove(polylines.draft); // 移除草稿路径折线
          polylines.draft = null; // 将引用置为null
        }
        if (polylines.history) {
          map.remove(polylines.history); // 移除历史路径折线
          polylines.history = null; // 将引用置为null
        }
        if (polylines.run) {
          map.remove(polylines.run); // 移除运行路径折线
          polylines.run = null; // 将引用置为null
        }

        // 步骤6: 删除地图上的当前位置标记（runnerMarker）
        if (runnerMarker) {
          map.remove(runnerMarker); // 移除跑步者位置标记
          runnerMarker = null; // 将引用置为null
        }

        // 步骤7: 隐藏绘制信息标记（如果存在）
        if (drawingInfoMarker) drawingInfoMarker.hide();

        // 步骤8: 调用 drawMarkers() 来恢复地图上的打卡点样式
        drawMarkers();

        // 步骤9: 重置本地草稿路径相关变量
        draftPath = []; // 清空草稿路径数组
        draftPathLngLat = []; // 清空草稿路径经纬度数组
        draftTotalDist = 0; // 重置草稿总距离

        // 步骤10: 重置 currentRunData 中的相关数据
        if (currentRunData) {
          currentRunData.draft_coords = []; // 清空草稿坐标
          currentRunData.run_coords = []; // 清空运行坐标
          currentRunData.total_run_distance_m = 0; // 重置总运行距离
          currentRunData.total_run_time_s = 0; // 重置总运行时间
          // 重置打卡点状态 (恢复到刚拉取时的状态)
          currentRunData.target_sequence = 0;
          currentRunData.isInTargetZone = false;
        }

        // 步骤11: 更新当前任务列表中对应任务的数据
        if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) {
          currentTasks[selectedTaskIndex].draft_coords = []; // 清空任务的草稿坐标
          currentTasks[selectedTaskIndex].run_coords = []; // 清空任务的运行坐标
        }

        // 步骤12: 更新仪表盘显示
        updateDashboard();

        // 步骤13: 重新渲染任务列表
        renderTaskList();

        // 步骤14: 重新绘制地图标记 (应用重置后的状态)
        drawMarkers();
      }
      async function discardBlackDraftPolyline() {
        try {
          if (polylines.draft) {
            map.remove(polylines.draft);
            polylines.draft = null;
          }
          draftPath = [];
          draftPathLngLat = [];
          pendingPoints = [];
          isUpdating = false;
          isPathDrawing = false;
          leftMouseDown = false;
          draftTotalDist = 0;
          if (drawingInfoMarker) drawingInfoMarker.hide();
          await callPythonAPI("set_draft_path", []);
          if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) {
            currentTasks[selectedTaskIndex].draft_coords = [];
            renderTaskList();
          }
          if (currentRunData) currentRunData.draft_coords = [];
        } catch (e) {
          logMessage_Error("discardBlackDraftPolyline() error:", e);
        }
      }
      async function processCurrentPath() {
        if (draftPath && draftPath.length > 0) {
          logMessage_Info("正在保存草稿路径...");
          await callPythonAPI("set_draft_path", draftPath);
        }
        const result = await callPythonAPI("process_path");
        if (result.success) {
          currentRunData.run_coords = result.run_coords;
          currentRunData.total_run_distance_m = result.total_dist;
          currentRunData.total_run_time_s = result.total_time;
          drawOnMap();
          updateDashboard();
          renderTaskList();
          discardBlackDraftPolyline();
          singleProcessedPoints = 0;
          singleTotalPoints = currentRunData.run_coords?.length || 0;
          updateSingleProgress(0, "0 / " + singleTotalPoints + " 点");
        } else {
          showModalAlert(result.message);
        }
      }
      async function toggleRun() {
        const btn = $("start-run-button");
        runAccumulatedMs = 0;

        if (btn.textContent === "开始执行") {
          const autoGen = $("auto-gen-all-check").checked;
          if (selectedTaskIndex < 0) {
            showModalAlert("请先选择任务");
            return;
          }
          if (currentRunData) {
            currentRunData.target_sequence = 1;
            currentRunData.isInTargetZone = false;
            updateDashboard();
            drawMarkers();
          }
          const result = await callPythonAPI_raw(
            "/api/background_task/start",
            "POST",
            {
              task_indices: [selectedTaskIndex],
              auto_generate: autoGen,
            }
          );

          if (result.success) {
            btn.textContent = "停止";
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-danger");
            updateSingleProgress(0, "0 / 0 点");
            setTimeout(() => startBackgroundTaskPolling(), 500);
          } else {
            showModalAlert(result.message);
          }
        } else {
          await callPythonAPI_raw("/api/background_task/stop", "POST", {});
          btn.textContent = "开始执行";
          btn.classList.remove("btn-danger");
          btn.classList.add("btn-primary");
          stopBackgroundTaskPolling();
        }
      }
      async function toggleAllRuns() {
        const btn = $("start-all-button");
        runAccumulatedMs = 0;

        if (btn.textContent === "执行所有") {
          const ignoreCompleted = $("run-completed-check").checked;
          const autoGen = $("auto-gen-all-check").checked;
          const taskIndices = [];
          for (let i = 0; i < currentTasks.length; i++) {
            const task = currentTasks[i];
            if (task.status == 1 && !ignoreCompleted) continue;
            const infoText = task.info_text || "";

            if (infoText === "已过期") {
              continue;
            }
            if (infoText.startsWith("开始于")) {
              continue;
            }
            taskIndices.push(i);
          }
          if (taskIndices.length === 0) {
            showModalAlert("没有可执行的任务");
            return;
          }
          if (currentRunData) {
            currentRunData.target_sequence = 1;
            currentRunData.isInTargetZone = false;
            updateDashboard();
            drawMarkers();
          }
          const result = await callPythonAPI_raw(
            "/api/background_task/start",
            "POST",
            {
              task_indices: taskIndices,
              auto_generate: autoGen,
            }
          );
          if (result.success) {
            btn.textContent = "全部停止";
            btn.classList.remove("btn-secondary");
            btn.classList.add("btn-danger");
            updateSingleProgress(0, `0 / ${taskIndices.length} 任务`);
            setTimeout(() => startBackgroundTaskPolling(), 500);
          } else {
            showModalAlert(result.message);
          }
        } else {
          await callPythonAPI_raw("/api/background_task/stop", "POST", {});
          btn.textContent = "执行所有";
          btn.classList.remove("btn-danger");
          btn.classList.add("btn-secondary");
          stopBackgroundTaskPolling();
        }
      }
      // ========== 后台任务管理函数 ==========
      let backgroundTaskPollInterval = null;
      let backgroundTaskStartTime = 0;

      function startBackgroundTaskPolling() {
        if (backgroundTaskPollInterval) {
          clearInterval(backgroundTaskPollInterval);
        }
        backgroundTaskStartTime = Date.now();
        pollBackgroundTaskStatus();
        backgroundTaskPollInterval = setInterval(
          pollBackgroundTaskStatus,
          3000
        );
      }
      function stopBackgroundTaskPolling() {
        if (backgroundTaskPollInterval) {
          clearInterval(backgroundTaskPollInterval);
          backgroundTaskPollInterval = null;
        }
        backgroundTaskStartTime = 0;
      }
      async function pollBackgroundTaskStatus() {
        try {
          const result = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );
          if (result.success && result.task_status) {
            const status = result.task_status;
            if (status.run_coords && status.run_coords.length > 0) {
              if (
                !currentRunData ||
                !currentRunData.run_coords ||
                currentRunData.run_coords.length === 0
              ) {
                logMessage_Info(
                  "检测到后端已自动生成路径，正在更新前端地图..."
                );
                currentRunData.run_coords = status.run_coords || [];
                currentRunData.target_points = status.target_points || [];
                currentRunData.target_point_names =
                  status.target_point_names || "";
                currentRunData.recommended_coords =
                  status.recommended_coords || [];

                currentRunData.total_run_time_s =
                  status.estimated_total_time_s || 0;
                currentRunData.total_run_distance_m =
                  status.estimated_total_distance_m || 0;
                drawOnMap();
                updateDashboard();
              }
            }
            const completedTasks = status.completed_tasks || 0;
            const totalTasks = status.total_tasks || 0;
            const progressPercent = status.progress_percent || 0;
            const currentTaskProgress = status.current_task_progress || 0;
            let pct = 0;
            let displayText = "";
            if (
              status.singleTotalPoints !== undefined &&
              status.singleProcessedPoints !== undefined
            ) {
              singleTotalPoints = status.singleTotalPoints;
              singleProcessedPoints = status.singleProcessedPoints;
              pct = Math.floor(
                (singleProcessedPoints * 100) / Math.max(1, singleTotalPoints)
              );
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} 点`;
            } else if (
              currentRunData &&
              Array.isArray(currentRunData.run_coords) &&
              currentRunData.run_coords.length > 0
            ) {
              singleTotalPoints = currentRunData.run_coords.length;

              if (status.current_position) {
                const currentPointIndex =
                  status.current_position.point_index || 0;
                singleProcessedPoints = Math.min(
                  currentPointIndex,
                  singleTotalPoints
                );
              } else {
                singleProcessedPoints = Math.floor(
                  (currentTaskProgress / 100) * singleTotalPoints
                );
              }

              pct = Math.floor(
                (singleProcessedPoints * 100) / Math.max(1, singleTotalPoints)
              );
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} 点`;
            } else {
              singleTotalPoints = 0;
              singleProcessedPoints = 0;
              pct = 0;
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} 点`;
            }

            updateSingleProgress(pct, displayText);
            if (
              status.task_indices &&
              status.current_task_index !== undefined
            ) {
              const task_list = status.task_indices;
              const current_list_index = status.current_task_index;
              if (task_list.length > current_list_index) {
                const global_task_index = task_list[current_list_index];

                if (
                  global_task_index !== selectedTaskIndex ||
                  (currentRunData &&
                    currentRunData.task_index !== global_task_index)
                ) {
                  logMessage_Info(
                    `[Polling] 检测到任务切换: ${selectedTaskIndex} -> ${global_task_index}`
                  );
                  selectedTaskIndex = global_task_index;
                  renderTaskList();
                  await forceLoadTaskDataForPolling(global_task_index);
                }
              }
            }
            if (status.elapsed_time_s !== undefined) {
              runAccumulatedMs = status.elapsed_time_s * 1000;
            }
            if (status.current_distance_m !== undefined && currentRunData) {
              currentRunData.distance_covered_m = status.current_distance_m;
            }
            if (status.checked_targets_count !== undefined && currentRunData) {
              currentRunData.target_sequence = status.checked_targets_count;
            }
            updateDashboard();

            drawMarkers();
            if (status.current_position) {
              const pos = status.current_position;
              updateRunnerPosition(
                pos.lon,
                pos.lat,
                pos.distance || 0,
                pos.target_sequence || 0,
                0,
                false
              );
            }
            const taskStartTime = (status.start_time || 0) * 1000;
            const isOldTask =
              backgroundTaskStartTime > 0 &&
              taskStartTime < backgroundTaskStartTime - 2000;
            if (status.status === "completed") {
              if (!isOldTask) {
                logMessage_Info("后台任务全部完成！");
                showModalAlert("后台任务全部完成！");
              }
              stopBackgroundTaskPolling();
              $("start-run-button").textContent = "开始执行";
              $("start-run-button").classList.remove("btn-danger");
              $("start-run-button").classList.add("btn-primary");
              $("start-all-button").textContent = "执行所有";
              $("start-all-button").classList.remove("btn-danger");
              $("start-all-button").classList.add("btn-secondary");
              updateMobileTaskUI("已完成", "所有任务已完成");
              if (!isOldTask) {
                refreshTasks();
              }
            } else if (status.status === "error") {
              const errorMsg = status.error || "未知错误";
              logMessage_Error("后台任务执行出错: " + errorMsg);
              if (!isOldTask) {
                showModalAlert("后台任务执行出错: " + errorMsg);
              }
              stopBackgroundTaskPolling();
              $("start-run-button").textContent = "开始执行";
              $("start-run-button").classList.remove("btn-danger");
              $("start-run-button").classList.add("btn-primary");
              $("start-all-button").textContent = "执行所有";
              $("start-all-button").classList.remove("btn-danger");
              $("start-all-button").classList.add("btn-secondary");
              updateMobileTaskUI("错误", errorMsg || "任务执行出错");
            }
          }
        } catch (e) {
          logMessage_Debug("轮询后台任务状态失败:", e);
        }
      }
      async function checkBackgroundTaskOnLoad() {
        try {
          const result = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );

          if (result.success && result.task_status) {
            const status = result.task_status;
            if (status.status === "running") {
              logMessage_Info("检测到后台任务正在运行，已恢复状态显示");
              const totalTasks = status.total_tasks || 0;
              if (totalTasks === 1) {
                $("start-run-button").textContent = "停止";
                $("start-run-button").classList.remove("btn-primary");
                $("start-run-button").classList.add("btn-danger");
              } else if (totalTasks > 1) {
                $("start-all-button").textContent = "全部停止";
                $("start-all-button").classList.remove("btn-secondary");
                $("start-all-button").classList.add("btn-danger");
              }
              const task_list = status.task_indices || [];
              const current_list_index = status.current_task_index || 0;

              if (task_list.length > current_list_index) {
                const global_task_index = task_list[current_list_index];

                logMessage_Info(
                  `正在恢复运行中的任务 (索引: ${global_task_index}) 的地图数据...`
                );

                if (status.run_coords && status.run_coords.length > 0) {
                  currentRunData = {
                    run_coords: status.run_coords || [],
                    target_points: status.target_points || [],
                    target_point_names: status.target_point_names || "",
                    recommended_coords: status.recommended_coords || [],
                    target_sequence: status.checked_targets_count || 0,
                    distance_covered_m: status.current_distance_m || 0,
                    total_run_time_s: status.estimated_total_time_s || 0,
                    total_run_distance_m:
                      status.estimated_total_distance_m || 0,
                  };

                  selectedTaskIndex = global_task_index;
                  const taskListDiv = $("task-list");
                  Array.from(taskListDiv.children).forEach((child, idx) => {
                    if (idx === global_task_index) {
                      child.classList.add("selected");
                    } else {
                      child.classList.remove("selected");
                    }
                  });
                  loadHistory(global_task_index);
                  updateDashboard();
                  drawOnMap();

                  logMessage_Info(
                    `任务数据已从API响应恢复，总点数: ${currentRunData.run_coords.length}`,
                    "INFO"
                  );
                } else {
                  await selectTask(global_task_index);
                }
              } else {
                logMessage_Warning("后台任务状态不一致，无法恢复地图路径。");
              }
              const completedTasks = status.completed_tasks || 0;
              const progressPercent = status.progress_percent || 0;
              const currentTaskProgress = status.current_task_progress || 0;
              let pct = 0;
              let displayText = "";
              if (
                status.singleTotalPoints !== undefined &&
                status.singleProcessedPoints !== undefined
              ) {
                singleTotalPoints = status.singleTotalPoints;
                singleProcessedPoints = status.singleProcessedPoints;
                pct = Math.floor(
                  (singleProcessedPoints * 100) / Math.max(1, singleTotalPoints)
                );
                displayText = `${singleProcessedPoints} / ${singleTotalPoints} 点`;
              } else if (
                currentRunData &&
                Array.isArray(currentRunData.run_coords) &&
                currentRunData.run_coords.length > 0
              ) {
                singleTotalPoints = currentRunData.run_coords.length;

                if (status.current_position) {
                  const currentPointIndex =
                    status.current_position.point_index || 0;
                  singleProcessedPoints = Math.min(
                    currentPointIndex,
                    singleTotalPoints
                  );
                } else {
                  singleProcessedPoints = Math.floor(
                    (currentTaskProgress / 100) * singleTotalPoints
                  );
                }

                pct = Math.floor(
                  (singleProcessedPoints * 100) / Math.max(1, singleTotalPoints)
                );
                displayText = `${singleProcessedPoints} / ${singleTotalPoints} 点`;
              } else {
                singleTotalPoints = 0;
                singleProcessedPoints = 0;
                pct = 0;
                displayText = `${singleProcessedPoints} / ${singleTotalPoints} 点`;
              }

              updateSingleProgress(pct, displayText);
              if (status.elapsed_time_s !== undefined) {
                runAccumulatedMs = status.elapsed_time_s * 1000;
              }
              if (status.current_distance_m !== undefined && currentRunData) {
                currentRunData.distance_covered_m = status.current_distance_m;
              }
              if (
                status.checked_targets_count !== undefined &&
                currentRunData
              ) {
                currentRunData.target_sequence = status.checked_targets_count;
              }
              updateDashboard();
              if (status.current_position) {
                const pos = status.current_position;
                updateRunnerPosition(
                  pos.lon,
                  pos.lat,
                  pos.distance || 0,
                  pos.target_sequence || 0,
                  0,
                  true
                );
              }

              startBackgroundTaskPolling();
              return true;
            }
          }
        } catch (e) {
          logMessage_Debug("检查后台任务状态失败:", e);
          return false;
        }
      }

      function ensureRunnerMarker() {
        if (runnerMarker) return;
        const content =
          '<div class="w-5 h-5 rounded-full border-2 border-white shadow-lg" style="background:linear-gradient(135deg,var(--base-color-300),var(--base-color-600));"></div>';
        runnerMarker = new AMapInstance.Marker({
          position: map.getCenter(),
          content,
          anchor: "center",
          zIndex: 200,
        });
        map.add(runnerMarker);
      }
      function updateRunnerPosition(
        lon,
        lat,
        distance,
        targetSequence,
        duration,
        centerNow = false
      ) {
        ensureRunnerMarker();
        const pos = new AMapInstance.LngLat(lon, lat);
        runnerMarker.setPosition(pos);
        if (map && centerNow) map.setCenter(pos);
        runAccumulatedMs += duration || 0;
        currentRunData.distance_covered_m = distance || 0;
        $(
          "current-location-label"
        ).textContent = `当前位置GPS坐标: ${(+lon).toFixed(
          4
        )}, ${(+lat).toFixed(4)}`;

        const mobileCurrentLocationLabel = document.getElementById(
          "mobile-current-location-label"
        );
        if (mobileCurrentLocationLabel) {
          mobileCurrentLocationLabel.textContent = `当前位置: ${(+lon).toFixed(
            4
          )}, ${(+lat).toFixed(4)}`;
        }
        const jsTargetSequence = targetSequence + 1;
        if (currentRunData.target_sequence !== jsTargetSequence) {
          currentRunData.target_sequence = jsTargetSequence;
          drawMarkers();
        }
        updateDashboard();
        if (
          Array.isArray(currentRunData.run_coords) &&
          currentRunData.run_coords.length > 0
        ) {
          singleTotalPoints = currentRunData.run_coords.length;
          singleProcessedPoints = Math.min(
            singleProcessedPoints + 1,
            singleTotalPoints
          );
          const pct = Math.floor(
            (singleProcessedPoints * 100) / Math.max(1, singleTotalPoints)
          );
          updateSingleProgress(
            pct,
            `${singleProcessedPoints} / ${singleTotalPoints} 点`
          );
        }
      }
      function onTaskCompleted(taskIndex) {
        if (currentTasks[taskIndex]) {
          currentTasks[taskIndex].status = 1;
          renderTaskList();
        }
      }
      function onRunStopped() {
        logMessage_Info("后台任务已停止（来自服务器推送）。");
        stopBackgroundTaskPolling();
        const startBtn = $("start-run-button");
        if (startBtn) {
          startBtn.textContent = "开始执行";
          startBtn.classList.remove("btn-danger");
          startBtn.classList.add("btn-primary");
          startBtn.disabled = false;
        }
        const startAllBtn = $("start-all-button");
        if (startAllBtn) {
          startAllBtn.textContent = "执行所有";
          startAllBtn.classList.remove("btn-danger");
          startAllBtn.classList.add("btn-secondary");
          startAllBtn.disabled = false;
        }
      }

      async function exportTask() {
        if (selectedTaskIndex === -1) {
          showModalAlert("请先选择一个要导出的任务！");
          return;
        }
        const result = await callPythonAPI("export_task_data");
        if (result && result.success && result.data) {
          const jsonStr = JSON.stringify(result.data, null, 2);
          const blob = new Blob([jsonStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = result.filename || "task_export.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          logMessage_Info("导出成功");
        } else if (result && !result.success) {
          showModalAlert(`导出失败: ${result.message}`);
        }
      }
      async function importTask() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const result = await callPythonAPI("import_task_data", text);
            if (result.success) {
              IS_OFFLINE = true;
              currentSessionUA = "NULL";
              const uaLabel = $("ua-label");
              if (uaLabel) uaLabel.textContent = "NULL";
              const uaBtn = $("random-ua-btn");
              if (uaBtn) uaBtn.disabled = true;
              if (result.userInfo) {
                currentUserData = result.userInfo;
                const name = currentUserData.name || "离线调试";
                const sid = currentUserData.student_id || "NULL";
                $("user-name-label").textContent = `姓名: ${name}`;
                $("user-id-label").textContent = `学号: ${sid}`;
              }
              showMainApp();
              const adminBtn = $("show-admin-panel");
              if (adminBtn) {
                adminBtn.classList.remove("hidden");
                logMessage_Info("[离线导入] 管理面板按钮已显示");
              }
              await mapReadyPromise;
              currentTasks = result.tasks;
              renderTaskList();
              selectTask(0);
              requestAnimationFrame(() => drawOnMap());
              logMessage_Info("导入成功");
            } else {
              showModalAlert(result.message || "导入失败");
            }
          } catch (error) {
            showModalAlert(`导入失败: ${error.message}`);
          }
        };
        input.click();
      }
      async function getWalkingPath(waypoints) {
        if (!AMapInstance || waypoints.length < 2)
          throw new Error("地图实例未加载或路径点少于2");
        const useFallback = pythonParams.api_fallback_line ?? false,
          maxRetries = pythonParams.api_retries ?? 2,
          retryDelayMs = (pythonParams.api_retry_delay_s ?? 0.5) * 1000;
        callPythonAPI(
          "js_log",
          "INFO",
          `开始路径规划: 重试=${maxRetries}次, 延迟=${retryDelayMs}ms, 备用直线=${useFallback}`
        );
        const all_path = [];
        const areCoordsEqual = (c1, c2) =>
          Math.abs(c1.lng - c2.lng) < 1e-6 && Math.abs(c1.lat - c2.lat) < 1e-6;
        const searchSegment = (start, end) =>
          new Promise((resolve) => {
            callPythonAPI(
              "js_log",
              "DEBUG",
              `AMap API请求 --> 步行路径: ${start.toString()} 至 ${end.toString()}`
            );
            new AMap.Walking({
              map: null,
              panel: "",
              hideMarkers: true,
            }).search(start, end, (status, result) => {
              if (status === "complete" && result.routes?.length > 0) {
                const p = [];
                result.routes[0].steps.forEach((s) =>
                  s.path.forEach((pt) => p.push({ lng: pt.lng, lat: pt.lat }))
                );
                callPythonAPI(
                  "js_log",
                  "DEBUG",
                  `AMap API响应 <-- 成功，点数: ${p.length}`
                );
                resolve(p);
              } else {
                let info = result
                  ? result.info || JSON.stringify(result)
                  : "NULL";
                callPythonAPI(
                  "js_log",
                  "ERROR",
                  `AMap API响应 <-- 失败. 状态: ${status}, 结果: ${info}`
                );
                resolve([]);
              }
            });
          });
        for (let i = 0; i < waypoints.length - 1; i++) {
          logMessage_Info(
            `正在规划第 ${i + 1}/${waypoints.length - 1} 段路径...`
          );
          const realStart = waypoints[i],
            realEnd = waypoints[i + 1];
          let attempts = 0,
            segmentPath = [];
          while (attempts <= maxRetries) {
            if (attempts > 0) {
              logMessage_Info(
                `第 ${i + 1} 段路径规划失败，${retryDelayMs / 1000}秒后重试...`
              );
              await new Promise((res) => setTimeout(res, retryDelayMs));
            }
            segmentPath = await searchSegment(realStart, realEnd);
            if (segmentPath.length > 0) break;
            attempts++;
          }
          if (segmentPath.length === 0) {
            if (useFallback) {
              logMessage_Info(`第 ${i + 1} 段路径规划最终失败，启用直线连接。`);
              segmentPath = [
                { lng: realStart.lng, lat: realStart.lat },
                { lng: realEnd.lng, lat: realEnd.lat },
              ];
            } else
              throw new Error(
                `第 ${i + 1} 段路径规划失败 (重试 ${maxRetries} 次后)`
              );
          }
          if (
            !areCoordsEqual(segmentPath[0], {
              lng: realStart.lng,
              lat: realStart.lat,
            })
          )
            segmentPath.unshift({ lng: realStart.lng, lat: realStart.lat });
          if (
            !areCoordsEqual(segmentPath[segmentPath.length - 1], {
              lng: realEnd.lng,
              lat: realEnd.lat,
            })
          )
            segmentPath.push({ lng: realEnd.lng, lat: realEnd.lat });
          all_path.push(...(i > 0 ? segmentPath.slice(1) : segmentPath));
        }
        return all_path;
      }
      async function onConfirmAutoGenerate() {
        const minTime = parseInt($("min-time-input").value),
          maxTime = parseInt($("max-time-input").value),
          minDist = parseInt($("min-dist-input").value);
        if (minTime > maxTime) {
          showModalAlert("最短时间不能大于最长时间");
          return;
        }
        $("auto-gen-modal").classList.add("hidden");
        $("auto-gen-modal").classList.remove("flex");
        document.body.classList.remove("modal-visible");

        if (
          selectedTaskIndex === -1 ||
          !currentRunData.target_points ||
          currentRunData.target_points.length === 0
        ) {
          showModalAlert("请先选择一个有打卡点的任务");
          return;
        }
        logMessage_Info("正在调用高德地图API进行路径规划...");
        try {
          const waypoints = currentRunData.target_points.map(
            (p) => new AMapInstance.LngLat(p[0], p[1])
          );
          const apiPath = await getWalkingPath(waypoints);
          logMessage_Info(
            `路径规划成功，共 ${apiPath.length} 个坐标点。正在生成模拟数据...`
          );
          const result = await callPythonAPI(
            "auto_generate_path_with_api",
            apiPath,
            minTime,
            maxTime,
            minDist
          );
          if (result.success) {
            currentRunData.run_coords = result.run_coords;
            currentRunData.total_run_distance_m = result.total_dist;
            currentRunData.total_run_time_s = result.total_time;
            drawOnMap();
            updateDashboard();
            renderTaskList();
            singleProcessedPoints = 0;
            singleTotalPoints = currentRunData.run_coords?.length || 0;
            updateSingleProgress(0, "0 / " + singleTotalPoints + " 点");
          } else {
            logMessage_Info(`生成失败: ${result.message}`);
            showModalAlert(`生成失败: ${result.message}`);
          }
        } catch (error) {
          logMessage_Info(`路径规划或生成失败: ${error}`);
          showModalAlert(`路径规划或生成失败: ${error}`);
        }
      }
      async function loadHistory(index) {
        $("history-placeholder").textContent = "正在加载...";
        $("history-list").innerHTML = "";
        const result = await callPythonAPI("get_task_history", index);
        if (result.success && result.history.length > 0) {
          $("history-placeholder").classList.add("hidden");
          result.history.forEach((rec) => {
            const item = document.createElement("div");
            item.className =
              "grid grid-cols-3 gap-2 text-xs p-2 border-b border-slate-100 cursor-pointer hover:bg-white/70 rounded";
            item.innerHTML = `<span class="text-slate-600">${rec.time}</span><span class="font-semibold text-emerald-700">${rec.len}</span><span class="font-semibold text-sky-700">${rec.used_time}</span>`;
            item.addEventListener("click", () => showHistoricalTrack(rec.trid));
            $("history-list").appendChild(item);
          });
        } else {
          $("history-placeholder").textContent = "无历史记录或加载失败";
          $("history-placeholder").classList.remove("hidden");
        }
      }

      async function showHistoricalTrack(trid) {
        if (backgroundTaskPollInterval) {
          logMessage_Warning(
            "任务执行中，无法查看历史记录！请先停止当前任务。"
          );
          showModalAlert("任务执行中，无法查看历史记录！请先停止当前任务。");
          return;
        }
        const result = await callPythonAPI("get_historical_track", trid);
        if (result.success) {
          logMessage_Info(
            `[历史轨迹] API返回数据 - coords长度: ${
              result.coords?.length || 0
            }, target_points长度: ${result.target_points?.length || 0}`
          );

          if (isMobileMode) {
            const modal = $("mobile-track-modal");
            if (modal) {
              $("mobile-track-modal").classList.add("show");
              modal.classList.remove("hidden");
              modal.style.display = "flex";
              await initMobileTrackMap();
              clearMobileTrackMap();
              const path = result.coords.map(
                (p) => new AMapInstance.LngLat(p[0], p[1])
              );

              if (path.length > 0) {
                mobileTrackPolyline = new AMapInstance.Polyline({
                  path: path,
                  strokeColor: "#8b5cf6",
                  strokeWeight: 5,
                  strokeOpacity: 0.8,
                  zIndex: 55,
                  map: mobileTrackMapInstance,
                });
                const startMarker = new AMapInstance.Marker({
                  position: path[0],
                  content:
                    '<div style="width:12px;height:12px;background:#10b981;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                  anchor: "center",
                  map: mobileTrackMapInstance,
                });
                mobileTrackMarkers.push(startMarker);
                const endMarker = new AMapInstance.Marker({
                  position: path[path.length - 1],
                  content:
                    '<div style="width:12px;height:12px;background:#ef4444;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                  anchor: "center",
                  map: mobileTrackMapInstance,
                });
                mobileTrackMarkers.push(endMarker);
                let totalDist = 0;
                if (AMapInstance.GeometryUtil) {
                  totalDist = AMapInstance.GeometryUtil.distanceOfLine(path);
                }
                const distance = result.distance || totalDist / 1000;
                const duration = result.duration || result.used_time || "--:--";
                const checkpoints =
                  result.checkpoints || result.target_points?.length || 0;
                const distEl = $("mobile-track-distance");
                const durEl = $("mobile-track-duration");
                const paceEl = $("mobile-track-pace");
                if (distEl) {
                  distEl.textContent = `${
                    typeof distance === "number"
                      ? distance.toFixed(2)
                      : distance
                  } km`;
                }
                if (durEl) {
                  durEl.textContent = duration;
                }
                if (
                  paceEl &&
                  typeof distance === "number" &&
                  duration !== "--:--"
                ) {
                  const durationMatch = duration.match(/(\d+):(\d+)/);
                  if (durationMatch) {
                    const totalMinutes =
                      parseInt(durationMatch[1]) +
                      parseInt(durationMatch[2]) / 60;
                    const pace = distance > 0 ? totalMinutes / distance : 0;
                    const paceMin = Math.floor(pace);
                    const paceSec = Math.round((pace - paceMin) * 60);
                    paceEl.textContent = `${paceMin}:${paceSec
                      .toString()
                      .padStart(2, "0")}/km`;
                  } else {
                    paceEl.textContent = "--:--";
                  }
                }

                logMessage_Info(
                  `[历史轨迹] 摘要信息已更新 - 距离: ${distance} km, 时长: ${duration}, 打卡点: ${checkpoints}`
                );
                logMessage_Info(
                  `[历史轨迹] 检查打卡点数据 - target_points存在: ${!!result.target_points}, 长度: ${
                    result.target_points?.length || 0
                  }`
                );
                if (result.target_points && result.target_points.length > 0) {
                  const targetNames = result.target_point_names
                    ? result.target_point_names.split("|")
                    : [];
                  result.target_points.forEach((point, index) => {
                    const pointName = targetNames[index] || `点 ${index + 1}`;
                    const checkpointMarker = new AMapInstance.Marker({
                      position: new AMapInstance.LngLat(point[0], point[1]),
                      content: `<div class="flex flex-col items-center">
                      <div class="text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg bg-emerald-600 text-white">
                        ${pointName}
                      </div>
                      <div class="w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-emerald-600"></div>
                    </div>`,
                      anchor: "bottom-center",
                      zIndex: 100,
                      map: mobileTrackMapInstance,
                    });
                    mobileTrackMarkers.push(checkpointMarker);
                  });
                  logMessage_Info(
                    `[历史轨迹] 已绘制 ${result.target_points.length} 个打卡点`
                  );
                }
                mobileTrackMapInstance.setFitView();
              }
            }
            return;
          }
          if (polylines.history) map.remove(polylines.history);
          polylines.history = new AMapInstance.Polyline({
            path: result.coords.map((p) => new AMapInstance.LngLat(p[0], p[1])),
            strokeColor: "#8b5cf6",
            strokeWeight: 6,
            strokeOpacity: 0.8,
            zIndex: 55,
          });
          map.add(polylines.history);
          map.setFitView([polylines.history]);
        } else showModalAlert("无法加载历史轨迹");
      }
      function updateSingleProgress(pct, text, extra) {
        const fill = $("single-progress-fill");
        const label = $("single-progress-text");
        const extraEl = $("single-progress-extra");
        if (fill) fill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
        if (label) label.textContent = `进度 · ${pct}%`;
        if (extraEl) extraEl.textContent = extra || text || "";
        const mobileFill = document.getElementById(
          "mobile-single-progress-fill"
        );
        const mobileLabel = document.getElementById(
          "mobile-single-progress-text"
        );
        const mobileExtraEl = document.getElementById(
          "mobile-single-progress-extra"
        );
        if (mobileFill)
          mobileFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
        if (mobileLabel) mobileLabel.textContent = `进度 · ${pct}%`;
        if (mobileExtraEl) mobileExtraEl.textContent = extra || text || "";
      }
      function getCallerInfo(linesToSkip = null) {
        try {
          const err = new Error();
          const stack = err.stack;
          if (!stack) return { source: "unknown (no stack)" };
          const lines = stack.split("\n");

          let callerLine;

          if (linesToSkip !== null) {
            try {
              callerLine = lines[linesToSkip + 1] || "";
            } catch (error) {
              logMessage_Error("Error accessing stack line:", error);
              callerLine = lines[4] || lines[3] || lines[2] || lines[1] || "";
            }
          } else {
            callerLine = lines[4] || lines[3] || lines[2] || lines[1] || "";
          }
          if (typeof callerLine !== "string") {
            callerLine = "";
          }
          callerLine = callerLine.trim();
          let match = callerLine.match(
            /at\s+(?:(.+)\s+\()?(?:.+\/)?([^:]+:\d+:\d+)\)?/
          );
          if (match) {
            const functionName = match[1] || "anonymous";
            const fileInfo = match[2] || "";
            return {
              source: `${functionName} (${fileInfo})`,
              functionName: functionName,
              fileInfo: fileInfo,
            };
          }
          match = callerLine.match(/^(?:([^@]+)@)?(?:.+\/)?([^:]+:\d+:\d+)$/);
          if (match) {
            const functionName = match[1] || "anonymous";
            const fileInfo = match[2] || "";
            return {
              source: `${functionName}@${fileInfo}`,
              functionName: functionName,
              fileInfo: fileInfo,
            };
          }
          return { source: callerLine || "unknown (parse failed)" };
        } catch (e) {
          return { source: "unknown (error parsing stack)" };
        }
      }
      function extractCleanSource(sourceString) {
        if (typeof sourceString !== "string") {
          return "unknown";
        }
        let result = "";
        const marker = "(uuid=";
        let markerIndex = sourceString.indexOf(marker);
        if (markerIndex === -1) {
          return sourceString.trim();
        }
        let relevantPart = sourceString.substring(0, markerIndex);
        result = relevantPart.trimEnd();
        return result || "未知";
      }
      (function () {
        const originalConsole = {
          log: console.log.bind(console),
          info: console.info.bind(console),
          warn: console.warn.bind(console),
          error: console.error.bind(console),
          debug: console.debug.bind(console),
        };
        let isIntercepting = false;

        function interceptConsole(level, args, originalFn) {
          originalFn.apply(console, args);
          if (isIntercepting) return;

          try {
            isIntercepting = true;
            const message = args
              .map((arg) => {
                if (typeof arg === "string") return arg;
                if (arg instanceof Error)
                  return `${arg.name}: ${arg.message}\n${arg.stack}`;
                try {
                  return JSON.stringify(arg);
                } catch (e) {
                  return String(arg);
                }
              })
              .join(" ");
            if (
              message.includes("[前端日志]") ||
              message.includes("[日志发送失败]") ||
              message.includes("Failed to fetch") ||
              message.includes("NetworkError")
            ) {
              return;
            }
            if (!isInNetworkErrorState && sessionUUID) {
              const now = new Date();
              const timestamp = `${String(now.getHours()).padStart(
                2,
                "0"
              )}:${String(now.getMinutes()).padStart(2, "0")}:${String(
                now.getSeconds()
              ).padStart(2, "0")}`;

              fetch("/api/log_frontend", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-Session-ID": sessionUUID || null,
                },
                credentials: "include",
                body: JSON.stringify({
                  level: level.toUpperCase(),
                  message: message,
                  timestamp: timestamp,
                  source: "第三方JS",
                }),
              }).catch(() => {});
            }
          } finally {
            isIntercepting = false;
          }
        }
        console.log = function (...args) {
          interceptConsole("info", args, originalConsole.log);
        };

        console.info = function (...args) {
          interceptConsole("info", args, originalConsole.info);
        };

        console.warn = function (...args) {
          interceptConsole("warning", args, originalConsole.warn);
        };

        console.error = function (...args) {
          interceptConsole("error", args, originalConsole.error);
        };

        console.debug = function (...args) {
          interceptConsole("debug", args, originalConsole.debug);
        };
        console._original = originalConsole;
      })();
      function logMessage(msg, level = "INFO", source = null) {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        const s = String(now.getSeconds()).padStart(2, "0");
        const timestamp = `[${h}:${m}:${s}]`;
        const timestamp2 = `${h}:${m}:${s}`;
        const line = typeof msg === "string" ? msg : JSON.stringify(msg);

        let level_new = "INFO";
        let callerInfo;
        if (source) {
          callerInfo = source;
        } else {
          let orange_callerInfo = getCallerInfo();
          callerInfo = extractCleanSource(orange_callerInfo.source);
        }

        let new_message = `${timestamp}[前端日志][${callerInfo}] ${line}`;
        const fullMessage = `${timestamp}[${callerInfo}] ${line}`;

        if (level === "DEBUG") {
          level_new = "DEBUG";
          if (console._original) {
            console._original.debug(new_message);
          } else {
            console.debug(new_message);
          }
        } else if (level === "INFO") {
          level_new = "INFO";
          if (console._original) {
            console._original.info(new_message);
          } else {
            console.info(new_message);
          }
        } else if (level === "ERROR") {
          level_new = "ERROR";
          if (console._original) {
            console._original.error(new_message);
          } else {
            console.error(new_message);
          }
        } else if (level === "WARNING") {
          level_new = "WARNING";
          if (console._original) {
            console._original.warn(new_message);
          } else {
            console.warn(new_message);
          }
        } else if (level === "CRITICAL") {
          level_new = "CRITICAL";
          if (console._original) {
            console._original.error(new_message);
          } else {
            console.error(new_message);
          }
        } else {
          if (console._original) {
            console._original.log(new_message);
          } else {
            console.log(new_message);
          }
        }
        if (!isInNetworkErrorState && source !== "Backend") {
          try {
            fetch("/api/log_frontend", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Session-ID": sessionUUID || null,
              },
              credentials: "include",
              body: JSON.stringify({
                level: level_new,
                message: line,
                timestamp: timestamp2,
                source: callerInfo,
              }),
            }).catch((err) => {
              if (console._original && console._original.error) {
                console._original.error("[日志发送失败]", err);
              } else {
              }
            });
          } catch (e) {
            if (console._original && console._original.error) {
              console._original.error("[日志发送异常]", e);
            }
          }
        }
        const isCoreLog = (message, logLevel) => {
          if (
            logLevel === "ERROR" ||
            logLevel === "WARNING" ||
            logLevel === "CRITICAL"
          ) {
            return true;
          }
          const coreKeywords = [
            "路径规划",
            "路径生成",
            "自动生成",
            "处理路径",
            "清除路径",
            "录制路径",
            "导出路径",
            "开始执行",
            "执行完成",
            "执行所有",
            "停止执行",
            "任务完成",
            "任务失败",
            "提交成功",
            "提交失败",
            "上传成功",
            "上传失败",
            "数据提交",
            "登录成功",
            "登录失败",
            "登出",
            "进入多账号模式",
            "退出多账号模式",
            "账号列表",
            "签到成功",
            "签到失败",
            "补签",
            "加载任务",
            "刷新任务",
            "选择任务",
            "[JS-Queue]",
            "无打卡点",
            "跳过: 任务",
          ];

          return coreKeywords.some((keyword) => message.includes(keyword));
        };
        const shouldShowInUI = isCoreLog(line, level);

        if (shouldShowInUI) {
          const single = $("log-text");
          if (single) {
            single.value += fullMessage + "\n";
            single.scrollTop = single.scrollHeight;
          }
          const multi = $("multi-log-text");
          if (multi) {
            multi.value += fullMessage + "\n";
            multi.scrollTop = multi.scrollHeight;
          }
          // ========================================
          // 【移动端日志同步】
          // ========================================
          const mobileLog = document.getElementById("mobile-log-text");
          if (mobileLog) {
            mobileLog.value += fullMessage + "\n";
            mobileLog.scrollTop = mobileLog.scrollHeight;
          }
        }
      }
      function logMessage_Debug(...args) {
        const msg = args.join(" ");
        logMessage(msg, "DEBUG");
      }
      function logMessage_Info(...args) {
        const msg = args.join(" ");
        logMessage(msg, "INFO");
      }
      function logMessage_Warning(...args) {
        const msg = args.join(" ");
        logMessage(msg, "WARNING");
      }
      function logMessage_Error(...args) {
        const msg = args.join(" ");
        logMessage(msg, "ERROR");
      }
      function logMessage_Critical(...args) {
        const msg = args.join(" ");
        logMessage(msg, "CRITICAL");
      }
      function showTab(tabName, element) {
        if (tabName !== "attendance" && notificationAutoRefreshTimer) {
          clearTimeout(notificationAutoRefreshTimer);
          notificationAutoRefreshTimer = null;
          logMessage_Info("[自动刷新] 已停止（切换到其他标签）");
        }
        [
          "run-control",
          "path-tools",
          "history",
          "params",
          "log",
          "checkpoints",
          "attendance",
        ].forEach((name) => {
          $(`${name}-tab`).classList.add("hidden");
          const b = document.querySelector(
            `button[onclick="showTab('${name}', this)"]`
          );
          if (b) b.classList.remove("active");
        });
        $(`${tabName}-tab`).classList.remove("hidden");
        if (element) element.classList.add("active");
        if (tabName === "attendance") {
          // refreshNotificationsUI() 会获取最新通知
          // onNotificationsUpdated() (由后台调用或 refreshNotificationsUI 间接调用) 会填充 attendance-list
          // refreshNotificationsUI() 自带防抖，所以这里直接调用是安全的
          logMessage_Info("[自动刷新] 切换到签到标签，启动自动刷新");
          refreshNotificationsUI(true, false); // 切换tab视为自动刷新，将开启定时刷新
        }
      }

      function autoLogin(user, pass) {
        if (!user || !pass) return;
        const userCombo = $("user-combo");
        userCombo.addEventListener("focus", refreshUserList);
        userCombo.addEventListener("click", refreshUserList);
        if ([...userCombo.options].some((o) => o.value === user))
          userCombo.value = user;
        else {
          const opt = document.createElement("option");
          opt.value = opt.textContent = user;
          userCombo.appendChild(opt);
          userCombo.value = user;
        }
        $("username-entry").value = user;
        $("password-entry").value = pass;
        onUserChange().then(() => $("login-button").click());
      }

      function createParamInputs(
        container,
        prefix,
        changeHandler,
        excludeGroups = []
      ) {
        container.innerHTML = "";
        let finalExclude = [...excludeGroups];
        if (prefix !== "multi-param") {
          finalExclude.push("自动签到");
        }
        paramGroups.forEach((group, index) => {
          if (finalExclude.includes(group.title)) {
            return;
          }
          if (excludeGroups.includes(group.title)) {
            return;
          }

          const header = document.createElement("h3");
          const marginTopClass = index === 0 ? "" : "mt-4";
          header.className = `text-base font-bold text-sky-700 ${marginTopClass} mb-2 border-b border-slate-200 pb-1`;
          header.textContent = group.title;
          container.appendChild(header);

          for (const key of group.keys) {
            const def = paramDefs[key];
            if (!def) continue;

            const div = document.createElement("div");
            div.className = "text-sm mb-3";

            const step =
              key.endsWith("_s") || key.endsWith("_mps") ? "0.1" : "1";
            const unitHtml = def.unit
              ? `<span class="ml-2 text-xs text-slate-500 select-none">${def.unit}</span>`
              : "";

            if (def.type === "theme_selector") {
              div.innerHTML = `
          <label class="block text-slate-700 font-semibold">${def.label}</label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
          <div class="grid grid-cols-3 gap-2 mt-2">
              <button onclick="setThemeStyle('default')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">默认</button>
              <button onclick="setThemeStyle('theme-anime')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">二次元</button>
              <button onclick="setThemeStyle('theme-minimalist')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">简约</button>
          </div>
        `;
            } else if (def.type === "color_picker") {
              div.innerHTML = `
          <label for="${prefix}-${key}" class="block text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center gap-3 mt-1">
            <input type="color" id="${prefix}-${key}-picker" data-key="${key}" class="w-10 h-10 rounded-full cursor-pointer border-2 border-white shadow-md" title="点击选择颜色">
            <input type="text" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" placeholder="#7dd3fc" title="${def.help}">
            <button onclick="resetBaseColorToDefault('${prefix}')" class="btn btn-ghost !py-1 !px-3 !text-xs flex-shrink-0">恢复默认</button>
          </div>
           <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
            } else if (
              def.type === "checkbox" ||
              key === "api_fallback_line" ||
              key === "ignore_task_time"
            ) {
              div.innerHTML = `
          <label class="flex items-center gap-2 cursor-pointer" title="${def.help}">
            <input type="checkbox" id="${prefix}-${key}" data-key="${key}" class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0">
            <span class="text-slate-700 font-semibold">${def.label}</span>
          </label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
            } else {
              div.innerHTML = `
          <label for="${prefix}-${key}" class="block mb-1 text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center">
            <input type="number" step="${step}" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" title="${def.help}">
            ${unitHtml}
          </div>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
            }

            container.appendChild(div);

            const inputs = div.querySelectorAll("input");
            inputs.forEach((input) => {
              if (input.type === "color") {
                input.addEventListener("input", (e) => {
                  const hexColor = e.target.value;
                  const textInput = document.getElementById(`${prefix}-${key}`);
                  if (textInput) textInput.value = hexColor;
                  setBaseColor(hexColor, hexColor);
                });
                input.addEventListener("change", changeHandler);
              } else if (input.type === "text" && key === "theme_base_color") {
                input.addEventListener("change", (e) => {
                  const hexColor = e.target.value;
                  const colorPicker = document.getElementById(
                    `${prefix}-${key}-picker`
                  );
                  if (colorPicker) colorPicker.value = hexColor;
                  setBaseColor(hexColor, hexColor);
                  changeHandler(e);
                });
              } else {
                input.addEventListener("change", changeHandler);
              }
            });
          }
        });
      }

      function updateParamInputs(container, prefix, params) {
        for (const key of Object.keys(paramDefs)) {
          const input = document.getElementById(`${prefix}-${key}`);
          if (!input || !params) continue;
          if (!(key in params)) continue;
          if (input.type === "checkbox") {
            input.checked = Boolean(params[key]);
          } else {
            input.value = params[key];
            if (key === "theme_base_color") {
              const colorPicker = document.getElementById(
                `${prefix}-${key}-picker`
              );
              if (colorPicker) {
                colorPicker.value = params[key];
              }
            }
          }
        }
      }

      function onParamChange(event) {
        const key = event.target.dataset.key;
        let value;
        if (event.target.type === "checkbox") value = event.target.checked;
        else value = event.target.value;
        pythonParams[key] = value;
        callPythonAPI("update_param", key, value);
        if (key === "ignore_task_time") {
          logMessage_Info(
            "参数 'ignore_task_time' 已更改，正在自动刷新任务列表..."
          );
          refreshTasks();
        }
      }
      function onGlobalParamChange(event) {
        const key = event.target.dataset.key;
        let value =
          event.target.type === "checkbox"
            ? event.target.checked
            : event.target.value;
        pythonParams[key] = value;
        callPythonAPI("update_param", key, value);
        if (key === "ignore_task_time") {
          updateAllAccountsStatusText();
        }
      }
      async function openAccountParamsModal(username) {
        const result = await callPythonAPI(
          "multi_get_account_params",
          username
        );
        if (!result.success) {
          showModalAlert(result.message);
          return;
        }
        $("account-params-title").textContent = `[${username}] 参数设置`;
        const container = $("account-params-container");
        createParamInputs(container, "acc-param", () => {}, ["主题与外观"]);
        updateParamInputs(container, "acc-param", result.params);

        $("save-account-params-btn").onclick = async () => {
          const inputs = container.querySelectorAll("input");
          for (const input of inputs) {
            const key = input.dataset.key;
            const value =
              input.type === "checkbox" ? input.checked : input.value;
            await callPythonAPI(
              "multi_update_account_param",
              username,
              key,
              value
            );
          }
          const modal = $("account-params-modal");
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          document.body.classList.remove("modal-visible");
        };
        const modal = $("account-params-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.classList.add("modal-visible");
      }
      function toggleUserDetails(show) {
        const modal = $("user-details-modal");
        modal.classList.toggle("hidden", !show);
        modal.classList.toggle("flex", show);
        const mapToToggle = !$("multi-account-app").classList.contains("hidden")
          ? multiAccountMap
          : map;
        if (show) {
          if (mapToToggle)
            mapToToggle.setStatus({
              dragEnable: false,
              scrollWheel: false,
              doubleClickZoom: false,
            });
          document.body.classList.add("modal-visible");
        } else {
          if (mapToToggle)
            mapToToggle.setStatus({
              dragEnable: true,
              scrollWheel: true,
              doubleClickZoom: true,
            });
          document.body.classList.remove("modal-visible");
        }
      }
      function toggleTaskDetails(show) {
        const modal = $("task-details-modal");
        modal.classList.toggle("hidden", !show);
        modal.classList.toggle("flex", show);

        const mapToToggle = !$("multi-account-app").classList.contains("hidden")
          ? multiAccountMap
          : map;
        if (show) {
          if (mapToToggle)
            mapToToggle.setStatus({
              dragEnable: false,
              scrollWheel: false,
              doubleClickZoom: false,
            });
          document.body.classList.add("modal-visible");
        } else {
          if (mapToToggle)
            mapToToggle.setStatus({
              dragEnable: true,
              scrollWheel: true,
              doubleClickZoom: true,
            });
          document.body.classList.remove("modal-visible");
        }
      }
      function showUserDetails() {
        if (!currentUserData || !currentUserData.student_id) {
          showModalAlert("请先成功登录");
          return;
        }
        const info = currentUserData;
        const content = $("user-details-content");
        content.innerHTML = "";
        const kv = {
          姓名: info.name,
          学号: info.student_id,
          用户名: info.username,
          性别: info.gender,
          学校: info.school_name,
          属性: info.attribute_type,
          手机号: info.phone,
          用户ID: info.id,
          身份证号: info.id_card,
          注册时间: info.registration_time,
          首次登录: info.first_login_time,
          上次登录: info.last_login_time,
          当前登录: info.current_login_time,
        };
        Object.entries(kv).forEach(([k, v]) => {
          const p = document.createElement("p");
          p.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">${k}:</span><span class="break-all">${
            v || "NULL"
          }</span>`;
          content.appendChild(p);
        });
        const uaText = IS_OFFLINE ? "NULL" : currentSessionUA || "NULL";
        const p_ua = document.createElement("p");
        p_ua.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">UA:</span><span class="break-all">${uaText}</span>`;
        content.appendChild(p_ua);

        toggleUserDetails(true);
      }

      function showTaskDetails() {
        if (!currentRunData || !currentRunData.run_name) {
          showModalAlert("请先选择任务");
          return;
        }
        const content = $("task-details-content");
        content.innerHTML = "";
        const kv = {
          任务名称: currentRunData.run_name,
          任务状态: currentRunData.status == 1 ? "已完成" : "未完成",
          任务ID: currentRunData.errand_id,
          计划ID: currentRunData.errand_schedule,
          开始时间: currentRunData.start_time,
          结束时间: currentRunData.end_time,
          上传时间: currentRunData.upload_time,
        };
        Object.entries(kv).forEach(([k, v]) => {
          const p = document.createElement("p");
          p.innerHTML = `<span class="font-bold w-28 inline-block text-left pr-2 text-slate-500">${k}:</span><span>${
            v || "NULL"
          }</span>`;
          content.appendChild(p);
        });
        const tpTitle = document.createElement("p");
        tpTitle.className = "font-bold text-slate-500 mt-2";
        tpTitle.textContent = "打卡点列表:";
        content.appendChild(tpTitle);
        (currentRunData.target_points || []).forEach((p, i) => {
          const name =
            (currentRunData.target_point_names || "").split("|")[i] ||
            `打卡点${i + 1}`;
          const div = document.createElement("div");
          div.className = "flex items-center gap-2 text-slate-600 ml-4";
          const numSpan = document.createElement("span");
          numSpan.className = "font-mono w-6 inline-block";
          numSpan.textContent = `${i + 1}.`;
          const nameSpan = document.createElement("span");
          nameSpan.textContent = name;
          const coordsSpan = document.createElement("span");
          coordsSpan.className = "text-xs text-slate-400";
          coordsSpan.textContent = `(${p[0].toFixed(5)}, ${p[1].toFixed(5)})`;
          div.append(numSpan, nameSpan, coordsSpan);
          content.appendChild(div);
        });
        toggleTaskDetails(true);
      }

      function toggleNotifications(show, forceDisableMap = false) {
        const modal = $("notifications-modal");
        modal.classList.toggle("hidden", !show);
        modal.classList.toggle("flex", show);

        const mapToToggle = !$("multi-account-app").classList.contains("hidden")
          ? multiAccountMap
          : map;

        if (show) {
          if (mapToToggle)
            mapToToggle.setStatus({
              dragEnable: false,
              scrollWheel: false,
              doubleClickZoom: false,
            });
          document.body.classList.add("modal-visible");
        } else {
          if (forceDisableMap) {
            if (mapToToggle)
              mapToToggle.setStatus({
                dragEnable: false,
                scrollWheel: false,
                doubleClickZoom: false,
              });
          } else {
            if (mapToToggle)
              mapToToggle.setStatus({
                dragEnable: true,
                scrollWheel: true,
                doubleClickZoom: true,
              });
          }
          document.body.classList.remove("modal-visible");
        }
      }

      async function fetchNotifications(limit = null, offset = 0) {
        if (IS_OFFLINE) {
          logMessage_Info("[通知] 离线模式下无法获取通知");
          return {
            success: true,
            unreadCount: 0,
            notices: [],
          };
        }

        logMessage_Debug("开始刷新通知", { limit, offset });
        const badge = $("notification-badge");
        let result = null;
        try {
          const params = {};
          if (limit !== null) {
            params.request_limit = limit;
            params.request_offset = offset;
          }

          result = await callPythonAPI("get_notifications", params);
          if (result && result.success) {
            if (offset === 0) {
              window.currentNotifications = result.notices || [];
            } else {
              window.currentNotifications = (
                window.currentNotifications || []
              ).concat(result.notices || []);
            }
            if (result.unreadCount > 0) {
              badge.textContent =
                result.unreadCount > 9 ? "9+" : result.unreadCount;
              badge.classList.remove("hidden");
            } else {
              badge.classList.add("hidden");
            }
            if (limit === null || offset === 0) {
              window.currentNotifications = result.notices || [];
            } else {
              window.currentNotifications = (
                window.currentNotifications || []
              ).concat(result.notices || []);
            }
          } else {
            badge.classList.add("hidden");
          }
        } catch (e) {
          logMessage_Error("Fetch notifications failed", e);
          badge.classList.add("hidden");
        }
        return result;
      }
      let notificationAutoRefreshTimer = null;
      async function refreshNotificationsUI(useCache = true, isManual = false) {
        if (isRefreshingNotifications) {
          logMessage_Info(
            "Notification refresh already in progress. Skipping."
          );
          return;
        }
        isRefreshingNotifications = true;
        const content = $("notifications-content");
        const refreshBtn = $("refresh-notifications-btn");
        const markReadBtn = $("mark-all-read-btn");
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.textContent = "刷新中...";
        }
        if (markReadBtn) markReadBtn.disabled = true;

        try {
          let cachedDisplayed = false;
          if (useCache && content) {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">正在加载缓存通知...</p>';
            try {
              const cachedResult = await callPythonAPI(
                "get_cached_notifications"
              );
              if (
                cachedResult &&
                cachedResult.success &&
                cachedResult.cached &&
                cachedResult.notices.length > 0
              ) {
                logMessage_Info(
                  `显示缓存的 ${cachedResult.notices.length} 条通知`
                );
                content.innerHTML = "";
                renderNotificationBatch(cachedResult.notices, content);
                cachedDisplayed = true;
                const badge = $("notification-badge");
                if (cachedResult.unreadCount > 0) {
                  badge.textContent =
                    cachedResult.unreadCount > 9
                      ? "9+"
                      : cachedResult.unreadCount;
                  badge.classList.remove("hidden");
                } else {
                  badge.classList.add("hidden");
                }
                const hasUnread = cachedResult.notices.some(
                  (n) => n.isRead == 0 || n.isRead === false
                );
                if (markReadBtn) markReadBtn.disabled = !hasUnread;
                const refreshingIndicator = document.createElement("div");
                refreshingIndicator.id = "refreshing-indicator";
                refreshingIndicator.className =
                  "p-3 text-center text-slate-400 text-sm";
                refreshingIndicator.innerHTML = "正在刷新最新通知...";
                if (content) content.appendChild(refreshingIndicator);
              }
            } catch (e) {
              logMessage_Warning("获取缓存通知失败，将直接加载最新通知", e);
            }
          }
          if (!cachedDisplayed && content) {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">正在加载通知...</p>';
          }
          let currentOffset = 0;
          const batchSize = cachedDisplayed ? 5000 : 5;
          let hasMore = true;
          let firstLoad = true;
          let finalResult = null;
          function startAutoRefreshTimer() {
            if (!isManual) {
              if (notificationAutoRefreshTimer) {
                clearTimeout(notificationAutoRefreshTimer);
                notificationAutoRefreshTimer = null;
              }
              const refreshIntervalInput = $("param-auto_attendance_refresh_s");
              const refreshInterval = refreshIntervalInput
                ? parseInt(refreshIntervalInput.value)
                : 300;
              if (refreshInterval > 0) {
                logMessage_Info(
                  `[自动刷新] (加载完成) 将在 ${refreshInterval} 秒后自动刷新通知`
                );
                notificationAutoRefreshTimer = setTimeout(() => {
                  logMessage_Info("[自动刷新] 正在自动刷新通知...");
                  refreshNotificationsUI(true, false);
                }, refreshInterval * 1000);
              }
            }
          }
          const loadNextBatch = async () => {
            if (!hasMore) {
              if (finalResult) {
                onNotificationsUpdated(finalResult);
              }
              logMessage_Info("所有通知加载完成（模态框）");
              startAutoRefreshTimer();
              return;
            }
            logMessage_Info(
              `正在加载通知：offset=${currentOffset}, limit=${batchSize}`
            );
            const result = await fetchNotifications(batchSize, currentOffset);
            if (firstLoad) {
              finalResult = result;
            }
            if (!result || !result.success) {
              if (firstLoad && !cachedDisplayed) {
                content.innerHTML =
                  '<p class="text-red-500 text-center py-10">加载失败，请稍后重试</p>';
              }
              return;
            }
            const notices = result.notices || [];

            if (firstLoad && content) {
              content.innerHTML = "";
              firstLoad = false;
              logMessage_Info(
                `首批新通知加载完成，${
                  cachedDisplayed ? "已替换" : "正在显示"
                }缓存数据`
              );
            }

            if (notices.length === 0 && currentOffset === 0 && content) {
              content.innerHTML =
                '<p class="text-slate-400 text-center py-10">暂无通知</p>';
              if (markReadBtn) markReadBtn.disabled = true;
              return;
            }
            const oldIndicator = $("loading-more-indicator");
            if (oldIndicator) {
              oldIndicator.remove();
            }
            if (notices.length > 0 && content) {
              logMessage_Info(
                `第${
                  Math.floor(currentOffset / batchSize) + 1
                }批加载完成：显示 ${notices.length} 条通知`
              );
              renderNotificationBatch(notices, content);
              const allNotices = window.currentNotifications || [];
              const hasUnread = allNotices.some(
                (n) => n.isRead == 0 || n.isRead === false
              );
              if (markReadBtn) markReadBtn.disabled = !hasUnread;
            }
            currentOffset += batchSize;
            hasMore = result.hasMore || false;
            if (hasMore && content) {
              const loadingMore = document.createElement("div");
              loadingMore.id = "loading-more-indicator";
              loadingMore.className = "p-3 text-center text-slate-400 text-sm";
              loadingMore.innerHTML = "正在加载更多通知...";
              content.appendChild(loadingMore);
              setTimeout(loadNextBatch, 100);
            } else {
              if (finalResult) {
                onNotificationsUpdated(finalResult);
              }
              logMessage_Info("所有通知加载完成（模态框）");

              startAutoRefreshTimer();
            }
          };

          await loadNextBatch();
        } catch (e) {
          logMessage_Error("Failed to refresh notifications UI", e);
          content.innerHTML =
            '<p class="text-red-500 text-center py-10">刷新失败，请稍后重试</p>';
        } finally {
          if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.textContent = "刷新";
          }
          isRefreshingNotifications = false;
        }
      }
      function renderNotificationBatch(notices, container) {
        if (!notices || notices.length === 0) return;

        for (const n of notices) {
          const item = document.createElement("div");
          item.className = "p-3 border-b border-slate-200";
          item.id = `notice-${n.id}`;

          const isEffectivelyRead = n.isRead == 1 || n.isRead === true;
          const isReadClass = isEffectivelyRead ? "opacity-60" : "font-bold";
          let readButtonHtml = "";
          if (!isEffectivelyRead) {
            readButtonHtml = `<button class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600" onclick="markAsRead(event, '${n.id}')">设为已读</button>`;
          }
          let attendanceHtml = "";
          const isAttendanceTask =
            n.image === "attendance" || (n.title && n.title.includes("签到"));

          if (isAttendanceTask && n.id) {
            switch (n.attendance_code) {
              case -1:
                try {
                  const coordsStr = (n.updateBy || "").trim();
                  const [lat, lon] = coordsStr.split(",").map(Number);
                  if (isNaN(lon) || isNaN(lat)) {
                    attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">已过期</span> <span class="text-xs text-slate-400">(坐标无效)</span>`;
                  } else {
                    const targetCoords = `[${lon}, ${lat}]`;
                    attendanceHtml = `
                      <span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">已过期</span>
                      <div class="relative inline-block group">
                        <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="补签此任务">
                          <span>补签</span>
                          <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                        </button>
                        <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                          <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">随机补签</button>
                          <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">手动选点补签</button>
                        </div>
                      </div>
                    `;
                  }
                } catch (e) {
                  attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">已过期</span> <span class="text-xs text-slate-400">(坐标解析失败)</span>`;
                }
                break;
              case 1:
                attendanceHtml = `<span class="text-xs font-semibold text-emerald-600 px-2 py-0.5 rounded-full bg-emerald-100">已签到</span>`;
                break;
              case 0:
                try {
                  const coordsStr = (n.updateBy || "").trim();
                  const [lat, lon] = coordsStr.split(",").map(Number);

                  if (!isNaN(lon) && !isNaN(lat)) {
                    const rollCallId = n.id;
                    const targetCoords = `[${lon}, ${lat}]`;

                    attendanceHtml = `
                    <div class="relative inline-block group">
                      <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                        <span>签到</span>
                        <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                      </button>
                      <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                        <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${rollCallId}', ${targetCoords})">随机签到</button>
                        <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${rollCallId}', ${targetCoords})">手动选点</button>
                      </div>
                    </div>
                    <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${rollCallId}', ${targetCoords})">
                      补签
                    </button>
                  `;
                  } else {
                    attendanceHtml = `<span class="text-xs text-slate-400">坐标无效</span>`;
                  }
                } catch (e) {
                  logMessage_Error("解析签到坐标失败:", e, n.updateBy);
                  attendanceHtml = `<span class="text-xs text-red-500">数据错误</span>`;
                }
                break;
              default:
                attendanceHtml = `<span class="text-xs text-slate-400">状态未知</span>`;
            }
          }

          item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-base text-slate-800 ${isReadClass}">${n.title}</span>
            <div class="flex items-center gap-2">
              ${readButtonHtml}
              ${attendanceHtml}
              <span class="text-xs text-slate-500 flex-shrink-0">${n.createtime}</span>
            </div>
          </div>
          <p class="text-sm text-slate-600 mt-1 ${isReadClass}">${n.content}</p>
        `;
          container.appendChild(item);
        }
      }

      function showNotifications() {
        if (IS_OFFLINE) {
          const content = $("notifications-content");
          if (content) {
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10">离线模式下无法获取通知</p>';
          }
          toggleNotifications(true);

          logMessage_Info("[通知] 离线模式下无法获取通知，已显示提示信息");
          return;
        }
        toggleNotifications(true);
        refreshNotificationsUI(true, true);
      }
      function onNotificationsUpdated(result) {
        if (!result || !result.success) {
          logMessage_Info("[后台刷新] 获取通知失败");
          return;
        }

        logMessage_Info(
          `[后台刷新] 收到 ${result.unreadCount} 未读, ${result.notices.length} 总数`
        );
        const badge = $("notification-badge");
        if (result.unreadCount > 0) {
          badge.textContent =
            result.unreadCount > 9 ? "9+" : result.unreadCount;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
        const attList = $("attendance-list");
        if (attList) {
          attList.innerHTML = "";
          const attendanceNotices = (window.currentNotifications || []).filter(
            (n) =>
              n.image === "attendance" || (n.title && n.title.includes("签到"))
          );
          if (attendanceNotices.length === 0) {
            attList.innerHTML =
              '<p class="text-slate-400 text-center py-10 text-xs">暂无签到任务</p>';
          } else {
            attendanceNotices.forEach((n) => {
              const item = document.createElement("div");
              item.className = "p-2 border-b border-slate-100";
              let statusText = "未知";
              let statusClass = "text-slate-500";
              let buttonHtml = "";
              let targetCoords = "null";
              let canSign = false;
              try {
                const coordsStr = (n.updateBy || "").trim();
                const [lat, lon] = coordsStr.split(",").map(Number);
                if (!isNaN(lon) && !isNaN(lat)) {
                  targetCoords = `[${lon}, ${lat}]`;
                  canSign = true;
                }
              } catch (e) {}
              switch (n.attendance_code) {
                case -1:
                  statusText = "已过期";
                  statusClass = "text-red-600 font-semibold";
                  if (canSign) {
                    buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="补签此任务">
                    <span>补签</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">随机补签</button>
                    <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">手动选点补签</button>
                  </div>
                </div>
              `;
                  }
                  break;
                case 1:
                  statusText = "已签到";
                  statusClass = "text-emerald-600 font-semibold";
                  break;
                case 0:
                  statusText = "待签到";
                  statusClass = "text-sky-600 font-bold";
                  if (canSign) {
                    buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                    <span>签到</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${n.id}', ${targetCoords})">随机签到</button>
                    <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${n.id}', ${targetCoords})">手动选点</button>
                  </div>
                </div>
                <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                  补签
                </button>
              `;
                  }
                  break;
                default:
                  statusText = "状态未知";
                  statusClass = "text-slate-400";
              }
              if (
                n.attendance_status_text &&
                n.attendance_status_text.includes("失败")
              ) {
                statusText = n.attendance_status_text;
                statusClass = "text-red-700 font-bold";
              }
              item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-sm font-semibold text-slate-700">${n.title}</span>
            <span class="text-xs ${statusClass} flex-shrink-0">${statusText}</span>
          </div>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-slate-500">${n.content}</span>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-slate-400">${n.createtime}</span>
              ${buttonHtml}
            </div>
          </div>
        `;
              attList.appendChild(item);
            });
          }
        }
        const modal = $("notifications-modal");
        syncMobileAttendanceList();
      }
      async function handleAttendance(event, rollCallId, targetCoords) {
        event.stopPropagation();
        logMessage_Info(`正在为您自动签到... 活动ID: ${rollCallId}`);
        const result = await callPythonAPI(
          "trigger_attendance",
          rollCallId,
          targetCoords,
          "random",
          null,
          false
        );
        if (result.success) {
          logMessage_Info(`签到成功: ${result.message}`);
          showModalAlert(`签到成功: ${result.message}`);
        } else {
          logMessage_Info(`签到失败: ${result.message}`);
          showModalAlert(`签到失败: ${result.message}`);
        }
        await fetchNotifications();
        showNotifications();
      }

      const svgIconNormal = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path fill="#22d3ee" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

      const svgIconMakeup = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path fill="#f59e0b" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

      async function handleManualAttendance(event, rollCallId, targetCoords) {
        event.stopPropagation();
        toggleNotifications(false, true);

        selectedTaskIndex = -1;
        renderTaskList();
        drawOnMap();

        logMessage_Info("请在地图上单击选择签到点...");

        if (tempAttendanceMarker && map) {
          map.remove(tempAttendanceMarker);
          tempAttendanceMarker = null;
        }
        if (tempAttendanceCircle && map) {
          map.remove(tempAttendanceCircle);
          tempAttendanceCircle = null;
        }
        const radius =
          currentUserData && currentUserData.server_attendance_radius_m
            ? currentUserData.server_attendance_radius_m
            : 0.0;
        const position = new AMapInstance.LngLat(
          targetCoords[0],
          targetCoords[1]
        );
        tempAttendanceMarker = new AMapInstance.Marker({
          position: position,
          content: svgIconNormal,
          clickable: false,
          anchor: "bottom-center",
          zIndex: 200,
        });
        tempAttendanceCircle = new AMapInstance.Circle({
          center: position,
          radius: radius,
          strokeColor: "#00BFFF",
          strokeOpacity: 1,
          strokeWeight: 2,
          fillColor: "#00BFFF",
          fillOpacity: 0.2,
          zIndex: 199,
          bubble: true,
          clickable: false,
        });
        map.add(tempAttendanceMarker);
        map.add(tempAttendanceCircle);

        map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);
        const infoMarker = new AMapInstance.Text({
          text: "已显示签到区域，请在地图上单击选点",
          position: position,
          anchor: "bottom-center",
          offset: new AMapInstance.Pixel(0, -40),
          clickable: false,
          style: {
            "background-color": "#fff",
            padding: "5px 10px",
            "border-radius": "5px",
            "box-shadow": "0 2px 4px rgba(0,0,0,0.2)",
            "pointer-events": "none",
          },
        });
        map.add(infoMarker);
        const onMapClick = async (e) => {
          map.off("click", onMapClick);
          map.remove(infoMarker);
          const clickedLngLat = e.lnglat;
          const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];
          const distance = fastDistanceMeters(
            clickedLngLat.lng,
            clickedLngLat.lat,
            targetCoords[0],
            targetCoords[1]
          );
          if (distance > radius) {
            logMessage_Info(
              `选点失败：距离 ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`
            );
            showModalAlert(
              "您选择的点不在签到范围内，请重新在地图上单击选点。",
              "选点无效"
            );
            map.add(infoMarker);
            map.on("click", onMapClick);
            return;
          }
          logMessage_Info(
            `已选择签到点: ${specificCoords.join(
              ", "
            )} (距离 ${distance.toFixed(1)}m)`
          );
          try {
            const result = await callPythonAPI(
              "trigger_attendance",
              rollCallId,
              targetCoords,
              "specific",
              specificCoords,
              false
            );
            if (result.success) {
              logMessage_Info(`签到成功: ${result.message}`);
              showModalAlert(`签到成功: ${result.message}`);
            } else {
              logMessage_Info(`签到失败: ${result.message}`);
              showModalAlert(`签到失败: ${result.message}`);
            }
          } catch (err) {
            logMessage_Info(`签到时发生JS错误: ${err}`);
          } finally {
            if (tempAttendanceMarker && map) {
              map.remove(tempAttendanceMarker);
              tempAttendanceMarker = null;
            }
            if (tempAttendanceCircle && map) {
              map.remove(tempAttendanceCircle);
              tempAttendanceCircle = null;
            }
            if (map) {
              map.setStatus({
                dragEnable: true,
                scrollWheel: true,
                doubleClickZoom: true,
              });
            }

            await fetchNotifications();
          }
        };

        map.on("click", onMapClick);
      }

      async function handleMakeupAttendance(event, rollCallId, targetCoords) {
        event.stopPropagation();
        logMessage_Info(`正在为您 [补签]... 活动ID: ${rollCallId}`);
        const result = await callPythonAPI(
          "trigger_attendance",
          rollCallId,
          targetCoords,
          "random",
          null,
          true
        );
        if (result.success) {
          logMessage_Info(`补签成功: ${result.message}`);
          showModalAlert(`补签成功: ${result.message}`);
        } else {
          logMessage_Info(`补签失败: ${result.message}`);
          showModalAlert(`补签失败: ${result.message}`);
        }
        await fetchNotifications();
      }
      async function handleManualMakeupAttendance(
        event,
        rollCallId,
        targetCoords
      ) {
        event.stopPropagation();
        toggleNotifications(false, true);
        selectedTaskIndex = -1;
        renderTaskList();
        drawOnMap();
        logMessage_Info("请在地图上单击选择 [补签] 点...");
        if (tempAttendanceMarker && map) {
          map.remove(tempAttendanceMarker);
          tempAttendanceMarker = null;
        }
        if (tempAttendanceCircle && map) {
          map.remove(tempAttendanceCircle);
          tempAttendanceCircle = null;
        }
        const radius =
          currentUserData && currentUserData.server_attendance_radius_m
            ? currentUserData.server_attendance_radius_m
            : 0.0;
        const position = new AMapInstance.LngLat(
          targetCoords[0],
          targetCoords[1]
        );
        logMessage_Info(
          `系统签到点: ${targetCoords[0]}, ${targetCoords[1]} (半径: ${radius}米)`
        );
        tempAttendanceMarker = new AMapInstance.Marker({
          position: position,
          content: svgIconMakeup,
          clickable: false,
          anchor: "bottom-center",
          zIndex: 200,
        });
        tempAttendanceCircle = new AMapInstance.Circle({
          center: position,
          radius: radius,
          strokeColor: "#F7B731",
          strokeOpacity: 1,
          strokeWeight: 2,
          fillColor: "#F7B731",
          fillOpacity: 0.2,
          zIndex: 199,
          bubble: true,
          clickable: false,
        });

        map.add(tempAttendanceMarker);
        map.add(tempAttendanceCircle);
        map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);
        const infoMarker = new AMapInstance.Text({
          text: "已显示签到区域，请在地图上单击选点 [补签]",
          position: position,
          anchor: "bottom-center",
          offset: new AMapInstance.Pixel(0, -40),
          clickable: false,
          style: {
            "background-color": "#fff",
            padding: "5px 10px",
            "border-radius": "5px",
            "box-shadow": "0 2px 4px rgba(0,0,0,0.2)",
            "pointer-events": "none",
          },
        });
        map.add(infoMarker);
        const onMapClick = async (e) => {
          map.off("click", onMapClick);
          map.remove(infoMarker);
          const clickedLngLat = e.lnglat;
          const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];
          const distance = fastDistanceMeters(
            clickedLngLat.lng,
            clickedLngLat.lat,
            targetCoords[0],
            targetCoords[1]
          );
          if (distance > radius) {
            logMessage_Info(
              `[补签] 选点失败：距离 ${distance.toFixed(1)}m > ${radius.toFixed(
                1
              )}m`
            );
            showModalAlert(
              "您选择的点不在签到范围内，请重新在地图上单击选点。",
              "选点无效"
            );
            map.add(infoMarker);
            map.on("click", onMapClick);
            return;
          }
          logMessage_Info(
            `已选择 [补签] 点: ${specificCoords.join(
              ", "
            )} (距离 ${distance.toFixed(1)}m)`
          );

          try {
            const result = await callPythonAPI(
              "trigger_attendance",
              rollCallId,
              targetCoords,
              "specific",
              specificCoords,
              true
            );
            if (result.success) {
              logMessage_Info(`补签成功: ${result.message}`);
              showModalAlert(`补签成功: ${result.message}`);
            } else {
              logMessage_Info(`补签失败: ${result.message}`);
              showModalAlert(`补签失败: ${result.message}`);
            }
          } catch (err) {
            logMessage_Info(`补签时发生JS错误: ${err}`);
          } finally {
            if (tempAttendanceMarker && map) {
              map.remove(tempAttendanceMarker);
              tempAttendanceMarker = null;
            }
            if (tempAttendanceCircle && map) {
              map.remove(tempAttendanceCircle);
              tempAttendanceCircle = null;
            }
            if (map) {
              map.setStatus({
                dragEnable: true,
                scrollWheel: true,
                doubleClickZoom: true,
              });
            }

            await fetchNotifications();
          }
        };

        map.on("click", onMapClick);
      }

      async function markAsRead(event, noticeId) {
        event.stopPropagation();
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = "...";

        try {
          const result = await callPythonAPI(
            "mark_notification_read",
            noticeId
          );
          if (result.success) {
            await fetchNotifications();
            showNotifications();
          } else {
            showModalAlert(result.message || "标记已读失败");
            btn.disabled = false;
            btn.textContent = "设为已读";
          }
        } catch (e) {
          logMessage_Error("markAsRead failed:", e);
          btn.disabled = false;
          btn.textContent = "设为已读";
        }
      }
      async function markAllAsRead() {
        const btn = $("mark-all-read-btn");
        btn.disabled = true;
        btn.textContent = "处理中...";
        const unreadNotices = (window.currentNotifications || []).filter(
          (n) => !n.isRead
        );
        if (unreadNotices.length === 0) {
          btn.textContent = "一键已读";
          return;
        }
        try {
          const promises = unreadNotices.map((n) =>
            callPythonAPI("mark_notification_read", n.id)
          );
          await Promise.all(promises);
          logMessage_Info(
            `“一键已读”操作完成，共处理 ${unreadNotices.length} 条。`
          );
        } catch (e) {
          logMessage_Error("markAllAsRead failed:", e);
          logMessage_Info(`“一键已读”时发生错误: ${e}`);
        } finally {
          await fetchNotifications();
          showNotifications();
          btn.disabled =
            (window.currentNotifications || []).filter((n) => !n.isRead)
              .length === 0;
          btn.textContent = "一键已读";
        }
      }
      $("multi-remove-all-btn").addEventListener("click", multi_removeAll);
      $("multi-remove-selected-btn").addEventListener(
        "click",
        multi_removeSelected
      );
      $("multi-refresh-all-btn").addEventListener("click", multi_refreshAll);
      $("multi-select-all-check").addEventListener(
        "change",
        multi_toggleSelectAll
      );
      $("multi-start-selected-btn").addEventListener(
        "click",
        multi_startSelected
      );
      $("multi-stop-selected-btn").addEventListener(
        "click",
        multi_stopSelected
      );
      $("multi-refresh-selected-btn").addEventListener(
        "click",
        multi_refreshSelected
      );
    </script>
    <div id="modify-phone-modal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-slate-800">修改绑定手机号</h3>
          <button
            onclick="closeModifyPhoneModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >当前手机号</label
            >
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+86 </span>
              <input
                type="tel"
                id="modify-phone-current"
                class="input-field"
                readonly
              />
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >新手机号</label
            >
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+86 </span>
              <input
                type="tel"
                id="modify-phone-new"
                class="input-field"
                placeholder="请输入新手机号"
                inputmode="numeric"
                pattern="[0-9]*"
                style="min-height: 44px"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >短信验证码</label
            >
            <div class="flex gap-2">
              <input
                type="text"
                id="modify-phone-code"
                class="input-field flex-1"
                placeholder="请输入验证码"
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
                style="min-height: 44px"
              />
              <button
                onclick="sendModifyPhoneCode()"
                id="modify-phone-send-btn"
                class="btn btn-primary whitespace-nowrap"
                style="min-height: 44px"
              >
                发送验证码
              </button>
            </div>
          </div>

          <div class="flex gap-3 pt-4">
            <button
              onclick="confirmModifyPhone()"
              class="btn btn-success flex-1"
              style="min-height: 44px"
            >
              确认修改
            </button>
            <button
              onclick="closeModifyPhoneModal()"
              class="btn btn-ghost flex-1"
              style="min-height: 44px"
            >
              取消
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== 移动端UI交互函数 ====================
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      function switchMobileNotifTab(tabName) {
        const allTab = document.getElementById("mobile-notif-tab-all");
        const attTab = document.getElementById("mobile-notif-tab-attendance");
        const allList = document.getElementById(
          "mobile-all-notifications-list"
        );
        const attList = document.getElementById(
          "mobile-attendance-notifications-list"
        );
        if (tabName === "all") {
          allTab.className =
            "flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition";
          attTab.className =
            "flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition";
          allList.classList.remove("hidden");
          attList.classList.add("hidden");
        } else {
          attTab.className =
            "flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition";
          allTab.className =
            "flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition";
          attList.classList.remove("hidden");
          allList.classList.add("hidden");
        }
      }
      async function mobileRefreshNotifications() {
        const btn = document.getElementById("mobile-refresh-notifications-btn");
        if (btn) {
          btn.disabled = true;
          const originalText = (btn.textContent || "").trim();
        }

        try {
          await fetchNotifications();
          updateMobileNotificationUI();
        } catch (error) {
          console.error("刷新通知失败:", error);
          showTempMessage("刷新通知失败，请稍后重试", "error");
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent =
              typeof originalText !== "undefined" ? originalText : "刷新";
          }
        }
      }
      function updateMobileNotificationUI() {
        const notifications = window.currentNotifications || [];
        const badge = document.getElementById("mobile-notification-badge");
        const unreadCount = notifications.filter((n) => !n.isRead).length;
        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? "9+" : unreadCount;
            badge.classList.remove("hidden");
          } else {
            badge.classList.add("hidden");
          }
        }
        const attendanceNotices = notifications.filter(
          (n) =>
            n.image === "attendance" || (n.title && n.title.includes("签到"))
        );
        const regularNotices = notifications;
        const allList = document.getElementById(
          "mobile-all-notifications-list"
        );
        if (allList) {
          if (regularNotices.length === 0) {
            allList.innerHTML =
              '<p class="text-slate-400 text-center py-8 text-sm">暂无通知</p>';
          } else {
            allList.innerHTML = "";
            regularNotices.forEach((notice) => {
              const item = document.createElement("div");
              item.className =
                "mobile-list-item " + (notice.isRead ? "opacity-60" : "");
              item.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${escapeHtml(
                    notice.title
                  )}</span>
                  <span class="text-xs text-slate-400">${escapeHtml(
                    notice.createtime
                  )}</span>
                </div>
                <p class="text-xs text-slate-600">${escapeHtml(
                  notice.content
                )}</p>
              </div>
              ${
                !notice.isRead
                  ? '<span class="ml-2 w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></span>'
                  : ""
              }
            `;
              item.addEventListener("click", () =>
                markMobileNotificationRead(notice.id)
              );
              allList.appendChild(item);
            });
          }
        }

        const attList = document.getElementById(
          "mobile-attendance-notifications-list"
        );
        if (attList) {
          if (attendanceNotices.length === 0) {
            attList.innerHTML =
              '<p class="text-slate-400 text-center py-8 text-sm">暂无签到任务</p>';
          } else {
            attList.innerHTML = "";
            attendanceNotices.forEach((notice) => {
              const item = document.createElement("div");
              item.className = "mobile-list-item";
              let statusBadge = "";
              let actionButtons = "";

              if (notice.attendance_code === -1) {
                statusBadge =
                  '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-600">已过期</span>';
              } else if (notice.attendance_code === 1) {
                statusBadge =
                  '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-600">已签到</span>';
              } else if (notice.attendance_code === 0) {
                statusBadge =
                  '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-600">待签到</span>';
                actionButtons = `
                <button class="py-1 px-3 bg-sky-500 text-white rounded-lg text-xs font-medium hover:bg-sky-600 transition" onclick="event.stopPropagation(); mobileHandleAttendance('${notice.id}')">
                  签到
                </button>
              `;
              }

              item.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${escapeHtml(
                    notice.title
                  )}</span>
                  ${statusBadge}
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">${escapeHtml(
                    notice.content
                  )}</span>
                  <span class="text-xs text-slate-400 ml-2">${escapeHtml(
                    notice.createtime
                  )}</span>
                </div>
              </div>
              ${actionButtons}
            `;
              attList.appendChild(item);
            });
          }
        }
      }
      function syncMobileAttendanceList() {
        const mobileAttList = document.getElementById("mobile-attendance-list");
        if (!mobileAttList) return;
        const notifications = window.currentNotifications || [];
        const attendanceNotices = notifications.filter(
          (n) =>
            n.image === "attendance" || (n.title && n.title.includes("签到"))
        );
        mobileAttList.innerHTML = "";
        if (attendanceNotices.length === 0) {
          mobileAttList.innerHTML =
            '<p class="text-slate-400 text-center py-8 text-sm">暂无签到任务</p>';
          return;
        }
        attendanceNotices.forEach((n) => {
          const item = document.createElement("div");
          item.className =
            "bg-white rounded-lg p-3 border border-slate-200 mb-2";
          let statusText = "未知";
          let statusClass = "text-slate-500";
          let buttonHtml = "";
          let targetCoords = "null";
          let canSign = false;
          try {
            const coordsStr = (n.updateBy || "").trim();
            const [lat, lon] = coordsStr.split(",").map(Number);
            if (!isNaN(lon) && !isNaN(lat)) {
              targetCoords = `[${lon}, ${lat}]`;
              canSign = true;
            }
          } catch (e) {}
          switch (n.attendance_code) {
            case -1:
              statusText = "已过期";
              statusClass = "text-red-600 font-semibold";
              if (canSign) {
                buttonHtml = `
                <button class="w-full mt-2 py-2 px-4 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition" 
                  onclick="event.stopPropagation(); handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                  随机补签
                </button>
              `;
              }
              break;
            case 1:
              statusText = "已签到";
              statusClass = "text-emerald-600 font-semibold";
              break;
            case 0:
              statusText = "待签到";
              statusClass = "text-sky-600 font-bold";
              if (canSign) {
                buttonHtml = `
                <div class="space-y-2 mt-2">
                  <!-- 第一行：随机签到和随机补签 -->
                  <div class="flex gap-2">
                    <button class="flex-1 py-2 px-4 bg-sky-500 text-white rounded-lg text-sm font-medium hover:bg-sky-600 transition" 
                      onclick="event.stopPropagation(); handleAttendance(event, '${n.id}', ${targetCoords})">
                      随机签到
                    </button>
                    <button class="flex-1 py-2 px-4 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition" 
                      onclick="event.stopPropagation(); handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                      随机补签
                    </button>
                  </div>
                  <!-- 第二行：地图选点签到按钮 -->
                  <button class="w-full py-2 px-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg text-sm font-bold hover:from-purple-600 hover:to-purple-700 transition-all shadow-md flex items-center justify-center gap-2" 
                    onclick="event.stopPropagation(); openMobileMapAttendanceModal('${n.id}', ${targetCoords})">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    📍 地图选点签到
                  </button>
                </div>
              `;
              }
              break;
            default:
              statusText = "状态未知";
              statusClass = "text-slate-400";
          }
          if (
            n.attendance_status_text &&
            n.attendance_status_text.includes("失败")
          ) {
            statusText = n.attendance_status_text;
            statusClass = "text-red-700 font-bold";
          }
          item.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <p class="text-sm font-semibold text-slate-800 mb-1">${n.title}</p>
              <p class="text-xs text-slate-600">${n.content}</p>
            </div>
            <span class="text-xs ${statusClass} ml-2 flex-shrink-0">${statusText}</span>
          </div>
          <div class="text-xs text-slate-400">${n.createtime}</div>
          ${buttonHtml}
        `;
          mobileAttList.appendChild(item);
        });
      }
      async function markMobileNotificationRead(noticeId) {
        try {
          const result = await callPythonAPI(
            "mark_notification_read",
            noticeId
          );
          if (result.success) {
            await mobileRefreshNotifications();
          }
        } catch (error) {
          console.error("标记已读失败:", error);
        }
      }
      async function mobileMarkAllAsRead() {
        const notifications = window.currentNotifications || [];
        const unreadNotices = notifications.filter((n) => !n.isRead);

        if (unreadNotices.length === 0) {
          showTempMessage("没有未读通知", "info");
          return;
        }
        try {
          const promises = unreadNotices.map((n) =>
            callPythonAPI("mark_notification_read", n.id)
          );
          await Promise.all(promises);

          await mobileRefreshNotifications();
          showTempMessage("已全部标记为已读", "success");
        } catch (error) {
          console.error("一键已读失败:", error);
          showTempMessage("操作失败，请稍后重试", "error");
        }
      }
      function expandMobileNotifications() {
        showNotifications();
      }
      async function mobileHandleAttendance(rollCallId) {
        const notifications = window.currentNotifications || [];
        const notice = notifications.find((n) => n.id === rollCallId);

        if (!notice) {
          showTempMessage("未找到签到活动信息", "error");
          return;
        }
        try {
          const coordsStr = (notice.updateBy || "").trim();
          const [lat, lon] = coordsStr.split(",").map(Number);
          if (isNaN(lon) || isNaN(lat)) {
            showTempMessage("签到坐标无效", "error");
            return;
          }
          const targetCoords = [lon, lat];
          const result = await callPythonAPI(
            "trigger_attendance",
            rollCallId,
            targetCoords,
            "random",
            null,
            false
          );
          if (result.success) {
            showTempMessage("签到成功！", "success");
            await mobileRefreshNotifications();
          } else {
            showTempMessage("签到失败: " + result.message, "error");
          }
        } catch (error) {
          console.error("签到失败:", error);
          showTempMessage("签到失败，请稍后重试", "error");
        }
      }
      async function mobileRefreshTasks() {
        try {
          showTempMessage("正在刷新任务列表...", "info");
          await refreshTasks();
          showTempMessage("任务列表已刷新", "success");
        } catch (error) {
          console.error("[移动端] 刷新任务列表失败:", error);
          showTempMessage("刷新任务列表失败", "error");
        }
      }
      let mobileTaskRunning = false;
      let mobileTaskPaused = false;
      function updateMobileTaskUI(status, detail = "") {
        const statusIndicator = $("mobile-status-indicator");
        const statusDetail = $("mobile-status-detail");
        const startBtn = $("mobile-start-btn");
        const stopBtn = $("mobile-stop-btn");
        if (statusIndicator) {
          statusIndicator.textContent = status;
          statusIndicator.className =
            "text-xs font-semibold px-2 py-1 rounded-full";
          if (status === "运行中") {
            statusIndicator.className += " bg-green-200 text-green-600";
          } else if (status === "已暂停") {
            statusIndicator.className += " bg-yellow-200 text-yellow-600";
          } else if (status === "已停止") {
            statusIndicator.className += " bg-red-200 text-red-600";
          } else if (status === "已完成") {
            statusIndicator.className += " bg-blue-200 text-blue-600";
          } else {
            statusIndicator.className += " bg-slate-200 text-slate-600";
          }
        }
        if (statusDetail) {
          statusDetail.textContent = detail || "等待执行任务";
        }
        if (startBtn && stopBtn) {
          if (status === "运行中") {
            startBtn.disabled = true;
            stopBtn.disabled = false;
          } else if (status === "已暂停") {
            startBtn.disabled = false;
            stopBtn.disabled = false;
          } else if (status === "已完成") {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            mobileTaskRunning = false;
            mobileTaskPaused = false;
          } else {
            startBtn.disabled = false;
            stopBtn.disabled = true;
          }
        }
      }
      function updateMobileProgress(percent, text) {
        const progressBar = $("mobile-progress-bar");
        const progressText = $("mobile-progress-text");
        if (progressBar) {
          progressBar.style.width = percent + "%";
        }
        if (progressText) {
          progressText.textContent = text || percent + "%";
        }
      }
      function mobileAddTask() {
        addTask();
      }
      async function mobileStartTask() {
        try {
          if (selectedTaskIndex < 0 || selectedTaskIndex === -1) {
            showModalAlert("请先选择一个任务再开始执行", "未选择任务");
            return;
          }
          const statusRes = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );
          const isBackendRunning =
            statusRes.success &&
            statusRes.task_status &&
            statusRes.task_status.status === "running";
          if (isBackendRunning) {
            mobileTaskRunning = true;
            mobileTaskPaused = false;
            updateMobileTaskUI("运行中", "后台已有任务在运行");
            showTempMessage("后台已有任务在运行，无法启动新任务", "warning");
            if (!backgroundTaskPollInterval) {
              startBackgroundTaskPolling();
            }
            return;
          }
          if (mobileTaskRunning && !mobileTaskPaused) {
            showTempMessage("任务正在运行中", "info");
            return;
          }
          updateMobileTaskUI("准备中", "正在启动任务...");
          if (currentRunData) {
            currentRunData.target_sequence = 1;
            currentRunData.isInTargetZone = false;
          }
          const result = await callPythonAPI_raw(
            "/api/background_task/start",
            "POST",
            {
              task_indices: [selectedTaskIndex],
              auto_generate: true,
            }
          );
          if (result && result.success) {
            mobileTaskRunning = true;
            mobileTaskPaused = false;
            updateMobileTaskUI("运行中", "任务执行中");
            updateMobileProgress(0, "0%");
            showTempMessage("任务已启动", "success");
            setTimeout(() => startBackgroundTaskPolling(), 500);
          } else {
            const isRunning = await syncMobileBtnStateFromBackend();
            if (!isRunning) {
              updateMobileTaskUI("未启动", result?.message || "启动失败");
            }
            showTempMessage(result?.message || "启动失败", "error");
          }
        } catch (error) {
          console.error("[移动端] 启动任务失败:", error);
          const isRunning = await syncMobileBtnStateFromBackend();
          if (!isRunning) {
            updateMobileTaskUI("错误", "启动失败");
          }
          showTempMessage("启动任务时发生错误", "error");
        }
      }
      async function syncMobileBtnStateFromBackend() {
        try {
          const res = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );
          if (
            res.success &&
            res.task_status &&
            res.task_status.status === "running"
          ) {
            mobileTaskRunning = true;
            mobileTaskPaused = false;
            updateMobileTaskUI("运行中", "任务执行中 (已恢复)");
            if (!backgroundTaskPollInterval) {
              startBackgroundTaskPolling();
            }
            return true;
          }
        } catch (e) {
          console.error("同步状态失败:", e);
        }
        mobileTaskRunning = false;
        return false;
      }
      async function mobileStopTask() {
        try {
          const statusRes = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );
          const isBackendRunning =
            statusRes.success &&
            statusRes.task_status &&
            statusRes.task_status.status === "running";

          if (!isBackendRunning) {
            mobileTaskRunning = false;
            updateMobileTaskUI("未启动", "没有正在运行的任务");
            showTempMessage("没有正在运行的任务", "info");
            return;
          }

          updateMobileTaskUI("停止中", "正在停止任务...");

          const result = await callPythonAPI_raw(
            "/api/background_task/stop",
            "POST",
            {}
          );

          if (result && result.success) {
            mobileTaskRunning = false;
            mobileTaskPaused = false;
            updateMobileTaskUI("已停止", "任务已停止");
            showTempMessage("任务已停止", "success");
            stopBackgroundTaskPolling();
          } else {
            const isRunning = await syncMobileBtnStateFromBackend();
            if (isRunning) {
              updateMobileTaskUI("运行中", result?.message || "停止失败");
            } else {
              updateMobileTaskUI("已停止", "任务已停止 (修正状态)");
            }
            showTempMessage(result?.message || "停止失败", "error");
          }
        } catch (error) {
          console.error("[移动端] 停止任务失败:", error);
          const isRunning = await syncMobileBtnStateFromBackend();
          if (isRunning) {
            updateMobileTaskUI("运行中", "停止请求异常");
          } else {
            updateMobileTaskUI("已停止", "连接异常 (假设已停)");
          }
          showTempMessage("停止任务时发生错误", "error");
        }
      }
      async function mobilePauseTask() {
        try {
          if (!mobileTaskRunning) {
            showTempMessage("没有正在运行的任务", "info");
            return;
          }

          if (mobileTaskPaused) {
            showTempMessage("任务已暂停", "info");
            return;
          }

          const result = await callPythonAPI("pause_run");
          if (result && result.success) {
            mobileTaskPaused = true;
            updateMobileTaskUI("已暂停", "任务已暂停");
            showTempMessage("任务已暂停", "success");
          } else {
            showTempMessage(result?.message || "暂停失败", "error");
          }
        } catch (error) {
          console.error("[移动端] 暂停任务失败:", error);
          showTempMessage("暂停任务时发生错误", "error");
        }
      }
      async function mobileResumeTask() {
        try {
          if (!mobileTaskPaused) {
            showTempMessage("任务未暂停", "info");
            return;
          }

          const result = await callPythonAPI("resume_run");
          if (result && result.success) {
            mobileTaskPaused = false;
            updateMobileTaskUI("运行中", "任务继续执行");
            showTempMessage("任务已继续", "success");
          } else {
            showTempMessage(result?.message || "继续失败", "error");
          }
        } catch (error) {
          console.error("[移动端] 继续任务失败:", error);
          showTempMessage("继续任务时发生错误", "error");
        }
      }
      async function mobileResetTask() {
        try {
          showMobileConfirm(
            "重置任务",
            "确定要重置任务吗？这将清除当前进度。",
            async () => {
              const result = await callPythonAPI("reset_run");
              if (result && result.success) {
                mobileTaskRunning = false;
                mobileTaskPaused = false;
                updateMobileTaskUI("未启动", "任务已重置");
                updateMobileProgress(0, "0%");
                showTempMessage("任务已重置", "success");
              } else {
                showTempMessage(result?.message || "重置失败", "error");
              }
            }
          );
        } catch (error) {
          console.error("[移动端] 重置任务失败:", error);
          showTempMessage("重置任务时发生错误", "error");
        }
      }
      async function exitMobileMultiAccount() {
        try {
          const statusRes = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );
          const isTaskRunning =
            statusRes.success &&
            statusRes.task_status &&
            statusRes.task_status.status === "running";
          if (isTaskRunning || mobileTaskRunning) {
            showMobileConfirm(
              "警告：任务正在运行",
              "检测到有跑步任务正在执行中。退出多账号模式将停止当前任务，可能导致数据不完整。\n\n确定要继续退出吗？",
              async () => {
                try {
                  await callPythonAPI_raw(
                    "/api/background_task/stop",
                    "POST",
                    {}
                  );
                  stopBackgroundTaskPolling();
                  updateMobileTaskUI("已停止", "任务已停止（退出多账号模式）");
                  mobileTaskRunning = false;
                  mobileTaskPaused = false;
                  performExitMobileMultiAccount();
                } catch (error) {
                  console.error("[移动端] 停止任务失败:", error);
                  showTempMessage(
                    "停止任务时出错，但仍将退出多账号模式",
                    "warning"
                  );
                  performExitMobileMultiAccount();
                }
              },
              () => {
                showTempMessage("已取消退出多账号模式", "info");
              }
            );
            return;
          }
        } catch (error) {
          console.error("[移动端] 检查任务状态失败:", error);
          showTempMessage("无法检查任务状态，将继续退出", "warning");
        }
        performExitMobileMultiAccount();
      }
      async function performExitMobileMultiAccount() {
        stopMultiAccountAutoRefresh();
        await callPythonAPI("exit_multi_account_mode");
        document
          .getElementById("mobile-multi-account-app")
          .classList.add("hidden");
        document
          .getElementById("mobile-login-container")
          .classList.remove("hidden");
        updateMobileNavVisibility(false);
      }
      async function exitMobileSingleAccount() {
        try {
          console.log("[移动端] 开始退出单账号模式...");
          const result = await callPythonAPI("exit_single_account_mode");
          if (!result || !result.success) {
            console.error(
              "[移动端] 退出单账号模式失败:",
              result?.message || "未知错误"
            );
            showTempMessage(
              "退出失败: " + (result?.message || "未知错误"),
              "error"
            );
            return;
          }
          console.log("[移动端] 退出单账号模式成功，开始切换界面...");
          if (typeof destroyMobileSingleMap === "function") {
            destroyMobileSingleMap();
            console.log("[退出单账号] 移动端：已销毁单账号地图");
          }
          const mobileMainApp = document.getElementById("mobile-main-app");
          if (mobileMainApp) {
            mobileMainApp.classList.add("hidden");
          }
          const loginContainer = document.getElementById(
            "mobile-login-container"
          );
          if (loginContainer) {
            loginContainer.classList.remove("hidden");
          }
          updateMobileNavVisibility(false);
          setTimeout(async () => {
            console.log("[移动端] 开始刷新会话列表...");
            if (typeof refreshMobileSessions === "function") {
              await refreshMobileSessions();
              console.log("[移动端] 会话列表刷新完成");
            } else if (typeof refreshSessionList === "function") {
              await refreshSessionList();
              console.log("[移动端] 会话列表刷新完成（使用PC端函数）");
            } else {
              console.warn("[移动端] 未找到刷新会话列表的函数");
            }
          }, 200);
          showTempMessage("已退出单账号模式", "success");
          console.log("[移动端] 退出单账号模式流程完成");
        } catch (error) {
          console.error("[移动端] 退出单账号模式时发生错误:", error);
          showTempMessage("退出时发生错误: " + error.message, "error");
        }
      }
      async function exitMobileMultiAccountToSessions() {
        try {
          console.log("[移动端] 开始退出多账号模式...");
          stopMultiAccountAutoRefresh();
          const result = await callPythonAPI("exit_multi_account_mode");
          if (!result || !result.success) {
            console.error(
              "[移动端] 退出多账号模式失败:",
              result?.message || "未知错误"
            );
            showTempMessage(
              "退出失败: " + (result?.message || "未知错误"),
              "error"
            );
            return;
          }

          console.log("[移动端] 退出多账号模式成功，开始切换界面...");
          const mobileMultiApp = document.getElementById(
            "mobile-multi-account-app"
          );
          if (mobileMultiApp) {
            mobileMultiApp.classList.add("hidden");
          }
          const loginContainer = document.getElementById(
            "mobile-login-container"
          );
          if (loginContainer) {
            loginContainer.classList.remove("hidden");
          }
          updateMobileNavVisibility(false);
          setTimeout(async () => {
            console.log("[移动端] 开始刷新会话列表...");
            if (typeof refreshMobileSessions === "function") {
              await refreshMobileSessions();
              console.log("[移动端] 会话列表刷新完成");
            } else if (typeof refreshSessionList === "function") {
              await refreshSessionList();
              console.log("[移动端] 会话列表刷新完成（使用PC端函数）");
            } else {
              console.warn("[移动端] 未找到刷新会话列表的函数");
            }
          }, 200);
          showTempMessage("已退出多账号模式", "success");
          console.log("[移动端] 退出多账号模式流程完成");
        } catch (error) {
          console.error("[移动端] 退出多账号模式时发生错误:", error);
          showTempMessage("退出时发生错误: " + error.message, "error");
        }
      }
      function mobileToggleSelectAllAccounts() {
        const checkbox = document.getElementById("mobile-select-all-accounts");
        const accountCheckboxes = document.querySelectorAll(
          '#mobile-multi-account-list input[type="checkbox"]'
        );
        accountCheckboxes.forEach((cb) => {
          cb.checked = checkbox.checked;
        });
      }
      async function mobileStartSelectedAccounts() {
        try {
          const selected = document.querySelectorAll(
            '#mobile-multi-account-list input[type="checkbox"]:checked'
          );
          if (selected.length === 0) {
            showTempMessage("请先选择要启动的账号", "error");
            return;
          }
          await multi_startSelected();
          showTempMessage(`正在启动 ${selected.length} 个账号`, "success");
        } catch (error) {
          console.error("[移动端] 启动选中账号失败:", error);
          showTempMessage("启动选中账号失败", "error");
        }
      }
      async function mobileStopSelectedAccounts() {
        try {
          const selected = document.querySelectorAll(
            '#mobile-multi-account-list input[type="checkbox"]:checked'
          );
          if (selected.length === 0) {
            showTempMessage("请先选择要停止的账号", "error");
            return;
          }
          await multi_stopSelected();
          showTempMessage(`正在停止 ${selected.length} 个账号`, "success");
        } catch (error) {
          console.error("[移动端] 停止选中账号失败:", error);
          showTempMessage("停止选中账号失败", "error");
        }
      }
      function mobileAddMultiAccount() {
        try {
          multi_addFromConfig();
        } catch (error) {
          console.error("[移动端] 添加账号失败:", error);
          showTempMessage("添加账号失败", "error");
        }
      }
      async function mobileRefreshMultiAccounts() {
        try {
          showTempMessage("正在刷新账号列表...", "info");
          await multi_refreshAll();
          showTempMessage("账号列表已刷新", "success");
        } catch (error) {
          console.error("[移动端] 刷新账号列表失败:", error);
          showTempMessage("刷新账号列表失败", "error");
        }
      }
      async function mobileStartAllAccounts() {
        try {
          const count = parseInt(
            $("multi-account-count")?.textContent || "0",
            10
          );
          if (!count || count <= 0) {
            showTempMessage("账号列表为空，无法启动", "error");
            return;
          }
          const randomDelayCheck = document.getElementById(
            "mobile-multi-random-delay-check"
          );
          const onlyIncompleteCheck = document.getElementById(
            "mobile-multi-only-incomplete-check"
          );
          const use_delay = randomDelayCheck ? randomDelayCheck.checked : true;
          const min_delay = 0;
          const max_delay = 300;
          const run_only_incomplete = onlyIncompleteCheck
            ? onlyIncompleteCheck.checked
            : true;

          showTempMessage(`正在启动全部 ${count} 个账号...`, "info");
          const result = await callPythonAPI(
            "multi_start_all_accounts",
            min_delay,
            max_delay,
            use_delay,
            run_only_incomplete
          );
          if (!result || !result.success) {
            showTempMessage(result?.message || "启动全部账号失败", "error");
            return;
          }

          showTempMessage("已发送全部启动指令", "success");
        } catch (error) {
          console.error("[移动端] 启动全部账号失败:", error);
          showTempMessage("启动全部账号失败", "error");
        }
      }
      async function mobileStopAllAccounts() {
        try {
          await multi_stopAll();
          showTempMessage("已发送全部停止指令", "success");
        } catch (error) {
          console.error("[移动端] 停止全部账号失败:", error);
          showTempMessage("停止全部账号失败", "error");
        }
      }
      async function mobileRefreshAllAccounts() {
        try {
          showTempMessage("正在刷新所有账号...", "info");
          await multi_refreshAll();
          showTempMessage("所有账号已刷新", "success");
        } catch (error) {
          console.error("[移动端] 刷新所有账号失败:", error);
          showTempMessage("刷新所有账号失败", "error");
        }
      }
      async function mobileRemoveSelectedAccounts() {
        try {
          const selected = document.querySelectorAll(
            '#mobile-multi-account-list input[type="checkbox"]:checked'
          );
          if (selected.length === 0) {
            showTempMessage("请先选择要删除的账号", "error");
            return;
          }
          showMobileConfirm(
            "删除账号",
            `确定要删除选中的 ${selected.length} 个账号吗？`,
            async () => {
              await multi_removeSelected();
              showTempMessage(`已删除 ${selected.length} 个账号`, "success");
            }
          );
        } catch (error) {
          console.error("[移动端] 删除选中账号失败:", error);
          showTempMessage("删除选中账号失败", "error");
        }
      }
      function toggleMobileMoreMenu(show) {
        const modal = document.getElementById("mobile-more-menu-modal");
        if (modal) {
          if (show) {
            modal.classList.remove("hidden");
          } else {
            modal.classList.add("hidden");
          }
        }
      }
      function toggleMobileAdminPanel(show) {
        const modal = document.getElementById("mobile-admin-panel-modal");
        if (modal) {
          if (show) {
            modal.classList.remove("hidden");
            initMobileAdminPanel("mobile-admin");
          } else {
            modal.classList.add("hidden");
          }
        }
      }
      function toggleMobileUserDetails(show) {
        if (!isMobileMode) {
          toggleUserDetails(show);
          return;
        }
        const modal = document.getElementById("mobile-user-details-modal");
        if (modal) {
          if (show) {
            modal.classList.remove("hidden");
          } else {
            modal.classList.add("hidden");
          }
        }
      }
      function toggleMobileTaskDetails(show) {
        const modal = document.getElementById("mobile-task-details-modal");
        if (modal) {
          if (show) {
            modal.classList.remove("hidden");
          } else {
            modal.classList.add("hidden");
          }
        }
      }
      function toggleMobileNotifications(show) {
        const modal = document.getElementById("mobile-notifications-modal");

        // 检查元素是否存在，防止空指针错误
        if (modal) {
          // 根据show参数决定显示或隐藏
          if (show) {
            // 移除hidden类，显示模态框
            modal.classList.remove("hidden");
            // 加载通知内容（调用已存在的函数）
            // updateMobileNotificationUI();
          } else {
            // 添加hidden类，隐藏模态框
            modal.classList.add("hidden");
          }
        }
      }
      function showMobileConfirm(title, message, onConfirm, onCancel) {
        const modal = document.getElementById("mobile-confirm-modal");
        if (!modal) {
          console.error("找不到移动端确认对话框元素");
          return;
        }
        const titleElement = document.getElementById("mobile-confirm-title");
        if (titleElement) {
          titleElement.textContent = title;
        }
        const messageElement = document.getElementById(
          "mobile-confirm-message"
        );
        if (messageElement) {
          messageElement.textContent = message;
        }
        const cancelBtn = document.getElementById("mobile-confirm-cancel-btn");
        const okBtn = document.getElementById("mobile-confirm-ok-btn");
        const closeModal = () => {
          modal.classList.add("hidden");
        };
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);
        newCancelBtn.addEventListener("click", () => {
          closeModal();
          if (onCancel && typeof onCancel === "function") {
            onCancel();
          }
        });
        newOkBtn.addEventListener("click", () => {
          closeModal();
          if (onConfirm && typeof onConfirm === "function") {
            onConfirm();
          }
        });
        modal.onclick = (e) => {
          if (e.target === modal) {
            closeModal();
            if (onCancel && typeof onCancel === "function") {
              onCancel();
            }
          }
        };
        modal.classList.remove("hidden");
      }
      async function mobileLogout() {
        try {
          const statusRes = await callPythonAPI_raw(
            "/api/background_task/status",
            "GET",
            null
          );
          const isTaskRunning =
            statusRes.success &&
            statusRes.task_status &&
            statusRes.task_status.status === "running";
          if (isTaskRunning || mobileTaskRunning) {
            showMobileConfirm(
              "警告：任务正在运行",
              "检测到有跑步任务正在执行中。退出登录将停止当前任务，可能导致数据不完整。\n\n确定要继续退出吗？",
              async () => {
                try {
                  await callPythonAPI_raw(
                    "/api/background_task/stop",
                    "POST",
                    {}
                  );
                  stopBackgroundTaskPolling();
                  updateMobileTaskUI("已停止", "任务已停止（退出登录）");
                  mobileTaskRunning = false;
                  mobileTaskPaused = false;
                  performMobileLogout();
                } catch (error) {
                  console.error("[移动端] 停止任务失败:", error);
                  showTempMessage("停止任务时出错，但仍将退出登录", "warning");
                  performMobileLogout();
                }
              },
              () => {
                showTempMessage("已取消退出登录", "info");
              }
            );
            return;
          }
        } catch (error) {
          console.error("[移动端] 检查任务状态失败:", error);
          showTempMessage("无法检查任务状态，将继续退出", "warning");
        }
        performMobileLogout();
      }
      function performMobileLogout() {
        showMobileConfirm("退出登录", "确定要退出登录吗？", () => {
          const mobileMainApp = document.getElementById("mobile-main-app");
          if (mobileMainApp) {
            mobileMainApp.classList.add("hidden");
          }
          const loginContainer = document.getElementById(
            "mobile-login-container"
          );
          if (loginContainer) {
            loginContainer.classList.remove("hidden");
          }
          updateMobileNavVisibility(false);
          showTempMessage("已退出登录", "success");
        });
      }
      async function loadMobileUserDetails() {
        try {
          if (!currentUserData || !currentUserData.student_id) {
            const emptyDiv = document.getElementById(
              "mobile-user-details-empty"
            );
            const avatarDiv = document.getElementById(
              "mobile-user-details-avatar"
            );
            const basicDiv = document.getElementById(
              "mobile-user-details-basic"
            );
            const schoolDiv = document.getElementById(
              "mobile-user-details-school"
            );
            const loginDiv = document.getElementById(
              "mobile-user-details-login"
            );
            const uaDiv = document.getElementById("mobile-user-details-ua");
            if (emptyDiv) emptyDiv.classList.remove("hidden");
            if (avatarDiv) avatarDiv.classList.add("hidden");
            if (basicDiv) basicDiv.classList.add("hidden");
            if (schoolDiv) schoolDiv.classList.add("hidden");
            if (loginDiv) loginDiv.classList.add("hidden");
            if (uaDiv) uaDiv.classList.add("hidden");
            showTempMessage("请先登录", "warning");
            return;
          }
          const user_data = currentUserData;
          const emptyDiv = document.getElementById("mobile-user-details-empty");
          const avatarDiv = document.getElementById(
            "mobile-user-details-avatar"
          );
          const basicDiv = document.getElementById("mobile-user-details-basic");
          const schoolDiv = document.getElementById(
            "mobile-user-details-school"
          );
          const loginDiv = document.getElementById("mobile-user-details-login");
          const uaDiv = document.getElementById("mobile-user-details-ua");
          if (emptyDiv) emptyDiv.classList.add("hidden");
          if (avatarDiv) avatarDiv.classList.remove("hidden");
          if (basicDiv) basicDiv.classList.remove("hidden");
          if (schoolDiv) schoolDiv.classList.remove("hidden");
          if (loginDiv) loginDiv.classList.remove("hidden");
          if (uaDiv) uaDiv.classList.remove("hidden");
          const avatarImg = document.getElementById(
            "mobile-user-details-avatar-img"
          );
          const nameText = document.getElementById("mobile-user-details-name");

          if (avatarImg && user_data.avatar) {
            avatarImg.src = user_data.avatar;
          }
          if (nameText) {
            nameText.textContent = user_data.name || "未知用户";
          }
          const basicList = document.getElementById(
            "mobile-user-details-basic-list"
          );
          if (basicList) {
            basicList.innerHTML = "";
            const basicInfo = {
              学号: user_data.student_id,
              用户名: user_data.username,
              性别: user_data.gender,
              手机号: user_data.phone,
              用户ID: user_data.id,
              身份证号: user_data.id_card,
            };
            Object.entries(basicInfo).forEach(([label, value]) => {
              const p = document.createElement("div");
              p.className = "flex items-start gap-2";
              p.innerHTML = `
              <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
              <span class="text-slate-800 break-all flex-1">${
                value || "NULL"
              }</span>
            `;
              basicList.appendChild(p);
            });
          }
          const schoolList = document.getElementById(
            "mobile-user-details-school-list"
          );
          if (schoolList) {
            schoolList.innerHTML = "";
            const schoolInfo = {
              学校: user_data.school_name,
              属性: user_data.attribute_type,
            };
            Object.entries(schoolInfo).forEach(([label, value]) => {
              const p = document.createElement("div");
              p.className = "flex items-start gap-2";
              p.innerHTML = `
              <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
              <span class="text-slate-800 break-all flex-1">${
                value || "NULL"
              }</span>
            `;
              schoolList.appendChild(p);
            });
          }
          const loginList = document.getElementById(
            "mobile-user-details-login-list"
          );
          if (loginList) {
            loginList.innerHTML = "";
            const loginInfo = {
              注册时间: user_data.registration_time,
              首次登录: user_data.first_login_time,
              上次登录: user_data.last_login_time,
              当前登录: user_data.current_login_time,
            };
            Object.entries(loginInfo).forEach(([label, value]) => {
              const p = document.createElement("div");
              p.className = "flex items-start gap-2";
              p.innerHTML = `
              <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
              <span class="text-slate-800 break-all flex-1">${
                value || "NULL"
              }</span>
            `;
              loginList.appendChild(p);
            });
          }
          const uaText = document.getElementById("mobile-user-details-ua-text");
          if (uaText) {
            const uaString = IS_OFFLINE ? "NULL" : currentSessionUA || "NULL";
            uaText.textContent = uaString;
          }
          showTempMessage("用户详情加载成功", "success");
        } catch (error) {
          console.error("加载用户详情失败:", error);
          showTempMessage("加载用户详情失败: " + error.message, "error");
        }
      }
      async function loadMobileProfile() {
        await loadMobileUserDetails();
      }
      function loadMobileTaskDetails() {
        if (!currentRunData || !currentRunData.run_name) {
          const emptyDiv = document.getElementById("mobile-task-details-empty");
          const basicDiv = document.getElementById("mobile-task-details-basic");
          const timeDiv = document.getElementById("mobile-task-details-time");
          const pointsDiv = document.getElementById(
            "mobile-task-details-points"
          );
          const historyDiv = document.getElementById(
            "mobile-task-details-history"
          );
          if (emptyDiv) emptyDiv.classList.remove("hidden");
          if (basicDiv) basicDiv.classList.add("hidden");
          if (timeDiv) timeDiv.classList.add("hidden");
          if (pointsDiv) pointsDiv.classList.add("hidden");
          if (historyDiv) historyDiv.classList.add("hidden");
          showTempMessage("请先在任务列表中选择一个任务", "warning");
          return;
        }
        const emptyDiv = document.getElementById("mobile-task-details-empty");
        const basicDiv = document.getElementById("mobile-task-details-basic");
        const timeDiv = document.getElementById("mobile-task-details-time");
        const pointsDiv = document.getElementById("mobile-task-details-points");
        const historyDiv = document.getElementById(
          "mobile-task-details-history"
        );
        if (emptyDiv) emptyDiv.classList.add("hidden");
        if (basicDiv) basicDiv.classList.remove("hidden");
        if (timeDiv) timeDiv.classList.remove("hidden");
        if (pointsDiv) pointsDiv.classList.remove("hidden");
        if (historyDiv) historyDiv.classList.remove("hidden");
        const basicList = document.getElementById(
          "mobile-task-details-basic-list"
        );
        if (basicList) {
          basicList.innerHTML = "";
          const basicInfo = {
            任务名称: currentRunData.run_name,
            任务状态: currentRunData.status == 1 ? "已完成 ✓" : "未完成",
            任务ID: currentRunData.errand_id,
            计划ID: currentRunData.errand_schedule,
          };
          Object.entries(basicInfo).forEach(([label, value]) => {
            const p = document.createElement("div");
            p.className = "flex items-start gap-2";
            p.innerHTML = `
            <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
            <span class="text-slate-800 break-all flex-1">${
              value || "NULL"
            }</span>
          `;
            basicList.appendChild(p);
          });
        }
        const timeList = document.getElementById(
          "mobile-task-details-time-list"
        );
        if (timeList) {
          timeList.innerHTML = "";
          const timeInfo = {
            开始时间: currentRunData.start_time,
            结束时间: currentRunData.end_time,
            上传时间: currentRunData.upload_time,
          };
          Object.entries(timeInfo).forEach(([label, value]) => {
            const p = document.createElement("div");
            p.className = "flex items-start gap-2";
            p.innerHTML = `
            <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
            <span class="text-slate-800 break-all flex-1">${
              value || "NULL"
            }</span>
          `;
            timeList.appendChild(p);
          });
        }
        const pointsList = document.getElementById(
          "mobile-task-details-points-list"
        );
        if (pointsList) {
          pointsList.innerHTML = "";
          const targetPoints = currentRunData.target_points || [];
          const pointNames = (currentRunData.target_point_names || "").split(
            "|"
          );
          if (targetPoints.length > 0) {
            targetPoints.forEach((point, index) => {
              const name = pointNames[index] || `打卡点${index + 1}`;
              const pointCard = document.createElement("div");
              pointCard.className =
                "bg-white border border-purple-200 rounded-lg p-3 space-y-1";
              pointCard.innerHTML = `
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-6 h-6 bg-purple-500 text-white rounded-full text-xs font-bold">${
                  index + 1
                }</span>
                <span class="font-medium text-slate-800">${name}</span>
              </div>
              <div class="text-xs text-slate-500 pl-8">
                坐标: ${point[0].toFixed(5)}, ${point[1].toFixed(5)}
              </div>
            `;
              pointsList.appendChild(pointCard);
            });
          } else {
            pointsList.innerHTML =
              '<p class="text-slate-400 text-center py-4 text-sm">该任务暂无打卡点数据</p>';
          }
        }
        const historyList = document.getElementById(
          "mobile-task-details-history-list"
        );
        if (historyList) {
          historyList.innerHTML = "";
          if (currentRunData.history && currentRunData.history.length > 0) {
            currentRunData.history.forEach((record, index) => {
              const p = document.createElement("div");
              p.className =
                "flex items-start gap-2 pb-2 border-b border-amber-200 last:border-0";
              p.innerHTML = `
              <span class="font-semibold text-slate-600">${index + 1}.</span>
              <span class="text-slate-800 break-all flex-1">${
                record.time || "NULL"
              } - ${record.status || "未知状态"}</span>
            `;
              historyList.appendChild(p);
            });
          } else {
            historyList.innerHTML =
              '<p class="text-slate-400 text-center py-4 text-sm">暂无历史记录</p>';
          }
        }
        showTempMessage("任务详情加载成功", "success");
      }
      function destroyMobileSingleMap() {
        try {
          if (map) {
            map.destroy();
            map = null;
            console.log("[移动端] 单账号地图已销毁");
          }
          window.mobile_map_panel_initialize_mark = false;
          const container = document.getElementById("mobile-map-container");
          if (container) container.innerHTML = "";
        } catch (e) {
          console.warn("[移动端] 销毁单账号地图失败:", e);
        }
      }
      function destroyMobileMultiMap() {
        try {
          if (multiAccountMap) {
            multiAccountMap.destroy();
            multiAccountMap = null;
            console.log("[移动端] 多账号地图已销毁");
          }
          window.mobile_multi_map_panel_initialize_mark = false;
          const container = document.getElementById(
            "mobile-multi-map-container"
          );
          if (container) container.innerHTML = "";
        } catch (e) {
          console.warn("[移动端] 销毁多账号地图失败:", e);
        }
      }
      async function initMobileMap(
        containerId,
        isMultiAccount = false,
        retryCount = 0
      ) {
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        const container = document.getElementById(containerId);
        if (!container) {
          logMessage_Warning(`[移动端地图] 容器 ${containerId} 不存在`);
          if (retryCount < MAX_RETRIES) {
            logMessage_Info(
              `[移动端地图] 将在 ${RETRY_DELAY}ms 后重试 (${
                retryCount + 1
              }/${MAX_RETRIES})`
            );
            setTimeout(() => {
              initMobileMap(containerId, isMultiAccount, retryCount + 1);
            }, RETRY_DELAY);
          }
          return false;
        }
        const containerStyle = window.getComputedStyle(container);
        const containerWidth = container.offsetWidth;
        const containerHeight = container.offsetHeight;

        if (
          containerWidth === 0 ||
          containerHeight === 0 ||
          containerStyle.display === "none"
        ) {
          logMessage_Warning(
            `[移动端地图] 容器 ${containerId} 不可见或尺寸为0 (${containerWidth}x${containerHeight})`
          );
          if (retryCount < MAX_RETRIES) {
            logMessage_Info(
              `[移动端地图] 将在 ${RETRY_DELAY}ms 后重试 (${
                retryCount + 1
              }/${MAX_RETRIES})`
            );
            setTimeout(() => {
              initMobileMap(containerId, isMultiAccount, retryCount + 1);
            }, RETRY_DELAY);
          }
          return false;
        }
        if (typeof AMapInstance === "undefined") {
          logMessage_Error("[移动端地图] 高德地图API未加载");
          container.innerHTML = `
          <div class="absolute inset-0 flex items-center justify-center text-slate-400">
            <div class="text-center">
              <svg class="w-12 h-12 mx-auto mb-2 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p class="text-sm">地图加载失败</p>
              <p class="text-xs mt-1">高德地图API未加载</p>
            </div>
          </div>
        `;
          if (retryCount < MAX_RETRIES) {
            logMessage_Info(
              `[移动端地图] 将在 ${RETRY_DELAY}ms 后重试加载 (${
                retryCount + 1
              }/${MAX_RETRIES})`
            );
            setTimeout(() => {
              initMobileMap(containerId, isMultiAccount, retryCount + 1);
            }, RETRY_DELAY);
          }
          return false;
        }
        container.innerHTML = `
        <div class="absolute inset-0 flex items-center justify-center text-slate-400">
          <div class="text-center">
            <svg class="w-12 h-12 mx-auto mb-2 text-blue-300 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <p class="text-sm">地图初始化中...</p>
          </div>
        </div>
      `;
        if (isMultiAccount) {
          if (multiAccountMap && multiAccountMap.getZoom) {
            const currentContainer = multiAccountMap.getContainer();
            if (currentContainer && currentContainer.id === containerId) {
              logMessage_Info(
                "[移动端地图] 多账号地图已初始化且容器匹配，执行Resize刷新"
              );
              container.innerHTML = "";
              setTimeout(() => {
                multiAccountMap.resize();
              }, 200);
              return true;
            } else {
              logMessage_Info(
                `[移动端地图] 多账号地图容器不匹配 (旧: ${currentContainer?.id}, 新: ${containerId})，正在销毁旧实例...`
              );
              try {
                multiAccountMap.destroy();
              } catch (e) {
                console.warn("销毁多账号地图失败:", e);
              }
              multiAccountMap = null;
              multiAccountMarkers = {};
            }
          }
          logMessage_Info(`[移动端地图] 初始化多账号地图容器: ${containerId}`);
          try {
            multiAccountMap = new AMapInstance.Map(containerId, {
              zoom: 15,
              center: [113.390342, 22.527403],
              mapStyle: "amap://styles/normal",
            });
            await new Promise((resolve, reject) => {
              const timeout = setTimeout(() => {
                reject(new Error("地图加载超时"));
              }, 5000);

              multiAccountMap.on("complete", () => {
                clearTimeout(timeout);
                resolve();
              });
            });
            const ctrlBar = new AMapInstance.ControlBar({
              position: { top: "10px", right: "10px" },
            });
            multiAccountMap.addControl(ctrlBar);
            try {
              const buildings = new AMapInstance.BuildingLayer();
              buildings.setMap(multiAccountMap);
            } catch (e) {
              logMessage_Warning("[移动端地图] 3D建筑图层不可用:", e);
            }

            logMessage_Info("[移动端地图] 多账号地图初始化成功");
            return true;
          } catch (error) {
            logMessage_Error("[移动端地图] 多账号地图初始化失败:", error);
            container.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-sm">地图初始化失败</p>
                <p class="text-xs mt-1">${error.message || "未知错误"}</p>
              </div>
            </div>
          `;
            if (retryCount < MAX_RETRIES) {
              logMessage_Info(
                `[移动端地图] 将在 ${RETRY_DELAY}ms 后重试 (${
                  retryCount + 1
                }/${MAX_RETRIES})`
              );
              setTimeout(() => {
                initMobileMap(containerId, isMultiAccount, retryCount + 1);
              }, RETRY_DELAY);
            }
            return false;
          }
        } else {
          if (map && map.getZoom) {
            const currentContainer = map.getContainer();
            if (currentContainer && currentContainer.id === containerId) {
              logMessage_Info(
                "[移动端地图] 单账号地图已初始化且容器匹配，执行Resize刷新"
              );
              container.innerHTML = "";
              setTimeout(() => {
                map.resize();
                if (typeof drawOnMap === "function") {
                }
              }, 200);
              return true;
            } else {
              logMessage_Info(
                `[移动端地图] 单账号地图容器不匹配 (旧: ${currentContainer?.id}, 新: ${containerId})，正在销毁旧实例...`
              );
              try {
                if (runnerMarker) runnerMarker = null;
                map.destroy();
              } catch (e) {
                console.warn("销毁单账号地图失败:", e);
              }
              map = null;
              markers = [];
              polylines = {
                recommended: [],
                draft: null,
                run: null,
                history: null,
              };
            }
          }

          logMessage_Info(`[移动端地图] 初始化单账号地图容器: ${containerId}`);

          try {
            if (runnerMarker) {
              runnerMarker = null;
              logMessage_Info(
                "[移动端地图] 已清除旧的runner marker，准备为新地图创建"
              );
            }
            map = new AMapInstance.Map(containerId, {
              zoom: 15,
              center: [113.390342, 22.527403],
              mapStyle: "amap://styles/normal",
            });
            await new Promise((resolve, reject) => {
              const timeout = setTimeout(() => {
                reject(new Error("地图加载超时"));
              }, 5000);
              map.on("complete", () => {
                clearTimeout(timeout);
                resolve();
              });
            });
            const ctrlBar = new AMapInstance.ControlBar({
              position: { top: "10px", right: "10px" },
            });
            map.addControl(ctrlBar);
            try {
              const buildings = new AMapInstance.BuildingLayer();
              buildings.setMap(map);
            } catch (e) {
              logMessage_Warning("[移动端地图] 3D建筑图层不可用:", e);
            }
            logMessage_Info("[移动端地图] 单账号地图初始化成功");
            return true;
          } catch (error) {
            logMessage_Error("[移动端地图] 单账号地图初始化失败:", error);
            container.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-sm">地图初始化失败</p>
                <p class="text-xs mt-1">${error.message || "未知错误"}</p>
              </div>
            </div>
          `;
            if (retryCount < MAX_RETRIES) {
              logMessage_Info(
                `[移动端地图] 将在 ${RETRY_DELAY}ms 后重试 (${
                  retryCount + 1
                }/${MAX_RETRIES})`
              );
              setTimeout(() => {
                initMobileMap(containerId, isMultiAccount, retryCount + 1);
              }, RETRY_DELAY);
            }
            return false;
          }
        }
      }
      async function loadMobileTaskHistoryPanel() {
        const listContainer = document.getElementById(
          "mobile-task-history-list"
        );
        const infoDiv = document.getElementById("mobile-history-task-info");

        if (!listContainer) return;
        if (
          selectedTaskIndex === -1 ||
          !currentRunData ||
          !currentRunData.run_name
        ) {
          listContainer.innerHTML =
            '<p class="text-slate-400 text-center py-8 text-sm">请先在任务列表中选择一个任务</p>';
          if (infoDiv) infoDiv.textContent = "未选择任务";
          return;
        }
        if (infoDiv) infoDiv.textContent = `任务: ${currentRunData.run_name}`;
        listContainer.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';
        try {
          const result = await callPythonAPI(
            "get_task_history",
            selectedTaskIndex
          );
          if (result.success && result.history && result.history.length > 0) {
            listContainer.innerHTML = "";
            result.history.forEach((rec, idx) => {
              const item = document.createElement("div");
              item.className =
                "bg-white rounded-lg p-3 border border-amber-100 shadow-sm mb-2";
              item.innerHTML = `
              <div class="flex justify-between items-center mb-1">
                <span class="text-xs font-bold text-slate-600">#${
                  idx + 1
                }</span>
                <span class="text-xs text-slate-400">${rec.time}</span>
              </div>
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-xs text-slate-500">距离</p>
                  <p class="text-sm font-bold text-emerald-600">${rec.len}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500">用时</p>
                  <p class="text-sm font-bold text-sky-600">${rec.used_time}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500">配速</p>
                  <p class="text-sm font-bold text-purple-600">${rec.speed}</p>
                </div>
              </div>
              <button class="w-full mt-2 py-1 text-xs bg-slate-50 text-slate-600 rounded border border-slate-200 hover:bg-slate-100" 
                onclick="showHistoricalTrack('${rec.trid}')">
                查看轨迹
              </button>
            `;
              listContainer.appendChild(item);
            });
          } else {
            listContainer.innerHTML =
              '<p class="text-slate-400 text-center py-10 text-sm">暂无历史记录</p>';
          }
        } catch (e) {
          console.error("加载历史记录失败:", e);
          listContainer.innerHTML = `<p class="text-red-500 text-center py-8 text-sm">加载失败: ${e.message}</p>`;
        }
      }
      function switchMobileSinglePanel(panelId) {
        const singleModePanels = [
          "mobile-control-panel",
          "mobile-map-panel",
          "mobile-task-panel",
          "mobile-task-details-panel",
          "mobile-notification-panel",
          "mobile-log-panel",
          "mobile-checkpoints-panel",
          "mobile-attendance-panel",
          "mobile-admin-panel",
          "mobile-settings-panel",
          "mobile-profile-panel",
          "mobile-task-history-panel",
        ];
        singleModePanels.forEach((id) => {
          const panel = document.getElementById(id);
          if (panel) {
            panel.style.display = "none";
          }
        });
        const targetPanel = document.getElementById(panelId);
        if (targetPanel) {
          targetPanel.style.display = "";
          if (panelId === "mobile-control-panel") {
            logMessage_Info("[移动端单账号] 激活控制面板");
            if (!window.mobile_map_panel_initialize_mark) {
              switchMobileSinglePanel("mobile-map-panel");
              logMessage_Info("[移动端单账号] 首次激活控制面板，初始化地图...");
              setTimeout(function () {
                window.mobile_map_panel_initialize_mark = true;
                initMobileMap("mobile-map-container", false);
              }, 200);
              setTimeout(function () {
                switchMobileSinglePanel("mobile-control-panel");
              }, 400);
              logMessage_Info("[移动端单账号] 地图初始化完成，返回控制面板");
            }
          }
          if (panelId === "mobile-settings-panel") {
            logMessage_Info("[移动端单账号] 激活设置面板，开始加载配置...");
            const mobileParamsContainer = document.getElementById(
              "mobile-params-container"
            );
            if (
              mobileParamsContainer &&
              typeof pythonParams !== "undefined" &&
              typeof updateParamInputs === "function"
            ) {
              updateParamInputs(
                mobileParamsContainer,
                "mobile-param",
                pythonParams
              );
              logMessage_Info("[移动端单账号] 设置面板配置已自动加载");
            } else {
              logMessage_Warning(
                "[移动端单账号] 无法加载配置：容器或函数未定义"
              );
            }
            if (typeof refreshMobileSettings === "function") {
              refreshMobileSettings();
              logMessage_Info("[移动端单账号] 设置面板已自动刷新");
            } else {
              logMessage_Warning(
                "[移动端单账号] refreshMobileSettings函数未定义"
              );
            }
          }
          if (panelId === "mobile-map-panel") {
            logMessage_Info("[移动端单账号] 激活地图面板，初始化地图...");
            if (
              currentRunData &&
              currentRunData.run_coords &&
              currentRunData.run_coords.length > 0
            ) {
              logMessage_Info("[移动端单账号] 开始绘制任务路径和打卡点...");
              if (typeof drawOnMap === "function") {
                drawOnMap();

                drawOnMap();
                logMessage_Info("[移动端单账号] 任务路径和打卡点已绘制");
                ensureRunnerMarker();
              }
            } else {
              logMessage_Info("[移动端单账号] 无任务数据，跳过绘制");
            }
          }
          if (panelId === "mobile-attendance-panel") {
            logMessage_Info("[移动端单账号] 激活签到面板，开始加载配置...");
            setTimeout(() => {
              const attendanceEnabled = document.getElementById(
                "mobile-attendance-enabled"
              );
              if (attendanceEnabled && typeof pythonParams !== "undefined") {
                attendanceEnabled.checked =
                  pythonParams.attendance_enabled !== false;
              }
              const attendanceTime = document.getElementById(
                "mobile-attendance-time"
              );
              if (attendanceTime && typeof pythonParams !== "undefined") {
                attendanceTime.value = pythonParams.attendance_time || "08:00";
              }
              const attendanceDelayMin = document.getElementById(
                "mobile-attendance-delay-min"
              );
              const attendanceDelayMax = document.getElementById(
                "mobile-attendance-delay-max"
              );
              if (
                attendanceDelayMin &&
                attendanceDelayMax &&
                typeof pythonParams !== "undefined"
              ) {
                attendanceDelayMin.value =
                  pythonParams.attendance_delay_min || 0;
                attendanceDelayMax.value =
                  pythonParams.attendance_delay_max || 300;
              }
              const autoRefreshInterval = document.getElementById(
                "mobile-param-auto_attendance_refresh_s"
              );
              if (autoRefreshInterval && typeof pythonParams !== "undefined") {
                autoRefreshInterval.value =
                  pythonParams.auto_attendance_refresh_s || 60;
                logMessage_Info(
                  "[移动端单账号] 自动刷新间隔已加载:",
                  autoRefreshInterval.value,
                  "秒"
                );
              }
              const userRadius = document.getElementById(
                "mobile-param-attendance_user_radius_m"
              );
              if (userRadius && typeof pythonParams !== "undefined") {
                userRadius.value = pythonParams.attendance_user_radius_m || 0;
                logMessage_Info(
                  "[移动端单账号] 签到随机半径已加载:",
                  userRadius.value,
                  "米"
                );
              }
              logMessage_Info("[移动端单账号] 签到面板配置已自动加载");
              refreshNotificationsUI(true, true);
            }, 50);
          }
          if (panelId === "mobile-task-details-panel") {
            logMessage_Info(
              "[移动端单账号] 激活任务详情面板，开始加载任务详情..."
            );
            setTimeout(() => {
              if (typeof loadMobileTaskDetails === "function") {
                loadMobileTaskDetails();
                logMessage_Info("[移动端单账号] 任务详情已自动加载");
              } else {
                logMessage_Warning(
                  "[移动端单账号] loadMobileTaskDetails函数未定义"
                );
              }
            }, 50);
          }
          if (panelId === "mobile-profile-panel") {
            logMessage_Info(
              "[移动端单账号] 激活用户详情面板，开始加载用户详情..."
            );
            setTimeout(() => {
              if (typeof loadMobileUserDetails === "function") {
                loadMobileUserDetails();
                logMessage_Info("[移动端单账号] 用户详情已自动加载");
              } else {
                logMessage_Warning(
                  "[移动端单账号] loadMobileUserDetails函数未定义"
                );
              }
            }, 50);
          }

          // 【管理面板】激活时初始化
          // 当用户切换到管理面板时，自动初始化管理面板的标签页和内容
          // 原因：管理面板包含多个标签页（用户管理、角色管理等），需要根据用户权限动态创建
          if (panelId === "mobile-admin-panel") {
            logMessage_Info("[移动端单账号] 激活管理面板，开始初始化...");
            // 调用 initMobileAdminPanel 函数初始化管理面板
            // 参数 'mobile-admin-panel' 是前缀，用于区分单账号和多账号的管理面板
            if (typeof initMobileAdminPanel === "function") {
              initMobileAdminPanel("mobile-admin-panel");
            } else {
              logMessage_Warning(
                "[移动端单账号] initMobileAdminPanel函数未定义"
              );
            }
          }

          // 【通知面板】激活时自动刷新
          if (panelId === "mobile-notification-panel") {
            logMessage_Info("[移动端单账号] 激活通知面板，自动刷新...");
            setTimeout(() => {
              mobileRefreshNotifications();
            }, 50);
          }

          if (panelId === "mobile-task-history-panel") {
            logMessage_Info("[移动端单账号] 激活历史记录面板...");
            setTimeout(() => {
              loadMobileTaskHistoryPanel();
            }, 50);
          }

          // 【任务列表面板】激活时自动刷新任务列表
          if (panelId === "mobile-task-panel") {
            logMessage_Info("[移动端单账号] 激活任务列表面板，自动刷新任务...");
            setTimeout(() => {
              if (typeof mobileRefreshTasks === "function") {
                mobileRefreshTasks();
                logMessage_Info("[移动端单账号] 任务列表已自动刷新");
              } else {
                logMessage_Warning(
                  "[移动端单账号] mobileRefreshTasks函数未定义"
                );
              }
            }, 50);
          }

          // 【打卡点面板】激活时自动渲染打卡点列表
          if (panelId === "mobile-checkpoints-panel") {
            logMessage_Info(
              "[移动端单账号] 激活打卡点面板，自动渲染打卡点列表..."
            );
            setTimeout(() => {
              if (typeof renderMobileCheckpointsList === "function") {
                renderMobileCheckpointsList();
                logMessage_Info("[移动端单账号] 打卡点列表已自动渲染");
              } else {
                logMessage_Warning(
                  "[移动端单账号] renderMobileCheckpointsList函数未定义"
                );
              }
            }, 50);
          }

          // 第四步：滚动到页面顶部
          // 切换面板后，自动滚动到页面顶部，确保用户看到面板的完整内容
          // 使用平滑滚动效果（smooth），提供更好的用户体验
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else {
          // 如果找不到目标面板，输出警告信息
          // 这可能是因为传入了错误的panelId，或者HTML结构发生了变化
          logMessage_Warning(`[移动端单账号] 找不到ID为 ${panelId} 的面板`);
        }

        // 第五步：更新导航栏和侧边栏的激活状态
        // 当面板切换后，需要更新底部导航栏和侧边栏菜单的视觉状态
        // 让当前激活的菜单项高亮显示，其他菜单项恢复默认样式
        updateMobileNavActiveState(panelId); // 更新底部导航栏的激活状态
        updateMobileSidebarActive(panelId); // 更新侧边栏菜单的激活状态
      }

      /**
       * 【移动端多账号面板切换】专用函数
       * 重命名自 switchMobilePanel，现在仅用于多账号模式
       * 单账号模式使用 switchMobileSinglePanel
       */
      function switchMobileMulitPanel(panelId, mode = "multi") {
        // 根据模式定义面板列表
        const singleModePanels = [
          "mobile-control-panel",
          "mobile-map-panel",
          "mobile-task-panel",
          "mobile-task-details-panel", // 【问题11修复】新增：任务详情面板
          "mobile-notification-panel",
          "mobile-log-panel", // 新增：日志面板
          "mobile-checkpoints-panel", // 【问题6修复】新增：打卡点面板
          "mobile-attendance-panel",
          "mobile-admin-panel", // 【问题15&18修复】新增：管理面板
          "mobile-settings-panel",
          "mobile-profile-panel", // 新增：我的资料面板
        ];

        const multiModePanels = [
          "mobile-multi-account-panel",
          "mobile-multi-map-panel",
          "mobile-multi-control-panel",
          "mobile-multi-admin-panel",
          "mobile-multi-settings-panel",
          "mobile-multi-log-panel",
        ];
        const panelList =
          mode === "single" ? singleModePanels : multiModePanels;
        panelList.forEach((id) => {
          const panel = document.getElementById(id);
          if (panel) {
            panel.style.display = "none";
          }
        });
        const targetPanel = document.getElementById(panelId);
        if (targetPanel) {
          targetPanel.style.display = "";
          if (panelId === "mobile-multi-control-panel") {
            logMessage_Info("[移动端多账号] 激活多账号控制面板");
            if (!window.mobile_multi_map_panel_initialize_mark) {
              switchMobileMulitPanel("mobile-multi-map-panel");
              logMessage_Info(
                "[移动端多账号] 首次激活多账号控制面板，初始化地图..."
              );
              setTimeout(function () {
                window.mobile_multi_map_panel_initialize_mark = true;
                initMobileMap("mobile-multi-map-container", true);
              }, 200);
              setTimeout(function () {
                switchMobileMulitPanel("mobile-multi-control-panel");
              }, 400);
              logMessage_Info(
                "[移动端多账号] 多账号地图初始化完成，返回控制面板"
              );
            }
          }
          if (panelId === "mobile-settings-panel") {
            console.log("[移动端] 激活设置面板，开始加载配置...");
            const mobileParamsContainer = document.getElementById(
              "mobile-params-container"
            );
            if (
              mobileParamsContainer &&
              typeof pythonParams !== "undefined" &&
              typeof updateParamInputs === "function"
            ) {
              updateParamInputs(
                mobileParamsContainer,
                "mobile-param",
                pythonParams
              );
              console.log("[移动端] 设置面板配置已自动加载");
            } else {
              console.warn("[移动端] 无法加载配置：容器或函数未定义");
            }
          }
          if (panelId === "mobile-multi-settings-panel") {
            console.log("[移动端] 激活多账号全局设置面板，开始加载配置...");
            const mobileMultiParamsContainer = document.getElementById(
              "mobile-multi-global-params-container"
            );
            if (
              mobileMultiParamsContainer &&
              typeof pythonParams !== "undefined" &&
              typeof updateParamInputs === "function"
            ) {
              updateParamInputs(
                mobileMultiParamsContainer,
                "mobile-multi-param",
                pythonParams
              );
              console.log("[移动端] 多账号全局设置面板配置已自动加载");
            }
          }
          if (panelId === "mobile-multi-map-panel") {
            console.log("[移动端] 激活多账号地图面板，初始化地图...");
            setTimeout(() => {}, 100);
          }
          if (panelId === "mobile-admin-panel") {
            console.log("[移动端] 激活管理面板，开始初始化...");
            if (typeof initMobileAdminPanel === "function") {
              initMobileAdminPanel("mobile-admin-panel");
            } else {
              console.warn("[移动端] initMobileAdminPanel函数未定义");
            }
          }
          if (panelId === "mobile-multi-admin-panel") {
            console.log("[移动端] 激活多账号管理面板，开始初始化...");
            if (typeof initMobileAdminPanel === "function") {
              initMobileAdminPanel("mobile-multi-admin-panel");
            } else {
              console.warn("[移动端] initMobileAdminPanel函数未定义");
            }
          }
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else {
          console.warn(`找不到ID为 ${panelId} 的面板`);
        }
        updateMobileNavActiveState(panelId);
        updateMobileSidebarActive(panelId);
      }
      function switchMobilePanel(panelId, mode = "multi") {
        return switchMobileMulitPanel(panelId, mode);
      }
      function scrollToMobileSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
          updateMobileNavActiveState(sectionId);
        } else {
          console.warn(`找不到ID为 ${sectionId} 的面板`);
        }
      }
      function updateMobileNavActiveState(activeSectionId) {
        const navButtons = document.querySelectorAll(".mobile-nav-btn");
        const sectionNavMap = {
          "mobile-control-panel": "control",
          "mobile-map-panel": "map",
          "mobile-task-panel": "task",
          "mobile-notification-panel": "notifications",
          "mobile-attendance-panel": "attendance",
          "mobile-settings-panel": "settings",
          "mobile-multi-account-panel": "accounts",
          "mobile-multi-control-panel": "control",
          "mobile-multi-map-panel": "map",
          "mobile-multi-settings-panel": "settings",
        };
        const targetNav = sectionNavMap[activeSectionId];
        navButtons.forEach((btn) => {
          const navType = btn.getAttribute("data-nav");
          if (navType === targetNav) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
      }
      function updateMobileSidebarActive(panelId) {
        const panelToMenuText = {
          "mobile-control-panel": "控制",
          "mobile-map-panel": "地图",
          "mobile-task-panel": "任务",
          "mobile-notification-panel": "通知",
          "mobile-log-panel": "日志",
          "mobile-checkpoints-panel": "打卡点",
          "mobile-attendance-panel": "签到",
          "mobile-admin-panel": "管理",
          "mobile-settings-panel": "设置",
          "mobile-profile-panel": "我的",
          "mobile-task-details-panel": "任务详情",
          "mobile-task-history-panel": "历史记录",
          "mobile-multi-control-panel": "控制",
          "mobile-multi-map-panel": "地图",
          "mobile-multi-account-panel": "账号",
          "mobile-multi-admin-panel": "管理",
          "mobile-multi-settings-panel": "设置",
          "mobile-multi-log-panel": "日志",
        };
        const targetMenuText = panelToMenuText[panelId];
        if (!targetMenuText) {
          console.log(`[侧边栏active] 面板 ${panelId} 没有对应的侧边栏菜单项`);
          const sidebarItems = document.querySelectorAll(
            ".mobile-sidebar-item"
          );
          sidebarItems.forEach((item) => {
            item.classList.remove("mobile-sidebar-active");
            item.style.backgroundColor = "";
            item.style.color = "";
            item.style.fontWeight = "";
          });
          return;
        }
        let targetSidebar;
        if (panelId.includes("multi")) {
          targetSidebar = document.getElementById(
            "mobile-sidebar-multi-account"
          );
        } else {
          targetSidebar = document.getElementById(
            "mobile-sidebar-single-account"
          );
        }
        if (!targetSidebar) {
          console.warn(`[侧边栏active] 找不到对应的侧边栏容器`);
          return;
        }
        const sidebarItems = targetSidebar.querySelectorAll(
          ".mobile-sidebar-item"
        );
        sidebarItems.forEach((item) => {
          const span = item.querySelector("span");
          if (span) {
            const menuText = span.textContent.trim();
            if (menuText === targetMenuText) {
              item.classList.add("mobile-sidebar-active");
              item.style.backgroundColor = "rgba(59, 130, 246, 0.1)";
              item.style.color = "#3b82f6";
              item.style.fontWeight = "600";
            } else {
              item.classList.remove("mobile-sidebar-active");
              item.style.backgroundColor = "";
              item.style.color = "";
              item.style.fontWeight = "";
            }
          }
        });

        console.log(
          `[侧边栏active] 已更新active状态: ${targetMenuText} (面板: ${panelId})`
        );
      }
      async function openMobileAccountParams(username) {
        if (!username) return;
        const modal = document.getElementById("mobile-account-params-modal");
        const titleEl = document.getElementById("mobile-account-params-title");
        const container = document.getElementById(
          "mobile-account-params-container"
        );
        const saveBtn = document.getElementById(
          "mobile-save-account-params-btn"
        );
        if (!modal || !container) return;
        container.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';
        modal.classList.remove("hidden");

        if (titleEl) titleEl.textContent = `[${username}] 参数设置`;

        try {
          const result = await callPythonAPI(
            "multi_get_account_params",
            username
          );
          if (!result.success) {
            showModalAlert(result.message);
            modal.classList.add("hidden");
            return;
          }
          createParamInputs(container, "mobile-acc-param", () => {}, [
            "主题与外观",
          ]);
          updateParamInputs(container, "mobile-acc-param", result.params);
          if (saveBtn) {
            saveBtn.onclick = async () => {
              showTempMessage("正在保存...", "info");
              const inputs = container.querySelectorAll("input, select");
              try {
                for (const input of inputs) {
                  const key = input.dataset.key;
                  if (!key) continue;
                  const value =
                    input.type === "checkbox" ? input.checked : input.value;
                  await callPythonAPI(
                    "multi_update_account_param",
                    username,
                    key,
                    value
                  );
                }
                showTempMessage("设置已保存", "success");
                closeMobileAccountParams();
              } catch (e) {
                showTempMessage("保存失败: " + e.message, "error");
              }
            };
          }
        } catch (e) {
          container.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${e.message}</p>`;
        }
      }
      // ==================== 移动端地图控制函数 ====================
      function mobileZoomIn() {
        if (map) {
          map.zoomIn();
        }
      }
      function mobileZoomOut() {
        if (map) {
          map.zoomOut();
        }
      }
      function mobileFitView() {
        if (map && markers && markers.length > 0) {
          map.setFitView(markers, false, [50, 50, 50, 50]);
        }
      }
      function resetMobileMapView() {
        if (map) {
          if (markers && markers.length > 0) {
            map.setFitView(markers, false, [50, 50, 50, 50]);
            console.log("[单账号地图] 复位视角：自动适应所有标记点");
          } else {
            const defaultCenter = [116.397128, 39.916527];
            const defaultZoom = 11;
            map.setCenter(defaultCenter);
            map.setZoom(defaultZoom);
            console.log("[单账号地图] 复位视角：重置到默认位置");
          }
        } else {
          console.warn("[单账号地图] 无法复位视角：地图实例未初始化");
        }
      }
      function mobileMultiZoomIn() {
        if (multiAccountMap) {
          multiAccountMap.zoomIn();
        }
      }
      function mobileMultiZoomOut() {
        if (multiAccountMap) {
          multiAccountMap.zoomOut();
        }
      }
      function mobileMultiFitView() {
        if (multiAccountMap) {
          const allOverlays = multiAccountMap.getAllOverlays();
          if (allOverlays && allOverlays.length > 0) {
            multiAccountMap.setFitView(allOverlays, false, [50, 50, 50, 50]);
          }
        }
      }
      function resetMultiMapView() {
        if (multiAccountMap) {
          const allOverlays = multiAccountMap.getAllOverlays();
          if (allOverlays && allOverlays.length > 0) {
            multiAccountMap.setFitView(allOverlays, false, [50, 50, 50, 50]);
            console.log("[多账号地图] 复位视角：自动适应所有路线");
          } else {
            const defaultCenter = [113.390342, 22.527403];
            const defaultZoom = 11;
            multiAccountMap.setCenter(defaultCenter);
            multiAccountMap.setZoom(defaultZoom);
            console.log(
              "[多账号地图] 复位视角：重置到指定位置 [113.390342, 22.527403]"
            );
          }
        } else {
          console.warn("[多账号地图] 无法复位视角：地图实例未初始化");
        }
      }
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
      // ==================== 移动端专用辅助函数 ====================
      function clearMobileLog() {
        const mobileLogText = document.getElementById("mobile-log-text");
        if (mobileLogText) {
          mobileLogText.value = "";
          console.log("[移动端] 日志已清空");
        }
      }
      function syncUAToMobile(uaText) {
        const mobileUALabel = document.getElementById("mobile-ua-label");
        if (mobileUALabel) {
          mobileUALabel.textContent = uaText || "(未加载)";
          console.log("[移动端] UA已同步:", uaText);
        }
      }
      async function loadMobileCaptcha(formType) {
        const displayId =
          formType === "login"
            ? "mobile-login-captcha-display"
            : "mobile-register-captcha-display";
        const displayElement = document.getElementById(displayId);
        if (!displayElement) {
          console.log(`[移动端验证码] 未找到验证码显示元素: ${displayId}`);
          return;
        }
        const captchaId = captchaIds[formType];
        if (!captchaId) {
          displayElement.innerHTML =
            '<span class="text-slate-400 text-xs">等待加载...</span>';
          console.log(
            `[移动端验证码] captchaId尚未生成，等待PC端加载: ${formType}`
          );
          return;
        }
        const captchaDims = captchaDimensions[formType] || {
          width: 343,
          height: 119,
        };
        // ========================================
        // 【移动端验证码缩放】
        // ========================================

        const viewportWidth =
          window.innerWidth || document.documentElement.clientWidth;
        const padding = 80 + 40;
        const availableWidth = viewportWidth - padding;
        const needsScaling = availableWidth < captchaDims.width;
        const targetWidth = needsScaling
          ? Math.floor(availableWidth)
          : captchaDims.width;
        const scaleFactor = needsScaling ? targetWidth / captchaDims.width : 1;
        const targetHeight = Math.floor(captchaDims.height * scaleFactor);

        console.log(
          `[移动端验证码缩放] 屏幕宽度${viewportWidth}px，可用${availableWidth}px，验证码原始${captchaDims.width}x${captchaDims.height}px，目标${targetWidth}x${targetHeight}px`
        );
        const timestamp = Date.now();
        let iframeSrc = `/api/captcha/html/${captchaId}?t=${timestamp}`;
        if (needsScaling) {
          iframeSrc += `&width=${targetWidth}`;
        }
        const iframeHtml = `
        <iframe 
          src="${iframeSrc}"
          style="width: ${targetWidth}px; height: ${targetHeight}px; border: none; overflow: hidden; display: block; max-width: 100%;"
          scrolling="no"
          frameborder="0"
          title="验证码">
        </iframe>
      `;
        displayElement.innerHTML = iframeHtml;

        console.log(
          `[移动端验证码] ${formType}表单验证码同步成功，复用ID: ${captchaId.substring(
            0,
            8
          )}... (时间戳: ${timestamp})`
        );
      }
      // ==================== 注册登录和个人资料功能 ====================
      let isPhoneLogin = false;

      document.addEventListener("DOMContentLoaded", function () {
        const usernameBtn = document.getElementById("auth-login-username-btn");
        const phoneBtn = document.getElementById("auth-login-phone-btn");
        const authInput = document.getElementById("auth-username");
        const authLabel = document.getElementById("auth-login-label");
        const authUsernameContainer = document.getElementById(
          "auth-username-container"
        );
        if (usernameBtn && phoneBtn) {
          usernameBtn.addEventListener("click", function () {
            isPhoneLogin = false;
            usernameBtn.className =
              "px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm";
            phoneBtn.className =
              "px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm";
            authInput.type = "text";
            authInput.placeholder = "请输入用户名";
            authInput.removeAttribute("inputmode");
            authInput.removeAttribute("maxlength");
            if (authLabel) authLabel.textContent = "用户名";
            if (authUsernameContainer) {
              const currentValue = authInput.value;
              authUsernameContainer.innerHTML = `
              <input type="text" id="auth-username" class="input-field mt-1" 
                     placeholder="请输入用户名" autocomplete="username">
            `;
              const newAuthInput = document.getElementById("auth-username");
              newAuthInput.value = currentValue;
              newAuthInput.removeAttribute("maxlength");
            }
            const switchToSms = document.getElementById("auth-switch-to-sms");
            if (switchToSms) switchToSms.classList.add("hidden");
            const passwordSection = document.getElementById(
              "auth-password-section"
            );
            const smsSection = document.getElementById("auth-sms-section");
            if (passwordSection) passwordSection.classList.remove("hidden");
            if (smsSection) smsSection.classList.add("hidden");
          });
          phoneBtn.addEventListener("click", function () {
            isPhoneLogin = true;
            phoneBtn.className =
              "px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm";
            usernameBtn.className =
              "px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm";
            authInput.type = "tel";
            authInput.placeholder = "请输入手机号";
            authInput.setAttribute("inputmode", "numeric");
            authInput.setAttribute("maxlength", "11");
            if (authLabel) authLabel.textContent = "手机号";
            if (authUsernameContainer) {
              const currentValue = authInput.value;
              authUsernameContainer.innerHTML = `
              <div class="phone-input-wrapper mt-1">
                <span class="phone-prefix">+86 </span>
                <input type="tel" id="auth-username" class="input-field" 
                       placeholder="请输入手机号" autocomplete="tel" inputmode="numeric" maxlength="11">
              </div>
            `;
              document.getElementById("auth-username").value = currentValue;
            }
            const switchToSms = document.getElementById("auth-switch-to-sms");
            if (switchToSms) switchToSms.classList.remove("hidden");
          });
        }

        const switchToSms = document.getElementById("auth-switch-to-sms");
        const switchToPassword = document.getElementById(
          "auth-switch-to-password"
        );
        const passwordSection = document.getElementById(
          "auth-password-section"
        );
        const smsSection = document.getElementById("auth-sms-section");

        if (switchToSms) {
          switchToSms.addEventListener("click", function () {
            passwordSection.classList.add("hidden");
            smsSection.classList.remove("hidden");
          });
        }

        if (switchToPassword) {
          switchToPassword.addEventListener("click", function () {
            smsSection.classList.add("hidden");
            passwordSection.classList.remove("hidden");
          });
        }
        const sendLoginCodeBtn = document.getElementById(
          "auth-send-login-code"
        );
        if (sendLoginCodeBtn) {
          sendLoginCodeBtn.addEventListener("click", function () {
            const phoneInput = document.getElementById("auth-username");
            const phone = phoneInput.value.trim();

            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
              showModalAlert("请输入正确的手机号");
              return;
            }
            openCaptchaModal({
              phone: phone,
              button: sendLoginCodeBtn,
              originalText: sendLoginCodeBtn.textContent,
              scene: "login",
            });
          });
        }
        const regUsernameInput = document.getElementById("auth-reg-username");
        if (regUsernameInput) {
          regUsernameInput.addEventListener("input", function (e) {
            const value = e.target.value;
            const noChinese = value.replace(/[一-龥]/g, "");
            if (value !== noChinese) {
              e.target.value = noChinese;
              showTempMessage("用户名不能包含中文字符", "warning");
            }
          });
        }
        const avatarInput = document.getElementById("auth-reg-avatar");
        if (avatarInput) {
          avatarInput.addEventListener("change", function (e) {
            if (typeof previewAvatarForRegistration === "function") {
              previewAvatarForRegistration(e);
            } else {
              console.error("previewAvatarForRegistration 函数尚未加载");
            }
          });
        }
        const sendCodeBtn = document.getElementById("auth-reg-send-code-btn");
        if (sendCodeBtn) {
          sendCodeBtn.addEventListener("click", async function () {
            const phone = document.getElementById("auth-reg-phone").value;
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
              showModalAlert("请输入正确的手机号");
              return;
            }
            openCaptchaModal({
              phone: phone,
              button: sendCodeBtn,
              originalText: sendCodeBtn.textContent,
            });
          });
        }
        // ============================================================
        // 验证码相关事件监听器
        // ============================================================
        const loginCaptchaRefreshBtn = document.getElementById(
          "auth-login-captcha-refresh"
        );
        if (loginCaptchaRefreshBtn) {
          loginCaptchaRefreshBtn.addEventListener("click", function (e) {
            e.preventDefault();
            refreshCaptcha("login");
          });
        }
        const loginCaptchaDisplay = document.getElementById(
          "auth-login-captcha-display"
        );
        if (loginCaptchaDisplay) {
          loginCaptchaDisplay.addEventListener("click", function () {
            refreshCaptcha("login");
          });
        }
        const registerCaptchaRefreshBtn = document.getElementById(
          "auth-register-captcha-refresh"
        );
        if (registerCaptchaRefreshBtn) {
          registerCaptchaRefreshBtn.addEventListener("click", function (e) {
            e.preventDefault();
            refreshCaptcha("register");
          });
        }
        const registerCaptchaDisplay = document.getElementById(
          "auth-register-captcha-display"
        );
        if (registerCaptchaDisplay) {
          registerCaptchaDisplay.addEventListener("click", function () {
            refreshCaptcha("register");
          });
        }
        const authLoginContainer = document.getElementById(
          "auth-login-container"
        );
        if (
          authLoginContainer &&
          !authLoginContainer.classList.contains("hidden")
        ) {
          setTimeout(() => {
            loadCaptcha("login");
            loadCaptcha("register");
          }, 100);
        }
      });
      function modifyPhone() {
        const currentPhone = document.getElementById("profile-phone").value;
        document.getElementById("modify-phone-current").value = currentPhone;
        document.getElementById("modify-phone-new").value = "";
        document.getElementById("modify-phone-code").value = "";
        document.getElementById("modify-phone-modal").style.display = "flex";
        document.body.classList.add("modal-visible");

        const currentPhoneInput = document.getElementById(
          "modify-phone-current"
        );
        const currentPhoneWrapper = currentPhoneInput
          ? currentPhoneInput.closest(".phone-input-wrapper")
          : null;
        if (currentPhoneWrapper) {
          const prefix = currentPhoneWrapper.querySelector(".phone-prefix");
          const isUnbound =
            !currentPhoneInput.value || currentPhoneInput.value === "未绑定";

          if (prefix) {
            prefix.style.display = isUnbound ? "none" : "inline";
          }
          currentPhoneWrapper.classList.toggle("prefix-hidden", isUnbound);
        }
      }
      function closeModifyPhoneModal() {
        document.getElementById("modify-phone-modal").style.display = "none";
      }
      async function sendModifyPhoneCode() {
        const newPhone = document.getElementById("modify-phone-new").value;
        if (!newPhone || !/^1[3-9]\d{9}$/.test(newPhone)) {
          showModalAlert("请输入正确的新手机号");
          return;
        }
        const btn = document.getElementById("modify-phone-send-btn");
        const originalText = btn.textContent;
        openCaptchaModal({
          phone: newPhone,
          button: btn,
          originalText: originalText,
          scene: "modify",
        });
        logMessage_Info("[修改手机号] 已打开图形验证码模态框");
      }
      async function confirmModifyPhone() {
        const newPhone = document.getElementById("modify-phone-new").value;
        const code = document.getElementById("modify-phone-code").value;
        if (!/^1[3-9]\d{9}$/.test(newPhone)) {
          showModalAlert("请输入正确的新手机号格式");
          return;
        }
        try {
          const bindResult = await callPythonAPI_raw(
            "/api/auth/check_phone",
            "POST",
            { phone: newPhone }
          );
          if (
            bindResult &&
            bindResult.is_bound &&
            bindResult.bound_to_user !== currentAuthUsername
          ) {
            const confirmed = await jsShowConfirm(
              "手机号已被绑定",
              `您输入的新手机号 ${newPhone} 已被用户 ${bindResult.bound_to_user} 绑定。\n\n是否继续？\n\n如果继续，该手机号将从原账号上强制解绑并绑定到您的账号上。`
            );
            if (!confirmed) {
              logMessage_Info(
                "[修改手机号] 用户取消操作，因为手机号已被绑定。"
              );
              return;
            }
            logMessage_Info("[修改手机号] 用户已确认强制解绑，继续操作...");
          } else if (
            bindResult &&
            bindResult.is_bound &&
            bindResult.bound_to_user === currentAuthUsername
          ) {
            showModalAlert("此手机号已绑定到您的账号。", "提示");
            closeModifyPhoneModal();
            return;
          }
          if (!newPhone || !code) {
            showModalAlert("请填写完整信息");
            return;
          }
        } catch (e) {
          logMessage_Error("检查手机号绑定失败:", e);
          showModalAlert(
            `检查手机号失败: ${e.message}，请稍后重试`,
            "网络错误"
          );
          return;
        }
        try {
          const result = await callPythonAPI_raw(
            "/api/user/update_phone",
            "POST",
            {
              new_phone: newPhone,
              sms_code: code,
            }
          );
          if (result && result.success) {
            showModalAlert("手机号修改成功");
            document.getElementById("profile-phone").value = newPhone;
            closeModifyPhoneModal();
          } else {
            showModalAlert(result?.message || "修改失败");
          }
        } catch (error) {
          showModalAlert("修改失败: " + error.message);
        }
      }
      async function loadSystemConfig() {
        const formContainer = $("admin-config-form");
        formContainer.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch("/api/admin/config/load", {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();

          if (!result.success) {
            formContainer.innerHTML = `<p class="text-red-500 text-center py-10">加载配置失败: ${result.message}</p>`;
            return;
          }

          const config = result.config;
          formContainer.innerHTML = "";
          const createInput = (
            section,
            key,
            label,
            type = "text",
            help = ""
          ) => {
            const value = config[section]?.[key];
            let inputHtml = "";
            if (type === "boolean") {
              inputHtml = `
              <select id="config-${section}-${key}" class="select-field">
                <option value="true" ${
                  value === true ? "selected" : ""
                }>启用</option>
                <option value="false" ${
                  value === false ? "selected" : ""
                }>禁用</option>
              </select>
            `;
            } else if (type === "number") {
              inputHtml = `<input type="number" id="config-${section}-${key}" value="${value}" class="input-field">`;
            } else if (type === "password_storage") {
              inputHtml = `
              <select id="config-${section}-${key}" class="select-field">
                <option value="plaintext" ${
                  value === "plaintext" ? "selected" : ""
                }>明文</option>
                <option value="sha256" ${
                  value === "sha256" ? "selected" : ""
                }>sha256</option>
                <option value="bcrypt" ${
                  value === "bcrypt" ? "selected" : ""
                }>bcrypt(自动加盐)</option>
              </select>
            `;
            } else {
              inputHtml = `<input type="text" id="config-${section}-${key}" value="${value}" class="input-field">`;
            }
            return `
            <div class="mb-3">
              <label for="config-${section}-${key}" class="block text-sm font-semibold text-slate-700">${label} <!-- <span class="text-xs font-mono text-slate-400">[${section}] ${key}</span> --></label>
              ${inputHtml}
              ${
                help ? `<p class="text-xs text-slate-500 mt-1">${help}</p>` : ""
              }
            </div>
          `;
          };
          let html = "";
          html +=
            '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mb-2">游客配置</h5>';
          html += createInput(
            "Guest",
            "allow_guest_login",
            "允许游客登录",
            "boolean",
            "是否允许未注册用户以游客身份使用系统。"
          );
          html +=
            '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">系统配置</h5>';
          html += createInput(
            "System",
            "session_expiry_days",
            "会话过期时间 (天)",
            "number",
            "超过此时间未访问的会话将被自动清理。"
          );
          html += createInput(
            "System",
            "school_accounts_dir",
            "学校账号目录",
            "text",
            "存储 school_accounts/*.ini 文件的目录。"
          );
          html += createInput(
            "System",
            "system_accounts_dir",
            "系统账号目录",
            "text",
            "存储 system_accounts/*.json 文件的目录。"
          );
          html += createInput(
            "System",
            "permissions_file",
            "权限文件名",
            "text",
            "存储权限配置的JSON文件名。"
          );
          html += createInput(
            "System",
            "session_monitor_check_interval",
            "会话监控间隔 (秒)",
            "number",
            "系统检查会话活跃状态的间隔。"
          );
          html += createInput(
            "System",
            "session_inactivity_timeout",
            "会话不活跃超时 (秒)",
            "number",
            "会话无活动超过此时间将被清理。"
          );
          html +=
            '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">日志配置</h5>';
          html += createInput(
            "Logging",
            "log_rotation_size_mb",
            "日志轮转大小 (MB)",
            "number",
            "单个日志文件最大大小。"
          );
          html += createInput(
            "Logging",
            "archive_max_size_mb",
            "归档目录最大 (MB)",
            "number",
            "归档目录总大小限制，0为不限制。"
          );
          html += createInput(
            "Logging",
            "log_dir",
            "日志目录",
            "text",
            "存储 zx-slm-tool.log 文件的目录。"
          );
          html += createInput(
            "Logging",
            "archive_dir",
            "归档目录",
            "text",
            "存储压缩日志 (logs/archive) 的目录。"
          );
          html +=
            '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">安全配置</h5>';
          html += createInput(
            "Security",
            "password_storage",
            "密码存储方式",
            "password_storage",
            "修改此项可能导致旧密码失效。"
          );
          html += createInput(
            "Security",
            "brute_force_protection",
            "启用暴力破解防护",
            "boolean",
            "限制登录尝试次数。"
          );
          html += createInput(
            "Security",
            "login_log_retention_days",
            "登录日志保留 (天)",
            "number",
            "登录审计日志的保留天数。"
          );
          html +=
            '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">地图配置</h5>';
          html += createInput(
            "Map",
            "amap_js_key",
            "高德地图 API Key",
            "text",
            "用于前端地图显示的JS API Key。"
          );
          html +=
            '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">第三方 API 配置</h5>';
          html += createInput(
            "API",
            "ip_api_key",
            "IP定位 API Key",
            "text",
            "IP地理位置查询API密钥（可选，留空使用免费接口）。"
          );
          formContainer.innerHTML = html;
        } catch (e) {
          formContainer.innerHTML = `<p class="text-red-500 text-center py-10">加载配置时发生错误: ${e.message}</p>`;
        }
      }
      async function loadCaptchaSettings() {
        try {
          console.log("[验证码设置] 开始加载验证码配置参数...");
          if (window.initialData && window.initialData.captcha_settings) {
            const settings = window.initialData.captcha_settings;
            $("captcha-length").value = settings.length || 4;
            $("captcha-scale-factor").value = settings.scale_factor || 2;
            $("captcha-noise-level").value = settings.noise_level || 0.08;
            console.log("[验证码设置] 已从缓存加载配置:", settings);
          } else {
            const response = await callPythonAPI("get_initial_data");
            if (response && response.captcha_settings) {
              const settings = response.captcha_settings;
              $("captcha-length").value = settings.length || 4;
              $("captcha-scale-factor").value = settings.scale_factor || 2;
              $("captcha-noise-level").value = settings.noise_level || 0.08;

              console.log("[验证码设置] 已从API加载配置:", settings);
            } else {
              console.warn("[验证码设置] 未能获取配置，使用默认值");
            }
          }
        } catch (error) {
          console.error("[验证码设置] 加载配置失败:", error);
        }
      }
      async function saveCaptchaSettings() {
        try {
          console.log("[验证码设置] 开始保存验证码配置...");
          const length = parseInt($("captcha-length").value);
          const scale_factor = parseInt($("captcha-scale-factor").value);
          const noise_level = parseFloat($("captcha-noise-level").value);
          if (isNaN(length) || length < 3 || length > 6) {
            Swal.fire({
              icon: "error",
              title: "参数错误",
              text: "验证码长度必须在3-6之间",
            });
            return;
          }
          if (isNaN(scale_factor) || scale_factor < 2 || scale_factor > 4) {
            Swal.fire({
              icon: "error",
              title: "参数错误",
              text: "细分倍数必须在2-4之间",
            });
            return;
          }
          if (isNaN(noise_level) || noise_level < 0 || noise_level > 0.3) {
            Swal.fire({
              icon: "error",
              title: "参数错误",
              text: "噪点比例必须在0.0-0.3之间",
            });
            return;
          }
          console.log("[验证码设置] 参数验证通过:", {
            length,
            scale_factor,
            noise_level,
          });
          const response = await fetch("/api/captcha/save_settings", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            credentials: "include",
            body: JSON.stringify({
              length,
              scale_factor,
              noise_level,
            }),
          });
          const result = await response.json();
          if (result && result.success) {
            console.log("[验证码设置] 保存成功");
            Swal.fire({
              icon: "success",
              title: "保存成功",
              text: "验证码设置已保存",
              timer: 2000,
              showConfirmButton: false,
            });
            if (window.initialData) {
              window.initialData.captcha_settings = {
                length,
                scale_factor,
                noise_level,
              };
            }
          } else {
            throw new Error(result?.message || "保存失败");
          }
        } catch (error) {
          console.error("[验证码设置] 保存失败:", error);
          Swal.fire({
            icon: "error",
            title: "保存失败",
            text: error.message || "无法保存验证码设置",
          });
        }
      }
      async function testGenerateCaptcha() {
        try {
          console.log("[验证码设置] 开始测试生成验证码...");
          const length = parseInt($("captcha-length").value);
          const scale_factor = parseInt($("captcha-scale-factor").value);
          const noise_level = parseFloat($("captcha-noise-level").value);
          if (isNaN(length) || length < 3 || length > 6) {
            Swal.fire({
              icon: "error",
              title: "参数错误",
              text: "验证码长度必须在3-6之间",
            });
            return;
          }
          if (isNaN(scale_factor) || scale_factor < 2 || scale_factor > 4) {
            Swal.fire({
              icon: "error",
              title: "参数错误",
              text: "细分倍数必须在2-4之间",
            });
            return;
          }
          if (isNaN(noise_level) || noise_level < 0 || noise_level > 0.3) {
            Swal.fire({
              icon: "error",
              title: "参数错误",
              text: "噪点比例必须在0.0-0.3之间",
            });
            return;
          }
          const response = await fetch("/api/captcha/test_generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            credentials: "include",
            body: JSON.stringify({
              length,
              scale_factor,
              noise_level,
            }),
          });
          const result = await response.json();
          if (result && result.success) {
            console.log("[验证码设置] 测试生成成功，验证码:", result.code);
            $("captcha-test-preview").classList.remove("hidden");
            const displayContainer = $("captcha-preview-display");
            const captchaWidth = result.width || 343;
            const captchaHeight = result.height || 119;

            const timestamp = Date.now();

            const iframeHtml = `
            <iframe 
              src="/api/captcha/html/${result.captcha_id}?t=${timestamp}"
              style="max-width: ${captchaWidth}px; max-height: ${captchaHeight}px; width: 100%; height: ${captchaHeight}px; border: none; overflow: hidden; display: block; margin: 0 auto;"
              scrolling="no"
              frameborder="0"
              title="验证码预览">
            </iframe>
          `;
            displayContainer.innerHTML = iframeHtml;
            $("captcha-preview-answer").textContent = result.code;
            console.log("[验证码设置] 预览区域已更新 (iframe模式)");
          } else {
            throw new Error(result?.message || "生成失败");
          }
        } catch (error) {
          console.error("[验证码设置] 测试生成失败:", error);
          Swal.fire({
            icon: "error",
            title: "生成失败",
            text: error.message || "无法生成测试验证码",
          });
        }
      }
      document.addEventListener("DOMContentLoaded", function () {
        const saveCaptchaSettingsBtn = $("save-captcha-settings-btn");
        if (saveCaptchaSettingsBtn) {
          saveCaptchaSettingsBtn.addEventListener("click", saveCaptchaSettings);
          console.log("[验证码设置] 已注册保存按钮事件");
        }
        const testCaptchaBtn = $("test-captcha-btn");
        if (testCaptchaBtn) {
          testCaptchaBtn.addEventListener("click", testGenerateCaptcha);
          console.log("[验证码设置] 已注册测试按钮事件");
        }
        const refreshCaptchaHistoryBtn = $("refresh-captcha-history-btn");
        if (refreshCaptchaHistoryBtn) {
          refreshCaptchaHistoryBtn.addEventListener(
            "click",
            loadCaptchaHistory
          );
          console.log("[验证码历史] 已注册刷新按钮事件");
        }
      });
      async function loadCaptchaHistory() {
        const listContainer = $("admin-captcha-list_modal");
        if (!listContainer) {
          console.error("找不到容器 admin-captcha-list_modal");
          return;
        }
        listContainer.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';
        try {
          const dateInput = $("captcha-history-date");
          const statusSelect = $("captcha-history-status");

          if (!dateInput || !statusSelect) return;
          const date = dateInput.value.replace(/-/g, "");
          const status = statusSelect.value;
          const params = new URLSearchParams({ date });
          if (status) {
            params.append("status", status);
          }
          const response = await fetch(`/api/captcha/history?${params}`, {
            headers: { "X-Session-ID": sessionUUID },
          });
          const result = await response.json();
          if (!result.success) {
            listContainer.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
            return;
          }
          const records = result.data || [];
          const total = records.length;
          const success = records.filter(
            (r) => r.status === "verified_success"
          ).length;
          const failed = records.filter(
            (r) => r.status === "verified_failed"
          ).length;
          const pending = records.filter((r) => r.status === "created").length;
          const expired = records.filter((r) => r.status === "expired").length;
          const testGenerated = records.filter(
            (r) => r.status === "test_generated"
          ).length;
          const statTotal = $("captcha-stat-total");
          const statSuccess = $("captcha-stat-success");
          const statFailed = $("captcha-stat-failed");
          const statPending = $("captcha-stat-pending");
          const statExpired = $("captcha-stat-expired");
          const statTestGenerated = $("captcha-stat-test");
          if (statTotal) statTotal.textContent = total;
          if (statSuccess) statSuccess.textContent = success;
          if (statFailed) statFailed.textContent = failed;
          if (statPending) statPending.textContent = pending;
          if (statExpired) statExpired.textContent = expired;
          if (statTestGenerated) statTestGenerated.textContent = testGenerated;
          if (records.length === 0) {
            listContainer.innerHTML =
              '<p class="text-slate-400 text-center py-10">该日期没有验证码记录</p>';
            return;
          }
          listContainer.innerHTML = "";
          records.forEach((record) => {
            const statusClass =
              {
                created: "bg-yellow-100 text-yellow-800",
                verified_success: "bg-green-100 text-green-800",
                verified_failed: "bg-red-100 text-red-800",
                expired: "bg-gray-100 text-gray-800",
              }[record.status] || "bg-gray-100 text-gray-800";
            const statusText =
              {
                created: "待验证",
                verified_success: "验证成功",
                verified_failed: "验证失败",
                expired: "已过期",
                test_generated: "测试生成",
              }[record.status] || record.status;
            const itemDiv = document.createElement("div");
            itemDiv.className =
              "p-3 bg-white border border-slate-200 rounded-lg hover:shadow-md transition-shadow mb-2";
            itemDiv.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-mono text-sm text-slate-600">ID: ${
                    record.captcha_id ? record.captcha_id : "N/A"
                  }</span>
                  <span class="px-2 py-0.5 text-xs rounded ${statusClass}">${statusText}</span>
                </div>
                <div class="text-xs text-slate-500 space-y-0.5">
                  <div>验证码: <span class="font-semibold text-slate-700 font-mono">${
                    record.code
                  }</span></div>
                  <div>创建时间: ${
                    record.timestamp_readable ||
                    new Date(record.timestamp * 1000).toLocaleString("zh-CN")
                  }</div>
                  ${
                    record.verified_at_readable
                      ? `<div>验证时间: ${record.verified_at_readable}</div>`
                      : ""
                  }
                  ${
                    record.verified_input
                      ? `<div>用户输入: <span class="${
                          record.status === "verified_success"
                            ? "text-green-600"
                            : "text-red-600"
                        } font-semibold">${record.verified_input}</span></div>`
                      : ""
                  }
                  <div>客户端IP: ${record.client_ip || "N/A"}</div>
                </div>
              </div>
              <button onclick="showCaptchaDetail('${record.captcha_id}')" 
                class="text-sm text-blue-600 hover:text-blue-800 ml-2 bg-blue-50 px-2 py-1 rounded">
                详情
              </button>
            </div>
            ${
              record.html
                ? `
              <div class="mt-2 pt-2 border-t border-slate-100">
                <div class="text-xs text-slate-500 mb-1">验证码图片:</div>
                <div class="flex items-center justify-center bg-slate-50 p-2 rounded overflow-hidden">
                  <div class="scale-75 origin-center">${record.html}</div>
                </div>
              </div>
            `
                : ""
            }
          `;
            listContainer.appendChild(itemDiv);
          });

          console.log(`[验证码历史] 已加载 ${records.length} 条记录`);
        } catch (e) {
          console.error("[验证码历史] 加载失败:", e);
          listContainer.innerHTML = `<p class="text-red-500 text-center py-10">加载验证码历史时发生错误: ${e.message}</p>`;
        }
      }
      function showCaptchaDetail(captchaId) {
        console.log("显示验证码详情:", captchaId);
        fetch(`/api/captcha/detail/${captchaId}`, {
          headers: {
            "X-Session-ID": sessionUUID,
          },
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success && result.data) {
              const captcha = result.data;
              if (captcha) {
                populateCaptchaDetailModal(captcha);
                const modal = $("captcha-detail-modal");
                if (modal) {
                  modal.classList.remove("hidden");
                  document.body.classList.add("modal-visible");
                }
              } else {
                showModalAlert("未找到该验证码的详细信息");
              }
            } else {
              showModalAlert(
                "获取验证码详情失败：" + (result.message || "未知错误")
              );
            }
          })
          .catch((error) => {
            console.error("[验证码详情] 获取失败:", error);
            showModalAlert("获取验证码详情时发生错误：" + error.message);
          });
      }
      function populateCaptchaDetailModal(captcha) {
        $("detail-captcha-id").textContent = captcha.captcha_id || "-";
        $("detail-code").textContent = captcha.code || "-";
        const statusElement = $("detail-status");
        const statusConfig = {
          created: { text: "待验证", class: "bg-yellow-100 text-yellow-800" },
          verified_success: {
            text: "验证成功",
            class: "bg-green-100 text-green-800",
          },
          verified_failed: {
            text: "验证失败",
            class: "bg-red-100 text-red-800",
          },
          expired: { text: "已过期", class: "bg-gray-100 text-gray-800" },
          test_generated: {
            text: "测试生成",
            class: "bg-blue-100 text-blue-800",
          },
        };
        const statusInfo = statusConfig[captcha.status] || {
          text: captcha.status,
          class: "bg-gray-100 text-gray-800",
        };
        statusElement.textContent = statusInfo.text;
        statusElement.className = `px-2 py-1 text-xs rounded ${statusInfo.class}`;
        $("detail-created-time").textContent =
          captcha.timestamp_readable ||
          new Date(captcha.timestamp * 1000).toLocaleString("zh-CN");
        const verifiedTimeContainer = $("detail-verified-time-container");
        if (captcha.verified_at_readable) {
          $("detail-verified-time").textContent = captcha.verified_at_readable;
          verifiedTimeContainer.classList.remove("hidden");
        } else {
          verifiedTimeContainer.classList.add("hidden");
        }
        const expiredTimeContainer = $("detail-expired-time-container");
        if (captcha.expired_at_readable) {
          $("detail-expired-time").textContent = captcha.expired_at_readable;
          expiredTimeContainer.classList.remove("hidden");
        } else {
          expiredTimeContainer.classList.add("hidden");
        }
        const verificationCard = $("detail-verification-card");
        if (captcha.verified_input) {
          $("detail-user-input").textContent = captcha.verified_input;
          $("detail-user-input").className =
            captcha.status === "verified_success"
              ? "font-mono font-bold text-green-600"
              : "font-mono font-bold text-red-600";
          const resultText =
            captcha.status === "verified_success"
              ? "✅ 验证成功"
              : "❌ 验证失败";
          const resultClass =
            captcha.status === "verified_success"
              ? "text-green-600 font-semibold"
              : "text-red-600 font-semibold";
          $("detail-verification-result").textContent = resultText;
          $("detail-verification-result").className = resultClass;

          verificationCard.classList.remove("hidden");
        } else {
          verificationCard.classList.add("hidden");
        }
        $("detail-client-ip").textContent = captcha.client_ip || "N/A";
        $("detail-user-agent").textContent = captcha.user_agent || "N/A";
        const imageCard = $("detail-captcha-image-card");
        const htmlContainer = $("detail-captcha-html");
        if (captcha.html) {
          htmlContainer.innerHTML = captcha.html;
          imageCard.classList.remove("hidden");
        } else {
          htmlContainer.innerHTML =
            '<p class="text-slate-400">验证码图片不可用</p>';
          imageCard.classList.add("hidden");
        }
      }
      function closeCaptchaDetailModal() {
        const modal = $("captcha-detail-modal");
        if (modal) {
          modal.classList.add("hidden");
        }
      }
      async function loadReminders() {
        const listContainer = $("admin-reminders-list_modal");
        listContainer.innerHTML =
          '<p class="text-slate-400 text-center py-10">加载中...</p>';

        try {
          const response = await fetch("/api/reminders/list", {
            method: "GET",
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();
          if (!result.success) {
            listContainer.innerHTML = `<p class="text-red-500 text-center py-10">${
              result.message || "加载失败"
            }</p>`;
            return;
          }
          const reminders = result.reminders || [];
          const total = reminders.length;
          const enabled = reminders.filter((r) => r.enabled).length;
          const disabled = total - enabled;
          $("reminder-stat-total").textContent = total;
          $("reminder-stat-enabled").textContent = enabled;
          $("reminder-stat-disabled").textContent = disabled;
          if (reminders.length === 0) {
            listContainer.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无提醒，点击"添加提醒"创建新提醒</p>';
            return;
          }
          listContainer.innerHTML = "";
          reminders.forEach((reminder) => {
            const itemDiv = document.createElement("div");
            itemDiv.className =
              "p-4 bg-white border border-slate-200 rounded-lg hover:shadow-md transition-shadow";
            const isCrossDay = reminder.start_time > reminder.end_time;
            const timeRangeClass = isCrossDay
              ? "text-purple-600"
              : "text-blue-600";
            const timeRangeIcon = isCrossDay ? "🌙" : "☀️";
            const timeRangeHint = isCrossDay ? "（跨天）" : "";
            itemDiv.innerHTML = `
            <div class="flex justify-between items-start">
              <!-- 左侧：提醒信息 -->
              <div class="flex-1">
                <!-- 标题和状态标签 -->
                <div class="flex items-center gap-2 mb-2">
                  <h5 class="font-semibold text-slate-800 text-base">${escapeHtml(
                    reminder.title
                  )}</h5>
                  ${
                    reminder.enabled
                      ? '<span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded">启用</span>'
                      : '<span class="px-2 py-0.5 text-xs bg-slate-100 text-slate-600 rounded">禁用</span>'
                  }
                </div>
                <!-- 提醒内容 -->
                <p class="text-sm text-slate-600 mb-3 line-clamp-2">${escapeHtml(
                  reminder.message
                )}</p>
                <!-- 时间范围 -->
                <div class="flex items-center gap-2 text-sm ${timeRangeClass}">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>${timeRangeIcon} ${reminder.start_time} - ${
              reminder.end_time
            } ${timeRangeHint}</span>
                </div>
                <!-- 创建和更新时间 -->
                <div class="mt-2 text-xs text-slate-400 space-y-0.5">
                  <div>创建时间: ${formatTimestamp(reminder.created_at)}</div>
                  ${
                    reminder.updated_at &&
                    reminder.updated_at !== reminder.created_at
                      ? `<div>更新时间: ${formatTimestamp(
                          reminder.updated_at
                        )}</div>`
                      : ""
                  }
                </div>
              </div>
              <!-- 右侧：操作按钮 -->
              <div class="flex flex-col gap-2 ml-4">
                <!-- 编辑按钮 -->
                <button onclick="openReminderEditModal('${reminder.id}')" 
                  class="btn btn-ghost !py-1 !px-3 text-xs whitespace-nowrap hover:bg-sky-50 hover:text-sky-600"
                  title="编辑提醒">
                  <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  编辑
                </button>
                <!-- 启用/禁用切换按钮 -->
                <button onclick="toggleReminderEnabled('${
                  reminder.id
                }', ${!reminder.enabled})" 
                  class="btn btn-ghost !py-1 !px-3 text-xs whitespace-nowrap ${
                    reminder.enabled
                      ? "hover:bg-yellow-50 hover:text-yellow-600"
                      : "hover:bg-green-50 hover:text-green-600"
                  }"
                  title="${reminder.enabled ? "禁用提醒" : "启用提醒"}">
                  <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="${
                        reminder.enabled
                          ? "M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
                          : "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      }"></path>
                  </svg>
                  ${reminder.enabled ? "禁用" : "启用"}
                </button>

                <!-- 删除按钮 -->
                <button onclick="deleteReminder('${reminder.id}', '${escapeHtml(
              reminder.title
            )}')" 
                  class="btn btn-ghost !py-1 !px-3 text-xs whitespace-nowrap hover:bg-red-50 hover:text-red-600"
                  title="删除提醒">
                  <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  删除
                </button>
              </div>
            </div>
          `;
            listContainer.appendChild(itemDiv);
          });
          console.log(`[定时提醒] 已加载 ${reminders.length} 条提醒`);
        } catch (error) {
          console.error("[定时提醒] 加载失败:", error);
          listContainer.innerHTML = `<p class="text-red-500 text-center py-10">加载提醒时发生错误: ${error.message}</p>`;
        }
      }
      async function openReminderEditModal(reminderId = "") {
        const modal = $("reminder-edit-modal");
        const title = $("reminder-modal-title");
        const idField = $("reminder-id-field");
        const titleField = $("reminder-title-field");
        const messageField = $("reminder-message-field");
        const startTimeField = $("reminder-start-time-field");
        const endTimeField = $("reminder-end-time-field");
        const enabledField = $("reminder-enabled-field");
        if (reminderId) {
          title.textContent = "✏️ 编辑定时提醒";
          try {
            const response = await fetch("/api/reminders/list", {
              method: "GET",
              headers: { "X-Session-ID": sessionUUID },
            });
            const result = await response.json();
            if (result.success) {
              const reminder = result.reminders.find(
                (r) => r.id === reminderId
              );
              if (reminder) {
                idField.value = reminder.id;
                titleField.value = reminder.title;
                messageField.value = reminder.message;
                startTimeField.value = reminder.start_time;
                endTimeField.value = reminder.end_time;
                enabledField.checked = reminder.enabled;
              } else {
                showModalAlert("提醒不存在", "错误");
                return;
              }
            }
          } catch (error) {
            console.error("[定时提醒] 加载提醒数据失败:", error);
            showModalAlert("加载提醒数据失败", "错误");
            return;
          }
        } else {
          title.textContent = "⏰ 添加定时提醒";
          idField.value = "";
          titleField.value = "";
          messageField.value = "";
          startTimeField.value = "";
          endTimeField.value = "";
          enabledField.checked = true;
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        titleField.focus();
      }
      function closeReminderEditModal() {
        const modal = $("reminder-edit-modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
      async function saveReminder() {
        const id = $("reminder-id-field").value.trim();
        const title = $("reminder-title-field").value.trim();
        const message = $("reminder-message-field").value.trim();
        const startTime = $("reminder-start-time-field").value;
        const endTime = $("reminder-end-time-field").value;
        const enabled = $("reminder-enabled-field").checked;
        if (!title) {
          showModalAlert("请输入提醒标题", "错误");
          return;
        }
        if (title.length > 50) {
          showModalAlert("提醒标题不能超过50个字符", "错误");
          return;
        }
        if (!message) {
          showModalAlert("请输入提醒内容", "错误");
          return;
        }
        if (message.length > 500) {
          showModalAlert("提醒内容不能超过500个字符", "错误");
          return;
        }
        if (!startTime || !endTime) {
          showModalAlert("请选择开始时间和结束时间", "错误");
          return;
        }
        const timePattern = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;
        if (!timePattern.test(startTime) || !timePattern.test(endTime)) {
          showModalAlert("时间格式错误，应为 HH:MM（如 19:00）", "错误");
          return;
        }

        try {
          const isUpdate = !!id;
          const apiUrl = isUpdate
            ? "/api/reminders/update"
            : "/api/reminders/add";
          const requestData = {
            title: title,
            message: message,
            start_time: startTime,
            end_time: endTime,
            enabled: enabled,
          };
          if (isUpdate) {
            requestData.id = id;
          }
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify(requestData),
          });
          const result = await response.json();
          if (result.success) {
            showModalAlert(
              isUpdate ? "提醒更新成功" : "提醒添加成功",
              "成功",
              "success"
            );
            closeReminderEditModal();
            loadReminders();
          } else {
            showModalAlert(result.message || "保存失败", "错误");
          }
        } catch (error) {
          console.error("[定时提醒] 保存失败:", error);
          showModalAlert("保存提醒时发生错误: " + error.message, "错误");
        }
      }
      async function toggleReminderEnabled(reminderId, newEnabledState) {
        try {
          const response = await fetch("/api/reminders/update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({
              id: reminderId,
              enabled: newEnabledState,
            }),
          });

          const result = await response.json();

          if (result.success) {
            console.log(
              `[定时提醒] 提醒状态已更新: ID=${reminderId}, enabled=${newEnabledState}`
            );
            loadReminders();
          } else {
            showModalAlert(result.message || "更新状态失败", "错误");
          }
        } catch (error) {
          console.error("[定时提醒] 更新状态失败:", error);
          showModalAlert("更新提醒状态时发生错误: " + error.message, "错误");
        }
      }
      async function deleteReminder(reminderId, reminderTitle) {
        const confirmed = await Swal.fire({
          title: "确认删除？",
          html: `确定要删除提醒 <strong>${escapeHtml(
            reminderTitle
          )}</strong> 吗？<br><span class="text-sm text-slate-500">此操作不可恢复</span>`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "确认删除",
          cancelButtonText: "取消",
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#64748b",
        });
        if (!confirmed.isConfirmed) {
          return;
        }
        try {
          const response = await fetch("/api/reminders/delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify({ id: reminderId }),
          });
          const result = await response.json();
          if (result.success) {
            showModalAlert("提醒已删除", "成功", "success");
            loadReminders();
          } else {
            showModalAlert(result.message || "删除失败", "错误");
          }
        } catch (error) {
          console.error("[定时提醒] 删除失败:", error);
          showModalAlert("删除提醒时发生错误: " + error.message, "错误");
        }
      }
      function formatTimestamp(timestamp) {
        const date = new Date(timestamp * 1000);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }
      let shownReminders = new Set();
      async function checkAndShowReminders() {
        if (!sessionUUID) {
          sessionUUID = getUUIDFromURL();
          if (!sessionUUID) {
            logMessage_Error("跳过提醒检查: sessionUUID 未定义");
            return;
          }
        }
        try {
          const response = await fetch("/api/reminders/check", {
            method: "GET",
            headers: {
              "X-Session-ID": sessionUUID,
            },
          });
          const result = await response.json();
          if (!result.success) {
            console.error("[定时提醒] 检查失败:", result.message);
            return;
          }
          const reminders = result.reminders || [];
          for (const reminder of reminders) {
            if (shownReminders.has(reminder.id)) {
              continue;
            }
            shownReminders.add(reminder.id);
            Swal.fire({
              title: reminder.title,
              html: reminder.message.replace(/\n/g, "<br>"),
              icon: "info",
              confirmButtonText: "知道了",
              allowOutsideClick: true,
              allowEscapeKey: true,
              customClass: {
                popup: "reminder-alert-popup",
                title: "reminder-alert-title",
                htmlContainer: "reminder-alert-content",
              },
            });

            console.log(`[定时提醒] 已显示提醒: ${reminder.title}`);
          }
        } catch (error) {
          console.error("[定时提醒] 检查提醒时发生错误:", error);
        }
      }
      async function loadSSLInfo() {
        try {
          const response = await fetch("/api/admin/ssl/info", {
            method: "GET",
            headers: {
              "X-Session-ID": sessionUUID,
              "Content-Type": "application/json",
            },
          });
          const data = await response.json();
          if (data.success) {
            const sslEnabledToggle = $("ssl-enabled-toggle");
            const httpsOnlyToggle = $("https-only-toggle");
            if (sslEnabledToggle) {
              sslEnabledToggle.checked = data.config.ssl_enabled || false;
            }

            if (httpsOnlyToggle) {
              httpsOnlyToggle.checked = data.config.https_only || false;
            }
            updateSSLStatusBadge(data.config.ssl_enabled);
            const certInfoContent = $("ssl-cert-info-content");

            if (certInfoContent) {
              if (
                data.cert_info &&
                Object.keys(data.cert_info).length > 0 &&
                !data.cert_info.error
              ) {
                let html = '<div class="space-y-2">';
                if (data.cert_info.error) {
                  html += `<div class="text-red-600">⚠️ ${data.cert_info.error}</div>`;
                  if (data.cert_info.install_hint) {
                    html += `<div class="text-sm text-slate-500">${data.cert_info.install_hint}</div>`;
                  }
                } else if (!data.cert_info.subject) {
                  html +=
                    '<p class="text-amber-600 text-center py-4">无法解析证书，请检查路径是否正确。</p>';
                } else {
                  if (data.cert_info.subject) {
                    html += `<div class="flex justify-between">
                    <span class="text-slate-600">主题 (Subject):</span>
                    <span class="font-mono text-sm">${escapeHtml(
                      data.cert_info.subject
                    )}</span>
                  </div>`;
                  }

                  if (data.cert_info.issuer) {
                    html += `<div class="flex justify-between">
                    <span class="text-slate-600">颁发者 (Issuer):</span>
                    <span class="font-mono text-sm">${escapeHtml(
                      data.cert_info.issuer
                    )}</span>
                  </div>`;
                  }

                  if (data.cert_info.not_before) {
                    html += `<div class="flex justify-between">
                    <span class="text-slate-600">生效日期:</span>
                    <span class="text-sm">${formatDate(
                      data.cert_info.not_before
                    )}</span>
                  </div>`;
                  }

                  if (data.cert_info.not_after) {
                    const isExpired = data.cert_info.is_expired || false;
                    const expiryClass = isExpired
                      ? "text-red-600"
                      : "text-green-600";
                    html += `<div class="flex justify-between">
                    <span class="text-slate-600">过期日期:</span>
                    <span class="text-sm ${expiryClass}">${formatDate(
                      data.cert_info.not_after
                    )}</span>
                  </div>`;

                    if (isExpired) {
                      html += `<div class="text-red-600 text-sm mt-2">⚠️ 证书已过期</div>`;
                    }
                  }

                  if (data.cert_info.san && data.cert_info.san.length > 0) {
                    html += `<div class="mt-2">
                    <span class="text-slate-600">域名 (SAN):</span>
                    <div class="mt-1 flex flex-wrap gap-1">`;
                    data.cert_info.san.forEach((domain) => {
                      html += `<span class="px-2 py-1 bg-slate-100 rounded text-xs">${escapeHtml(
                        domain
                      )}</span>`;
                    });
                    html += `</div></div>`;
                  }
                }

                html += "</div>";
                certInfoContent.innerHTML = html;
              } else {
                if (data.config.ssl_enabled) {
                  let errorMsg = "SSL已启用，但证书路径为空或证书无效。";
                  if (data.cert_info && data.cert_info.error) {
                    errorMsg = `SSL已启用，但证书加载失败: ${data.cert_info.error}`;
                  }
                  certInfoContent.innerHTML = `<p class="text-amber-600 text-center py-4">${escapeHtml(
                    errorMsg
                  )}</p>`;
                } else {
                  certInfoContent.innerHTML =
                    '<p class="text-slate-400 text-center py-4">HTTPS/SSL 未启用</p>';
                }
              }
            }
            console.log("[SSL管理] SSL信息加载成功");
          } else {
            showTempMessage(data.message || "SSL信息加载失败", "error");
          }
        } catch (error) {
          console.error("[SSL管理] 加载SSL信息失败:", error);
          showTempMessage("加载SSL信息失败", "error");
        }
      }
      function updateSSLStatusBadge(sslEnabled) {
        const badge = $("ssl-status-badge");
        if (!badge) return;

        if (sslEnabled) {
          badge.className =
            "px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700";
          badge.textContent = "✓ HTTPS 已启用";
        } else {
          badge.className =
            "px-3 py-1 rounded-full text-sm font-semibold bg-slate-100 text-slate-600";
          badge.textContent = "HTTP 模式";
        }
      }
      async function uploadSSLCertificate() {
        const certFileInput = $("ssl-cert-file-input");
        const keyFileInput = $("ssl-key-file-input");
        const uploadBtn = $("ssl-upload-btn");
        if (!certFileInput.files || certFileInput.files.length === 0) {
          showTempMessage("请选择证书文件", "error");
          return;
        }
        if (!keyFileInput.files || keyFileInput.files.length === 0) {
          showTempMessage("请选择密钥文件", "error");
          return;
        }
        setButtonLoading(uploadBtn, true, "上传中...");
        try {
          const formData = new FormData();
          formData.append("cert_file", certFileInput.files[0]);
          formData.append("key_file", keyFileInput.files[0]);
          const response = await fetch("/api/admin/ssl/upload", {
            method: "POST",
            headers: {
              "X-Session-ID": sessionUUID,
            },
            body: formData,
          });
          const data = await response.json();
          if (data.success) {
            showTempMessage("证书上传成功", "success");
            certFileInput.value = "";
            keyFileInput.value = "";
            await loadSSLInfo();
          } else {
            showTempMessage(data.message || "证书上传失败", "error");
          }
        } catch (error) {
          console.error("[SSL管理] 上传证书失败:", error);
          showTempMessage("上传失败: " + error.message, "error");
        } finally {
          setButtonLoading(uploadBtn, false, "上传证书");
        }
      }
      async function saveSSLConfig() {
        const saveBtn = $("ssl-save-config-btn");
        const sslEnabledToggle = $("ssl-enabled-toggle");
        const httpsOnlyToggle = $("https-only-toggle");
        setButtonLoading(saveBtn, true, "保存中...");
        try {
          const configData = {
            ssl_enabled: sslEnabledToggle.checked,
            https_only: httpsOnlyToggle.checked,
          };
          const response = await fetch("/api/admin/ssl/config", {
            method: "POST",
            headers: {
              "X-Session-ID": sessionUUID,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(configData),
          });
          const data = await response.json();
          if (data.success) {
            showModalAlert("配置已保存，需要重启服务器才能生效", "保存成功");
            updateSSLStatusBadge(configData.ssl_enabled);
          } else {
            showModalAlert(data.message || "保存配置失败", "保存失败");
          }
        } catch (error) {
          console.error("[SSL管理] 保存配置失败:", error);
          showModalAlert("保存失败: " + error.message, "网络错误");
        } finally {
          setButtonLoading(saveBtn, false, "保存配置");
        }
      }
      function formatDate(isoString) {
        try {
          const date = new Date(isoString);
          return date.toLocaleString("zh-CN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (e) {
          return isoString;
        }
      }
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
      // ============================================================================
      // 定时提醒检查器
      // ============================================================================
      function startReminderChecker() {
        checkAndShowReminders();
        setInterval(checkAndShowReminders, 60 * 1000);

        console.log("[定时提醒] 定时检查已启动，每分钟检查一次");
      }
      async function saveSystemConfig() {
        const btn = $("admin-save-config_modal");
        setButtonLoading(btn, true, "保存中...");

        try {
          const configData = {
            Guest: {
              allow_guest_login:
                $("config-Guest-allow_guest_login").value === "true",
            },
            System: {
              session_expiry_days: parseInt(
                $("config-System-session_expiry_days").value,
                10
              ),
              school_accounts_dir: $("config-System-school_accounts_dir").value,
              system_accounts_dir: $("config-System-system_accounts_dir").value,
              permissions_file: $("config-System-permissions_file").value,
              session_monitor_check_interval: parseInt(
                $("config-System-session_monitor_check_interval").value,
                10
              ),
              session_inactivity_timeout: parseInt(
                $("config-System-session_inactivity_timeout").value,
                10
              ),
            },
            Logging: {
              log_rotation_size_mb: parseInt(
                $("config-Logging-log_rotation_size_mb").value,
                10
              ),
              archive_max_size_mb: parseInt(
                $("config-Logging-archive_max_size_mb").value,
                10
              ),
              log_dir: $("config-Logging-log_dir").value,
              archive_dir: $("config-Logging-archive_dir").value,
            },
            Security: {
              password_storage: $("config-Security-password_storage").value,
              brute_force_protection:
                $("config-Security-brute_force_protection").value === "true",
              login_log_retention_days: parseInt(
                $("config-Security-login_log_retention_days").value,
                10
              ),
            },
            Map: {
              amap_js_key: $("config-Map-amap_js_key").value,
            },
            API: {
              ip_api_key: $("config-API-ip_api_key").value,
            },
          };
          const response = await fetch("/api/admin/config/save", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Session-ID": sessionUUID,
            },
            body: JSON.stringify(configData),
          });
          const result = await response.json();
          if (result.success) {
            showModalAlert(
              "配置已保存。请注意，部分配置（如路径）需要重启程序才能生效。",
              "保存成功"
            );
            showButtonSuccess(btn, "保存成功", 2000);
          } else {
            showModalAlert(`保存失败: ${result.message}`, "保存失败");
            showButtonError(btn, "保存失败", 2000);
          }
        } catch (e) {
          showModalAlert(`保存配置时发生错误: ${e.message}`, "保存失败");
          showButtonError(btn, "保存失败", 2000);
        } finally {
          setButtonLoading(btn, false, "保存配置");
        }
      }
      function showTempMessage(msg, type = "info") {
        const colors = {
          success: "bg-green-100 text-green-700 border-green-300",
          warning: "bg-amber-100 text-amber-700 border-amber-300",
          error: "bg-red-100 text-red-700 border-red-300",
          info: "bg-blue-100 text-blue-700 border-blue-300",
        };
        const div = document.createElement("div");
        div.className = `fixed top-4 right-4 px-4 py-2 rounded-lg border-2 ${colors[type]} z-50 shadow-lg`;
        div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(() => {
          div.remove();
        }, 3000);
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof window.APP_CONFIG === "undefined") {
          console.error("APP_CONFIG 未定义, UI动态配置脚本跳过。");
          window.APP_CONFIG = { sms_enabled: false, reg_verify_enabled: false };
        }
        const config = window.APP_CONFIG;
        if (!config.sms_enabled) {
          console.log("短信服务已禁用，正在隐藏相关UI元素...");
          const switchToSmsBtn = document.getElementById("auth-switch-to-sms");
          if (switchToSmsBtn) switchToSmsBtn.style.display = "none";
          const smsSection = document.getElementById("auth-sms-section");
          if (smsSection) smsSection.style.display = "none";
          const adminModifySmsGroup = document.getElementById(
            "admin-modify-phone-sms-group"
          );
          if (adminModifySmsGroup) adminModifySmsGroup.style.display = "none";
          const newUserSmsGroup = document.getElementById("newUserSmsGroup");
          if (newUserSmsGroup) newUserSmsGroup.style.display = "none";
        }
        if (!config.reg_verify_enabled) {
          console.log("手机注册/验证已禁用，正在隐藏相关UI元素...");
          const regPhoneDiv = document.getElementById("auth-reg-phone-wrapper");
          if (regPhoneDiv) regPhoneDiv.style.display = "none";
          const regSmsDiv = document.getElementById("auth-reg-sms-wrapper");
          if (regSmsDiv) regSmsDiv.style.display = "none";
          const profileModifyBtn = document.getElementById(
            "profile-modify-phone-btn"
          );
          if (profileModifyBtn) profileModifyBtn.style.display = "none";
          const profilePhoneHint =
            document.getElementById("profile-phone-hint");
          if (profilePhoneHint) profilePhoneHint.style.display = "none";
        }
        console.log("[定时提醒] 正在启动定时提醒检查器...");
        startReminderChecker();
      });
      // ==================== 移动端事件绑定 (Phase 4b) ====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("[移动端] 开始绑定Phase 4b功能...");
        const mobileRandomUABtn = document.getElementById(
          "mobile-random-ua-btn"
        );
        if (mobileRandomUABtn) {
          mobileRandomUABtn.addEventListener("click", async () => {
            try {
              const newUA = await callPythonAPI("generate_new_ua");
              const mobileUALabel = document.getElementById("mobile-ua-label");
              if (mobileUALabel) {
                mobileUALabel.textContent = newUA || "(生成失败)";
              }
              const pcUALabel = document.getElementById("ua-label");
              if (pcUALabel) {
                pcUALabel.textContent = newUA || "(生成失败)";
              }
              console.log("[移动端] 已生成新的UA:", newUA);
            } catch (error) {
              console.error("[移动端] 生成UA失败:", error);
              showModalAlert("生成UA失败，请重试");
            }
          });
          console.log("[移动端] 随机UA按钮已绑定");
        }
        const mobileImportBtn = document.getElementById("mobile-import-button");
        if (mobileImportBtn) {
          mobileImportBtn.addEventListener("click", async (e) => {
            if (typeof checkButtonPermission === "function") {
              if (
                !(await checkButtonPermission(
                  "mobile-import-button",
                  "use_import_button"
                ))
              ) {
                return;
              }
            }
            if (typeof importTask === "function") {
              await importTask();
            } else {
              console.error("[移动端] importTask函数未定义");
              showModalAlert("导入功能暂不可用");
            }
          });
          console.log("[移动端] 导入按钮已绑定");
        }
        // ========================================
        // 【移动端参数设置面板】
        // ========================================
        const mobileParamsContainer = document.getElementById(
          "mobile-params-container"
        );
        if (mobileParamsContainer && typeof createParamInputs === "function") {
          const excludeGroups = ["主题设置", "自动签到"];
          createParamInputs(
            mobileParamsContainer,
            "mobile-param",
            function (e) {
              const input = e.target;
              const key = input.dataset.key;
              let value;
              if (input.type === "checkbox") {
                value = input.checked;
              } else if (input.type === "number") {
                value = parseFloat(input.value) || 0;
              } else {
                value = input.value;
              }
              if (typeof callPythonAPI === "function") {
                callPythonAPI("update_param", key, value);
                console.log(`[移动端] 参数已更新: ${key} = ${value}`);
              }
            },
            excludeGroups
          );
          console.log("[移动端] 参数设置面板已初始化");
        }
        console.log("[移动端] Phase 4b功能绑定完成");
      });
      document.addEventListener("DOMContentLoaded", function () {
        console.log("[移动端] 开始初始化Phase 4d全局设置面板...");
        const mobileMultiGlobalParamsContainer = document.getElementById(
          "mobile-multi-global-params-container"
        );
        if (
          mobileMultiGlobalParamsContainer &&
          typeof createParamInputs === "function"
        ) {
          const excludeGroups = ["主题设置"];
          createParamInputs(
            mobileMultiGlobalParamsContainer,
            "mobile-multi-param",
            function (e) {
              const input = e.target;
              const key = input.dataset.key;
              let value;
              if (input.type === "checkbox") {
                value = input.checked;
              } else if (input.type === "number") {
                value = parseFloat(input.value) || 0;
              } else {
                value = input.value;
              }
              if (typeof callPythonAPI === "function") {
                callPythonAPI("update_param", key, value);
                console.log(`[移动端多账号] 全局参数已更新: ${key} = ${value}`);
              }
            },
            excludeGroups
          );
          if (
            typeof pythonParams !== "undefined" &&
            typeof updateParamInputs === "function"
          ) {
            updateParamInputs(
              mobileMultiGlobalParamsContainer,
              "mobile-multi-param",
              pythonParams
            );
            console.log("[移动端] 多账号全局参数已自动填充配置数值");
          } else {
            console.warn(
              "[移动端] pythonParams或updateParamInputs未定义，无法自动填充配置"
            );
          }

          console.log("[移动端] 多账号全局参数面板已初始化");
        }
        const configSelect = document.getElementById(
          "multi-config-user-select"
        );
        if (configSelect) {
          if (!configSelect._refreshBound) {
            configSelect.addEventListener("focus", refreshUserList);
            configSelect.addEventListener("click", refreshUserList);
            configSelect._refreshBound = true;
            console.log("[移动端] 配置文件选择器已绑定自动刷新事件");
          }
          if (typeof refreshUserList === "function") {
            refreshUserList();
            console.log("[移动端] 配置文件选择器已执行初始刷新");
          }
        }

        console.log("[移动端] Phase 4d全局设置面板初始化完成");
      });

      function toggleMobileMultiAdminPanel(show) {
        const modal = document.getElementById("mobile-multi-admin-panel-modal");
        if (modal) {
          if (show) {
            modal.classList.remove("hidden");
            initMobileAdminPanel("mobile-multi-admin");
          } else {
            modal.classList.add("hidden");
          }
        }
      }
      function initMobileAdminPanel(prefix) {
        const userGroup = currentUserData?.group || "user";
        let tabsNavId, contentId;
        if (prefix === "mobile-multi-admin") {
          tabsNavId = "mobile-multi-admin-tabs-nav";
          contentId = "mobile-multi-admin-panel-content";
        } else if (prefix === "mobile-multi-admin-panel") {
          tabsNavId = "mobile-multi-admin-tabs-nav-panel";
          contentId = "mobile-multi-admin-content-panel";
        } else if (prefix === "mobile-admin-panel") {
          tabsNavId = "mobile-admin-tabs-nav-panel";
          contentId = "mobile-admin-panel-content-panel";
        } else {
          tabsNavId = "mobile-admin-tabs-nav";
          contentId = "mobile-admin-panel-content";
        }
        const tabsNav = document.getElementById(tabsNavId);
        if (!tabsNav) {
          console.error(`[移动端管理面板] 找不到标签页导航容器: ${tabsNavId}`);
          return;
        }
        const allTabs = [
          {
            id: "users",
            label: "用户",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
            permission: "admin",
          },
          {
            id: "groups",
            label: "权限组",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>',
            permission: "admin",
          },
          {
            id: "logs",
            label: "日志",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
            permission: "admin",
          },
          {
            id: "health",
            label: "状态",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>',
            permission: "all",
          },
          {
            id: "profile",
            label: "资料",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',
            permission: "all",
          },
          {
            id: "sessions",
            label: "会话",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            permission: "all",
          },
          {
            id: "messages",
            label: "留言",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>',
            permission: "all",
          },
          {
            id: "ipban",
            label: "IP封禁",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>',
            permission: "admin",
          },
          {
            id: "sms",
            label: "短信",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
            permission: "admin",
          },
          {
            id: "config",
            label: "配置",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>',
            permission: "admin",
          },
          {
            id: "captcha",
            label: "验证码",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
            permission: "admin",
          },
          {
            id: "reminders",
            label: "提醒",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            permission: "admin",
          },
          {
            id: "ssl",
            label: "HTTPS",
            icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>',
            permission: "admin",
          },
        ];
        const visibleTabs = allTabs.filter((tab) => {
          if (tab.permission === "all") return true;
          if (
            tab.permission === "admin" &&
            (userGroup === "admin" || userGroup === "superadmin")
          )
            return true;
          return false;
        });
        tabsNav.innerHTML = "";
        visibleTabs.forEach((tab, index) => {
          const button = document.createElement("button");
          const isActive = index === 0;
          button.className = `px-4 py-2 font-semibold text-xs whitespace-nowrap rounded-lg transition ${
            isActive
              ? "text-sky-600 bg-sky-50 border-b-2 border-sky-600"
              : "text-slate-400 hover:text-slate-600 hover:bg-slate-50"
          }`;
          button.innerHTML = `${tab.icon}${tab.label}`;
          button.onclick = () => switchMobileAdminTab(tab.id, prefix);
          tabsNav.appendChild(button);
        });
        if (visibleTabs.length > 0) {
          switchMobileAdminTab(visibleTabs[0].id, prefix);
        }
      }
      function switchMobileAdminTab(tabId, prefix) {
        let tabsNavId, contentId;
        if (prefix === "mobile-multi-admin") {
          tabsNavId = "mobile-multi-admin-tabs-nav";
          contentId = "mobile-multi-admin-panel-content";
        } else if (prefix === "mobile-multi-admin-panel") {
          tabsNavId = "mobile-multi-admin-tabs-nav-panel";
          contentId = "mobile-multi-admin-content-panel";
        } else if (prefix === "mobile-admin-panel") {
          tabsNavId = "mobile-admin-tabs-nav-panel";
          contentId = "mobile-admin-panel-content-panel";
        } else {
          tabsNavId = "mobile-admin-tabs-nav";
          contentId = "mobile-admin-panel-content";
        }
        const tabsNav = document.getElementById(tabsNavId);
        const content = document.getElementById(contentId);

        if (!tabsNav || !content) {
          console.error(
            `[移动端管理面板] 找不到容器元素: tabsNavId=${tabsNavId}, contentId=${contentId}`
          );
          return;
        }
        Array.from(tabsNav.children).forEach((button) => {
          const buttonText = button.textContent.trim();
          const tabMap = {
            用户: "users",
            权限组: "groups",
            日志: "logs",
            状态: "health",
            资料: "profile",
            会话: "sessions",
            留言: "messages",
            IP封禁: "ipban",
            短信: "sms",
            配置: "config",
            验证码: "captcha",
            提醒: "reminders",
            HTTPS: "ssl",
          };
          const buttonTabId = tabMap[buttonText];
          if (buttonTabId === tabId) {
            button.className =
              "px-4 py-2 font-semibold text-xs whitespace-nowrap rounded-lg transition text-sky-600 bg-sky-50 border-b-2 border-sky-600";
          } else {
            button.className =
              "px-4 py-2 font-semibold text-xs whitespace-nowrap rounded-lg transition text-slate-400 hover:text-slate-600 hover:bg-slate-50";
          }
        });
        if (prefix === "mobile-admin-panel") {
          const allPanels = [
            "mobile-admin-users-panel-panel",
            "mobile-admin-groups-panel-panel",
            "mobile-admin-logs-panel-panel",
            "mobile-admin-health-panel-panel",
            "mobile-admin-profile-panel-panel",
            "mobile-admin-sessions-panel-panel",
            "mobile-admin-messages-panel-panel",
            "mobile-admin-ipban-panel-panel",
            "mobile-admin-sms-panel-panel",
            "mobile-admin-config-panel-panel",
            "mobile-admin-captcha-panel-panel",
            "mobile-admin-reminders-panel-panel",
            "mobile-admin-ssl-panel-panel",
          ];

          allPanels.forEach((panelId) => {
            const panel = document.getElementById(panelId);
            if (panel) panel.classList.add("hidden");
          });
          const captchaHistoryPanelMobile = document.getElementById(
            "admin-captcha-history-panel_modal"
          );
          if (captchaHistoryPanelMobile)
            captchaHistoryPanelMobile.classList.add("hidden");
          const targetPanelId = `mobile-admin-${tabId}-panel-panel`;
          const targetPanel = document.getElementById(targetPanelId);
          if (targetPanel) {
            targetPanel.classList.remove("hidden");
          } else {
            console.warn(`[移动端管理面板] 找不到目标面板: ${targetPanelId}`);
          }
          switch (tabId) {
            case "users":
              loadAdminUsers();
              setTimeout(() => copyAdminContentToPanelVersion("users"), 500);
              break;
            case "groups":
              loadAdminGroups();
              setTimeout(() => copyAdminContentToPanelVersion("groups"), 500);
              break;
            case "logs":
              loadAdminLogs(1);
              setTimeout(() => copyAdminContentToPanelVersion("logs"), 500);
              break;
            case "health":
              loadHealthStatus();
              setTimeout(() => copyAdminContentToPanelVersion("health"), 500);
              break;
            case "profile":
              loadPersonalInfo();
              setTimeout(() => copyAdminContentToPanelVersion("profile"), 500);
              break;
            case "sessions":
              loadAdminSessions();
              setTimeout(() => copyAdminContentToPanelVersion("sessions"), 500);
              break;
            case "messages":
              loadMessages();
              setTimeout(() => copyAdminContentToPanelVersion("messages"), 600);
              break;
            case "ipban":
              loadIPBans();
              setTimeout(() => copyAdminContentToPanelVersion("ipban"), 500);
              break;
            case "sms":
              loadSMSConfig();
              setTimeout(() => copyAdminContentToPanelVersion("sms"), 500);
              break;
            case "config":
              loadSystemConfig();
              setTimeout(() => copyAdminContentToPanelVersion("config"), 500);
              break;
            case "captcha":
              loadCaptchaSettings();
              const dateInput = $("captcha-history-date");
              if (dateInput) {
                const today = new Date().toISOString().split("T")[0];
                dateInput.value = today;
              }
              loadCaptchaHistory();
              setTimeout(() => copyAdminContentToPanelVersion("captcha"), 500);
              break;
            case "reminders":
              loadReminders();
              setTimeout(
                () => copyAdminContentToPanelVersion("reminders"),
                500
              );
              break;
            case "ssl":
              loadSSLInfo();
              setTimeout(() => copyAdminContentToPanelVersion("ssl"), 500);
              break;
          }
          return;
        }

        content.innerHTML =
          '<p class="text-slate-400 text-center py-10 text-sm">加载中...</p>';
        switch (tabId) {
          case "users":
            loadAdminUsers();
            setTimeout(() => copyAdminContentToMobile("users", contentId), 500);
            break;
          case "groups":
            loadAdminGroups();
            setTimeout(
              () => copyAdminContentToMobile("groups", contentId),
              500
            );
            break;
          case "logs":
            loadAdminLogs(1);
            setTimeout(() => copyAdminContentToMobile("logs", contentId), 500);
            break;
          case "health":
            loadHealthStatus();
            setTimeout(
              () => copyAdminContentToMobile("health", contentId),
              500
            );
            break;
          case "profile":
            loadPersonalInfo();
            setTimeout(
              () => copyAdminContentToMobile("profile", contentId),
              500
            );
            break;
          case "sessions":
            loadAdminSessions();
            setTimeout(
              () => copyAdminContentToMobile("sessions", contentId),
              500
            );
            break;
          case "messages":
            loadMessages();
            setTimeout(
              () => copyAdminContentToMobile("messages", contentId),
              600
            );
            break;
          case "ipban":
            loadIPBans();
            setTimeout(() => copyAdminContentToMobile("ipban", contentId), 500);
            break;
          case "sms":
            loadSMSConfig();
            setTimeout(() => copyAdminContentToMobile("sms", contentId), 500);
            break;
          case "config":
            loadSystemConfig();
            setTimeout(
              () => copyAdminContentToMobile("config", contentId),
              500
            );
            break;
          case "captcha":
            loadCaptchaSettings();
            const dateInputEl = $("captcha-history-date");
            if (dateInputEl) {
              dateInputEl.value = new Date().toISOString().split("T")[0];
            }
            loadCaptchaHistory();

            setTimeout(
              () => copyAdminContentToMobile("captcha", contentId),
              500
            );
            break;
          case "reminders":
            loadReminders();
            setTimeout(
              () => copyAdminContentToMobile("reminders", contentId),
              500
            );
            break;
          case "ssl":
            loadSSLInfo();
            setTimeout(() => copyAdminContentToMobile("ssl", contentId), 500);
            break;
          default:
            content.innerHTML =
              '<p class="text-slate-400 text-center py-10 text-sm">未知的标签页</p>';
        }
      }
      function copyAdminContentToMobile(tabType, mobileContentId) {
        const pcContainerMap = {
          users: "admin-users-panel_modal",
          groups: "admin-groups-panel_modal",
          logs: "admin-logs-panel_modal",
          health: "admin-health-panel_modal",
          profile: "admin-profile-panel_modal",
          sessions: "admin-sessions-panel_modal",
          messages: "admin-messages-panel_modal",
          ipban: "admin-ip-ban-modal",
          sms: "admin-sms-config-modal",
          config: "admin-config-panel_modal",
          captcha: "admin-captcha-panel_modal",
          reminders: "admin-reminders-panel_modal",
          ssl: "admin-ssl-panel_modal",
        };
        const pcContainerId = pcContainerMap[tabType];
        const pcContainer = document.getElementById(pcContainerId);
        const mobileContainer = document.getElementById(mobileContentId);

        if (!pcContainer || !mobileContainer) {
          console.error(
            `[移动端管理面板] 找不到容器: PC=${pcContainerId}, Mobile=${mobileContentId}`
          );
          mobileContainer.innerHTML =
            '<p class="text-red-500 text-center py-10 text-sm">加载失败</p>';
          return;
        }
        mobileContainer.innerHTML = pcContainer.innerHTML;
        mobileContainer.querySelectorAll("button").forEach((btn) => {
          btn.classList.add("!text-xs", "!py-1", "!px-2");
        });
        mobileContainer.querySelectorAll("h4, h5").forEach((heading) => {
          heading.classList.add("!text-sm");
        });
      }
      function copyAdminContentToPanelVersion(tabType) {
        const pcToMobileMap = {
          users: {
            pc: "admin-users-list_modal",
            mobile: "mobile-admin-users-list-panel",
          },
          groups: {
            pc: "admin-groups-list_modal",
            mobile: "mobile-admin-groups-list-panel",
          },
          logs: {
            pc: "admin-logs-content_modal",
            mobile: "mobile-admin-logs-content-panel",
          },
          health: {
            pc: "admin-health-content_modal",
            mobile: "mobile-admin-health-content-panel",
          },
          profile: {
            pc: "admin-profile-content_modal",
            mobile: "mobile-admin-profile-content-panel",
          },
          sessions: {
            pc: "admin-sessions-list_modal",
            mobile: "mobile-admin-sessions-list-panel",
          },
          messages: {
            pc: "admin-messages-list_modal",
            mobile: "mobile-admin-messages-list-panel",
          },
          ipban: { pc: "ip-ban-list", mobile: "mobile-ip-ban-list-panel" },
          sms: {
            pc: "admin-sms-config-modal",
            mobile: "mobile-admin-sms-content-panel",
          },
          config: {
            pc: "admin-config-panel_modal",
            mobile: "mobile-admin-config-content-panel",
          },
          captcha: {
            pc: "admin-captcha-list_modal",
            mobile: "mobile-admin-captcha-list-panel",
          },
          reminders: {
            pc: "admin-reminders-panel_modal",
            mobile: "mobile-admin-reminders-content-panel",
          },
          ssl: {
            pc: "admin-ssl-panel_modal",
            mobile: "mobile-admin-ssl-content-panel",
          },
        };
        const mapping = pcToMobileMap[tabType];
        if (!mapping) {
          logMessage_Error(`[移动端管理面板] 未定义的标签页类型: ${tabType}`);
          return;
        }
        const pcContainer = document.getElementById(mapping.pc);
        const mobileContainer = document.getElementById(mapping.mobile);

        if (!pcContainer || !mobileContainer) {
          logMessage_Error(
            `[移动端管理面板] 找不到容器: PC=${mapping.pc}, Mobile=${mapping.mobile}`
          );
          if (mobileContainer) {
            mobileContainer.innerHTML =
              '<p class="text-red-500 text-center py-10 text-xs">加载失败</p>';
          }
          return;
        }
        mobileContainer.innerHTML = pcContainer.innerHTML;
        mobileContainer.querySelectorAll("button").forEach((btn) => {
          btn.classList.add("!text-xs", "!py-1", "!px-2");
        });
        mobileContainer.querySelectorAll("h4, h5").forEach((heading) => {
          heading.classList.add("!text-xs");
        });
        mobileContainer
          .querySelectorAll("input, select, textarea")
          .forEach((input) => {
            input.classList.add("!text-xs");
          });
      }
      function addMobileSelectedConfig() {
        const select = document.getElementById("multi-config-user-select");
        if (!select || !select.value) {
          showTempMessage("请先选择要添加的配置文件", "error");
          return;
        }
        try {
          multi_addFromConfig();
          showTempMessage("配置已添加", "success");
        } catch (error) {
          console.error("[移动端] 添加配置失败:", error);
          showTempMessage("添加配置失败", "error");
        }
      }
      async function addMobileAllConfigs() {
        const select = document.getElementById("multi-config-user-select");
        if (!select) {
          showTempMessage("找不到配置文件选择器", "error");
          return;
        }
        const options = Array.from(select.options).filter((opt) => opt.value);
        if (options.length === 0) {
          showTempMessage("没有可添加的配置文件", "error");
          return;
        }

        try {
          showTempMessage(`正在添加 ${options.length} 个配置...`, "info");

          for (const option of options) {
            select.value = option.value;
            await multi_addFromConfig();
            await new Promise((resolve) => setTimeout(resolve, 200));
          }

          showTempMessage(`已添加 ${options.length} 个配置`, "success");
          await mobileRefreshMultiAccounts();
        } catch (error) {
          console.error("[移动端] 批量添加配置失败:", error);
          showTempMessage("批量添加配置失败", "error");
        }
      }
      function openManualAccountModal() {
        const modal = document.getElementById("mobile-manual-account-modal");
        if (!modal) {
          console.error("[移动端] 找不到手动账号输入模态框");
          return;
        }

        const usernameInput = document.getElementById(
          "manual-account-username"
        );
        const passwordInput = document.getElementById(
          "manual-account-password"
        );
        if (usernameInput) usernameInput.value = "";
        if (passwordInput) passwordInput.value = "";

        modal.classList.remove("hidden");
        modal.classList.add("show");

        setTimeout(() => {
          if (usernameInput) usernameInput.focus();
        }, 100);

        console.log("[移动端] 已打开手动账号输入模态框");
      }
      function closeManualAccountModal() {
        const modal = document.getElementById("mobile-manual-account-modal");
        if (!modal) {
          return;
        }
        modal.classList.add("hidden");
        modal.classList.remove("show");
        const usernameInput = document.getElementById(
          "manual-account-username"
        );
        const passwordInput = document.getElementById(
          "manual-account-password"
        );
        if (usernameInput) usernameInput.value = "";
        if (passwordInput) passwordInput.value = "";

        console.log("[移动端] 已关闭手动账号输入模态框");
      }
      async function confirmManualAccountAdd() {
        const usernameInput = document.getElementById(
          "manual-account-username"
        );
        const passwordInput = document.getElementById(
          "manual-account-password"
        );
        if (!usernameInput || !passwordInput) {
          showTempMessage("找不到输入框元素", "error");
          return;
        }
        const username = usernameInput.value.trim();
        if (!username) {
          showTempMessage("请输入用户名", "error");
          usernameInput.focus();
          return;
        }
        const password = passwordInput.value;
        if (!password) {
          showTempMessage("请输入密码", "error");
          passwordInput.focus();
          return;
        }

        try {
          showTempMessage("正在添加账号...", "info");
          const result = await callPythonAPI("multi_add_account", {
            username: username,
            password: password,
            params: {},
          });

          if (result.success) {
            showTempMessage("账号添加成功", "success");
            closeManualAccountModal();
            await mobileRefreshMultiAccounts();
            console.log(`[移动端] 手动添加账号成功: ${username}`);
          } else {
            showTempMessage(
              `添加失败: ${result.message || "未知错误"}`,
              "error"
            );
            console.error("[移动端] 手动添加账号失败:", result);
          }
        } catch (error) {
          console.error("[移动端] 手动添加账号异常:", error);
          showTempMessage("添加账号时发生错误", "error");
        }
      }
      function importMobileAccountList() {
        try {
          if (typeof importMultiAccountList === "function") {
            importMultiAccountList();
          } else {
            showTempMessage("导入功能未实现", "error");
            console.error("[移动端] importMultiAccountList函数未定义");
          }
        } catch (error) {
          console.error("[移动端] 导入账号列表失败:", error);
          showTempMessage("导入失败: " + error.message, "error");
        }
      }
      async function downloadMobileAccountTemplate() {
        try {
          if (typeof multi_downloadTemplate === "function") {
            await multi_downloadTemplate();
            showTempMessage("模板下载成功", "success");
          } else {
            showTempMessage("下载模板功能未实现", "error");
            console.error("[移动端] multi_downloadTemplate函数未定义");
          }
        } catch (error) {
          console.error("[移动端] 下载模板失败:", error);
          showTempMessage("下载模板失败: " + error.message, "error");
        }
      }
      function exportMobileAccountList() {
        try {
          if (typeof exportMultiAccountList === "function") {
            exportMultiAccountList();
          } else {
            showTempMessage("导出功能未实现", "error");
          }
        } catch (error) {
          console.error("[移动端] 导出账号列表失败:", error);
          showTempMessage("导出失败", "error");
        }
      }
      async function mobileRefreshSelectedAccounts() {
        try {
          const selected = document.querySelectorAll(
            '#mobile-multi-account-list input[type="checkbox"]:checked'
          );
          if (selected.length === 0) {
            showTempMessage("请先选择要刷新的账号", "error");
            return;
          }
          showTempMessage(`正在刷新 ${selected.length} 个账号...`, "info");
          if (typeof multi_refreshSelected === "function") {
            await multi_refreshSelected();
            showTempMessage("已刷新选中账号", "success");
          } else {
            showTempMessage("刷新功能未实现", "error");
          }
        } catch (error) {
          console.error("[移动端] 刷新选中账号失败:", error);
          showTempMessage("刷新失败", "error");
        }
      }
      async function deleteMobileSelectedAccounts() {
        try {
          const selected = document.querySelectorAll(
            '#mobile-multi-account-list input[type="checkbox"]:checked'
          );
          if (selected.length === 0) {
            showTempMessage("请先选择要删除的账号", "error");
            return;
          }
          showMobileConfirm(
            "确认删除",
            `确定要删除选中的 ${selected.length} 个账号吗？`,
            async () => {
              try {
                if (typeof multi_removeSelected === "function") {
                  await multi_removeSelected(true);
                  showTempMessage("已删除选中账号", "success");
                  await mobileRefreshMultiAccounts();
                } else {
                  showTempMessage("删除功能未实现", "error");
                }
              } catch (error) {
                console.error("[移动端] 删除选中账号失败:", error);
                showTempMessage("删除失败", "error");
              }
            }
          );
        } catch (error) {
          console.error("[移动端] 删除选中账号失败:", error);
          showTempMessage("删除失败", "error");
        }
      }
      async function deleteMobileAllAccounts() {
        try {
          showMobileConfirm(
            "确认删除",
            "确定要删除所有账号吗？此操作不可恢复！",
            async () => {
              try {
                if (typeof multi_removeAll === "function") {
                  await multi_removeAll(true);
                  showTempMessage("已删除所有账号", "success");
                  await mobileRefreshMultiAccounts();
                } else {
                  showTempMessage("删除功能未实现", "error");
                }
              } catch (error) {
                console.error("[移动端] 删除所有账号失败:", error);
                showTempMessage("删除失败", "error");
              }
            }
          );
        } catch (error) {
          console.error("[移动端] 删除所有账号失败:", error);
          showTempMessage("删除失败", "error");
        }
      }
      function saveMobileMultiGlobalSettings() {
        try {
          const container = document.getElementById(
            "mobile-multi-global-params-container"
          );
          if (!container) {
            showTempMessage("找不到全局参数容器", "error");
            return;
          }
          const params = {};
          container
            .querySelectorAll("input, select, textarea")
            .forEach((input) => {
              const key = input.dataset.key;
              if (!key) return;
              if (input.type === "checkbox") {
                params[key] = input.checked;
              } else if (input.type === "number") {
                params[key] = parseFloat(input.value) || 0;
              } else {
                params[key] = input.value;
              }
            });
          if (typeof callPythonAPI === "function") {
            Object.keys(params).forEach((key) => {
              callPythonAPI("update_param", key, params[key]);
            });
            showTempMessage("全局设置已保存", "success");
            console.log("[移动端] 全局参数已保存:", params);
          } else {
            showTempMessage("API不可用", "error");
          }
        } catch (error) {
          console.error("[移动端] 保存全局设置失败:", error);
          showTempMessage("保存失败", "error");
        }
      }
      function clearMobileMultiLog() {
        try {
          const mobileLog = document.getElementById("mobile-multi-log-text");
          if (mobileLog) {
            mobileLog.value = "";
          }
          const pcLog = document.getElementById("multi-log-text");
          if (pcLog) {
            pcLog.value = "";
          }

          showTempMessage("日志已清空", "success");
        } catch (error) {
          console.error("[移动端] 清空日志失败:", error);
          showTempMessage("清空日志失败", "error");
        }
      }
      function scrollMobileMultiLogToBottom() {
        try {
          const mobileLog = document.getElementById("mobile-multi-log-text");
          if (mobileLog) {
            mobileLog.scrollTop = mobileLog.scrollHeight;
          }
        } catch (error) {
          console.error("[移动端] 滚动日志失败:", error);
        }
      }
      function syncMultiLogToMobile() {
        try {
          const pcLog = document.getElementById("multi-log-text");
          const mobileLog = document.getElementById("mobile-multi-log-text");
          if (pcLog && mobileLog) {
            if (pcLog.value !== mobileLog.value) {
              mobileLog.value = pcLog.value;
            }
          }
        } catch (error) {
          console.error("[移动端] 同步日志失败:", error);
        }
      }
      setInterval(syncMultiLogToMobile, 1000);

      console.log("[移动端] Phase 4d功能已加载完成");
      let currentHistoryTaskId = null;
      async function openMobileHistoryModal(taskId, taskName) {
        currentHistoryTaskId = taskId;
        const modal = document.getElementById("mobile-history-modal");
        const taskNameEl = document.getElementById("mobile-history-task-name");
        const listContent = document.getElementById(
          "mobile-history-list-content"
        );
        if (!modal) return;
        modal.classList.remove("hidden");
        if (taskNameEl) {
          taskNameEl.textContent = taskName || "未知任务";
        }
        if (listContent) {
          listContent.innerHTML =
            '<p class="text-slate-400 text-center py-10">加载中...</p>';
        }
        try {
          const response = await fetch(`/api/history/${taskId}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });

          if (!response.ok) {
            throw new Error("获取历史记录失败");
          }

          const data = await response.json();
          if (data && data.history && data.history.length > 0) {
            let html = "";
            data.history.forEach((record, index) => {
              const date = new Date(record.timestamp);
              const timeStr = date.toLocaleString("zh-CN");
              const distKm = (record.distance / 1000).toFixed(2);
              const minutes = Math.floor(record.duration / 60);
              const seconds = record.duration % 60;
              const durationStr = `${String(minutes).padStart(2, "0")}:${String(
                seconds
              ).padStart(2, "0")}`;
              const statusColors = {
                completed: "green",
                failed: "red",
                partial: "orange",
              };
              const statusColor = statusColors[record.status] || "slate";
              const statusTexts = {
                completed: "已完成",
                failed: "失败",
                partial: "部分完成",
              };
              const statusText = statusTexts[record.status] || record.status;
              html += `
              <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 transition"
                onclick="openMobileTrackModal('${record.id}', '${
                record.task_id
              }')">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-slate-600">${timeStr}</span>
                  <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${statusColor}-100 text-${statusColor}-700">${statusText}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center">
                  <div>
                    <p class="text-xs text-slate-500">距离</p>
                    <p class="font-bold text-sm text-blue-600">${distKm} km</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-500">时长</p>
                    <p class="font-bold text-sm text-green-600">${durationStr}</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-500">配速</p>
                    <p class="font-bold text-sm text-purple-600">${
                      record.pace || "--:--"
                    }</p>
                  </div>
                </div>
              </div>
            `;
            });
            listContent.innerHTML = html;
          } else {
            listContent.innerHTML =
              '<p class="text-slate-400 text-center py-10">暂无历史记录</p>';
          }
        } catch (error) {
          console.error("加载历史记录失败:", error);
          if (listContent) {
            listContent.innerHTML = `<p class="text-red-500 text-center py-10">加载失败: ${error.message}</p>`;
          }
        }
      }
      function closeMobileHistoryModal() {
        const modal = document.getElementById("mobile-history-modal");
        if (modal) {
          modal.classList.add("hidden");
        }
        currentHistoryTaskId = null;
      }
      let mobileTrackMapInstance = null;
      let mobileTrackPolyline = null;
      let mobileTrackMarkers = [];
      async function openMobileTrackModal(recordId, taskId) {
        const modal = document.getElementById("mobile-track-modal");
        if (!modal) return;
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.add("show");
        }, 10);
        await initMobileTrackMap();

        try {
          const response = await fetch(
            `/api/get_historical_track?task_id=${taskId}&record_id=${recordId}`,
            {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            }
          );
          if (!response.ok) {
            throw new Error("获取路径数据失败");
          }
          const data = await response.json();
          const timeEl = document.getElementById("mobile-track-time");
          const distEl = document.getElementById("mobile-track-distance");
          const durEl = document.getElementById("mobile-track-duration");
          const paceEl = document.getElementById("mobile-track-pace");
          if (timeEl && data.timestamp) {
            const date = new Date(data.timestamp);
            timeEl.textContent = date.toLocaleString("zh-CN");
          }
          if (distEl && data.distance) {
            distEl.textContent = `${(data.distance / 1000).toFixed(2)} km`;
          }
          if (durEl && data.duration) {
            const min = Math.floor(data.duration / 60);
            const sec = data.duration % 60;
            durEl.textContent = `${String(min).padStart(2, "0")}:${String(
              sec
            ).padStart(2, "0")}`;
          }
          if (paceEl && data.pace) {
            paceEl.textContent = data.pace;
          }
          if (mobileTrackMapInstance && data.path && data.path.length > 0) {
            clearMobileTrackMap();
            const path = data.path.map(
              (p) => new AMapInstance.LngLat(p[0], p[1])
            );
            mobileTrackPolyline = new AMapInstance.Polyline({
              path: path,
              strokeColor: "#3b82f6",
              strokeWeight: 4,
              strokeOpacity: 0.8,
              map: mobileTrackMapInstance,
            });
            if (path.length > 0) {
              const startMarker = new AMapInstance.Marker({
                position: path[0],
                icon: new AMapInstance.Icon({
                  image:
                    "data:image/svg+xml;base64," +
                    btoa(
                      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#22c55e" width="32" height="32"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" fill="white" font-size="12" font-weight="bold">起</text></svg>'
                    ),
                  size: new AMapInstance.Size(32, 32),
                }),
                map: mobileTrackMapInstance,
              });
              mobileTrackMarkers.push(startMarker);
            }
            if (path.length > 1) {
              const endMarker = new AMapInstance.Marker({
                position: path[path.length - 1],
                icon: new AMapInstance.Icon({
                  image:
                    "data:image/svg+xml;base64," +
                    btoa(
                      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ef4444" width="32" height="32"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" fill="white" font-size="12" font-weight="bold">终</text></svg>'
                    ),
                  size: new AMapInstance.Size(32, 32),
                }),
                map: mobileTrackMapInstance,
              });
              mobileTrackMarkers.push(endMarker);
            }
            if (data.checkpoints && data.checkpoints.length > 0) {
              data.checkpoints.forEach((cp, idx) => {
                const marker = new AMapInstance.Marker({
                  position: new AMapInstance.LngLat(cp[0], cp[1]),
                  icon: new AMapInstance.Icon({
                    image:
                      "data:image/svg+xml;base64," +
                      btoa(
                        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f59e0b" width="28" height="28"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><text x="12" y="12" text-anchor="middle" fill="white" font-size="8" font-weight="bold">${
                          idx + 1
                        }</text></svg>`
                      ),
                    size: new AMapInstance.Size(28, 28),
                  }),
                  map: mobileTrackMapInstance,
                });
                mobileTrackMarkers.push(marker);
              });
            }
            mobileTrackMapInstance.setFitView();
          }
        } catch (error) {
          console.error("加载路径失败:", error);
          showTempMessage("加载路径失败: " + error.message, "error");
        }
      }
      async function initMobileTrackMap() {
        if (mobileTrackMapInstance) return;
        if (!AMapInstance) {
          console.error("高德地图API未加载");
          return;
        }
        try {
          mobileTrackMapInstance = new AMapInstance.Map(
            "mobile-track-map-container",
            {
              viewMode: "2D",
              zoom: 15,
              center: [113.390342, 22.527403],
            }
          );
        } catch (error) {
          console.error("初始化路径地图失败:", error);
        }
      }
      function clearMobileTrackMap() {
        if (mobileTrackPolyline) {
          mobileTrackPolyline.setMap(null);
          mobileTrackPolyline = null;
        }
        mobileTrackMarkers.forEach((marker) => {
          marker.setMap(null);
        });
        mobileTrackMarkers = [];
      }
      function closeMobileTrackModal() {
        const modal = document.getElementById("mobile-track-modal");
        if (modal) {
          modal.classList.remove("show");
          setTimeout(() => {
            modal.classList.add("hidden");
          }, 300);
        }
        clearMobileTrackMap();
        if (mobileTrackMapInstance) {
          mobileTrackMapInstance.destroy();
          mobileTrackMapInstance = null;
        }
      }
      function mobileTrackZoomIn() {
        if (mobileTrackMapInstance) {
          mobileTrackMapInstance.zoomIn();
        }
      }

      function mobileTrackZoomOut() {
        if (mobileTrackMapInstance) {
          mobileTrackMapInstance.zoomOut();
        }
      }

      function mobileTrackFitView() {
        if (mobileTrackMapInstance) {
          mobileTrackMapInstance.setFitView();
        }
      }
      let mobileMapAttendanceInstance = null;
      let mobileMapAttendanceMarker = null;
      let mobileMapAttendanceNoticeId = null;
      let mobileMapAttendanceTarget = null;
      let mobileMapAttendanceSelected = null;
      async function openMobileMapAttendanceModal(noticeId, targetCoords) {
        console.log("[地图选点] 打开模态框", { noticeId, targetCoords });
        mobileMapAttendanceNoticeId = noticeId;
        mobileMapAttendanceTarget = targetCoords;
        mobileMapAttendanceSelected = null;
        const modal = document.getElementById("mobile-map-attendance-modal");
        if (!modal) {
          console.error("[地图选点] 模态框元素不存在");
          return;
        }
        modal.classList.remove("hidden");
        const coordsDisplay = document.getElementById(
          "mobile-map-attendance-coords"
        );
        const confirmBtn = document.getElementById(
          "mobile-map-attendance-confirm-btn"
        );
        if (coordsDisplay) coordsDisplay.textContent = "未选择";
        if (confirmBtn) confirmBtn.disabled = true;
        setTimeout(() => {
          initMobileMapAttendance(targetCoords);
        }, 300);
      }
      async function initMobileMapAttendance(targetCoords) {
        console.log("[地图选点] 初始化地图", targetCoords);
        if (mobileMapAttendanceInstance) {
          mobileMapAttendanceInstance.destroy();
          mobileMapAttendanceInstance = null;
        }
        if (typeof AMap === "undefined") {
          console.error("[地图选点] 高德地图API未加载");
          showTempMessage("地图加载失败，请刷新页面重试", "error");
          return;
        }

        const container = document.getElementById(
          "mobile-map-attendance-container"
        );
        if (!container) {
          console.error("[地图选点] 地图容器不存在");
          return;
        }
        container.innerHTML = "";
        try {
          mobileMapAttendanceInstance = new AMap.Map(
            "mobile-map-attendance-container",
            {
              zoom: 17,
              center: targetCoords,
              mapStyle: "amap://styles/normal",
              showLabel: true,
              viewMode: "2D",
            }
          );
          console.log("[地图选点] 地图实例创建成功");
          const targetMarker = new AMap.Marker({
            position: targetCoords,
            icon: new AMap.Icon({
              size: new AMap.Size(32, 32),
              image:
                "data:image/svg+xml;base64," +
                btoa(`
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                <circle cx="16" cy="16" r="14" fill="#3b82f6" stroke="white" stroke-width="3"/>
                <text x="16" y="21" text-anchor="middle" fill="white" font-size="18" font-weight="bold">🎯</text>
              </svg>
            `),
              imageSize: new AMap.Size(32, 32),
            }),
            title: "目标签到位置",
            zIndex: 100,
          });
          mobileMapAttendanceInstance.add(targetMarker);
          mobileMapAttendanceInstance.on("click", (e) => {
            const lng = e.lnglat.getLng();
            const lat = e.lnglat.getLat();
            console.log("[地图选点] 用户点击位置", { lng, lat });
            mobileMapAttendanceSelected = [lng, lat];
            const coordsDisplay = document.getElementById(
              "mobile-map-attendance-coords"
            );
            if (coordsDisplay) {
              coordsDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(
                6
              )}`;
            }
            const confirmBtn = document.getElementById(
              "mobile-map-attendance-confirm-btn"
            );
            if (confirmBtn) {
              confirmBtn.disabled = false;
            }
            if (mobileMapAttendanceMarker) {
              mobileMapAttendanceInstance.remove(mobileMapAttendanceMarker);
            }
            mobileMapAttendanceMarker = new AMap.Marker({
              position: [lng, lat],
              icon: new AMap.Icon({
                size: new AMap.Size(40, 40),
                image:
                  "data:image/svg+xml;base64," +
                  btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                  <circle cx="20" cy="20" r="18" fill="#ef4444" stroke="white" stroke-width="4"/>
                  <text x="20" y="26" text-anchor="middle" fill="white" font-size="22" font-weight="bold">📍</text>
                </svg>
              `),
                imageSize: new AMap.Size(40, 40),
              }),
              title: "选中的签到位置",
              zIndex: 110,
            });
            mobileMapAttendanceInstance.add(mobileMapAttendanceMarker);
          });

          console.log("[地图选点] 地图初始化完成，等待用户选点");
        } catch (error) {
          console.error("[地图选点] 地图初始化失败", error);
          showTempMessage("地图初始化失败：" + error.message, "error");
        }
      }
      async function confirmMobileMapAttendance() {
        console.log("[地图选点] 确认签到", {
          noticeId: mobileMapAttendanceNoticeId,
          selected: mobileMapAttendanceSelected,
        });
        if (!mobileMapAttendanceSelected) {
          showTempMessage("请先在地图上点击选择签到位置", "warning");
          return;
        }
        const confirmBtn = document.getElementById(
          "mobile-map-attendance-confirm-btn"
        );
        if (confirmBtn) {
          confirmBtn.disabled = true;
          confirmBtn.innerHTML = '<span class="animate-pulse">签到中...</span>';
        }
        try {
          const result = await callPythonAPI("sign_in", {
            notice_id: mobileMapAttendanceNoticeId,
            longitude: mobileMapAttendanceSelected[0],
            latitude: mobileMapAttendanceSelected[1],
          });
          console.log("[地图选点] 签到API返回", result);
          if (result.success) {
            showTempMessage("✅ 签到成功！", "success");
            closeMobileMapAttendanceModal();
            setTimeout(() => {
              refreshNotificationsUI(true, true);
            }, 1000);
          } else {
            showTempMessage(
              "❌ 签到失败：" + (result.message || "未知错误"),
              "error"
            );
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.innerHTML = `
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                确认签到
              </span>
            `;
            }
          }
        } catch (error) {
          console.error("[地图选点] 签到失败", error);
          showTempMessage("签到失败：" + error.message, "error");

          // 恢复按钮状态
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = `
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
              确认签到
            </span>
          `;
          }
        }
      }
      function closeMobileMapAttendanceModal() {
        console.log("[地图选点] 关闭模态框");
        const modal = document.getElementById("mobile-map-attendance-modal");
        if (modal) {
          modal.classList.add("hidden");
        }
        if (mobileMapAttendanceMarker) {
          if (mobileMapAttendanceInstance) {
            mobileMapAttendanceInstance.remove(mobileMapAttendanceMarker);
          }
          mobileMapAttendanceMarker = null;
        }

        if (mobileMapAttendanceInstance) {
          mobileMapAttendanceInstance.destroy();
          mobileMapAttendanceInstance = null;
        }
        mobileMapAttendanceNoticeId = null;
        mobileMapAttendanceTarget = null;
        mobileMapAttendanceSelected = null;
      }
      let taskLongPressTimer = null;
      let taskLongPressed = false;
      function attachTaskTouchHandlers(taskItem, taskData) {
        if (!taskItem) return;
        taskItem.addEventListener("touchstart", (e) => {
          taskLongPressed = false;
          taskLongPressTimer = setTimeout(() => {
            taskLongPressed = true;
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
            openMobileHistoryModal(taskData.id, taskData.name);
          }, 500);
        });
        taskItem.addEventListener("touchmove", () => {
          if (taskLongPressTimer) {
            clearTimeout(taskLongPressTimer);
            taskLongPressTimer = null;
          }
        });
        taskItem.addEventListener("touchend", (e) => {
          if (taskLongPressTimer) {
            clearTimeout(taskLongPressTimer);
            taskLongPressTimer = null;
          }
          if (taskLongPressed) {
            e.preventDefault();
            return;
          }
          showMobileTaskDetails(taskData);
        });
        taskItem.addEventListener("touchcancel", () => {
          if (taskLongPressTimer) {
            clearTimeout(taskLongPressTimer);
            taskLongPressTimer = null;
          }
        });
      }
      function showMobileTaskDetails(taskData) {
        const modal = document.getElementById("mobile-task-details-modal");
        const content = document.getElementById("mobile-task-details-content");

        if (!modal || !content) return;
        let html = `
        <div class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-sky-50 rounded-lg">
            <span class="text-sm text-slate-600">任务名称</span>
            <span class="font-semibold text-slate-800">${
              taskData.name || "未命名"
            }</span>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div class="p-3 bg-blue-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">距离</p>
              <p class="font-bold text-lg text-blue-600">${
                taskData.distance ? (taskData.distance / 1000).toFixed(2) : "--"
              } km</p>
            </div>
            <div class="p-3 bg-green-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">时长</p>
              <p class="font-bold text-lg text-green-600">${
                taskData.duration || "--:--"
              }</p>
            </div>
          </div>
          
          <div class="p-3 bg-slate-50 rounded-lg">
            <p class="text-xs text-slate-500 mb-1">状态</p>
            <p class="font-semibold text-slate-800">${
              taskData.status || "未知"
            }</p>
          </div>
          
          ${
            taskData.description
              ? `
          <div class="p-3 bg-slate-50 rounded-lg">
            <p class="text-xs text-slate-500 mb-1">描述</p>
            <p class="text-sm text-slate-700">${taskData.description}</p>
          </div>
          `
              : ""
          }
        </div>
      `;

        content.innerHTML = html;

        modal.classList.remove("hidden");
      }
      function toggleMobileTaskDetails(show) {
        const modal = document.getElementById("mobile-task-details-modal");
        if (!modal) return;

        if (show) {
          modal.classList.remove("hidden");
        } else {
          modal.classList.add("hidden");
        }
      }

      console.log("[移动端] Phase 4c功能已加载");
    </script>

    <script>
      window.addEventListener("beforeunload", () => {
        if (multiAccountAutoRefreshInterval) {
          clearInterval(multiAccountAutoRefreshInterval);
          multiAccountAutoRefreshInterval = null;
        }
      });
    </script>
  </body>
</html>
