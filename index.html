<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥åŠ©æ‰‹</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com" onerror="handleCdnError()"></script>

<!-- Google Fonts æ ‡å‡†å¼•å…¥ï¼ˆæ›¿ä»£æ‰‹å†™ @font-faceï¼‰ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
  href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@600;700&family=Noto+Sans+SC:wght@400;600;700&display=swap"
  rel="stylesheet" onerror="handleCdnError()">


<script>
// é…ç½®TailwindCSS
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { 'sans': ['Noto Sans SC','system-ui','sans-serif'], 'display':['Zilla Slab','serif'] },
      colors: { 'base': '#7dd3fc' }
    }
  }
}
</script>
<style>
/* CSSå˜é‡å®šä¹‰ */


/* é»˜è®¤ä¸»é¢˜ï¼ˆæ— éœ€é¢å¤– classï¼‰ */
body { 
  background: linear-gradient(180deg, rgba(245,250,255,1) 0%, rgba(235,245,255,1) 40%, rgba(250,240,255,1) 100%); 
  background-attachment: fixed; 
}
.panel { 
  backdrop-filter: blur(16px); 
  background-color: var(--card-bg); 
  border: 1px solid rgba(255,255,255,0.45); 
  box-shadow: 0 10px 24px rgba(16,24,40,0.12); 
}

/* äºŒæ¬¡å…ƒä¸»é¢˜ */
body.theme-anime {
  /* æ·»åŠ ä¸€å¼ èƒŒæ™¯å›¾ï¼Œæ‚¨å¯ä»¥æ›¿æ¢ä¸ºæ‚¨å–œæ¬¢çš„å›¾ç‰‡URL */
  background-image: url('https://api.paugram.com/wallpaper');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}
body.theme-anime .panel {
  /* é¢æ¿ä½¿ç”¨æ›´å¼ºçƒˆçš„æ¯›ç»ç’ƒæ•ˆæœ */
  background-color: rgba(255, 255, 255, 0.65); /* é™ä½ä¸é€æ˜åº¦ */
  backdrop-filter: blur(20px) saturate(150%); /* å¢å¼ºæ¨¡ç³Šå’Œé¥±å’Œåº¦ */
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
}

/* ç®€çº¦ä¸»é¢˜ */
body.theme-minimalist {
  background: #f8f9fa; /* ä½¿ç”¨çº¯è‰²èƒŒæ™¯ */
}
body.theme-minimalist .panel {
  background-color: #ffffff;
  backdrop-filter: none; /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
  border: 1px solid #e9ecef; /* ä½¿ç”¨æ›´æŸ”å’Œçš„è¾¹æ¡† */
  box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* ä½¿ç”¨æ›´ç»†å¾®çš„é˜´å½± */
  border-radius: 12px; /* ç¨å¾®å‡å°åœ†è§’ */
}

/* ä¸‹æ‹‰é€‰æ‹©æ¡†æ–‡æœ¬ä¸æ¢è¡Œï¼Œé¿å…å¤šè¡ŒæŒ¤å‹å¯¼è‡´â€œçœ‹èµ·æ¥ä¸é½å…¨â€ */
#multi-config-user-select {
  white-space: nowrap;         /* æ–‡æœ¬ä¸æŠ˜è¡Œ */
  overflow-x: auto;            /* è¾…åŠ©ï¼šå…è®¸æ°´å¹³æ»šåŠ¨ï¼ˆæ³¨æ„ï¼šéƒ¨åˆ†æµè§ˆå™¨ä¸ä¸º select æ˜¾ç¤º H-scrollï¼‰ */
  max-width: 100%;             /* çº¦æŸä¸ºå®¹å™¨å®½åº¦ï¼Œé¿å…æ’‘ç ´å¸ƒå±€ */
}


/* ä»…é’ˆå¯¹ select å…ƒç´ å‡å°ç»Ÿä¸€è¡¨å•å†…è¾¹è·ï¼Œæ‰©å¤§å¯è§†ç©ºé—´ */
select.select-field {
  padding: 0.45rem 0.6rem;     /* åŸæ¥ .select-field çš„ padding æ¯”è¾ƒåšï¼Œé€‚å½“å‡å° */
}

/* ç»™ options æç¤ºå®Œæ•´æ–‡æœ¬ï¼ˆä¸åŒæµè§ˆå™¨å¯¹ option çš„æ ·å¼æ”¯æŒæœ‰é™ï¼Œtooltip æ›´ç¨³å¦¥ï¼‰ */
#multi-config-user-select option {
  /* å¤§å¤šæ•°æµè§ˆå™¨ä¸æ”¯æŒ option çš„ ellipsisï¼Œä½†å¯ä¿ç•™ä»¥å°½å¯èƒ½å…¼å®¹ */
  text-overflow: ellipsis;
  overflow: hidden;
}

/* æ¨¡æ€æ¡†èƒŒæ™¯ */

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  pointer-events: auto; /* å…è®¸èƒŒæ™¯é®ç½©å±‚äº¤äº’ï¼Œé˜»æŒ¡ä¸‹æ–¹ç‚¹å‡» */
  background-color: rgba(0, 0, 0, 0.4); /* æ·»åŠ åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
  /* display å°†ç”± JS æ§åˆ¶ä¸º 'flex' ä»¥å®ç°å±…ä¸­ */
  align-items: center;
  justify-content: center;
}


/* å†…å®¹å®¹å™¨ï¼šå±…ä¸­æ˜¾ç¤º */
.modal-content {
  background: linear-gradient(135deg, #ffffff, #f7f9ff);
  /* margin: 10% auto;  <-- ç§»é™¤æ­¤è¡Œä»¥å…è®¸ Flexbox å‚ç›´å±…ä¸­ */
  padding: 24px 28px;
  border-radius: 16px;
  width: 360px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25),
              0 0 12px rgba(120,160,255,0.4);
  animation: fadeIn 0.35s ease, scaleIn 0.35s ease;
  font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
  position: relative;
  pointer-events: auto; /* å†…å®¹å¯äº¤äº’ */
}

/* æ ‡é¢˜ */
.modal-content h3 {
  margin-top: 0;
  text-align: center;
  font-size: 20px;
  color: #3a4a7a;
  letter-spacing: 1px;
}

/* å…³é—­æŒ‰é’® */
.close {
  position: absolute;
  right: 14px;
  top: 10px;
  font-size: 22px;
  cursor: pointer;
  color: #888;
  transition: color 0.2s;
}
.close:hover {
  color: #ff5c8a;
}

/* è¡¨å• */
.form-group {
  margin: 14px 0;
}
.form-group label {
  display: inline-block;
  width: 70px;
  font-weight: bold;
  color: #4a4a6a;
}
.form-group input {
  width: 230px;
  padding: 8px 10px;
  border: 1px solid #ccd2f0;
  border-radius: 8px;
  outline: none;
  transition: all 0.25s;
  background: #fff;
}
.form-group input:focus {
  border-color: #7a9dff;
  box-shadow: 0 0 6px rgba(122,157,255,0.6);
}

/* åº•éƒ¨æŒ‰é’® */
.modal-actions {
  text-align: right;
  margin-top: 18px;
}
.modal-actions button {
  margin-left: 10px;
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.25s;
}
#newUserCancel {
  background: #e0e4f7;
  color: #444;
}
#newUserCancel:hover {
  background: #d0d6f0;
}
#newUserConfirm {
  background: linear-gradient(135deg, #7a9dff, #5c7cff);
  color: #fff;
  box-shadow: 0 3px 8px rgba(92,124,255,0.4);
}
#newUserConfirm:hover {
  background: linear-gradient(135deg, #5c7cff, #4a68e0);
  box-shadow: 0 4px 10px rgba(92,124,255,0.55);
}

/* åŠ¨ç”» */
@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity: 1;}
}
@keyframes scaleIn {
  from {transform: scale(0.9);}
  to {transform: scale(1);}
}



:root { --base-color: #7dd3fc; --base-color-600: #0891b2; --base-color-500: #22d3ee; --base-color-300: #a5f3fc; --card-bg: rgba(255,255,255,0.85); --glass: rgba(255,255,255,0.65); --ink: #0f172a; }
html,body { height:100%; }
body { background: linear-gradient(180deg, rgba(245,250,255,1) 0%, rgba(235,245,255,1) 40%, rgba(250,240,255,1) 100%); background-attachment: fixed; }

.bg-anime { background-image: url(''); background-size: cover; background-position: center; }
.panel { backdrop-filter: blur(16px); background-color: var(--card-bg); border: 1px solid rgba(255,255,255,0.45); box-shadow: 0 10px 24px rgba(16,24,40,0.12); }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem 1rem; border-radius:999px; font-weight:700; transition: all .25s ease; box-shadow: 0 6px 16px rgba(2, 132, 199, .15); }
.btn:hover { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(2,132,199,.22); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-primary { color:#fff; background: linear-gradient(135deg, var(--base-color), var(--base-color-600)); }
.btn-secondary { color:#fff; background: linear-gradient(135deg, #a855f7, #7c3aed); }
.btn-danger { color:#fff; background: linear-gradient(135deg, #ef4444, #b91c1c); }
.btn-warning { color:#fff; background: linear-gradient(135deg, #f59e0b, #d97706); }
.btn-success { color:#fff; background: linear-gradient(135deg, #10b981, #059669); }
.btn-ghost { color:#334155; background: rgba(255,255,255,0.7); border: 1px solid rgba(148,163,184,0.35); }

.input-field, .select-field {
  width:100%; border-radius: 14px; padding:.7rem .9rem; background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
  border: 1px solid rgba(148,163,184,0.35); box-shadow: inset 0 1px 0 rgba(255,255,255,0.6), 0 8px 14px rgba(16,24,40,0.06);
  color:#0f172a; transition: box-shadow .2s ease, border-color .2s ease;
}
.input-field:focus, .select-field:focus { outline:none; border-color: var(--base-color-600); box-shadow: 0 0 0 3px rgba(34,211,238,.25); }
.badge { display:inline-block; padding:.25rem .6rem; border-radius:999px; font-weight:700; background: rgba(34,211,238,.18); color: var(--base-color-600); }
.card-title { font-family: 'Zilla Slab', serif; letter-spacing:.5px; }
::-webkit-scrollbar { width: 10px; height:10px; }
::-webkit-scrollbar-track { background: rgba(226,232,240,0.6); }
::-webkit-scrollbar-thumb { background-color: rgba(148,163,184,0.8); border-radius: 6px; border: 2px solid rgba(226,232,240,0.6); }
::-webkit-scrollbar-thumb:hover { background-color: rgba(100,116,139,0.9); }
.tab-button { padding:.5rem .75rem; font-weight:700; color:#64748b; border-bottom:3px solid transparent; transition: all .2s ease; }
.tab-button.active { color: var(--base-color-600); border-bottom-color: var(--base-color-600); }
#task-list > div.selected { background: rgba(34,211,238,.14); border-left: 4px solid var(--base-color-600); }

#map-container.drawing .amap-marker,
#map-container.drawing .amap-text,
#map-container.drawing .amap-overlay-text,
#map-container.drawing .amap-overlay { pointer-events:none !important; }

.pulsing-marker { animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { transform: scale(0.98); box-shadow: 0 0 0 0 rgba(2, 132, 199, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(2,132,199,0); } 100% { transform: scale(0.98); box-shadow: 0 0 0 0 rgba(2,132,199,0); } }

.hero-overlay { background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.85) 60%); }
.theme-dot { width:20px; height:20px; border-radius:100%; border:2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,.15); cursor:pointer; transition: transform .2s ease; }
.theme-dot:hover { transform: scale(1.05); }

/* æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶ï¼Œéšè—åœ°å›¾logoå’Œç‰ˆæƒ */
#user-details-modal:not(.hidden) ~ #map-container .amap-logo,
#user-details-modal:not(.hidden) ~ #map-container .amap-copyright,
#task-details-modal:not(.hidden) ~ #map-container .amap-logo,
#task-details-modal:not(.hidden) ~ #map-container .amap-copyright,
#user-details-modal:not(.hidden) ~ main > #multi-map-container .amap-logo,
#user-details-modal:not(.hidden) ~ main > #multi-map-container .amap-copyright,
#task-details-modal:not(.hidden) ~ main > #multi-map-container .amap-logo,
#task-details-modal:not(.hidden) ~ main > #multi-map-container .amap-copyright,
#account-params-modal:not(.hidden) ~ main > #multi-map-container .amap-logo,
#account-params-modal:not(.hidden) ~ main > #multi-map-container .amap-copyright {
  display: none !important;
}
/* å½“ä»»æ„æ¨¡æ€æ‰“å¼€æ—¶ï¼Œéšè—åœ°å›¾çš„ logo ä¸ç‰ˆæƒ */
body.modal-visible .amap-logo,
body.modal-visible .amap-copyright {
  display: none !important;
}
</style>
<script src="https://webapi.amap.com/loader.js" onerror="handleCdnError()"></script>
</head>
<body class="text-slate-800 font-sans h-screen overflow-hidden antialiased">

<div id="cdn-error-overlay" style="display: none; position: fixed; inset: 0; z-index: 9999; background-color: #f8fafc; color: #475569; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
  <div style="max-width: 500px;">
    <h1 style="font-size: 1.875rem; font-weight: bold; color: #be123c; margin-bottom: 1rem;">ç•Œé¢èµ„æºåŠ è½½å¤±è´¥</h1>
    <p style="font-size: 1.125rem; margin-bottom: 1.5rem;">åº”ç”¨ç¨‹åºæ— æ³•è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œæœåŠ¡å™¨ï¼ˆCDNï¼‰æ¥ä¸‹è½½å¿…è¦çš„ç•Œé¢æ–‡ä»¶ï¼ˆå¦‚æ ·å¼å’Œåœ°å›¾åº“ï¼‰ã€‚</p>
    <div style="background-color: #f1f5f9; border-radius: 0.5rem; padding: 1rem; text-align: left; font-size: 0.875rem; line-height: 1.5;">
      <h2 style="font-weight: 600; color: #1e293b; margin-top: 0; margin-bottom: 0.75rem;">å¯èƒ½çš„åŸå› åŠè§£å†³æ–¹æ³•ï¼š</h2>
      <ul style="list-style-type: disc; padding-left: 1.25rem; margin: 0;">
        <li style="margin-bottom: 0.5rem;"><strong>æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥</strong>ï¼šè¯·ç¡®ä¿æ‚¨çš„è®¾å¤‡å·²è¿æ¥åˆ°äº’è”ç½‘ã€‚</li>
        <li style="margin-bottom: 0.5rem;"><strong>æ£€æŸ¥é˜²ç«å¢™æˆ–ä»£ç†</strong>ï¼šç³»ç»Ÿé˜²ç«å¢™ã€æ€æ¯’è½¯ä»¶æˆ–ç½‘ç»œä»£ç†å¯èƒ½é˜»æ­¢äº†ç¨‹åºè®¿é—®ç½‘ç»œã€‚</li>
        <li><strong>ç½‘ç»œç¯å¢ƒé—®é¢˜</strong>ï¼šæ‚¨å½“å‰çš„ç½‘ç»œç¯å¢ƒå¯èƒ½æ— æ³•ç¨³å®šè®¿é—®æ‰€éœ€çš„å¤–éƒ¨èµ„æºã€‚</li>
      </ul>
    </div>
    <p style="margin-top: 1.5rem; font-size: 0.875rem; color: #64748b;">è¯·æ£€æŸ¥ç½‘ç»œåï¼Œå®Œå…¨å…³é—­å¹¶é‡å¯æœ¬ç¨‹åºã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œæ‚¨å¯èƒ½éœ€è¦æ›´æ¢ç½‘ç»œç¯å¢ƒã€‚</p>
  </div>
</div>

<!-- æ–°ç”¨æˆ·æ·»åŠ æ¨¡æ€æ¡† -->
<div id="newUserModal" class="modal">
  <div class="modal-content">
    <span class="close" id="newUserClose">&times;</span>
    <h3>æ·»åŠ æ–°ç”¨æˆ·</h3>
    <div class="form-group">
      <label for="newUsername">è´¦å·ï¼š</label>
      <input type="text" id="newUsername" placeholder="è¯·è¾“å…¥è´¦å·">
    </div>
    <div class="form-group">
      <label for="newPassword">å¯†ç ï¼š</label>
      <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
    </div>
    <div class="modal-actions">
      <button id="newUserCancel">å–æ¶ˆ</button>
      <button id="newUserConfirm">ç¡®è®¤</button>
    </div>
  </div>
</div>


<!-- åŠ è½½é®ç½©å±‚ -->
<div id="loading-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center gap-6 bg-white/80">
  <div class="loader"></div>
  <p class="text-base font-bold text-sky-600">æ­£åœ¨åŠ è½½èµ„æºä¸­...</p>
</div>

<!-- ç”¨æˆ·è®¤è¯ç™»å½•ç•Œé¢ -->
<div id="auth-login-container" class="w-full h-full flex items-center justify-center">
  <div class="panel rounded-2xl w-full max-w-md p-8 space-y-6">
    <div class="text-center">
      <h2 class="text-3xl font-bold text-sky-700 card-title mb-2">è·‘æ­¥åŠ©æ‰‹</h2>
      <p class="text-sm text-slate-500">è¯·ç™»å½•æˆ–æ³¨å†Œä»¥ç»§ç»­ä½¿ç”¨</p>
    </div>
    
    <!-- ç™»å½•/æ³¨å†Œåˆ‡æ¢æ ‡ç­¾ -->
    <div class="flex border-b border-slate-200">
      <button id="auth-tab-login" class="flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition">ç™»å½•</button>
      <button id="auth-tab-register" class="flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition hover:text-slate-600">æ³¨å†Œ</button>
    </div>
    
    <!-- ç™»å½•è¡¨å• -->
    <div id="auth-login-form" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold leading-6 text-slate-700">ç”¨æˆ·å</label>
        <input type="text" id="auth-username" class="input-field mt-1" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
      </div>
      <div>
        <label class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
        <input type="password" id="auth-password" class="input-field mt-1" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
      </div>
      <button id="auth-login-btn" class="btn btn-primary w-full py-3">ç™»å½•</button>
      <div id="guest-login-section" class="text-center hidden">
        <div class="relative flex py-2 items-center">
          <div class="flex-grow border-t border-slate-200"></div>
          <span class="flex-shrink mx-4 text-slate-400 text-xs">æˆ–</span>
          <div class="flex-grow border-t border-slate-200"></div>
        </div>
        <button id="auth-guest-btn" class="btn btn-ghost w-full">ä»¥æ¸¸å®¢èº«ä»½ç»§ç»­</button>
      </div>
    </div>
    
    <!-- æ³¨å†Œè¡¨å• -->
    <div id="auth-register-form" class="hidden space-y-4">
      <div>
        <label class="block text-sm font-semibold leading-6 text-slate-700">ç”¨æˆ·å</label>
        <input type="text" id="auth-reg-username" class="input-field mt-1" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20å­—ç¬¦ï¼‰" autocomplete="username">
      </div>
      <div>
        <label class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
        <input type="password" id="auth-reg-password" class="input-field mt-1" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6å­—ç¬¦ï¼‰" autocomplete="new-password">
      </div>
      <div>
        <label class="block text-sm font-semibold leading-6 text-slate-700">ç¡®è®¤å¯†ç </label>
        <input type="password" id="auth-reg-password-confirm" class="input-field mt-1" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " autocomplete="new-password">
      </div>
      <button id="auth-register-btn" class="btn btn-success w-full py-3">æ³¨å†Œ</button>
    </div>
    
    <!-- é”™è¯¯æç¤º -->
    <div id="auth-error-msg" class="hidden text-sm text-center p-3 rounded-lg bg-red-50 border border-red-200 text-red-600"></div>
    <div id="auth-success-msg" class="hidden text-sm text-center p-3 rounded-lg bg-green-50 border border-green-200 text-green-600"></div>
  </div>
</div>

<!-- ç™»å½•ç•Œé¢ (åº”ç”¨ç™»å½•ï¼Œåœ¨è®¤è¯åæ˜¾ç¤º) -->
<div id="login-container" class="hidden w-full h-full grid grid-cols-1 lg:grid-cols-2">
  
  <div class="flex flex-col items-center justify-center p-12 bg-gradient-to-br from-slate-50 to-gray-100">
      <div class="text-center w-full max-w-sm space-y-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-violet-500" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          
          <h2 class="text-3xl font-bold text-slate-800 card-title">å¤šè´¦å·æ¨¡å¼</h2>
          <p class="text-slate-500">
              æ”¯æŒæ‰¹é‡å¯¼å…¥ã€ç»Ÿä¸€ç®¡ç†å’Œä¸€é”®æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚
          </p>
          
          <button id="multi-account-btn" class="btn btn-secondary w-full py-3">è¿›å…¥å¤šè´¦å·æ§åˆ¶å°</button>
      </div>
  </div>

  <div class="flex items-center justify-center p-8 bg-white">
    <div class="panel rounded-2xl w-full max-w-md p-8 space-y-6">
      <div class="flex items-center gap-3">
        <h2 class="text-3xl font-bold text-sky-700 card-title">å•è´¦å·ç™»å½•</h2>
      </div>
      <div class="space-y-4 w-full">
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">é€‰æ‹©è´¦å·</label>
          <select id="user-combo" class="select-field mt-1"></select>
        </div>
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">ç”¨æˆ·å</label>
          <input type="text" id="username-entry" class="input-field mt-1" placeholder="ä½ çš„å­¦å·æˆ–å·¥å·">
        </div>
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
          <input type="password" id="password-entry" class="input-field mt-1" placeholder="ä½ çš„å¯†ç ">
        </div>
      </div>
      <button id="login-button" class="btn btn-primary w-full py-3">ç™»å½•</button>
            <div class="relative flex py-2 items-center">
        <div class="flex-grow border-t border-slate-200"></div>
        <span class="flex-shrink mx-4 text-slate-400 text-xs">æˆ–</span>
        <div class="flex-grow border-t border-slate-200"></div>
      </div>
      <button id="import-button" class="btn btn-success w-full">å¯¼å…¥ç¦»çº¿æ–‡ä»¶</button>
      
      <div class="pt-2">
        <div class="flex justify-between items-center text-xs text-slate-500 mb-1">
          <span>User-Agent</span>
          <button id="random-ua-btn" title="éšæœºç”Ÿæˆæ–°çš„UA" class="btn btn-ghost !py-1 !px-2">éšæœº</button>
        </div>
        <p id="ua-label" class="text-xs text-slate-600 break-all bg-white/70 border border-slate-200 p-2 rounded-md"> (æœªåŠ è½½) </p>
      </div>
    </div>
  </div>
</div>

<!-- ä¸»åº”ç”¨ç•Œé¢ -->
<main id="main-app" class="hidden h-screen w-screen grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4">
  <!-- å·¦ä¾§é¢æ¿ -->
  <div class="lg:col-span-1 xl:col-span-1 flex flex-col gap-4 h-full min-h-0">
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <div class="panel rounded-xl p-4 flex items-center gap-4">
      <div class="flex-1 ">
        <p id="user-name-label" class="font-bold text-slate-800 truncate">å§“å: NULL</p>
        <p id="user-id-label" class="text-sm text-slate-500">å­¦å·: NULL</p>
      </div>
      <button id="show-notifications-btn" class="btn btn-ghost !py-2 !px-3 relative" title="æŸ¥çœ‹é€šçŸ¥">
        <span>é€šçŸ¥</span>
        <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-4 h-4 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center">0</span>
      </button>
      <button id="show-user-details" class="btn btn-ghost !py-2 !px-3" title="æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…">è¯¦æƒ…</button>
      <button id="show-admin-panel" class="btn btn-ghost !py-2 !px-3 hidden" title="ç®¡ç†é¢æ¿">ç®¡ç†</button>
      <button id="logout-button" class="btn btn-ghost !py-2 !px-3 !text-red-600" title="æ³¨é”€">é€€å‡º</button>
    </div>
    <!-- ä»»åŠ¡åˆ—è¡¨é¢æ¿ -->
    <div class="panel rounded-xl p-4 flex-grow flex flex-col min-h-0">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold text-slate-800">ä»»åŠ¡åˆ—è¡¨</h2>
        <div class="flex gap-2">
          <button id="show-task-details" class="btn btn-ghost !py-1 !px-3">ä»»åŠ¡è¯¦æƒ…</button>
          <button id="refresh-button" class="btn btn-ghost !py-1 !px-3">åˆ·æ–°</button>
        </div>
      </div>
      <div id="task-list" class="flex-grow overflow-y-auto -mr-2 pr-2"></div>
    </div>
    <!-- æ§åˆ¶é¢æ¿ (é€‰é¡¹å¡) -->
    <div class="panel rounded-xl p-4">
      <div class="flex border-b border-slate-200 -mx-4 px-2 space-x-2">
        <button class="tab-button active" onclick="showTab('run-control', this)">æ‰§è¡Œ</button>
        <button class="tab-button" onclick="showTab('path-tools', this)">è·¯å¾„</button>
        <button class="tab-button" onclick="showTab('checkpoints', this)">æ‰“å¡ç‚¹</button>
        <button class="tab-button" onclick="showTab('attendance', this)">ç­¾åˆ°</button>
        <button class="tab-button" onclick="showTab('history', this)">å†å²</button>
        <button class="tab-button" onclick="showTab('params', this)">å‚æ•°</button>
        <button class="tab-button" onclick="showTab('log', this)">æ—¥å¿—</button>
      </div>
      <div class="h-56 overflow-y-auto">
        <!-- æ‰§è¡Œé€‰é¡¹å¡ -->
        <div id="run-control-tab" class="pt-4 space-y-3">
        <div id="run-stats-block" class="text-center p-3 rounded-lg border border-slate-200 bg-white/80">
            <p class="text-sm text-slate-500">å·²é€‰ä»»åŠ¡æ€»è§ˆ</p>
            <p id="run-stats-label" class="font-bold text-2xl text-sky-600">-- km / --:--</p>
        </div>

        <!-- å•ä»»åŠ¡è¿›åº¦æ¡ -->
        <div id="single-progress-block" class="mt-2">
            <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
            <div id="single-progress-fill" class="h-2 bg-sky-500" style="width:0%"></div>
            </div>
            <div class="flex justify-between text-xs mt-1">
            <span id="single-progress-text" class="text-slate-600">æœªå¼€å§‹</span>
            <span id="single-progress-extra" class="text-slate-400"></span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="start-run-button" class="btn btn-primary">å¼€å§‹æ‰§è¡Œ</button>
            <button id="start-all-button" class="btn btn-secondary">æ‰§è¡Œæ‰€æœ‰</button>
        </div>

          <div class="flex items-center justify-center space-x-4 pt-1">
            <label class="flex items-center gap-1.5 text-xs text-slate-700 cursor-pointer"><input type="checkbox" id="run-completed-check" class="w-4 h-4 accent-sky-600 rounded"><span class="font-semibold">å¿½ç•¥å·²å®ŒæˆçŠ¶æ€</span></label>
            <label class="flex items-center gap-1.5 text-xs text-slate-700 cursor-pointer"><input type="checkbox" id="auto-gen-all-check" class="w-4 h-4 accent-sky-600 rounded"><span class="font-semibold">è‡ªåŠ¨ç”Ÿæˆè·¯å¾„</span></label>
          </div>
        </div>
        <!-- è·¯å¾„å·¥å…·é€‰é¡¹å¡ -->
        <div id="path-tools-tab" class="hidden pt-4 space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <button id="record-button" class="btn btn-success">å½•åˆ¶è·¯å¾„</button>
            <button id="auto-gen-button" class="btn btn-secondary">è‡ªåŠ¨ç”Ÿæˆ</button>
            <button id="process-button" class="btn btn-primary">å¤„ç†è·¯å¾„</button>
            <button id="clear-button" class="btn btn-warning">æ¸…é™¤è·¯å¾„</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button id="export-button" class="btn btn-ghost border border-slate-300 col-span-1">å¯¼å‡º</button>
            <div class="col-span-1"></div>
          </div>
        </div>
        <!-- æ‰“å¡ç‚¹é€‰é¡¹å¡ -->
        <div id="checkpoints-tab" class="hidden pt-2">
            <div id="target-points-text" class="h-48 overflow-y-auto"></div>
        </div>


        <div id="attendance-tab" class="hidden pt-2 space-y-2 h-56 flex flex-col">
          <div class="flex-shrink-0 space-y-2 border-b pb-2">
            <label class="flex items-center gap-2 cursor-pointer" title="å¼€å¯åï¼Œå°†åœ¨åå°è‡ªåŠ¨åˆ·æ–°é€šçŸ¥å¹¶å°è¯•ç­¾åˆ°">
              <input type="checkbox" id="param-auto_attendance_enabled" data-key="auto_attendance_enabled" class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0">
              <span class="text-slate-700 font-semibold">å¼€å¯è‡ªåŠ¨ç­¾åˆ°</span>
            </label>
            
            <div class="flex items-center gap-2">
              <label class="text-sm text-slate-700 font-semibold flex-shrink-0">åˆ·æ–°é—´éš”(ç§’)</label>
              <input type="number" step="30" id="param-auto_attendance_refresh_s" data-key="auto_attendance_refresh_s" class="input-field !py-1 w-full" title="è‡ªåŠ¨åˆ·æ–°é€šçŸ¥çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå»ºè®®ä¸ä½äº60">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-slate-700 font-semibold flex-shrink-0">éšæœºåŠå¾„(ç±³)</label>
              <input type="number" step="1" id="param-attendance_user_radius_m" data-key="attendance_user_radius_m" class="input-field !py-1 w-full" title="è‡ªåŠ¨ç­¾åˆ°æ—¶ï¼Œåœ¨æœåŠ¡å™¨å…è®¸èŒƒå›´å†…çš„æœ€å¤§éšæœºåç§»åŠå¾„ã€‚è®¾ä¸º0ä¸ºç²¾ç¡®ç­¾åˆ°ã€‚">
            </div>
          </div>
          <div class="flex justify-between items-center border-t pt-2 mt-2">
            <h4 class="text-sm font-semibold text-slate-700">ç­¾åˆ°ä»»åŠ¡åˆ—è¡¨</h4>
            <button id="refresh-attendance-list-btn" class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600" onclick="refreshNotificationsUI()">
              åˆ·æ–°
            </button>
          </div>
          
          <div id="attendance-list" class="flex-grow overflow-y-auto pr-1">
             <p class="text-slate-400 text-center py-10 text-xs">ç‚¹å‡»â€œåˆ·æ–°â€æŒ‰é’®æŸ¥çœ‹ç­¾åˆ°ä»»åŠ¡</p>
          </div>
        </div>

        <!-- å†å²è®°å½•é€‰é¡¹å¡ -->
        <div id="history-tab" class="hidden pt-2">
          <div id="history-list-container">
            <p id="history-placeholder" class="text-slate-400 text-center py-16">é€‰æ‹©ä»»åŠ¡åæ˜¾ç¤ºå†å²è®°å½•</p>
            <div id="history-list"></div>
          </div>
        </div>
        <!-- å‚æ•°è®¾ç½®é€‰é¡¹å¡ -->
        <div id="params-tab" class="hidden space-y-3">
          <div id="params-container"></div>
        </div>
        <!-- æ—¥å¿—é€‰é¡¹å¡ -->
        <div id="log-tab" class="hidden pt-2">
          <div class="h-48">
            <textarea id="log-text" readonly class="w-full h-full bg-white/80 border border-slate-200 rounded-md p-2 text-xs text-slate-700 resize-none focus:outline-none leading-snug"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å³ä¾§ä¸»åŒºåŸŸ -->
  <div class="lg:col-span-2 xl:col-span-3 flex flex-col gap-4 h-full min-h-0">
    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map-container" class="flex-grow bg-slate-200 rounded-xl relative overflow-hidden border border-slate-200">
      <div class="absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200">
        <button id="zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
        <span id="zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
        <button id="zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
        <button id="reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
      </div>
    </div>
    <!-- åº•éƒ¨ä¿¡æ¯é¢æ¿ -->
    <div class="grid grid-cols-1 gap-4">
      <!-- å®æ—¶çŠ¶æ€ -->
      <div class="panel rounded-xl p-4 flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-slate-800">å®æ—¶çŠ¶æ€</h3>
          <p class="text-sm font-mono text-slate-500" id="current-location-label">å½“å‰ä½ç½®GPSåæ ‡: --, --</p>
        </div>
        <div class="grid grid-cols-4 divide-x divide-slate-200 text-center pt-2">
            <div>
              <p class="text-sm text-slate-500">å·²è·‘è·ç¦»</p>
              <p id="live-dist-label" class="font-bold text-xl text-slate-700">0.00 km</p>
            </div>
            <div>
              <p class="text-sm text-slate-500">æ€»è·ç¦»</p>
              <p id="total-dist-label" class="font-bold text-xl text-slate-700">0.00 km</p>
            </div>
            <div>
              <p class="text-sm text-slate-500">å·²ç”¨æ—¶é—´</p>
              <p id="live-time-label" class="font-bold text-xl text-slate-700">00:00</p>
            </div>
            <div>
              <p class="text-sm text-slate-500">é¢„è®¡æ—¶é—´</p>
              <p id="total-time-label" class="font-bold text-xl text-slate-700">00:00</p>
            </div>
        </div>
      </div>
    </div>
  </div>

  
</main>

<main id="multi-account-app" class="hidden h-screen w-screen grid grid-cols-1 lg:grid-cols-[530px,1fr] xl:grid-cols-[530px,1fr] gap-4 p-4">
  <div class="flex flex-col gap-4 h-full min-h-0">
    <div class="panel rounded-xl p-4 flex-shrink-0">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-bold text-slate-800 card-title">å¤šè´¦å·æ§åˆ¶å°</h2>
          <button id="exit-multi-mode-btn" class="btn btn-ghost !py-1 !px-3">è¿”å›ç™»å½•é¡µ</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button id="multi-start-all-btn" class="btn btn-primary">å…¨éƒ¨å¼€å§‹</button>
            <button id="multi-stop-all-btn" class="btn btn-danger">å…¨éƒ¨åœæ­¢</button>
        </div>
        <div class="mt-4 space-y-2 text-sm border-t pt-3">
            <label class="flex items-center gap-2 cursor-pointer font-semibold text-slate-700">
                <input type="checkbox" id="multi-use-delay-check" checked class="w-4 h-4 accent-sky-600 rounded">
                å¯ç”¨éšæœºå¯åŠ¨å»¶è¿Ÿ
            <div class="flex items-center gap-2 pl-6">
                <input type="number" id="multi-min-delay-input" value="0" class="input-field !py-1 w-20 text-center">
                <span>-</span>
                <input type="number" id="multi-max-delay-input" value="300" class="input-field !py-1 w-20 text-center">
                <span>ç§’</span>
            </div>
            </label>
            <label class="flex items-center gap-2 cursor-pointer font-semibold text-slate-700 mt-2">
                <input type="checkbox" id="multi-run-only-incomplete-check" checked class="w-4 h-4 accent-sky-600 rounded">
                ä»…æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡
            </label>
        </div>
    </div>
    <div class="panel rounded-xl p-4 flex-grow flex flex-col min-h-0">
        <div class="flex justify-between items-center mb-1">
          <div class="flex items-center gap-2">
            <h2 class="text-lg font-bold text-slate-800">è´¦å·åˆ—è¡¨ (<span id="multi-account-count">0</span>)</h2>
            <input type="checkbox" id="multi-select-all-check" class="w-4 h-4 accent-sky-600 rounded" title="å…¨é€‰/å–æ¶ˆå…¨é€‰">
          </div>
          <div class="flex gap-2">
            <button id="multi-import-excel-btn" class="btn btn-ghost !py-1 !px-3" title="ä»æ–‡ä»¶å¯¼å…¥">å¯¼å…¥</button>
            <button id="multi-export-excel-btn" class="btn btn-ghost !py-1 !px-3" title="å¯¼å‡ºæ±‡æ€»">å¯¼å‡º</button>
            <button id="multi-download-template-btn" class="btn btn-ghost !py-1 !px-3" title="ä¸‹è½½å¯¼å…¥æ¨¡æ¿">ä¸‹è½½æ¨¡æ¿</button>
          </div>

        </div>

        

        

        


        <div class="flex items-center justify-between mb-3 text-xs border-b pb-2">
        <!-- å·¦ä¾§ï¼šåˆ·æ–° -->
        <div class="flex items-center gap-2">
            
            <button id="multi-refresh-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-blue-600">
            åˆ·æ–°é€‰ä¸­
            </button>
            <button id="multi-refresh-all-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-blue-600">
            åˆ·æ–°å…¨éƒ¨
            </button>
        </div>

        <!-- ä¸­å¤®ï¼šæ§åˆ¶ -->
        <div class="flex items-center gap-2">
            
            <button id="multi-start-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-green-600">
            å¼€å§‹é€‰ä¸­
            </button>
            <button id="multi-stop-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-green-600">
            åœæ­¢é€‰ä¸­
            </button>
        </div>

        <!-- å³ä¾§ï¼šç§»é™¤ -->
        <div class="flex items-center gap-2">
            
            <button id="multi-remove-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-red-600">
            ç§»é™¤é€‰ä¸­
            </button>
            <button id="multi-remove-all-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-red-600">
            ç§»é™¤å…¨éƒ¨
            </button>
        </div>
        </div>














        






          <div id="multi-account-list" class="flex-grow overflow-y-auto -mr-2 pr-2" style="max-height: 42vh;">
            <p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>
        </div>
        <div class="mt-2 border-t pt-3 flex items-center gap-2">
            <select id="multi-config-user-select" class="select-field !py-1 flex-grow"></select>
            <button id="multi-add-from-config-btn" class="btn btn-ghost !py-1 !px-2 flex-shrink-0">æ·»åŠ </button>
            <button id="multi-load-all-from-config-btn" class="btn btn-ghost !py-1 !px-2 flex-shrink-0">æ·»åŠ å…¨éƒ¨</button>
        </div>
    </div>
    <div class="panel rounded-xl p-4 flex-shrink-0">
        <h3 class="font-bold text-slate-800 mb-2">å…¨å±€å‚æ•°</h3>
        <div id="multi-global-params-container" class="h-40 overflow-y-auto pr-1"></div>
    </div>
  </div>
  <div class="flex flex-col gap-4 h-full min-h-0">
    <div id="multi-map-container" class="flex-grow bg-slate-200 rounded-xl relative overflow-hidden border border-slate-200">
        <div class="absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200">
            <button id="multi-zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
            <span id="multi-zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
            <button id="multi-zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
            <button id="multi-reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
        </div>
    </div>
    <div class="panel rounded-xl p-4 h-48 flex flex-col">
        <h3 class="font-bold text-slate-800 mb-2">å…¨å±€æ—¥å¿—</h3>
        <textarea id="multi-log-text" readonly class="w-full flex-grow bg-white/80 border border-slate-200 rounded-md p-2 text-xs text-slate-700 resize-none focus:outline-none leading-snug"></textarea>
    </div>
  </div>
</main>

<!-- æ¨¡æ€å¯¹è¯æ¡† -->
<div id="amap-key-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
    <h3 class="text-xl font-bold text-red-600 text-center">ç¼ºå°‘åœ°å›¾API Key</h3>
    <p class="text-sm text-slate-600 text-center">
        ç¨‹åºéœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„é«˜å¾·åœ°å›¾JS API Keyæ‰èƒ½ä½¿ç”¨åœ°å›¾åŠŸèƒ½ã€‚è¯·å‰å¾€
        <a href="https://console.amap.com/dev/key/app" target="_blank" class="text-sky-600 hover:underline">é«˜å¾·å¼€æ”¾å¹³å°</a>
        ç”³è¯·ä¸€ä¸ªKeyï¼ˆç±»å‹é€‰æ‹©â€œWebç«¯(JS API)â€ï¼‰ï¼Œç„¶åç²˜è´´åˆ°ä¸‹æ–¹ã€‚
    </p>
    <div class="space-y-2">
        <label class="w-full text-slate-700 font-semibold">API Key:</label>
        <input id="amap-key-input" type="text" class="input-field w-full" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ä½ çš„API Key">
    </div>
    <div class="flex justify-end gap-3 pt-4">
      <button id="confirm-amap-key-btn" class="btn btn-primary">ç¡®è®¤å¹¶ä¿å­˜</button>
    </div>
  </div>
</div>







<div id="auto-gen-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
    <h3 class="text-xl font-bold text-sky-600 text-center">è‡ªåŠ¨ç”Ÿæˆè·¯çº¿é…ç½®</h3>
    <div class="space-y-4">
      <div class="flex items-center">
        <label class="w-32 text-slate-700 font-semibold">æœ€çŸ­æ—¶é—´(åˆ†é’Ÿ)</label>
        <input id="min-time-input" type="number" value="20" class="input-field w-full">
      </div>
      <div class="flex items-center">
        <label class="w-32 text-slate-700 font-semibold">æœ€é•¿æ—¶é—´(åˆ†é’Ÿ)</label>
        <input id="max-time-input" type="number" value="30" class="input-field w-full">
      </div>
      <div class="flex items-center">
        <label class="w-32 text-slate-700 font-semibold">æœ€çŸ­è·ç¦»(ç±³)</label>
        <input id="min-dist-input" type="number" value="2000" class="input-field w-full">
      </div>
    </div>
    <div class="flex justify-end gap-3 pt-4">
      <button id="cancel-gen-button" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
      <button id="confirm-gen-button" class="btn btn-primary">ç”Ÿæˆ</button>
    </div>
  </div>
</div>
<div id="user-details-modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/40" onclick="toggleUserDetails(false)"></div>
  <div class="panel rounded-2xl p-6 w-[32rem] space-y-4 relative">
    <div class="flex items-center justify-center gap-2">
      <h3 class="text-xl font-bold text-sky-600 text-center">ç”¨æˆ·è¯¦æƒ…</h3>
    </div>
    <div id="user-details-content" class="text-sm space-y-1 max-h-[70vh] overflow-y-auto"></div>
    <div class="flex justify-end pt-2"><button class="btn btn-ghost border border-slate-300" onclick="toggleUserDetails(false)">å…³é—­</button></div>
  </div>
</div>
<div id="task-details-modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/40" onclick="toggleTaskDetails(false)"></div>
  <div class="panel rounded-2xl p-6 w-[36rem] space-y-4 relative">
    <div class="flex items-center justify-center gap-2">
      <h3 class="text-xl font-bold text-sky-600 text-center">ä»»åŠ¡è¯¦æƒ…</h3>
    </div>
    <div id="task-details-content" class="text-sm space-y-1 max-h-[70vh] overflow-y-auto"></div>
    <div class="flex justify-end pt-2"><button class="btn btn-ghost border border-slate-300" onclick="toggleTaskDetails(false)">å…³é—­</button></div>
  </div>
</div>
<div id="account-params-modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/40" onclick="
    const modalElem = this.parentElement;
    modalElem.classList.add('hidden'); 
    modalElem.classList.remove('flex'); 
    document.body.classList.remove('modal-visible');
  "></div>
  <div class="panel rounded-2xl p-6 w-[32rem] space-y-4 relative">
    <h3 id="account-params-title" class="text-xl font-bold text-sky-600 text-center">è´¦å·å‚æ•°è®¾ç½®</h3>
    <div id="account-params-container" class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
    <div class="flex justify-end pt-2 gap-3">
      <button class="btn btn-ghost border border-slate-300" onclick="
        const m = this.closest('#account-params-modal');
        m.classList.add('hidden'); 
        m.classList.remove('flex'); 
        document.body.classList.remove('modal-visible');
      ">å…³é—­</button>

      <button id="save-account-params-btn" class="btn btn-primary">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="notifications-modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/40" onclick="toggleNotifications(false)"></div>
  <div class="panel rounded-2xl p-6 w-[36rem] space-y-4 relative">
    <h3 class="text-xl font-bold text-sky-600 text-center">é€šçŸ¥ä¸­å¿ƒ</h3>
    <div id="notifications-content" class="text-sm space-y-2 max-h-[70vh] overflow-y-auto pr-2">
      <p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½...</p>
    </div>
    <div class="flex justify-between items-center pt-2">
      <div class="flex gap-2"> <button id="refresh-notifications-btn" class="btn btn-ghost !py-1 !px-3 text-sky-600">åˆ·æ–°</button>
        <button id="mark-all-read-btn" class="btn btn-secondary !py-1 !px-3">ä¸€é”®å·²è¯»</button>
      </div>
      <button class="btn btn-ghost border border-slate-300" onclick="toggleNotifications(false)">å…³é—­</button>
    </div>
  </div>
</div>


<div id="alert-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1051]">
  <div class="absolute inset-0 bg-black/60" onclick="closeModalAlert()"></div>
  <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
    <h3 id="alert-modal-title" class="text-xl font-bold text-red-600 text-center">æ“ä½œå¤±è´¥</h3>
    <p id="alert-modal-message" class="text-sm text-slate-600 text-center py-4">
      è¿™æ˜¯ä¸€ä¸ªé”™è¯¯æç¤ºã€‚
    </p>
    <div class="flex justify-center gap-3 pt-4">
      <button id="alert-modal-close-btn" class="btn btn-primary">å…³é—­</button>
    </div>
  </div>
</div>

<div id="admin-panel-modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/40" onclick="toggleAdminPanel(false)"></div>
  <div class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-bold text-sky-600">ç®¡ç†é¢æ¿</h3>
      <button class="btn btn-ghost !py-1 !px-3" onclick="toggleAdminPanel(false)">å…³é—­</button>
    </div>
    
    <!-- ç®¡ç†æ ‡ç­¾ -->
    <div class="flex border-b border-slate-200">
      <button id="admin-tab-users" class="px-4 py-2 font-semibold text-sky-600 border-b-2 border-sky-600">ç”¨æˆ·ç®¡ç†</button>
      <button id="admin-tab-groups" class="px-4 py-2 font-semibold text-slate-400 border-b-2 border-transparent">æƒé™ç»„ç®¡ç†</button>
    </div>
    
    <!-- ç”¨æˆ·ç®¡ç†é¢æ¿ -->
    <div id="admin-users-panel" class="space-y-4">
      <div class="flex justify-between items-center">
        <h4 class="font-semibold">ç”¨æˆ·åˆ—è¡¨</h4>
        <button id="admin-refresh-users" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
      </div>
      <div id="admin-users-list" class="space-y-2">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>
    </div>
    
    <!-- æƒé™ç»„ç®¡ç†é¢æ¿ -->
    <div id="admin-groups-panel" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <h4 class="font-semibold">æƒé™ç»„åˆ—è¡¨</h4>
        <button id="admin-refresh-groups" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
      </div>
      <div id="admin-groups-list" class="space-y-2">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>
    </div>
  </div>
</div>

<div id="confirm-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1052]">
  <div class="absolute inset-0 bg-black/60"></div> <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
    <h3 id="confirm-modal-title" class="text-xl font-bold text-amber-600 text-center">è¯·ç¡®è®¤</h3>
    <p id="confirm-modal-message" class="text-sm text-slate-600 text-center py-4">
      ä½ ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ
    </p>
    <div class="flex justify-end gap-3 pt-4">
      <button id="confirm-modal-cancel-btn" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
      <button id="confirm-modal-ok-btn" class="btn btn-primary">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script>
// ==============================================================================
// JavaScriptéƒ¨åˆ†
// ==============================================================================

// å…¨å±€å˜é‡

let cdnErrorOccurred = false;
function handleCdnError() {
  if (cdnErrorOccurred) return;
  cdnErrorOccurred = true;

  
  // åªè´Ÿè´£æ˜¾ç¤ºé”™è¯¯æç¤ºé¡µé¢ï¼Œä¸å†éšè—å…¶ä»–å…ƒç´ æˆ–åœæ­¢é¡µé¢
  const errorOverlay = document.getElementById('cdn-error-overlay');
  if (errorOverlay) {
    // ä½¿ç”¨ !important æ¥ç¡®ä¿å®ƒèƒ½è¦†ç›–å…¶ä»–æ ·å¼
    errorOverlay.style.setProperty('display', 'flex', 'important');
  }

  console.error("ä¸€ä¸ªæˆ–å¤šä¸ªCDNèµ„æºåŠ è½½å¤±è´¥ï¼Œå·²æ˜¾ç¤ºé”™è¯¯æç¤ºã€‚åº”ç”¨å°†ç»§ç»­å°è¯•åˆå§‹åŒ–ã€‚");
}


function showModalAlert(message, title = 'æç¤º') {
  const modal = $('alert-modal');
  const titleEl = $('alert-modal-title');
  const msgEl = $('alert-modal-message');
  const closeBtn = $('alert-modal-close-btn');

  if (!modal || !titleEl || !msgEl || !closeBtn) {
    // æ¨¡æ€æ¡†DOMä¸å­˜åœ¨ï¼Œå›é€€åˆ°åŸç”Ÿ alert
    console.warn('Alert modal DOM not found, falling back to native alert.');
    alert(`${title}:\n${message}`);
    return;
  }

  titleEl.textContent = title;
  // æ›¿æ¢ \n ä¸º <br> ä»¥æ”¯æŒæ¢è¡Œ
  msgEl.innerHTML = String(message).replace(/\n/g, '<br>');
  
  // æ ¹æ®æ ‡é¢˜è®¾ç½®é¢œè‰²
  if (title.includes('å¤±è´¥') || title.includes('é”™è¯¯')) {
    titleEl.classList.remove('text-sky-600');
    titleEl.classList.add('text-red-600');
  } else {
    titleEl.classList.remove('text-red-600');
    titleEl.classList.add('text-sky-600');
  }

  closeBtn.onclick = closeModalAlert;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  document.body.classList.add('modal-visible'); // éšè—åœ°å›¾ç‰ˆæƒ
}

function closeModalAlert() {
  const modal = $('alert-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ¨¡æ€æ¡†å¯è§
  const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
  let stillVisible = false;
  otherModals.forEach(m => {
    if (m.id !== 'alert-modal' && !m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
        stillVisible = true;
    }
  });
  if (!stillVisible) {
    document.body.classList.remove('modal-visible');
  }
}

// --- é€šç”¨ç¡®è®¤æ¨¡æ€æ¡† (ä¿®å¤ Bug 2) ---
let resolveConfirmPromise = null;

function jsShowConfirm(title, message) {
  // è¿”å›ä¸€ä¸ª Promiseï¼Œpywebview ä¼šç­‰å¾…å®ƒ
  return new Promise((resolve) => {
    const modal = $('confirm-modal');
    const titleEl = $('confirm-modal-title');
    const msgEl = $('confirm-modal-message');
    const okBtn = $('confirm-modal-ok-btn');
    const cancelBtn = $('confirm-modal-cancel-btn');

    if (!modal || !titleEl || !msgEl || !okBtn || !cancelBtn) {
      console.error('Confirm modal DOM not found. Falling back to native confirm.');
      // å›é€€åˆ°åŸç”Ÿ confirmï¼Œå®ƒä¹Ÿä¼šé˜»å¡å¹¶è¿”å›å€¼
      resolve(confirm(`${title}:\n${message}`));
      return;
    }
    
    // ä¿å­˜ resolve å‡½æ•°ï¼Œä»¥ä¾¿æŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨
    resolveConfirmPromise = resolve;

    titleEl.textContent = title || 'è¯·ç¡®è®¤';
    msgEl.innerHTML = String(message).replace(/\n/g, '<br>');

    // ç§»é™¤æ—§ç›‘å¬å™¨ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
    okBtn.onclick = null;
    cancelBtn.onclick = null;
    
    // ç»‘å®šæ–°ç›‘å¬å™¨
    okBtn.onclick = () => handleConfirm(true);
    cancelBtn.onclick = () => handleConfirm(false);

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-visible');
  });
}

function handleConfirm(result) {
  const modal = $('confirm-modal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  
  // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ¨¡æ€æ¡†å¯è§ (ä½¿ç”¨ä¸ closeModalAlert ç›¸åŒçš„é€»è¾‘)
  const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
  let stillVisible = false;
  otherModals.forEach(m => {
    if (m.id !== 'confirm-modal' && !m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
        stillVisible = true;
    }
  });
  if (!stillVisible) {
    document.body.classList.remove('modal-visible');
  }

  // è§£æ Promise
  if (resolveConfirmPromise) {
    resolveConfirmPromise(result);
    resolveConfirmPromise = null; // æ¸…ç†
  }
}




let pywebviewApiReady = false;

let AMAP_API_KEY = ""; // å…¨å±€API Keyå˜é‡
let isRefreshingNotifications = false; // é€šçŸ¥åˆ·æ–°çš„â€œin-flightâ€æ ‡å¿—

let isRefreshingTasks = false;


// ç¦»çº¿æ¨¡å¼æ ‡å¿—
let IS_OFFLINE = false;

// Webæ¨¡å¼æ£€æµ‹å’ŒAPIå°è£…
let isWebMode = (typeof window.pywebview === 'undefined');  // å¦‚æœæ²¡æœ‰pywebviewï¼Œåˆ™ä¸ºWebæ¨¡å¼
let sessionUUID = null;  // å½“å‰ä¼šè¯UUID

// ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°
async function callPythonAPI(method, ...args) {
  if (isWebMode) {
    // Webæ¨¡å¼ï¼šé€šè¿‡HTTPè°ƒç”¨åç«¯APIï¼Œå¸¦ä¸Šä¼šè¯UUID
    const headers = {
      'Content-Type': 'application/json',
    };
    
    // æ·»åŠ ä¼šè¯UUIDåˆ°è¯·æ±‚å¤´
    if (sessionUUID) {
      headers['X-Session-ID'] = sessionUUID;
    }
    
    const response = await fetch(`/api/${method}`, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(args.length === 1 && typeof args[0] === 'object' ? args[0] : args)
    });
    if (!response.ok) {
      throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.statusText}`);
    }
    return await response.json();
  } else {
    // æ¡Œé¢æ¨¡å¼ï¼šç›´æ¥è°ƒç”¨pywebview API
    if (!window.pywebview || !window.pywebview.api) {
      throw new Error('pywebview APIæœªå°±ç»ª');
    }
    const func = window.pywebview.api[method];
    if (typeof func !== 'function') {
      throw new Error(`æœªçŸ¥çš„APIæ–¹æ³•: ${method}`);
    }
    return await func(...args);
  }
}

// åœ¨æœåŠ¡å™¨ç«¯Chromeä¸­æ‰§è¡ŒJavaScriptï¼ˆWebæ¨¡å¼ä¸“ç”¨ï¼‰
async function executeServerJS(script, ...args) {
  if (!isWebMode) {
    // éWebæ¨¡å¼ï¼Œç›´æ¥åœ¨æœ¬åœ°æ‰§è¡Œ
    return eval(script);
  }
  
  // Webæ¨¡å¼ï¼šå‘é€åˆ°æœåŠ¡å™¨ç«¯Chromeæ‰§è¡Œ
  const headers = {
    'Content-Type': 'application/json',
  };
  
  // æ·»åŠ ä¼šè¯UUIDåˆ°è¯·æ±‚å¤´
  if (sessionUUID) {
    headers['X-Session-ID'] = sessionUUID;
  }
  
  const response = await fetch('/execute_js', {
    method: 'POST',
    headers: headers,
    body: JSON.stringify({
      script: script,
      args: args
    })
  });
  
  if (!response.ok) {
    throw new Error(`æœåŠ¡å™¨ç«¯JSæ‰§è¡Œå¤±è´¥: ${response.statusText}`);
  }
  
  const data = await response.json();
  if (!data.success) {
    throw new Error(data.message || 'JSæ‰§è¡Œå¤±è´¥');
  }
  
  return data.result;
}

// å•è´¦å·æ¨¡å¼ï¼šGPSç‚¹è¿›åº¦è®¡æ•°
let singleProcessedPoints = 0;       // å·²å¤„ç†/å·²ä¸ŠæŠ¥çš„ç‚¹æ•°
let singleTotalPoints = 0;           // å½“å‰ä»»åŠ¡æ€»ç‚¹æ•°ï¼ˆrun_coordsé•¿åº¦ï¼‰


// ç»Ÿä¸€çš„ AMap å•ä¾‹ä¸åŠ è½½æ§åˆ¶
let AMapInstance, map;
let amapLoadingPromise = null;   // ä¿è¯åªè§¦å‘ä¸€æ¬¡åŠ è½½
let AMapReady = false;           // SDKæ˜¯å¦å°±ç»ª

let currentTasks = [];
let selectedTaskIndex = -1;
let currentUserData = {};
let currentRunData = {};
let polylines = { recommended: [], draft: null, run: null, history: null };
let markers = [];
let runnerMarker = null;
let drawingInfoMarker = null;
let tempAttendanceMarker = null;
let tempAttendanceCircle = null;
let isDrawing = false;
let isPathDrawing = false;
let leftMouseDown = false;
const $ = (id) => document.getElementById(id);

let multiAccountMap;
let multiAccountMarkers = {}; // {username: AMap.Marker}
const userColors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
let colorIndex = 0;
let path_planning_queue = [];
let is_planning_path = false;

let currentSessionUA = ""

let pendingMultiPositions = []; // [{ username, lon, lat, name }]

// -- åœ°å›¾åˆå§‹åŒ–Promiseï¼Œç”¨äºç¡®ä¿åœ°å›¾å®Œå…¨åŠ è½½åå†æ‰§è¡Œç»˜å›¾æ“ä½œ --
let mapReadyPromise = null;
let resolveMapReady = null;

// å‚æ•°å®šä¹‰ï¼ˆè¯¦ç»†ç‰ˆï¼šæ ‡ç­¾ã€å•ä½ã€å¸®åŠ©ï¼‰
const paramDefs = {
  // é‡‡æ ·ä¸é€Ÿåº¦
  "interval_ms": {
    label: "é‡‡æ ·é—´éš”",
    unit: "ms",
    help: "ç›¸é‚» GPS ç‚¹ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œç”¨äºæ¨¡æ‹Ÿä¸ŠæŠ¥èŠ‚å¥ã€‚"
  },
  "interval_random_ms": {
    label: "é—´éš”éšæœºèŒƒå›´",
    unit: "ms",
    help: "åœ¨é‡‡æ ·é—´éš”çš„åŸºç¡€ä¸Šä¸Šä¸‹æµ®åŠ¨çš„éšæœºæŠ–åŠ¨å¹…åº¦ã€‚"
  },
  "speed_mps": {
    label: "å¹³å‡é€Ÿåº¦",
    unit: "m/s",
    help: "ç”Ÿæˆ/å¤„ç†è·¯å¾„æ—¶çš„ç›®æ ‡å¹³å‡é€Ÿåº¦ã€‚"
  },
  "speed_random_mps": {
    label: "é€Ÿåº¦éšæœºèŒƒå›´",
    unit: "m/s",
    help: "é€Ÿåº¦çš„ä¸Šä¸‹æµ®åŠ¨èŒƒå›´ï¼Œç”¨äºæ¨¡æ‹Ÿè‡ªç„¶æ³¢åŠ¨ã€‚"
  },
  "location_random_m": {
    label: "å®šä½éšæœºåç§»åŠå¾„",
   
 unit: "m",
    help: "å¯¹æ¯ä¸ª GPS ç‚¹æ–½åŠ çš„éšæœºåç§»çš„åŠå¾„ï¼Œæ¨¡æ‹Ÿå®šä½å™ªå£°ã€‚"
  },

  // ä»»åŠ¡é—´éš”
  "task_gap_min_s": {
    label: "ä»»åŠ¡é—´éš™ä¸‹é™",
    unit: "s",
    help: "è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„æœ€çŸ­ç­‰å¾…æ—¶é—´ã€‚"
  },
  "task_gap_max_s": {
    label: "ä»»åŠ¡é—´éš™ä¸Šé™",
    unit: "s",
    help: "è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚"
  },

  // API é‡è¯•ç­–ç•¥
  "api_fallback_line": {
    label: "è§„åˆ’å¤±è´¥æ—¶ä½¿ç”¨ç›´çº¿è¿æ¥",
    unit: "",
    help: "å¯ç”¨åï¼Œå½“æŸæ®µæ­¥è¡Œè·¯å¾„è§„åˆ’å¤±è´¥æ—¶ï¼Œä½¿ç”¨èµ·ç»ˆç‚¹ç›´çº¿ä»£æ›¿ã€‚"
  },
  "api_retries": {
    label: "APIé‡è¯•æ¬¡æ•°",
    unit: "æ¬¡",
    help: "æ­¥è¡Œè·¯å¾„æ¯ä¸€æ®µå¤±è´¥åçš„é‡è¯•æ¬¡æ•°ã€‚"
  },
  
"api_retry_delay_s": {
    label: "APIé‡è¯•é—´éš”",
    unit: "s",
    help: "æ­¥è¡Œè·¯å¾„å¤±è´¥åå‘èµ·ä¸‹ä¸€æ¬¡é‡è¯•å‰çš„ç­‰å¾…æ—¶é—´ã€‚"
  },
  "ignore_task_time": {
    label: "å¿½ç•¥ä»»åŠ¡æ—¶é—´ä»…å¯¹æ¯”æ—¥æœŸ",
    unit: "",
    help: "å‹¾é€‰åï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦â€œæœªå¼€å§‹â€æˆ–â€œå·²è¿‡æœŸâ€æ—¶ï¼Œåªå¯¹æ¯”å¹´æœˆæ—¥ï¼Œå¿½ç•¥å…·ä½“æ—¶åˆ†ç§’ã€‚"
  },

  // è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ç›®æ ‡
  "min_time_m": {
    label: "ç›®æ ‡æ—¶é•¿ä¸‹é™",
    unit: "åˆ†é’Ÿ",
    help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»æ—¶é•¿æœ€å°å€¼ã€‚"
  },
  "max_time_m": {
    label: "ç›®æ ‡æ—¶é•¿ä¸Šé™",
    unit: "åˆ†é’Ÿ",
    help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»æ—¶é•¿æœ€å¤§å€¼ã€‚"
  },
  "min_dist_m": {
    label: "ç›®æ ‡è·ç¦»ä¸‹é™",
    unit: "m",
    help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»è·ç¦»ä¸‹é™ã€‚ä¸Šé™æŒ‰ 1.0â€“1.15 å€éšæœºæµ®åŠ¨ã€‚"
  },

  // ä¸»é¢˜
  "theme_style": {
    label: "ç•Œé¢ä¸»é¢˜é£æ ¼",
    unit: "",
    help: "åˆ‡æ¢åº”ç”¨ç•Œé¢çš„å¤–è§‚ã€‚ä¸»é¢˜åˆ‡æ¢åå°†è‡ªåŠ¨ä¿å­˜ã€‚",
    type: "theme_selector" // è‡ªå®šä¹‰ç±»å‹ï¼Œç”¨äºç”Ÿæˆä¸»é¢˜æŒ‰é’®
  },
  "theme_base_color": {
    label: "ä¸»é¢˜åŸºç¡€é¢œè‰²",
    unit: "",
    help: "ç•Œé¢ä¸»è‰²è°ƒï¼ˆç‚¹å‡»é¢œè‰²å—è¿›è¡Œé€‰æ‹©ï¼‰ã€‚",
    type: "color_picker" // è‡ªå®šä¹‰ç±»å‹ï¼Œç”¨äºç”Ÿæˆé¢œè‰²é€‰æ‹©å™¨
  },
  "auto_attendance_enabled": {
    label: "å¼€å¯è‡ªåŠ¨ç­¾åˆ°",
    unit: "",
    help: "å¼€å¯åï¼Œå°†åœ¨åå°è‡ªåŠ¨åˆ·æ–°é€šçŸ¥å¹¶å°è¯•ç­¾åˆ°",
    type: "checkbox"
  },
  "auto_attendance_refresh_s": {
    label: "åˆ·æ–°é—´éš”",
    unit: "ç§’",
    help: "è‡ªåŠ¨åˆ·æ–°é€šçŸ¥çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå»ºè®®ä¸ä½äº60"
  },
  "attendance_user_radius_m": {
    label: "éšæœºåŠå¾„",
    unit: "ç±³",
    help: "è‡ªåŠ¨ç­¾åˆ°æ—¶ï¼Œåœ¨æœåŠ¡å™¨å…è®¸èŒƒå›´å†…çš„æœ€å¤§éšæœºåç§»åŠå¾„ã€‚è®¾ä¸º0ä¸ºç²¾ç¡®ç­¾åˆ°ã€‚"
  }
};

// å‚æ•°åˆ†ç»„å®šä¹‰
const paramGroups = [
  {
    title: "é‡‡æ ·ä¸é€Ÿåº¦",
    keys: ["interval_ms","interval_random_ms","speed_mps","speed_random_mps","location_random_m"]
  },
  {
    title: "ä»»åŠ¡é—´éš”",
    keys: ["task_gap_min_s", "task_gap_max_s", "ignore_task_time"]
  },
  {
    title: "è·¯å¾„è§„åˆ’é‡è¯•ç­–ç•¥",
    keys: ["api_fallback_line","api_retries","api_retry_delay_s"]
  },
  {
    title: "è‡ªåŠ¨ç”Ÿæˆç›®æ ‡",
    keys: ["min_time_m","max_time_m","min_dist_m"]
  },
  {
    title: "ä¸»é¢˜ä¸å¤–è§‚",
    keys: ["theme_style", "theme_base_color"]
  },
  {
    title: "è‡ªåŠ¨ç­¾åˆ°",
    keys: ["auto_attendance_enabled", "auto_attendance_refresh_s", "attendance_user_radius_m"]
  }
];

let pythonParams = {};

let runAccumulatedMs = 0;
let draftTotalDist = 0;


// æ˜¾å¼é”€æ¯å•è´¦å·åœ°å›¾å®ä¾‹ï¼Œé‡Šæ”¾èµ„æºå¹¶å¤ä½å˜é‡
function destroySingleMap() {
  try {
    // å…ˆæ¸…ç†è‡ªå®šä¹‰äº¤äº’ç›‘å¬å™¨
    if (window.mapCleanup) {
      window.mapCleanup();
      window.mapCleanup = null;
    }
    if (map && typeof map.destroy === 'function') {
      map.destroy();
    }
  } catch (e) {
    console.warn('destroySingleMap warning:', e);
  } finally {
    map = null;
    polylines.recommended = [];
    polylines.draft = null;
    polylines.run = null;
    polylines.history = null;
    markers = [];
    runnerMarker = null;
    drawingInfoMarker = null;

    try { const container = document.getElementById('map-container'); if (container) container.classList.remove('drawing'); } catch (_) {}
    isDrawing = false; isPathDrawing = false; leftMouseDown = false; pendingUnlockMap = false;
    draftPath = []; draftPathLngLat = []; pendingPoints = []; isUpdating = false; lastMouseMoveTime = 0;
    try { document.body.classList.remove('modal-visible'); } catch (_) {}
  }
}





function updateMultiGlobalButtons(startDisabled, stopDisabled) {
  const startBtn = document.getElementById('multi-start-all-btn');
  const stopBtn  = document.getElementById('multi-stop-all-btn');
  if (!startBtn || !stopBtn) return;
  // åç«¯ä¼ å…¥çš„å¸ƒå°”å€¼å³æŒ‰é’®ç¦ç”¨çŠ¶æ€
  startBtn.disabled = !!startDisabled;
  stopBtn.disabled  = !!stopDisabled;
}


// å®‰å…¨ resize å¹¶åœ¨ä¸‹ä¸€å¸§ç»Ÿä¸€ fit è§†è§’ï¼ˆé¿å…åˆæ¬¡æ˜¾ç¤ºåç§»ï¼‰
function safeResizeAndFitView() {
  try {
    map.resize();
    requestAnimationFrame(() => {
      resetMapView();
      // å†è¡¥ä¸€æ¬¡ fitViewï¼Œç¡®ä¿ marker æŠ•å½±æ­£ç¡®
      if (markers.length > 0) {
        map.setFitView(markers, false, [50, 50, 50, 50]);
      }
    });
  } catch (e) {
    console.warn('safeResizeAndFitView error:', e);
  }
}





// --- æ–°å¢ï¼šä¸»é¢˜é£æ ¼åˆ‡æ¢ ---
function setThemeStyle(styleName) {
  // ç§»é™¤ body ä¸Šæ‰€æœ‰å¯èƒ½çš„ä¸»é¢˜ class
  document.body.classList.remove('theme-anime', 'theme-minimalist');
  
  // å¦‚æœä¸æ˜¯é»˜è®¤ä¸»é¢˜ï¼Œåˆ™æ·»åŠ å¯¹åº”çš„ class
  if (styleName !== 'default') {
    document.body.classList.add(styleName);
  }
  
  // æ›´æ–°æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
  const themeButtons = document.querySelectorAll('#params-tab .grid button[onclick^="setThemeStyle"]');
  themeButtons.forEach(btn => {
    if (btn.getAttribute('onclick') === `setThemeStyle('${styleName}')`) {
      btn.classList.add('border-2', 'border-sky-500'); // é«˜äº®é€‰ä¸­
    } else {
      btn.classList.remove('border-2', 'border-sky-500');
    }
  });

  // è°ƒç”¨ Python åç«¯ä¿å­˜è®¾ç½®
  callPythonAPI('update_param', 'theme_style', styleName);
  logMessage(`ä¸»é¢˜å·²åˆ‡æ¢ä¸º: ${styleName}`);
}


// --- æ¢å¤é»˜è®¤ä¸»é¢˜é¢œè‰² ---
function resetBaseColorToDefault(prefix) {
  const defaultColor = '#7dd3fc';
  const key = 'theme_base_color';

  // 1. æ›´æ–°é¢œè‰²é€‰æ‹©å™¨å’Œæ–‡æœ¬æ¡†çš„UI
  const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
  const textInput = document.getElementById(`${prefix}-${key}`);
  if (colorPicker) colorPicker.value = defaultColor;
  if (textInput) textInput.value = defaultColor;

  // 2. è°ƒç”¨ç°æœ‰å‡½æ•°æ›´æ–°ç•Œé¢ä¸»é¢˜å¹¶ä¿å­˜åˆ°åç«¯
  // setBaseColor å†…éƒ¨å·²ç»åŒ…å«äº†è°ƒç”¨ python api ä¿å­˜çš„é€»è¾‘
  setBaseColor(defaultColor, defaultColor);

  // 3. æ›´æ–°å‰ç«¯ç¼“å­˜çš„å‚æ•°å¯¹è±¡ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´
  if (pythonParams) {
      pythonParams[key] = defaultColor;
  }
  
  logMessage("ä¸»é¢˜é¢œè‰²å·²æ¢å¤ä¸ºé»˜è®¤ã€‚");
}

// --- ä¸»é¢˜é¢œè‰²è®¾ç½® ---
function setBaseColor(c, deep) {
  document.documentElement.style.setProperty('--base-color', c);
  document.documentElement.style.setProperty('--base-color-600', deep);
  document.documentElement.style.setProperty('--base-color-300', c);
  callPythonAPI('update_param', 'theme_base_color', c);
  if ($('base-color-input')) $('base-color-input').value = c;
}
function onColorPicked(val) { setBaseColor(val, val); }

// ====================
// è®¤è¯ç³»ç»Ÿ JavaScript
// ====================

// æ£€æŸ¥å¹¶æ˜¾ç¤ºè®¤è¯çŠ¶æ€
async function checkAuthStatus() {
  if (!isWebMode) {
    // æ¡Œé¢æ¨¡å¼è·³è¿‡è®¤è¯
    return true;
  }
  
  // æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è®¤è¯
  try {
    const result = await callPythonAPI('get_initial_data');
    if (result && result.is_authenticated) {
      return true;
    }
  } catch (e) {
    console.log('æœªè®¤è¯æˆ–ä¼šè¯è¿‡æœŸ');
  }
  
  return false;
}

// æ˜¾ç¤ºè®¤è¯ç™»å½•ç•Œé¢
function showAuthLogin() {
  $('auth-login-container').classList.remove('hidden');
  $('login-container').classList.add('hidden');
  $('main-app').classList.add('hidden');
  
  // æ£€æŸ¥æ˜¯å¦å…è®¸æ¸¸å®¢ç™»å½•
  checkGuestLoginEnabled();
}

// æ£€æŸ¥æ˜¯å¦å…è®¸æ¸¸å®¢ç™»å½•
async function checkGuestLoginEnabled() {
  try {
    const result = await fetch('/auth/get_config');
    const data = await result.json();
    if (data.success && data.allow_guest_login) {
      $('guest-login-section').classList.remove('hidden');
    } else {
      $('guest-login-section').classList.add('hidden');
    }
  } catch (e) {
    console.error('è·å–é…ç½®å¤±è´¥:', e);
  }
}

// åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
function switchAuthTab(tab) {
  const loginTab = $('auth-tab-login');
  const registerTab = $('auth-tab-register');
  const loginForm = $('auth-login-form');
  const registerForm = $('auth-register-form');
  
  if (tab === 'login') {
    loginTab.classList.add('text-sky-600', 'border-sky-600');
    loginTab.classList.remove('text-slate-400', 'border-transparent');
    registerTab.classList.remove('text-sky-600', 'border-sky-600');
    registerTab.classList.add('text-slate-400', 'border-transparent');
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
  } else {
    registerTab.classList.add('text-sky-600', 'border-sky-600');
    registerTab.classList.remove('text-slate-400', 'border-transparent');
    loginTab.classList.remove('text-sky-600', 'border-sky-600');
    loginTab.classList.add('text-slate-400', 'border-transparent');
    registerForm.classList.remove('hidden');
    loginForm.classList.add('hidden');
  }
  
  // æ¸…ç©ºé”™è¯¯/æˆåŠŸæ¶ˆæ¯
  $('auth-error-msg').classList.add('hidden');
  $('auth-success-msg').classList.add('hidden');
}

// æ˜¾ç¤ºè®¤è¯é”™è¯¯æ¶ˆæ¯
function showAuthError(message) {
  const errorMsg = $('auth-error-msg');
  errorMsg.textContent = message;
  errorMsg.classList.remove('hidden');
  $('auth-success-msg').classList.add('hidden');
}

// æ˜¾ç¤ºè®¤è¯æˆåŠŸæ¶ˆæ¯
function showAuthSuccess(message) {
  const successMsg = $('auth-success-msg');
  successMsg.textContent = message;
  successMsg.classList.remove('hidden');
  $('auth-error-msg').classList.add('hidden');
}

// ç”¨æˆ·ç™»å½•
async function handleAuthLogin() {
  const username = $('auth-username').value.trim();
  const password = $('auth-password').value.trim();
  
  if (!username || !password) {
    showAuthError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
    return;
  }
  
  try {
    const response = await fetch('/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-ID': sessionUUID
      },
      body: JSON.stringify({
        auth_username: username,
        auth_password: password
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAuthSuccess('ç™»å½•æˆåŠŸï¼');
      setTimeout(() => {
        // éšè—è®¤è¯ç•Œé¢ï¼Œæ˜¾ç¤ºåº”ç”¨ç™»å½•ç•Œé¢
        $('auth-login-container').classList.add('hidden');
        $('login-container').classList.remove('hidden');
        // å¦‚æœæ˜¯æ¸¸å®¢ï¼Œæ˜¾ç¤ºæç¤º
        if (result.is_guest) {
          logMessage('[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼šæ— æ³•æ ‡è®°é€šçŸ¥å·²è¯»ã€æ— æ³•ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½ã€æ— æ³•æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡');
        }
      }, 1000);
    } else {
      showAuthError(result.message || 'ç™»å½•å¤±è´¥');
    }
  } catch (e) {
    showAuthError('ç™»å½•è¯·æ±‚å¤±è´¥ï¼š' + e.message);
  }
}

// ç”¨æˆ·æ³¨å†Œ
async function handleAuthRegister() {
  const username = $('auth-reg-username').value.trim();
  const password = $('auth-reg-password').value.trim();
  const passwordConfirm = $('auth-reg-password-confirm').value.trim();
  
  // éªŒè¯è¾“å…¥
  if (!username || !password || !passwordConfirm) {
    showAuthError('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
    return;
  }
  
  if (username.length < 3 || username.length > 20) {
    showAuthError('ç”¨æˆ·åé•¿åº¦åº”ä¸º3-20å­—ç¬¦');
    return;
  }
  
  if (password.length < 6) {
    showAuthError('å¯†ç é•¿åº¦è‡³å°‘ä¸º6å­—ç¬¦');
    return;
  }
  
  if (password !== passwordConfirm) {
    showAuthError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
    return;
  }
  
  try {
    const response = await fetch('/auth/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        auth_username: username,
        auth_password: password
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAuthSuccess('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
      setTimeout(() => {
        // åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾å¹¶å¡«å……ç”¨æˆ·å
        switchAuthTab('login');
        $('auth-username').value = username;
        $('auth-password').value = password;
      }, 1500);
    } else {
      showAuthError(result.message || 'æ³¨å†Œå¤±è´¥');
    }
  } catch (e) {
    showAuthError('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼š' + e.message);
  }
}

// æ¸¸å®¢ç™»å½•
async function handleGuestLogin() {
  try {
    const response = await fetch('/auth/guest_login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-ID': sessionUUID
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAuthSuccess('ä»¥æ¸¸å®¢èº«ä»½ç™»å½•æˆåŠŸï¼');
      setTimeout(() => {
        $('auth-login-container').classList.add('hidden');
        $('login-container').classList.remove('hidden');
        logMessage('[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼šæ— æ³•æ ‡è®°é€šçŸ¥å·²è¯»ã€æ— æ³•ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½ã€æ— æ³•æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡');
      }, 1000);
    } else {
      showAuthError(result.message || 'æ¸¸å®¢ç™»å½•å¤±è´¥');
    }
  } catch (e) {
    showAuthError('æ¸¸å®¢ç™»å½•è¯·æ±‚å¤±è´¥ï¼š' + e.message);
  }
}

// ====================
// è®¤è¯äº‹ä»¶ç»‘å®š
// ====================

// åœ¨DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    // è®¤è¯æ ‡ç­¾åˆ‡æ¢
    const loginTab = $('auth-tab-login');
    const registerTab = $('auth-tab-register');
    if (loginTab) loginTab.addEventListener('click', () => switchAuthTab('login'));
    if (registerTab) registerTab.addEventListener('click', () => switchAuthTab('register'));
    
    // ç™»å½•æŒ‰é’®
    const loginBtn = $('auth-login-btn');
    if (loginBtn) loginBtn.addEventListener('click', handleAuthLogin);
    
    // æ³¨å†ŒæŒ‰é’®
    const registerBtn = $('auth-register-btn');
    if (registerBtn) registerBtn.addEventListener('click', handleAuthRegister);
    
    // æ¸¸å®¢ç™»å½•æŒ‰é’®
    const guestBtn = $('auth-guest-btn');
    if (guestBtn) guestBtn.addEventListener('click', handleGuestLogin);
    
    // Enteré”®ç™»å½•
    const authUsername = $('auth-username');
    const authPassword = $('auth-password');
    if (authUsername) authUsername.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAuthLogin();
    });
    if (authPassword) authPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAuthLogin();
    });
    
    // Enteré”®æ³¨å†Œ
    const authRegPassword = $('auth-reg-password-confirm');
    if (authRegPassword) authRegPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAuthRegister();
    });
    
    // ç®¡ç†é¢æ¿æŒ‰é’®
    const adminPanelBtn = $('show-admin-panel');
    if (adminPanelBtn) adminPanelBtn.addEventListener('click', () => toggleAdminPanel(true));
    
    // ç®¡ç†é¢æ¿æ ‡ç­¾
    const adminUsersTab = $('admin-tab-users');
    const adminGroupsTab = $('admin-tab-groups');
    if (adminUsersTab) adminUsersTab.addEventListener('click', () => switchAdminTab('users'));
    if (adminGroupsTab) adminGroupsTab.addEventListener('click', () => switchAdminTab('groups'));
    
    // åˆ·æ–°æŒ‰é’®
    const refreshUsersBtn = $('admin-refresh-users');
    const refreshGroupsBtn = $('admin-refresh-groups');
    if (refreshUsersBtn) refreshUsersBtn.addEventListener('click', loadAdminUsers);
    if (refreshGroupsBtn) refreshGroupsBtn.addEventListener('click', loadAdminGroups);
  });
}

// ====================
// ç®¡ç†é¢æ¿åŠŸèƒ½
// ====================

function toggleAdminPanel(show) {
  const modal = $('admin-panel-modal');
  if (show) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    loadAdminUsers();
  } else {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

function switchAdminTab(tab) {
  const usersTab = $('admin-tab-users');
  const groupsTab = $('admin-tab-groups');
  const usersPanel = $('admin-users-panel');
  const groupsPanel = $('admin-groups-panel');
  
  if (tab === 'users') {
    usersTab.classList.add('text-sky-600', 'border-sky-600');
    usersTab.classList.remove('text-slate-400', 'border-transparent');
    groupsTab.classList.remove('text-sky-600', 'border-sky-600');
    groupsTab.classList.add('text-slate-400', 'border-transparent');
    usersPanel.classList.remove('hidden');
    groupsPanel.classList.add('hidden');
    loadAdminUsers();
  } else {
    groupsTab.classList.add('text-sky-600', 'border-sky-600');
    groupsTab.classList.remove('text-slate-400', 'border-transparent');
    usersTab.classList.remove('text-sky-600', 'border-sky-600');
    usersTab.classList.add('text-slate-400', 'border-transparent');
    groupsPanel.classList.remove('hidden');
    usersPanel.classList.add('hidden');
    loadAdminGroups();
  }
}

async function loadAdminUsers() {
  try {
    const response = await fetch('/auth/admin/list_users', {
      headers: {
        'X-Session-ID': sessionUUID
      }
    });
    const result = await response.json();
    
    if (!result.success) {
      $('admin-users-list').innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
      return;
    }
    
    const listEl = $('admin-users-list');
    if (result.users.length === 0) {
      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç”¨æˆ·</p>';
      return;
    }
    
    // åŒæ—¶è·å–æƒé™ç»„åˆ—è¡¨
    const groupsResp = await fetch('/auth/admin/list_groups', {
      headers: {
        'X-Session-ID': sessionUUID
      }
    });
    const groupsData = await groupsResp.json();
    const groups = groupsData.success ? Object.keys(groupsData.groups) : ['guest', 'user', 'admin'];
    
    listEl.innerHTML = result.users.map(user => {
      const createdDate = new Date(user.created_at * 1000).toLocaleString();
      const lastLoginDate = user.last_login ? new Date(user.last_login * 1000).toLocaleString() : 'ä»æœªç™»å½•';
      
      const groupSelect = `
        <select class="text-sm border border-slate-300 rounded px-2 py-1" onchange="updateUserGroup('${user.auth_username}', this.value)">
          ${groups.map(g => `<option value="${g}" ${g === user.group ? 'selected' : ''}>${g}</option>`).join('')}
        </select>
      `;
      
      return `
        <div class="border border-slate-200 rounded-lg p-3">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="font-semibold text-slate-800">${user.auth_username}</p>
              <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
              <p class="text-xs text-slate-500">æœ€åç™»å½•: ${lastLoginDate}</p>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="text-xs text-slate-600">æƒé™ç»„:</span>
              ${groupSelect}
            </div>
          </div>
        </div>
      `;
    }).join('');
  } catch (e) {
    $('admin-users-list').innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
  }
}

async function updateUserGroup(username, newGroup) {
  try {
    const response = await fetch('/auth/admin/update_user_group', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-ID': sessionUUID
      },
      body: JSON.stringify({
        target_username: username,
        new_group: newGroup
      })
    });
    
    const result = await response.json();
    if (result.success) {
      logMessage(`ç”¨æˆ· ${username} çš„æƒé™ç»„å·²æ›´æ–°ä¸º ${newGroup}`);
    } else {
      alert('æ›´æ–°å¤±è´¥: ' + result.message);
      loadAdminUsers(); // é‡æ–°åŠ è½½ä»¥æ¢å¤åŸçŠ¶æ€
    }
  } catch (e) {
    alert('æ›´æ–°å¤±è´¥: ' + e.message);
    loadAdminUsers();
  }
}

async function loadAdminGroups() {
  try {
    const response = await fetch('/auth/admin/list_groups', {
      headers: {
        'X-Session-ID': sessionUUID
      }
    });
    const result = await response.json();
    
    if (!result.success) {
      $('admin-groups-list').innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
      return;
    }
    
    const listEl = $('admin-groups-list');
    const groups = result.groups;
    
    listEl.innerHTML = Object.keys(groups).map(groupKey => {
      const group = groups[groupKey];
      const perms = group.permissions;
      
      return `
        <div class="border border-slate-200 rounded-lg p-4">
          <h5 class="font-semibold text-slate-800 mb-2">${group.name} (${groupKey})</h5>
          <div class="grid grid-cols-2 gap-2 text-sm">
            ${Object.keys(perms).map(perm => `
              <div class="flex items-center gap-2">
                <span class="${perms[perm] ? 'text-green-600' : 'text-slate-400'}">${perms[perm] ? 'âœ“' : 'âœ—'}</span>
                <span class="text-slate-600">${perm}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }).join('');
  } catch (e) {
    $('admin-groups-list').innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
  }
}

// --- åˆå§‹åŒ– ---
async function initializeApp() {
  // æ£€æµ‹Webæ¨¡å¼å¹¶æå–UUID
  if (isWebMode) {
    const urlPath = window.location.pathname;
    const match = urlPath.match(/\/uuid=([a-zA-Z0-9]+)/);
    if (match) {
      sessionUUID = match[1];
      console.log('Webæ¨¡å¼: ä¼šè¯UUID =', sessionUUID);
    }
    
    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    const isAuthenticated = await checkAuthStatus();
    if (!isAuthenticated) {
      showAuthLogin();
      return; // åœæ­¢åˆå§‹åŒ–ï¼Œç­‰å¾…è®¤è¯
    }
  }

  // æ—¢ç„¶èƒ½æˆåŠŸåˆå§‹åŒ–ï¼Œå°±éšè—CDNé”™è¯¯æç¤ºï¼ˆå¦‚æœæ˜¯è¯¯æŠ¥ï¼‰
  const cdnErrorOverlay = document.getElementById('cdn-error-overlay');
  if (cdnErrorOverlay) cdnErrorOverlay.style.display = 'none';

  const initialData = await callPythonAPI('get_initial_data');
  const userCombo = $('user-combo');
  userCombo.innerHTML = '<option value="">(æ–°ç”¨æˆ·)</option>';
  initialData.users.forEach(user => {
    const option = document.createElement('option');
    option.value = option.textContent = user;
    userCombo.appendChild(option);
  });

  createParamInputs($('params-container'), 'param', onParamChange);
  if (initialData.lastUser) userCombo.value = initialData.lastUser;
  await onUserChange();
  
  // ä¿®å¤Issue 5: æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•ï¼ˆä¼šè¯æŒä¹…åŒ–ï¼‰
  if (initialData.isLoggedIn && initialData.userInfo) {
    // ç”¨æˆ·å·²ç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºä¸»ç•Œé¢
    currentUserData = initialData.userInfo;
    
    // Issue 4ä¿®å¤ï¼šæ¢å¤ä¼šè¯æ—¶ç¡®ä¿API Keyå·²é…ç½®å¹¶åŠ è½½åœ°å›¾
    AMAP_API_KEY = initialData.amap_key || "";
    if (AMAP_API_KEY) {
      try {
        await loadAMapOnce();
      } catch (e) {
        console.error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆä¼šè¯æ¢å¤ï¼‰', e);
      }
    }
    
    showMainApp();
    const name = currentUserData.name || '';
    $('user-name-label').textContent = `å§“å: ${name}`;
    $('user-id-label').textContent = `å­¦å·: ${currentUserData.student_id}`;
    updateDashboard();
    await refreshTasks();
    await fetchNotifications();
    const base = pythonParams.theme_base_color || '#7dd3fc'; 
    setBaseColor(base, base);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†æƒé™ï¼Œæ˜¾ç¤ºç®¡ç†æŒ‰é’®
    if (initialData.auth_group === 'admin' || initialData.auth_group === 'super_admin') {
      const adminBtn = $('show-admin-panel');
      if (adminBtn) adminBtn.classList.remove('hidden');
    }
  } else {
    // æœªç™»å½•ï¼Œæ£€æŸ¥API Key
    AMAP_API_KEY = initialData.amap_key || "";
    if (!AMAP_API_KEY) {
      logMessage("[è­¦å‘Š] æœªé…ç½®é«˜å¾·åœ°å›¾API Keyï¼Œè¯·åœ¨å¼¹çª—ä¸­è¾“å…¥ã€‚");
      $('amap-key-modal').classList.remove('hidden');
      $('amap-key-modal').classList.add('flex');
    } else {
      try {
        await loadAMapOnce();
      } catch (e) {
        console.error('AMap SDK åŠ è½½å¤±è´¥ï¼ˆready é˜¶æ®µï¼‰', e);
      }
    }
  }

  if (pythonParams.theme_style) {
    setThemeStyle(pythonParams.theme_style);
  }

  // ç«‹åˆ»åˆ·æ–°ä¸€æ¬¡ç”¨æˆ·åˆ—è¡¨ï¼ˆè°ƒç”¨çš„æ˜¯æ–° refreshUserListï¼‰
  await refreshUserList();

  const loadingOverlay = $('loading-overlay');
  loadingOverlay.style.opacity = '0';
  setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
  bindImmediateRefreshForUserSelects();
  
  // --- ç»‘å®šç­¾åˆ°Tabå†…çš„å‚æ•°æ§ä»¶ ---
  const attEnabled = $('param-auto_attendance_enabled');
  const attRefresh = $('param-auto_attendance_refresh_s');
  const attRadius = $('param-attendance_user_radius_m');
  if (attEnabled) attEnabled.addEventListener('change', onParamChange);
  if (attRefresh) attRefresh.addEventListener('change', onParamChange);
  if (attRadius) attRadius.addEventListener('change', onParamChange);

  // ç»‘å®šAPI Keyæ¨¡æ€æ¡†çš„ç¡®è®¤æŒ‰é’®äº‹ä»¶
  $('confirm-amap-key-btn').addEventListener('click', onConfirmAmapKey);

  // å°†å®šæ—¶åˆ·æ–°ç§»åŠ¨åˆ° API å°±ç»ªåå†å¯åŠ¨
  setInterval(refreshUserList, 5000);
  
  // æ ‡è®° API å·²å°±ç»ª
  pywebviewApiReady = true;
}

// ç›‘å¬pywebviewå°±ç»ªäº‹ä»¶ï¼ˆæ¡Œé¢æ¨¡å¼ï¼‰
window.addEventListener('pywebviewready', initializeApp);

// å¦‚æœæ˜¯Webæ¨¡å¼ï¼Œåœ¨DOMContentLoadedæ—¶åˆå§‹åŒ–
if (isWebMode) {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    // DOMå·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–
    initializeApp();
  }
}

function enhanceMapInteraction(mapInstance) {
    if (!mapInstance) return () => {}; // é˜²å¾¡ï¼šå¦‚æœå®ä¾‹æ— æ•ˆï¼Œè¿”å›ç©ºæ¸…ç†å‡½æ•°
    const container = mapInstance.getContainer();
    if (!container) return () => {}; // é˜²å¾¡ï¼šå¦‚æœå®¹å™¨æ— æ•ˆ

    const handlers = [];

    const addManagedListener = (element, type, listener, options) => {
        element.addEventListener(type, listener, options);
        handlers.push({ element, type, listener, options });
    };

    const wheelHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!mapInstance) return; // é˜²å¾¡æ£€æŸ¥
        if (e.deltaY < 0) mapInstance.zoomIn();
        else mapInstance.zoomOut();
    };
    addManagedListener(container, 'wheel', wheelHandler, { passive: false });

    const contextMenuHandler = (e) => e.preventDefault();
    addManagedListener(container, 'contextmenu', contextMenuHandler);

    const DRAG_SAME_DIRECTION = true;
    let rmbLongPressTimer = null, mmbLongPressTimer = null, rmbDragging = false, mmbDragging = false, lastClientX = 0, lastClientY = 0;
    
    function doPanBy(mouseX, mouseY) {
        if (!mapInstance) return; // é˜²å¾¡æ£€æŸ¥
        const dx = mouseX - lastClientX; const dy = mouseY - lastClientY;
        if (dx !== 0 || dy !== 0) {
            const panDx = DRAG_SAME_DIRECTION ? dx : -dx; const panDy = DRAG_SAME_DIRECTION ? dy : -dy;
            mapInstance.panBy(panDx, panDy); lastClientX = mouseX; lastClientY = mouseY;
        }
    }

    const mouseDownHandler = (e) => {
        if (e.button === 0) return; lastClientX = e.clientX; lastClientY = e.clientY;
        if (e.button === 1) { e.preventDefault(); e.stopPropagation(); mmbLongPressTimer = setTimeout(() => { mmbDragging = true; }, 0); }
        if (e.button === 2) { e.preventDefault(); e.stopPropagation(); rmbLongPressTimer = setTimeout(() => { rmbDragging = true; }, 0); }
    };
    addManagedListener(container, 'mousedown', mouseDownHandler);

    const mouseMoveHandler = (e) => { if (rmbDragging || mmbDragging) { e.preventDefault(); e.stopPropagation(); doPanBy(e.clientX, e.clientY); } };
    addManagedListener(container, 'mousemove', mouseMoveHandler);

    function endDrag(button) {
        if (button === 2) { clearTimeout(rmbLongPressTimer); rmbLongPressTimer = null; rmbDragging = false; }
        if (button === 1) { clearTimeout(mmbLongPressTimer); mmbLongPressTimer = null; mmbDragging = false; }
    }

    const mouseUpHandler = (e) => {
        endDrag(e.button);
        // æ ¸å¿ƒä¿®å¤ï¼šåœ¨ä»»ä½•é¼ æ ‡æŒ‰é”®ï¼ˆç‰¹åˆ«æ˜¯ä¸­/å³é”®ï¼‰æŠ¬èµ·åï¼Œ
        // å¦‚æœä»å¤„äºç»˜åˆ¶æ¨¡å¼ï¼Œåˆ™å¼ºåˆ¶é‡ç”³åœ°å›¾ä¸å¯æ‹–æ‹½çš„çŠ¶æ€ï¼Œ
        // é˜²æ­¢æ‹–æ‹½çŠ¶æ€è¢«æ„å¤–é‡ç½®ï¼Œä»è€Œä¿®å¤å·¦é”®æ—¢èƒ½ç”»å›¾åˆèƒ½æ‹–åŠ¨åœ°å›¾çš„BUGã€‚
        if (isDrawing && map) {
            map.setStatus({ dragEnable: false });
        }
    };
    addManagedListener(container, 'mouseup', mouseUpHandler);

    const mouseLeaveHandler = () => { endDrag(1); endDrag(2); };
    addManagedListener(container, 'mouseleave', mouseLeaveHandler);
    
    const windowMouseUpHandler = () => { leftMouseDown = false; isPathDrawing = false; endDrag(1); endDrag(2); };
    addManagedListener(window, 'mouseup', windowMouseUpHandler, true);

    // è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°
    return () => {
        handlers.forEach(({ element, type, listener, options }) => {
            element.removeEventListener(type, listener, options);
        });
    };
}

// ç»Ÿä¸€ä¸€æ¬¡æ€§åŠ è½½ AMap SDK
function loadAMapOnce() {
  if (AMapReady && AMapInstance) return Promise.resolve(AMapInstance);
  if (amapLoadingPromise) return amapLoadingPromise;

  // ä¼˜å…ˆå¤ç”¨ window.AMapï¼ˆå¤šè´¦å·é‡Œå·²è½½å…¥è¿‡ï¼‰
  if (window.AMap && window.AMap.ControlBar) { // æ£€æŸ¥ä¸€ä¸ªæ’ä»¶æ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­æ˜¯å¦å®Œæ•´åŠ è½½
    AMapInstance = window.AMap;
    AMapReady = true;
    amapLoadingPromise = Promise.resolve(AMapInstance);
    return amapLoadingPromise;
  }

  // æ–°å¢ï¼šåŠ è½½å‰æ£€æŸ¥Keyæ˜¯å¦å­˜åœ¨
  if (!AMAP_API_KEY) {
      logMessage("[é”™è¯¯] å°è¯•åŠ è½½åœ°å›¾å¤±è´¥ï¼šAPI Keyä¸ºç©ºã€‚");
      // å†æ¬¡å¼¹å‡ºæç¤ºæ¡†
      $('amap-key-modal').classList.remove('hidden');
      $('amap-key-modal').classList.add('flex');
      // è¿”å›ä¸€ä¸ªè¢«æ‹’ç»çš„Promiseï¼Œä¸­æ–­åŠ è½½é“¾
      return Promise.reject("API Key is missing.");
  }
  
  // é¦–æ¬¡åŠ è½½ SDKï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå¹¶å¸¦ä¸Šæ‰€æœ‰éœ€è¦çš„æ’ä»¶
  amapLoadingPromise = AMapLoader.load({
    key: AMAP_API_KEY, // ä¿®æ”¹ï¼šä½¿ç”¨å…¨å±€å˜é‡
    version: "2.0",
    plugins: ['AMap.ControlBar', 'AMap.BuildingLayer', 'AMap.Walking'] // åœ¨è¿™é‡Œä¸€æ¬¡æ€§å£°æ˜æ‰€æœ‰æ’ä»¶
  })
    .then((AMap) => {
      AMapInstance = AMap;
      AMapReady = true;
      logMessage("é«˜å¾·åœ°å›¾SDKåŠæ‰€æœ‰æ’ä»¶åŠ è½½æˆåŠŸã€‚");
      return AMapInstance;
    })
    .catch((err) => {
      console.error("AMap åŠ è½½å¤±è´¥", err);
      logMessage("[JS-Error] é«˜å¾·åœ°å›¾SDKåŠ è½½å¤±è´¥ï¼åœ°å›¾åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚");
      AMapReady = false;
      AMapInstance = null;
      amapLoadingPromise = null;
      throw err;
    });

  return amapLoadingPromise;
}

// ç¡®ä¿â€œå•è´¦å·åœ°å›¾â€åœ¨å®¹å™¨æ˜¾ç¤ºååˆ›å»ºï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
function ensureSingleMap() {
  if (map || !AMapReady || !AMapInstance) return;
  const container = document.getElementById('map-container');
  if (!container) return;
  const isHidden = container.offsetParent === null;
  if (isHidden) return; // å®¹å™¨æœªæ˜¾ç¤ºæ—¶ä¸åˆ›å»º
  initMap(AMapInstance);
}

// æ–°å¢ï¼šå¼ºåˆ¶æŠ•å½±åˆ·æ–°
function forceProjectionRefresh() {
  if (!map) return;
  try {
    // ä¸´æ—¶å…³é—­æ‹–æ‹½ï¼Œè§¦å‘äº¤äº’å±‚çŠ¶æ€é‡å»º
    map.setStatus({ dragEnable: false });

    // åˆ·æ–°å°ºå¯¸
    map.resize();

    // ä¸‹ä¸€å¸§ç»Ÿä¸€æ‹Ÿåˆè¦†ç›–ç‰©æˆ–æ‰“å¡ç‚¹
    requestAnimationFrame(() => {
      const overlays = [...polylines.recommended];
      if (polylines.draft) overlays.push(polylines.draft);
      if (polylines.run) overlays.push(polylines.run);
      if (polylines.history) overlays.push(polylines.history);

      if (overlays.length > 0) {
        map.setFitView(overlays, false, [60, 60, 60, 60]);
      } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
        const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        map.setFitView(pts, false, [60, 60, 60, 60]);
      } else {
        map.setZoomAndCenter(17, [113.390342, 22.527403]);
      }

      // æ¢å¤æ‹–æ‹½
      map.setStatus({ dragEnable: true });
    });
  } catch (e) {
    console.warn('forceProjectionRefresh warning:', e);
  }
}


function ensureSingleControls() {
  const container = document.getElementById('map-container');
  if (!container) return;

  // æ£€æŸ¥æ§ä»¶DOMæ˜¯å¦ä»åœ¨ï¼ˆè¢« AMap destroy æ¸…ç©ºæ—¶éœ€è¦é‡å»ºï¼‰
  const hasZoomIn = !!document.getElementById('zoom-in');
  const hasZoomOut = !!document.getElementById('zoom-out');
  const hasReset = !!document.getElementById('reset-view-btn');

  if (hasZoomIn && hasZoomOut && hasReset) {
    // æ§ä»¶è¿˜åœ¨ï¼Œåªéœ€è¦ç¡®ä¿äº‹ä»¶ç»‘å®š
    attachSingleControlHandlers();
    return;
  }

  // é‡å»ºæ§ä»¶ç›’ï¼ˆä¸åŸHTMLä¸€è‡´ï¼‰
  const overlay = document.createElement('div');
  overlay.className = 'absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200';
  overlay.innerHTML = `
    <button id="zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
  `;
  container.appendChild(overlay);

  attachSingleControlHandlers();
}

function attachSingleControlHandlers() {
  const zi = document.getElementById('zoom-in');
  const zo = document.getElementById('zoom-out');
  const rv = document.getElementById('reset-view-btn');

  // é˜²é‡å¤ç»‘å®šï¼šæ ‡è®°å·²ç»‘å®š
  if (zi && !zi._bound) {
    zi.addEventListener('click', () => { if (map) map.zoomIn(); });
    zi._bound = true;
  }
  if (zo && !zo._bound) {
    zo.addEventListener('click', () => { if (map) map.zoomOut(); });
    zo._bound = true;
  }
  if (rv && !rv._bound) {
    rv.addEventListener('click', resetMapView);
    rv._bound = true;
  }
}

function ensureMultiControls() {
  const container = document.getElementById('multi-map-container');
  if (!container) return;

  const hasZoomIn = !!document.getElementById('multi-zoom-in');
  const hasZoomOut = !!document.getElementById('multi-zoom-out');
  const hasReset = !!document.getElementById('multi-reset-view-btn');

  if (hasZoomIn && hasZoomOut && hasReset) {
    attachMultiControlHandlers();
    return;
  }

  const overlay = document.createElement('div');
  overlay.className = 'absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200';
  overlay.innerHTML = `
    <button id="multi-zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="multi-zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="multi-zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="multi-reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
  `;
  container.appendChild(overlay);

  attachMultiControlHandlers();
}

function attachMultiControlHandlers() {
  const zi = document.getElementById('multi-zoom-in');
  const zo = document.getElementById('multi-zoom-out');
  const rv = document.getElementById('multi-reset-view-btn');

  if (zi && !zi._bound) {
    zi.addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomIn(); });
    zi._bound = true;
  }
  if (zo && !zo._bound) {
    zo.addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomOut(); });
    zo._bound = true;
  }
  if (rv && !rv._bound) {
    rv.addEventListener('click', multi_resetMapView);
    rv._bound = true;
  }
}



// åˆå§‹åŒ–é«˜å¾·åœ°å›¾
function initMap(AMap) {
  if (map) return;
  AMapInstance = AMap;
  map = new AMapInstance.Map('map-container', {
    viewMode: '3D', pitch: 55, rotation: 0, zoom: 17,
    center: [113.390342, 22.527403]
  });

  const ctrlBar = new AMapInstance.ControlBar({
    position: { left: '12px', top: '12px' }, showZoomBar: false, showControlButton: true
  });
  map.addControl(ctrlBar);

  try { const buildings = new AMapInstance.BuildingLayer(); buildings.setMap(map); } catch (e) { console.warn('BuildingLayer not available:', e); }

  map.on('mousedown', onMapMouseDown);
  map.on('mousemove', onMapMouseMove);
  map.on('mouseup', onMapMouseUp);
  map.on('zoomchange', () => {
    if (!map) return;
    const z = map.getZoom();
    const zoomLevelEl = $('zoom-level');
    if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
  });

  if (window.mapCleanup) window.mapCleanup();
  window.mapCleanup = enhanceMapInteraction(map);
  map.setStatus({ doubleClickZoom: true, dragEnable: true, scrollWheel: true, keyboardEnable: true });

  // æ¢å¤ç®€æ´çš„completeäº‹ä»¶ï¼Œä»…ç”¨äºæ—¥å¿—æˆ–æœªæ¥æ‰©å±•
  map.on('complete', () => {
    logMessage("åœ°å›¾å®ä¾‹å·²åŠ è½½ã€‚");
    // å½“åœ°å›¾åŠ è½½å®Œæˆåï¼Œå…‘ç°Promiseï¼Œé€šçŸ¥ç­‰å¾…æ–¹
    if (resolveMapReady) {
      resolveMapReady(map);
    }
  });
}


// --- UIçŠ¶æ€åˆ‡æ¢ ---
function showMainApp() {
  // åœ¨æ˜¾ç¤ºä¸»åº”ç”¨æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Promiseç”¨äºç­‰å¾…åœ°å›¾åŠ è½½
  mapReadyPromise = new Promise(resolve => {
    resolveMapReady = resolve;
  });
  $('login-container').classList.add('hidden');
  $('main-app').classList.remove('hidden');
  $('main-app').classList.add('grid');

  if (window?.pywebview?.api?.enter_single_account_mode) {
    callPythonAPI('enter_single_account_mode');
  } else {
    logMessage("å·²è¿›å…¥å•è´¦å·æ¨¡å¼ã€‚");
  }

  // 1. ç¡®ä¿æ—§å®ä¾‹è¢«é”€æ¯
  destroySingleMap();

  // 2. ç»ˆæä¿®å¤ï¼šä¸ç«‹å³åˆ›å»ºåœ°å›¾ï¼Œè€Œæ˜¯å»¶è¿Ÿåˆ›å»º
  // è¿™ä¸ªå»¶è¿Ÿç»™äºˆæµè§ˆå™¨è¶³å¤Ÿæ—¶é—´æ¥å®ŒæˆUIå¸ƒå±€ä» hidden åˆ° grid çš„åˆ‡æ¢å’Œæ¸²æŸ“
  logMessage("ç­‰å¾…UIæ¸²æŸ“ç¨³å®š...");
  setTimeout(() => {
    logMessage("UIç¨³å®šï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...");
    loadAMapOnce().then(() => {
      initMap(AMapInstance); // åœ¨è¿™é‡Œæ‰çœŸæ­£åˆ›å»ºåœ°å›¾å®ä¾‹
      ensureSingleControls();

      // ç”±äºåœ°å›¾åˆ›å»ºæ—¶å®¹å™¨å°ºå¯¸å·²æ­£ç¡®ï¼Œåç»­çš„ä»»åŠ¡åŠ è½½å’Œç»˜åˆ¶æµç¨‹å°†è‡ªç„¶æ­£ç¡®
      // selectTask() ä¼šåœ¨ refreshTasks() ä¸­è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ map å®ä¾‹å·²å­˜åœ¨
    }).catch((e) => console.error('AMap åŠ è½½å¤±è´¥ï¼ˆå»¶è¿Ÿåˆ›å»ºé˜¶æ®µï¼‰', e));
  }, 100); // 100æ¯«ç§’çš„å»¶è¿Ÿå¯¹äºç°ä»£æµè§ˆå™¨å·²ç»°ç»°æœ‰ä½™
}

function resetUI() {
  $('main-app').classList.add('hidden'); $('main-app').classList.remove('grid'); $('login-container').classList.remove('hidden');
  $('user-name-label').textContent = 'å§“å: NULL'; $('user-id-label').textContent = 'å­¦å·: NULL';
  const logoutBtn = $('logout-button'); logoutBtn.classList.remove('!text-amber-500'); logoutBtn.classList.add('!text-red-600');
  currentTasks = []; selectedTaskIndex = -1; currentUserData = {}; currentRunData = {};
  $('task-list').innerHTML = ''; $('history-list').innerHTML = ''; $('target-points-text').innerHTML = '';

  // ç¦»çº¿æ ‡å¿—å¤ä½ï¼ŒUA æ ‡ç­¾ä¸éšæœºæŒ‰é’®æ¢å¤
  IS_OFFLINE = false;
  const uaLabel = $('ua-label'); if (uaLabel) uaLabel.textContent = ' (æœªåŠ è½½) ';
  const uaBtn = $('random-ua-btn'); if (uaBtn) uaBtn.disabled = false;

  
  // å…ˆç§»é™¤å½•åˆ¶æ ·å¼ä¸äº¤äº’ç¦ç”¨ï¼ˆå³ä½¿åœ°å›¾å·²é”€æ¯ä¹Ÿæ¸…ç†DOMï¼‰
  try {
    const container = document.getElementById('map-container');
    if (container) container.classList.remove('drawing');
  } catch (_) {}
  isDrawing = false;
  isPathDrawing = false;
  leftMouseDown = false;
  pendingUnlockMap = false;
  // æ¸…ç©ºç»˜åˆ¶ä¸´æ—¶é˜Ÿåˆ—ä¸èŠ‚æµ
  draftPath = [];
  draftPathLngLat = [];
  pendingPoints = [];
  isUpdating = false;
  lastMouseMoveTime = 0;
  // æ¨¡æ€å…¨å±€æ ‡è®°æ¸…ç†
  try { document.body.classList.remove('modal-visible'); } catch (_) {}

  onRunStopped(); 
  updateDashboard();
  
  destroySingleMap();
}




function clearMapOverlays() {
  if(!map) return;
  polylines.recommended.forEach(p=>map.remove(p)); polylines.recommended = [];
  if(polylines.draft) map.remove(polylines.draft);
  if(polylines.run) map.remove(polylines.run);
  if(polylines.history) map.remove(polylines.history);
  polylines.draft = polylines.run = polylines.history = null;
  map.remove(markers); markers = [];
  if(runnerMarker){ map.remove(runnerMarker); runnerMarker = null; }
  if(drawingInfoMarker){ map.remove(drawingInfoMarker); drawingInfoMarker = null; }
}

// æ˜¾å¼é”€æ¯å•è´¦å·åœ°å›¾å®ä¾‹ï¼Œé‡Šæ”¾èµ„æºå¹¶å¤ä½å˜é‡
function destroySingleMap() {
  try {
    if (map && typeof map.destroy === 'function') {
      map.destroy();
    }
  } catch (e) {
    console.warn('destroySingleMap warning:', e);
  } finally {
    map = null;
    // è¦†ç›–ç‰©ä¸çŠ¶æ€å˜é‡å¤ä½ï¼ˆä¿é™©ï¼‰
    polylines.recommended = [];
    polylines.draft = null;
    polylines.run = null;
    polylines.history = null;
    markers = [];
    runnerMarker = null;
    drawingInfoMarker = null;

    // å½•åˆ¶æ¨¡å¼ & äº¤äº’åŒä¿é™©å¤ä½
    try {
      const container = document.getElementById('map-container');
      if (container) container.classList.remove('drawing');
    } catch (_) {}
    isDrawing = false;
    isPathDrawing = false;
    leftMouseDown = false;
    pendingUnlockMap = false;
    // ç»˜åˆ¶é˜Ÿåˆ—ä¸èŠ‚æµçŠ¶æ€æ¸…ç†
    draftPath = [];
    draftPathLngLat = [];
    pendingPoints = [];
    isUpdating = false;
    lastMouseMoveTime = 0;

    // æ¨¡æ€æ®‹ç•™ä¿é™©æ¸…ç†ï¼ˆé˜²äº¤äº’ç¦ç”¨ï¼‰
    try { document.body.classList.remove('modal-visible'); } catch (_) {}
  }
}

// --- äº‹ä»¶ç›‘å¬ç»‘å®š ---
$('user-combo').addEventListener('change', onUserChange);
$('username-entry').addEventListener('input', async (e) => {
  const username = e.target.value.trim();
  $('password-entry').value = "";
  const userCombo = $('user-combo');
  const exists = [...userCombo.options].some(o => o.value === username);
  userCombo.value = exists ? username : "";
  if (!username) { 
    $('ua-label').textContent = '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)'; 
    return; 
  }
  const data = await callPythonAPI('on_user_selected', username);
  if (data && data.password) $('password-entry').value = data.password;
  // ä¿®å¤Issue 1: ç¡®ä¿UAæ ‡ç­¾æ­£ç¡®æ›´æ–°
  if (data && data.ua) {
    $('ua-label').textContent = data.ua;
  } else {
    $('ua-label').textContent = '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
  }
  pythonParams = (data && data.params) ? data.params : pythonParams;
  updateParamInputs($('params-container'), 'param', pythonParams);
  const base = pythonParams.theme_base_color || '#7dd3fc'; setBaseColor(base, base);
});
$('random-ua-btn').addEventListener('click', async () => $('ua-label').textContent = await callPythonAPI('generate_new_ua'));
$('login-button').addEventListener('click', onLogin);
$('logout-button').addEventListener('click', onLogout);
$('refresh-button').addEventListener('click', refreshTasks);
$('record-button').addEventListener('click', toggleRecordMode);
$('clear-button').addEventListener('click', () => clearCurrentPath(true));
$('process-button').addEventListener('click', processCurrentPath);
$('start-run-button').addEventListener('click', toggleRun);
$('start-all-button').addEventListener('click', toggleAllRuns);
$('export-button').addEventListener('click', exportTask);
$('import-button').addEventListener('click', importTask);
// $('zoom-in').addEventListener('click', () => { if (map) map.zoomIn(); });
// $('zoom-out').addEventListener('click', () => { if (map) map.zoomOut(); });
// $('reset-view-btn').addEventListener('click', resetMapView);
$('show-user-details').addEventListener('click', (e) => {
  e.stopPropagation(); // ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¨¡æ€æ¡†èƒŒæ™¯
  showUserDetails();
});
$('show-task-details').addEventListener('click', (e) => {
  e.stopPropagation(); // ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¨¡æ€æ¡†èƒŒæ™¯
  showTaskDetails();
});
$('auto-gen-button').addEventListener('click', () => $('auto-gen-modal').classList.remove('hidden'));
$('cancel-gen-button').addEventListener('click', () => $('auto-gen-modal').classList.add('hidden'));
$('confirm-gen-button').addEventListener('click', onConfirmAutoGenerate);

// --- ç»‘å®šé€šçŸ¥æŒ‰é’® ---
$('show-notifications-btn').addEventListener('click', (e) => {
  e.stopPropagation(); // ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¨¡æ€æ¡†èƒŒæ™¯
  showNotifications();
});

$('mark-all-read-btn').addEventListener('click', markAllAsRead);
$('refresh-notifications-btn').addEventListener('click', refreshNotificationsUI);

$('multi-download-template-btn').addEventListener('click', multi_downloadTemplate);


// --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å‡½æ•° (JSç«¯) ---


// å¤„ç†API Keyç¡®è®¤äº‹ä»¶
async function onConfirmAmapKey() {
    const input = $('amap-key-input');
    const newKey = input.value.trim();
    if (!newKey) {
        showModalAlert('API Key ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    const result = await callPythonAPI('save_amap_key', newKey);
    if (result.success) {
        AMAP_API_KEY = newKey;
        const modal = $('amap-key-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        logMessage("API Keyå·²æ›´æ–°ï¼Œæ­£åœ¨å°è¯•é‡æ–°åŠ è½½åœ°å›¾...");
        
        // å…³é”®ï¼šä¿å­˜æˆåŠŸåï¼Œé‡æ–°è§¦å‘åœ°å›¾åŠ è½½
        try {
            await loadAMapOnce();
            // å¦‚æœåœ°å›¾åŠ è½½æˆåŠŸï¼Œå¯èƒ½éœ€è¦åˆå§‹åŒ–ä¸€äº›ä¾èµ–åœ°å›¾çš„UI
            // ä¾‹å¦‚ï¼Œå¦‚æœå·²ç»è¿›å…¥äº†ä¸»ç•Œé¢ï¼Œåˆ™éœ€è¦ç¡®ä¿åœ°å›¾è¢«åˆ›å»º
            ensureSingleMap();
            // ... å…¶ä»–å¯èƒ½éœ€è¦åœ°å›¾çš„åˆå§‹åŒ–é€»è¾‘ ...
        } catch (e) {
            console.error('ä¿å­˜KeyååŠ è½½AMap SDKå¤±è´¥', e);
            logMessage("[é”™è¯¯] æ–°çš„API Keyä¼¼ä¹æ— æ•ˆï¼Œåœ°å›¾åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥åé‡è¯•ã€‚");
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå¯ä»¥å†æ¬¡å¼¹å‡ºçª—å£
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

    } else {
        showModalAlert(`ä¿å­˜å¤±è´¥: ${result.message}`);
    }
}

function bindImmediateRefreshForUserSelects() {
  const loginSelect = $('user-combo');
  const multiSelect = $('multi-config-user-select');

  if (loginSelect && !loginSelect._refreshBound) {
    loginSelect.addEventListener('focus', refreshUserList);
    loginSelect.addEventListener('click', refreshUserList);
    loginSelect._refreshBound = true;
  }

  if (multiSelect && !multiSelect._refreshBound) {
    multiSelect.addEventListener('focus', refreshUserList);
    multiSelect.addEventListener('click', refreshUserList);
    multiSelect._refreshBound = true;
  }
}

// --- ä¸“é—¨ç”¨äºåç«¯å¼ºåˆ¶åˆ·æ–°UIçš„å‡½æ•° ---

async function multi_downloadTemplate() {
  const result = await callPythonAPI('multi_download_import_template');
  if (!result || !result.success) {
    showModalAlert(result?.message || 'æ¨¡æ¿ä¸‹è½½å¤±è´¥');
  }
}



async function forceRefreshTaskUI(index) {
    logMessage(`[Backend] æ­£åœ¨å¼ºåˆ¶åˆ·æ–°ä»»åŠ¡ #${index} çš„ç•Œé¢...`);

    // 1. ä»Pythonè·å–æœ€æ–°çš„ä»»åŠ¡è¯¦æƒ…
    const result = await callPythonAPI('get_task_details', index);
    if (!result.success) {
        logMessage(`å¼ºåˆ¶åˆ·æ–°å¤±è´¥: ${result.message}`);
        return;
    }

    // 2. æ›´æ–°JSä¸­çš„æ ¸å¿ƒæ•°æ®
    // æ›´æ–°å½“å‰é€‰ä¸­çš„ä»»åŠ¡æ•°æ®ï¼Œç”¨äºåœ°å›¾å’Œä»ªè¡¨ç›˜
    currentRunData = result.details;
    // æ›´æ–°ä»»åŠ¡æ€»åˆ—è¡¨ä¸­çš„å¯¹åº”é¡¹ï¼Œç¡®ä¿â€œè·¯å¾„çŠ¶æ€â€å¾½ç« ä¹Ÿèƒ½åˆ·æ–°
    if (currentTasks && currentTasks[index]) {
        Object.assign(currentTasks[index], result.details);
    }

    // 3. å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç›¸å…³çš„UIç»„ä»¶
    selectedTaskIndex = index; // ç¡®ä¿å½“å‰é€‰ä¸­ç´¢å¼•æ­£ç¡®
    renderTaskList();      // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ï¼ˆæ›´æ–°çŠ¶æ€å¾½ç« å’Œé«˜äº®ï¼‰
    updateDashboard();     // æ›´æ–°ä»ªè¡¨ç›˜ï¼ˆè·¯ç¨‹ã€æ—¶é—´ï¼‰
    drawOnMap();           // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶æ–°çš„çº¢è‰²æŠ˜çº¿
}


// ç”¨ get_initial_data å…¼å®¹åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
async function refreshUserList() {
  try {
    // API æœªå°±ç»ªæ—¶ç›´æ¥è¿”å›ï¼Œé¿å… TypeError
    if (!pywebviewApiReady || !window.pywebview?.api?.get_initial_data) return;

    const initialData = await callPythonAPI('get_initial_data');
    // å…¼å®¹ç»“æ„ { users: [...], lastUser: '...' }
    const users = Array.isArray(initialData?.users) ? initialData.users : [];

    const select = document.getElementById("user-combo");                // ç™»å½•é¡µé€‰æ‹©æ¡†
    const multiSelect = document.getElementById("multi-config-user-select"); // å¤šè´¦å·æ¨¡å¼é€‰æ‹©æ¡†

    function updateSelect(selectElem, users) {
      if (!selectElem) return;
      // è®°å½•å½“å‰é€‰æ‹©ä¸æ»šåŠ¨ä½ç½®
      const previousValue = selectElem.value;
      const previousScrollTop = selectElem.scrollTop;

      // æ¸…ç©ºåé‡å»º
      selectElem.innerHTML = '';

      // ç»Ÿä¸€é¦–é¡¹ï¼šæ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)';
      selectElem.appendChild(opt);

      users.forEach(u => {
        const o = document.createElement('option');
        o.value = u;
        o.textContent = u;
        o.title = u; // é•¿æ–‡æœ¬ tooltip
        selectElem.appendChild(o);
      });

      // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
      if (users.includes(previousValue)) {
        selectElem.value = previousValue;
      } else {
        selectElem.value = '';
      }

      // æ¢å¤æ»šåŠ¨ä½ç½®
      selectElem.scrollTop = previousScrollTop;
    }

    updateSelect(select, users);
    updateSelect(multiSelect, users);
  } catch (err) {
    console.error("åˆ·æ–°ç”¨æˆ·åˆ—è¡¨å¤±è´¥", err);
  }
}

// å®šæ—¶åˆ·æ–°ï¼Œä¾‹å¦‚æ¯ 5 ç§’
setInterval(refreshUserList, 5000);


async function onUserChange() {
  const username = $('user-combo').value;
  const data = await callPythonAPI('on_user_selected', username);
  $('username-entry').value = username;
  $('password-entry').value = data.password || "";
  $('ua-label').textContent = data.ua || '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
  pythonParams = data.params || pythonParams;
  updateParamInputs($('params-container'), 'param', pythonParams);
  
  // åº”ç”¨ä¸»é¢˜é¢œè‰²
  const base = pythonParams.theme_base_color || '#7dd3fc'; 
  setBaseColor(base, base);
  
  // æ–°å¢ï¼šåº”ç”¨ä¸»é¢˜é£æ ¼
  const style = pythonParams.theme_style || 'default';
  setThemeStyle(style);
}

async function onLogin() {
  const user = $('username-entry').value.trim();
  const pass = $('password-entry').value;
  if (!user) { showModalAlert('è¯·è¾“å…¥ç”¨æˆ·å'); return; }

  // åœ¨çº¿ç™»å½•å‰ï¼Œå¤ä½ç¦»çº¿æ ‡å¿—ä¸ UA æŒ‰é’®
  IS_OFFLINE = false;
  const uaBtn = $('random-ua-btn'); if (uaBtn) uaBtn.disabled = false;

  // åœ¨ç™»å½•å‰ï¼Œä»ç™»å½•é¡µçš„UAæ ‡ç­¾æ•è·å½“å‰çš„UA
  const uaOnLoginScreen = $('ua-label')?.textContent || "";

  const result = await callPythonAPI('login', user, pass);
  if(result.success) {
    showMainApp();
    currentUserData = result.userInfo;
    currentSessionUA = uaOnLoginScreen;
    const name = currentUserData.name || '';
    $('user-name-label').textContent = `å§“å: ${name}`;
    $('user-id-label').textContent = `å­¦å·: ${currentUserData.student_id}`;

    updateDashboard();
    
    await refreshTasks();
    
    await fetchNotifications();

    const base = pythonParams.theme_base_color || '#7dd3fc'; setBaseColor(base, base);
  } else {
    showModalAlert(result.message, 'ç™»å½•å¤±è´¥');
  }
}



async function onLogout() {
  await callPythonAPI('logout');
  // ç»Ÿä¸€æç¤ºï¼šé€€å‡ºå•è´¦å·æ¨¡å¼ï¼ˆç”±åç«¯å‘å‡ºï¼‰
  if (window?.pywebview?.api?.exit_single_account_mode) {
    await callPythonAPI('exit_single_account_mode');
  }
  currentSessionUA = "";
  resetUI();
}


async function refreshTasks(){
  if (isRefreshingTasks) {
    // å¹¶å‘ä¿æŠ¤ï¼šå·²æœ‰åˆ·æ–°åœ¨è¿›è¡Œä¸­æ—¶ç›´æ¥è¿”å›
    return;
  }
  isRefreshingTasks = true;

  // ä¸´æ—¶ç¦ç”¨åˆ·æ–°æŒ‰é’®ï¼Œç”¨æˆ·ä½“éªŒæ›´æ˜ç¡®
  const btn = $('refresh-button');
  if (btn) btn.disabled = true;

  try {
    const taskResult = await callPythonAPI('load_tasks');
    if (taskResult && taskResult.success) {
      currentTasks = taskResult.tasks;
      renderTaskList();
      return;
    }

    // å°å»¶è¿Ÿé‡è¯•ä¸€æ¬¡ï¼ˆå…œåº•ï¼‰ï¼Œä½†ä»ä¿æŒé˜²æŠ–
    await new Promise(r => setTimeout(r, 300));
    const retry = await callPythonAPI('load_tasks');
    if (retry && retry.success) {
      currentTasks = retry.tasks;
      renderTaskList();

      await fetchNotifications();

    } else {
      logMessage("åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç‚¹å‡»å·¦ä¾§â€œåˆ·æ–°â€é‡è¯•ã€‚");
    }
  } finally {
    isRefreshingTasks = false;
    if (btn) btn.disabled = false;
  }
}


function renderTaskList() {
  const taskListDiv = $('task-list'); taskListDiv.innerHTML = "";
  if (currentTasks.length === 0) { taskListDiv.innerHTML = `<div class="text-slate-400 text-center py-10">æš‚æ— ä»»åŠ¡</div>`; return; }
  currentTasks.forEach((task, index) => {
    const item = document.createElement('div');
    const pathStatus = task.run_coords?.length > 0 ? 'å·²ç”Ÿæˆ' : (task.draft_coords?.length > 0 ? 'è‰ç¨¿' : 'æ— è·¯å¾„');
    let statusClass = 'text-amber-600', statusText = 'æœªå®Œæˆ', statusIcon = 'ğŸ•’';

    // å·²å®Œæˆï¼ˆå®½æ¾æ¯”è¾ƒï¼Œå…¼å®¹æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
    if (task.status == 1) { statusClass = 'text-emerald-600'; statusText = 'å·²å®Œæˆ'; statusIcon = 'âœ…'; }

    // è¿‡æœŸä¼˜å…ˆæ˜¾ç¤º
    if (task.info_text === 'å·²è¿‡æœŸ') { statusClass = 'text-red-600'; statusText = 'å·²è¿‡æœŸ'; statusIcon = 'â›”'; }

    // è‹¥åç«¯ info_text è¡¨ç¤ºâ€œå¼€å§‹äº: YYYY-MM-DDâ€ï¼Œåˆ™æŠŠå·¦ä¾§çŠ¶æ€æ˜¾ç¤ºä¸ºâ€œæœªå¼€å§‹â€
    if (! (task.status == 1) ) {
        if (typeof task.info_text === 'string' && task.info_text.startsWith('å¼€å§‹äº')) {
            statusClass = 'text-slate-600';
            statusText = 'æœªå¼€å§‹';
            statusIcon = 'â³';
        }
    }

    item.className = 'p-3 rounded-xl cursor-pointer border border-transparent transition-colors duration-200 hover:bg-white/70';
    item.innerHTML = `
      <div class="flex items-center gap-3">
        <p class="font-bold text-slate-700 text-sm truncate">${task.run_name}</p>
      </div>
      <div class="flex justify-between items-center mt-2 text-xs">
        <span class="font-semibold ${statusClass} flex items-center gap-1">${statusIcon} ${statusText}</span>
        <span class="text-slate-500">${task.info_text || ''}</span>
        <span class="badge">${pathStatus}</span>
      </div>
    `;
    item.dataset.index = index;
    if (task.status === 1) item.classList.add('opacity-60');
    if (index === selectedTaskIndex) item.classList.add('selected');
    item.addEventListener('click', () => selectTask(index));
    taskListDiv.appendChild(item);
  });
}

async function selectTask(index) {
  if (isDrawing) { logMessage("è¯·å…ˆç»“æŸå½“å‰è·¯å¾„ç»˜åˆ¶ï¼"); return; }
  if (selectedTaskIndex === index) return;
  
  const taskListDiv = $('task-list');
  if (selectedTaskIndex > -1 && taskListDiv.children[selectedTaskIndex]) { 
      taskListDiv.children[selectedTaskIndex].classList.remove('selected'); 
  }
  selectedTaskIndex = index;
  if (taskListDiv.children[selectedTaskIndex]) { 
      taskListDiv.children[selectedTaskIndex].classList.add('selected'); 
  }

  // --- BUGä¿®å¤ ---
  const selectedTask = currentTasks[index];
  // åˆ¤æ–­æ˜¯å¦ä¸ºç¦»çº¿å¯¼å…¥çš„ä»»åŠ¡
  if (selectedTask && selectedTask.info_text === "ç¦»çº¿") {
    // ç¦»çº¿æ¨¡å¼: ç›´æ¥ä½¿ç”¨å‰ç«¯å·²æœ‰çš„å®Œæ•´æ•°æ®ï¼Œä¸å†è¯·æ±‚åç«¯
    currentRunData = selectedTask;
    updateDashboard();
    drawOnMap();
    loadHistory(index); // åŠ è½½å†å²ï¼ˆç¦»çº¿æ¨¡å¼ä¸‹é€šå¸¸ä¸ºç©ºï¼‰
    singleProcessedPoints = 0;
    singleTotalPoints = (currentRunData.run_coords?.length || 0);
    updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
  } else {
    // åœ¨çº¿æ¨¡å¼: æŒ‰åŸé€»è¾‘ä»åç«¯è·å–è¯¦æƒ…
    const result = await callPythonAPI('get_task_details', index);
    if (result.success) {
      currentRunData = result.details;
      updateDashboard();
      
      drawOnMap();
      setTimeout(() => {
        if (selectedTaskIndex === index) {
          logMessage("æ‰§è¡ŒäºŒæ¬¡æ¸²æŸ“ä»¥ä¿®æ­£åˆå§‹ä½ç§»...");
          drawOnMap();
        }
      }, 100); // ç¨å¾®å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿æ¸²æŸ“ç¨³å®š

      loadHistory(index);
      singleProcessedPoints = 0;
      singleTotalPoints = (currentRunData.run_coords?.length || 0);
      updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
    } else {
      logMessage(result.message);
    }
  }
}


// --- å¤šè´¦å·æ¨¡å¼äº‹ä»¶ç›‘å¬ ---
$('multi-account-btn').addEventListener('click', switchToMultiMode);
$('exit-multi-mode-btn').addEventListener('click', exitMultiMode);
$('multi-start-all-btn').addEventListener('click', multi_startAll);
$('multi-stop-all-btn').addEventListener('click', multi_stopAll);
$('multi-load-all-from-config-btn').addEventListener('click', multi_loadAllFromConfig);
$('multi-add-from-config-btn').addEventListener('click', multi_addFromConfig);
$('multi-import-excel-btn').addEventListener('click', multi_importFromExcel);
$('multi-export-excel-btn').addEventListener('click', multi_exportToExcel);
// $('multi-zoom-in').addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomIn(); });
// $('multi-zoom-out').addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomOut(); });
// $('multi-reset-view-btn').addEventListener('click', multi_resetMapView);

// --- å¤šè´¦å·æ¨¡å¼æ ¸å¿ƒå‡½æ•° ---
async function switchToMultiMode() {
    
    $('multi-account-count').textContent = 0;

    const result = await callPythonAPI('enter_multi_account_mode');
    if(!result.success) return;
    $('login-container').classList.add('hidden');
    $('main-app').classList.add('hidden');
    $('multi-account-app').classList.remove('hidden');
    $('multi-account-app').classList.add('grid');
    document.body.classList.remove('modal-visible');


    
    // ç»Ÿä¸€åŠ è½½ä¸€æ¬¡ SDKï¼ˆè‹¥å·²åŠ è½½åˆ™ç«‹å³è¿”å›ï¼‰
    try {
    await loadAMapOnce();
    } catch (e) {
    console.error('AMap æœªå°±ç»ªï¼Œæ— æ³•è¿›å…¥å¤šè´¦å·åœ°å›¾', e);
    return;
    }


    // åˆ›å»ºå¤šè´¦å·åœ°å›¾
    if (!multiAccountMap && AMapInstance) {
    multiAccountMap = new AMapInstance.Map('multi-map-container', {
        viewMode: '3D',
        pitch: 55,
        rotation: 0,
        zoom: 17,
        center: [113.390342, 22.527403]
    });

    // å¤šè´¦å·åœ°å›¾çš„ 3D æ§åˆ¶æ† (ç›´æ¥åˆ›å»º)
    const ctrlBar = new AMapInstance.ControlBar({
        position: { left: '12px', top: '12px' },
        showZoomBar: false,
        showControlButton: true
    });
    multiAccountMap.addControl(ctrlBar);


    // å»ºç­‘ç‰©å›¾å±‚ (ç›´æ¥åˆ›å»º)
    try {
        const buildings = new AMapInstance.BuildingLayer();
        buildings.setMap(multiAccountMap);
    } catch (e) {
        console.warn('BuildingLayer not available (multi):', e);
    }

    multiAccountMap.on('zoomchange', () => {
        const z = multiAccountMap.getZoom();
        $('multi-zoom-level').textContent = String(z.toFixed(1));
    });

    multiAccountMap.on('zoomchange', () => {
        if (!multiAccountMap) return; // é˜²å¾¡æ£€æŸ¥
        const z = multiAccountMap.getZoom();
        const zoomLevelEl = $('multi-zoom-level');
        if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
    });

    // ä¿å­˜æ¸…ç†å‡½æ•°
    if (window.multiMapCleanup) window.multiMapCleanup();
    window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

    multiAccountMap.setStatus({ 
        doubleClickZoom: true, 
        dragEnable: true, 
        scrollWheel: true, 
        keyboardEnable: true 
    });

    // å…œåº•é‡å»ºå¹¶ç»‘å®šå¤šè´¦å·æ§ä»¶
    ensureMultiControls();
    }



    

    const configUsers = await callPythonAPI('multi_get_all_config_users');
    const select = $('multi-config-user-select');
    select.innerHTML = '<option value="">(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)</option>';
    configUsers.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = u;
        select.appendChild(opt);
    });
    
    // åˆå§‹åŒ–å…¨å±€å‚æ•°UI
    const container = $('multi-global-params-container');
    container.innerHTML = '';
    createParamInputs(container, 'multi-param', onGlobalParamChange);
    pythonParams = result.params;
    updateParamInputs(container, 'multi-param', pythonParams);

    await callPythonAPI('set_multi_run_only_incomplete', 
      document.getElementById('multi-run-only-incomplete-check').checked
    );

    // ç¡®ä¿å¤šè´¦å·é€‰æ‹©æ¡†ä¹Ÿæœ‰â€œç‚¹å‡»/èšç„¦å³åˆ·æ–°â€
    bindImmediateRefreshForUserSelects();

    // self.log("å·²è¿›å…¥å¤šè´¦å·æ¨¡å¼ã€‚")
    updateMultiGlobalButtons(true, true); // åˆå§‹ç¦ç”¨ï¼Œåç«¯å¾ˆå¿«ä¼šæ ¹æ®çœŸå®çŠ¶æ€åˆ·æ–°

}

async function exitMultiMode() {
    path_planning_queue = [];
    is_planning_path = false;
    await callPythonAPI('exit_multi_account_mode');
    $('multi-account-app').classList.add('hidden');
    $('multi-account-app').classList.remove('grid');
    $('login-container').classList.remove('hidden');
    document.body.classList.remove('modal-visible'); 

    $('multi-account-list').innerHTML = '<p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>';
    if (multiAccountMap) {
        // å…ˆæ‰§è¡Œæ¸…ç†
        if (window.multiMapCleanup) {
            window.multiMapCleanup();
            window.multiMapCleanup = null;
        }
        try { multiAccountMap.remove(Object.values(multiAccountMarkers)); } catch (_) {}
        try { if (typeof multiAccountMap.destroy === 'function') multiAccountMap.destroy(); } catch (e) { console.warn('destroy multiAccountMap warning:', e); }
    }
    multiAccountMarkers = {};
    multiAccountMap = null;
}


async function multi_loadAllFromConfig() {
    const result = await callPythonAPI('multi_load_accounts_from_config');
    if (result && result.accounts) renderMultiAccountList(result.accounts);
}

function openNewUserModal() {
    $('newUsername').value = "";
    $('newPassword').value = "";
    $('newUserModal').style.display = "flex"; /* å°† 'block' æ”¹ä¸º 'flex' ä»¥å¯ç”¨å±…ä¸­ */
}

function closeNewUserModal() {
    $('newUserModal').style.display = "none";
}
$('newUserClose').onclick = closeNewUserModal;
$('newUserCancel').onclick = closeNewUserModal;


async function multi_addFromConfig(){
    const user = $('multi-config-user-select').value;
    if (!user) {
        // æ‰“å¼€æ¨¡æ€æ¡†
        openNewUserModal();

        // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
        $('newUserConfirm').onclick = async () => {
            const inputUsername = $('newUsername').value.trim();
            const inputPassword = $('newPassword').value;
            if (!inputUsername) {
                showModalAlert("è´¦å·ä¸èƒ½ä¸ºç©º");
                return;
            }
            closeNewUserModal();
            const result = await callPythonAPI('multi_add_account', inputUsername, inputPassword);
            if (result && result.accounts) renderMultiAccountList(result.accounts);
        };
        return;
    }
    // å·²æœ‰é…ç½®ç”¨æˆ·
    const result = await callPythonAPI('multi_add_account', user, "");
    if (result && result.accounts) renderMultiAccountList(result.accounts);
}


async function multi_importFromExcel() {
    const result = await callPythonAPI('multi_import_accounts');
    if (result && result.accounts) renderMultiAccountList(result.accounts);
}

async function multi_exportToExcel() {
    await callPythonAPI('multi_export_accounts_summary');
}


async function multi_exportToExcel() { await callPythonAPI('multi_export_accounts_summary'); }

async function multi_startAll() {


    // è‹¥å½“å‰åˆ—è¡¨ä¸ºç©º
    const count = parseInt($('multi-account-count').textContent || '0', 10);
    if (!count || count <= 0) {
        showModalAlert('è´¦å·åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹ã€‚è¯·å…ˆæ·»åŠ è´¦å·ã€‚');

        return;
    }


    const use_delay = $('multi-use-delay-check').checked;
    const min_delay = parseInt($('multi-min-delay-input').value) || 0;
    const max_delay = parseInt($('multi-max-delay-input').value) || 300;
    const run_only_incomplete = $('multi-run-only-incomplete-check').checked;

    const result = await callPythonAPI('multi_start_all_accounts', min_delay, max_delay, use_delay, run_only_incomplete);
    // å¤±è´¥æ—¶å›æ»šæŒ‰é’®çŠ¶æ€å¹¶æç¤º
    if (!result || !result.success) {
        showModalAlert(result?.message || 'æ— æ³•å¼€å§‹å…¨éƒ¨è´¦å·ä»»åŠ¡ã€‚');

        return;
    }
}


async function multi_stopAll() {
    await callPythonAPI('multi_stop_all_accounts');

}

// åç«¯ä¸»åŠ¨æ¨é€æ—¶ä½¿ç”¨çš„åˆ·æ–°å…¥å£
function onAccountsUpdated(accounts) {
    try {
        renderMultiAccountList(accounts);
    } catch (e) {
        console.error("onAccountsUpdated render failed:", e);
    }
}


function renderMultiAccountList(accounts) {
    const listDiv = $('multi-account-list');
    listDiv.innerHTML = '';
    $('multi-account-count').textContent = accounts.length;
    if (accounts.length === 0) {
        listDiv.innerHTML = '<p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>';
        return;
    }

    accounts.forEach(acc => {
        const s = acc.summary;
        const item = document.createElement('div');
        item.id = `multi-acc-${acc.username}`;
        item.dataset.username = acc.username;
        item.className = 'p-3 rounded-xl border border-slate-200 bg-white/80 mb-2 text-sm';
        item.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="font-bold text-slate-800 flex items-start gap-2 truncate min-w-0">
                    <input type="checkbox" class="account-checkbox w-4 h-4 accent-sky-600 rounded flex-shrink-0 mt-1">
                    <div class="truncate">
                        <span class="account-name truncate">${acc.name}</span>
                        <span class="text-xs text-slate-500 font-normal block">(${acc.username})</span>
                    </div>
                </div>
                <span class="status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap">${acc.status_text}</span>
            </div>


            <div class="grid grid-cols-5 gap-2 text-center text-xs mt-2 pt-2 border-t text-slate-600">
                <div>æ€»æ•°: <span class="summary-total font-bold">${s.total}</span></div>
                <div>å®Œæˆ: <span class="summary-completed font-bold text-emerald-600">${s.completed}</span></div>
                <div>æœªå¼€å§‹: <span class="summary-notstarted font-bold text-slate-600">${s.not_started}</span></div>
                <div>å¯è·‘: <span class="summary-executable font-bold text-amber-600">${s.executable}</span></div>
                <div>è¿‡æœŸ: <span class="summary-expired font-bold text-red-600">${s.expired}</span></div>
            </div>

            <div class="grid grid-cols-3 gap-2 text-center text-xs mt-2 pt-2 border-t border-slate-100 text-slate-600">
                <div title="å¾…ç­¾åˆ°ä»»åŠ¡">å¾…ç­¾: <span class="summary-att-pending font-bold text-sky-600">${s.att_pending || 0}</span></div>
                <div title="å·²ç­¾åˆ°ä»»åŠ¡">å·²ç­¾: <span class="summary-att-completed font-bold text-emerald-600">${s.att_completed || 0}</span></div>
                <div title="å·²è¿‡æœŸç­¾åˆ°">è¿‡æœŸ: <span class="summary-att-expired font-bold text-red-600">${s.att_expired || 0}</span></div>
            </div>

            <div class="flex justify-end items-center gap-2 mt-2 pt-2 border-t">
                <button class="btn-account-refresh btn btn-ghost !py-1 !px-3 !text-xs" data-username="${acc.username}">åˆ·æ–°</button>
                <button class="btn-account-start btn btn-success !py-1 !px-3 !text-xs" data-username="${acc.username}">å¼€å§‹</button>
                <button class="btn-account-stop btn btn-warning !py-1 !px-3 !text-xs" data-username="${acc.username}">åœæ­¢</button>
                <button class="btn-account-params btn btn-ghost !py-1 !px-3 !text-xs" data-username="${acc.username}">è®¾ç½®</button>
            </div>
            <!-- è¿›åº¦æ¡å— -->
            <div class="mt-2">
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div class="progress-fill h-2 bg-sky-500" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span class="progress-text text-slate-600">æœªå¼€å§‹</span>
                    <span class="progress-extra text-slate-400"></span>
                </div>
            </div>
            `;
        listDiv.appendChild(item);
    });
    // Re-bind events for new elements

    document.querySelectorAll('.btn-account-start').forEach(b => b.onclick = (e) => {
      const runOnly = document.getElementById('multi-run-only-incomplete-check')?.checked ?? true;
      callPythonAPI('multi_start_single_account', e.target.dataset.username, runOnly);
    });
    document.getElementById('multi-run-only-incomplete-check').addEventListener('change', async (e) => {
      // å…ˆå‘Šè¯‰åç«¯å½“å‰çš„å¼€å…³çŠ¶æ€
      await callPythonAPI('set_multi_run_only_incomplete', e.target.checked);
      // å†è§¦å‘ä¸€æ¬¡â€œåˆ·æ–°å…¨éƒ¨â€ï¼Œè®©æ‘˜è¦ä¸æŒ‰é’®ç«‹åˆ»ä¸€è‡´
      await callPythonAPI('multi_refresh_all_statuses');
    });



    document.querySelectorAll('.btn-account-stop').forEach(b => b.onclick = (e) => callPythonAPI('multi_stop_single_account', e.target.dataset.username));
    document.querySelectorAll('.btn-account-params').forEach(b => b.onclick = (e) => openAccountParamsModal(e.target.dataset.username));
    updateSelectAllCheckboxState();
    // const startAllBtn = $('multi-start-all-btn');
    // const stopAllBtn = $('multi-stop-all-btn');
    // if (startAllBtn) startAllBtn.disabled = false;
    // if (stopAllBtn) stopAllBtn.disabled = true;
        document.querySelectorAll('.btn-account-refresh').forEach(b => {
        b.onclick = async (e) => {
            const u = e.currentTarget.dataset.username;
            // ç«‹åˆ»åšè½»é‡UIåé¦ˆï¼ˆå¯é€‰ï¼‰
            const item = document.getElementById(`multi-acc-${u}`);
            if (item) {
                const statusEl = item.querySelector('.status-text');
                if (statusEl) statusEl.textContent = 'åˆ·æ–°ä¸­...';
            }
            const result = await callPythonAPI('multi_refresh_single_status', u);
            if (!result || !result.success) {
                showModalAlert(result?.message || 'åˆ·æ–°å¤±è´¥');
            }
        };
    });

}

// --- æ–°çš„JSå‡½æ•° ---
function multi_toggleSelectAll(event) {
    const isChecked = event.target.checked;
    document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = isChecked);
}

function updateSelectAllCheckboxState() {
    const allCheckboxes = document.querySelectorAll('.account-checkbox');
    const checkedCount = document.querySelectorAll('.account-checkbox:checked').length;
    const selectAllCheckbox = $('multi-select-all-check');
    if (allCheckboxes.length > 0) {
        selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

$('multi-account-list').addEventListener('change', (event) => { if (event.target.classList.contains('account-checkbox')) { updateSelectAllCheckboxState(); } });

async function multi_removeAll() {
    const confirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', 'ç¡®å®šè¦ç§»é™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
    if (confirmed) {
        const result = await callPythonAPI('multi_remove_all_accounts');
        if (result && result.accounts) renderMultiAccountList(result.accounts);
    }
}

async function multi_removeSelected() {
    const selectedUsernames = Array.from(document.querySelectorAll('.account-checkbox:checked')).map(cb => cb.closest('[data-username]').dataset.username);
    if (selectedUsernames.length === 0) { showModalAlert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ç§»é™¤çš„è´¦å·ã€‚"); return; }
    const confirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', `ç¡®å®šè¦ç§»é™¤é€‰ä¸­çš„ ${selectedUsernames.length} ä¸ªè´¦å·å—ï¼Ÿ`);
    if (confirmed) {
        const result = await callPythonAPI('multi_remove_selected_accounts', selectedUsernames);
        if (result && result.accounts) renderMultiAccountList(result.accounts);
    }
}

function multi_getSelectedUsernames() {
    return Array.from(document.querySelectorAll('.account-checkbox:checked'))
        .map(cb => cb.closest('[data-username]')?.dataset?.username)
        .filter(Boolean);
}

async function multi_startSelected() {
    const usernames = multi_getSelectedUsernames();
    if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œå¼€å§‹é€‰ä¸­â€ã€‚');
        return;
    }
    // ä»å·¥å…·æ å‹¾é€‰é¡¹è¯»å–è¿è¡Œç­–ç•¥ï¼ˆä¸â€œå…¨éƒ¨å¼€å§‹â€ä¸€è‡´ï¼‰
    const use_delay = $('multi-use-delay-check')?.checked ?? true;
    const min_delay = parseInt($('multi-min-delay-input')?.value) || 0;
    const max_delay = parseInt($('multi-max-delay-input')?.value) || 300;
    const run_only_incomplete = $('multi-run-only-incomplete-check')?.checked ?? true;

    // é€ä¸ªè°ƒç”¨åç«¯â€œå•è´¦å·å¼€å§‹â€
    for (const u of usernames) {
        try {
            // å¯é€‰ï¼šè¿™é‡Œå¯ä»¥å®ç°ç®€å•çš„éšæœºå»¶è¿Ÿï¼Œé¿å…ç¬å‘å…¨éƒ¨
            if (use_delay && max_delay >= min_delay) {
                const d = Math.random() * (max_delay - min_delay) + min_delay;
                // è½»é‡å»¶è¿Ÿï¼Œä¸é˜»å¡ UI
                await new Promise(res => setTimeout(res, d * 10)); // ç¼©çŸ­ä¸€ä¸ªæ•°é‡çº§ï¼Œé¿å…è¿‡é•¿ç­‰å¾…
            }
            await callPythonAPI('multi_start_single_account', u);
        } catch (e) {
            console.error(`å¼€å§‹è´¦å· ${u} å¤±è´¥`, e);
        }
    }
}

async function multi_stopSelected() {
    const usernames = multi_getSelectedUsernames();
    if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œåœæ­¢é€‰ä¸­â€ã€‚');
        return;
    }
    for (const u of usernames) {
        try {
            await callPythonAPI('multi_stop_single_account', u);
        } catch (e) {
            console.error(`åœæ­¢è´¦å· ${u} å¤±è´¥`, e);
        }
    }
}

async function multi_refreshSelected() {
    const usernames = multi_getSelectedUsernames();
    if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œåˆ·æ–°é€‰ä¸­â€ã€‚');
        return;
    }
    for (const u of usernames) {
        try {
            // è½»é‡ UI æç¤ºï¼ˆéå¿…éœ€ï¼‰
            const item = document.getElementById(`multi-acc-${u}`);
            if (item) {
                const statusEl = item.querySelector('.status-text');
                if (statusEl) statusEl.textContent = 'åˆ·æ–°ä¸­...';
            }
            await callPythonAPI('multi_refresh_single_status', u);
        } catch (e) {
            console.error(`åˆ·æ–°è´¦å· ${u} å¤±è´¥`, e);
        }
    }
}


async function multi_refreshAll() { await callPythonAPI('multi_refresh_all_statuses'); }

async function process_path_queue() {
    if (is_planning_path || path_planning_queue.length === 0) return;
    is_planning_path = true;
    const { username, waypoints } = path_planning_queue.shift();
    try {
        logMessage(`[JS-Queue] å¼€å§‹å¤„ç† ${username} çš„è·¯å¾„è§„åˆ’...`);
        const path = await getWalkingPath(waypoints);
        logMessage(`[JS-Queue] è·¯å¾„è§„åˆ’æˆåŠŸ for ${username}, è¿”å› ${path.length} ç‚¹ç»™Pythonã€‚`);
        callPythonAPI('multi_path_generation_callback', username, true, path);
    } catch (error) {
        logMessage(`[JS-Queue] è·¯å¾„è§„åˆ’å¤±è´¥ for ${username}: ${error}`);
        callPythonAPI('multi_path_generation_callback', username, false, String(error));
    } finally {
        is_planning_path = false;
        setTimeout(process_path_queue, 100);
    }
}
function triggerPathGenerationForPy(username, waypoints) {
    logMessage(`æ”¶åˆ° ${username} çš„è·¯å¾„è§„åˆ’è¯·æ±‚ï¼Œå·²åŠ å…¥é˜Ÿåˆ—ã€‚`);
    path_planning_queue.push({ username, waypoints });
    process_path_queue();
}


function multi_updateAccountStatus(username, data) {
    const item = $(`multi-acc-${username}`);
    if (!item) return;

    // 1. æ–‡æ¡ˆä¸æ‘˜è¦çš„å¸¸è§„æ›´æ–°
    if (data.status_text) {
        item.querySelector('.status-text').textContent = data.status_text;
    }
    if (data.name) {
        item.querySelector('.account-name').textContent = data.name;
    }

    
    if (data.summary) {
        const s = data.summary;
        item.querySelector('.summary-total').textContent = s.total;
        item.querySelector('.summary-completed').textContent = s.completed;
        const ns = item.querySelector('.summary-notstarted');
        if (ns) ns.textContent = (s.not_started ?? 0);
        item.querySelector('.summary-executable').textContent = s.executable;
        item.querySelector('.summary-expired').textContent = s.expired;

        // æ›´æ–°ç­¾åˆ°ç»Ÿè®¡
        const att_pending = item.querySelector('.summary-att-pending');
        const att_completed = item.querySelector('.summary-att-completed');
        const att_expired = item.querySelector('.summary-att-expired');
        if (att_pending) att_pending.textContent = s.att_pending || 0;
        if (att_completed) att_completed.textContent = s.att_completed || 0;
        if (att_expired) att_expired.textContent = s.att_expired || 0;


    }






    // 2. è¿›åº¦æ¡ä¸é™„åŠ æ–‡æœ¬çš„æ›´æ–°
    if (typeof data.progress_pct === 'number') {
        const fill = item.querySelector('.progress-fill');
        if (fill) fill.style.width = `${Math.max(0, Math.min(100, data.progress_pct))}%`;
    }
    if (typeof data.progress_text === 'string') {
        const label = item.querySelector('.progress-text');
        if (label) label.textContent = data.progress_text;
    }
    if (typeof data.progress_extra === 'string') {
        const extra = item.querySelector('.progress-extra');
        if (extra) extra.textContent = data.progress_extra;
    }

    // 3. çŠ¶æ€é©±åŠ¨çš„æ ‡è®°æ¸…ç†é€»è¾‘ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
    // å–æœ€æ–°çŠ¶æ€æ–‡æœ¬ï¼ˆdata.status_text è‹¥æœªæä¾›åˆ™è¯»å–å½“å‰DOMï¼‰
    const currentStatus =
        (typeof data.status_text === 'string' && data.status_text.trim())
            ? data.status_text.trim()
            : (item.querySelector('.status-text')?.textContent?.trim() || '');

    // å®šä¹‰â€œéè¿è¡Œæ€â€é›†åˆï¼šåˆ°è¾¾è¿™äº›çŠ¶æ€åä¸å†åº”ä¿ç•™åœ°å›¾æ ‡è®°
    const NON_RUNNING_STATUSES = new Set([
        'ä»»åŠ¡å·²å®Œæˆ',
        'å…¨éƒ¨å®Œæˆ',
        'æ— ä»»åŠ¡å¯æ‰§è¡Œ',
        'å·²åœæ­¢',
        'å·²ä¸­æ­¢',
        'å¾…å‘½'
    ]);

    // è‹¥è¿›å…¥éè¿è¡ŒçŠ¶æ€ï¼Œåˆ™ç§»é™¤è¯¥è´¦å·çš„åœ°å›¾æ ‡è®°
    if (NON_RUNNING_STATUSES.has(currentStatus)) {
        multi_removeRunnerMarker(username);
        return; // å·²æ¸…ç†ï¼Œæ— éœ€è¿›ä¸€æ­¥åˆ¤æ–­
    }

    // æ‘˜è¦ä¹Ÿå¯è¾…åŠ©åˆ¤æ–­ï¼šå½“ s.executable == 0 ä¸”çŠ¶æ€æ–‡æœ¬ä¸æ˜¯æ˜æ˜¾è¿è¡Œæ€ï¼Œä¹Ÿæ¸…ç†ä¸€æ¬¡ï¼ˆä¿é™©ï¼‰
    const s = data.summary;
    if (s && typeof s.executable === 'number' && s.executable <= 0) {
        // å¦‚æœæ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡ä¸”ä¸æ˜¯â€œç™»å½•ä¸­/åˆ†æä»»åŠ¡/è¿è¡Œä¸­/ç­‰å¾…ä¸­â€ï¼Œåˆ™ç§»é™¤
        const maybeRunning = ['ç™»å½•ä¸­...', 'åˆ†æä»»åŠ¡', 'è¿è¡Œ', 'ç­‰å¾…', 'æ’é˜Ÿç™»å½•...', 'å»¶è¿Ÿ'];
        const isLikelyRunning = maybeRunning.some(k => currentStatus.includes(k));
        if (!isLikelyRunning) {
            multi_removeRunnerMarker(username);
        }
    }
}


function multi_updateRunnerPosition(username, lon, lat, name) {
    if (!multiAccountMap) return;
    const pos = new AMapInstance.LngLat(lon, lat);
    if (multiAccountMarkers[username]) {
        multiAccountMarkers[username].setPosition(pos);
    } else {
        const color = userColors[colorIndex++ % userColors.length];
        const markerContent = `<div style="background-color: ${color};" class="text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg text-white">${name}</div>`;
        multiAccountMarkers[username] = new AMapInstance.Marker({
            position: pos, content: markerContent, anchor: 'bottom-center',
            zIndex: 110, title: `${name} (${username})`
        });
        multiAccountMap.add(multiAccountMarkers[username]);
    }
    multi_resetMapView();
}

function multi_removeRunnerMarker(username) {
    const marker = multiAccountMarkers[username];
    if (marker && multiAccountMap) {
        multiAccountMap.remove(marker);
    }
    delete multiAccountMarkers[username];
    // ç§»é™¤åæ ¹æ®å½“å‰å‰©ä½™æ ‡è®°ç»Ÿä¸€è§†è§’
    multi_resetMapView();
}


function multi_resetMapView() {
    if (!multiAccountMap) return;
    const overlays = Object.values(multiAccountMarkers).filter(m => m.getMap());
    if (overlays.length > 0) {
        multiAccountMap.setFitView(overlays, false, [80, 80, 80, 80]);
    } else {
        multiAccountMap.setZoomAndCenter(17, [113.390342, 22.527403]);
    }
}


function selectTaskFromBackend(index) { if (selectedTaskIndex !== index) selectTask(index); }

function updateDashboard() {
  if (!currentRunData || Object.keys(currentRunData).length === 0) {
    $('run-stats-label').textContent = `-- km / --:--`;
    $('live-dist-label').textContent = '0.00 km';
    $('total-dist-label').textContent = '0.00 km';
    $('live-time-label').textContent = '00:00';
    $('total-time-label').textContent = '00:00';
    $('target-points-text').innerHTML = '<p class="text-slate-400 text-center text-xs pt-4">è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡</p>';
    $('current-location-label').textContent = 'å½“å‰ä½ç½®GPSåæ ‡: --, --';
    return;
  }
  const isDrawingNow = isDrawing && !currentRunData.run_coords?.length;
  if (isDrawingNow && draftTotalDist > 0) {
    const drawKm = (draftTotalDist / 1000).toFixed(2);
    const avgSpeed = pythonParams.speed_mps || 1.5;
    const estMin = avgSpeed > 0 ? (draftTotalDist / avgSpeed) / 60 : 0;
    $('run-stats-block').innerHTML = `<p class="text-sm text-slate-500">å½“å‰ç»˜åˆ¶</p><p class="font-bold text-2xl text-emerald-600">${drawKm} km / ~${estMin.toFixed(1)} min</p>`;
  } else {
    const dist = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
    const timeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
    const timeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
    $('run-stats-block').innerHTML = `<p class="text-sm text-slate-500">å·²é€‰ä»»åŠ¡æ€»è§ˆ</p><p id="run-stats-label" class="font-bold text-2xl text-sky-600">${dist} km / ${String(timeMin).padStart(2,'0')}:${String(timeSec).padStart(2,'0')}</p>`;
  }
  const liveKm = ((currentRunData.distance_covered_m || 0) / 1000).toFixed(2);
  const liveMs = runAccumulatedMs || 0;
  const mm = String(Math.floor(liveMs / 60000)).padStart(2, '0');
  const ss = String(Math.floor((liveMs % 60000) / 1000)).padStart(2, '0');
  $('live-dist-label').textContent = `${liveKm} km`;
  $('live-time-label').textContent = `${mm}:${ss}`;

  const totalDistKm = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
  $('total-dist-label').textContent = `${totalDistKm} km`;
  const totalTimeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
  const totalTimeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
  $('total-time-label').textContent = `${String(totalTimeMin).padStart(2,'0')}:${String(totalTimeSec).padStart(2,'0')}`;
  
  const targetDiv = $('target-points-text');
  targetDiv.innerHTML = "";
  const names = (currentRunData.target_point_names || "").split('|');
  const sequence = currentRunData.target_sequence || 0;
  if (names.length === 0 || (names.length === 1 && names[0] === '')) {
    targetDiv.innerHTML = '<p class="text-slate-400 text-center text-xs pt-4">æ­¤ä»»åŠ¡æ— æ‰“å¡ç‚¹</p>';
  } else {
    names.forEach((name, i) => {
      if (!name) return;
      const p = document.createElement('p');
      let textClass = 'text-slate-500';
      if (sequence > 0) {
        if (i + 1 < sequence) textClass = 'text-slate-400 line-through';
        else if (i + 1 === sequence) textClass = 'font-bold text-sky-600';
      }
      p.className = `transition-colors p-1 rounded ${textClass}`;
      p.innerHTML = `<span class="font-mono w-6 inline-block">${i + 1}.</span>${name}`;
      targetDiv.appendChild(p);
    });
    centerTargetList(sequence);
  }
}
function centerTargetList(sequence) {
  const targetDiv = $('target-points-text');
  if (!targetDiv || !targetDiv.children || targetDiv.children.length === 0) return;
  const idx = Math.max(0, Math.min(targetDiv.children.length - 1, (sequence || 1) - 1));
  const child = targetDiv.children[idx];
  if (child && typeof child.scrollIntoView === 'function') {
    try { child.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) {}
  }
}
function resetMapView() {
  if (!map) return;
  const overlays = [...polylines.recommended, ...markers];
  if (polylines.draft) overlays.push(polylines.draft);
  if (polylines.run) overlays.push(polylines.run);
  if (polylines.history) overlays.push(polylines.history);
  
  if (overlays.length > 0) {
      map.setFitView(overlays, false, [60,60,60,60]);
  } else if (currentRunData && currentRunData.target_points?.length > 0) {
      const targetLngLats = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
      map.setFitView(targetLngLats, false, [60,60,60,60]);
  } else {
      map.setZoomAndCenter(17, [113.390342, 22.527403]);
  }
}

// åœ¨æ ‡è®°ç»˜åˆ¶ååšä¸€æ¬¡â€œç¡¬åˆ·æ–°â€ï¼Œæ¨¡æ‹Ÿå½•åˆ¶æŒ‰é’®å¸¦æ¥çš„ç¨³å®šæŠ•å½±é‡å»º
function forceProjectionRefresh() {
  if (!map) return;
  try {
    // 1) å…ˆä¸´æ—¶å…³é—­æ‹–æ‹½ä»¥è§¦å‘å†…éƒ¨äº¤äº’å±‚çŠ¶æ€å˜æ›´ï¼ˆè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼‰
    map.setStatus({ dragEnable: false });

    // 2) åšä¸€æ¬¡å°ºå¯¸åˆ·æ–°
    map.resize();

    // 3) ä¸‹ä¸€å¸§è¿›è¡Œè§†è§’æ‹Ÿåˆï¼ˆè¦†ç›–ç‰©æˆ–æ‰“å¡ç‚¹ä¼˜å…ˆï¼‰
    requestAnimationFrame(() => {
      const overlays = [...polylines.recommended];
      if (polylines.draft) overlays.push(polylines.draft);
      if (polylines.run) overlays.push(polylines.run);
      if (polylines.history) overlays.push(polylines.history);

      // ä¼˜å…ˆç”¨è¦†ç›–ç‰© fitï¼›æ²¡æœ‰è¦†ç›–ç‰©æ—¶ï¼Œç”¨æ‰“å¡ç‚¹ï¼›éƒ½æ²¡æœ‰æ—¶å›åˆ°é»˜è®¤è§†è§’
      if (overlays.length > 0) {
        map.setFitView(overlays, false, [60, 60, 60, 60]);
      } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
        const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        map.setFitView(pts, false, [60, 60, 60, 60]);
      } else {
        map.setZoomAndCenter(17, [113.390342, 22.527403]);
      }

      // 4) æ¢å¤æ‹–æ‹½ï¼ˆå½•åˆ¶æŒ‰é’®çš„è¡Œä¸ºä¹Ÿæ˜¯è¿™ä¸€å¥—ï¼‰
      map.setStatus({ dragEnable: true });
    });
  } catch (e) {
    console.warn('forceProjectionRefresh warning:', e);
  }
}


// åœ¨æ ‡è®°ç»˜åˆ¶ååšä¸€æ¬¡â€œç¡¬åˆ·æ–°â€ï¼Œæ¨¡æ‹Ÿå½•åˆ¶æŒ‰é’®å¸¦æ¥çš„ç¨³å®šæŠ•å½±é‡å»º
function forceProjectionRefresh() {
  if (!map) return;
  try {
    // 1) å…ˆä¸´æ—¶å…³é—­æ‹–æ‹½ä»¥è§¦å‘å†…éƒ¨äº¤äº’å±‚çŠ¶æ€å˜æ›´ï¼ˆè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼‰
    map.setStatus({ dragEnable: false });

    // 2) åšä¸€æ¬¡å°ºå¯¸åˆ·æ–°
    map.resize();

    // 3) ä¸‹ä¸€å¸§è¿›è¡Œè§†è§’æ‹Ÿåˆï¼ˆè¦†ç›–ç‰©æˆ–æ‰“å¡ç‚¹ä¼˜å…ˆï¼‰
    requestAnimationFrame(() => {
      const overlays = [...polylines.recommended];
      if (polylines.draft) overlays.push(polylines.draft);
      if (polylines.run) overlays.push(polylines.run);
      if (polylines.history) overlays.push(polylines.history);

      // ä¼˜å…ˆç”¨è¦†ç›–ç‰© fitï¼›æ²¡æœ‰è¦†ç›–ç‰©æ—¶ï¼Œç”¨æ‰“å¡ç‚¹ï¼›éƒ½æ²¡æœ‰æ—¶å›åˆ°é»˜è®¤è§†è§’
      if (overlays.length > 0) {
        map.setFitView(overlays, false, [60, 60, 60, 60]);
      } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
        const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        map.setFitView(pts, false, [60, 60, 60, 60]);
      } else {
        map.setZoomAndCenter(17, [113.390342, 22.527403]);
      }

      // 4) æ¢å¤æ‹–æ‹½ï¼ˆå½•åˆ¶æŒ‰é’®çš„è¡Œä¸ºä¹Ÿæ˜¯è¿™ä¸€å¥—ï¼‰
      map.setStatus({ dragEnable: true });
    });
  } catch (e) {
    console.warn('forceProjectionRefresh warning:', e);
  }
}




// åœ°å›¾ç»˜åˆ¶ç›¸å…³
function drawOnMap() {
  if (!map) return;
  clearMapOverlays();
  const data = currentRunData;
  if (!data) return;

  if (data.recommended_coords?.length > 0) {
    let segment = [];
    data.recommended_coords.forEach(p => {
      if (p[0] === 0 && p[1] === 0) {
        if (segment.length > 1) polylines.recommended.push(new AMapInstance.Polyline({ path: segment, strokeColor: "#10b981", strokeWeight: 5, lineCap: 'round', strokeOpacity: 0.6, zIndex: 40 }));
        segment = [];
      } else { segment.push(new AMapInstance.LngLat(p[0], p[1])); }
    });
    if (segment.length > 1) polylines.recommended.push(new AMapInstance.Polyline({ path: segment, strokeColor: "#10b981", strokeWeight: 5, lineCap: 'round', strokeOpacity: 0.6, zIndex: 40 }));
    map.add(polylines.recommended);
  }
  if (data.draft_coords?.length > 0) {
    polylines.draft = new AMapInstance.Polyline({ path: data.draft_coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#1f2937", strokeWeight: 6, zIndex: 45 });
    map.add(polylines.draft);
  }
  if (data.run_coords?.length > 0) {
    polylines.run = new AMapInstance.Polyline({ path: data.run_coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#ef4444", strokeWeight: 5, strokeStyle: 'dashed', zIndex: 50 });
    map.add(polylines.run);
  }
  drawMarkers();
  resetMapView();
}

function drawMarkers() {
  if (!map) return; 
  map.remove(markers); markers = [];
  const data = currentRunData; if (!data?.target_points?.length) return;
  const sequence = data.target_sequence || (data.status == 1 ? data.target_points.length + 1 : 0);
  const names = (data.target_point_names || "").split('|');
  data.target_points.forEach((p, i) => {
    let bgColor = 'bg-emerald-600', textColor = 'text-white', zIndex = 100, pulseClass = '';
    if (i + 1 < sequence) { bgColor = 'bg-slate-400'; } else if (i + 1 === sequence) { bgColor = 'bg-sky-600'; zIndex = 110; pulseClass = 'pulsing-marker'; }
    const pointName = names[i] || `ç‚¹ ${i+1}`;
    const markerContent = `<div class="relative flex flex-col items-center pointer-events-none"><div class="${pulseClass} text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg ${bgColor} ${textColor}">${pointName}</div><div class="w-0 h-0 border-x-4 border-x-transparent border-t-4 ${bgColor.replace('bg-','border-t-')}"></div></div>`;
    const marker = new AMapInstance.Marker({ position: new AMapInstance.LngLat(p[0], p[1]), content: markerContent, anchor: 'bottom-center', zIndex: zIndex });
    markers.push(marker);
  });
  map.add(markers);
}

// --- è·¯å¾„ç»˜åˆ¶ç›¸å…³å‡½æ•° ---
let draftPath = [], draftPathLngLat = [], pendingPoints = [], isUpdating = false, lastMouseMoveTime = 0;
const MOUSE_MOVE_THROTTLE_MS = 70;
const MIN_DRAW_DISTANCE_M = 12;

function fastDistanceMeters(lon1, lat1, lon2, lat2) { return Math.sqrt(Math.pow((lon1 - lon2) * 102834.74, 2) + Math.pow((lat1 - lat2) * 111712.69, 2)); }

function scheduleUpdate() {
  if (isUpdating) return; isUpdating = true;
  requestAnimationFrame(() => {
    if (pendingPoints.length > 0) {
      const batch = pendingPoints.splice(0, pendingPoints.length);
      batch.forEach(pt => {
        const lngLat = new AMapInstance.LngLat(pt.lng, pt.lat);
        draftPath.push(pt);
        draftPathLngLat.push(lngLat);
        if (draftPathLngLat.length > 1) { const prev = draftPathLngLat[draftPathLngLat.length - 2]; draftTotalDist += fastDistanceMeters(prev.lng, prev.lat, pt.lng, pt.lat); }
        checkTargetReachedOnDraw(lngLat, pt.isKey === 1);
      });
      if (!polylines.draft) { polylines.draft = new AMapInstance.Polyline({ path: draftPathLngLat, strokeColor: "#1f2937", strokeWeight: 6, zIndex: 45 }); map.add(polylines.draft); }
      else { polylines.draft.setPath(draftPathLngLat); }
      updateDrawingInfo(draftPathLngLat[draftPathLngLat.length - 1]);
      updateDashboard();
    }
    isUpdating = false;
    if (pendingPoints.length > 0) scheduleUpdate();
  });
}

function onMapMouseDown(e) { if (e.originEvent.button !== 0) return; leftMouseDown = true; if (isDrawing) { isPathDrawing = true; pendingPoints.push({ lng: e.lnglat.lng, lat: e.lnglat.lat, isKey: 0 }); scheduleUpdate(); } }
function onMapMouseMove(e) {
  const now = performance.now(); if (now - lastMouseMoveTime < MOUSE_MOVE_THROTTLE_MS) return; lastMouseMoveTime = now;
  if (isDrawing && isPathDrawing && leftMouseDown) {
    const lastPos = draftPath[draftPath.length - 1];
    if (!lastPos || fastDistanceMeters(lastPos.lng, lastPos.lat, e.lnglat.lng, e.lnglat.lat) > MIN_DRAW_DISTANCE_M) { pendingPoints.push({ lng: e.lnglat.lng, lat: e.lnglat.lat, isKey: 0 }); scheduleUpdate(); }
    else { updateDrawingInfo(e.lnglat); }
  }
}
function onMapMouseUp(e) { leftMouseDown = false; if (isDrawing && isPathDrawing) { isPathDrawing = false; scheduleUpdate(); } if (pendingUnlockMap) { map.setStatus({ dragEnable: true }); pendingUnlockMap = false; } }
function checkTargetReachedOnDraw(currentLngLat, isForcedKeyPoint = false) {
  if (!currentRunData?.target_points || currentRunData.target_points.length === 0) return;
  let seq = currentRunData.target_sequence || 1;
  if (seq > currentRunData.target_points.length) return;
  const [tarLon, tarLat] = currentRunData.target_points[seq - 1];
  const dist = fastDistanceMeters(currentLngLat.lng, currentLngLat.lat, tarLon, tarLat);
  const range = currentRunData.target_range_m || 0.0;
  if (dist <= range && !currentRunData.isInTargetZone) {
    currentRunData.isInTargetZone = true;
    const targetName = (currentRunData.target_point_names || "").split('|')[seq - 1] || `æ‰“å¡ç‚¹${seq}`;
    logMessage(`åˆ°è¾¾æ‰“å¡ç‚¹ ${seq}: ${targetName}`);
    if (isForcedKeyPoint) { pendingPoints.push({ lng: tarLon, lat: tarLat, isKey: 1 }); scheduleUpdate(); }
    if (seq < currentRunData.target_points.length) {
      currentRunData.target_sequence = seq + 1;
      updateDashboard();
      drawMarkers();
    } else {
      logMessage("å·²åˆ°è¾¾æ‰€æœ‰æ‰“å¡ç‚¹ï¼");
      if (isDrawing) {
        toggleRecordMode(true);
      }
    }
  } else if (dist > range && currentRunData.isInTargetZone) {
    currentRunData.isInTargetZone = false;
  }
}
function updateDrawingInfo(lnglat) {
  if (!isDrawing) { if (drawingInfoMarker) drawingInfoMarker.hide(); return; }
  const avgSpeed = pythonParams.speed_mps || 1.5; const estTime = avgSpeed > 0 ? draftTotalDist / avgSpeed : 0;
  const timeStr = `${Math.floor(estTime / 60).toString().padStart(2, '0')}:${Math.floor(estTime % 60).toString().padStart(2, '0')}`;
  if (!drawingInfoMarker) { drawingInfoMarker = new AMapInstance.Text({ anchor: 'bottom-left', offset: new AMapInstance.Pixel(10, -10), style: { 'background-color': 'rgba(255, 255, 255, 0.9)', 'border': '1px solid #94a3b8', 'padding': '4px 8px', 'border-radius': '10px', 'font-size': '12px', 'color': '#1e293b' } }); map.add(drawingInfoMarker); }
  drawingInfoMarker.setText(`è·ç¦»: ${draftTotalDist.toFixed(0)} m | é¢„ä¼°: ~${timeStr}`);
  drawingInfoMarker.setPosition(lnglat);
  drawingInfoMarker.show();
}

let pendingUnlockMap = false;

function toggleRecordMode() {
  const btn = $('record-button'); isDrawing = !isDrawing;
  if (isDrawing) {
    if(selectedTaskIndex === -1) { showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡ï¼"); isDrawing = false; return; }
    btn.innerHTML = 'ç»“æŸç»˜åˆ¶'; btn.classList.remove('btn-success'); btn.classList.add('btn-danger');
    $('map-container').classList.add('drawing');
    clearCurrentPath(false);
    currentRunData.target_sequence = 1; currentRunData.isInTargetZone = false; draftTotalDist = 0;
    updateDashboard(); drawMarkers(); map.setStatus({ dragEnable: false }); resetMapView();
    logMessage("è¿›å…¥å½•åˆ¶æ¨¡å¼ã€‚è¯·åœ¨åœ°å›¾ä¸ŠæŒ‰ä¸‹å·¦é”®å¹¶æ‹–åŠ¨æ¥ç»˜åˆ¶è·¯å¾„ã€‚");
  } else {
    btn.innerHTML = 'å½•åˆ¶è·¯å¾„'; btn.classList.remove('btn-danger'); btn.classList.add('btn-success');
    $('map-container').classList.remove('drawing');
    pendingUnlockMap = true; isPathDrawing = false; if (drawingInfoMarker) drawingInfoMarker.hide();
    const totalTargets = (currentRunData.target_points?.length || 0);
    const inLastZone = totalTargets > 0 && currentRunData.target_sequence >= totalTargets && currentRunData.isInTargetZone === true;
    if (inLastZone) { if (draftPath.length > 0) callPythonAPI('set_draft_path', draftPath).then(() => processCurrentPath()); }
    else { discardBlackDraftPolyline(); logMessage("æœªè¾¾åˆ°æœ€åæ‰“å¡ç‚¹ï¼Œå·²èˆå¼ƒè·¯å¾„ã€‚"); }
    currentRunData.target_sequence = 0; draftTotalDist = 0;
    updateDashboard(); drawMarkers(); resetMapView();
  }
}
async function clearCurrentPath(confirm = true) {
  if (confirm) {
      
      const userConfirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ','ç¡®è®¤æ¸…é™¤å½“å‰ä»»åŠ¡å·²ç”Ÿæˆçš„è·¯å¾„å—ï¼Ÿ');
      if (!userConfirmed) return;
  }
  await callPythonAPI('clear_current_task_draft')
  if (polylines.draft) { map.remove(polylines.draft); polylines.draft = null; }
  if (polylines.run) { map.remove(polylines.run); polylines.run = null; }
  if (drawingInfoMarker) drawingInfoMarker.hide();
  draftPath = []; draftPathLngLat = []; draftTotalDist = 0;
  if (currentRunData) { currentRunData.draft_coords = []; currentRunData.run_coords = []; currentRunData.total_run_distance_m = 0; currentRunData.total_run_time_s = 0; }
  if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) { currentTasks[selectedTaskIndex].draft_coords = []; currentTasks[selectedTaskIndex].run_coords = []; }
  updateDashboard(); renderTaskList();
}
async function discardBlackDraftPolyline() {
  try {
    if (polylines.draft) { map.remove(polylines.draft); polylines.draft = null; }
    draftPath = []; draftPathLngLat = []; pendingPoints = []; isUpdating = false; isPathDrawing = false; leftMouseDown = false; draftTotalDist = 0;
    if (drawingInfoMarker) drawingInfoMarker.hide();
    await callPythonAPI('set_draft_path', []);
    if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) { currentTasks[selectedTaskIndex].draft_coords = []; renderTaskList(); }
    if (currentRunData) currentRunData.draft_coords = [];
  } catch (e) { console.error("discardBlackDraftPolyline() error:", e); }
}
async function processCurrentPath() {
  if (draftPath.length > 0) await callPythonAPI('set_draft_path', draftPath);
  const result = await callPythonAPI('process_path');
  if(result.success) {
    currentRunData.run_coords = result.run_coords;
    currentRunData.total_run_distance_m = result.total_dist;
    currentRunData.total_run_time_s = result.total_time;
    drawOnMap(); updateDashboard(); renderTaskList(); discardBlackDraftPolyline();
    // å¤„ç†è·¯å¾„ååŒæ­¥æ€»ç‚¹æ•°å¹¶å¤ä½è¿›åº¦
    singleProcessedPoints = 0;
    singleTotalPoints = (currentRunData.run_coords?.length || 0);
    updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

  } else showModalAlert(result.message);
}
async function toggleRun() {
  const btn = $('start-run-button'); runAccumulatedMs = 0;
  if (btn.textContent === 'å¼€å§‹æ‰§è¡Œ') {
    const result = await callPythonAPI('start_single_run');
    if(result.success) onRunStarted(); else showModalAlert(result.message);
  } else {
    await callPythonAPI('stop_run'); onRunStopped();
  }
}
async function toggleAllRuns() {
  const btn = $('start-all-button'); runAccumulatedMs = 0;
  if (btn.textContent === 'æ‰§è¡Œæ‰€æœ‰') {
    const ignoreCompleted = $('run-completed-check').checked;
    const autoGen = $('auto-gen-all-check').checked;
    const result = await callPythonAPI('start_all_runs', ignoreCompleted, autoGen);
    if(!result.success) showModalAlert(result.message);
  } else await callPythonAPI('stop_run');
}
// ä¿®å¤Issue 2: æ·»åŠ å®æ—¶çŠ¶æ€è½®è¯¢
let statusPollInterval = null;

async function pollRunStatus() {
  try {
    const status = await callPythonAPI('get_run_status');
    if (status && status.running) {
      // æ›´æ–°ä½ç½®å’Œè¿›åº¦
      if (status.current_position) {
        updateRunnerPosition(
          status.current_position.lon,
          status.current_position.lat,
          status.distance_covered || 0,
          status.target_sequence || 0,
          status.duration || 0,
          false // ä¸è‡ªåŠ¨å±…ä¸­ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ä½œ
        );
      }
      // æ›´æ–°è¿›åº¦
      if (status.processed_points !== undefined && status.total_points !== undefined) {
        singleProcessedPoints = status.processed_points;
        singleTotalPoints = status.total_points;
        const pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
        updateSingleProgress(pct, `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`);
      }
    } else if (status && !status.running && statusPollInterval) {
      // ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
      clearInterval(statusPollInterval);
      statusPollInterval = null;
      onRunStopped();
    }
  } catch (e) {
    console.error('è½®è¯¢çŠ¶æ€å¤±è´¥:', e);
  }
}

function onRunStarted() {
  $('start-run-button').textContent = 'åœæ­¢';
  $('start-run-button').classList.remove('btn-primary');
  $('start-run-button').classList.add('btn-danger');
  $('start-all-button').textContent = 'å…¨éƒ¨åœæ­¢';
  $('start-all-button').classList.remove('btn-secondary');
  $('start-all-button').classList.add('btn-danger');
  // ä¿®å¤é€»è¾‘é”™è¯¯ï¼šç¦ç”¨å…¶ä»–æ§åˆ¶æŒ‰é’®
  ['record-button','auto-gen-button','process-button','clear-button','export-button','refresh-button','import-button','login-button','logout-button'].forEach(id => {
      if($(id)) $(id).disabled = true;
  });
// å¼€å§‹è¿è¡Œæ—¶é‡ç½®è¿›åº¦
  singleProcessedPoints = 0;
  singleTotalPoints = (currentRunData.run_coords?.length || 0);
  updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

  // ä¿®å¤Issue 2: å¯åŠ¨çŠ¶æ€è½®è¯¢ï¼ˆæ¯2ç§’ï¼‰
  if (statusPollInterval) clearInterval(statusPollInterval);
  statusPollInterval = setInterval(pollRunStatus, 2000);

}
function onRunStopped() {
    $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
    $('start-run-button').classList.remove('btn-danger');
    $('start-run-button').classList.add('btn-primary');
    $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
    $('start-all-button').classList.remove('btn-danger');
    $('start-all-button').classList.add('btn-secondary');
    runAccumulatedMs = 0;
    if(runnerMarker) { map.remove(runnerMarker); runnerMarker = null; }
    if (currentRunData) { currentRunData.target_sequence = 0; updateDashboard(); drawMarkers(); }
    $('current-location-label').textContent = 'å½“å‰ä½ç½®GPSåæ ‡: --, --';
    // ä¿®å¤é€»è¾‘é”™è¯¯ï¼šæ¢å¤å…¶ä»–æ§åˆ¶æŒ‰é’®
    ['record-button','auto-gen-button','process-button','clear-button','export-button','refresh-button','import-button','login-button','logout-button'].forEach(id => {
        if($(id)) $(id).disabled = false;
    });
    // åœæ­¢è¿è¡Œæ—¶å¤ä½è¿›åº¦
    singleProcessedPoints = 0;
    singleTotalPoints = (currentRunData.run_coords?.length || 0);
    updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

    // ä¿®å¤Issue 2: åœæ­¢çŠ¶æ€è½®è¯¢
    if (statusPollInterval) {
      clearInterval(statusPollInterval);
      statusPollInterval = null;
    }

}

function onAllRunsToggled(isRunning) {
  if(isRunning) { onRunStarted(); }
  else { onRunStopped(); }
}

function ensureRunnerMarker() {
  if (runnerMarker) return;
  const content = '<div class="w-5 h-5 rounded-full border-2 border-white shadow-lg" style="background:linear-gradient(135deg,var(--base-color-300),var(--base-color-600));"></div>';
  runnerMarker = new AMapInstance.Marker({ position: map.getCenter(), content, anchor: 'center', zIndex: 200 });
  map.add(runnerMarker);
}
function updateRunnerPosition(lon, lat, distance, targetSequence, duration, centerNow=false) {
  ensureRunnerMarker();
  const pos = new AMapInstance.LngLat(lon, lat);
  runnerMarker.setPosition(pos);
  if (map && centerNow) map.setCenter(pos);
  runAccumulatedMs += (duration || 0);
  currentRunData.distance_covered_m = distance || 0;
  $('current-location-label').textContent = `å½“å‰ä½ç½®GPSåæ ‡: ${(+lon).toFixed(4)}, ${(+lat).toFixed(4)}`;
  if (currentRunData.target_sequence !== targetSequence) { currentRunData.target_sequence = targetSequence; drawMarkers(); }
  updateDashboard();
  // æ¯ä¸ªGPSç‚¹åˆ°è¾¾åæ¨è¿›è¿›åº¦
  if (Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
    // é˜²é‡å¤ï¼šé™åˆ¶ä¸è¶…è¿‡æ€»ç‚¹æ•°
    singleTotalPoints = currentRunData.run_coords.length;
    singleProcessedPoints = Math.min(singleProcessedPoints + 1, singleTotalPoints);
    const pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
    updateSingleProgress(pct, `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`);
  }

}
function onTaskCompleted(taskIndex) { if (currentTasks[taskIndex]) { currentTasks[taskIndex].status = 1; renderTaskList(); } }
async function exportTask() { 
  if (selectedTaskIndex === -1) { 
    showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„ä»»åŠ¡ï¼"); 
    return; 
  } 
  const result = await callPythonAPI('export_task_data'); 
  if (result && result.success && result.data) {
    // Webæ¨¡å¼ï¼šåˆ›å»ºä¸‹è½½é“¾æ¥
    const jsonStr = JSON.stringify(result.data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = result.filename || 'task_export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    logMessage('å¯¼å‡ºæˆåŠŸ');
  } else if (result && !result.success) {
    showModalAlert(`å¯¼å‡ºå¤±è´¥: ${result.message}`);
  }
}

async function importTask() {
  // Webæ¨¡å¼ï¼šä½¿ç”¨æ–‡ä»¶è¾“å…¥
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const result = await callPythonAPI('import_task_data', text);
      
      if (result.success) {
        IS_OFFLINE = true;
        currentSessionUA = "NULL";
        const uaLabel = $('ua-label');
        if (uaLabel) uaLabel.textContent = 'NULL';
        const uaBtn = $('random-ua-btn');
        if (uaBtn) uaBtn.disabled = true;
        if (result.userInfo) {
          currentUserData = result.userInfo;
          const name = currentUserData.name || 'ç¦»çº¿è°ƒè¯•';
          const sid = currentUserData.student_id || 'NULL';
          $('user-name-label').textContent = `å§“å: ${name}`;
          $('user-id-label').textContent = `å­¦å·: ${sid}`;
        }
        showMainApp();
        await mapReadyPromise;
        currentTasks = result.tasks;
        renderTaskList();
        selectTask(0);
        requestAnimationFrame(() => drawOnMap());
        logMessage('å¯¼å…¥æˆåŠŸ');
      } else {
        showModalAlert(result.message || 'å¯¼å…¥å¤±è´¥');
      }
    } catch (error) {
      showModalAlert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
    }
  };
  input.click();
}





// --- é«˜å¾·åœ°å›¾JS APIè·¯å¾„è§„åˆ’ ---
async function getWalkingPath(waypoints) {
  if (!AMapInstance || waypoints.length < 2) throw new Error("åœ°å›¾å®ä¾‹æœªåŠ è½½æˆ–è·¯å¾„ç‚¹å°‘äº2");
  const useFallback = pythonParams.api_fallback_line ?? false, maxRetries = pythonParams.api_retries ?? 2, retryDelayMs = (pythonParams.api_retry_delay_s ?? 0.5) * 1000;
  callPythonAPI('js_log', 'INFO', `å¼€å§‹è·¯å¾„è§„åˆ’: é‡è¯•=${maxRetries}æ¬¡, å»¶è¿Ÿ=${retryDelayMs}ms, å¤‡ç”¨ç›´çº¿=${useFallback}`);
  const all_path = [];
  const areCoordsEqual = (c1, c2) => Math.abs(c1.lng - c2.lng) < 1e-6 && Math.abs(c1.lat - c2.lat) < 1e-6;
  const searchSegment = (start, end) => new Promise((resolve) => {
    callPythonAPI('js_log', 'DEBUG', `AMap APIè¯·æ±‚ --> æ­¥è¡Œè·¯å¾„: ${start.toString()} è‡³ ${end.toString()}`);
    new AMap.Walking({ map: null, panel: "", hideMarkers: true }).search(start, end, (status, result) => {
      if (status === 'complete' && result.routes?.length > 0) {
        const p = []; result.routes[0].steps.forEach(s => s.path.forEach(pt => p.push({ lng: pt.lng, lat: pt.lat })));
        callPythonAPI('js_log', 'DEBUG', `AMap APIå“åº” <-- æˆåŠŸï¼Œç‚¹æ•°: ${p.length}`); resolve(p);
      } else { let info = result ? (result.info || JSON.stringify(result)) : 'NULL'; callPythonAPI('js_log', 'ERROR', `AMap APIå“åº” <-- å¤±è´¥. çŠ¶æ€: ${status}, ç»“æœ: ${info}`); resolve([]); }
    });
  });
  // await new Promise(resolve => AMap.plugin('AMap.Walking', resolve));
  for (let i = 0; i < waypoints.length - 1; i++) {
    logMessage(`æ­£åœ¨è§„åˆ’ç¬¬ ${i + 1}/${waypoints.length - 1} æ®µè·¯å¾„...`);
    const realStart = waypoints[i], realEnd = waypoints[i + 1]; let attempts = 0, segmentPath = [];
    while (attempts <= maxRetries) {
      if (attempts > 0) { logMessage(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’å¤±è´¥ï¼Œ${retryDelayMs / 1000}ç§’åé‡è¯•...`); await new Promise(res => setTimeout(res, retryDelayMs)); }
      segmentPath = await searchSegment(realStart, realEnd); if (segmentPath.length > 0) break; attempts++;
    }
    if (segmentPath.length === 0) {
      if (useFallback) { logMessage(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’æœ€ç»ˆå¤±è´¥ï¼Œå¯ç”¨ç›´çº¿è¿æ¥ã€‚`); segmentPath = [{ lng: realStart.lng, lat: realStart.lat }, { lng: realEnd.lng, lat: realEnd.lat }]; }
      else throw new Error(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’å¤±è´¥ (é‡è¯• ${maxRetries} æ¬¡å)`);
    }
    if (!areCoordsEqual(segmentPath[0], {lng: realStart.lng, lat: realStart.lat})) segmentPath.unshift({ lng: realStart.lng, lat: realStart.lat });
    if (!areCoordsEqual(segmentPath[segmentPath.length - 1], {lng: realEnd.lng, lat: realEnd.lat})) segmentPath.push({ lng: realEnd.lng, lat: realEnd.lat });
    all_path.push(...(i > 0 ? segmentPath.slice(1) : segmentPath));
  }
  return all_path;
}

async function onConfirmAutoGenerate() {
  const minTime = parseInt($('min-time-input').value), maxTime = parseInt($('max-time-input').value), minDist = parseInt($('min-dist-input').value);
  if (minTime > maxTime) { showModalAlert("æœ€çŸ­æ—¶é—´ä¸èƒ½å¤§äºæœ€é•¿æ—¶é—´"); return; }
  $('auto-gen-modal').classList.add('hidden');
  if (selectedTaskIndex === -1 || !currentRunData.target_points || currentRunData.target_points.length === 0) { showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰æ‰“å¡ç‚¹çš„ä»»åŠ¡"); return; }
  logMessage("æ­£åœ¨è°ƒç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œè·¯å¾„è§„åˆ’...");
  try {
    const waypoints = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
    const apiPath = await getWalkingPath(waypoints);
    logMessage(`è·¯å¾„è§„åˆ’æˆåŠŸï¼Œå…± ${apiPath.length} ä¸ªåæ ‡ç‚¹ã€‚æ­£åœ¨ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®...`);
    const result = await callPythonAPI('auto_generate_path_with_api', apiPath, minTime, maxTime, minDist);
    if (result.success) { 
      currentRunData.run_coords = result.run_coords; 
      currentRunData.total_run_distance_m = result.total_dist; 
      currentRunData.total_run_time_s = result.total_time; 
      drawOnMap(); updateDashboard(); renderTaskList(); 
     
      // è‡ªåŠ¨ç”ŸæˆååŒæ­¥æ€»ç‚¹æ•°å¹¶å¤ä½è¿›åº¦
      singleProcessedPoints = 0;
      singleTotalPoints = (currentRunData.run_coords?.length || 0);
      updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

    } else { 
      logMessage(`ç”Ÿæˆå¤±è´¥: ${result.message}`); 
      showModalAlert(`ç”Ÿæˆå¤±è´¥: ${result.message}`); 
    }
  } catch (error) { 
    logMessage(`è·¯å¾„è§„åˆ’æˆ–ç”Ÿæˆå¤±è´¥: ${error}`); 
    showModalAlert(`è·¯å¾„è§„åˆ’æˆ–ç”Ÿæˆå¤±è´¥: ${error}`); 
  }
}
async function loadHistory(index) {
  $('history-placeholder').textContent = "æ­£åœ¨åŠ è½½..."; $('history-list').innerHTML = "";
  const result = await callPythonAPI('get_task_history', index);
  if(result.success && result.history.length > 0) {
    $('history-placeholder').classList.add('hidden');
    result.history.forEach(rec => {
      const item = document.createElement('div');
      item.className = 'grid grid-cols-3 gap-2 text-xs p-2 border-b border-slate-100 cursor-pointer hover:bg-white/70 rounded';
      item.innerHTML = `<span class="text-slate-600">${rec.time}</span><span class="font-semibold text-emerald-700">${rec.len}</span><span class="font-semibold text-sky-700">${rec.speed}</span>`;
      item.addEventListener('click', () => showHistoricalTrack(rec.trid)); $('history-list').appendChild(item);
    });
  } else { $('history-placeholder').textContent = "æ— å†å²è®°å½•æˆ–åŠ è½½å¤±è´¥"; $('history-placeholder').classList.remove('hidden'); }
}
async function showHistoricalTrack(trid) {
  const result = await callPythonAPI('get_historical_track', trid);
  if(result.success) {
    if(polylines.history) map.remove(polylines.history);
    polylines.history = new AMapInstance.Polyline({ path: result.coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#8b5cf6", strokeWeight: 6, strokeOpacity: 0.8, zIndex: 55 });
    map.add(polylines.history); map.setFitView([polylines.history]);
  } else showModalAlert("æ— æ³•åŠ è½½å†å²è½¨è¿¹");
}

// --- å…¶ä»–è¾…åŠ©å‡½æ•° ---


// å•è´¦å·è¿›åº¦æ¡æ›´æ–°
function updateSingleProgress(pct, text, extra) {
  const fill = $('single-progress-fill');
  const label = $('single-progress-text');
  const extraEl = $('single-progress-extra');
  if (fill) fill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
  if (label) label.textContent = `è¿›åº¦ Â· ${pct}%`;
  if (extraEl) extraEl.textContent = extra || text || '';
}


function logMessage(msg) {
  // æ–°å¢ï¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ·»åŠ  [HH:MM:SS] æ ¼å¼çš„æ—¶é—´æˆ³
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  const timestamp = `[${h}:${m}:${s}]`;

  const line = typeof msg === 'string' ? msg : JSON.stringify(msg);
  // å°†æ—¶é—´æˆ³ä¸åŸå§‹æ¶ˆæ¯ç»„åˆ
  const fullMessage = `${timestamp} ${line}`;

  const single = $('log-text');
  const multi = $('multi-log-text');
  if (single) {
    // ä½¿ç”¨å¸¦æœ‰æ—¶é—´æˆ³çš„å®Œæ•´æ¶ˆæ¯
    single.value += fullMessage + '\n';
    single.scrollTop = single.scrollHeight;
  }
  if (multi) {
    // ä½¿ç”¨å¸¦æœ‰æ—¶é—´æˆ³çš„å®Œæ•´æ¶ˆæ¯
    multi.value += fullMessage + '\n';
    multi.scrollTop = multi.scrollHeight;
  }
}


function showTab(tabName, element) {
  ['run-control','path-tools','history','params','log', 'checkpoints', 'attendance'].forEach(name => {
    $(`${name}-tab`).classList.add('hidden');
    const b = document.querySelector(`button[onclick="showTab('${name}', this)"]`);
    if (b) b.classList.remove('active');
  });
  $(`${tabName}-tab`).classList.remove('hidden');
  if (element) element.classList.add('active');
  if (tabName === 'attendance') {
    // refreshNotificationsUI() ä¼šè·å–æœ€æ–°é€šçŸ¥
    // onNotificationsUpdated() (ç”±åå°è°ƒç”¨æˆ– refreshNotificationsUI é—´æ¥è°ƒç”¨) ä¼šå¡«å…… attendance-list
    // refreshNotificationsUI() è‡ªå¸¦é˜²æŠ–ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨æ˜¯å®‰å…¨çš„
    console.log("Attendance tab opened, refreshing notifications list...");
    refreshNotificationsUI();
  }
}



function autoLogin(user, pass) {
  if (!user || !pass) return;
  const userCombo = $('user-combo');
  userCombo.addEventListener('focus', refreshUserList);
  userCombo.addEventListener('click', refreshUserList);
  if ([...userCombo.options].some(o => o.value === user)) userCombo.value = user;
  else { const opt = document.createElement('option'); opt.value = opt.textContent = user; userCombo.appendChild(opt); userCombo.value = user; }
  $('username-entry').value = user; $('password-entry').value = pass;
  onUserChange().then(() => $('login-button').click());
}


function createParamInputs(container, prefix, changeHandler, excludeGroups = []) {
  container.innerHTML = '';

  // é»˜è®¤æ’é™¤â€œè‡ªåŠ¨ç­¾åˆ°â€ç»„ï¼Œå› ä¸ºå®ƒåœ¨ä¸“å±Tabé‡Œ
  let finalExclude = [...excludeGroups];
  if (prefix !== 'multi-param') {
      finalExclude.push("è‡ªåŠ¨ç­¾åˆ°");
  }

  paramGroups.forEach((group, index) => {
    // å¦‚æœå½“å‰åˆ†ç»„çš„æ ‡é¢˜åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œåˆ™è·³è¿‡
    if (finalExclude.includes(group.title)) {
      return; 
    }
    // å¦‚æœå½“å‰åˆ†ç»„çš„æ ‡é¢˜åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œåˆ™è·³è¿‡
    if (excludeGroups.includes(group.title)) {
      return; 
    }

    const header = document.createElement('h3');
    const marginTopClass = index === 0 ? '' : 'mt-4';
    header.className = `text-base font-bold text-sky-700 ${marginTopClass} mb-2 border-b border-slate-200 pb-1`;
    header.textContent = group.title;
    container.appendChild(header);
    
    for (const key of group.keys) {
      const def = paramDefs[key];
      if (!def) continue;

      const div = document.createElement('div');
      div.className = 'text-sm mb-3';

      const step = (key.endsWith('_s') || key.endsWith('_mps')) ? '0.1' : '1';
      const unitHtml = def.unit ? `<span class="ml-2 text-xs text-slate-500 select-none">${def.unit}</span>` : '';

      // æ ¹æ®è‡ªå®šä¹‰ type å†³å®šæ¸²æŸ“å“ªä¸ª UI
      if (def.type === 'theme_selector') {
        div.innerHTML = `
          <label class="block text-slate-700 font-semibold">${def.label}</label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
          <div class="grid grid-cols-3 gap-2 mt-2">
              <button onclick="setThemeStyle('default')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">é»˜è®¤</button>
              <button onclick="setThemeStyle('theme-anime')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">äºŒæ¬¡å…ƒ</button>
              <button onclick="setThemeStyle('theme-minimalist')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">ç®€çº¦</button>
          </div>
        `;
      } else if (def.type === 'color_picker') {
        div.innerHTML = `
          <label for="${prefix}-${key}" class="block text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center gap-3 mt-1">
            <input type="color" id="${prefix}-${key}-picker" data-key="${key}" class="w-10 h-10 rounded-full cursor-pointer border-2 border-white shadow-md" title="ç‚¹å‡»é€‰æ‹©é¢œè‰²">
            <input type="text" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" placeholder="#7dd3fc" title="${def.help}">
            <button onclick="resetBaseColorToDefault('${prefix}')" class="btn btn-ghost !py-1 !px-3 !text-xs flex-shrink-0">æ¢å¤é»˜è®¤</button>
          </div>
           <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
      } else if (def.type === 'checkbox' || key === 'api_fallback_line' || key === 'ignore_task_time') {
        div.innerHTML = `
          <label class="flex items-center gap-2 cursor-pointer" title="${def.help}">
            <input type="checkbox" id="${prefix}-${key}" data-key="${key}" class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0">
            <span class="text-slate-700 font-semibold">${def.label}</span>
          </label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
      } else {
        div.innerHTML = `
          <label for="${prefix}-${key}" class="block mb-1 text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center">
            <input type="number" step="${step}" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" title="${def.help}">
            ${unitHtml}
          </div>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
      }

      container.appendChild(div);
      
      // ä¸ºæ‰€æœ‰ input ç»‘å®š change äº‹ä»¶
      const inputs = div.querySelectorAll('input');
      inputs.forEach(input => {
        if(input.type === 'color') {
          // é¢œè‰²é€‰æ‹©å™¨ä½¿ç”¨ input äº‹ä»¶å®ç°å®æ—¶é¢„è§ˆ
          input.addEventListener('input', (e) => {
            const hexColor = e.target.value;
            const textInput = document.getElementById(`${prefix}-${key}`);
            if (textInput) textInput.value = hexColor;
            setBaseColor(hexColor, hexColor); // å®æ—¶æ›´æ–°
          });
          // change äº‹ä»¶ç”¨äºæœ€ç»ˆç¡®è®¤å¹¶ä¿å­˜
          input.addEventListener('change', changeHandler);
        } else if (input.type === 'text' && key === 'theme_base_color') {
          // æ–‡æœ¬æ¡†ä¹Ÿè”åŠ¨é¢œè‰²é€‰æ‹©å™¨å’Œä¸»é¢˜è‰²
          input.addEventListener('change', (e) => {
            const hexColor = e.target.value;
            const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
            if (colorPicker) colorPicker.value = hexColor;
            setBaseColor(hexColor, hexColor);
            changeHandler(e); // è§¦å‘ä¿å­˜
          });
        } else {
          input.addEventListener('change', changeHandler);
        }
      });
    }
  });
}


function updateParamInputs(container, prefix, params) {
  for (const key of Object.keys(paramDefs)) {
    const input = document.getElementById(`${prefix}-${key}`);
if (!input || !params) continue;
    if (!(key in params)) continue;
if (input.type === 'checkbox') {
      input.checked = Boolean(params[key]);
} else {
      input.value = params[key];
      // å¦‚æœæ˜¯é¢œè‰²å‚æ•°ï¼Œé¢å¤–æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
      if (key === 'theme_base_color') {
        const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
        if (colorPicker) {
          colorPicker.value = params[key];
        }
      }
}
  }
}



function onParamChange(event) {
  const key = event.target.dataset.key;
  let value;
  if (event.target.type === 'checkbox') value = event.target.checked;
  else value = event.target.value;
  pythonParams[key] = value; callPythonAPI('update_param', key, value);
}

function onGlobalParamChange(event) {
  const key = event.target.dataset.key;
  let value = event.target.type === 'checkbox' ? event.target.checked : event.target.value;
  pythonParams[key] = value;
  callPythonAPI('update_param', key, value);
}

async function openAccountParamsModal(username) {
    const result = await callPythonAPI('multi_get_account_params', username);
    if (!result.success) { showModalAlert(result.message); return; }

    $('account-params-title').textContent = `[${username}] å‚æ•°è®¾ç½®`;
    const container = $('account-params-container');
    // è°ƒç”¨ createParamInputs æ—¶ï¼Œä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ’é™¤â€œä¸»é¢˜ä¸å¤–è§‚â€åˆ†ç»„
    createParamInputs(container, 'acc-param', () => {}, ['ä¸»é¢˜ä¸å¤–è§‚']);
    updateParamInputs(container, 'acc-param', result.params);

    $('save-account-params-btn').onclick = async () => {
        const inputs = container.querySelectorAll('input');
        for (const input of inputs) {
            const key = input.dataset.key;
            const value = input.type === 'checkbox' ? input.checked : input.value;
            await callPythonAPI('multi_update_account_param', username, key, value);
        }
        // å…³é—­æ—¶ç§»é™¤æ ·å¼ä¸ body æ ‡è®°
        const modal = $('account-params-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-visible');
    };

    // æ˜¾ç¤ºå¹¶å±…ä¸­
    const modal = $('account-params-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');             // ç¡®ä¿å±…ä¸­
    document.body.classList.add('modal-visible');  // éšè—åœ°å›¾ç‰ˆæƒ
}



function toggleUserDetails(show) {
  const modal = $('user-details-modal');
  modal.classList.toggle('hidden', !show);
  modal.classList.toggle('flex', show);
  const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;
  if (show) {
    if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
    document.body.classList.add('modal-visible');
  } else {
    // å…³é—­æ¨¡æ€æ—¶æ¢å¤åŒå‡»ç¼©æ”¾
    if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
    document.body.classList.remove('modal-visible');
  }
}


function toggleTaskDetails(show) {
  const modal = $('task-details-modal');
  modal.classList.toggle('hidden', !show);
  modal.classList.toggle('flex', show);

  const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;

  if (show) {
    if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
    // æ‰“å¼€ä»»åŠ¡è¯¦æƒ…æ—¶ä¹Ÿæ ‡è®° bodyï¼Œä»¥è§¦å‘ç‰ˆæƒéšè—æ ·å¼
    document.body.classList.add('modal-visible');
  } else {
    // å…³é—­æ¨¡æ€æ—¶æ¢å¤åŒå‡»ç¼©æ”¾
    if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
    // å…³é”®ï¼šå…³é—­æ—¶å»é™¤æ ‡è®°ï¼Œæ¢å¤ç‰ˆæƒæ˜¾ç¤º
    document.body.classList.remove('modal-visible');
  }
}

function showUserDetails() {
  if (!currentUserData || !currentUserData.student_id) { showModalAlert('è¯·å…ˆæˆåŠŸç™»å½•'); return; }
  const info = currentUserData;
  const content = $('user-details-content'); content.innerHTML = '';
  const kv = {'å§“å':info.name,'å­¦å·':info.student_id,'ç”¨æˆ·å':info.username,'æ€§åˆ«':info.gender,'å­¦æ ¡':info.school_name,'å±æ€§':info.attribute_type,'æ‰‹æœºå·':info.phone,'ç”¨æˆ·ID':info.id,'èº«ä»½è¯å·':info.id_card,'æ³¨å†Œæ—¶é—´':info.registration_time,'é¦–æ¬¡ç™»å½•':info.first_login_time,'ä¸Šæ¬¡ç™»å½•':info.last_login_time,'å½“å‰ç™»å½•':info.current_login_time};
  Object.entries(kv).forEach(([k,v]) => { const p = document.createElement('p'); p.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">${k}:</span><span class="break-all">${v || 'NULL'}</span>`; content.appendChild(p); });

  // ç¦»çº¿æ¨¡å¼ä¸‹å›ºå®šæ˜¾ç¤ºæ—  UAï¼›å¦åˆ™ä»ç™»å½•æ—¶ä¿å­˜çš„ currentSessionUA å˜é‡ä¸­è¯»å–
  const uaText = IS_OFFLINE ? 'NULL' : (currentSessionUA || 'NULL');
  const p_ua = document.createElement('p');
  // ä¸å…¶ä»–è¡Œä¸€è‡´ï¼šæ ‡ç­¾å·¦å¯¹é½ï¼Œç§»é™¤ align-top å’Œä¸å¿…è¦çš„å®½åº¦è°ƒæ•´
  p_ua.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">UA:</span><span class="break-all">${uaText}</span>`;
  content.appendChild(p_ua);


  toggleUserDetails(true);
}

function showTaskDetails() {
  if (!currentRunData || !currentRunData.run_name) { showModalAlert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡'); return; }
  const content = $('task-details-content'); content.innerHTML = '';
  const kv = {'ä»»åŠ¡åç§°':currentRunData.run_name,'ä»»åŠ¡çŠ¶æ€':currentRunData.status==1?'å·²å®Œæˆ':'æœªå®Œæˆ','ä»»åŠ¡ID':currentRunData.errand_id,'è®¡åˆ’ID':currentRunData.errand_schedule,'å¼€å§‹æ—¶é—´':currentRunData.start_time,'ç»“æŸæ—¶é—´':currentRunData.end_time,'ä¸Šä¼ æ—¶é—´':currentRunData.upload_time};
  Object.entries(kv).forEach(([k,v]) => { const p = document.createElement('p'); p.innerHTML = `<span class="font-bold w-28 inline-block text-left pr-2 text-slate-500">${k}:</span><span>${v || 'NULL'}</span>`; content.appendChild(p); });
  const tpTitle = document.createElement('p'); tpTitle.className = 'font-bold text-slate-500 mt-2'; tpTitle.textContent = 'æ‰“å¡ç‚¹åˆ—è¡¨:'; content.appendChild(tpTitle);
  (currentRunData.target_points || []).forEach((p,i)=>{
    const name = (currentRunData.target_point_names||"").split('|')[i] || `æ‰“å¡ç‚¹${i+1}`;
    const div = document.createElement('div'); div.className = 'flex items-center gap-2 text-slate-600 ml-4';
    const numSpan = document.createElement('span'); numSpan.className = 'font-mono w-6 inline-block'; numSpan.textContent = `${i+1}.`;
    const nameSpan = document.createElement('span'); nameSpan.textContent = name;
    const coordsSpan = document.createElement('span'); coordsSpan.className = 'text-xs text-slate-400'; coordsSpan.textContent = `(${p[0].toFixed(5)}, ${p[1].toFixed(5)})`;
    div.append(numSpan, nameSpan, coordsSpan);
    content.appendChild(div);
  });
  toggleTaskDetails(true);
}


function toggleNotifications(show, forceDisableMap = false) {
  const modal = $('notifications-modal');
  modal.classList.toggle('hidden', !show);
  modal.classList.toggle('flex', show);

  const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;

  if (show) {
    // æ‰“å¼€æ¨¡æ€æ¡†ï¼šæ€»æ˜¯ç¦ç”¨åœ°å›¾
    if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
    document.body.classList.add('modal-visible');
  } else {
    // å…³é—­æ¨¡æ€æ¡†ï¼š
    if (forceDisableMap) {
      // å¦‚æœæ˜¯â€œæ‰‹åŠ¨é€‰ç‚¹â€è°ƒç”¨çš„ï¼Œä¿æŒåœ°å›¾ç¦ç”¨çŠ¶æ€
      if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
    } else {
      // å¦åˆ™ï¼ˆä¾‹å¦‚ç‚¹å‡»èƒŒæ™¯ã€å…³é—­æŒ‰é’®ï¼‰ï¼Œæ¢å¤åœ°å›¾
      if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
    }
    document.body.classList.remove('modal-visible');
  }
}

async function fetchNotifications() {
  const badge = $('notification-badge');
  let result = null; // <-- 1. å¿…é¡»åœ¨å‡½æ•°é¡¶éƒ¨å£°æ˜
  try {
    result = await callPythonAPI('get_notifications'); // <-- 2. åœ¨ try å—ä¸­èµ‹å€¼ (ä¸ä½¿ç”¨ const/let)
    
    // 3. æ£€æŸ¥ result æ˜¯å¦ä¸º null (é˜²æ­¢ç½‘ç»œé”™è¯¯)
    if (result && result.success) { 
      // æ›´æ–°å¾½ç« 
      if (result.unreadCount > 0) {
        badge.textContent = result.unreadCount > 9 ? '9+' : result.unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
      // ç¼“å­˜é€šçŸ¥æ•°æ®
      window.currentNotifications = result.notices || [];
    } else {
      badge.classList.add('hidden');
    }
  } catch (e) {
    console.error("Fetch notifications failed", e);
    badge.classList.add('hidden');
  }
  return result; // <-- 4. ç°åœ¨å¯ä»¥å®‰å…¨è¿”å›
}
async function refreshNotificationsUI() {
  // --- BUGä¿®å¤ï¼šé˜²æ­¢é‡å¤ç‚¹å‡» ---
  if (isRefreshingNotifications) {
      console.log("Notification refresh already in progress. Skipping.");
      return; // å¦‚æœå·²åœ¨åˆ·æ–°ï¼Œåˆ™ç›´æ¥é€€å‡º
  }
  isRefreshingNotifications = true; // è®¾ç½® "in-flight" æ ‡å¿—
  // --- ç»“æŸä¿®å¤ ---

  const content = $('notifications-content');
  const refreshBtn = $('refresh-notifications-btn');
  const markReadBtn = $('mark-all-read-btn');

  // 1. è®¾ç½®åŠ è½½çŠ¶æ€
  if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
  }
  if (markReadBtn) markReadBtn.disabled = true;
  content.innerHTML = '<p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½...</p>';

  try {
    const result = await fetchNotifications();
      // 2. å¼‚æ­¥è·å–æœ€æ–°æ•°æ®
      // fetchNotifications ä¼šæ›´æ–°å…¨å±€çš„ window.currentNotifications
      await fetchNotifications(); 
      
      // 3. ä¿®å¤Issue 3: ä½¿ç”¨æµå¼æ¸²æŸ“ï¼Œé€æ¡æ˜¾ç¤ºé€šçŸ¥è€Œä¸æ˜¯ç­‰å¾…å…¨éƒ¨å®Œæˆ
      content.innerHTML = ''; // æ¸…ç©º "æ­£åœ¨åŠ è½½..."
      const notices = window.currentNotifications || [];

      if (notices.length === 0) {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— é€šçŸ¥</p>';
          if (markReadBtn) markReadBtn.disabled = true;
      } else {
          let hasUnread = false;
          // ä½¿ç”¨requestAnimationFrameå’Œåˆ†æ‰¹æ¸²æŸ“æ¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
          let batchIndex = 0;
          const batchSize = 5; // æ¯æ‰¹æ¸²æŸ“5æ¡
          
          const renderBatch = () => {
            const start = batchIndex * batchSize;
            const end = Math.min(start + batchSize, notices.length);
            
            for (let i = start; i < end; i++) {
              const n = notices[i];
              const item = document.createElement('div');
              item.className = 'p-3 border-b border-slate-200';
              
              item.id = `notice-${n.id}`; // æ·»åŠ å”¯ä¸€ID
                  
              const isEffectivelyRead = (n.isRead == 1 || n.isRead === true);
              const isReadClass = isEffectivelyRead ? 'opacity-60' : 'font-bold';
                  
              // 1. â€œè®¾ä¸ºå·²è¯»â€æŒ‰é’®
              let readButtonHtml = '';
              if (!isEffectivelyRead) { 
                hasUnread = true;
                readButtonHtml = `<button class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600" onclick="markAsRead(event, '${n.id}')">è®¾ä¸ºå·²è¯»</button>`;
              }

              // 2. ç­¾åˆ°çŠ¶æ€/æŒ‰é’® (ä½¿ç”¨åç«¯æ–°é€»è¾‘)
              let attendanceHtml = '';
              const isAttendanceTask = (n.image === 'attendance') || (n.title && n.title.includes('ç­¾åˆ°'));
              
              if (isAttendanceTask && n.id) {
                // åç«¯å·²ç»é™„åŠ äº† attendance_code (-1=è¿‡æœŸ, 0=å¾…ç­¾, 1=å·²ç­¾)
                switch (n.attendance_code) {
                  case -1:
                    // --- æ–°ä»£ç  (case -1) ---
                    try {
                      const coordsStr = (n.updateBy || "").trim();
                      const [lat, lon] = coordsStr.split(',').map(Number);
                      if (isNaN(lon) || isNaN(lat)) throw new Error('åæ ‡æ— æ•ˆ');
                      const targetCoords = `[${lon}, ${lat}]`;
                      
                      attendanceHtml = `
                        <span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span>
                        <div class="relative inline-block group">
                          <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="è¡¥ç­¾æ­¤ä»»åŠ¡">
                            <span>è¡¥ç­¾</span>
                            <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                          </button>
                          <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                            <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">éšæœºè¡¥ç­¾</button>
                            <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾</button>
                          </div>
                        </div>
                      `;
                    } catch (e) {
                      attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span> <span class="text-xs text-slate-400">(åæ ‡æ— æ•ˆ)</span>`;
                    }
                    break;
                  case 1:
                    attendanceHtml = `<span class="text-xs font-semibold text-emerald-600 px-2 py-0.5 rounded-full bg-emerald-100">å·²ç­¾åˆ°</span>`;
                    break;
                  case 0:
                    // å¾…ç­¾åˆ°ï¼Œæ˜¾ç¤ºæŒ‰é’®
                    try {
                      // åæ ‡åœ¨ updateBy å­—æ®µï¼Œæ ¼å¼ä¸º "lat,lon"
                      const coordsStr = (n.updateBy || "").trim();
                      const [lat, lon] = coordsStr.split(',').map(Number);
                      
                      if (!isNaN(lon) && !isNaN(lat)) {
                        const rollCallId = n.id;
                        // JS API éœ€è¦ [lon, lat] æ ¼å¼
                        const targetCoords = `[${lon}, ${lat}]`; 
                        
                        // --- æ–°ä»£ç  (case 0, successful parse) ---
                        // ä¿ç•™åŸæœ‰çš„ç­¾åˆ°ä¸‹æ‹‰æ¡†ï¼Œå¹¶é¢å¤–æ·»åŠ ä¸€ä¸ªâ€œè¡¥ç­¾â€æŒ‰é’®
                        attendanceHtml = `
                          <div class="relative inline-block group">
                            <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                              <span>ç­¾åˆ°</span>
                              <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                            </button>
                            <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                              <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${rollCallId}', ${targetCoords})">éšæœºç­¾åˆ°</button>
                              <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${rollCallId}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹</button>
                            </div>
                          </div>
                          <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${rollCallId}', ${targetCoords})">
                            è¡¥ç­¾
                          </button>
                        `;
                      } else {
                        attendanceHtml = `<span class="text-xs text-slate-400">åæ ‡æ— æ•ˆ</span>`;
                      }
                    } catch (e) {
                      console.error("è§£æç­¾åˆ°åæ ‡å¤±è´¥:", e, n.updateBy);
                      attendanceHtml = `<span class="text-xs text-red-500">æ•°æ®é”™è¯¯</span>`;
                    }
                    break;
                  default:
                    // (status_code æœªçŸ¥)
                    attendanceHtml = `<span class="text-xs text-slate-400">çŠ¶æ€æœªçŸ¥</span>`;
                }
              }
              
              // 3. ç»„è£…
              item.innerHTML = `
                <div class="flex justify-between items-center">
                  <span class="text-base text-slate-800 ${isReadClass}">${n.title}</span>
                  <div class="flex items-center gap-2">
                    ${readButtonHtml}
                    ${attendanceHtml}
                    <span class="text-xs text-slate-500 flex-shrink-0">${n.createtime}</span>
                  </div>
                </div>
                <p class="text-sm text-slate-600 mt-1 ${isReadClass}">${n.content}</p>
              `;
              content.appendChild(item);
              
              if (!isEffectivelyRead) hasUnread = true;
            }
            
            batchIndex++;
            if (end < notices.length) {
              // è¿˜æœ‰æ›´å¤šé€šçŸ¥ï¼Œç»§ç»­æ¸²æŸ“ä¸‹ä¸€æ‰¹
              requestAnimationFrame(renderBatch);
            } else {
              // æ¸²æŸ“å®Œæˆ
              if (markReadBtn) markReadBtn.disabled = !hasUnread;
            }
          };
          
          // å¼€å§‹ç¬¬ä¸€æ‰¹æ¸²æŸ“
          renderBatch();
      }
      // 4. æ˜¾å¼è°ƒç”¨ onNotificationsUpdated æ¥åˆ·æ–°â€œç­¾åˆ°â€Tab
      //    å› ä¸ºå®ƒåŒ…å«æ¸²æŸ“ attendance-list çš„é€»è¾‘
      if (result && result.success) {
          onNotificationsUpdated(result);
      }
  } catch (e) {
      console.error("Failed to refresh notifications UI", e);
      content.innerHTML = '<p class="text-red-500 text-center py-10">åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
  } finally {
      // 4. æ¢å¤æŒ‰é’®çŠ¶æ€
      if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'åˆ·æ–°';
      }
      if (markReadBtn) {
           // å†æ¬¡æ£€æŸ¥æœ€æ–°çš„æœªè¯»çŠ¶æ€
           const hasUnread = (window.currentNotifications || []).some(n => n.isRead == 0 || n.isRead === false);
           markReadBtn.disabled = !hasUnread;
      }
      isRefreshingNotifications = false;
  }
}

function showNotifications() {
  // 1. æ‰“å¼€æ¨¡æ€æ¡†
  toggleNotifications(true);
  
  // 2. è§¦å‘UIåˆ·æ–°ï¼ˆè¿™ä¸ªæ–°å‡½æ•°ä¼šå¤„ç†åŠ è½½ã€è·å–æ•°æ®å’Œæ¸²æŸ“ï¼‰
  refreshNotificationsUI();
}

/**
 * ç”±åç«¯è‡ªåŠ¨åˆ·æ–°çº¿ç¨‹è°ƒç”¨
 * @param {object} result - åç«¯ get_notifications è¿”å›çš„ç»“æœ
 */
function onNotificationsUpdated(result) {
  if (!result || !result.success) {
    logMessage("[åå°åˆ·æ–°] è·å–é€šçŸ¥å¤±è´¥");
    return;
  }
  
  logMessage(`[åå°åˆ·æ–°] æ”¶åˆ° ${result.unreadCount} æœªè¯», ${result.notices.length} æ€»æ•°`);

  // 1. æ›´æ–°è§’æ ‡
  const badge = $('notification-badge');
  if (result.unreadCount > 0) {
    badge.textContent = result.unreadCount > 9 ? '9+' : result.unreadCount;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
  
  // 2. ç¼“å­˜æœ€æ–°æ•°æ®
  window.currentNotifications = result.notices || [];

  // 3. æ¸²æŸ“â€œç­¾åˆ°â€Tab (å¦‚æœè¯¥Tabå­˜åœ¨)
  const attList = $('attendance-list');
  if (attList) {
    attList.innerHTML = '';
    const attendanceNotices = (window.currentNotifications || []).filter(n => 
      n.image === 'attendance' || (n.title && n.title.includes('ç­¾åˆ°'))
    );
    
    if (attendanceNotices.length === 0) {
      attList.innerHTML = '<p class="text-slate-400 text-center py-10 text-xs">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>';
    } else {
      attendanceNotices.forEach(n => {
        const item = document.createElement('div');
        item.className = 'p-2 border-b border-slate-100';
        
        let statusText = 'æœªçŸ¥';
        let statusClass = 'text-slate-500';
        let buttonHtml = ''; // --- æ–°å¢ï¼šç”¨äºå­˜æ”¾æŒ‰é’® ---
        
        // --- æå–åæ ‡è§£æé€»è¾‘ï¼Œä¾›æŒ‰é’®ä½¿ç”¨ ---
        let targetCoords = 'null';
        let canSign = false;
        try {
          const coordsStr = (n.updateBy || "").trim();
          const [lat, lon] = coordsStr.split(',').map(Number);
          if (!isNaN(lon) && !isNaN(lat)) {
            targetCoords = `[${lon}, ${lat}]`;
            canSign = true;
          }
        } catch (e) {}

        // ä½¿ç”¨åç«¯é™„åŠ çš„ attendance_code
        switch (n.attendance_code) {
          case -1:
            statusText = 'å·²è¿‡æœŸ'; statusClass = 'text-red-600 font-semibold';
            // --- æ–°å¢ï¼šæ·»åŠ è¡¥ç­¾æŒ‰é’® ---
            if (canSign) {
              buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="è¡¥ç­¾æ­¤ä»»åŠ¡">
                    <span>è¡¥ç­¾</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">éšæœºè¡¥ç­¾</button>
                    <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾</button>
                  </div>
                </div>
              `;
            }
            break;
          case 1:
            statusText = 'å·²ç­¾åˆ°'; statusClass = 'text-emerald-600 font-semibold';
            // (å·²ç­¾åˆ°ï¼Œæ— éœ€æŒ‰é’®)
            break;
          case 0:
            statusText = 'å¾…ç­¾åˆ°'; statusClass = 'text-sky-600 font-bold';
            // æ–°å¢ï¼šæ·»åŠ ç­¾åˆ°å’Œè¡¥ç­¾æŒ‰é’®
            if (canSign) {
              // (ä¸ºç®€æ´ï¼Œç­¾åˆ°Tabåªæ”¾éšæœºç­¾åˆ°å’Œè¡¥ç­¾)
              // ä¸é€šçŸ¥æ¨¡æ€æ¡†ä¿æŒä¸€è‡´ï¼Œä¸ºâ€œç­¾åˆ°â€æŒ‰é’®æ·»åŠ ä¸‹æ‹‰èœå•
              buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                    <span>ç­¾åˆ°</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${n.id}', ${targetCoords})">éšæœºç­¾åˆ°</button>
                    <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹</button>
                  </div>
                </div>
                <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                  è¡¥ç­¾
                </button>
              `;
            }
            break;
          default:
            statusText = 'çŠ¶æ€æœªçŸ¥'; statusClass = 'text-slate-400';
        }
        
        // å¦‚æœæ˜¯è‡ªåŠ¨ç­¾åˆ°å¤±è´¥
        if (n.attendance_status_text && n.attendance_status_text.includes('å¤±è´¥')) {
            statusText = n.attendance_status_text;
            statusClass = 'text-red-700 font-bold';
        }

        // --- æ–°ä»£ç  (innerHTML) ---
        item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-sm font-semibold text-slate-700">${n.title}</span>
            <span class="text-xs ${statusClass} flex-shrink-0">${statusText}</span>
          </div>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-slate-500">${n.content}</span>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-slate-400">${n.createtime}</span>
              ${buttonHtml}
            </div>
          </div>
        `;
        attList.appendChild(item);
      });
    }
  }

  // 4. (å¯é€‰) å¦‚æœé€šçŸ¥æ¨¡æ€æ¡†å½“å‰æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°å®ƒ
  const modal = $('notifications-modal');
  if (modal && !modal.classList.contains('hidden')) {
    refreshNotificationsUI();
  }
}

// --- å¤„ç†ç­¾åˆ°ç‚¹å‡»çš„å‡½æ•° ---
async function handleAttendance(event, rollCallId, targetCoords) {
  event.stopPropagation();
  logMessage(`æ­£åœ¨ä¸ºæ‚¨è‡ªåŠ¨ç­¾åˆ°... æ´»åŠ¨ID: ${rollCallId}`);
  // è°ƒç”¨åç«¯éšæœºç­¾åˆ° (location_choice='random', specific_coords=null, is_makeup=false)
  const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'random', null, false);
  if (result.success) {
    logMessage(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
    showModalAlert(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
  } else {
    logMessage(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
    showModalAlert(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
  }
  // ç­¾åˆ°ååˆ·æ–°é€šçŸ¥åˆ—è¡¨çŠ¶æ€
  await fetchNotifications();
  showNotifications();
}

const svgIconNormal = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path fill="#22d3ee" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

const svgIconMakeup = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path fill="#f59e0b" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

async function handleManualAttendance(event, rollCallId, targetCoords) {
  event.stopPropagation();
  // å…³é”®ä¿®å¤ï¼šä¼ å…¥ 'true'ï¼Œå‘Šè¯‰ toggleNotifications åœ¨å…³é—­åä¿æŒåœ°å›¾ç¦ç”¨
  toggleNotifications(false, true); 
  
  // ä¿®å¤Issue 4: æ¸…ç©ºå½“å‰ä»»åŠ¡é€‰æ‹©ä»¥æ¸…é™¤åœ°å›¾é®æŒ¡ç‰©
  selectedTaskIndex = -1;
  renderTaskList();
  drawOnMap();
  
  logMessage("è¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰æ‹©ç­¾åˆ°ç‚¹...");

  // --- 1. æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§æ ‡è®° ---
  if (tempAttendanceMarker && map) {
    map.remove(tempAttendanceMarker);
    tempAttendanceMarker = null;
  }
  if (tempAttendanceCircle && map) {
    map.remove(tempAttendanceCircle);
    tempAttendanceCircle = null;
  }

      // --- 2. è·å–åæ ‡å’ŒåŠå¾„ ---
      const radius = (currentUserData && currentUserData.server_attendance_radius_m) ? currentUserData.server_attendance_radius_m : 0.0;
      const position = new AMapInstance.LngLat(targetCoords[0], targetCoords[1]);


  // --- 3. ç»˜åˆ¶ç³»ç»Ÿç­¾åˆ°ç‚¹æ ‡è®° (è€å¸ˆçš„ä½ç½®) ---
  tempAttendanceMarker = new AMapInstance.Marker({
    position: position,
    content: svgIconNormal, 
    clickable: false,
    anchor: 'bottom-center',
    zIndex: 200
  });

  // --- 4. ç»˜åˆ¶ç­¾åˆ°èŒƒå›´åœ†åœˆ ---
  tempAttendanceCircle = new AMapInstance.Circle({
    center: position,
    radius: radius,
    strokeColor: "#00BFFF", 
    strokeOpacity: 1,
    strokeWeight: 2,
    fillColor: "#00BFFF",    
    fillOpacity: 0.2,
    zIndex: 199,
    bubble: true,
    clickable: false
  });

  map.add(tempAttendanceMarker);
  map.add(tempAttendanceCircle);
  
  // --- 5. ç¼©æ”¾å¹¶å±…ä¸­åˆ°è¯¥åŒºåŸŸ ---
  map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]); 

  // --- 6. æç¤ºç”¨æˆ·ç‚¹å‡»åœ°å›¾ ---
  const infoMarker = new AMapInstance.Text({
    text: 'å·²æ˜¾ç¤ºç­¾åˆ°åŒºåŸŸï¼Œè¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹',
    position: position, 
    anchor: 'bottom-center',
    offset: new AMapInstance.Pixel(0, -40), 
    clickable: false,
    style: { 
      'background-color': '#fff', 
      'padding': '5px 10px', 
      'border-radius': '5px', 
      'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
      'pointer-events': 'none' 
    }
  });
  map.add(infoMarker);

  // --- 7. ç›‘å¬ä¸€æ¬¡åœ°å›¾å•å‡»äº‹ä»¶ (åŒ…å«è·ç¦»æ ¡éªŒå’ŒçŠ¶æ€æ¢å¤) ---
  const onMapClick = async (e) => {
    map.off('click', onMapClick); 
    map.remove(infoMarker); 
    
    const clickedLngLat = e.lnglat;
    const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];
    
    // --- è·ç¦»åˆ¤æ–­ (ä¸Šæ¬¡çš„ä¿®å¤) ---
    const distance = fastDistanceMeters(clickedLngLat.lng, clickedLngLat.lat, targetCoords[0], targetCoords[1]);
    
    if (distance > radius) {
        logMessage(`é€‰ç‚¹å¤±è´¥ï¼šè·ç¦» ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`);
        showModalAlert('æ‚¨é€‰æ‹©çš„ç‚¹ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼Œè¯·é‡æ–°åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ã€‚', 'é€‰ç‚¹æ— æ•ˆ');
        
        // é‡æ–°æ˜¾ç¤ºæç¤ºå¹¶é‡æ–°ç»‘å®šç›‘å¬ (åœ°å›¾ä»å¤„äºâ€œé€‰ç‚¹æ¨¡å¼â€)
        map.add(infoMarker);
        map.on('click', onMapClick); 
        return; 
    }
    // --- è·ç¦»åˆ¤æ–­ç»“æŸ ---

    logMessage(`å·²é€‰æ‹©ç­¾åˆ°ç‚¹: ${specificCoords.join(', ')} (è·ç¦» ${distance.toFixed(1)}m)`);
    
    try {
      const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'specific', specificCoords, false);
      if (result.success) {
        logMessage(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
        showModalAlert(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
      } else {
        logMessage(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
        showModalAlert(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
      }
    } catch (err) {
      logMessage(`ç­¾åˆ°æ—¶å‘ç”ŸJSé”™è¯¯: ${err}`);
    } finally {
      // --- 8. æ¸…ç†è¦†ç›–ç‰© ---
      if (tempAttendanceMarker && map) {
        map.remove(tempAttendanceMarker);
        tempAttendanceMarker = null;
      }
      if (tempAttendanceCircle && map) {
        map.remove(tempAttendanceCircle);
        tempAttendanceCircle = null;
      }

      // --- å…³é”®ä¿®å¤ï¼šæ¢å¤åœ°å›¾äº¤äº’çŠ¶æ€ ---
      if (map) {
        map.setStatus({
          dragEnable: true,
          scrollWheel: true,
          doubleClickZoom: true
        });
      }
      
      await fetchNotifications();
    }
  };
  
  map.on('click', onMapClick);
}


async function handleMakeupAttendance(event, rollCallId, targetCoords) {
  event.stopPropagation();
  logMessage(`æ­£åœ¨ä¸ºæ‚¨ [è¡¥ç­¾]... æ´»åŠ¨ID: ${rollCallId}`);
  
  // è°ƒç”¨åç«¯éšæœºç­¾åˆ°ï¼Œå¹¶æ˜ç¡®ä¼ é€’ is_makeup=True
  // ç­¾å: trigger_attendance(rollCallId, targetCoords, location_choice, specific_coords, is_makeup)
  const result = await callPythonAPI('trigger_attendance', 
    rollCallId, 
    targetCoords, 
    'random',   // location_choice
    null,       // specific_coords
    true        // is_makeup
  );

  if (result.success) {
    logMessage(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
    showModalAlert(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
  } else {
    logMessage(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
    showModalAlert(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
  }
  // è¡¥ç­¾ååˆ·æ–°é€šçŸ¥åˆ—è¡¨çŠ¶æ€
  await fetchNotifications();
  // é‡æ–°æ‰“å¼€é€šçŸ¥æ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
  showNotifications();
}

// --- æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾å‡½æ•° ---
async function handleManualMakeupAttendance(event, rollCallId, targetCoords) {
  event.stopPropagation();
  // å…³é”®ä¿®å¤ï¼šä¼ å…¥ 'true'ï¼Œå‘Šè¯‰ toggleNotifications åœ¨å…³é—­åä¿æŒåœ°å›¾ç¦ç”¨
  toggleNotifications(false, true); 
  
  // ä¿®å¤Issue 4: æ¸…ç©ºå½“å‰ä»»åŠ¡é€‰æ‹©ä»¥æ¸…é™¤åœ°å›¾é®æŒ¡ç‰©
  selectedTaskIndex = -1;
  renderTaskList();
  drawOnMap();
  
  logMessage("è¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰æ‹© [è¡¥ç­¾] ç‚¹...");

  // --- 1. æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§æ ‡è®° ---
  if (tempAttendanceMarker && map) {
    map.remove(tempAttendanceMarker);
    tempAttendanceMarker = null;
  }
  if (tempAttendanceCircle && map) {
    map.remove(tempAttendanceCircle);
    tempAttendanceCircle = null;
  }

  // --- 2. è·å–åæ ‡å’ŒåŠå¾„ ---
  const radius = (currentUserData && currentUserData.server_attendance_radius_m) ? currentUserData.server_attendance_radius_m : 0.0;
  const position = new AMapInstance.LngLat(targetCoords[0], targetCoords[1]);
  logMessage(`ç³»ç»Ÿç­¾åˆ°ç‚¹: ${targetCoords[0]}, ${targetCoords[1]} (åŠå¾„: ${radius}ç±³)`);

  // --- 3. ç»˜åˆ¶ç³»ç»Ÿç­¾åˆ°ç‚¹æ ‡è®° (è€å¸ˆçš„ä½ç½®) ---
  tempAttendanceMarker = new AMapInstance.Marker({
    position: position,
    content: svgIconMakeup, // ä½¿ç”¨æ©™è‰²SVG
    clickable: false,
    anchor: 'bottom-center',
    zIndex: 200
  });

  // --- 4. ç»˜åˆ¶ç­¾åˆ°èŒƒå›´åœ†åœˆ (ä½¿ç”¨è¡¥ç­¾çš„) ---
  tempAttendanceCircle = new AMapInstance.Circle({
    center: position,
    radius: radius,
    strokeColor: "#F7B731", 
    strokeOpacity: 1,
    strokeWeight: 2,
    fillColor: "#F7B731",    
    fillOpacity: 0.2,
    zIndex: 199,
    bubble: true, 
    clickable: false
  });

  map.add(tempAttendanceMarker);
  map.add(tempAttendanceCircle);
  
  // --- 5. ç¼©æ”¾å¹¶å±…ä¸­åˆ°è¯¥åŒºåŸŸ ---
  map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);

  // --- 6. æç¤ºç”¨æˆ·ç‚¹å‡»åœ°å›¾ ---
  const infoMarker = new AMapInstance.Text({
    text: 'å·²æ˜¾ç¤ºç­¾åˆ°åŒºåŸŸï¼Œè¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ [è¡¥ç­¾]',
    position: position,
    anchor: 'bottom-center',
    offset: new AMapInstance.Pixel(0, -40), 
    clickable: false,
    style: { 
      'background-color': '#fff', 
      'padding': '5px 10px', 
      'border-radius': '5px', 
      'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
      'pointer-events': 'none'
    }
  });
  map.add(infoMarker);

  // --- 7. ç›‘å¬ä¸€æ¬¡åœ°å›¾å•å‡»äº‹ä»¶ (åŒ…å«è·ç¦»æ ¡éªŒå’ŒçŠ¶æ€æ¢å¤) ---
  const onMapClick = async (e) => {
    map.off('click', onMapClick); 
    map.remove(infoMarker); 
    
    const clickedLngLat = e.lnglat;
    const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];

    // --- è·ç¦»åˆ¤æ–­ (ä¸Šæ¬¡çš„ä¿®å¤) ---
    const distance = fastDistanceMeters(clickedLngLat.lng, clickedLngLat.lat, targetCoords[0], targetCoords[1]);
    
    if (distance > radius) {
        logMessage(`[è¡¥ç­¾] é€‰ç‚¹å¤±è´¥ï¼šè·ç¦» ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`);
        showModalAlert('æ‚¨é€‰æ‹©çš„ç‚¹ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼Œè¯·é‡æ–°åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ã€‚', 'é€‰ç‚¹æ— æ•ˆ');
        
        // é‡æ–°æ˜¾ç¤ºæç¤ºå¹¶é‡æ–°ç»‘å®šç›‘å¬ (åœ°å›¾ä»å¤„äºâ€œé€‰ç‚¹æ¨¡å¼â€)
        map.add(infoMarker);
        map.on('click', onMapClick); 
        return; 
    }
    // --- è·ç¦»åˆ¤æ–­ç»“æŸ ---

    logMessage(`å·²é€‰æ‹© [è¡¥ç­¾] ç‚¹: ${specificCoords.join(', ')} (è·ç¦» ${distance.toFixed(1)}m)`);
    
    try {
      const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'specific', specificCoords, true);
      if (result.success) {
        logMessage(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
        showModalAlert(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
      } else {
        logMessage(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
        showModalAlert(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
      }
    } catch (err) {
      logMessage(`è¡¥ç­¾æ—¶å‘ç”ŸJSé”™è¯¯: ${err}`);
    } finally {
      // --- 8. æ¸…ç†è¦†ç›–ç‰© ---
      if (tempAttendanceMarker && map) {
        map.remove(tempAttendanceMarker);
        tempAttendanceMarker = null;
      }
      if (tempAttendanceCircle && map) {
        map.remove(tempAttendanceCircle);
        tempAttendanceCircle = null;
      }

      // --- å…³é”®ä¿®å¤ï¼šæ¢å¤åœ°å›¾äº¤äº’çŠ¶æ€ ---
      if (map) {
        map.setStatus({
          dragEnable: true,
          scrollWheel: true,
          doubleClickZoom: true
        });
      }
      
      await fetchNotifications();
    }
  };
  
  map.on('click', onMapClick);
}


async function markAsRead(event, noticeId) {
    event.stopPropagation(); // é˜²æ­¢ç‚¹å‡»ç©¿é€
    
    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '...';

    try {
        const result = await callPythonAPI('mark_notification_read', noticeId);
        if (result.success) {
            // æˆåŠŸåï¼Œé‡æ–°ä»æœåŠ¡å™¨è·å–æœ€æ–°åˆ—è¡¨
            // è¿™æ˜¯æœ€å¯é çš„æ–¹å¼ï¼Œèƒ½è‡ªåŠ¨æ›´æ–°è§’æ ‡å’Œåˆ—è¡¨çŠ¶æ€
            await fetchNotifications();
            // é‡æ–°æ¸²æŸ“æ¨¡æ€æ¡†å†…éƒ¨
            showNotifications();
        } else {
            showModalAlert(result.message || 'æ ‡è®°å·²è¯»å¤±è´¥');
            btn.disabled = false;
            btn.textContent = 'è®¾ä¸ºå·²è¯»';
        }
    } catch (e) {
        console.error("markAsRead failed:", e);
        btn.disabled = false;
        btn.textContent = 'è®¾ä¸ºå·²è¯»';
    }
}

/**
 * æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
 */
async function markAllAsRead() {
    const btn = $('mark-all-read-btn');
    btn.disabled = true;
    btn.textContent = 'å¤„ç†ä¸­...';

    // æ‰¾å‡ºæ‰€æœ‰æœªè¯»é€šçŸ¥
    const unreadNotices = (window.currentNotifications || []).filter(n => !n.isRead);
    if (unreadNotices.length === 0) {
        btn.textContent = 'ä¸€é”®å·²è¯»';
        return;
    }

    try {
        // å¹¶è¡Œå‘é€æ‰€æœ‰â€œè®¾ä¸ºå·²è¯»â€è¯·æ±‚
        const promises = unreadNotices.map(n => 
            callPythonAPI('mark_notification_read', n.id)
        );
        await Promise.all(promises);
        
        // å…¨éƒ¨å®Œæˆåï¼ˆæ— è®ºæ˜¯å¦å…¨éƒ¨æˆåŠŸï¼‰ï¼Œéƒ½ç»Ÿä¸€åˆ·æ–°ä¸€æ¬¡
        logMessage(`â€œä¸€é”®å·²è¯»â€æ“ä½œå®Œæˆï¼Œå…±å¤„ç† ${unreadNotices.length} æ¡ã€‚`);

    } catch (e) {
        console.error("markAllAsRead failed:", e);
        logMessage(`â€œä¸€é”®å·²è¯»â€æ—¶å‘ç”Ÿé”™è¯¯: ${e}`);
    } finally {
        // æœ€ç»ˆï¼Œä»æœåŠ¡å™¨æ‹‰å–æœ€æ–°çŠ¶æ€
        await fetchNotifications();
        // é‡æ–°æ¸²æŸ“æ¨¡æ€æ¡†
        showNotifications();
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = (window.currentNotifications || []).filter(n => !n.isRead).length === 0;
        btn.textContent = 'ä¸€é”®å·²è¯»';
    }
}

$('multi-remove-all-btn').addEventListener('click', multi_removeAll);
$('multi-remove-selected-btn').addEventListener('click', multi_removeSelected);
$('multi-refresh-all-btn').addEventListener('click', multi_refreshAll);
$('multi-select-all-check').addEventListener('change', multi_toggleSelectAll);
$('multi-start-selected-btn').addEventListener('click', multi_startSelected);
$('multi-stop-selected-btn').addEventListener('click', multi_stopSelected);
$('multi-refresh-selected-btn').addEventListener('click', multi_refreshSelected);

</script>
</body>
</html>