<!DOCTYPE html>
<html lang="zh-CN">

<head>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" onerror="handleCdnError('Socket.IO')"></script>
  <meta charset="UTF-8">
  <title>è·‘æ­¥åŠ©æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com" onerror="handleCdnError()"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@600;700&family=Noto+Sans+SC:wght@400;600;700&display=swap"
    rel="stylesheet" onerror="handleCdnError()">

  <script src="https://webapi.amap.com/loader.js" onerror="handleCdnError()"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script>
    // é…ç½®TailwindCSS
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'sans': ['Noto Sans SC', 'system-ui', 'sans-serif'], 'display': ['Zilla Slab', 'serif'] },
          colors: { 'base': '#7dd3fc' }
        }
      }
    }
  </script>
  <style>
    /* CSSå˜é‡å®šä¹‰ */



    /* é»˜è®¤ä¸»é¢˜ï¼ˆæ— éœ€é¢å¤– classï¼‰ */
    body {
      background: linear-gradient(180deg, rgba(245, 250, 255, 1) 0%, rgba(235, 245, 255, 1) 40%, rgba(250, 240, 255, 1) 100%);
      background-attachment: fixed;

    }

    .panel {
      backdrop-filter: blur(16px);
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.45);
      box-shadow: 0 10px 24px rgba(16, 24, 40, 0.12);
    }

    /* äºŒæ¬¡å…ƒä¸»é¢˜ */
    body.theme-anime {
      /* æ·»åŠ ä¸€å¼ èƒŒæ™¯å›¾ï¼Œæ‚¨å¯ä»¥æ›¿æ¢ä¸ºæ‚¨å–œæ¬¢çš„å›¾ç‰‡URL */
      background-image: url('https://api.paugram.com/wallpaper');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    body.theme-anime .panel {
      /* é¢æ¿ä½¿ç”¨æ›´å¼ºçƒˆçš„æ¯›ç»ç’ƒæ•ˆæœ */
      background-color: rgba(255, 255, 255, 0.65);
      /* é™ä½ä¸é€æ˜åº¦ */
      backdrop-filter: blur(20px) saturate(150%);
      /* å¢å¼ºæ¨¡ç³Šå’Œé¥±å’Œåº¦ */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }

    /* ç®€çº¦ä¸»é¢˜ */
    body.theme-minimalist {
      background: #f8f9fa;
      /* ä½¿ç”¨çº¯è‰²èƒŒæ™¯ */
    }

    body.theme-minimalist .panel {
      background-color: #ffffff;
      backdrop-filter: none;
      /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
      border: 1px solid #e9ecef;
      /* ä½¿ç”¨æ›´æŸ”å’Œçš„è¾¹æ¡† */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      /* ä½¿ç”¨æ›´ç»†å¾®çš„é˜´å½± */
      border-radius: 12px;
      /* ç¨å¾®å‡å°åœ†è§’ */
    }

    /* ä¸‹æ‹‰é€‰æ‹©æ¡†æ–‡æœ¬ä¸æ¢è¡Œï¼Œé¿å…å¤šè¡ŒæŒ¤å‹å¯¼è‡´â€œçœ‹èµ·æ¥ä¸é½å…¨â€ */
    #multi-config-user-select {
      white-space: nowrap;
      /* æ–‡æœ¬ä¸æŠ˜è¡Œ */
      overflow-x: auto;
      max-width: 100%;
      /* çº¦æŸä¸ºå®¹å™¨å®½åº¦ï¼Œé¿å…æ’‘ç ´å¸ƒå±€ */
    }


    select.select-field {
      padding: 0.45rem 0.6rem;
    }

    #multi-config-user-select option {
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* æ¨¡æ€æ¡†èƒŒæ™¯ */

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      /* å…è®¸èƒŒæ™¯é®ç½©å±‚äº¤äº’ï¼Œé˜»æŒ¡ä¸‹æ–¹ç‚¹å‡» */
      background-color: rgba(0, 0, 0, 0.4);
      /* æ·»åŠ åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
      /* display å°†ç”± JS æ§åˆ¶ä¸º 'flex' ä»¥å®ç°å±…ä¸­ */
      align-items: center;
      justify-content: center;
    }


    /* å†…å®¹å®¹å™¨ï¼šå±…ä¸­æ˜¾ç¤º */
    .modal-content {
      background: linear-gradient(135deg, #ffffff, #f7f9ff);
      /* margin: 10% auto;  <-- ç§»é™¤æ­¤è¡Œä»¥å…è®¸ Flexbox å‚ç›´å±…ä¸­ */
      padding: 24px 28px;
      border-radius: 16px;
      width: 360px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25),
        0 0 12px rgba(120, 160, 255, 0.4);
      animation: fadeIn 0.35s ease, scaleIn 0.35s ease;
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
      position: relative;
      pointer-events: auto;
      /* å†…å®¹å¯äº¤äº’ */
    }

    /* æ ‡é¢˜ */
    .modal-content h3 {
      margin-top: 0;
      text-align: center;
      font-size: 20px;
      color: #3a4a7a;
      letter-spacing: 1px;
    }

    /* å…³é—­æŒ‰é’® */
    .close {
      position: absolute;
      right: 14px;
      top: 10px;
      font-size: 22px;
      cursor: pointer;
      color: #888;
      transition: color 0.2s;
    }

    .close:hover {
      color: #ff5c8a;
    }

    /* è¡¨å• */
    .form-group {
      margin: 14px 0;
    }

    .form-group label {
      display: inline-block;
      width: 70px;
      font-weight: bold;
      color: #4a4a6a;
    }

    .form-group input {
      width: 230px;
      padding: 8px 10px;
      border: 1px solid #ccd2f0;
      border-radius: 8px;
      outline: none;
      transition: all 0.25s;
      background: #fff;
    }

    .form-group input:focus {
      border-color: #7a9dff;
      box-shadow: 0 0 6px rgba(122, 157, 255, 0.6);
    }

    /* åº•éƒ¨æŒ‰é’® */
    .modal-actions {
      text-align: right;
      margin-top: 18px;
    }

    .modal-actions button {
      margin-left: 10px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s;
    }

    #newUserCancel {
      background: #e0e4f7;
      color: #444;
    }

    #newUserCancel:hover {
      background: #d0d6f0;
    }

    #newUserConfirm {
      background: linear-gradient(135deg, #7a9dff, #5c7cff);
      color: #fff;
      box-shadow: 0 3px 8px rgba(92, 124, 255, 0.4);
    }

    #newUserConfirm:hover {
      background: linear-gradient(135deg, #5c7cff, #4a68e0);
      box-shadow: 0 4px 10px rgba(92, 124, 255, 0.55);
    }

    /* åŠ¨ç”» */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.9);
      }

      to {
        transform: scale(1);
      }
    }



    :root {
      --base-color: #7dd3fc;
      --base-color-600: #0891b2;
      --base-color-500: #22d3ee;
      --base-color-300: #a5f3fc;
      --card-bg: rgba(255, 255, 255, 0.85);
      --glass: rgba(255, 255, 255, 0.65);
      --ink: #0f172a;
    }

    html,
    body {
      height: 100%;
    }

    body {
      background: linear-gradient(180deg, rgba(245, 250, 255, 1) 0%, rgba(235, 245, 255, 1) 40%, rgba(250, 240, 255, 1) 100%);
      background-attachment: fixed;
    }

    .bg-anime {
      background-image: url('');
      background-size: cover;
      background-position: center;
    }

    .panel {
      backdrop-filter: blur(16px);
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.45);
      box-shadow: 0 10px 24px rgba(16, 24, 40, 0.12);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      padding: .65rem 1rem;
      border-radius: 999px;
      font-weight: 700;
      transition: all .25s ease;
      box-shadow: 0 6px 16px rgba(2, 132, 199, .15);
    }

    .btn:hover {
      /* transform: translateY(-1px); */
      /* æŒ‰é’®æ²¡äº‹ä¸è¦çç§»åŠ¨ */
      transform: none;
      box-shadow: 0 12px 28px rgba(2, 132, 199, .22);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      color: #fff;
      background: linear-gradient(135deg, var(--base-color), var(--base-color-600));
    }

    .btn-secondary {
      color: #fff;
      background: linear-gradient(135deg, #a855f7, #7c3aed);
    }

    .btn-danger {
      color: #fff;
      background: linear-gradient(135deg, #ef4444, #b91c1c);
    }

    .btn-warning {
      color: #fff;
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .btn-success {
      color: #fff;
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .btn-ghost {
      color: #334155;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .input-field,
    .select-field {
      width: 100%;
      border-radius: 14px;
      padding: .7rem .9rem;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 8px 14px rgba(16, 24, 40, 0.06);
      color: #0f172a;
      transition: box-shadow .2s ease, border-color .2s ease;
    }

    .input-field:focus,
    .select-field:focus {
      outline: none;
      border-color: var(--base-color-600);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, .25);
    }

    /* +86å‰ç¼€å®¹å™¨æ ·å¼ - è®©è¾“å…¥æ¡†å’Œå‰ç¼€çœ‹èµ·æ¥åƒä¸€ä¸ªæ•´ä½“ */
    .phone-input-wrapper {
      /* ä½¿ç”¨flexå¸ƒå±€ï¼Œå°†å‰ç¼€å’Œè¾“å…¥æ¡†æ¨ªå‘æ’åˆ— */
      display: flex;
      align-items: center;
      /* å‚ç›´å±…ä¸­å¯¹é½ */
      width: 100%;
      /* å æ»¡çˆ¶å®¹å™¨å®½åº¦ */
      border-radius: 14px;
      /* ä¸input-fieldä¿æŒä¸€è‡´çš„åœ†è§’ */
      /* ä½¿ç”¨ä¸input-fieldç›¸åŒçš„èƒŒæ™¯æ¸å˜æ•ˆæœ */
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
      border: 1px solid rgba(148, 163, 184, 0.35);
      /* ä¸input-fieldä¸€è‡´çš„è¾¹æ¡† */
      /* ä¸input-fieldä¸€è‡´çš„é˜´å½±æ•ˆæœ */
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 8px 14px rgba(16, 24, 40, 0.06);
      transition: box-shadow .2s ease, border-color .2s ease;
      /* å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”» */
      overflow: hidden;
      /* éšè—æº¢å‡ºå†…å®¹ï¼Œä¿æŒåœ†è§’å®Œæ•´ */
    }

    /* å½“å†…éƒ¨è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œæ•´ä¸ªå®¹å™¨ä¹Ÿè¦æ˜¾ç¤ºç„¦ç‚¹æ ·å¼ */
    .phone-input-wrapper:focus-within {
      border-color: var(--base-color-600);
      /* ç„¦ç‚¹æ—¶çš„è¾¹æ¡†é¢œè‰² */
      box-shadow: 0 0 0 3px rgba(34, 211, 238, .25);
      /* ç„¦ç‚¹æ—¶çš„å¤–å‘å…‰æ•ˆæœ */
    }

    /* +86å‰ç¼€æ ‡ç­¾æ ·å¼ - æ˜¾ç¤ºä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç  */
    .phone-prefix {
      /* å†…è¾¹è·ï¼šå·¦å³0.9remä¸input-fieldä¿æŒä¸€è‡´ï¼Œä¸Šä¸‹ä½¿ç”¨.7rem */
      padding: .7rem 0 .7rem .9rem;
      color: #64748b;
      /* ä½¿ç”¨ç¨æµ…çš„é¢œè‰²åŒºåˆ†å‰ç¼€å’Œç”¨æˆ·è¾“å…¥ */
      font-weight: 500;
      /* ä¸­ç­‰å­—é‡ */
      user-select: none;
      /* ç¦æ­¢ç”¨æˆ·é€‰ä¸­æ–‡æœ¬ï¼ˆå› ä¸ºè¿™æ˜¯ä¸å¯ç¼–è¾‘çš„ï¼‰ */
      white-space: nowrap;
      /* æ–‡æœ¬ä¸æ¢è¡Œ */
      flex-shrink: 0;
      /* ä¸å…è®¸å‰ç¼€è¢«å‹ç¼© */
    }

    /* å¸¦å‰ç¼€çš„è¾“å…¥æ¡†æ ·å¼ - éœ€è¦ç§»é™¤è‡ªèº«çš„è¾¹æ¡†å’ŒèƒŒæ™¯ */
    .phone-input-wrapper .input-field {
      /* ç§»é™¤è‡ªèº«çš„è¾¹æ¡†ã€èƒŒæ™¯å’Œé˜´å½±ï¼Œå› ä¸ºè¿™äº›æ•ˆæœå·²ç»ç”±å®¹å™¨æä¾› */
      border: none;
      background: transparent;
      box-shadow: none;
      /* ç§»é™¤å·¦ä¾§å†…è¾¹è·ï¼Œå› ä¸ºå‰ç¼€å·²ç»æä¾›äº†å·¦ä¾§é—´è· */
      padding-left: 0;
      padding-right: .9rem;
      /* ä¿ç•™å³ä¾§å†…è¾¹è· */
      flex: 1;
      /* å æ®å‰©ä½™ç©ºé—´ */
      min-width: 0;
      /* å…è®¸è¾“å…¥æ¡†ç¼©å°ï¼Œé¿å…æº¢å‡º */
    }

    /* ç§»é™¤å¸¦å‰ç¼€è¾“å…¥æ¡†çš„ç„¦ç‚¹æ ·å¼ï¼Œå› ä¸ºç„¦ç‚¹æ ·å¼ç”±å®¹å™¨æä¾› */
    .phone-input-wrapper .input-field:focus {
      outline: none;
      /* ç§»é™¤æµè§ˆå™¨é»˜è®¤çš„ç„¦ç‚¹è½®å»“ */
      border: none;
      /* ç¡®ä¿æ²¡æœ‰è¾¹æ¡† */
      box-shadow: none;
      /* ç¡®ä¿æ²¡æœ‰é˜´å½± */
    }

    /* å½“ wrapper æ ‡è®°ä¸º prefix-hidden æ—¶ (å³+86è¢«éšè—)ï¼Œ
       æ¢å¤è¾“å…¥æ¡†çš„å·¦ä¾§å†…è¾¹è·ï¼Œä½¿å…¶ä¸å¸¸è§„è¾“å…¥æ¡†å¯¹é½ */
    .phone-input-wrapper.prefix-hidden .input-field {
      padding-left: .9rem;
    }

    .badge {
      display: inline-block;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-weight: 700;
      background: rgba(34, 211, 238, .18);
      color: var(--base-color-600);
    }

    .card-title {
      font-family: 'Zilla Slab', serif;
      letter-spacing: .5px;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(226, 232, 240, 0.6);
    }

    ::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 6px;
      border: 2px solid rgba(226, 232, 240, 0.6);
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: rgba(100, 116, 139, 0.9);
    }

    .tab-button {
      padding: .5rem .75rem;
      font-weight: 700;
      color: #64748b;
      border-bottom: 3px solid transparent;
      transition: all .2s ease;
    }

    .tab-button.active {
      color: var(--base-color-600);
      border-bottom-color: var(--base-color-600);
    }

    #task-list>div.selected {
      background: rgba(34, 211, 238, .14);
      border-left: 4px solid var(--base-color-600);
    }

    #map-container.drawing .amap-marker,
    #map-container.drawing .amap-text,
    #map-container.drawing .amap-overlay-text,
    #map-container.drawing .amap-overlay {
      pointer-events: none !important;
    }

    .pulsing-marker {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.98);
        box-shadow: 0 0 0 0 rgba(2, 132, 199, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 12px rgba(2, 132, 199, 0);
      }

      100% {
        transform: scale(0.98);
        box-shadow: 0 0 0 0 rgba(2, 132, 199, 0);
      }
    }

    .hero-overlay {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.85) 60%);
    }

    .theme-dot {
      width: 20px;
      height: 20px;
      border-radius: 100%;
      border: 2px solid #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .15);
      cursor: pointer;
      transition: transform .2s ease;
    }

    .theme-dot:hover {
      transform: scale(1.05);
    }

    /* æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶ï¼Œéšè—åœ°å›¾logoå’Œç‰ˆæƒ */
    #amap-key-modal:not(.hidden)~#map-container .amap-logo,
    #amap-key-modal:not(.hidden)~#map-container .amap-copyright,
    #amap-key-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #amap-key-modal:not(.hidden)~main>#multi-map-container .amap-copyright,

    #user-details-modal:not(.hidden)~#map-container .amap-logo,
    #user-details-modal:not(.hidden)~#map-container .amap-copyright,
    #task-details-modal:not(.hidden)~#map-container .amap-logo,
    #task-details-modal:not(.hidden)~#map-container .amap-copyright,
    #user-details-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #user-details-modal:not(.hidden)~main>#multi-map-container .amap-copyright,
    #task-details-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #task-details-modal:not(.hidden)~main>#multi-map-container .amap-copyright,
    #account-params-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #account-params-modal:not(.hidden)~main>#multi-map-container .amap-copyright {
      display: none !important;
    }

    /* å½“ä»»æ„æ¨¡æ€æ‰“å¼€æ—¶ï¼Œéšè—åœ°å›¾çš„ logo ä¸ç‰ˆæƒ */
    body.modal-visible .amap-logo,
    body.modal-visible .amap-copyright {
      display: none !important;
    }

    #admin-modal-close-btn:hover {
      transform: translateY(-50%);
      /* å¼ºåˆ¶ hover æ—¶åªåº”ç”¨å‚ç›´å±…ä¸­ transform */
    }

    /* --- Bug Fix: é˜²æ­¢ SweetAlert2 å¼¹çª—å¯¼è‡´é¡µé¢ä½ç§» --- */
    html.swal2-shown,
    body.swal2-shown:not(.swal2-toast-shown) {
      padding-right: 0;
      /* å¼ºåˆ¶ç§»é™¤ SweetAlert æ·»åŠ çš„ padding */
    }

    /* ============================================================ */
    /* ä»»åŠ¡29-30ï¼šç§»åŠ¨ç«¯ä¼˜åŒ–CSS */
    /* ä¸ºç§»åŠ¨è®¾å¤‡æä¾›æ›´å¥½çš„å“åº”å¼ä½“éªŒå’Œäº¤äº’ä¼˜åŒ– */
    /* ============================================================ */

    /* é’ˆå¯¹å±å¹•å®½åº¦å°äºç­‰äº768pxçš„è®¾å¤‡ï¼ˆæ‰‹æœºå’Œå°å¹³æ¿ï¼‰ */
    @media (max-width: 768px) {

      /* Modalå¼¹çª—ä¼˜åŒ–ï¼šåœ¨å°å±å¹•ä¸Šå æ®æ›´å¤šç©ºé—´ */
      .modal-content,
      .panel.rounded-2xl {
        width: 90% !important;
        /* å®½åº¦è°ƒæ•´ä¸ºå±å¹•çš„90% */
        max-width: 90% !important;
        /* æœ€å¤§å®½åº¦ä¹Ÿè®¾ä¸º90% */
        margin: 0 auto;
        /* æ°´å¹³å±…ä¸­ */
      }

      /* æŒ‰é’®å’Œå¯ç‚¹å‡»å…ƒç´ ä¼˜åŒ–ï¼šç¡®ä¿è¶³å¤Ÿå¤§ä»¥ä¾¿æ‰‹æŒ‡ç‚¹å‡» */
      button,
      input[type="submit"],
      input[type="button"],
      .btn {
        min-height: 44px;
        /* iOSäººæœºç•Œé¢æŒ‡å—æ¨èçš„æœ€å°è§¦æ‘¸ç›®æ ‡é«˜åº¦ */
        padding: 12px 16px;
        /* å¢åŠ å†…è¾¹è·ï¼Œæ‰©å¤§ç‚¹å‡»åŒºåŸŸ */
        font-size: 16px;
        /* å¢å¤§å­—ä½“ï¼Œæé«˜å¯è¯»æ€§ */
      }

      /* æ–‡æœ¬è¾“å…¥æ¡†ä¼˜åŒ– */
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="tel"],
      input[type="number"],
      textarea,
      select {
        min-height: 44px;
        /* ç¡®ä¿è¾“å…¥æ¡†è¶³å¤Ÿé«˜ */
        font-size: 16px;
        /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾é¡µé¢ï¼ˆiOSåœ¨å­—ä½“å°äº16pxæ—¶ä¼šè‡ªåŠ¨ç¼©æ”¾ï¼‰ */
        padding: 10px 12px;
        /* èˆ’é€‚çš„å†…è¾¹è· */
      }

      /* ç”µè¯å·ç è¾“å…¥æ¡†ç‰¹åˆ«ä¼˜åŒ–ï¼šé˜²æ­¢iOS Safariè‡ªåŠ¨ç¼©æ”¾ */
      input[type="tel"] {
        font-size: 16px !important;
        /* å¼ºåˆ¶16pxï¼Œé˜²æ­¢iOSç¼©æ”¾ */
      }

      /* è¡¨å•å®¹å™¨ä¼˜åŒ–ï¼šåœ¨ç§»åŠ¨ç«¯å †å æ˜¾ç¤º */
      .flex.gap-3,
      .flex.gap-4 {
        flex-direction: column;
        /* çºµå‘æ’åˆ— */
        gap: 12px;
        /* è°ƒæ•´é—´è· */
      }

      /* ç®¡ç†é¢æ¿Tabä¼˜åŒ–ï¼šæ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
      [class*="admin-tab"] {
        padding: 14px 20px;
        /* å¢å¤§Tabçš„å†…è¾¹è· */
        font-size: 15px;
        /* å¢å¤§å­—ä½“ */
      }

      /* å¡ç‰‡å’Œåˆ—è¡¨é¡¹ä¼˜åŒ– */
      .border.rounded-lg {
        padding: 16px;
        /* å¢å¤§å†…è¾¹è· */
      }

      /* æ»šåŠ¨å®¹å™¨ä¼˜åŒ–ï¼šæ·»åŠ æ»šåŠ¨æŒ‡ç¤º */
      .overflow-y-auto {
        -webkit-overflow-scrolling: touch;
        /* iOSå¹³æ»‘æ»šåŠ¨ */
      }

      /* å¤´åƒæ˜¾ç¤ºä¼˜åŒ– */
      [id^="avatar-"] {
        width: 48px;
        /* åœ¨ç§»åŠ¨ç«¯ç¼©å°å¤´åƒ */
        height: 48px;
      }

      /* å“åº”å¼ç½‘æ ¼ï¼šåœ¨ç§»åŠ¨ç«¯æ”¹ä¸ºå•åˆ— */
      .grid.grid-cols-2,
      .grid.grid-cols-3,
      .grid.grid-cols-4 {
        grid-template-columns: 1fr;
        /* å•åˆ—å¸ƒå±€ */
      }
    }

    /* é’ˆå¯¹è¶…å°å±å¹•ï¼ˆå®½åº¦å°äº480pxï¼‰ */
    @media (max-width: 480px) {

      /* è¿›ä¸€æ­¥ä¼˜åŒ–Modalå®½åº¦ */
      .modal-content,
      .panel.rounded-2xl {
        width: 95% !important;
        max-width: 95% !important;
        padding: 16px;
        /* å‡å°å†…è¾¹è·ä»¥èŠ‚çœç©ºé—´ */
      }

      /* å­—ä½“å¤§å°è°ƒæ•´ */
      h1,
      .text-xl {
        font-size: 20px;
      }

      h2,
      .text-lg {
        font-size: 18px;
      }

      h3,
      .text-base {
        font-size: 16px;
      }

      /* æŒ‰é’®ç»„ä¼˜åŒ–ï¼šå‚ç›´å †å  */
      .flex.gap-1,
      .flex.gap-2 {
        flex-direction: column;
        width: 100%;
      }

      .flex.gap-1>button,
      .flex.gap-2>button {
        width: 100%;
        /* æŒ‰é’®å æ»¡å®½åº¦ */
      }
    }

    /* ============================================================ */
    /* ç§»åŠ¨ç«¯ä¸“ç”¨UIå®¹å™¨æ ·å¼ */
    /* ä¸ºæ™ºèƒ½æ‰‹æœºç§»åŠ¨ç»ˆç«¯è®¾è®¡çš„ç‹¬ç«‹UIå®¹å™¨ï¼Œå®ç°è§¦å±ä¼˜åŒ– */
    /* ============================================================ */

    /* ç§»åŠ¨ç«¯å®¹å™¨åŸºç¡€æ ·å¼ - é»˜è®¤éšè—ï¼Œé€šè¿‡JavaScriptæ§åˆ¶æ˜¾ç¤º */
    #mobile-container {
      display: none;
      /* é»˜è®¤éšè—ç§»åŠ¨ç«¯å®¹å™¨ */
      position: fixed;
      /* å›ºå®šå®šä½ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰æ¡Œé¢å…ƒç´  */
      top: 0;
      /* ä»é¡¶éƒ¨å¼€å§‹ */
      left: 0;
      /* ä»å·¦ä¾§å¼€å§‹ */
      width: 100%;
      /* å æ®å…¨å±å®½åº¦ */
      height: 100vh;
      /* å æ®100%è§†å£é«˜åº¦ */
      overflow-y: auto;
      /* å…è®¸å‚ç›´æ»šåŠ¨ */
      overflow-x: hidden;
      /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
      background: linear-gradient(180deg, rgba(245, 250, 255, 1) 0%, rgba(235, 245, 255, 1) 40%, rgba(250, 240, 255, 1) 100%);
      /* ä¿æŒä¸ä¸»é¢˜ä¸€è‡´çš„æ¸å˜èƒŒæ™¯ */
      background-attachment: fixed;
      /* èƒŒæ™¯å›ºå®šï¼Œæ»šåŠ¨æ—¶ä¸ç§»åŠ¨ */
      padding: 0;
      /* ç§»é™¤é»˜è®¤å†…è¾¹è· */
      margin: 0;
      /* ç§»é™¤é»˜è®¤å¤–è¾¹è· */
      z-index: 10000;
      /* è¶…é«˜å±‚çº§ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰æ¡Œé¢å®¹å™¨å’Œæ¨¡æ€æ¡† */
    }

    /* æ¡Œé¢ç«¯å®¹å™¨åŸºç¡€æ ·å¼ - é»˜è®¤æ˜¾ç¤º */
    #desktop-container {
      display: block;
      /* é»˜è®¤æ˜¾ç¤ºæ¡Œé¢ç«¯å®¹å™¨ */
      width: 100%;
      /* å æ®å…¨å®½ */
      height: 100%;
      /* å æ®å…¨é«˜ */
    }

    /* ç§»åŠ¨ç«¯æ¨¡å¼ä¸‹çš„bodyæ ·å¼ - å½“æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡æ—¶åº”ç”¨ */
    body.mobile-mode {
      font-size: 16px;
      /* è®¾ç½®æœ€å°å­—ä½“ä¸º16pxï¼Œé˜²æ­¢iOS Safariè‡ªåŠ¨ç¼©æ”¾é¡µé¢ */
      -webkit-text-size-adjust: 100%;
      /* é˜²æ­¢iOSæ¨ªå±æ—¶æ–‡å­—è‡ªåŠ¨ç¼©æ”¾ */
      -moz-text-size-adjust: 100%;
      /* é˜²æ­¢Firefoxç§»åŠ¨ç‰ˆæ–‡å­—è‡ªåŠ¨ç¼©æ”¾ */
      -ms-text-size-adjust: 100%;
      /* é˜²æ­¢IEç§»åŠ¨ç‰ˆæ–‡å­—è‡ªåŠ¨ç¼©æ”¾ */
      text-size-adjust: 100%;
      /* æ ‡å‡†å±æ€§ï¼šé˜²æ­¢æ–‡å­—è‡ªåŠ¨ç¼©æ”¾ */
      overflow-x: hidden;
      /* éšè—æ¨ªå‘æº¢å‡ºï¼Œé¿å…å·¦å³æ»‘åŠ¨ */
      user-select: none;
      /* ç¦æ­¢æ–‡æœ¬é€‰æ‹©ï¼Œæ›´æ¥è¿‘åŸç”ŸAppä½“éªŒ */
      -webkit-user-select: none;
      /* Safari/Chromeç¦æ­¢æ–‡æœ¬é€‰æ‹© */
      -webkit-tap-highlight-color: transparent;
      /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº®æ•ˆæœ */
      touch-action: pan-y;
      /* åªå…è®¸å‚ç›´æ»šåŠ¨æ‰‹åŠ¿ */
    }



    /* ç§»åŠ¨ç«¯ +86 å‰ç¼€ */
    .mobile-mode .phone-input-wrapper {
      display: flex;
      align-items: center;
      width: 100%;
      border-radius: 10px;
      /* åŒ¹é… .mobile-mode input æ ·å¼ */
      border: 2px solid rgba(148, 163, 184, 0.3);
      background-color: rgba(255, 255, 255, 0.9);
      overflow: hidden;
      min-height: 44px;
      transition: all 0.2s ease;
    }

    /* è·å¾—ç„¦ç‚¹æ—¶çš„æ ·å¼ */
    .mobile-mode .phone-input-wrapper:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: scale(1.02);
    }

    /* +86 å‰ç¼€æ ‡ç­¾ */
    .mobile-mode .phone-prefix {
      /* åŒ¹é… .mobile-mode input å†…è¾¹è· */
      padding: 12px 0 12px 16px;
      font-size: 16px;
      color: #64748b;
      font-weight: 500;
      user-select: none;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* å†…éƒ¨è¾“å…¥æ¡†ï¼šç§»é™¤è‡ªèº«æ ·å¼ */
    .mobile-mode .phone-input-wrapper .input-field {
      border: none;
      background: transparent;
      box-shadow: none;
      padding-left: 0;
      padding-right: 16px;
      /* åŒ¹é… .mobile-mode input */
      font-size: 16px;
      /* åŒ¹é… .mobile-mode input */
      flex: 1;
      min-width: 0;
      /* ç¡®ä¿é«˜åº¦è¶³å¤Ÿ */
      min-height: 44px;
      padding-top: 12px;
      padding-bottom: 12px;
    }

    /* ç§»é™¤å†…éƒ¨è¾“å…¥æ¡†çš„ç„¦ç‚¹ï¼Œå› ä¸ºå®¹å™¨å·²æœ‰ */
    .mobile-mode .phone-input-wrapper .input-field:focus {
      outline: none;
      border: none;
      box-shadow: none;
      transform: none;
      /* ç§»é™¤ .mobile-mode input:focus çš„æ”¾å¤§ */
    }

    /* å½“ wrapper æ ‡è®°ä¸º prefix-hidden æ—¶ (å³+86è¢«éšè—)ï¼Œ
       æ¢å¤è¾“å…¥æ¡†çš„å·¦ä¾§å†…è¾¹è·ï¼Œä½¿å…¶ä¸å¸¸è§„è¾“å…¥æ¡†å¯¹é½ */
    .mobile-mode .phone-input-wrapper.prefix-hidden .input-field {
      padding-left: 16px;
    }


    /* ç§»åŠ¨ç«¯æ¨¡å¼ä¸‹ï¼Œå¼ºåˆ¶éšè—æ‰€æœ‰æ¡Œé¢ç«¯å®¹å™¨å’Œå…ƒç´  */
    body.mobile-mode #desktop-container,
    body.mobile-mode #auth-login-container,
    body.mobile-mode #login-container,
    body.mobile-mode #main-app,
    body.mobile-mode #multi-account-app {
      display: none !important;
      visibility: hidden !important;
      pointer-events: none !important;
      z-index: -1 !important;
    }

    /* ç§»åŠ¨ç«¯æ¨¡å¼ä¸‹ï¼Œç¡®ä¿æ¨¡æ€æ¡†ä¸ä¼šé®æŒ¡ç§»åŠ¨ç«¯UI */
    body.mobile-mode .modal,
    body.mobile-mode #admin-panel-modal,
    body.mobile-mode #session-picker-modal {
      z-index: 9999 !important;
      /* ä½äºmobile-containerçš„10000 */
    }

    /* ç§»åŠ¨ç«¯æ¨¡å¼ä¸‹çš„æŒ‰é’®ä¼˜åŒ– - æ›´å¤§çš„è§¦æ‘¸ç›®æ ‡ */
    .mobile-mode .btn,
    .mobile-mode button {
      min-height: 44px;
      /* iOSäººæœºç•Œé¢æŒ‡å—æ¨èçš„æœ€å°è§¦æ‘¸ç›®æ ‡é«˜åº¦ */
      min-width: 44px;
      /* æœ€å°å®½åº¦ä¹Ÿè®¾ä¸º44pxï¼Œç¡®ä¿æ­£æ–¹å½¢æŒ‰é’®å¯ç‚¹å‡» */
      font-size: 16px;
      /* å¢å¤§å­—ä½“ï¼Œæé«˜å¯è¯»æ€§ */
      padding: 12px 20px;
      /* å¢å¤§å†…è¾¹è·ï¼Œæ‰©å¤§ç‚¹å‡»åŒºåŸŸ */
      border-radius: 12px;
      /* å¢å¤§åœ†è§’ï¼Œæ›´ç¬¦åˆç§»åŠ¨ç«¯UIé£æ ¼ */
      font-weight: 600;
      /* åŠ ç²—å­—ä½“ï¼Œæ›´æ˜“è¯†åˆ« */
      letter-spacing: 0.5px;
      /* å¢åŠ å­—é—´è·ï¼Œæé«˜å¯è¯»æ€§ */
      transition: all 0.2s ease;
      /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”»ï¼Œæå‡äº¤äº’ä½“éªŒ */
      touch-action: manipulation;
      /* ä¼˜åŒ–è§¦æ‘¸å“åº”ï¼Œç§»é™¤åŒå‡»ç¼©æ”¾å»¶è¿Ÿ */
      cursor: pointer;
      /* æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ï¼ˆæ¡Œé¢è°ƒè¯•æ—¶æœ‰ç”¨ï¼‰ */
    }

    /* ç§»åŠ¨ç«¯æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ - æä¾›è§¦è§‰åé¦ˆ */
    .mobile-mode .btn:active,
    .mobile-mode button:active {
      transform: scale(0.95);
      /* æŒ‰ä¸‹æ—¶è½»å¾®ç¼©å°ï¼Œæ¨¡æ‹Ÿç‰©ç†æŒ‰é”®åé¦ˆ */
      opacity: 0.8;
      /* é™ä½ä¸é€æ˜åº¦ï¼Œå¢å¼ºè§†è§‰åé¦ˆ */
    }

    /* ç§»åŠ¨ç«¯æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡†ä¼˜åŒ– */
    .mobile-mode input,
    .mobile-mode select,
    .mobile-mode textarea {
      min-height: 44px;
      /* ç¡®ä¿è¾“å…¥æ¡†è¶³å¤Ÿé«˜ï¼Œä¾¿äºè§¦æ‘¸ */
      font-size: 16px;
      /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ï¼ˆå­—ä½“å°äº16pxæ—¶ä¼šç¼©æ”¾ï¼‰ */
      padding: 12px 16px;
      /* å¢å¤§å†…è¾¹è·ï¼Œæå‡è¾“å…¥ä½“éªŒ */
      border-radius: 10px;
      /* åœ†è§’è®¾è®¡ï¼Œç¬¦åˆç°ä»£ç§»åŠ¨UI */
      border: 2px solid rgba(148, 163, 184, 0.3);
      /* å¢ç²—è¾¹æ¡†ï¼Œæ›´æ˜“è¯†åˆ« */
      background-color: rgba(255, 255, 255, 0.9);
      /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
      transition: all 0.2s ease;
      /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
      touch-action: manipulation;
      /* ä¼˜åŒ–è§¦æ‘¸å“åº” */
    }

    /* è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶çš„æ ·å¼ */
    .mobile-mode input:focus,
    .mobile-mode select:focus,
    .mobile-mode textarea:focus {
      border-color: #3b82f6;
      /* èšç„¦æ—¶æ˜¾ç¤ºè“è‰²è¾¹æ¡† */
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      /* æ·»åŠ å¤–å‘å…‰æ•ˆæœ */
      outline: none;
      /* ç§»é™¤é»˜è®¤çš„ç„¦ç‚¹è½®å»“ */
      transform: scale(1.02);
      /* è½»å¾®æ”¾å¤§ï¼Œå¢å¼ºè§†è§‰åé¦ˆ */
    }

    /* ç§»åŠ¨ç«¯é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ */
    .mobile-mode .mobile-header {
      position: fixed;
      /* å›ºå®šåœ¨é¡¶éƒ¨ */
      top: 0;
      /* è·ç¦»é¡¶éƒ¨0 */
      left: 0;
      /* è·ç¦»å·¦ä¾§0 */
      right: 0;
      /* è·ç¦»å³ä¾§0 */
      z-index: 1000;
      /* é«˜å±‚çº§ï¼Œç¡®ä¿åœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Š */
      height: 56px;
      /* æ ‡å‡†ç§»åŠ¨ç«¯å¯¼èˆªæ é«˜åº¦ */
      background: rgba(255, 255, 255, 0.95);
      /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
      backdrop-filter: blur(10px);
      /* æ¯›ç»ç’ƒæ•ˆæœ */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      /* åº•éƒ¨é˜´å½±ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
      display: flex;
      /* ä½¿ç”¨Flexboxå¸ƒå±€ */
      align-items: center;
      /* å‚ç›´å±…ä¸­å¯¹é½ */
      justify-content: space-between;
      /* ä¸¤ç«¯å¯¹é½ */
      padding: 0 16px;
      /* å·¦å³å†…è¾¹è· */
    }

    /* ç§»åŠ¨ç«¯å†…å®¹åŒºåŸŸ - ä¸ºé¡¶éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
    .mobile-mode .mobile-content {
      padding-top: 56px;
      /* é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å…è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ */
      padding-bottom: 80px;
      /* åº•éƒ¨å†…è¾¹è·ï¼Œä¸ºåº•éƒ¨å¯¼èˆªæ ç•™ç©ºé—´ */
      min-height: 100vh;
      /* æœ€å°é«˜åº¦ä¸º100%è§†å£é«˜åº¦ */
    }

    /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
    .mobile-mode .mobile-bottom-nav {
      position: fixed;
      /* å›ºå®šåœ¨åº•éƒ¨ */
      bottom: 0;
      /* è·ç¦»åº•éƒ¨0 */
      left: 0;
      /* è·ç¦»å·¦ä¾§0 */
      right: 0;
      /* è·ç¦»å³ä¾§0 */
      z-index: 1000;
      /* é«˜å±‚çº§ */
      height: 64px;
      /* åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
      background: rgba(255, 255, 255, 0.95);
      /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
      backdrop-filter: blur(10px);
      /* æ¯›ç»ç’ƒæ•ˆæœ */
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
      /* é¡¶éƒ¨é˜´å½± */
      display: flex;
      /* Flexboxå¸ƒå±€ */
      align-items: center;
      /* å‚ç›´å±…ä¸­ */
      justify-content: space-around;
      /* å‡åŒ€åˆ†å¸ƒ */
      padding: 0 8px;
      /* å·¦å³å†…è¾¹è· */
      padding-bottom: env(safe-area-inset-bottom, 0);
      /* é€‚é…iPhone Xç­‰æœ‰å®‰å…¨åŒºåŸŸçš„è®¾å¤‡ */
    }

    /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæŒ‰é’® */
    .mobile-mode .mobile-nav-btn {
      flex: 1;
      /* å‡åˆ†ç©ºé—´ */
      display: flex;
      /* Flexboxå¸ƒå±€ */
      flex-direction: column;
      /* å‚ç›´æ’åˆ—ï¼ˆå›¾æ ‡åœ¨ä¸Šï¼Œæ–‡å­—åœ¨ä¸‹ï¼‰ */
      align-items: center;
      /* æ°´å¹³å±…ä¸­ */
      justify-content: center;
      /* å‚ç›´å±…ä¸­ */
      padding: 8px;
      /* å†…è¾¹è· */
      min-height: 44px;
      /* æœ€å°è§¦æ‘¸ç›®æ ‡é«˜åº¦ */
      color: #64748b;
      /* é»˜è®¤ç°è‰² */
      text-decoration: none;
      /* ç§»é™¤ä¸‹åˆ’çº¿ */
      font-size: 12px;
      /* å°å­—ä½“ */
      font-weight: 500;
      /* ä¸­ç­‰å­—é‡ */
      transition: all 0.2s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
      cursor: pointer;
      /* æ‰‹å‹å…‰æ ‡ */
      touch-action: manipulation;
      /* ä¼˜åŒ–è§¦æ‘¸ */
    }

    /* åº•éƒ¨å¯¼èˆªæŒ‰é’®æ¿€æ´»çŠ¶æ€ */
    .mobile-mode .mobile-nav-btn.active {
      color: #3b82f6;
      /* æ¿€æ´»æ—¶æ˜¾ç¤ºè“è‰² */
      font-weight: 600;
      /* åŠ ç²— */
    }

    /* åº•éƒ¨å¯¼èˆªæŒ‰é’®å›¾æ ‡ */
    .mobile-mode .mobile-nav-btn svg {
      width: 24px;
      /* å›¾æ ‡å®½åº¦ */
      height: 24px;
      /* å›¾æ ‡é«˜åº¦ */
      margin-bottom: 4px;
      /* å›¾æ ‡ä¸æ–‡å­—é—´è· */
    }

    /* ç§»åŠ¨ç«¯å¡ç‰‡æ ·å¼ä¼˜åŒ– */
    .mobile-mode .mobile-card {
      background: rgba(255, 255, 255, 0.85);
      /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
      backdrop-filter: blur(10px);
      /* æ¯›ç»ç’ƒæ•ˆæœ */
      border-radius: 16px;
      /* å¤§åœ†è§’ */
      padding: 20px;
      /* å†…è¾¹è· */
      margin: 16px;
      /* å¤–è¾¹è· */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      /* é˜´å½±æ•ˆæœ */
      border: 1px solid rgba(255, 255, 255, 0.5);
      /* è¾¹æ¡† */
    }

    /* ç§»åŠ¨ç«¯è¡¨å•ç»„æ ·å¼ */
    .mobile-mode .mobile-form-group {
      margin-bottom: 20px;
      /* è¡¨å•é¡¹ä¹‹é—´çš„é—´è· */
    }

    /* ç§»åŠ¨ç«¯è¡¨å•æ ‡ç­¾ */
    .mobile-mode .mobile-form-label {
      display: block;
      /* å—çº§å…ƒç´ ï¼Œç‹¬å ä¸€è¡Œ */
      font-size: 14px;
      /* å­—ä½“å¤§å° */
      font-weight: 600;
      /* åŠ ç²— */
      color: #334155;
      /* æ·±ç°è‰² */
      margin-bottom: 8px;
      /* æ ‡ç­¾ä¸è¾“å…¥æ¡†é—´è· */
    }

    /* ç§»åŠ¨ç«¯å¤§æŒ‰é’®æ ·å¼ï¼ˆä¸»è¦æ“ä½œæŒ‰é’®ï¼‰ */
    .mobile-mode .mobile-primary-btn {
      width: 100%;
      /* å æ»¡å®½åº¦ */
      height: 50px;
      /* è¾ƒå¤§çš„é«˜åº¦ */
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      /* æ¸å˜è“è‰²èƒŒæ™¯ */
      color: white;
      /* ç™½è‰²æ–‡å­— */
      border: none;
      /* æ— è¾¹æ¡† */
      border-radius: 12px;
      /* åœ†è§’ */
      font-size: 17px;
      /* è¾ƒå¤§å­—ä½“ */
      font-weight: 700;
      /* ç²—ä½“ */
      text-align: center;
      /* æ–‡å­—å±…ä¸­ */
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      /* è“è‰²é˜´å½± */
      transition: all 0.2s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
      touch-action: manipulation;
      /* ä¼˜åŒ–è§¦æ‘¸ */
      cursor: pointer;
      /* æ‰‹å‹å…‰æ ‡ */
    }

    /* ä¸»è¦æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
    .mobile-mode .mobile-primary-btn:active {
      transform: scale(0.97);
      /* æŒ‰ä¸‹æ—¶ç¼©å° */
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
      /* å‡å¼±é˜´å½± */
    }

    /* ç§»åŠ¨ç«¯æ¬¡è¦æŒ‰é’®æ ·å¼ï¼ˆæ¬¡è¦æ“ä½œæŒ‰é’®ï¼‰ */
    .mobile-mode .mobile-secondary-btn {
      width: 100%;
      /* å æ»¡å®½åº¦ */
      height: 50px;
      /* é«˜åº¦ */
      background: white;
      /* ç™½è‰²èƒŒæ™¯ */
      color: #3b82f6;
      /* è“è‰²æ–‡å­— */
      border: 2px solid #3b82f6;
      /* è“è‰²è¾¹æ¡† */
      border-radius: 12px;
      /* åœ†è§’ */
      font-size: 17px;
      /* å­—ä½“å¤§å° */
      font-weight: 600;
      /* å­—é‡ */
      text-align: center;
      /* å±…ä¸­ */
      transition: all 0.2s ease;
      /* è¿‡æ¸¡ */
      touch-action: manipulation;
      /* è§¦æ‘¸ä¼˜åŒ– */
      cursor: pointer;
      /* å…‰æ ‡ */
    }

    /* æ¬¡è¦æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
    .mobile-mode .mobile-secondary-btn:active {
      transform: scale(0.97);
      /* ç¼©å° */
      background: rgba(59, 130, 246, 0.1);
      /* æµ…è“èƒŒæ™¯ */
    }

    /* ç§»åŠ¨ç«¯åˆ—è¡¨é¡¹æ ·å¼ */
    .mobile-mode .mobile-list-item {
      display: flex;
      /* Flexboxå¸ƒå±€ */
      align-items: center;
      /* å‚ç›´å±…ä¸­ */
      padding: 16px;
      /* å†…è¾¹è· */
      background: white;
      /* ç™½è‰²èƒŒæ™¯ */
      border-radius: 12px;
      /* åœ†è§’ */
      margin-bottom: 12px;
      /* é¡¹ä¹‹é—´çš„é—´è· */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      /* è½»å¾®é˜´å½± */
      min-height: 60px;
      /* æœ€å°é«˜åº¦ï¼Œç¡®ä¿å¯ç‚¹å‡» */
      transition: all 0.2s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
      cursor: pointer;
      /* æ‰‹å‹å…‰æ ‡ */
      touch-action: manipulation;
      /* è§¦æ‘¸ä¼˜åŒ– */
    }

    /* åˆ—è¡¨é¡¹æŒ‰ä¸‹æ•ˆæœ */
    .mobile-mode .mobile-list-item:active {
      transform: scale(0.98);
      /* è½»å¾®ç¼©å° */
      background: rgba(59, 130, 246, 0.05);
      /* æµ…è“èƒŒæ™¯ */
    }

    /* ç§»åŠ¨ç«¯åˆ†éš”çº¿ */
    .mobile-mode .mobile-divider {
      height: 1px;
      /* é«˜åº¦1åƒç´  */
      background: rgba(148, 163, 184, 0.2);
      /* åŠé€æ˜ç°è‰² */
      margin: 20px 0;
      /* ä¸Šä¸‹å¤–è¾¹è· */
    }

    /* ç§»åŠ¨ç«¯æ ‡é¢˜æ ·å¼ */
    .mobile-mode .mobile-title {
      font-size: 24px;
      /* å¤§å­—ä½“ */
      font-weight: 700;
      /* ç²—ä½“ */
      color: #0f172a;
      /* æ·±è‰² */
      margin-bottom: 8px;
      /* åº•éƒ¨é—´è· */
    }

    /* ç§»åŠ¨ç«¯å‰¯æ ‡é¢˜æ ·å¼ */
    .mobile-mode .mobile-subtitle {
      font-size: 16px;
      /* ä¸­ç­‰å­—ä½“ */
      font-weight: 400;
      /* æ­£å¸¸å­—é‡ */
      color: #64748b;
      /* ç°è‰² */
      margin-bottom: 24px;
      /* åº•éƒ¨é—´è· */
    }

    /* ç§»åŠ¨ç«¯ç©ºçŠ¶æ€æç¤º */
    .mobile-mode .mobile-empty-state {
      text-align: center;
      /* å±…ä¸­ */
      padding: 40px 20px;
      /* å†…è¾¹è· */
      color: #94a3b8;
      /* æµ…ç°è‰² */
      font-size: 15px;
      /* å­—ä½“å¤§å° */
    }

    /* ç§»åŠ¨ç«¯åŠ è½½åŠ¨ç”»å®¹å™¨ */
    .mobile-mode .mobile-loading {
      display: flex;
      /* Flexbox */
      flex-direction: column;
      /* å‚ç›´æ’åˆ— */
      align-items: center;
      /* æ°´å¹³å±…ä¸­ */
      justify-content: center;
      /* å‚ç›´å±…ä¸­ */
      padding: 40px;
      /* å†…è¾¹è· */
      color: #64748b;
      /* ç°è‰² */
    }

    /* ç§»åŠ¨ç«¯åˆ‡æ¢å¼€å…³æ ·å¼ */
    .mobile-mode .mobile-switch {
      position: relative;
      /* ç›¸å¯¹å®šä½ */
      width: 50px;
      /* å®½åº¦ */
      height: 28px;
      /* é«˜åº¦ */
      background: #e2e8f0;
      /* ç°è‰²èƒŒæ™¯ */
      border-radius: 14px;
      /* åœ†è§’ï¼ˆé«˜åº¦çš„ä¸€åŠï¼‰ */
      transition: all 0.3s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
      cursor: pointer;
      /* æ‰‹å‹å…‰æ ‡ */
      touch-action: manipulation;
      /* è§¦æ‘¸ä¼˜åŒ– */
    }

    /* å¼€å…³æ¿€æ´»çŠ¶æ€ */
    .mobile-mode .mobile-switch.active {
      background: #3b82f6;
      /* è“è‰²èƒŒæ™¯ */
    }

    /* å¼€å…³æ»‘å— */
    .mobile-mode .mobile-switch::after {
      content: '';
      /* ä¼ªå…ƒç´ å†…å®¹ä¸ºç©º */
      position: absolute;
      /* ç»å¯¹å®šä½ */
      top: 2px;
      /* è·ç¦»é¡¶éƒ¨2px */
      left: 2px;
      /* åˆå§‹ä½ç½®åœ¨å·¦ä¾§ */
      width: 24px;
      /* æ»‘å—å®½åº¦ */
      height: 24px;
      /* æ»‘å—é«˜åº¦ */
      background: white;
      /* ç™½è‰²æ»‘å— */
      border-radius: 12px;
      /* åœ†å½¢æ»‘å— */
      transition: all 0.3s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      /* é˜´å½±æ•ˆæœ */
    }

    /* æ¿€æ´»çŠ¶æ€ä¸‹çš„æ»‘å—ä½ç½® */
    .mobile-mode .mobile-switch.active::after {
      left: 24px;
      /* æ»‘å—ç§»åŠ¨åˆ°å³ä¾§ */
    }

    /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
    .mobile-mode .mobile-modal {
      position: fixed;
      /* å›ºå®šå®šä½ */
      top: 0;
      /* é¡¶éƒ¨ */
      left: 0;
      /* å·¦ä¾§ */
      right: 0;
      /* å³ä¾§ */
      bottom: 0;
      /* åº•éƒ¨ */
      z-index: 20000;
      /* è¶…é«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æ‰€æœ‰å†…å®¹ä¹‹ä¸Š */
      background: rgba(0, 0, 0, 0.5);
      /* åŠé€æ˜é»‘è‰²é®ç½© */
      display: flex;
      /* Flexboxå¸ƒå±€ */
      align-items: flex-end;
      /* åº•éƒ¨å¯¹é½ï¼ˆä»åº•éƒ¨å¼¹å‡ºï¼‰ */
      justify-content: center;
      /* æ°´å¹³å±…ä¸­ */
      opacity: 0;
      /* åˆå§‹é€æ˜ */
      visibility: hidden;
      /* åˆå§‹éšè— */
      transition: all 0.3s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
    }

    /* æ¨¡æ€æ¡†æ˜¾ç¤ºçŠ¶æ€ */
    .mobile-mode .mobile-modal.show {
      opacity: 1;
      /* å®Œå…¨ä¸é€æ˜ */
      visibility: visible;
      /* å¯è§ */
    }

    /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ */
    .mobile-mode .mobile-modal-content {
      background: white;
      /* ç™½è‰²èƒŒæ™¯ */
      border-radius: 20px 20px 0 0;
      /* é¡¶éƒ¨åœ†è§’ */
      width: 100%;
      /* å æ»¡å®½åº¦ */
      max-height: 85vh;
      /* æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„85% */
      overflow-y: auto;
      /* å…è®¸å‚ç›´æ»šåŠ¨ */
      padding: 24px;
      /* å†…è¾¹è· */
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0));
      /* åº•éƒ¨å†…è¾¹è·ï¼Œé€‚é…å®‰å…¨åŒºåŸŸ */
      transform: translateY(100%);
      /* åˆå§‹ä½ç½®åœ¨å±å¹•ä¸‹æ–¹ */
      transition: transform 0.3s ease;
      /* è¿‡æ¸¡åŠ¨ç”» */
    }

    /* æ¨¡æ€æ¡†å†…å®¹æ˜¾ç¤ºçŠ¶æ€ */
    .mobile-mode .mobile-modal.show .mobile-modal-content {
      transform: translateY(0);
      /* æ»‘å…¥åˆ°æ­£å¸¸ä½ç½® */
    }

    /* ============================================================ */
    /* ç§»åŠ¨ç«¯æ–°å¢å®¹å™¨ä¸“ç”¨æ ·å¼ */
    /* ä¸ºæ–°å¢çš„é€šçŸ¥é¢æ¿ã€ä»»åŠ¡é¢æ¿ã€æ§åˆ¶é¢æ¿ç­‰æä¾›æ ·å¼æ”¯æŒ */
    /* ============================================================ */

    /* ç§»åŠ¨ç«¯é€šçŸ¥é¢æ¿æ ·å¼å¢å¼º */
    .mobile-mode #mobile-notification-panel {
      position: relative;
      /* ä¸ºè§’æ ‡å®šä½æä¾›å‚ç…§ */
    }

    /* ç§»åŠ¨ç«¯é€šçŸ¥åˆ—è¡¨é¡¹æ ·å¼ */
    .mobile-mode #mobile-all-notifications-list .mobile-list-item,
    .mobile-mode #mobile-attendance-notifications-list .mobile-list-item {
      cursor: pointer;
      /* æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ï¼Œè¡¨æ˜å¯ç‚¹å‡» */
      border-left: 3px solid transparent;
      /* é¢„ç•™å·¦ä¾§è¾¹æ¡†ç©ºé—´ */
      transition: all 0.2s ease;
      /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
    }

    /* æœªè¯»é€šçŸ¥é¡¹æ ·å¼ - å·¦ä¾§æ˜¾ç¤ºè“è‰²è¾¹æ¡† */
    .mobile-mode #mobile-all-notifications-list .mobile-list-item:not(.opacity-60) {
      border-left-color: #3b82f6;
      /* è“è‰²å·¦è¾¹æ¡†è¡¨ç¤ºæœªè¯» */
      background: rgba(59, 130, 246, 0.05);
      /* æµ…è“èƒŒæ™¯ */
    }

    /* é€šçŸ¥é¡¹æ‚¬åœæ•ˆæœï¼ˆè§¦æ‘¸è®¾å¤‡æŒ‰ä¸‹æ•ˆæœï¼‰ */
    .mobile-mode #mobile-all-notifications-list .mobile-list-item:active,
    .mobile-mode #mobile-attendance-notifications-list .mobile-list-item:active {
      background: rgba(59, 130, 246, 0.1);
      /* æŒ‰ä¸‹æ—¶èƒŒæ™¯è‰²åŠ æ·± */
      transform: scale(0.98);
      /* è½»å¾®ç¼©å°ï¼Œæä¾›è§¦è§‰åé¦ˆ */
    }

    /* ç§»åŠ¨ç«¯ä»»åŠ¡é¢æ¿æ ·å¼ */
    .mobile-mode #mobile-task-panel .mobile-list-item {
      border-left: 3px solid #10b981;
      /* ç»¿è‰²å·¦è¾¹æ¡† */
      background: rgba(16, 185, 129, 0.03);
      /* æµ…ç»¿èƒŒæ™¯ */
    }

    /* ç§»åŠ¨ç«¯åœ°å›¾å®¹å™¨æ ·å¼ */
    .mobile-mode #mobile-map-container {
      touch-action: pan-x pan-y;
      /* å…è®¸åœ°å›¾çš„æ‹–åŠ¨æ‰‹åŠ¿ */
      -webkit-overflow-scrolling: touch;
      /* iOSå¹³æ»‘æ»šåŠ¨ */
    }

    /* åœ°å›¾åŠ è½½å ä½ç¬¦åŠ¨ç”» */
    .mobile-mode #mobile-map-container .text-slate-400 svg {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      /* è„‰å†²åŠ¨ç”» */
    }

    /* æ§åˆ¶é¢æ¿æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
    .mobile-mode #mobile-control-panel button:disabled {
      opacity: 0.5;
      /* åŠé€æ˜ */
      cursor: not-allowed;
      /* ç¦æ­¢å…‰æ ‡ */
      background: #cbd5e1 !important;
      /* ç°è‰²èƒŒæ™¯ */
      color: #64748b !important;
      /* ç°è‰²æ–‡å­— */
    }

    /* æ§åˆ¶é¢æ¿çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
    .mobile-mode #mobile-status-indicator {
      animation: fadeIn 0.3s ease;
      /* æ·¡å…¥åŠ¨ç”» */
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ä¸åŒçŠ¶æ€çš„é¢œè‰² */
    .mobile-mode #mobile-status-indicator.status-idle {
      background: #e2e8f0;
      color: #64748b;
    }

    .mobile-mode #mobile-status-indicator.status-running {
      background: #dcfce7;
      color: #16a34a;
      /* ç»¿è‰²ï¼šè¿è¡Œä¸­ */
    }

    .mobile-mode #mobile-status-indicator.status-paused {
      background: #fef3c7;
      color: #d97706;
      /* é»„è‰²ï¼šå·²æš‚åœ */
    }

    .mobile-mode #mobile-status-indicator.status-error {
      background: #fee2e2;
      color: #dc2626;
      /* çº¢è‰²ï¼šé”™è¯¯ */
    }

    /* è¿›åº¦æ¡åŠ¨ç”» */
    .mobile-mode #mobile-progress-bar {
      transition: width 0.5s ease-out;
      /* å¹³æ»‘çš„å®½åº¦è¿‡æ¸¡ */
    }

    /* å¤šè´¦å·åˆ—è¡¨æ ·å¼ */
    .mobile-mode #mobile-multi-account-list .mobile-list-item {
      position: relative;
      /* ä¸ºå¤é€‰æ¡†å®šä½æä¾›å‚ç…§ */
      padding-left: 48px;
      /* ä¸ºå¤é€‰æ¡†ç•™å‡ºç©ºé—´ */
    }

    /* å¤šè´¦å·åˆ—è¡¨å¤é€‰æ¡†æ ·å¼ */
    .mobile-mode #mobile-multi-account-list input[type="checkbox"] {
      position: absolute;
      /* ç»å¯¹å®šä½ */
      left: 16px;
      /* å·¦ä¾§å¯¹é½ */
      top: 50%;
      /* å‚ç›´å±…ä¸­ */
      transform: translateY(-50%);
      /* ç²¾ç¡®å±…ä¸­ */
    }

    /* è´¦å·çŠ¶æ€æ ‡ç­¾æ ·å¼ */
    .mobile-mode .account-status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      /* å®Œå…¨åœ†è§’ */
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      /* å¤§å†™ */
      letter-spacing: 0.5px;
    }

    .mobile-mode .account-status-running {
      background: #dcfce7;
      color: #16a34a;
    }

    .mobile-mode .account-status-stopped {
      background: #f1f5f9;
      color: #64748b;
    }

    .mobile-mode .account-status-error {
      background: #fee2e2;
      color: #dc2626;
    }

    /* ç§»åŠ¨ç«¯æ¨ªå±é€‚é… */
    @media (orientation: landscape) and (max-height: 500px) {

      /* æ¨ªå±ä¸”é«˜åº¦è¾ƒå°æ—¶ï¼ˆæ‰‹æœºæ¨ªå±ï¼‰ */
      .mobile-mode .mobile-header {
        height: 48px;
        /* å‡å°å¯¼èˆªæ é«˜åº¦ */
      }

      .mobile-mode .mobile-content {
        padding-top: 48px;
        /* ç›¸åº”å‡å°é¡¶éƒ¨å†…è¾¹è· */
        padding-bottom: 60px;
        /* å‡å°åº•éƒ¨å†…è¾¹è· */
      }

      .mobile-mode .mobile-bottom-nav {
        height: 56px;
        /* å‡å°åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
      }

      .mobile-mode .mobile-card {
        padding: 16px;
        /* å‡å°å¡ç‰‡å†…è¾¹è· */
        margin: 12px;
        /* å‡å°å¡ç‰‡å¤–è¾¹è· */
      }

      /* æ¨ªå±æ—¶ä¼˜åŒ–åœ°å›¾é«˜åº¦ */
      .mobile-mode #mobile-map-container {
        height: 200px !important;
        /* æ¨ªå±æ—¶å‡å°åœ°å›¾é«˜åº¦ */
      }

      /* æ¨ªå±æ—¶ä¼˜åŒ–åˆ—è¡¨æœ€å¤§é«˜åº¦ */
      .mobile-mode #mobile-all-notifications-list,
      .mobile-mode #mobile-attendance-notifications-list,
      .mobile-mode #mobile-task-list,
      .mobile-mode #mobile-multi-account-list {
        max-height: 30vh !important;
        /* æ¨ªå±æ—¶å‡å°åˆ—è¡¨æœ€å¤§é«˜åº¦ */
      }
    }

    /* ç§»åŠ¨ç«¯æ·±è‰²æ¨¡å¼é€‚é…ï¼ˆå¦‚æœç³»ç»Ÿå¯ç”¨æ·±è‰²æ¨¡å¼ï¼‰ */
    @media (prefers-color-scheme: dark) {
      .mobile-mode #mobile-container {
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        /* æ·±è‰²æ¸å˜èƒŒæ™¯ */
      }


      /* ç§»åŠ¨ç«¯è®¤è¯é¡µé¢æ ·å¼ï¼šéšè—å¤´éƒ¨å’Œåº•éƒ¨å¯¼èˆªæ  */
      .mobile-mode-auth #mobile-container .mobile-header,
      .mobile-mode-auth #mobile-container .mobile-bottom-nav {
        display: none !important;
      }

      /* ç§»åŠ¨ç«¯è®¤è¯é¡µé¢æ ·å¼ï¼šå†…å®¹åŒºåŸŸå æ»¡å…¨å± */
      .mobile-mode-auth #mobile-container .mobile-content {
        padding-top: 0;
        /* ç§»é™¤é¡¶éƒ¨å¯¼èˆªæ ç©ºé—´ */
        padding-bottom: 0;
        /* ç§»é™¤åº•éƒ¨å¯¼èˆªæ ç©ºé—´ */
      }

      .mobile-mode .mobile-card {
        background: rgba(30, 41, 59, 0.85);
        /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
        border: 1px solid rgba(255, 255, 255, 0.1);
        /* æµ…è‰²è¾¹æ¡† */
        color: #e2e8f0;
        /* æµ…è‰²æ–‡å­— */
      }

      .mobile-mode .mobile-header,
      .mobile-mode .mobile-bottom-nav {
        background: rgba(15, 23, 42, 0.95);
        /* æ·±è‰²èƒŒæ™¯ */
        border-color: rgba(255, 255, 255, 0.1);
        /* æµ…è‰²è¾¹æ¡† */
      }

      .mobile-mode .mobile-title {
        color: #f1f5f9;
        /* æµ…è‰²æ ‡é¢˜ */
      }

      .mobile-mode .mobile-subtitle {
        color: #94a3b8;
        /* ä¸­ç°è‰²å‰¯æ ‡é¢˜ */
      }

      .mobile-mode input,
      .mobile-mode select,
      .mobile-mode textarea {
        background: rgba(30, 41, 59, 0.8);
        /* æ·±è‰²è¾“å…¥æ¡†èƒŒæ™¯ */
        color: #e2e8f0;
        /* æµ…è‰²æ–‡å­— */
        border-color: rgba(148, 163, 184, 0.3);
        /* è¾¹æ¡†é¢œè‰² */
      }
    }
  </style>

</head>

<body class="text-slate-800 font-sans h-screen overflow-hidden antialiased">

  <div id="cdn-error-overlay"
    class="fixed inset-0 z-9999 hidden flex-col items-center justify-center bg-[#f8fafc] p-8 text-center text-[#475569]"
    style="font-family: sans-serif;">
    <div style="max-width: 500px;">
      <h1 style="font-size: 1.875rem; font-weight: bold; color: #be123c; margin-bottom: 1rem;">ç•Œé¢èµ„æºåŠ è½½å¤±è´¥</h1>
      <p style="font-size: 1.125rem; margin-bottom: 1.5rem;">åº”ç”¨ç¨‹åºæ— æ³•è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œæœåŠ¡å™¨ï¼ˆCDNï¼‰æ¥ä¸‹è½½å¿…è¦çš„ç•Œé¢æ–‡ä»¶ï¼ˆå¦‚æ ·å¼å’Œåœ°å›¾åº“ï¼‰ã€‚</p>
      <div
        style="background-color: #f1f5f9; border-radius: 0.5rem; padding: 1rem; text-align: left; font-size: 0.875rem; line-height: 1.5;">
        <h2 style="font-weight: 600; color: #1e293b; margin-top: 0; margin-bottom: 0.75rem;">å¯èƒ½çš„åŸå› åŠè§£å†³æ–¹æ³•ï¼š</h2>
        <ul style="list-style-type: disc; padding-left: 1.25rem; margin: 0;">
          <li style="margin-bottom: 0.5rem;"><strong>æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥</strong>ï¼šè¯·ç¡®ä¿æ‚¨çš„è®¾å¤‡å·²è¿æ¥åˆ°äº’è”ç½‘ã€‚</li>
          <li style="margin-bottom: 0.5rem;"><strong>æ£€æŸ¥é˜²ç«å¢™æˆ–ä»£ç†</strong>ï¼šç³»ç»Ÿé˜²ç«å¢™ã€æ€æ¯’è½¯ä»¶æˆ–ç½‘ç»œä»£ç†å¯èƒ½é˜»æ­¢äº†ç¨‹åºè®¿é—®ç½‘ç»œã€‚</li>
          <li><strong>ç½‘ç»œç¯å¢ƒé—®é¢˜</strong>ï¼šæ‚¨å½“å‰çš„ç½‘ç»œç¯å¢ƒå¯èƒ½æ— æ³•ç¨³å®šè®¿é—®æ‰€éœ€çš„å¤–éƒ¨èµ„æºã€‚</li>
        </ul>
      </div>
      <p style="margin-top: 1.5rem; font-size: 0.875rem; color: #64748b;">è¯·æ£€æŸ¥ç½‘ç»œåï¼Œå®Œå…¨å…³é—­å¹¶é‡å¯æœ¬ç¨‹åºã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œæ‚¨å¯èƒ½éœ€è¦æ›´æ¢ç½‘ç»œç¯å¢ƒã€‚</p>
    </div>
  </div>

  <!-- æ¸¸å®¢è­¦å‘Šé®ç½©å±‚ï¼ˆèƒŒæ™¯å˜æš—ï¼‰-->
  <div id="guest_warning_overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden"></div>

  <!-- æ¸¸å®¢è­¦å‘Šå¼¹çª—ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰-->
  <div id="guest-warning-toast"
    class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl p-5 z-[1001] rounded-2xl hidden shadow-2xl transition-all duration-300 ease-out border-4 border-red-500"
    style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
    <div class="flex items-start gap-4" id="guest_warning">
      <div class="flex-shrink-0 w-10 h-10 text-red-600 mt-1 animate-pulse">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd"
            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="flex-1">
        <h3 class="text-xl font-bold text-red-700 mb-2">âš ï¸ æ¸¸å®¢æ¨¡å¼é‡è¦æç¤º</h3>
        <div class="text-base text-slate-800 space-y-2 font-medium">
          <p class="bg-white/60 px-3 py-2 rounded-lg">
            <strong class="text-red-600">âš ï¸ è¯·ç«‹å³ä¿å­˜å½“å‰ç½‘å€ï¼</strong> ä¸¢å¤±URLå°†æ— æ³•æ¢å¤æ‚¨çš„æ•°æ®ï¼
          </p>
          <p class="bg-white/60 px-3 py-2 rounded-lg">
            <strong>åŠŸèƒ½é™åˆ¶ï¼š</strong>æ— æ³•æ ‡è®°é€šçŸ¥å·²è¯»ã€æ— æ³•ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½ã€æ— æ³•æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡
          </p>
          <p class="bg-white/60 px-3 py-2 rounded-lg">
            <strong class="text-amber-700">â° è‡ªåŠ¨æ¸…ç†ï¼š</strong>5åˆ†é’Ÿä¸æ´»è·ƒä¼šè¯å°†è¢«è‡ªåŠ¨æ¸…ç†
          </p>
          <p class="mt-3 text-sm text-slate-600">
            ğŸ’¡ å»ºè®®ï¼š<span class="text-blue-600 font-semibold">è¯·æ³¨å†Œè´¦å·ä»¥è·å¾—å®Œæ•´åŠŸèƒ½å’Œæ°¸ä¹…æ•°æ®ä¿å­˜</span>
          </p>
        </div>
      </div>
      <button id="guest-warning-close-btn"
        class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-slate-600 hover:text-red-600 hover:bg-white/80 rounded-full transition-colors duration-200 -mt-2 -mr-2 font-bold text-xl">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
  <!-- æ–°ç”¨æˆ·æ·»åŠ æ¨¡æ€æ¡† -->
  <!-- é—®é¢˜3ä¿®å¤ï¼šæ·»åŠ æ–°ç”¨æˆ·æ¨¡æ€æ¡†ï¼ˆä¸æ³¨å†Œè¡¨å•ä¸€è‡´ï¼Œphoneå¯é€‰ï¼ŒéªŒè¯ç å¯å‘é€ä½†éå¿…éœ€ï¼‰ -->
  <div id="newUserModal" class="modal">
    <div class="panel rounded-2xl w-full max-w-md p-6 space-y-4 relative bg-white/95 shadow-xl">

      <button id="newUserClose"
        class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>

      <h3 class="text-xl font-bold text-sky-700 text-center card-title">æ·»åŠ æ–°ç”¨æˆ·</h3>

      <div>
        <label for="newUsername" class="block text-sm font-semibold leading-6 text-slate-700">è´¦å·</label>
        <input type="text" id="newUsername" placeholder="è¯·è¾“å…¥è´¦å·ï¼ˆ3-20å­—ç¬¦ï¼Œä¸å«ä¸­æ–‡ï¼‰" class="input-field mt-1">
      </div>

      <div>
        <label for="newUserPhone" class="block text-sm font-semibold leading-6 text-slate-700">æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰</label>
        <input type="tel" id="newUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" inputmode="numeric" pattern="[0-9]*"
          class="input-field mt-1">
      </div>

      <div id="newUserSmsGroup" style="display:none;">
        <label for="newUserSmsCode" class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç ï¼ˆå¯é€‰ï¼‰</label>
        <div class="flex gap-2 mt-1">
          <input type="text" id="newUserSmsCode" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6" inputmode="numeric"
            pattern="[0-9]{6}" class="input-field flex-1">
          <button type="button" id="newUserSendCode" class="btn btn-primary whitespace-nowrap"
            style="min-height: 44px;">å‘é€éªŒè¯ç </button>
        </div>
      </div>

      <div>
        <label for="newUserNickname" class="block text-sm font-semibold leading-6 text-slate-700">æ˜µç§°</label>
        <input type="text" id="newUserNickname" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆå¯å«ä¸­æ–‡ï¼‰" class="input-field mt-1">
      </div>

      <div>
        <label for="newPassword" class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6å­—ç¬¦ï¼‰" class="input-field mt-1">
      </div>

      <div>
        <label for="newPasswordConfirm" class="block text-sm font-semibold leading-6 text-slate-700">ç¡®è®¤å¯†ç </label>
        <input type="password" id="newPasswordConfirm" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " class="input-field mt-1">
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
        <button id="newUserCancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button id="newUserConfirm" class="btn btn-primary">ç¡®è®¤</button>
      </div>
    </div>
  </div>


  <div id="multi-add-user-modal" class="modal">
    <div class="panel rounded-2xl w-full max-w-md p-6 space-y-4 relative bg-white/95 shadow-xl">
      <button id="multi-add-user-close"
        class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
      <h3 class="text-xl font-bold text-sky-700 text-center card-title">æ·»åŠ æ–°è´¦å·</h3>
      <!-- <p class="text-sm text-slate-500 text-center -mt-2">ï¼ˆæ­¤æ“ä½œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„å­¦æ ¡è´¦å· .ini é…ç½®æ–‡ä»¶ï¼‰</p> -->

      <div>
        <label for="multi-add-username" class="block text-sm font-semibold leading-6 text-slate-700">è´¦å· (å¿…å¡«)</label>
        <input type="text" id="multi-add-username" placeholder="è¯·è¾“å…¥è´¦å·ï¼ˆä¾‹å¦‚å­¦å·ï¼‰" class="input-field mt-1">
      </div>
      <div>
        <label for="multi-add-password" class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç  (å¿…å¡«)</label>
        <input type="password" id="multi-add-password" placeholder="è¯·è¾“å…¥å¯†ç  (è‡³å°‘6å­—ç¬¦)" class="input-field mt-1">
      </div>
      <div>
        <label for="multi-add-tag" class="block text-sm font-semibold leading-6 text-slate-700">æ ‡è®° (å¯é€‰)</label>
        <input type="text" id="multi-add-tag" placeholder="å¯é€‰ï¼Œç”¨äºåˆ†ç»„ (ä¾‹å¦‚: 'Aç»„')" class="input-field mt-1">
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
        <button id="multi-add-user-cancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button id="multi-add-user-confirm" class="btn btn-primary">ç¡®è®¤æ·»åŠ </button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <div id="loading-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center gap-6 bg-white/80">
    <div class="loader"></div>
    <p class="text-base font-bold text-sky-600">æ­£åœ¨åŠ è½½èµ„æºä¸­...</p>
  </div>

  <!-- ç”¨æˆ·è®¤è¯ç™»å½•ç•Œé¢ -->
  <div id="auth-login-container" class="hidden w-full h-full flex items-center justify-center">
    <div class="panel rounded-2xl w-full max-w-md p-6 space-y-6">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-sky-700 card-title mb-2">è·‘æ­¥åŠ©æ‰‹</h2>
        <p class="text-sm text-slate-500">è¯·ç™»å½•æˆ–æ³¨å†Œä»¥ç»§ç»­ä½¿ç”¨</p>
      </div>

      <!-- ç™»å½•/æ³¨å†Œåˆ‡æ¢æ ‡ç­¾ -->
      <div class="flex border-b border-slate-200">
        <button id="auth-tab-login"
          class="flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition">ç™»å½•</button>
        <button id="auth-tab-register"
          class="flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition hover:text-slate-600">æ³¨å†Œ</button>
      </div>

      <!-- ç™»å½•è¡¨å• -->
      <div id="auth-login-form" class="space-y-4">
        <!-- ä»»åŠ¡9: æ‰‹æœºå·/ç”¨æˆ·åç™»å½•åˆ‡æ¢ -->
        <div id="auth-login-type-toggle" class="flex justify-center gap-2 pb-2">
          <button id="auth-login-username-btn"
            class="px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm">
            ç”¨æˆ·åç™»å½•
          </button>
          <button id="auth-login-phone-btn" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm">
            æ‰‹æœºå·ç™»å½•
          </button>
        </div>

        <!-- ç”¨æˆ·å/æ‰‹æœºå·è¾“å…¥åŒºåŸŸ - æ”¯æŒåŠ¨æ€åˆ‡æ¢+86å‰ç¼€ -->
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700" id="auth-login-label">ç”¨æˆ·å</label>
          <!-- auth-username-container: å®¹å™¨ç”¨äºåŒ…è£¹è¾“å…¥æ¡†ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ /ç§»é™¤phone-input-wrapper -->
          <div id="auth-username-container">
            <!-- é»˜è®¤çŠ¶æ€ï¼šç”¨æˆ·åç™»å½•ï¼Œæ— å‰ç¼€ -->
            <input type="text" id="auth-username" class="input-field mt-1" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
          </div>
        </div>

        <!-- å¯†ç ç™»å½•åŒºåŸŸ -->
        <div id="auth-password-section">
          <div class="flex justify-between items-center">
            <label class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
            <button type="button" id="auth-switch-to-sms" class="text-xs text-sky-600 hover:text-sky-700 hidden">
              ä½¿ç”¨éªŒè¯ç ç™»å½•
            </button>
          </div>
          <input type="password" id="auth-password" class="input-field mt-1" placeholder="è¯·è¾“å…¥å¯†ç "
            autocomplete="current-password">
        </div>

        <!-- éªŒè¯ç ç™»å½•åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="auth-sms-section" class="hidden">
          <div class="flex justify-between items-center">
            <label class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç </label>
            <button type="button" id="auth-switch-to-password" class="text-xs text-sky-600 hover:text-sky-700">
              ä½¿ç”¨å¯†ç ç™»å½•
            </button>
          </div>
          <div class="flex gap-2 mt-1">
            <input type="text" id="auth-sms-code" class="input-field flex-1" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}">
            <button type="button" id="auth-send-login-code" class="btn btn-primary whitespace-nowrap"
              style="min-height: 44px;">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>

        <button id="auth-login-btn" class="btn btn-primary w-full py-3" style="min-height: 44px;">ç™»å½•</button>
        <div id="guest-login-section" class="text-center hidden">
          <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-slate-200"></div>
            <span class="flex-shrink mx-4 text-slate-400 text-xs">æˆ–</span>
            <div class="flex-grow border-t border-slate-200"></div>
          </div>
          <button id="auth-guest-btn" class="btn btn-ghost w-full">ä»¥æ¸¸å®¢èº«ä»½ç»§ç»­</button>
          <!-- æ¸¸å®¢æ¨¡å¼è­¦å‘Š -->
          <div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-left">
            <div class="flex items-start gap-2">
              <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" />
              </svg>
              <div class="text-xs text-amber-800">
                <p class="font-semibold mb-1">âš ï¸ æ¸¸å®¢æ¨¡å¼æç¤º</p>
                <ul class="space-y-1">
                  <li>â€¢ æ¸¸å®¢ä½¿ç”¨UUIDæ¢å¤çŠ¶æ€ï¼Œè¯·åŠ¡å¿…ä¿å­˜åœ°å€</li>
                  <li>â€¢ ä¸¢å¤±URLå°†æ— æ³•æ¢å¤æ‚¨çš„æ•°æ®å’Œè¿›åº¦</li>
                  <li>â€¢ 5åˆ†é’Ÿä¸æ´»è·ƒä¼šè¯å°†è¢«è‡ªåŠ¨æ¸…ç†</li>
                  <li>â€¢ å»ºè®®æ³¨å†Œè´¦å·ä»¥è·å¾—æ›´å¥½çš„ä½“éªŒ</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ³¨å†Œè¡¨å• -->
      <div id="auth-register-form" class="hidden space-y-4 overflow-y-auto max-h-[60vh] p-1">
        <!-- ä»»åŠ¡8: ç”¨æˆ·åï¼ˆç¦æ­¢ä¸­æ–‡ï¼‰ -->
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">ç”¨æˆ·å</label>
          <input type="text" id="auth-reg-username" class="input-field mt-1" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20å­—ç¬¦ï¼Œä¸å«ä¸­æ–‡ï¼‰"
            autocomplete="username">
        </div>

        <!-- ä»»åŠ¡8: æ‰‹æœºå·ï¼ˆtype="tel"è§¦æ§ä¼˜åŒ–ï¼‰ -->
        <!-- æ·»åŠ äº†+86å‰ç¼€æ˜¾ç¤ºï¼Œä½¿ç”¨phone-input-wrapperå®¹å™¨å®ç°å‰ç¼€å’Œè¾“å…¥æ¡†çš„è§†è§‰æ•´åˆ -->
        <div id="auth-reg-phone-wrapper">
          <label class="block text-sm font-semibold leading-6 text-slate-700">æ‰‹æœºå·</label>
          <!-- phone-input-wrapper: åŒ…è£¹å‰ç¼€å’Œè¾“å…¥æ¡†ï¼Œæä¾›ç»Ÿä¸€çš„å¤–è§‚æ ·å¼ -->
          <div class="phone-input-wrapper mt-1">
            <!-- phone-prefix: ä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç å‰ç¼€ (+86åé¢æœ‰ç©ºæ ¼) -->
            <span class="phone-prefix">+86 </span>
            <!-- è¾“å…¥æ¡†ï¼šç§»é™¤äº†mt-1ç±»ï¼Œå› ä¸ºå®¹å™¨å·²ç»æœ‰äº†mt-1 -->
            <input type="tel" id="auth-reg-phone" class="input-field" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel"
              inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

        <!-- ä»»åŠ¡8: çŸ­ä¿¡éªŒè¯ç  + å‘é€æŒ‰é’® -->
        <div id="auth-reg-sms-wrapper">
          <label class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç </label>
          <div class="flex gap-2">
            <input type="text" id="auth-reg-sms-code" class="input-field mt-1 flex-1" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}">
            <button id="auth-reg-send-code-btn" class="btn btn-primary mt-1 whitespace-nowrap"
              style="min-height: 44px;">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>

        <!-- ä»»åŠ¡8: æ˜µç§°ï¼ˆå…è®¸ä¸­æ–‡ï¼‰ -->
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">æ˜µç§°</label>
          <input type="text" id="auth-reg-nickname" class="input-field mt-1" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆå¯å«ä¸­æ–‡ï¼‰">
        </div>

        <!-- ä»»åŠ¡8: å¤´åƒä¸Šä¼  -->
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">å¤´åƒ</label>
          <div class="flex items-center gap-3 mt-1">
            <img id="auth-reg-avatar-preview" src="/static/default_avatar.png"
              class="w-16 h-16 rounded-full object-cover border-2 border-slate-200">
            <input type="file" id="auth-reg-avatar" accept="image/*" class="hidden">
            <button class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm"
              onclick="document.getElementById('auth-reg-avatar').click(); return false;">
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
              </svg>
              ä¸Šä¼ å¤´åƒ
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
          <input type="password" id="auth-reg-password" class="input-field mt-1" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6å­—ç¬¦ï¼‰"
            autocomplete="new-password">
        </div>
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">ç¡®è®¤å¯†ç </label>
          <input type="password" id="auth-reg-password-confirm" class="input-field mt-1" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
            autocomplete="new-password">
        </div>
        <button id="auth-register-btn" class="btn btn-success w-full py-3" style="min-height: 44px;">æ³¨å†Œ</button>
      </div>

      <!-- 2FAéªŒè¯è¡¨å• -->
      <div id="auth-2fa-form" class="hidden space-y-4">
        <div class="text-center mb-4">
          <h3 class="text-xl font-bold text-sky-700 mb-2">åŒå› ç´ è®¤è¯</h3>
          <p class="text-sm text-slate-500">è¯·è¾“å…¥æ‚¨çš„éªŒè¯å™¨åº”ç”¨ä¸­çš„6ä½éªŒè¯ç </p>
        </div>
        <div id="auth-reg-sms-wrapper">
          <label class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç </label>
          <input type="text" id="auth-2fa-code" class="input-field mt-1" placeholder="è¾“å…¥6ä½éªŒè¯ç " maxlength="6"
            inputmode="numeric" pattern="[0-9]{6}" autocomplete="one-time-code">
        </div>
        <button id="auth-2fa-verify-btn" class="btn btn-primary w-full py-3">éªŒè¯</button>
        <button id="auth-2fa-back-btn" class="btn btn-ghost w-full">è¿”å›ç™»å½•</button>
      </div>

      <!-- é”™è¯¯æç¤º -->
      <div id="auth-error-msg"
        class="hidden text-sm text-center p-3 rounded-lg bg-red-50 border border-red-200 text-red-600"></div>
      <div id="auth-success-msg"
        class="hidden text-sm text-center p-3 rounded-lg bg-green-50 border border-green-200 text-green-600"></div>
    </div>
  </div>

  <!-- ========================================
       ã€æ¡Œé¢ç«¯å®¹å™¨ã€‘Desktop Container
       - åŒ…è£¹æ‰€æœ‰æ¡Œé¢ç«¯UIå…ƒç´ 
       - é»˜è®¤æ˜¾ç¤ºï¼Œå½“æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡æ—¶è‡ªåŠ¨éšè—
       - ä¿ç•™åŸæœ‰çš„æ‰€æœ‰åŠŸèƒ½å’Œå¸ƒå±€
       ======================================== -->
  <div id="desktop-container">
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-container" class="w-full h-full grid grid-cols-1 lg:grid-cols-3">
      <div
        class="flex flex-col items-center justify-center p-8 lg:p-12 bg-gradient-to-br from-purple-50 via-violet-50 to-purple-100 relative overflow-hidden">
        <!-- èƒŒæ™¯è£…é¥°åœ†å½¢ - å¢åŠ è§†è§‰æ·±åº¦ -->
        <div
          class="absolute top-0 right-0 w-64 h-64 bg-violet-200 rounded-full opacity-20 blur-3xl -translate-y-1/2 translate-x-1/2">
        </div>
        <div
          class="absolute bottom-0 left-0 w-48 h-48 bg-purple-300 rounded-full opacity-20 blur-2xl translate-y-1/2 -translate-x-1/2">
        </div>

        <!-- å†…å®¹å¡ç‰‡ - ç›¸å¯¹å®šä½ç¡®ä¿åœ¨è£…é¥°å±‚ä¹‹ä¸Š -->
        <div
          class="relative text-center w-full max-w-sm space-y-7 panel rounded-3xl p-10 bg-white/60 backdrop-blur-xl shadow-2xl border border-white/50 hover:shadow-violet-200/50 transition-all duration-500 hover:scale-[1.02]">

          <!-- å›¾æ ‡å®¹å™¨ - æ·»åŠ å‘å…‰æ•ˆæœ -->
          <div class="relative inline-block">
            <!-- å›¾æ ‡èƒŒæ™¯å…‰æ™• -->
            <div class="absolute inset-0 bg-violet-400 rounded-full blur-2xl opacity-30 animate-pulse"></div>

            <!-- åŒäººå›¾æ ‡ - è±¡å¾å¤šè´¦å·åŠŸèƒ½ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="relative w-20 h-20 mx-auto text-violet-600 drop-shadow-lg"
              viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
            </svg>
          </div>

          <!-- æ ‡é¢˜ - æ¸å˜æ–‡å­—æ•ˆæœ -->
          <h2
            class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-violet-600 to-purple-600 bg-clip-text text-transparent card-title leading-tight">
            æŒä¸Šè²å³°<br>å¤šè´¦å·æ¨¡å¼
          </h2>

          <!-- æè¿°æ–‡å­— - å¢åŠ å›¾æ ‡ç‚¹ç¼€ -->
          <div class="space-y-3">
            <p class="text-slate-600 text-base leading-relaxed">
              âœ¨ æ”¯æŒæ‰¹é‡å¯¼å…¥è´¦å·<br>
              ğŸ¯ ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä»»åŠ¡<br>
              âš¡ ä¸€é”®æ‰§è¡Œå…¨éƒ¨æµç¨‹
            </p>
          </div>

          <!-- è¿›å…¥æŒ‰é’® - ç´«è‰²æ¸å˜ä¸»é¢˜ï¼Œå¢åŠ æ‚¬åœåŠ¨æ•ˆ -->
          <button id="multi-account-btn"
            class="btn btn-secondary w-full py-3.5 text-lg font-bold shadow-xl shadow-violet-300/40 hover:shadow-2xl hover:shadow-violet-400/50 transition-all duration-300">
            <span>è¿›å…¥å¤šè´¦å·æ§åˆ¶å°</span>
            <!-- å³ç®­å¤´å›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>




      <div
        class="flex items-center justify-center p-6 lg:p-8 bg-gradient-to-br from-white via-sky-50/30 to-cyan-50/40 relative overflow-hidden">

        <!-- èƒŒæ™¯è£…é¥°å…ƒç´  - æŸ”å’Œçš„å‡ ä½•å›¾å½¢ -->
        <div
          class="absolute top-0 right-0 w-64 h-64 bg-sky-300 rounded-full opacity-10 blur-3xl translate-x-1/3 -translate-y-1/3">
        </div>
        <div
          class="absolute bottom-0 left-0 w-48 h-48 bg-cyan-200 rounded-full opacity-15 blur-2xl -translate-x-1/4 translate-y-1/4">
        </div>

        <!-- ç™»å½•è¡¨å•ä¸»å¡ç‰‡ -->
        <div
          class="relative panel rounded-3xl w-full max-w-md p-10 space-y-7 shadow-2xl border border-white/60 hover:shadow-sky-200/40 transition-all duration-300">

          <!-- è¡¨å•æ ‡é¢˜åŒºåŸŸ - æ·»åŠ å›¾æ ‡è£…é¥° -->
          <div class="flex items-center justify-center gap-3 pb-2">
            <!-- ç™»å½•å›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-sky-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <h2 class="text-3xl lg:text-4xl font-bold text-sky-700 card-title">å•è´¦å·ç™»å½•</h2>
          </div>

          <!-- å‰¯æ ‡é¢˜ - äº§å“åç§° -->
          <div class="text-center">
            <p class="text-slate-500 text-sm">æŒä¸Šè²å³°è·‘æ­¥åŠ©æ‰‹</p>
          </div>

          <!-- è¡¨å•è¾“å…¥åŒºåŸŸ - ç»Ÿä¸€çš„é—´è·å’Œæ ·å¼ -->
          <div class="space-y-5 w-full">

            <!-- è´¦å·é€‰æ‹©ä¸‹æ‹‰æ¡† -->
            <div class="space-y-2">
              <label class="block text-sm font-bold leading-6 text-slate-700 flex items-center gap-2">
                <!-- è´¦å·å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                é€‰æ‹©è´¦å·
              </label>
              <!-- ä¸‹æ‹‰é€‰æ‹©æ¡† - æ”¯æŒå¿«é€Ÿåˆ‡æ¢å·²ä¿å­˜çš„è´¦å· -->
              <select id="user-combo"
                class="select-field hover:border-sky-400 focus:border-sky-600 cursor-pointer transition-all duration-200"
                title="é€‰æ‹©å·²ä¿å­˜çš„è´¦å·æˆ–åˆ›å»ºæ–°è´¦å·" aria-label="é€‰æ‹©è´¦å·"></select>
            </div>

            <!-- ç”¨æˆ·åè¾“å…¥æ¡† -->
            <div class="space-y-2">
              <label class="block text-sm font-bold leading-6 text-slate-700 flex items-center gap-2">
                <!-- ç”¨æˆ·å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                ç”¨æˆ·å
              </label>
              <!-- æ–‡æœ¬è¾“å…¥æ¡† - è¾“å…¥å­¦å·æˆ–å·¥å· -->
              <input type="text" id="username-entry"
                class="input-field hover:border-sky-400 focus:border-sky-600 transition-all duration-200"
                placeholder="è¯·è¾“å…¥å­¦å·æˆ–å·¥å·" autocomplete="username">
            </div>

            <!-- å¯†ç è¾“å…¥æ¡† -->
            <div class="space-y-2">
              <label class="block text-sm font-bold leading-6 text-slate-700 flex items-center gap-2">
                <!-- é”å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                å¯†ç 
              </label>
              <!-- å¯†ç è¾“å…¥æ¡† - éšè—å­—ç¬¦æ˜¾ç¤º -->
              <input type="password" id="password-entry"
                class="input-field hover:border-sky-400 focus:border-sky-600 transition-all duration-200"
                placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
            </div>
          </div>

          <!-- ä¸»ç™»å½•æŒ‰é’® - å¤©è“è‰²æ¸å˜ï¼Œçªå‡ºä¸»è¦æ“ä½œ -->
          <button id="login-button"
            class="btn btn-primary w-full py-3.5 text-lg font-bold shadow-xl shadow-sky-300/40 hover:shadow-2xl hover:shadow-sky-400/50 transition-all duration-300">
            <span>ç«‹å³ç™»å½•</span>
            <!-- å³ç®­å¤´å›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z"
                clip-rule="evenodd" />
            </svg>
          </button>

          <!-- åˆ†éš”çº¿ - "æˆ–"æ–‡å­—å±…ä¸­ -->
          <div class="relative flex py-3 items-center">
            <div class="flex-grow border-t border-slate-300"></div>
            <span class="flex-shrink mx-5 text-slate-400 text-sm font-medium">æˆ–è€…</span>
            <div class="flex-grow border-t border-slate-300"></div>
          </div>

          <!-- æ¬¡è¦æ“ä½œæŒ‰é’® - å¯¼å…¥ç¦»çº¿æ–‡ä»¶ -->
          <button id="import-button"
            class="btn btn-success w-full py-3 font-bold shadow-lg shadow-green-300/30 hover:shadow-xl hover:shadow-green-400/40 transition-all duration-300">
            <!-- ä¸Šä¼ å›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span>å¯¼å…¥ç¦»çº¿æ–‡ä»¶</span>
          </button>

          <!-- User-Agent æ˜¾ç¤ºåŒºåŸŸ - é«˜çº§è®¾ç½® -->
          <div class="pt-4 space-y-3 border-t border-slate-200">

            <!-- æ ‡é¢˜æ ï¼šUAæ ‡ç­¾ + éšæœºæŒ‰é’® -->
            <div class="flex justify-between items-center">
              <span class="text-sm font-semibold text-slate-600 flex items-center gap-2">
                <!-- ä¿¡æ¯å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                User-Agent æ ‡è¯†
              </span>

              <!-- éšæœºç”ŸæˆUAæŒ‰é’® - ç”¨äºæ¨¡æ‹Ÿä¸åŒæµè§ˆå™¨ -->
              <button id="random-ua-btn" title="éšæœºç”Ÿæˆæ–°çš„User-Agentï¼Œç”¨äºæ¨¡æ‹Ÿä¸åŒè®¾å¤‡å’Œæµè§ˆå™¨"
                class="btn btn-ghost !py-1.5 !px-3 text-xs hover:bg-sky-100 transition-colors">
                <!-- åˆ·æ–°å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>éšæœº</span>
              </button>
            </div>

            <!-- UAæ˜¾ç¤ºæ¡† - æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„æµè§ˆå™¨æ ‡è¯†å­—ç¬¦ä¸² -->
            <p id="ua-label"
              class="text-xs text-slate-600 break-all bg-gradient-to-br from-white to-slate-50 border border-slate-300 p-3 rounded-xl leading-relaxed shadow-inner">
              (æœªåŠ è½½)
            </p>
          </div>
        </div>
      </div>









      <div
        class="flex flex-col items-center justify-center p-6 md:p-10 lg:p-12 bg-gradient-to-br from-sky-50 via-white to-cyan-50 relative overflow-hidden"
        id="admin-panel-modal-Inline">

        <!-- èƒŒæ™¯è£…é¥°æ³¢çº¹ - å¢åŠ è§†è§‰è¶£å‘³æ€§ -->
        <div
          class="absolute top-0 left-0 w-72 h-72 bg-sky-200 rounded-full opacity-10 blur-3xl -translate-y-1/3 -translate-x-1/3">
        </div>
        <div
          class="absolute bottom-0 right-0 w-56 h-56 bg-cyan-300 rounded-full opacity-10 blur-2xl translate-y-1/3 translate-x-1/3">
        </div>

        <!-- ä¼šè¯ç®¡ç†ä¸»é¢æ¿ - æ¯›ç»ç’ƒå¡ç‰‡ï¼Œæ”¯æŒå‚ç›´æ»šåŠ¨ -->
        <div
          class="relative panel rounded-3xl w-full max-w-2xl p-8 space-y-5 bg-white/80 backdrop-blur-xl flex flex-col overflow-x-hidden shadow-2xl border border-white/60 hover:shadow-sky-200/50 transition-shadow duration-300"
          style="max-height: calc(100vh - 12rem);">

          <!-- é¢æ¿æ ‡é¢˜ - å¤©è“è‰²ä¸»é¢˜ä¸ç³»ç»Ÿç»Ÿä¸€ -->
          <div class="flex items-center justify-center gap-2 pb-2 border-b border-sky-100">
            <!-- ç®¡ç†å›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-sky-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <h3 class="text-2xl font-bold text-sky-700 text-center">ä¼šè¯ç®¡ç†</h3>
          </div>

          <!-- ä¼šè¯ç®¡ç†æ ¸å¿ƒåŒºåŸŸ - å¯æ»šåŠ¨å®¹å™¨ -->
          <div id="admin-sessions-panel" class="space-y-4 overflow-y-auto overflow-x-hidden flex-grow min-h-0 pr-2">

            <!-- å·¥å…·æ ï¼šæ ‡é¢˜ã€ä¸Šå¸æ¨¡å¼å¼€å…³ã€è®¡æ•°ã€åˆ·æ–°æŒ‰é’® -->
            <div class="flex justify-between items-center bg-gradient-to-r from-sky-50 to-transparent p-4 rounded-xl">
              <h4 class="font-bold text-slate-700 text-lg">ä¼šè¯åˆ—è¡¨</h4>

              <!-- å³ä¾§å·¥å…·ç»„ -->
              <div class="flex items-center gap-4">

                <!-- ä¸Šå¸æ¨¡å¼åˆ‡æ¢ - é»˜è®¤éšè—ï¼Œç®¡ç†å‘˜å¯è§ -->
                <label id="god-mode-toggle"
                  class="flex items-center gap-2 cursor-pointer bg-red-50 px-3 py-1.5 rounded-full hover:bg-red-100 transition-colors"
                  style="display:none;">
                  <input type="checkbox" id="god-mode-checkbox" class="w-4 h-4 accent-red-600 rounded cursor-pointer">
                  <span class="text-sm font-bold text-red-600">âš ï¸ ä¸Šå¸æ¨¡å¼</span>
                </label>

                <!-- ä¼šè¯è®¡æ•°æ˜¾ç¤º - åŠ¨æ€æ›´æ–° -->
                <div id="admin-session-count-display-inline"
                  class="text-sm font-medium text-slate-600 bg-white/70 px-3 py-1.5 rounded-full border border-slate-200">
                  <!-- ä¼šè¯è®¡æ•°å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                </div>

                <!-- åˆ·æ–°æŒ‰é’® - æ‰‹åŠ¨é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨ -->
                <button id="admin-refresh-sessions-inline"
                  class="btn btn-ghost !py-1.5 !px-3 hover:bg-sky-100 transition-colors">
                  <!-- åˆ·æ–°å›¾æ ‡ -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  <span>åˆ·æ–°</span>
                </button>
              </div>
            </div>

            <!-- ä¼šè¯åˆ—è¡¨å®¹å™¨ - åŠ¨æ€å†…å®¹ç”±JavaScriptå¡«å…… -->
            <div id="admin-sessions-list-inline" class="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
              <!-- åŠ è½½ä¸­å ä½ç¬¦ - é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤º -->
              <p class="text-slate-400 text-center py-12 text-base">
                <!-- åŠ è½½åŠ¨ç”»å›¾æ ‡ -->
                <svg class="animate-spin h-8 w-8 mx-auto mb-3 text-sky-500" xmlns="http://www.w3.org/2000/svg"
                  fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
                æ­£åœ¨åŠ è½½ä¼šè¯æ•°æ®...
              </p>
            </div>
          </div>
        </div>
      </div>





    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <main id="main-app" class="hidden h-screen w-screen grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4">
      <!-- å·¦ä¾§é¢æ¿ -->
      <div class="lg:col-span-1 xl:col-span-1 flex flex-col gap-4 h-full min-h-0">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div class="panel rounded-xl p-4 flex items-center gap-4">
          <div class="flex-1 ">
            <p id="user-name-label" class="font-bold text-slate-800 truncate">å§“å: NULL</p>
            <p id="user-id-label" class="text-sm text-slate-500">å­¦å·: NULL</p>
          </div>

          <button id="show-notifications-btn" class="btn btn-ghost !py-2 !px-3 relative" title="æŸ¥çœ‹é€šçŸ¥">
            <span>é€šçŸ¥</span>
            <span id="notification-badge"
              class="hidden absolute -top-1 -right-1 w-4 h-4 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center">0</span>
          </button>
          <button id="show-user-details" class="btn btn-ghost !py-2 !px-3" title="æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…">è¯¦æƒ…</button>
          <button id="show-admin-panel" class="btn btn-ghost !py-2 !px-3 hidden" title="ç®¡ç†é¢æ¿">ç®¡ç†</button>
          <button id="logout-button" class="btn btn-ghost !py-2 !px-3 !text-red-600" title="æ³¨é”€">é€€å‡º</button>
        </div>
        <!-- ä»»åŠ¡åˆ—è¡¨é¢æ¿ -->
        <div class="panel rounded-xl p-4 flex-grow flex flex-col min-h-0">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-lg font-bold text-slate-800">ä»»åŠ¡åˆ—è¡¨</h2>
            <div class="flex gap-2">
              <button id="show-task-details" class="btn btn-ghost !py-1 !px-3">ä»»åŠ¡è¯¦æƒ…</button>
              <button id="refresh-button" class="btn btn-ghost !py-1 !px-3">åˆ·æ–°</button>
            </div>
          </div>
          <div id="task-list" class="flex-grow overflow-y-auto -mr-2 pr-2"></div>
        </div>
        <!-- æ§åˆ¶é¢æ¿ (é€‰é¡¹å¡) -->
        <div class="panel rounded-xl p-4">
          <div class="flex border-b border-slate-200 -mx-4 px-2 space-x-2">
            <button class="tab-button active" onclick="showTab('run-control', this)">æ‰§è¡Œ</button>
            <button class="tab-button" onclick="showTab('path-tools', this)">è·¯å¾„</button>
            <button class="tab-button" onclick="showTab('checkpoints', this)">æ‰“å¡ç‚¹</button>
            <button class="tab-button" onclick="showTab('attendance', this)">ç­¾åˆ°</button>
            <button class="tab-button" onclick="showTab('history', this)">å†å²</button>
            <button class="tab-button" onclick="showTab('params', this)">å‚æ•°</button>
            <button class="tab-button" onclick="showTab('log', this)">æ—¥å¿—</button>
          </div>
          <div class="h-56 overflow-y-auto">
            <!-- æ‰§è¡Œé€‰é¡¹å¡ -->
            <div id="run-control-tab" class="pt-4 space-y-3">
              <div id="run-stats-block" class="text-center p-3 rounded-lg border border-slate-200 bg-white/80">
                <p class="text-sm text-slate-500">å·²é€‰ä»»åŠ¡æ€»è§ˆ</p>
                <p id="run-stats-label" class="font-bold text-2xl text-sky-600">-- km / --:--</p>
              </div>

              <!-- å•ä»»åŠ¡è¿›åº¦æ¡ -->
              <div id="single-progress-block" class="mt-2">
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                  <div id="single-progress-fill" class="h-2 bg-sky-500" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                  <span id="single-progress-text" class="text-slate-600">æœªå¼€å§‹</span>
                  <span id="single-progress-extra" class="text-slate-400"></span>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <button id="start-run-button" class="btn btn-primary">å¼€å§‹æ‰§è¡Œ</button>
                <button id="start-all-button" class="btn btn-secondary">æ‰§è¡Œæ‰€æœ‰</button>
              </div>

              <div class="flex items-center justify-center space-x-4 pt-1">
                <label class="flex items-center gap-1.5 text-xs text-slate-700 cursor-pointer"><input type="checkbox"
                    id="run-completed-check" class="w-4 h-4 accent-sky-600 rounded"><span
                    class="font-semibold">å¿½ç•¥å·²å®ŒæˆçŠ¶æ€</span></label>
                <label class="flex items-center gap-1.5 text-xs text-slate-700 cursor-pointer"><input type="checkbox"
                    id="auto-gen-all-check" class="w-4 h-4 accent-sky-600 rounded"><span
                    class="font-semibold">è‡ªåŠ¨ç”Ÿæˆè·¯å¾„</span></label>
              </div>
            </div>
            <!-- è·¯å¾„å·¥å…·é€‰é¡¹å¡ -->
            <div id="path-tools-tab" class="hidden pt-4 space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <button id="record-button" class="btn btn-success">å½•åˆ¶è·¯å¾„</button>
                <button id="auto-gen-button" class="btn btn-secondary">è‡ªåŠ¨ç”Ÿæˆ</button>
                <button id="process-button" class="btn btn-primary">å¤„ç†è·¯å¾„</button>
                <button id="clear-button" class="btn btn-warning">æ¸…é™¤è·¯å¾„</button>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <button id="export-button" class="btn btn-ghost border border-slate-300 col-span-1">å¯¼å‡º</button>
                <div class="col-span-1"></div>
              </div>
            </div>
            <!-- æ‰“å¡ç‚¹é€‰é¡¹å¡ -->
            <div id="checkpoints-tab" class="hidden pt-2">
              <div id="target-points-text" class="h-48 overflow-y-auto"></div>
            </div>


            <div id="attendance-tab" class="hidden pt-2 space-y-2 h-56 flex flex-col">
              <div class="flex-shrink-0 space-y-2 border-b pb-2">
                <label class="flex items-center gap-2 cursor-pointer" title="å¼€å¯åï¼Œå°†åœ¨åå°è‡ªåŠ¨åˆ·æ–°é€šçŸ¥å¹¶å°è¯•ç­¾åˆ°">
                  <input type="checkbox" id="param-auto_attendance_enabled" data-key="auto_attendance_enabled"
                    class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0">
                  <span class="text-slate-700 font-semibold">å¼€å¯è‡ªåŠ¨ç­¾åˆ°</span>
                </label>

                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-700 font-semibold flex-shrink-0">åˆ·æ–°é—´éš”(ç§’)</label>
                  <input type="number" step="30" id="param-auto_attendance_refresh_s"
                    data-key="auto_attendance_refresh_s" class="input-field !py-1 w-full"
                    title="è‡ªåŠ¨åˆ·æ–°é€šçŸ¥çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå»ºè®®ä¸ä½äº60">
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-700 font-semibold flex-shrink-0">éšæœºåŠå¾„(ç±³)</label>
                  <input type="number" step="1" id="param-attendance_user_radius_m" data-key="attendance_user_radius_m"
                    class="input-field !py-1 w-full" title="è‡ªåŠ¨ç­¾åˆ°æ—¶ï¼Œåœ¨æœåŠ¡å™¨å…è®¸èŒƒå›´å†…çš„æœ€å¤§éšæœºåç§»åŠå¾„ã€‚è®¾ä¸º0ä¸ºç²¾ç¡®ç­¾åˆ°ã€‚">
                </div>
              </div>
              <div class="flex justify-between items-center border-t pt-2 mt-2">
                <h4 class="text-sm font-semibold text-slate-700">ç­¾åˆ°ä»»åŠ¡åˆ—è¡¨</h4>
                <button id="refresh-attendance-list-btn" class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600"
                  onclick="refreshNotificationsUI(true, true)">
                  åˆ·æ–°
                </button>
              </div>

              <div id="attendance-list" class="flex-grow overflow-y-auto pr-1">
                <p class="text-slate-400 text-center py-10 text-xs">ç‚¹å‡»â€œåˆ·æ–°â€æŒ‰é’®æŸ¥çœ‹ç­¾åˆ°ä»»åŠ¡</p>
              </div>
            </div>

            <!-- å†å²è®°å½•é€‰é¡¹å¡ -->
            <div id="history-tab" class="hidden pt-2">
              <div id="history-list-container">
                <p id="history-placeholder" class="text-slate-400 text-center py-16">é€‰æ‹©ä»»åŠ¡åæ˜¾ç¤ºå†å²è®°å½•</p>
                <div id="history-list"></div>
              </div>
            </div>
            <!-- å‚æ•°è®¾ç½®é€‰é¡¹å¡ -->
            <div id="params-tab" class="hidden space-y-3">
              <div id="params-container"></div>
            </div>
            <!-- æ—¥å¿—é€‰é¡¹å¡ -->
            <div id="log-tab" class="hidden pt-2">
              <div class="h-48">
                <textarea id="log-text" readonly
                  class="w-full h-full bg-white/80 border border-slate-200 rounded-md p-2 text-xs text-slate-700 resize-none focus:outline-none leading-snug"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ä¸»åŒºåŸŸ -->
      <div class="lg:col-span-2 xl:col-span-3 flex flex-col gap-4 h-full min-h-0">
        <!-- åœ°å›¾å®¹å™¨ -->
        <div id="map-container"
          class="flex-grow bg-slate-200 rounded-xl relative overflow-hidden border border-slate-200">
          <div
            class="absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200">
            <button id="zoom-in"
              class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
            <span id="zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
            <button id="zoom-out"
              class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
            <button id="reset-view-btn"
              class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700"
              title="å¤ä½è§†è§’">ğŸ¯</button>
          </div>
        </div>
        <!-- åº•éƒ¨ä¿¡æ¯é¢æ¿ -->
        <div class="grid grid-cols-1 gap-4">
          <!-- å®æ—¶çŠ¶æ€ -->
          <div class="panel rounded-xl p-4 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <h3 class="font-bold text-slate-800">å®æ—¶çŠ¶æ€</h3>
              <p class="text-sm font-mono text-slate-500" id="current-location-label">å½“å‰ä½ç½®GPSåæ ‡: --, --</p>
            </div>
            <div class="grid grid-cols-4 divide-x divide-slate-200 text-center pt-2">
              <div>
                <p class="text-sm text-slate-500">å·²è·‘è·ç¦»</p>
                <p id="live-dist-label" class="font-bold text-xl text-slate-700">0.00 km</p>
              </div>
              <div>
                <p class="text-sm text-slate-500">æ€»è·ç¦»</p>
                <p id="total-dist-label" class="font-bold text-xl text-slate-700">0.00 km</p>
              </div>
              <div>
                <p class="text-sm text-slate-500">å·²ç”¨æ—¶é—´</p>
                <p id="live-time-label" class="font-bold text-xl text-slate-700">00:00</p>
              </div>
              <div>
                <p class="text-sm text-slate-500">é¢„è®¡æ—¶é—´</p>
                <p id="total-time-label" class="font-bold text-xl text-slate-700">00:00</p>
              </div>
            </div>
          </div>
        </div>
      </div>


    </main>

    <main id="multi-account-app"
      class="hidden h-screen w-screen grid grid-cols-1 lg:grid-cols-[530px,1fr] xl:grid-cols-[530px,1fr] gap-4 p-4">
      <div class="flex flex-col gap-4 h-full min-h-0">
        <div class="panel rounded-xl p-4 flex-shrink-0">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-lg font-bold text-slate-800 card-title">å¤šè´¦å·æ§åˆ¶å°</h2>
            <div class="flex gap-2">
              <!-- <button id="show-sessions-multi" class="btn btn-ghost !py-1 !px-3" title="ä¼šè¯ç®¡ç†">ä¼šè¯</button> -->
              <button id="show-admin-panel-multi" class="btn btn-ghost !py-1 !px-3" title="ç®¡ç†é¢æ¿">ç®¡ç†é¢æ¿</button>
              <button id="exit-multi-mode-btn" class="btn btn-ghost !py-1 !px-3">è¿”å›ç™»å½•é¡µ</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button id="multi-start-all-btn" class="btn btn-primary">å…¨éƒ¨å¼€å§‹</button>
            <button id="multi-stop-all-btn" class="btn btn-danger">å…¨éƒ¨åœæ­¢</button>
          </div>
          <div class="mt-4 space-y-2 text-sm border-t pt-3">
            <label class="flex items-center gap-2 cursor-pointer font-semibold text-slate-700">
              <input type="checkbox" id="multi-use-delay-check" checked class="w-4 h-4 accent-sky-600 rounded">
              å¯ç”¨éšæœºå¯åŠ¨å»¶è¿Ÿ
              <div class="flex items-center gap-2 pl-6">
                <input type="number" id="multi-min-delay-input" value="0" class="input-field !py-1 w-20 text-center">
                <span>-</span>
                <input type="number" id="multi-max-delay-input" value="300" class="input-field !py-1 w-20 text-center">
                <span>ç§’</span>
              </div>
            </label>
            <label class="flex items-center gap-2 cursor-pointer font-semibold text-slate-700 mt-2">
              <input type="checkbox" id="multi-run-only-incomplete-check" checked
                class="w-4 h-4 accent-sky-600 rounded">
              ä»…æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡
            </label>
          </div>
        </div>
        <div class="panel rounded-xl p-4 flex-grow flex flex-col min-h-0">
          <div class="flex justify-between items-center mb-1">
            <div class="flex items-center gap-2">
              <h2 class="text-lg font-bold text-slate-800">è´¦å·åˆ—è¡¨ (<span id="multi-account-count">0</span>)</h2>
              <input type="checkbox" id="multi-select-all-check" class="w-4 h-4 accent-sky-600 rounded" title="å…¨é€‰/å–æ¶ˆå…¨é€‰"
                style="display: none;">
            </div>
            <div class="flex gap-2">
              <button id="multi-import-excel-btn" class="btn btn-ghost !py-1 !px-3" title="ä»æ–‡ä»¶å¯¼å…¥">å¯¼å…¥</button>
              <button id="multi-export-excel-btn" class="btn btn-ghost !py-1 !px-3" title="å¯¼å‡ºæ±‡æ€»">å¯¼å‡º</button>
              <button id="multi-download-template-btn" class="btn btn-ghost !py-1 !px-3" title="ä¸‹è½½å¯¼å…¥æ¨¡æ¿">ä¸‹è½½æ¨¡æ¿</button>
            </div>

          </div>








          <div class="flex items-center justify-between mb-3 text-xs border-b pb-2">
            <!-- å·¦ä¾§ï¼šåˆ·æ–° -->
            <div class="flex items-center gap-2">

              <button id="multi-refresh-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-blue-600">
                åˆ·æ–°é€‰ä¸­
              </button>
              <button id="multi-refresh-all-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-blue-600">
                åˆ·æ–°å…¨éƒ¨
              </button>
            </div>

            <!-- ä¸­å¤®ï¼šæ§åˆ¶ -->
            <div class="flex items-center gap-2">

              <button id="multi-start-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-green-600">
                å¼€å§‹é€‰ä¸­
              </button>
              <button id="multi-stop-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-green-600">
                åœæ­¢é€‰ä¸­
              </button>
            </div>

            <!-- å³ä¾§ï¼šç§»é™¤ -->
            <div class="flex items-center gap-2">

              <button id="multi-remove-selected-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-red-600">
                ç§»é™¤é€‰ä¸­
              </button>
              <button id="multi-remove-all-btn" class="btn btn-ghost !py-0.5 !px-2 text-sm text-red-600">
                ç§»é™¤å…¨éƒ¨
              </button>
            </div>
          </div>





















          <div id="multi-account-list" class="flex-grow overflow-y-auto -mr-2 pr-2" style="max-height: 42vh;">
            <p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>
          </div>
          <div class="mt-2 border-t pt-3 flex items-center gap-2">
            <select id="multi-config-user-select" class="select-field !py-1 flex-grow"></select>
            <button id="multi-add-from-config-btn" class="btn btn-ghost !py-1 !px-2 flex-shrink-0">æ·»åŠ </button>
            <button id="multi-load-all-from-config-btn" class="btn btn-ghost !py-1 !px-2 flex-shrink-0">æ·»åŠ å…¨éƒ¨</button>
          </div>
        </div>
        <div class="panel rounded-xl p-4 flex-shrink-0">
          <h3 class="font-bold text-slate-800 mb-2">å…¨å±€å‚æ•°</h3>
          <div id="multi-global-params-container" class="h-40 overflow-y-auto pr-1"></div>
        </div>
      </div>
      <div class="flex flex-col gap-4 h-full min-h-0">
        <div id="multi-map-container"
          class="flex-grow bg-slate-200 rounded-xl relative overflow-hidden border border-slate-200">
          <div
            class="absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200">
            <button id="multi-zoom-in"
              class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
            <span id="multi-zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
            <button id="multi-zoom-out"
              class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
            <button id="multi-reset-view-btn"
              class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700"
              title="å¤ä½è§†è§’">ğŸ¯</button>
          </div>
        </div>
        <div class="panel rounded-xl p-4 h-48 flex flex-col">
          <h3 class="font-bold text-slate-800 mb-2">å…¨å±€æ—¥å¿—</h3>
          <textarea id="multi-log-text" readonly
            class="w-full flex-grow bg-white/80 border border-slate-200 rounded-md p-2 text-xs text-slate-700 resize-none focus:outline-none leading-snug"></textarea>
        </div>
      </div>
    </main>

    <!-- æ¨¡æ€å¯¹è¯æ¡† -->
    <div id="amap-key-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
        <h3 class="text-xl font-bold text-red-600 text-center">ç¼ºå°‘åœ°å›¾API Key</h3>
        <p class="text-sm text-slate-600 text-center">
          ç¨‹åºéœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„é«˜å¾·åœ°å›¾JS API Keyæ‰èƒ½ä½¿ç”¨åœ°å›¾åŠŸèƒ½ã€‚è¯·å‰å¾€
          <a href="https://console.amap.com/dev/key/app" target="_blank" class="text-sky-600 hover:underline">é«˜å¾·å¼€æ”¾å¹³å°</a>
          ç”³è¯·ä¸€ä¸ªKeyï¼ˆç±»å‹é€‰æ‹©â€œWebç«¯(JS API)â€ï¼‰ï¼Œç„¶åç²˜è´´åˆ°ä¸‹æ–¹ã€‚
        </p>
        <div class="space-y-2">
          <label class="w-full text-slate-700 font-semibold">API Key:</label>
          <input id="amap-key-input" type="text" class="input-field w-full" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ä½ çš„API Key">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button id="confirm-amap-key-btn" class="btn btn-primary">ç¡®è®¤å¹¶ä¿å­˜</button>
        </div>
      </div>
    </div>







    <div id="auto-gen-modal" class="fixed inset-0 flex items-center justify-center hidden z-50">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="panel rounded-2xl p-6 w-96 space-y-6 relative">
        <h3 class="text-xl font-bold text-sky-600 text-center">è‡ªåŠ¨ç”Ÿæˆè·¯çº¿é…ç½®</h3>
        <div class="space-y-4">
          <div class="flex items-center">
            <label class="w-32 text-slate-700 font-semibold">æœ€çŸ­æ—¶é—´(åˆ†é’Ÿ)</label>
            <input id="min-time-input" type="number" value="20" class="input-field w-full">
          </div>
          <div class="flex items-center">
            <label class="w-32 text-slate-700 font-semibold">æœ€é•¿æ—¶é—´(åˆ†é’Ÿ)</label>
            <input id="max-time-input" type="number" value="30" class="input-field w-full">
          </div>
          <div class="flex items-center">
            <label class="w-32 text-slate-700 font-semibold">æœ€çŸ­è·ç¦»(ç±³)</label>
            <input id="min-dist-input" type="number" value="2000" class="input-field w-full">
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button id="cancel-gen-button" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
          <button id="confirm-gen-button" class="btn btn-primary">ç”Ÿæˆ</button>
        </div>
      </div>
    </div>
    <div id="user-details-modal" class="fixed inset-0 hidden items-center justify-center z-50">
      <div class="absolute inset-0 bg-black/40" onclick="toggleUserDetails(false)"></div>
      <div class="panel rounded-2xl p-6 w-[32rem] space-y-4 relative">
        <div class="flex items-center justify-center gap-2">
          <h3 class="text-xl font-bold text-sky-600 text-center">ç”¨æˆ·è¯¦æƒ…</h3>
        </div>
        <div id="user-details-content" class="text-sm space-y-1 max-h-[70vh] overflow-y-auto"></div>
        <div class="flex justify-end pt-2"><button class="btn btn-ghost border border-slate-300"
            onclick="toggleUserDetails(false)">å…³é—­</button></div>
      </div>
    </div>
    <div id="task-details-modal" class="fixed inset-0 hidden items-center justify-center z-50">
      <div class="absolute inset-0 bg-black/40" onclick="toggleTaskDetails(false)"></div>
      <div class="panel rounded-2xl p-6 w-[36rem] space-y-4 relative">
        <div class="flex items-center justify-center gap-2">
          <h3 class="text-xl font-bold text-sky-600 text-center">ä»»åŠ¡è¯¦æƒ…</h3>
        </div>
        <div id="task-details-content" class="text-sm space-y-1 max-h-[70vh] overflow-y-auto"></div>
        <div class="flex justify-end pt-2"><button class="btn btn-ghost border border-slate-300"
            onclick="toggleTaskDetails(false)">å…³é—­</button></div>
      </div>
    </div>
    <!-- ç»“æŸï¼šæ¡Œé¢ç«¯å®¹å™¨ -->
  </div>

  <!-- ========================================
       ã€ç§»åŠ¨ç«¯å®¹å™¨ã€‘Mobile Container
       - ä¸“ä¸ºæ™ºèƒ½æ‰‹æœºç§»åŠ¨ç»ˆç«¯è®¾è®¡çš„UIå®¹å™¨
       - é»˜è®¤éšè—ï¼Œå½“æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡æ—¶è‡ªåŠ¨æ˜¾ç¤º
       - è§¦å±ä¼˜åŒ–çš„å•åˆ—å¸ƒå±€ï¼Œæ›´å¤§çš„æŒ‰é’®å’Œè¾“å…¥æ¡†
       ======================================== -->
  <div id="mobile-container">
    <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="mobile-header hidden" id="mobile-header" style="display:none;">
      <!-- å·¦ä¾§ï¼šLogoæˆ–è¿”å›æŒ‰é’® -->
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
          <!-- è·‘æ­¥å›¾æ ‡ -->
          <path
            d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z" />
        </svg>
        <span class="ml-2 text-lg font-bold text-slate-800">è·‘æ­¥åŠ©æ‰‹</span>
      </div>

      <!-- å³ä¾§ï¼šèœå•æŒ‰é’® -->
      <button id="mobile-menu-btn" class="p-2" aria-label="èœå•" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-slate-700" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </header>

    <!-- ========================================
         ã€ç§»åŠ¨ç«¯å†…å®¹åŒºåŸŸã€‘ä¸»å®¹å™¨
         - åŒ…å«æ‰€æœ‰ç§»åŠ¨ç«¯UIç»„ä»¶
         - é»˜è®¤éšè—ï¼Œç”±JavaScriptæ ¹æ®è®¾å¤‡ç±»å‹æ§åˆ¶æ˜¾ç¤º
         ======================================== -->
    <main class="mobile-content">

      <!-- ========================================
           ã€å®¹å™¨1ã€‘ç§»åŠ¨ç«¯ç”¨æˆ·è®¤è¯å®¹å™¨
           - å¯¹åº”PCç«¯çš„ auth-login-container
           - åŒ…å«ç™»å½•/æ³¨å†Œæ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
           - åŒ…å«ç™»å½•è¡¨å•å’Œæ³¨å†Œè¡¨å•
           - ä½¿ç”¨ç§»åŠ¨ç«¯å‹å¥½çš„å¡ç‰‡å¸ƒå±€
           ======================================== -->
      <div id="mobile-auth-login-container" class="space-y-4">

        <div class="mobile-card">

          <div class="text-center mb-6">
            <h1 class="mobile-title">æ¬¢è¿ä½¿ç”¨è·‘æ­¥åŠ©æ‰‹</h1>
            <p class="mobile-subtitle">è¯·ç™»å½•æˆ–æ³¨å†Œä»¥ç»§ç»­ä½¿ç”¨</p>
          </div>

          <div class="flex border-b border-slate-200 mb-4">
            <button id="mobile-auth-tab-login"
              class="flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition">
              ç™»å½•
            </button>
            <button id="mobile-auth-tab-register"
              class="flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition">
              æ³¨å†Œ
            </button>
          </div>

          <div id="mobile-login-form" class="space-y-4">

            <div class="flex justify-center gap-2 pb-2">
              <button id="mobile-login-username-btn"
                class="px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm">
                ç”¨æˆ·åç™»å½•
              </button>
              <button id="mobile-login-phone-btn" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm">
                æ‰‹æœºå·ç™»å½•
              </button>
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label" id="mobile-login-label">ç”¨æˆ·å</label>
              <div id="mobile-username-container" class="mt-1">
                <input type="text" id="mobile-auth-username" class="w-full" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                  autocomplete="username">
              </div>
            </div>

            <div id="mobile-password-section" class="mobile-form-group">
              <div class="flex justify-between items-center mb-2">
                <label class="mobile-form-label !mb-0">å¯†ç </label>
                <button type="button" id="mobile-switch-to-sms" class="text-sm text-sky-600 hover:text-sky-700 hidden">
                  ä½¿ç”¨éªŒè¯ç 
                </button>
              </div>
              <input type="password" id="mobile-auth-password" class="w-full" placeholder="è¯·è¾“å…¥å¯†ç "
                autocomplete="current-password">
            </div>

            <div id="mobile-sms-section" class="mobile-form-group hidden">
              <div class="flex justify-between items-center mb-2">
                <label class="mobile-form-label !mb-0">éªŒè¯ç </label>
                <button type="button" id="mobile-switch-to-password" class="text-sm text-sky-600 hover:text-sky-700">
                  ä½¿ç”¨å¯†ç 
                </button>
              </div>
              <div class="flex gap-2">
                <input type="text" id="mobile-auth-sms-code" class="w-full flex-1" placeholder="6ä½éªŒè¯ç " maxlength="6"
                  inputmode="numeric">
                <button type="button" id="mobile-auth-send-login-code"
                  class="btn btn-primary whitespace-nowrap !py-0 !px-4 !text-base">
                  å‘é€
                </button>
              </div>
            </div>

            <button id="mobile-login-btn" class="mobile-primary-btn">
              ç™»å½•
            </button>

            <div id="mobile-guest-login-section" class="text-center hidden">
              <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-slate-200"></div>
                <span class="flex-shrink mx-4 text-slate-400 text-xs">æˆ–</span>
                <div class="flex-grow border-t border-slate-200"></div>
              </div>
              <button id="mobile-guest-btn" class="mobile-secondary-btn">
                ä»¥æ¸¸å®¢èº«ä»½ç»§ç»­
              </button>
            </div>
          </div>

          <div id="mobile-register-form" class="space-y-4 hidden">

            <div class="mobile-form-group">
              <label class="mobile-form-label">ç”¨æˆ·å</label>
              <input type="text" id="mobile-reg-username" class="w-full" placeholder="3-20å­—ç¬¦ï¼Œä¸å«ä¸­æ–‡"
                autocomplete="username">
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">æ‰‹æœºå·</label>
              <div class="phone-input-wrapper mt-1">
                <span class="phone-prefix">+86 </span>
                <input type="tel" id="mobile-reg-phone" class="input-field" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel"
                  inputmode="numeric" maxlength="11">
              </div>
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">éªŒè¯ç </label>
              <div class="flex gap-2">
                <input type="text" id="mobile-reg-sms-code" class="w-full flex-1" placeholder="6ä½éªŒè¯ç " maxlength="6"
                  inputmode="numeric">
                <button id="mobile-reg-send-code-btn" class="btn btn-primary whitespace-nowrap !py-0 !px-4 !text-base">
                  å‘é€
                </button>
              </div>
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">æ˜µç§°</label>
              <input type="text" id="mobile-reg-nickname" class="w-full" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆå¯å«ä¸­æ–‡ï¼‰">
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">å¤´åƒ</label>
              <div class="flex items-center gap-3 mt-1">
                <img id="mobile-reg-avatar-preview" src="/static/default_avatar.png"
                  class="w-16 h-16 rounded-full object-cover border-2 border-slate-200">
                <input type="file" id="mobile-reg-avatar" accept="image/*" class="hidden">
                <button class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm"
                  onclick="document.getElementById('mobile-reg-avatar').click(); return false;">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                  </svg>
                  ä¸Šä¼ å¤´åƒ
                </button>
              </div>
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">å¯†ç </label>
              <input type="password" id="mobile-reg-password" class="w-full" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6å­—ç¬¦ï¼‰"
                autocomplete="new-password">
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">ç¡®è®¤å¯†ç </label>
              <input type="password" id="mobile-reg-password-confirm" class="w-full" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                autocomplete="new-password">
            </div>

            <button id="mobile-register-btn" class="mobile-primary-btn"
              style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
              æ³¨å†Œ
            </button>
          </div>

          <div id="mobile-auth-2fa-form" class="space-y-4 hidden">
            <div class="text-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">ä¸¤æ­¥éªŒè¯</h3>
              <p class="text-sm text-slate-600 mt-2">è¯·è¾“å…¥æ‚¨çš„éªŒè¯ç </p>
            </div>

            <div class="mobile-form-group">
              <label class="mobile-form-label">éªŒè¯ç </label>
              <input type="text" id="mobile-2fa-code" class="w-full" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6"
                inputmode="numeric" autocomplete="one-time-code">
            </div>

            <button id="mobile-2fa-submit-btn" class="mobile-primary-btn">
              éªŒè¯
            </button>

            <div class="text-center">
              <button id="mobile-2fa-back-btn" class="text-sky-600 text-sm font-medium">
                è¿”å›ç™»å½•
              </button>
            </div>
          </div>

          <div id="mobile-auth-error"
            class="hidden mt-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-600 text-sm text-center"></div>

          <div id="mobile-auth-success"
            class="hidden mt-4 p-3 rounded-lg bg-green-50 border border-green-200 text-green-600 text-sm text-center">
          </div>
        </div>
      </div>

      <!-- ========================================
           ã€å®¹å™¨2ã€‘ç§»åŠ¨ç«¯ç™»å½•å®¹å™¨ï¼ˆä¸‰æ å¸ƒå±€ï¼‰
           - å¯¹åº”PCç«¯çš„ login-container
           - å‚ç›´å †å ä¸‰ä¸ªåŠŸèƒ½åŒºåŸŸï¼š
             1. å¤šè´¦å·æ¨¡å¼å…¥å£
             2. ä¼šè¯ç®¡ç†é¢æ¿
             3. å•è´¦å·ç™»å½•é¢æ¿
           - é»˜è®¤éšè—ï¼Œç™»å½•åæ˜¾ç¤º
           ======================================== -->
      <div id="mobile-login-container" class="space-y-4 hidden">

        <!-- ========================================
             ã€åŒºåŸŸ1ã€‘å•è´¦å·ç™»å½•é¢æ¿å¡ç‰‡ï¼ˆå·²è°ƒæ•´é¡ºåºï¼ŒåŸä¸ºåŒºåŸŸ3ï¼‰
             - å¯¹åº”PCç«¯å³æ çš„å•è´¦å·ç™»å½•
             - æä¾›ç”¨æˆ·ä¸‹æ‹‰é€‰æ‹©å’Œå¯†ç è¾“å…¥
             - ä¸ºäº†ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œå°†æœ€å¸¸ç”¨çš„å•è´¦å·ç™»å½•æ”¾åœ¨é¦–ä½
             ======================================== -->
        <div class="mobile-card" id="mobile-single-login-card">

          <!-- æ ‡é¢˜ -->
          <h3 class="text-lg font-bold text-slate-800 mb-4">å•è´¦å·ç™»å½•</h3>

          <!-- ç”¨æˆ·é€‰æ‹©ä¸‹æ‹‰æ¡† - å¯¹åº”PCç«¯çš„user-combo -->
          <div class="mobile-form-group">
            <label class="mobile-form-label">é€‰æ‹©ç”¨æˆ·</label>
            <!-- selectä¸‹æ‹‰èœå•ï¼Œç”¨äºé€‰æ‹©å·²ä¿å­˜çš„ç”¨æˆ· -->
            <select id="mobile-user-combo" class="w-full">
              <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
              <!-- ç”¨æˆ·åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
            </select>
          </div>

          <!-- ç”¨æˆ·åè¾“å…¥æ¡† - å¯¹åº”PCç«¯çš„username-entry -->
          <div class="mobile-form-group">
            <label class="mobile-form-label">ç”¨æˆ·å</label>
            <input type="text" id="mobile-username-entry" class="w-full" placeholder="æˆ–ç›´æ¥è¾“å…¥ç”¨æˆ·å" autocomplete="username">
          </div>

          <!-- å¯†ç è¾“å…¥æ¡† - å¯¹åº”PCç«¯çš„password-entry -->
          <div class="mobile-form-group">
            <label class="mobile-form-label">å¯†ç </label>
            <input type="password" id="mobile-password-entry" class="w-full" placeholder="è¯·è¾“å…¥å¯†ç "
              autocomplete="current-password">
          </div>

          <!-- ç™»å½•æŒ‰é’® -->
          <button id="mobile-single-login-btn" class="mobile-primary-btn">
            ç™»å½•
          </button>
        </div>

        <!-- ========================================
             ã€åŒºåŸŸ2ã€‘å¤šè´¦å·æ¨¡å¼å…¥å£å¡ç‰‡ï¼ˆå·²è°ƒæ•´é¡ºåºï¼ŒåŸä¸ºåŒºåŸŸ1ï¼‰
             - å¯¹åº”PCç«¯å·¦æ çš„å¤šè´¦å·æ¨¡å¼
             - ç´«è‰²æ¸å˜ä¸»é¢˜å‡¸æ˜¾é«˜çº§åŠŸèƒ½
             ======================================== -->
        <div class="mobile-card" id="mobile-multi-account-card">

          <!-- å›¾æ ‡åŒºåŸŸ - åŒäººå›¾æ ‡è±¡å¾å¤šè´¦å·åŠŸèƒ½ -->
          <div class="text-center mb-4">
            <div class="inline-block p-4 bg-violet-100 rounded-full">
              <!-- åŒäººå›¾æ ‡SVG - ä½¿ç”¨ç´«è‰²ä¸»é¢˜ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-violet-600" viewBox="0 0 24 24"
                fill="currentColor">
                <path
                  d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
              </svg>
            </div>
          </div>

          <!-- æ ‡é¢˜å’Œæè¿° - å±…ä¸­å¯¹é½ -->
          <h2 class="mobile-title text-center">å¤šè´¦å·æ¨¡å¼</h2>
          <p class="mobile-subtitle text-center">æ‰¹é‡ç®¡ç†å¤šä¸ªè´¦å·ï¼Œä¸€é”®æ‰§è¡Œä»»åŠ¡</p>

          <!-- åŠŸèƒ½åˆ—è¡¨ - ä½¿ç”¨Emojiå›¾æ ‡å¢å¼ºè§†è§‰æ•ˆæœ -->
          <div class="space-y-3 mb-6">
            <div class="flex items-center">
              <span class="text-2xl mr-3">âœ¨</span>
              <span class="text-slate-700">æ”¯æŒæ‰¹é‡å¯¼å…¥è´¦å·</span>
            </div>
            <div class="flex items-center">
              <span class="text-2xl mr-3">ğŸ¯</span>
              <span class="text-slate-700">ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä»»åŠ¡</span>
            </div>
            <div class="flex items-center">
              <span class="text-2xl mr-3">âš¡</span>
              <span class="text-slate-700">ä¸€é”®æ‰§è¡Œå…¨éƒ¨æµç¨‹</span>
            </div>
          </div>

          <!-- è¿›å…¥æŒ‰é’® - ç´«è‰²æ¸å˜èƒŒæ™¯ä¸é˜´å½±å¢å¼ºè§†è§‰å¸å¼•åŠ› -->
          <button id="mobile-multi-account-btn" class="mobile-primary-btn"
            style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);">
            è¿›å…¥å¤šè´¦å·æ§åˆ¶å°
          </button>
        </div>

        <!-- ========================================
             ã€åŒºåŸŸ3ã€‘ä¼šè¯ç®¡ç†é¢æ¿å¡ç‰‡ï¼ˆå·²è°ƒæ•´é¡ºåºï¼ŒåŸä¸ºåŒºåŸŸ2ï¼‰
             - å¯¹åº”PCç«¯ä¸­æ çš„ä¼šè¯ç®¡ç†
             - æ˜¾ç¤ºæ´»è·ƒä¼šè¯åˆ—è¡¨å’Œç®¡ç†åŠŸèƒ½
             ======================================== -->
        <div class="mobile-card" id="mobile-session-panel-card">

          <!-- é¢æ¿æ ‡é¢˜ - ä½¿ç”¨å¤©è“è‰²ä¸»é¢˜ -->
          <div class="flex items-center justify-between mb-4 pb-3 border-b border-sky-100">
            <div class="flex items-center gap-2">
              <!-- ç®¡ç†å›¾æ ‡ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-sky-600" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              <h3 class="text-xl font-bold text-sky-700">ä¼šè¯ç®¡ç†</h3>
            </div>

            <!-- åˆ·æ–°æŒ‰é’® - ç”¨äºæ‰‹åŠ¨æ›´æ–°ä¼šè¯åˆ—è¡¨ -->
            <button id="mobile-refresh-sessions-btn" class="p-2 hover:bg-sky-50 rounded-lg transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-sky-600" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>

          <!-- æç¤ºä¿¡æ¯å’Œåˆ›å»ºæ–°ä¼šè¯æŒ‰é’®åŒºåŸŸ - å‚è€ƒPCç«¯session-panel-card -->
          <div class="bg-sky-50 border border-sky-200 rounded-lg p-4 mb-4">
            <!-- æç¤ºæ–‡å­— - å‘ŠçŸ¥ç”¨æˆ·å¯ä»¥é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯ -->
            <p class="text-sm text-slate-700 mb-3">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
            <!-- åˆ›å»ºæ–°ä¼šè¯æŒ‰é’® - è°ƒç”¨createNewSessionFromPicker()å‡½æ•° -->
            <button class="mobile-primary-btn w-full" onclick="createNewSessionFromPicker()"
              id="mobile-create-session-btn">
              <!-- åŠ å·å›¾æ ‡ - è¡¨ç¤ºåˆ›å»ºæ–°é¡¹ç›®çš„æ“ä½œ -->
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              åˆ›å»ºæ–°ä¼šè¯
            </button>
          </div>

          <!-- ä¼šè¯è®¡æ•°æ˜¾ç¤º - åŠ¨æ€æ˜¾ç¤ºå½“å‰ä¼šè¯æ•°é‡ -->
          <div id="mobile-session-count-display"
            class="text-sm text-slate-600 bg-sky-50 px-3 py-2 rounded-lg mb-4 text-center">
            <!-- ä¼šè¯è®¡æ•°å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
          </div>

          <!-- ä¼šè¯åˆ—è¡¨å®¹å™¨ - æ»šåŠ¨æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯ -->
          <div id="mobile-sessions-list" class="space-y-3 max-h-[40vh] overflow-y-auto">
            <!-- åŠ è½½ä¸­å ä½ç¬¦ - é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤º -->
            <p class="text-slate-400 text-center py-8">
              åŠ è½½ä¼šè¯åˆ—è¡¨ä¸­...
            </p>
          </div>
        </div>

        <!-- ========================================
             ã€å¿«é€Ÿæ“ä½œå¡ç‰‡ã€‘- ç™»å½•æˆåŠŸåæ˜¾ç¤º
             - æä¾›å¸¸ç”¨åŠŸèƒ½çš„å¿«é€Ÿå…¥å£
             - é»˜è®¤éšè—
             ======================================== -->
        <div class="mobile-card hidden" id="mobile-quick-actions">
          <h2 class="mobile-title">å¿«é€Ÿæ“ä½œ</h2>

          <!-- æ“ä½œæŒ‰é’®åˆ—è¡¨ - æ¯ä¸ªæŒ‰é’®éƒ½åŒ…å«å›¾æ ‡å’Œå³ç®­å¤´ -->
          <div class="space-y-3">

            <!-- å¼€å§‹è·‘æ­¥æŒ‰é’® -->
            <button class="mobile-list-item justify-between">
              <div class="flex items-center">
                <!-- æ’­æ”¾å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-sky-600 mr-3" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-medium">å¼€å§‹è·‘æ­¥</span>
              </div>
              <!-- å³ç®­å¤´ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd" />
              </svg>
            </button>

            <!-- æŸ¥çœ‹ä»»åŠ¡æŒ‰é’® -->
            <button class="mobile-list-item justify-between">
              <div class="flex items-center">
                <!-- å®Œæˆå›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-600 mr-3" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-medium">æŸ¥çœ‹ä»»åŠ¡</span>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd" />
              </svg>
            </button>

            <!-- å†å²è®°å½•æŒ‰é’® -->
            <button class="mobile-list-item justify-between">
              <div class="flex items-center">
                <!-- æ—¶é’Ÿå›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-600 mr-3" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-medium">å†å²è®°å½•</span>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd" />
              </svg>
            </button>

            <!-- è®¾ç½®æŒ‰é’® -->
            <button class="mobile-list-item justify-between">
              <div class="flex items-center">
                <!-- è®¾ç½®å›¾æ ‡ -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-orange-600 mr-3" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="font-medium">è®¾ç½®</span>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>

      </div>

      <!-- ========================================
           ã€å®¹å™¨3ã€‘ç§»åŠ¨ç«¯ä¸»åº”ç”¨ç•Œé¢ï¼ˆå•è´¦å·æ¨¡å¼ï¼‰
           - å¯¹åº”PCç«¯çš„ main-app
           - åŒ…å«ä»»åŠ¡åˆ—è¡¨ã€åœ°å›¾ã€æ§åˆ¶é¢æ¿
           - ç™»å½•æˆåŠŸåæ˜¾ç¤º
           ======================================== -->
      <div id="mobile-main-app" class="space-y-4 hidden">

        <!-- ========================================
             ã€é€šçŸ¥é¢æ¿ã€‘- æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥å’Œç­¾åˆ°ä»»åŠ¡
             ======================================== -->
        <div class="mobile-card" id="mobile-notification-panel">
          <!-- é¢æ¿å¤´éƒ¨ï¼šæ ‡é¢˜å’Œæœªè¯»è§’æ ‡ -->
          <div class="flex items-center justify-between mb-4 pb-3 border-b border-sky-100">
            <div class="flex items-center gap-2">
              <!-- é“ƒé“›å›¾æ ‡ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-sky-600" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
              </svg>
              <h3 class="text-xl font-bold text-sky-700">é€šçŸ¥ä¸­å¿ƒ</h3>
            </div>

            <!-- æœªè¯»è§’æ ‡ - æ˜¾ç¤ºæœªè¯»é€šçŸ¥æ•°é‡ -->
            <div class="relative">
              <span id="mobile-notification-badge"
                class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                <!-- æœªè¯»æ•°é‡å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
              </span>
              <!-- åˆ·æ–°æŒ‰é’® -->
              <button id="mobile-refresh-notifications-btn" class="p-2 hover:bg-sky-50 rounded-lg transition-colors"
                onclick="mobileRefreshNotifications()">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-sky-600" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
            </div>
          </div>

          <!-- é€šçŸ¥æ ‡ç­¾åˆ‡æ¢ - å…¨éƒ¨/ç­¾åˆ° -->
          <div class="flex border-b border-slate-200 mb-4">
            <button id="mobile-notif-tab-all"
              class="flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition"
              onclick="switchMobileNotifTab('all')">
              å…¨éƒ¨é€šçŸ¥
            </button>
            <button id="mobile-notif-tab-attendance"
              class="flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition"
              onclick="switchMobileNotifTab('attendance')">
              ç­¾åˆ°ä»»åŠ¡
            </button>
          </div>

          <!-- å…¨éƒ¨é€šçŸ¥åˆ—è¡¨ -->
          <div id="mobile-all-notifications-list" class="space-y-2 max-h-[40vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-8 text-sm">æš‚æ— é€šçŸ¥</p>
          </div>

          <!-- ç­¾åˆ°ä»»åŠ¡åˆ—è¡¨ - é»˜è®¤éšè— -->
          <div id="mobile-attendance-notifications-list" class="space-y-2 max-h-[40vh] overflow-y-auto hidden">
            <p class="text-slate-400 text-center py-8 text-sm">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>
          </div>

          <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
          <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
            <button
              class="flex-1 py-2 px-4 bg-sky-50 text-sky-600 rounded-lg text-sm font-medium hover:bg-sky-100 transition"
              onclick="mobileMarkAllAsRead()">
              å…¨éƒ¨å·²è¯»
            </button>
            <button
              class="flex-1 py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition"
              onclick="expandMobileNotifications()">
              æŸ¥çœ‹æ›´å¤š
            </button>
          </div>
        </div>

        <!-- ========================================
             ã€ä»»åŠ¡åˆ—è¡¨é¢æ¿ã€‘- æ˜¾ç¤ºè·‘æ­¥ä»»åŠ¡
             ======================================== -->
        <div class="mobile-card" id="mobile-task-panel">
          <!-- é¢æ¿å¤´éƒ¨ -->
          <div class="flex items-center justify-between mb-4 pb-3 border-b border-green-100">
            <div class="flex items-center gap-2">
              <!-- ä»»åŠ¡å›¾æ ‡ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-600" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
              </svg>
              <h3 class="text-xl font-bold text-green-700">ä»»åŠ¡åˆ—è¡¨</h3>
            </div>
            <!-- ä»»åŠ¡ç»Ÿè®¡ -->
            <div class="text-sm text-slate-600 bg-green-50 px-3 py-1 rounded-full" id="mobile-task-count">
              0 ä¸ªä»»åŠ¡
            </div>
          </div>

          <!-- ä»»åŠ¡åˆ—è¡¨ -->
          <div id="mobile-task-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-8 text-sm">æš‚æ— ä»»åŠ¡</p>
          </div>

          <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
          <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-slate-100">
            <button
              class="py-2 px-4 bg-green-50 text-green-600 rounded-lg text-sm font-medium hover:bg-green-100 transition flex items-center justify-center gap-1"
              onclick="mobileRefreshTasks()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              åˆ·æ–°
            </button>
            <button
              class="py-2 px-4 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100 transition flex items-center justify-center gap-1"
              onclick="mobileAddTask()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              æ–°å¢
            </button>
          </div>
        </div>

        <!-- ========================================
             ã€åœ°å›¾æ˜¾ç¤ºé¢æ¿ã€‘- æ˜¾ç¤ºä»»åŠ¡è·¯å¾„
             ======================================== -->
        <div class="mobile-card p-0 overflow-hidden" id="mobile-map-panel">
          <!-- åœ°å›¾å®¹å™¨ -->
          <div id="mobile-map-container" class="w-full h-[300px] relative bg-slate-100">
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                <p class="text-sm">åœ°å›¾åŠ è½½ä¸­...</p>
              </div>
            </div>
          </div>
          <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
          <div class="flex gap-2 p-3 bg-slate-50">
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileZoomIn()">
              æ”¾å¤§ +
            </button>
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileZoomOut()">
              ç¼©å° -
            </button>
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileFitView()">
              é€‚åº” âŠ¡
            </button>
          </div>
        </div>

        <!-- ========================================
             ã€æ§åˆ¶é¢æ¿ã€‘- ä»»åŠ¡æ‰§è¡Œæ§åˆ¶
             ======================================== -->
        <div class="mobile-card" id="mobile-control-panel">
          <!-- é¢æ¿å¤´éƒ¨ -->
          <div class="flex items-center gap-2 mb-4 pb-3 border-b border-orange-100">
            <!-- æ§åˆ¶å›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-orange-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
            </svg>
            <h3 class="text-xl font-bold text-orange-700">æ§åˆ¶é¢æ¿</h3>
          </div>

          <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
          <div class="mb-4 p-3 bg-slate-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-slate-600">å½“å‰çŠ¶æ€</span>
              <span id="mobile-status-indicator"
                class="text-xs font-semibold px-2 py-1 rounded-full bg-slate-200 text-slate-600">
                æœªå¯åŠ¨
              </span>
            </div>
            <div class="text-xs text-slate-500" id="mobile-status-detail">
              ç­‰å¾…æ‰§è¡Œä»»åŠ¡
            </div>
          </div>

          <!-- ä¸»è¦æ§åˆ¶æŒ‰é’® -->
          <div class="grid grid-cols-2 gap-3 mb-4">
            <!-- å¼€å§‹æŒ‰é’® -->
            <button id="mobile-start-btn"
              class="py-3 px-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
              onclick="mobileStartTask()">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                  clip-rule="evenodd" />
              </svg>
              å¼€å§‹
            </button>

            <!-- åœæ­¢æŒ‰é’® -->
            <button id="mobile-stop-btn"
              class="py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
              onclick="mobileStopTask()" disabled>
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                  clip-rule="evenodd" />
              </svg>
              åœæ­¢
            </button>
          </div>

          <!-- æ¬¡è¦æ§åˆ¶æŒ‰é’® -->
          <div class="grid grid-cols-3 gap-2">
            <button
              class="py-2 px-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-medium hover:bg-blue-100 transition flex flex-col items-center justify-center gap-1"
              onclick="mobilePauseTask()">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                  clip-rule="evenodd" />
              </svg>
              æš‚åœ
            </button>
            <button
              class="py-2 px-2 bg-purple-50 text-purple-600 rounded-lg text-xs font-medium hover:bg-purple-100 transition flex flex-col items-center justify-center gap-1"
              onclick="mobileResumeTask()">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                  clip-rule="evenodd" />
              </svg>
              ç»§ç»­
            </button>
            <button
              class="py-2 px-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-200 transition flex flex-col items-center justify-center gap-1"
              onclick="mobileResetTask()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              é‡ç½®
            </button>
          </div>

          <!-- è¿›åº¦æ˜¾ç¤º -->
          <div class="mt-4 pt-3 border-t border-slate-100">
            <div class="flex justify-between items-center mb-2">
              <span class="text-xs text-slate-600">ä»»åŠ¡è¿›åº¦</span>
              <span id="mobile-progress-text" class="text-xs font-semibold text-sky-600">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
              <div id="mobile-progress-bar"
                class="bg-gradient-to-r from-sky-500 to-blue-600 h-2 rounded-full transition-all duration-300"
                style="width: 0%"></div>
            </div>
          </div>
        </div>

      </div>

      <!-- ========================================
           ã€å®¹å™¨4ã€‘ç§»åŠ¨ç«¯å¤šè´¦å·æ¨¡å¼ç•Œé¢
           - å¯¹åº”PCç«¯çš„ multi-account-app
           - åŒ…å«è´¦å·åˆ—è¡¨å’Œæ‰¹é‡æ§åˆ¶åŠŸèƒ½
           ======================================== -->
      <div id="mobile-multi-account-app" class="space-y-4 hidden">

        <!-- è¿”å›æŒ‰é’® -->
        <div class="mobile-card py-3">
          <button class="flex items-center gap-2 text-sky-600 font-medium" onclick="exitMobileMultiAccount()" id="multi_exit_account">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            è¿”å›é¦–é¡µ
          </button>
        </div>

        <!-- è´¦å·ç®¡ç†é¢æ¿ -->
        <div class="mobile-card" id="mobile-multi-account-panel">
          <!-- é¢æ¿å¤´éƒ¨ -->
          <div class="flex items-center justify-between mb-4 pb-3 border-b border-purple-100">
            <div class="flex items-center gap-2">
              <!-- å¤šè´¦å·å›¾æ ‡ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-600" viewBox="0 0 24 24"
                fill="currentColor">
                <path
                  d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
              </svg>
              <h3 class="text-xl font-bold text-purple-700">è´¦å·ç®¡ç†</h3>
            </div>
            <!-- è´¦å·æ•°é‡ç»Ÿè®¡ -->
            <div class="text-sm text-slate-600 bg-purple-50 px-3 py-1 rounded-full" id="mobile-multi-account-count">
              0 ä¸ªè´¦å·
            </div>
          </div>

          <!-- å…¨é€‰å’Œæ‰¹é‡æ“ä½œ -->
          <div class="flex items-center justify-between mb-4 p-3 bg-purple-50 rounded-lg">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="mobile-select-all-accounts" class="w-5 h-5 text-purple-600 rounded"
                onchange="mobileToggleSelectAllAccounts()">
              <span class="text-sm font-medium text-slate-700">å…¨é€‰</span>
            </label>
            <div class="flex gap-2">
              <button
                class="py-1 px-3 bg-green-500 text-white rounded-lg text-xs font-medium hover:bg-green-600 transition"
                onclick="mobileStartSelectedAccounts()">
                å¯åŠ¨é€‰ä¸­
              </button>
              <button class="py-1 px-3 bg-red-500 text-white rounded-lg text-xs font-medium hover:bg-red-600 transition"
                onclick="mobileStopSelectedAccounts()">
                åœæ­¢é€‰ä¸­
              </button>
            </div>
          </div>

          <!-- è´¦å·åˆ—è¡¨ -->
          <div id="mobile-multi-account-list" class="space-y-2 max-h-[55vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-8 text-sm">æš‚æ— è´¦å·ï¼Œè¯·å…ˆæ·»åŠ </p>
          </div>

          <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
          <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-slate-100">
            <button
              class="py-2 px-4 bg-purple-50 text-purple-600 rounded-lg text-sm font-medium hover:bg-purple-100 transition flex items-center justify-center gap-1"
              onclick="mobileAddMultiAccount()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              æ·»åŠ è´¦å·
            </button>
            <button
              class="py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition flex items-center justify-center gap-1"
              onclick="mobileRefreshMultiAccounts()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              åˆ·æ–°åˆ—è¡¨
            </button>
          </div>
        </div>

        <!-- æ‰¹é‡æ§åˆ¶é¢æ¿ -->
        <div class="mobile-card" id="mobile-multi-control-panel">
          <!-- é¢æ¿å¤´éƒ¨ -->
          <div class="flex items-center gap-2 mb-4 pb-3 border-b border-orange-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-orange-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <h3 class="text-xl font-bold text-orange-700">æ‰¹é‡æ§åˆ¶</h3>
          </div>

          <!-- å…¨å±€çŠ¶æ€ -->
          <div class="mb-4 p-3 bg-slate-50 rounded-lg">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-slate-600">å…¨å±€çŠ¶æ€</span>
              <span id="mobile-multi-global-status"
                class="text-xs font-semibold px-2 py-1 rounded-full bg-slate-200 text-slate-600">
                å°±ç»ª
              </span>
            </div>
          </div>

          <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
          <div class="grid grid-cols-2 gap-3">
            <button
              class="py-3 px-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
              onclick="mobileStartAllAccounts()">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                  clip-rule="evenodd" />
              </svg>
              å…¨éƒ¨å¯åŠ¨
            </button>

            <button
              class="py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
              onclick="mobileStopAllAccounts()">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                  clip-rule="evenodd" />
              </svg>
              å…¨éƒ¨åœæ­¢
            </button>

            <button
              class="py-3 px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
              onclick="mobileRefreshAllAccounts()">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              å…¨éƒ¨åˆ·æ–°
            </button>

            <button
              class="py-3 px-4 bg-gradient-to-r from-slate-400 to-slate-500 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2"
              onclick="mobileRemoveSelectedAccounts()">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              åˆ é™¤é€‰ä¸­
            </button>
          </div>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <div class="mt-4 pt-3 border-t border-slate-100 grid grid-cols-3 gap-2">
            <div class="text-center p-2 bg-green-50 rounded-lg">
              <div id="mobile-multi-running-count" class="text-lg font-bold text-green-600">0</div>
              <div class="text-xs text-slate-600">è¿è¡Œä¸­</div>
            </div>
            <div class="text-center p-2 bg-yellow-50 rounded-lg">
              <div id="mobile-multi-paused-count" class="text-lg font-bold text-yellow-600">0</div>
              <div class="text-xs text-slate-600">å·²æš‚åœ</div>
            </div>
            <div class="text-center p-2 bg-slate-100 rounded-lg">
              <div id="mobile-multi-stopped-count" class="text-lg font-bold text-slate-600">0</div>
              <div class="text-xs text-slate-600">å·²åœæ­¢</div>
            </div>
          </div>
        </div>

        <!-- ========================================
             ã€åœ°å›¾é¢æ¿ã€‘- å¤šè´¦å·æ¨¡å¼åœ°å›¾æ˜¾ç¤º
             ======================================== -->
        <div class="mobile-card p-0 overflow-hidden" id="mobile-multi-map-panel">
          <!-- åœ°å›¾å®¹å™¨ - ç”¨äºæ˜¾ç¤ºæ‰€æœ‰è´¦å·çš„è·‘æ­¥è·¯çº¿ -->
          <div id="mobile-multi-map-container" class="w-full h-[300px] relative bg-slate-100">
            <!-- åœ°å›¾åŠ è½½å ä½ç¬¦ -->
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
              <div class="text-center">
                <!-- åœ°å›¾å›¾æ ‡ -->
                <svg class="w-12 h-12 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                <p class="text-sm">åœ°å›¾åŠ è½½ä¸­...</p>
              </div>
            </div>
          </div>

          <!-- åœ°å›¾æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
          <div class="flex gap-2 p-3 bg-slate-50">
            <!-- æ”¾å¤§æŒ‰é’® -->
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileMultiZoomIn()">
              æ”¾å¤§ +
            </button>
            <!-- ç¼©å°æŒ‰é’® -->
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileMultiZoomOut()">
              ç¼©å° -
            </button>
            <!-- è‡ªé€‚åº”è§†å›¾æŒ‰é’® -->
            <button
              class="flex-1 py-2 px-3 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-50 transition"
              onclick="mobileMultiFitView()">
              é€‚åº” âŠ¡
            </button>
          </div>
        </div>

      </div>

    </main>

    <!-- ========================================
         ã€ç§»åŠ¨ç«¯æ¨¡æ€æ¡†åŒºåŸŸã€‘
         åŒ…å«æ‰€æœ‰ç§»åŠ¨ç«¯ä¸“ç”¨çš„æ¨¡æ€æ¡†
         ======================================== -->

    <!-- ç§»åŠ¨ç«¯ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡† - ç”¨äºmobile-main-app -->
    <div id="mobile-user-details-modal" class="fixed inset-0 hidden mobile-modal z-50"
      onclick="toggleMobileUserDetails(false)">
      <!-- åŠé€æ˜é®ç½©å±‚ - ç‚¹å‡»å…³é—­æ¨¡æ€æ¡† -->
      <div class="absolute inset-0 bg-black/40"></div>
      <!-- æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ - ä»åº•éƒ¨å¼¹å‡ºï¼Œé‡‡ç”¨åœ†è§’è®¾è®¡ -->
      <div class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <!-- é¡¶éƒ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨ - è§†è§‰æç¤ºå¯å‘ä¸‹æ»‘åŠ¨å…³é—­ -->
        <div class="flex justify-center mb-2">
          <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
        </div>
        <!-- æ¨¡æ€æ¡†æ ‡é¢˜ -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200">
          <h3 class="text-xl font-bold text-sky-600 text-center">ç”¨æˆ·è¯¦æƒ…</h3>
        </div>
        <!-- ç”¨æˆ·è¯¦æƒ…å†…å®¹åŒºåŸŸ - ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        <div id="mobile-user-details-content" class="text-sm space-y-1 max-h-[60vh] overflow-y-auto"></div>

        <!-- åº•éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <div class="flex justify-between gap-2 pt-2">
          <!-- è¿”å›ç™»å½•æŒ‰é’® - è°ƒç”¨é€€å‡ºç™»å½•å‡½æ•° -->
          <button
            class="py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition flex items-center gap-1"
            onclick="toggleMobileUserDetails(false); mobileLogout();">
            <!-- é€€å‡ºå›¾æ ‡ -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            è¿”å›ç™»å½•
          </button>
          <!-- å…³é—­æŒ‰é’® -->
          <button class="mobile-primary-btn" onclick="toggleMobileUserDetails(false)">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† - ç”¨äºmobile-main-app -->
    <div id="mobile-task-details-modal" class="fixed inset-0 hidden mobile-modal z-50"
      onclick="toggleMobileTaskDetails(false)">
      <!-- åŠé€æ˜é®ç½©å±‚ -->
      <div class="absolute inset-0 bg-black/40"></div>
      <!-- æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ -->
      <div class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <!-- é¡¶éƒ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center mb-2">
          <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
        </div>
        <!-- æ¨¡æ€æ¡†æ ‡é¢˜ -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200">
          <h3 class="text-xl font-bold text-sky-600 text-center">ä»»åŠ¡è¯¦æƒ…</h3>
        </div>
        <!-- ä»»åŠ¡è¯¦æƒ…å†…å®¹åŒºåŸŸ - ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        <div id="mobile-task-details-content" class="text-sm space-y-1 max-h-[60vh] overflow-y-auto"></div>
        <!-- åº•éƒ¨å…³é—­æŒ‰é’® -->
        <div class="flex justify-end pt-2">
          <button class="mobile-primary-btn" onclick="toggleMobileTaskDetails(false)">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯é€šçŸ¥ä¸­å¿ƒæ¨¡æ€æ¡† - ç”¨äºmobile-main-app -->
    <div id="mobile-notifications-modal" class="fixed inset-0 hidden mobile-modal z-50"
      onclick="toggleMobileNotifications(false)">
      <!-- åŠé€æ˜é®ç½©å±‚ -->
      <div class="absolute inset-0 bg-black/40"></div>
      <!-- æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ -->
      <div class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <!-- é¡¶éƒ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center mb-2">
          <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
        </div>
        <!-- æ¨¡æ€æ¡†æ ‡é¢˜ -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200">
          <h3 class="text-xl font-bold text-sky-600 text-center">é€šçŸ¥ä¸­å¿ƒ</h3>
        </div>
        <!-- é€šçŸ¥å†…å®¹åŒºåŸŸ - ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        <div id="mobile-notifications-content" class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2">
          <p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½...</p>
        </div>
        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="flex justify-between items-center pt-2">
          <div class="flex gap-2">
            <button id="mobile-refresh-notifications-modal-btn"
              class="py-2 px-4 bg-sky-50 text-sky-600 rounded-lg text-sm font-medium hover:bg-sky-100 transition">åˆ·æ–°</button>
            <button id="mobile-mark-all-read-modal-btn"
              class="py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition">ä¸€é”®å·²è¯»</button>
          </div>
          <button class="mobile-primary-btn" onclick="toggleMobileNotifications(false)">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿æ¨¡æ€æ¡† - ç”¨äºmobile-main-appå’Œmobile-multi-account-app -->
    <div id="mobile-admin-panel-modal" class="fixed inset-0 hidden mobile-modal z-50"
      onclick="toggleMobileAdminPanel(false)">
      <!-- åŠé€æ˜é®ç½©å±‚ -->
      <div class="absolute inset-0 bg-black/40"></div>
      <!-- æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ -->
      <div class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <!-- é¡¶éƒ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center mb-2">
          <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
        </div>
        <!-- æ¨¡æ€æ¡†æ ‡é¢˜ -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200">
          <!-- ç®¡ç†å›¾æ ‡ -->
          <svg class="w-6 h-6 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
            </path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
            </path>
          </svg>
          <h3 class="text-xl font-bold text-sky-600 text-center">ç®¡ç†é¢æ¿</h3>
        </div>
        <!-- ç®¡ç†é¢æ¿æ ‡ç­¾é¡µå¯¼èˆª - æ¨ªå‘æ»šåŠ¨æ”¯æŒ -->
        <div class="flex border-b-2 border-slate-200 overflow-x-auto gap-1 pb-0 -mx-2 px-2"
          style="scrollbar-width: none;">
          <!-- æ ‡ç­¾é¡µæŒ‰é’®å°†ç”±JavaScriptåŠ¨æ€åˆ›å»ºå’Œç®¡ç† -->
        </div>
        <!-- ç®¡ç†é¢æ¿å†…å®¹åŒºåŸŸ - ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        <div id="mobile-admin-panel-content" class="text-sm space-y-2 max-h-[60vh] overflow-y-auto">
          <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
        </div>
        <!-- åº•éƒ¨å…³é—­æŒ‰é’® -->
        <div class="flex justify-end pt-2">
          <button class="mobile-primary-btn" onclick="toggleMobileAdminPanel(false)">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯è´¦å·å‚æ•°è®¾ç½®æ¨¡æ€æ¡† - ç”¨äºmobile-multi-account-app -->
    <div id="mobile-account-params-modal" class="fixed inset-0 hidden mobile-modal z-50"
      onclick="closeMobileAccountParams()">
      <!-- åŠé€æ˜é®ç½©å±‚ -->
      <div class="absolute inset-0 bg-black/40"></div>
      <!-- æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ -->
      <div class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <!-- é¡¶éƒ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center mb-2">
          <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
        </div>
        <!-- æ¨¡æ€æ¡†æ ‡é¢˜ -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-slate-200">
          <h3 id="mobile-account-params-title" class="text-xl font-bold text-sky-600 text-center">è´¦å·å‚æ•°è®¾ç½®</h3>
        </div>
        <!-- è´¦å·å‚æ•°è®¾ç½®å†…å®¹åŒºåŸŸ - ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        <div id="mobile-account-params-container" class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="flex justify-end gap-3 pt-2">
          <button
            class="py-2 px-4 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200 transition"
            onclick="closeMobileAccountParams()">å–æ¶ˆ</button>
          <button id="mobile-save-account-params-btn" class="mobile-primary-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- ========================================
         ã€ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ åŒºåŸŸã€‘
         æ ¹æ®å½“å‰åº”ç”¨æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„å¯¼èˆªæ 
         ======================================== -->

    <!-- å•è´¦å·æ¨¡å¼åº•éƒ¨å¯¼èˆªæ  - ç”¨äºmobile-main-app -->
    <nav class="mobile-bottom-nav hidden" id="mobile-bottom-nav-single-account" style="display:none;">

      <!-- 1. æ§åˆ¶æŒ‰é’® - åˆ‡æ¢åˆ°æ§åˆ¶é¢æ¿ -->
      <a href="#" class="mobile-nav-btn" data-nav="control"
        onclick="switchMobilePanel('mobile-control-panel', 'single')">
        <!-- æ§åˆ¶å›¾æ ‡ï¼šæ»‘åŠ¨æ¡/è°ƒèŠ‚å™¨å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
        <span>æ§åˆ¶</span>
      </a>

      <!-- 2. åœ°å›¾æŒ‰é’® - åˆ‡æ¢åˆ°åœ°å›¾é¢æ¿ -->
      <a href="#" class="mobile-nav-btn" data-nav="map" onclick="switchMobilePanel('mobile-map-panel', 'single')">
        <!-- åœ°å›¾å›¾æ ‡ï¼šæŠ˜å åœ°å›¾å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
        <span>åœ°å›¾</span>
      </a>

      <!-- 3. ä»»åŠ¡æŒ‰é’® - åˆ‡æ¢åˆ°ä»»åŠ¡é¢æ¿ -->
      <a href="#" class="mobile-nav-btn active" data-nav="home"
        onclick="switchMobilePanel('mobile-task-panel', 'single')">
        <!-- ä»»åŠ¡å›¾æ ‡ï¼šå‰ªè´´æ¿/ä»»åŠ¡åˆ—è¡¨å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
        </svg>
        <span>ä»»åŠ¡</span>
      </a>

      <!-- 4. é€šçŸ¥æŒ‰é’® - åˆ‡æ¢åˆ°é€šçŸ¥é¢æ¿ -->
      <a href="#" class="mobile-nav-btn" data-nav="notifications"
        onclick="switchMobilePanel('mobile-notification-panel', 'single')">
        <!-- é€šçŸ¥å›¾æ ‡ï¼šé“ƒé“›å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
        </svg>
        <span>é€šçŸ¥</span>
      </a>

      <!-- 5. ç­¾åˆ°æŒ‰é’® - åˆ‡æ¢åˆ°é€šçŸ¥é¢æ¿çš„ç­¾åˆ°æ ‡ç­¾ -->
      <a href="#" class="mobile-nav-btn" data-nav="attendance"
        onclick="switchMobilePanel('mobile-notification-panel', 'single'); setTimeout(() => switchMobileNotifTab('attendance'), 100);">
        <!-- ç­¾åˆ°å›¾æ ‡ï¼šæ—¥å†å¸¦å‹¾é€‰æ ‡è®° -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" />
        </svg>
        <span>ç­¾åˆ°</span>
      </a>

      <!-- 6. ç®¡ç†æŒ‰é’® - æ‰“å¼€ç®¡ç†é¢æ¿æ¨¡æ€æ¡† -->
      <a href="#" class="mobile-nav-btn" data-nav="admin" onclick="toggleMobileAdminPanel(true)">
        <!-- ç®¡ç†å›¾æ ‡ï¼šé½¿è½®/è®¾ç½®å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span>ç®¡ç†</span>
      </a>

      <!-- 7. æˆ‘çš„æŒ‰é’® - æ‰“å¼€ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡† -->
      <a href="#" class="mobile-nav-btn" data-nav="profile" onclick="toggleMobileUserDetails(true)">
        <!-- ç”¨æˆ·å›¾æ ‡ï¼šç”¨æˆ·å¤´åƒå›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
        </svg>
        <span>æˆ‘çš„</span>
      </a>

    </nav>

    <!-- å¤šè´¦å·æ¨¡å¼åº•éƒ¨å¯¼èˆªæ  - ç”¨äºmobile-multi-account-app -->
    <nav class="mobile-bottom-nav hidden" id="mobile-bottom-nav-multi-account" style="display:none;">

      <!-- 1. è´¦å·æŒ‰é’® - åˆ‡æ¢åˆ°è´¦å·åˆ—è¡¨é¢æ¿ -->
      <a href="#" class="mobile-nav-btn active" data-nav="accounts"
        onclick="switchMobilePanel('mobile-multi-account-panel', 'multi')">
        <!-- å¤šè´¦å·å›¾æ ‡ï¼šå¤šä¸ªç”¨æˆ·å¤´åƒ -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
        </svg>
        <span>è´¦å·</span>
      </a>

      <!-- 2. åœ°å›¾æŒ‰é’® - åˆ‡æ¢åˆ°åœ°å›¾é¢æ¿ -->
      <a href="#" class="mobile-nav-btn" data-nav="map" onclick="switchMobilePanel('mobile-multi-map-panel', 'multi')">
        <!-- åœ°å›¾å›¾æ ‡ï¼šæŠ˜å åœ°å›¾å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
        <span>åœ°å›¾</span>
      </a>

      <!-- 3. æ§åˆ¶æŒ‰é’® - åˆ‡æ¢åˆ°æ‰¹é‡æ§åˆ¶é¢æ¿ -->
      <a href="#" class="mobile-nav-btn" data-nav="control"
        onclick="switchMobilePanel('mobile-multi-control-panel', 'multi')">
        <!-- é—ªç”µå›¾æ ‡ï¼šä»£è¡¨æ§åˆ¶å’Œæ“ä½œ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <span>æ§åˆ¶</span>
      </a>

      <!-- 4. ç®¡ç†æŒ‰é’® - æ‰“å¼€ç®¡ç†é¢æ¿æ¨¡æ€æ¡† -->
      <a href="#" class="mobile-nav-btn" data-nav="admin" onclick="toggleMobileAdminPanel(true)">
        <!-- ç®¡ç†å›¾æ ‡ï¼šé½¿è½®/è®¾ç½®å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span>ç®¡ç†</span>
      </a>

      <!-- 5. è¿”å›æŒ‰é’® - è¿”å›ç™»å½•é¡µ -->
      <a href="#" class="mobile-nav-btn" data-nav="back" onclick="exitMobileMultiAccount()">
        <!-- è¿”å›å›¾æ ‡ï¼šå·¦ç®­å¤´ -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span>è¿”å›</span>
      </a>

    </nav>

  </div>
  <!-- ç»“æŸï¼šç§»åŠ¨ç«¯å®¹å™¨ -->


  <div id="mobile-session-picker-modal" class="fixed inset-0 hidden mobile-modal" onclick="closeMobileSessionPicker()">

    <div class="mobile-modal-content bg-white rounded-t-3xl p-6 space-y-4 max-h-[85vh] overflow-y-auto"
      onclick="event.stopPropagation()">


      <!-- é¡¶éƒ¨æ‹–åŠ¨æŒ‡ç¤ºå™¨ - è§†è§‰æç¤ºå¯ä»¥å‘ä¸‹æ»‘åŠ¨å…³é—­ -->
      <div class="flex justify-center mb-2">
        <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
      </div>

      <!-- æ¨¡æ€æ¡†æ ‡é¢˜æ  -->
      <div class="flex items-center justify-between pb-3 border-b border-slate-200">
        <h3 class="text-xl font-bold text-sky-600">ä¼šè¯ç®¡ç†</h3>
        <!-- ä¼šè¯è®¡æ•°æ˜¾ç¤º - åŠ¨æ€æ˜¾ç¤ºå½“å‰ä¼šè¯æ•°é‡ -->
        <div id="mobile-session-picker-count-display" class="text-sm text-slate-600 bg-sky-50 px-3 py-1 rounded-full">
          <!-- ä¼šè¯è®¡æ•°å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
      </div>

      <!-- æç¤ºä¿¡æ¯å’Œåˆ›å»ºæ–°ä¼šè¯æŒ‰é’®åŒºåŸŸ -->
      <div class="bg-sky-50 border border-sky-200 rounded-lg p-4">
        <p class="text-sm text-slate-700 mb-3">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
        <!-- åˆ›å»ºæ–°ä¼šè¯æŒ‰é’® - ä¸»æŒ‰é’®æ ·å¼ -->
        <button class="mobile-primary-btn w-full" onclick="createNewSessionFromPicker()"
          id="mobile-create-session-picker-btn">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          åˆ›å»ºæ–°ä¼šè¯
        </button>
      </div>

      <!-- ç°æœ‰ä¼šè¯åˆ—è¡¨åŒºåŸŸ -->
      <div class="space-y-3">
        <div class="flex justify-between items-center">
          <h4 class="font-semibold text-slate-700">ç°æœ‰ä¼šè¯</h4>
          <!-- åˆ·æ–°æŒ‰é’® - é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨ -->
          <button class="p-2 hover:bg-slate-100 rounded-lg transition-colors" onclick="refreshMobileSessionPicker()">
            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
          </button>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨å®¹å™¨ - åŠ¨æ€å¡«å……ä¼šè¯å¡ç‰‡ -->
        <div id="mobile-session-picker-list" class="space-y-2">
          <!-- åŠ è½½ä¸­å ä½ç¬¦ - é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤º -->
          <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
        </div>
      </div>

      <!-- åº•éƒ¨æç¤ºä¿¡æ¯ - è§£é‡Šä¼šè¯çš„æ¦‚å¿µ -->
      <div class="border-t pt-4 text-xs text-slate-500 relative">
        <p>ğŸ’¡ æç¤ºï¼šæ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€ã€‚æ‚¨å¯ä»¥åˆ›å»ºå¤šä¸ªä¼šè¯æ¥ç®¡ç†ä¸åŒçš„è´¦å·ã€‚</p>
      </div>
    </div>
  </div>

  <div id="account-params-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40" onclick="
    const modalElem = this.parentElement;
    modalElem.classList.add('hidden'); 
    modalElem.classList.remove('flex'); 
    document.body.classList.remove('modal-visible');
  "></div>
    <div class="panel rounded-2xl p-6 w-[32rem] space-y-4 relative">
      <h3 id="account-params-title" class="text-xl font-bold text-sky-600 text-center">è´¦å·å‚æ•°è®¾ç½®</h3>
      <div id="account-params-container" class="text-sm space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
      <div class="flex justify-end pt-2 gap-3">
        <button class="btn btn-ghost border border-slate-300" onclick="
        const m = this.closest('#account-params-modal');
        m.classList.add('hidden'); 
        m.classList.remove('flex'); 
        document.body.classList.remove('modal-visible');
      ">å…³é—­</button>

        <button id="save-account-params-btn" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="notifications-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40" onclick="toggleNotifications(false)"></div>
    <div class="panel rounded-2xl p-6 w-[36rem] space-y-4 relative">
      <h3 class="text-xl font-bold text-sky-600 text-center">é€šçŸ¥ä¸­å¿ƒ</h3>
      <div id="notifications-content" class="text-sm space-y-2 max-h-[70vh] overflow-y-auto pr-2">
        <p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½...</p>
      </div>
      <div class="flex justify-between items-center pt-2">
        <div class="flex gap-2"> <button id="refresh-notifications-btn"
            class="btn btn-ghost !py-1 !px-3 text-sky-600">åˆ·æ–°</button>
          <button id="mark-all-read-btn" class="btn btn-secondary !py-1 !px-3">ä¸€é”®å·²è¯»</button>
        </div>
        <button class="btn btn-ghost border border-slate-300" onclick="toggleNotifications(false)">å…³é—­</button>
      </div>
    </div>
  </div>


  <div id="alert-modal" class="fixed inset-0 flex items-center justify-center hidden z-[50000]">
    <div class="absolute inset-0 bg-black/60" onclick="closeModalAlert()"></div>
    <div class="panel rounded-2xl p-6 w-11/12 md:w-96 space-y-6 relative">
      <h3 id="alert-modal-title" class="text-xl font-bold text-red-600 text-center">æ“ä½œå¤±è´¥</h3>
      <p id="alert-modal-message" class="text-sm text-slate-600 text-center py-4">
        è¿™æ˜¯ä¸€ä¸ªé”™è¯¯æç¤ºã€‚
      </p>
      <div class="flex justify-center gap-3 pt-4">
        <button id="alert-modal-close-btn" class="btn btn-primary">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- 
    ===================================================================
    ç®¡ç†é¢æ¿æ¨¡æ€æ¡† - ä¼˜åŒ–ç¾åŒ–ç‰ˆ
    åŠŸèƒ½è¯´æ˜ï¼šæä¾›ç³»ç»Ÿç®¡ç†åŠŸèƒ½çš„ç»Ÿä¸€å…¥å£ï¼ŒåŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€æ—¥å¿—æŸ¥çœ‹ã€ç³»ç»Ÿé…ç½®ç­‰
    ä¼˜åŒ–å†…å®¹ï¼š
    1. å¢å¼ºè§†è§‰æ•ˆæœï¼šæ·»åŠ æ¸å˜èƒŒæ™¯ã€é˜´å½±ã€åœ†è§’ç­‰ç°ä»£åŒ–è®¾è®¡å…ƒç´ 
    2. æ”¹å–„äº¤äº’ä½“éªŒï¼šä¼˜åŒ–æ ‡ç­¾é¡µåˆ‡æ¢åŠ¨ç”»ã€æŒ‰é’®æ‚¬åœæ•ˆæœ
    3. æå‡å¯è®¿é—®æ€§ï¼šæ·»åŠ å›¾æ ‡ã€æ”¹å–„å¯¹æ¯”åº¦ã€ä¼˜åŒ–ç§»åŠ¨ç«¯é€‚é…
    ===================================================================
  -->
  <div id="admin-panel-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <!-- åŠé€æ˜é®ç½©å±‚ï¼Œç‚¹å‡»å…³é—­é¢æ¿ -->
    <div class="absolute inset-0 bg-gradient-to-br from-black/50 to-slate-900/60 backdrop-blur-sm"
      onclick="toggleAdminPanel(false)"></div>

    <!-- ä¸»é¢æ¿å®¹å™¨ - æ·»åŠ é˜´å½±å’ŒåŠ¨ç”»æ•ˆæœ -->
    <div
      class="panel rounded-3xl p-8 w-[65rem] max-h-[85vh] overflow-x-hidden space-y-5 relative flex flex-col shadow-2xl border-2 border-white/20">

      <!-- æ ‡é¢˜æ  - æ·»åŠ æ¸å˜èƒŒæ™¯å’Œå›¾æ ‡ -->
      <div class="relative mb-2 text-center flex-shrink-0">
        <div class="flex items-center justify-center gap-3">
          <!-- ç®¡ç†é¢æ¿å›¾æ ‡ -->
          <svg class="w-8 h-8 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
            </path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
            </path>
          </svg>
          <h3
            class="text-3xl font-bold bg-gradient-to-r from-sky-600 to-blue-600 bg-clip-text text-transparent inline-block">
            ç®¡ç†é¢æ¿</h3>
        </div>

        <!-- å…³é—­æŒ‰é’® - æ”¹è¿›æ ·å¼å’Œæ‚¬åœæ•ˆæœ -->
        <button id="admin-modal-close-btn"
          class="absolute top-1/2 right-0 transform -translate-y-1/2 btn btn-ghost !py-2 !px-4 hover:bg-red-50 hover:text-red-600 transition-all duration-200 rounded-xl"
          onclick="toggleAdminPanel(false)">
          <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          å…³é—­
        </button>
      </div>

      <!-- æ ‡ç­¾é¡µå¯¼èˆªæ  - ä¼˜åŒ–æ ·å¼å’Œé—´è· -->
      <div class="flex border-b-2 border-slate-200 flex-shrink-0 overflow-x-auto gap-1 pb-0">
        <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾ - æ·»åŠ å›¾æ ‡ -->
        <button id="admin-tab-users_modal"
          class="px-5 py-3 font-semibold text-sky-600 border-b-3 border-sky-600 hover:bg-sky-50 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
            </path>
          </svg>
          ç”¨æˆ·ç®¡ç†
        </button>

        <!-- æƒé™ç»„ç®¡ç†æ ‡ç­¾ -->
        <button id="admin-tab-groups_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
            </path>
          </svg>
          æƒé™ç»„
        </button>

        <!-- æ—¥å¿—æŸ¥çœ‹æ ‡ç­¾ -->
        <button id="admin-tab-logs_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
            </path>
          </svg>
          æ—¥å¿—æŸ¥çœ‹
        </button>

        <!-- ç³»ç»ŸçŠ¶æ€æ ‡ç­¾ -->
        <button id="admin-tab-health_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
            </path>
          </svg>
          ç³»ç»ŸçŠ¶æ€
        </button>

        <!-- ä¸ªäººä¿¡æ¯æ ‡ç­¾ -->
        <button id="admin-tab-profile_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          ä¸ªäººä¿¡æ¯
        </button>

        <!-- ä¼šè¯ç®¡ç†æ ‡ç­¾ -->
        <button id="admin-tab-sessions_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          ä¼šè¯ç®¡ç†
        </button>

        <!-- ç•™è¨€æ¿æ ‡ç­¾ -->
        <button id="admin-tab-messages_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
            </path>
          </svg>
          ç•™è¨€æ¿
        </button>

        <!-- IPå°ç¦æ ‡ç­¾ -->
        <button id="admin-tab-ipban_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
          </svg>
          IPå°ç¦
        </button>

        <!-- çŸ­ä¿¡é…ç½®æ ‡ç­¾ -->
        <button id="admin-tab-sms_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
            </path>
          </svg>
          çŸ­ä¿¡é…ç½®
        </button>

        <!-- ç³»ç»Ÿé…ç½®æ ‡ç­¾ -->
        <button id="admin-tab-config_modal"
          class="px-5 py-3 font-semibold text-slate-400 border-b-3 border-transparent hover:bg-slate-50 hover:text-slate-600 transition-all duration-200 rounded-t-lg whitespace-nowrap"
          style="display:none;">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
            </path>
          </svg>
          ç³»ç»Ÿé…ç½®
        </button>
      </div>

      <div class="overflow-x-hidden flex-grow min-h-0">
        <div id="admin-users-panel_modal" class="space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">ç”¨æˆ·åˆ—è¡¨</h4>
            <div class="flex gap-2">
              <button id="admin-create-user_modal" class="btn btn-primary !py-1 !px-2">æ–°å¢ç”¨æˆ·</button>
              <button id="admin-refresh-users_modal" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
            </div>
          </div>
          <div id="admin-users-list_modal" class="space-y-2 max-h-[50vh] overflow-y-auto -mr-2 pr-2">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>
        </div>

        <div id="admin-groups-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">æƒé™ç»„åˆ—è¡¨</h4>
            <div class="flex gap-2">
              <button id="admin-create-group_modal" class="btn btn-primary !py-1 !px-2">æ–°å¢æƒé™ç»„</button>
              <button id="admin-refresh-groups_modal" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
            </div>
          </div>
          <div id="admin-groups-list_modal" class="space-y-2 max-h-[50vh] overflow-y-auto -mr-2 pr-2">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>
        </div>

        <div id="admin-logs-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">ç³»ç»Ÿæ—¥å¿—</h4>
            <div class="flex gap-2">
              <select id="log-limit-select_modal" class="text-sm border border-slate-300 rounded px-2 py-1">
                <option value="100">æ¯é¡µ100è¡Œ</option>
                <option value="200">æ¯é¡µ200è¡Œ</option>
                <option value="500">æ¯é¡µ500è¡Œ</option>
                <option value="1000">æ¯é¡µ1000è¡Œ</option>
              </select>
              <button id="admin-refresh-logs_modal" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
            </div>
          </div>
          <div class="bg-slate-900 text-green-400 rounded-lg p-4 font-mono text-xs overflow-auto max-h-[47vh]">
            <pre id="admin-logs-content_modal" class="whitespace-pre-wrap overflow-visible">åŠ è½½ä¸­...</pre>
          </div>
          <div id="admin-logs-pagination"
            class="flex justify-between items-center text-sm text-slate-600 pt-2 border-t border-slate-200">
            <button id="log-prev-page"
              class="btn btn-ghost !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€é¡µ</button>

            <div class="flex items-center gap-2">
              <select id="log-page-select"
                class="text-sm border border-slate-300 rounded px-2 py-1 bg-white focus:border-sky-500 focus:ring-1 focus:ring-sky-500 focus:outline-none cursor-pointer">
                <option value="1">ç¬¬ 1 / 1 é¡µ</option>
              </select>
              <span id="log-page-total" class="text-sm text-slate-500 whitespace-nowrap">(å…± 0 è¡Œ)</span>
            </div>

            <button id="log-next-page"
              class="btn btn-ghost !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>

        <div id="admin-sessions-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">ä¼šè¯åˆ—è¡¨</h4>
            <div class="flex items-center gap-3">
              <label id="god-mode-toggle_modal" class="flex items-center gap-2 cursor-pointer" style="display:none;">
                <input type="checkbox" id="god-mode-checkbox_modal"
                  class="w-4 h-4 accent-red-600 rounded cursor-pointer">
                <span class="text-sm font-semibold text-red-600">ä¸Šå¸æ¨¡å¼</span>
              </label>
              <div id="admin-session-count-display" class="text-sm text-slate-600">
                <!-- ä¼šè¯è®¡æ•°å°†ç”±JSåŠ¨æ€å¡«å…… -->
              </div>
              <button id="admin-refresh-sessions_modal" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
            </div>
          </div>
          <div id="admin-sessions-list_modal" class="space-y-2 max-h-[50vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>
        </div>

        <!-- å¥åº·çŠ¶æ€é¢æ¿ -->
        <div id="admin-health-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">ç³»ç»Ÿå¥åº·çŠ¶æ€</h4>
            <div class="flex items-center gap-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="health-auto-refresh-toggle"
                  class="w-4 h-4 accent-sky-600 rounded cursor-pointer" checked>
                <span class="text-sm text-slate-600">
                  è‡ªåŠ¨åˆ·æ–°(5ç§’)
                  <!-- ä»»åŠ¡23ï¼šå€’è®¡æ—¶æ˜¾ç¤º -->
                  <span id="health-countdown-display" class="font-semibold text-sky-600"></span>
                </span>
              </label>
              <button id="admin-refresh-health_modal" class="btn btn-ghost !py-1 !px-2">æ‰‹åŠ¨åˆ·æ–°</button>
            </div>
          </div>
          <div id="admin-health-content_modal" class="space-y-4">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>
        </div>

        <!-- ä¸ªäººä¿¡æ¯é¢æ¿ -->
        <div id="admin-profile-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">ä¸ªäººä¿¡æ¯</h4>
            <button id="admin-refresh-profile_modal" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
          </div>

          <div id="admin-profile-content_modal" class="space-y-6 text-slate-800">

            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3">
              <h5 class="font-semibold text-slate-700 mb-2">å¤´åƒ</h5>
              <div class="flex items-center gap-4">
                <img id="profile-avatar-display" src="" alt="ç”¨æˆ·å¤´åƒ"
                  class="w-20 h-20 rounded-full border-2 border-slate-200"
                  onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EğŸ‘¤%3C/text%3E%3C/svg%3E'">
                <div class="flex-1 space-y-2">
                  <input type="file" id="profile-avatar-file" accept="image/*" class="hidden"
                    onchange="previewAvatar(event)">

                  <button class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm"
                    onclick="document.getElementById('profile-avatar-file').click();">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    ä¸Šä¼ å¤´åƒ
                  </button>
                </div>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3">
              <h5 class="font-semibold text-slate-700 mb-3">åŸºæœ¬ä¿¡æ¯</h5>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">æ˜µç§°</label>
                  <input type="text" id="profile-nickname" class="input-field" placeholder="è¾“å…¥æ˜µç§°">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">æ‰‹æœºå·</label>
                  <div class="flex gap-2">
                    <!-- phone-input-wrapper: ä¸ºæ‰‹æœºå·è¾“å…¥æ¡†æ·»åŠ +86å‰ç¼€å®¹å™¨ -->
                    <div class="phone-input-wrapper flex-1">
                      <!-- phone-prefix: ä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç å‰ç¼€ (+86åé¢æœ‰ç©ºæ ¼) -->
                      <span class="phone-prefix">+86 </span>
                      <!-- è¾“å…¥æ¡†ï¼šåªè¯»çŠ¶æ€ï¼Œç”¨äºæ˜¾ç¤ºå½“å‰ç»‘å®šçš„æ‰‹æœºå· -->
                      <input type="tel" id="profile-phone" class="input-field" placeholder="æœªç»‘å®š" readonly
                        inputmode="numeric">
                    </div>
                    <!-- ä¿®æ”¹æ‰‹æœºå·æŒ‰é’® -->
                    <button onclick="modifyPhone()" id="profile-modify-phone-btn"
                      class="btn btn-ghost border border-slate-300 !py-1.5 !px-3 text-sm whitespace-nowrap">
                      ä¿®æ”¹æ‰‹æœºå·
                    </button>
                  </div>
                  <p class="text-xs text-slate-500 mt-1" id="profile-phone-hint">ğŸ’¡ ä¿®æ”¹æ‰‹æœºå·éœ€è¦çŸ­ä¿¡éªŒè¯</p>
                </div>
                <div class="flex justify-end">
                  <button onclick="updateBasicInfo()" class="btn btn-primary">ä¿å­˜åŸºæœ¬ä¿¡æ¯</button>
                </div>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3">
              <h5 class="font-semibold text-slate-700 mb-3">ä¿®æ”¹å¯†ç </h5>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">å½“å‰å¯†ç </label>
                  <input type="password" id="profile-current-password" class="input-field" placeholder="è¾“å…¥å½“å‰å¯†ç ">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">æ–°å¯†ç </label>
                  <input type="password" id="profile-new-password" class="input-field" placeholder="è¾“å…¥æ–°å¯†ç ">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">ç¡®è®¤æ–°å¯†ç </label>
                  <input type="password" id="profile-confirm-password" class="input-field" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                <div class="flex justify-end">
                  <button onclick="updatePassword()" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                </div>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3">
              <h5 class="font-semibold text-slate-700 mb-3">åŒå› ç´ è®¤è¯(2FA)</h5>
              <div id="profile-2fa-status" class="mb-3">
                <p class="text-sm text-slate-600">çŠ¶æ€: <span id="profile-2fa-enabled">æ£€æµ‹ä¸­...</span></p>
              </div>
              <div id="profile-2fa-setup" class="space-y-3 hidden">
                <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 text-center">
                  <canvas id="profile-2fa-qr" class="mx-auto"></canvas>
                  <p class="text-xs text-slate-600 mt-2">å¯†é’¥: <span id="profile-2fa-secret" class="font-mono"></span></p>
                  <p class="text-xs text-slate-600 mt-1">è¯·ä½¿ç”¨Google Authenticatoræˆ–ç±»ä¼¼åº”ç”¨æ‰«ææ­¤äºŒç»´ç </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">éªŒè¯ç </label>
                  <input type="text" id="profile-2fa-code" class="input-field" placeholder="è¾“å…¥6ä½éªŒè¯ç ">
                </div>
                <div class="flex justify-end">
                  <button onclick="enable2FA()" class="btn btn-primary">å¯ç”¨2FA</button>
                </div>
              </div>
              <div id="profile-2fa-actions" class="space-y-2 flex justify-end">
                <button onclick="generate2FA()" class="btn btn-primary">ç”Ÿæˆ2FAå¯†é’¥</button>
              </div>
              <div id="profile-2fa-enabled-actions" class="space-y-2 hidden flex justify-end gap-2">
                <button onclick="test2FA()" class="btn btn-ghost">æµ‹è¯•2FA</button>
                <button onclick="disable2FA()" class="btn btn-warning">å…³é—­2FA</button>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3">
              <h5 class="font-semibold text-slate-700 mb-3">ä¸»é¢˜è®¾ç½®</h5>
              <select id="profile-theme-select" onchange="updateTheme()" class="select-field">
                <option value="light">æµ…è‰²ä¸»é¢˜</option>
                <option value="dark">æ·±è‰²ä¸»é¢˜</option>
              </select>
            </div>

          </div>
        </div>


        <!-- ç•™è¨€æ¿é¢æ¿ -->
        <div id="admin-messages-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">ç•™è¨€æ¿</h4>
            <button id="admin-refresh-messages_modal" class="btn btn-ghost !py-1 !px-2">åˆ·æ–°</button>
          </div>

          <!-- å‘è¡¨ç•™è¨€è¡¨å• -->
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-3">
            <h5 class="font-semibold text-slate-700">å‘è¡¨ç•™è¨€</h5>
            <div id="message-guest-fields" class="space-y-2 hidden">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">æ˜µç§° <span
                    class="text-red-500">*</span></label>
                <input type="text" id="message-nickname" class="input-field" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" maxlength="50">
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">é‚®ç®± <span
                    class="text-red-500">*</span></label>
                <input type="email" id="message-email" class="input-field" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±">
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-1">ç•™è¨€å†…å®¹ <span
                  class="text-red-500">*</span></label>
              <textarea id="message-content" class="input-field" rows="4" placeholder="è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼ˆæœ€å¤š1000å­—ï¼‰"
                maxlength="1000"></textarea>
              <div class="text-xs text-slate-500 mt-1 text-right">
                <span id="message-char-count">0</span> / 1000
              </div>
            </div>
            <button id="post-message-btn" onclick="postMessage()" class="btn btn-primary w-full">å‘è¡¨ç•™è¨€</button>
          </div>

          <!-- ç•™è¨€åˆ—è¡¨ -->
          <div id="admin-messages-list_modal" class="space-y-3 max-h-[19vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- ç”¨æˆ·æ—¥å¿—æŸ¥çœ‹Modal -->
        <!-- æ­¤ç»„ä»¶å…è®¸ç®¡ç†å‘˜æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„ç™»å½•è®°å½•å’Œæ“ä½œè®°å½• -->
        <!-- ============================================================ -->
        <div id="admin-user-logs-modal" class="hidden space-y-4">
          <h4 class="font-semibold">ç”¨æˆ·æ—¥å¿—æŸ¥çœ‹</h4>

          <!-- æ˜¾ç¤ºå½“å‰æŸ¥çœ‹çš„ç”¨æˆ·å -->
          <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
            <p class="text-sm text-slate-700">
              å½“å‰æŸ¥çœ‹ç”¨æˆ·: <span id="current-log-username" class="font-semibold text-sky-600">N/A</span>
            </p>
          </div>

          <!-- Tabåˆ‡æ¢æŒ‰é’® -->
          <div class="flex border-b border-slate-200">
            <!-- ç™»å½•è®°å½•TabæŒ‰é’®ï¼Œé»˜è®¤æ¿€æ´»çŠ¶æ€ -->
            <button id="log-tab-login" class="px-4 py-2 font-semibold text-sky-600 border-b-2 border-sky-600">
              ç™»å½•è®°å½•
            </button>
            <!-- æ“ä½œè®°å½•TabæŒ‰é’®ï¼Œé»˜è®¤æœªæ¿€æ´» -->
            <button id="log-tab-audit" class="px-4 py-2 font-semibold text-slate-400 border-b-2 border-transparent">
              æ“ä½œè®°å½•
            </button>
          </div>

          <!-- ç™»å½•è®°å½•å†…å®¹åŒºåŸŸï¼Œé»˜è®¤æ˜¾ç¤º -->
          <div id="log-login-content" class="space-y-2 max-h-[50vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>

          <!-- æ“ä½œè®°å½•å†…å®¹åŒºåŸŸï¼Œé»˜è®¤éšè— -->
          <div id="log-audit-content" class="hidden space-y-2 max-h-[50vh] overflow-y-auto">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>

          <!-- è¿”å›æŒ‰é’® -->
          <div class="flex justify-end">
            <button onclick="closeUserLogsModal()" class="btn btn-ghost">è¿”å›</button>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- IPå°ç¦ç®¡ç†Modal -->
        <!-- ============================================================ -->
        <div id="admin-ip-ban-modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold text-lg">ğŸš« IPå°ç¦ç®¡ç†</h4>
            <button id="admin-refresh-ipban_modal" class="btn btn-ghost !py-1 !px-2" onclick="loadIPBans()">åˆ·æ–°</button>
          </div>

          <div class="bg-gradient-to-br from-slate-50 to-gray-50 border-2 border-slate-200 rounded-lg p-4 shadow-sm">
            <h5 class="font-bold text-base text-slate-800 mb-3">ğŸ“œ ç°æœ‰å°ç¦è§„åˆ™</h5>
            <div id="ip-ban-list" class="space-y-2 max-h-[35vh] overflow-y-auto -mr-2 pr-2">
              <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
            </div>
          </div>

          <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg p-4 shadow-sm">
            <h5 class="font-bold text-base text-blue-900 mb-3">â• æ·»åŠ å°ç¦è§„åˆ™</h5>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ğŸ·ï¸ å°ç¦ç±»å‹</label>
                <select id="ban-type" class="select-field">
                  <option value="ip">å•ä¸ªIP</option>
                  <option value="range">IPèŒƒå›´(Range)</option>
                </select>
                <p class="mt-1 text-xs text-slate-500">
                  - <strong>å•ä¸ªIP</strong>: å°ç¦ä¸€ä¸ªç‰¹å®šçš„IPåœ°å€ (ä¾‹å¦‚: 1.2.3.4)<br>
                  - <strong>IPèŒƒå›´(Range)</strong>: å°ç¦ä¸€ä¸ªIPåœ°å€èŒƒå›´ (ä¾‹å¦‚: 192.168.1.1-192.168.1.100)
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ğŸ¯ å°ç¦ç›®æ ‡</label>
                <input type="text" id="ban-target" class="input-field" placeholder="è¯·è¾“å…¥IPåœ°å€ (ä¾‹å¦‚: 1.2.3.4)">
                <p id="ban-target-hint" class="mt-1 text-xs text-slate-500">
                  ç¤ºä¾‹: 1.2.3.4
                </p>
                <p id="ban-target-error" class="hidden mt-1 text-xs text-red-600 font-semibold"></p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end pt-2 border-t border-blue-100">
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-1">ğŸ”’ å°ç¦èŒƒå›´</label>
                  <select id="ban-scope" class="select-field">
                    <option value="all">å°ç¦æ‰€æœ‰åŠŸèƒ½</option>
                    <option value="messages_only">ä»…å°ç¦ç•™è¨€æ¿</option>
                  </select>
                </div>
                <button onclick="addIPBan()" class="btn btn-primary w-full min-h-[44px]">æ·»åŠ å°ç¦</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- çŸ­ä¿¡æœåŠ¡é…ç½®Modal -->
        <!-- ============================================================ -->
        <!-- çŸ­ä¿¡æœåŠ¡é…ç½®æ¨¡æ€æ¡† - é‡æ„ç‰ˆæœ¬ -->
        <!-- é‡‡ç”¨å¡ç‰‡å¼å¸ƒå±€ï¼Œæ¡ç†æ¸…æ™°ï¼Œè§†è§‰å±‚æ¬¡åˆ†æ˜ -->
        <div id="admin-sms-config-modal" class="hidden space-y-4">
          <!-- æ¨¡æ€æ¡†æ ‡é¢˜æ ï¼šæ˜¾ç¤ºæ ‡é¢˜å’Œåˆ·æ–°æŒ‰é’® -->
          <div class="flex justify-between items-center">
            <h4 class="font-semibold text-lg">ğŸ“± çŸ­ä¿¡æœåŠ¡é…ç½®</h4>
            <!-- åˆ·æ–°æŒ‰é’®ï¼šç‚¹å‡»åé‡æ–°åŠ è½½é…ç½® -->
            <button id="admin-refresh-sms_modal" class="btn btn-ghost !py-1 !px-2" onclick="loadSMSConfig()">åˆ·æ–°</button>
          </div>

          <!-- é…ç½®åŒºåŸŸå®¹å™¨ï¼šä½¿ç”¨å‚ç›´é—´è·ç»„ç»‡å„ä¸ªé…ç½®å¡ç‰‡ -->
          <div class="space-y-4">

            <!-- ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šåŠŸèƒ½å¼€å…³å¡ç‰‡ ========== -->
            <!-- ä½¿ç”¨æ¸å˜èƒŒæ™¯å’Œé˜´å½±æ•ˆæœï¼Œçªå‡ºæ˜¾ç¤ºè¿™æ˜¯æœ€é‡è¦çš„é…ç½®é¡¹ -->
            <div
              class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 shadow-sm">
              <!-- å¡ç‰‡æ ‡é¢˜ï¼šä½¿ç”¨å›¾æ ‡å’Œè¾ƒå¤§å­—ä½“å¢å¼ºè§†è§‰æ•ˆæœ -->
              <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ”Œ</span>
                <h5 class="font-bold text-base text-purple-900">åŠŸèƒ½å¼€å…³</h5>
              </div>

              <!-- ä¸»å¼€å…³ï¼šå¯ç”¨çŸ­ä¿¡æœåŠ¡ï¼ˆæœ€é‡è¦çš„é…ç½®é¡¹ï¼‰ -->
              <!-- æ·»åŠ  onchange äº‹ä»¶ï¼Œå½“ä¸»å¼€å…³å…³é—­æ—¶åŒæ­¥å…³é—­æ‰€æœ‰å­å¼€å…³ -->
              <label
                class="flex items-center gap-3 p-3 bg-white rounded-lg border border-purple-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                <input type="checkbox" id="sms-enabled" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500"
                  onchange="handleSmsMainSwitchChange()">
                <div class="flex-1">
                  <span class="font-semibold text-slate-800 block">å¯ç”¨çŸ­ä¿¡æœåŠ¡</span>
                  <span class="text-xs text-slate-500">å…³é—­æ­¤å¼€å…³å°†ç¦ç”¨æ‰€æœ‰çŸ­ä¿¡åŠŸèƒ½</span>
                </div>
              </label>

              <!-- å­å¼€å…³ç»„ï¼šåŠŸèƒ½ç»†åˆ†é…ç½®é¡¹ -->
              <!-- ä½¿ç”¨ç¼©è¿›å’Œè¾ƒå°å°ºå¯¸è¡¨ç¤ºè¿™äº›æ˜¯å­é€‰é¡¹ -->
              <div class="ml-8 mt-3 space-y-2 border-l-2 border-purple-200 pl-4">
                <!-- å­å¼€å…³1ï¼šå…è®¸ç”¨æˆ·ä¿®æ”¹æ‰‹æœºå· -->
                <label class="flex items-center gap-2 cursor-pointer group">
                  <input type="checkbox" id="sms-enable-phone-modification"
                    class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                  <div class="flex-1">
                    <span class="text-sm text-slate-700 group-hover:text-slate-900">å…è®¸ç”¨æˆ·ä¿®æ”¹æ‰‹æœºå·</span>
                    <span class="text-xs text-slate-400 block">ç”¨æˆ·å¯åœ¨ä¸ªäººèµ„æ–™ä¸­ä¿®æ”¹ç»‘å®šçš„æ‰‹æœºå·</span>
                  </div>
                </label>

                <!-- å­å¼€å…³2ï¼šå…è®¸æ‰‹æœºå·ç™»å½• -->
                <label class="flex items-center gap-2 cursor-pointer group">
                  <input type="checkbox" id="sms-enable-phone-login"
                    class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                  <div class="flex-1">
                    <span class="text-sm text-slate-700 group-hover:text-slate-900">å…è®¸æ‰‹æœºå·ç™»å½•</span>
                    <span class="text-xs text-slate-400 block">ç”¨æˆ·å¯ä½¿ç”¨æ‰‹æœºå·+å¯†ç è¿›è¡Œç™»å½•</span>
                  </div>
                </label>

                <!-- å­å¼€å…³3ï¼šæ³¨å†Œæ—¶éœ€è¦çŸ­ä¿¡éªŒè¯ -->
                <label class="flex items-center gap-2 cursor-pointer group">
                  <input type="checkbox" id="sms-enable-phone-registration-verify"
                    class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                  <div class="flex-1">
                    <span class="text-sm text-slate-700 group-hover:text-slate-900">æ³¨å†Œæ—¶éœ€è¦çŸ­ä¿¡éªŒè¯</span>
                    <span class="text-xs text-slate-400 block">ç”¨æˆ·æ³¨å†Œæ—¶å¿…é¡»å¡«å†™æ‰‹æœºå·å¹¶éªŒè¯</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- ========== ç¬¬äºŒéƒ¨åˆ†ï¼šçŸ­ä¿¡å®é…ç½®å¡ç‰‡ ========== -->
            <!-- ä½¿ç”¨è“è‰²ç³»ä¸»é¢˜ï¼Œæ¸…æ™°åŒºåˆ†ä¸åŒé…ç½®åŒºåŸŸ -->
            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg p-4 shadow-sm">
              <!-- å¡ç‰‡æ ‡é¢˜ -->
              <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ“§</span>
                <h5 class="font-bold text-base text-blue-900">çŸ­ä¿¡å®é…ç½®</h5>
              </div>

              <!-- é…ç½®è¡¨å•ï¼šæ‰€æœ‰è¾“å…¥æ¡†ä½¿ç”¨ç»Ÿä¸€æ ·å¼ -->
              <div class="space-y-3">
                <!-- çŸ­ä¿¡å®ç”¨æˆ·å -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      ğŸ‘¤ ç”¨æˆ·å
                    </span>
                  </label>
                  <input type="text" id="sms-username"
                    class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                    placeholder="è¯·è¾“å…¥çŸ­ä¿¡å®ç”¨æˆ·å">
                  <p class="text-xs text-slate-500 mt-1">åœ¨çŸ­ä¿¡å®å®˜ç½‘æ³¨å†Œåè·å–</p>
                </div>

                <!-- çŸ­ä¿¡å® API Key -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      ğŸ”‘ API Key
                    </span>
                  </label>
                  <input type="password" id="sms-apikey"
                    class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                    placeholder="è¯·è¾“å…¥çŸ­ä¿¡å® API Key">
                  <p class="text-xs text-slate-500 mt-1">åœ¨çŸ­ä¿¡å®åå°çš„"APIæ¥å£"é¡µé¢è·å–</p>
                </div>

                <!-- çŸ­ä¿¡ç­¾å -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      âœï¸ çŸ­ä¿¡ç­¾å
                    </span>
                  </label>
                  <input type="text" id="sms-signature"
                    class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                    placeholder="ã€æ‚¨çš„ç­¾åã€‘" maxlength="12">
                  <p class="text-xs text-slate-500 mt-1">ç­¾åé•¿åº¦3-12å­—ï¼Œéœ€åœ¨çŸ­ä¿¡å®åå°å®¡æ ¸é€šè¿‡</p>
                </div>

                <!-- çŸ­ä¿¡æ¨¡æ¿ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      ğŸ“ çŸ­ä¿¡æ¨¡æ¿
                    </span>
                  </label>
                  <textarea id="sms-template"
                    class="w-full border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                    rows="3" placeholder="æ‚¨çš„éªŒè¯ç æ˜¯ï¼š{code}ï¼Œ{minutes}åˆ†é’Ÿå†…æœ‰æ•ˆã€‚"></textarea>
                  <p class="text-xs text-slate-500 mt-1">ä½¿ç”¨ {code} è¡¨ç¤ºéªŒè¯ç ï¼Œ{minutes} è¡¨ç¤ºæœ‰æ•ˆæœŸåˆ†é’Ÿæ•°</p>
                </div>

                <!-- éªŒè¯ç æœ‰æ•ˆæœŸ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      â±ï¸ éªŒè¯ç æœ‰æ•ˆæœŸ
                    </span>
                  </label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="sms-code-expire"
                      class="flex-1 border-2 border-blue-200 rounded-lg px-3 py-2 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all"
                      placeholder="5" min="1" max="60">
                    <span class="text-sm text-slate-600">åˆ†é’Ÿ</span>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">å»ºè®®è®¾ç½®ä¸º5-10åˆ†é’Ÿï¼Œè¿‡é•¿ä¸å®‰å…¨ï¼Œè¿‡çŸ­ä½“éªŒå·®</p>
                </div>
              </div>
            </div>

            <!-- ========== ç¬¬ä¸‰éƒ¨åˆ†ï¼šé€Ÿç‡é™åˆ¶å¡ç‰‡ ========== -->
            <!-- ä½¿ç”¨æ©™è‰²ç³»ä¸»é¢˜ï¼Œè¡¨ç¤ºè¿™æ˜¯å®‰å…¨ç›¸å…³çš„é…ç½® -->
            <div
              class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 rounded-lg p-4 shadow-sm">
              <!-- å¡ç‰‡æ ‡é¢˜ -->
              <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">âš¡</span>
                <h5 class="font-bold text-base text-orange-900">é€Ÿç‡é™åˆ¶</h5>
              </div>
              <p class="text-xs text-slate-600 mb-3">é˜²æ­¢æ»¥ç”¨å’Œæ¶æ„æ”»å‡»ï¼Œä¿æŠ¤ç³»ç»Ÿå®‰å…¨</p>

              <!-- é€Ÿç‡é™åˆ¶è¡¨å•ï¼šä½¿ç”¨ç½‘æ ¼å¸ƒå±€åœ¨å¤§å±å¹•ä¸Šæ¨ªå‘æ’åˆ— -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <!-- å•ä¸ªè´¦å·æ¯å¤©æœ€å¤šå‘é€æ¬¡æ•° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      ğŸ‘¤ è´¦æˆ·é™åˆ¶
                    </span>
                  </label>
                  <div class="flex items-center gap-1">
                    <input type="number" id="sms-limit-account"
                      class="w-full border-2 border-orange-200 rounded-lg px-3 py-2 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
                      placeholder="10" min="1">
                    <span class="text-sm text-slate-600 whitespace-nowrap">æ¡/å¤©</span>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">å•ä¸ªè´¦å·æ¯å¤©æœ€å¤š</p>
                </div>

                <!-- å•ä¸ªIPæ¯å¤©æœ€å¤šå‘é€æ¬¡æ•° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      ğŸŒ IPé™åˆ¶
                    </span>
                  </label>
                  <div class="flex items-center gap-1">
                    <input type="number" id="sms-limit-ip"
                      class="w-full border-2 border-orange-200 rounded-lg px-3 py-2 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
                      placeholder="20" min="1">
                    <span class="text-sm text-slate-600 whitespace-nowrap">æ¡/å¤©</span>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">å•ä¸ªIPæ¯å¤©æœ€å¤š</p>
                </div>

                <!-- å•ä¸ªæ‰‹æœºå·æ¯å¤©æœ€å¤šå‘é€æ¬¡æ•° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">
                    <span class="inline-flex items-center gap-1">
                      ğŸ“± æ‰‹æœºå·é™åˆ¶
                    </span>
                  </label>
                  <div class="flex items-center gap-1">
                    <input type="number" id="sms-limit-phone"
                      class="w-full border-2 border-orange-200 rounded-lg px-3 py-2 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
                      placeholder="5" min="1">
                    <span class="text-sm text-slate-600 whitespace-nowrap">æ¡/å¤©</span>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">å•ä¸ªæ‰‹æœºå·æ¯å¤©æœ€å¤š</p>
                </div>
              </div>
            </div>

            <!-- ========== ç¬¬å››éƒ¨åˆ†ï¼šWebhooké…ç½®å¡ç‰‡ ========== -->
            <!-- ä½¿ç”¨ç»¿è‰²ç³»ä¸»é¢˜ï¼Œè¡¨ç¤ºè¿™æ˜¯é›†æˆç›¸å…³çš„é…ç½® -->
            <div
              class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4 shadow-sm">
              <!-- å¡ç‰‡æ ‡é¢˜ -->
              <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ”—</span>
                <h5 class="font-bold text-base text-green-900">Webhook å›è°ƒåœ°å€</h5>
              </div>

              <!-- Webhook URL æ˜¾ç¤º -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">å›è°ƒåœ°å€</label>
                <input type="text" id="sms-webhook-url"
                  class="w-full border-2 border-green-200 rounded-lg px-3 py-2 bg-green-50 text-slate-700 font-mono text-sm"
                  readonly>
                <p class="text-xs text-slate-600 mt-2 flex items-start gap-1">
                  <span>ğŸ’¡</span>
                  <span>å°†æ­¤URLé…ç½®åˆ°çŸ­ä¿¡å®åå°çš„"çŸ­ä¿¡å›å¤"åŠŸèƒ½ä¸­ï¼Œå³å¯æ¥æ”¶ç”¨æˆ·å›å¤çš„çŸ­ä¿¡</span>
                </p>
              </div>
            </div>

            <!-- ========== ç¬¬äº”éƒ¨åˆ†ï¼šæ“ä½œåŒºå¡ç‰‡ ========== -->
            <!-- ä½¿ç”¨ç°è‰²ç³»ä¸»é¢˜ï¼ŒåŒ…å«æ“ä½œæŒ‰é’®å’Œä½™é¢æ˜¾ç¤º -->
            <div class="bg-gradient-to-br from-slate-50 to-gray-50 border-2 border-slate-200 rounded-lg p-4 shadow-sm">
              <!-- æ“ä½œæŒ‰é’®ç»„ï¼šæŸ¥è¯¢ä½™é¢å’Œä¿å­˜é…ç½® -->
              <div class="flex flex-col sm:flex-row gap-3">
                <!-- æŸ¥è¯¢ä½™é¢æŒ‰é’®ï¼šä½¿ç”¨æ¬¡è¦æ ·å¼ -->
                <button id="btn-check-sms-balance" onclick="checkSMSBalance()"
                  class="flex-1 btn btn-ghost min-h-[44px] border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-100 transition-all">
                  ğŸ’° æŸ¥è¯¢ä½™é¢
                </button>
                <!-- ä¿å­˜é…ç½®æŒ‰é’®ï¼šä½¿ç”¨ä¸»è¦æ ·å¼ï¼Œè§†è§‰ä¸Šæ›´çªå‡º -->
                <button onclick="saveSMSConfig()"
                  class="flex-1 btn btn-primary min-h-[44px] shadow-md hover:shadow-lg transition-all">
                  ğŸ’¾ ä¿å­˜é…ç½®
                </button>
              </div>

              <!-- ç®¡ç†åŠŸèƒ½æŒ‰é’®ç»„ï¼šçŸ­ä¿¡å†å²å’ŒéªŒè¯ç ç®¡ç† -->
              <div class="flex flex-col sm:flex-row gap-3 mt-3 pt-3 border-t-2 border-slate-200">
                <!-- çŸ­ä¿¡å‘é€å†å²æŒ‰é’® -->
                <button onclick="openSMSHistoryModal()"
                  class="flex-1 btn btn-ghost min-h-[44px] border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-100 transition-all">
                  ğŸ“‹ çŸ­ä¿¡å‘é€å†å²
                </button>
                <!-- éªŒè¯ç ç®¡ç†æŒ‰é’® -->
                <button onclick="openVerificationCodesModal()"
                  class="flex-1 btn btn-ghost min-h-[44px] border-2 border-slate-300 hover:border-slate-400 hover:bg-slate-100 transition-all">
                  ğŸ”‘ éªŒè¯ç ç®¡ç†
                </button>
              </div>

              <!-- ä½™é¢æ˜¾ç¤ºåŒºåŸŸï¼šé»˜è®¤éšè—ï¼ŒæŸ¥è¯¢ä½™é¢åæ˜¾ç¤º -->
              <div id="sms-balance-display" class="hidden mt-3 border-2 border-blue-300 bg-blue-50 rounded-lg p-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ’µ</span>
                    <span class="font-medium text-slate-700">å½“å‰ä½™é¢</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <span id="sms-balance-value" class="text-2xl font-bold text-blue-600">--</span>
                    <span class="text-sm text-slate-600">æ¡</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div id="admin-config-panel_modal" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold text-lg">âš™ï¸ ç³»ç»Ÿé…ç½®</h4>
            <div class="flex gap-2">
              <button id="admin-refresh-config_modal" class="btn btn-ghost !py-1 !px-2"
                onclick="loadSystemConfig()">åˆ·æ–°</button>
              <button id="admin-save-config_modal" class="btn btn-primary !py-1 !px-2"
                onclick="saveSystemConfig()">ä¿å­˜é…ç½®</button>
            </div>
          </div>
          <p class="text-xs text-amber-700 bg-amber-50 p-2 rounded-md">âš ï¸
            è­¦å‘Šï¼šä¿®æ”¹è¿™äº›é…ç½®å¯èƒ½ä¼šå½±å“ç³»ç»Ÿç¨³å®šæ€§ã€‚ä¿å­˜åï¼Œéƒ¨åˆ†é…ç½®éœ€è¦**é‡å¯ç¨‹åº**æ‰èƒ½ç”Ÿæ•ˆã€‚</p>

          <div id="admin-config-form" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
            <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
          </div>

        </div>

      </div>
    </div>
  </div>

  <div id="sms-balance-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1055]">
    <div class="absolute inset-0 bg-black/70" onclick="closeSMSBalanceModal()"></div>
    <div class="panel rounded-2xl p-6 w-[90%] max-w-md max-h-[85vh] space-y-4 relative overflow-hidden">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ğŸ’° çŸ­ä¿¡ä½™é¢</h3>
        <button onclick="closeSMSBalanceModal()"
          class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
      </div>

      <div class="space-y-3">
        <div class="text-center">
          <span class="text-sm text-slate-500">å‰©ä½™æ¡æ•°</span>
          <p id="sms-balance-modal-value" class="text-4xl font-bold text-sky-600">--</p>
        </div>
        <div class="text-center mt-2">
          <span class="text-sm text-slate-500">ä»Šæ—¥å·²å‘é€</span>
          <p id="sms-balance-modal-sent" class="text-2xl font-semibold text-slate-700">--</p>
        </div>
        <div class="mt-4 text-center">
          <p id="sms-balance-modal-message" class="text-xs text-slate-500 bg-slate-50 p-2 rounded-md">æŸ¥è¯¢ä¸­...</p>
        </div>
      </div>

      <div class="flex justify-end border-t pt-4">
        <button onclick="closeSMSBalanceModal()" class="btn btn-primary w-full">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- ========== çŸ­ä¿¡å‘é€å†å²äºŒçº§æ¨¡æ€çª— ========== -->
  <div id="sms-history-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/70" onclick="closeSMSHistoryModal()"></div>
    <div class="panel rounded-2xl p-6 w-[90%] max-w-5xl max-h-[85vh] space-y-4 relative overflow-hidden">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ğŸ“‹ çŸ­ä¿¡å‘é€å†å²</h3>
        <button onclick="closeSMSHistoryModal()"
          class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
      </div>

      <!-- è¿‡æ»¤å’Œåˆ·æ–° -->
      <div class="flex gap-2 items-center">
        <input type="date" id="sms-history-date-filter" class="input-field flex-1" placeholder="æŒ‰æ—¥æœŸè¿‡æ»¤">
        <input type="text" id="sms-history-phone-filter" class="input-field flex-1" placeholder="æŒ‰æ‰‹æœºå·è¿‡æ»¤">
        <button onclick="loadSMSHistory()" class="btn btn-primary whitespace-nowrap">ğŸ”„ åˆ·æ–°</button>
      </div>

      <!-- å†å²è®°å½•åˆ—è¡¨ -->
      <div id="sms-history-list" class="space-y-2 max-h-[55vh] overflow-y-auto">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>

      <div class="flex justify-end border-t pt-4">
        <button onclick="closeSMSHistoryModal()" class="btn btn-ghost">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- ========== éªŒè¯ç ç®¡ç†äºŒçº§æ¨¡æ€çª— ========== -->
  <div id="verification-codes-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/70" onclick="closeVerificationCodesModal()"></div>
    <div class="panel rounded-2xl p-6 w-[90%] max-w-4xl max-h-[85vh] space-y-4 relative overflow-hidden">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ğŸ”‘ éªŒè¯ç çŠ¶æ€ç®¡ç†</h3>
        <button onclick="closeVerificationCodesModal()"
          class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
      </div>

      <!-- æ·»åŠ éªŒè¯ç è¡¨å• -->
      <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
        <h5 class="font-semibold mb-3 text-green-900">â• æ‰‹åŠ¨æ·»åŠ éªŒè¯ç </h5>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">

          <div class="phone-input-wrapper">
            <span class="phone-prefix">+86 </span>
            <input type="tel" id="manual-code-phone" class="input-field" placeholder="æ‰‹æœºå·" pattern="[0-9]*"
              maxlength="11">
          </div>

          <input type="text" id="manual-code-value" class="input-field" placeholder="éªŒè¯ç ï¼ˆ6ä½æ•°å­—ï¼‰" maxlength="6"
            pattern="[0-9]{6}">
          <button onclick="addManualVerificationCode()" class="btn btn-primary">æ·»åŠ éªŒè¯ç </button>
        </div>
        <p class="text-xs text-slate-600 mt-2">ğŸ’¡ æ­¤åŠŸèƒ½ç”¨äºæµ‹è¯•æˆ–ç´§æ€¥æƒ…å†µä¸‹æ‰‹åŠ¨æ·»åŠ éªŒè¯ç ï¼Œä¸ä¼šå®é™…å‘é€çŸ­ä¿¡</p>
      </div>

      <!-- åˆ·æ–°æŒ‰é’® -->
      <div class="flex justify-end">
        <button onclick="loadVerificationCodes()" class="btn btn-ghost">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
      </div>

      <!-- å½“å‰æœ‰æ•ˆéªŒè¯ç åˆ—è¡¨ -->
      <div id="verification-codes-list" class="space-y-2 max-h-[45vh] overflow-y-auto">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>

      <div class="flex justify-end border-t pt-4">
        <button onclick="closeVerificationCodesModal()" class="btn btn-ghost">å…³é—­</button>
      </div>
    </div>
  </div>

  <div id="admin-modify-nickname-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1053]">
    <div class="absolute inset-0 bg-black/60" onclick="closeAdminModifyNicknameModal()"></div>
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ä¿®æ”¹ç”¨æˆ·æ˜µç§°</h3>
        <button onclick="closeAdminModifyNicknameModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700">ç”¨æˆ·å</label>
          <input type="text" id="admin-modify-nickname-username" class="input-field mt-1" readonly>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700">æ–°æ˜µç§°</label>
          <input type="text" id="admin-modify-nickname-new" class="input-field mt-1" placeholder="è¯·è¾“å…¥æ–°æ˜µç§° (å¯å«ä¸­æ–‡)">
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeAdminModifyNicknameModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitAdminModifyNickname()" class="btn btn-primary">ç¡®è®¤ä¿®æ”¹</button>
      </div>
    </div>
  </div>


  <!-- ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æ‰‹æœºå·çš„äºŒçº§æ¨¡æ€æ¡† -->
  <div id="admin-modify-phone-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1053]">
    <div class="absolute inset-0 bg-black/60" onclick="closeAdminModifyPhoneModal()"></div>
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ä¿®æ”¹ç”¨æˆ·æ‰‹æœºå·</h3>
        <button onclick="closeAdminModifyPhoneModal()" class="text-slate-400 hover:text-slate-600">&times;</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700">ç”¨æˆ·å</label>
          <input type="text" id="admin-modify-phone-username" class="input-field mt-1" readonly>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700">å½“å‰æ‰‹æœºå·</label>
          <!-- phone-input-wrapper: ä¸ºå½“å‰æ‰‹æœºå·æ·»åŠ +86å‰ç¼€å®¹å™¨ -->
          <div class="phone-input-wrapper mt-1">
            <!-- phone-prefix: ä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç å‰ç¼€ (+86åé¢æœ‰ç©ºæ ¼) -->
            <span class="phone-prefix">+86 </span>
            <!-- è¾“å…¥æ¡†ï¼šåªè¯»çŠ¶æ€ï¼Œç”¨äºæ˜¾ç¤ºç”¨æˆ·å½“å‰ç»‘å®šçš„æ‰‹æœºå· -->
            <input type="tel" id="admin-modify-phone-current" class="input-field" readonly>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700">æ–°æ‰‹æœºå·</label>
          <!-- phone-input-wrapper: ä¸ºæ–°æ‰‹æœºå·æ·»åŠ +86å‰ç¼€å®¹å™¨ -->
          <div class="phone-input-wrapper mt-1">
            <!-- phone-prefix: ä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç å‰ç¼€ (+86åé¢æœ‰ç©ºæ ¼) -->
            <span class="phone-prefix">+86 </span>
            <!-- è¾“å…¥æ¡†ï¼šç®¡ç†å‘˜è¾“å…¥æ–°æ‰‹æœºå· -->
            <input type="tel" id="admin-modify-phone-new" class="input-field" placeholder="è¯·è¾“å…¥æ–°æ‰‹æœºå·" inputmode="numeric"
              pattern="[0-9]*">
          </div>
        </div>

        <div id="admin-modify-phone-sms-group">
          <label class="block text-sm font-semibold text-slate-700">éªŒè¯ç ï¼ˆå¯é€‰ï¼‰</label>
          <div class="flex gap-2 mt-1">
            <input type="text" id="admin-modify-phone-code" class="input-field flex-1" placeholder="éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}">
            <button onclick="sendAdminModifyPhoneCode()" id="admin-modify-phone-send-btn"
              class="btn btn-primary whitespace-nowrap">å‘é€éªŒè¯ç </button>
          </div>
          <p class="text-xs text-slate-500 mt-1" id="admin-modify-phone-sms-hint">ç®¡ç†å‘˜ä¿®æ”¹æ‰‹æœºå·ä¸å¼ºåˆ¶è¦æ±‚éªŒè¯ç </p>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeAdminModifyPhoneModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitAdminModifyPhone()" class="btn btn-primary">ç¡®è®¤ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·æ—¥å¿—æŸ¥çœ‹çš„äºŒçº§æ¨¡æ€æ¡† -->
  <div id="user-logs-secondary-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1053]">
    <div class="absolute inset-0 bg-black/60" onclick="closeUserLogsSecondaryModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] max-h-[81vh] space-y-4 relative overflow-y-auto">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ç”¨æˆ·æ—¥å¿—æŸ¥çœ‹</h3>
        <button onclick="closeUserLogsSecondaryModal()"
          class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
      </div>

      <!-- æ˜¾ç¤ºå½“å‰æŸ¥çœ‹çš„ç”¨æˆ·å -->
      <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
        <p class="text-sm text-slate-700">
          å½“å‰æŸ¥çœ‹ç”¨æˆ·: <span id="current-log-username-secondary" class="font-semibold text-sky-600">N/A</span>
        </p>
      </div>

      <!-- Tabåˆ‡æ¢æŒ‰é’® -->
      <div class="flex border-b border-slate-200">
        <button id="log-tab-login-secondary" class="px-4 py-2 font-semibold text-sky-600 border-b-2 border-sky-600"
          onclick="switchUserLogTab('login')">
          ç™»å½•è®°å½•
        </button>
        <button id="log-tab-audit-secondary"
          class="px-4 py-2 font-semibold text-slate-400 border-b-2 border-transparent"
          onclick="switchUserLogTab('audit')">
          æ“ä½œè®°å½•
        </button>
      </div>

      <!-- ç™»å½•è®°å½•å†…å®¹åŒºåŸŸ -->
      <div id="log-login-content-secondary" class="space-y-2 max-h-[50vh] overflow-y-auto">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>

      <!-- æ“ä½œè®°å½•å†…å®¹åŒºåŸŸ -->
      <div id="log-audit-content-secondary" class="hidden space-y-2 max-h-[50vh] overflow-y-auto">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>

      <!-- å…³é—­æŒ‰é’® -->
      <div class="flex justify-end">
        <button onclick="closeUserLogsSecondaryModal()" class="btn btn-ghost">å…³é—­</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal" class="fixed inset-0 flex items-center justify-center hidden z-[50000]">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="panel rounded-2xl p-6 w-11/12 md:w-96 space-y-6 relative">
      <h3 id="confirm-modal-title" class="text-xl font-bold text-amber-600 text-center">è¯·ç¡®è®¤</h3>
      <p id="confirm-modal-message" class="text-sm text-slate-600 text-center py-4">
        ä½ ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ
      </p>
      <div class="flex justify-end gap-3 pt-4">
        <button id="confirm-modal-cancel-btn" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button id="confirm-modal-ok-btn" class="btn btn-primary">ç¡®è®¤</button>
      </div>
    </div>
  </div>



  <script>
    // (ç¡®ä¿è¿™äº›å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ handleAuthLogin å¯ä»¥è°ƒç”¨)

    /**
     * åŠ è½½ç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨åˆ—è¡¨
     */
    async function loadMobileSessionPickerList() {
      const listEl = $('mobile-session-picker-list'); // ç›®æ ‡æ˜¯ç§»åŠ¨ç«¯åˆ—è¡¨
      if (!listEl) {
        logMessage_Error("loadMobileSessionPickerList: æ— æ³•æ‰¾åˆ° 'mobile-session-picker-list' å®¹å™¨ã€‚");
        return;
      }

      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        const headers = { 'X-Session-ID': sessionUUID || null };
        const response = await fetch('/auth/user/sessions', { headers: headers });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          // åœæ­¢åŠ è½½ï¼Œä¸æ˜¾ç¤ºè®¡æ•°æˆ–åˆ—è¡¨
          return;
        }

        const sessions = result.sessions || [];

        // æ›´æ–°å…¨å±€ä¼šè¯ä¿¡æ¯ (ä¸æ¡Œé¢ç‰ˆå…±äº«)
        currentSessionInfo.maxSessions = result.max_sessions || 1;
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');
        currentSessionInfo.currentCount = validSessions.length;

        // æ›´æ–°ç§»åŠ¨ç«¯è®¡æ•°å™¨
        const countEl = $('mobile-session-picker-count-display'); // ç›®æ ‡æ˜¯ç§»åŠ¨ç«¯è®¡æ•°å™¨
        if (countEl) {
          const { currentCount, maxSessions } = currentSessionInfo;
          if (maxSessions === -1) {
            countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
          } else {
            const colorClass = currentCount >= maxSessions ? 'text-red-600' : 'text-slate-600';
            countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
          }
        }

        if (validSessions.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯ï¼Œè¯·åˆ›å»ºæ–°ä¼šè¯</p>';
          return;
        }

        // æ¸²æŸ“åˆ—è¡¨ (ä½¿ç”¨ .mobile-list-item ä¼˜åŒ–ç§»åŠ¨ç«¯è§¦æ§)
        listEl.innerHTML = validSessions.map(session => {
          const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
          const isCurrent = session.is_current || session.session_id === sessionUUID;
          const sessionHash = session.session_hash || session.session_id.substring(0, 16);

          // (æ­¤å¤„çš„ statusStyles å’Œ statusText é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œäºˆä»¥ä¿ç•™)
          const is_multi_mode = session.is_multi_account_mode;
          const session_login_success = session.login_success;

          let statusStyles = '';
          let statusText = '';

          if (is_multi_mode) {
            statusStyles = session_login_success ? 'bg-purple-100 text-purple-700' : 'bg-purple-50 text-purple-400';
            statusText = session_login_success ? 'â– å¤šè´¦å· (å·²ç™»å½•)' : 'â– å¤šè´¦å· (æœªç™»å½•)';
          } else {
            statusStyles = session_login_success ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700';
            statusText = session_login_success ? 'âœ“ å·²ç™»å½•' : 'â—‹ æœªç™»å½•';
          }

          // [ä¼˜åŒ–] æ•´ä¸ªåˆ—è¡¨é¡¹ä½œä¸ºä¸»è¦ç‚¹å‡»ç›®æ ‡ï¼Œåˆ é™¤æŒ‰é’®ä½œä¸ºæ¬¡è¦ç›®æ ‡
          return `
            <div class="mobile-list-item justify-between ${isCurrent ? 'border-2 border-sky-500 bg-sky-50' : 'bg-white'}" 
                 ${!isCurrent ? `onclick="selectSessionFromPicker('${session.session_id}')" style="cursor: pointer;"` : 'style="cursor: default;"'}
                 title="${!isCurrent ? 'ç‚¹å‡»è¿›å…¥æ­¤ä¼šè¯' : 'è¿™æ˜¯å½“å‰ä¼šè¯'}">
              
              <div class="flex-1 min-w-0 pr-3">
                <div class="flex items-center">
                  <p class="font-semibold text-slate-800 truncate" title="${session.session_id}">ä¼šè¯ ${sessionHash}...</p>
                  ${isCurrent ? '<span class="text-xs text-sky-600 ml-2 px-2 py-0.5 bg-sky-100 rounded-full flex-shrink-0">(å½“å‰)</span>' : ''}
                </div>
                <p class="text-xs text-slate-500 mt-1">${createdDate}</p>
                <p class="text-xs mt-2">
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${statusStyles}">
                    ${statusText}
                  </span>
                </p>
              </div>
              
              <div class="flex-shrink-0 flex items-center justify-center pl-2">
                ${!isCurrent ? `
                  <button class="btn btn-ghost !text-red-500 !py-3 !px-4 !rounded-lg" 
                          onclick="event.stopPropagation(); deleteSessionFromPicker('${session.session_id}');"
                          title="åˆ é™¤æ­¤ä¼šè¯">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                ` : `
                  <div class="px-4" title="è¿™æ˜¯å½“å‰ä¼šè¯">
                    <svg class="w-6 h-6 text-sky-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                  </div>
                `}
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        logMessage_Error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:", e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    /**
     * æ˜¾ç¤ºç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨
     */
    function showMobileSessionPicker() {
      const modal = $('mobile-session-picker-modal');
      if (!modal) {
        console.error("Mobile session picker modal DOM not found!");
        return;
      }

      // ç§»åŠ¨ç«¯æ¨¡æ€æ¡†ä½¿ç”¨ 'flex' æ¥å¯ç”¨ 'align-items: flex-end' (åº•éƒ¨å¼¹å‡º)
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      // ä¿®å¤ï¼šæ·»åŠ  .show ç±»ä»¥è§¦å‘ç°ä»£ç§»åŠ¨ç«¯æ¨¡æ€æ¡†çš„ 'opacity: 1' å’Œ 'transform: translateY(0)'
      // (CSSä¸­ .mobile-modal.show .mobile-modal-content å®šä¹‰äº†æ»‘å…¥åŠ¨ç”»)
      modal.classList.add('show');
      document.body.classList.add('modal-visible');

      // è‡ªåŠ¨åŠ è½½ä¼šè¯åˆ—è¡¨ (ä½¿ç”¨æ–°åˆ›å»ºçš„ç§»åŠ¨ç«¯åŠ è½½å™¨)
      loadMobileSessionPickerList();
    }

    /**
     * å…³é—­ç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨
     */
    function closeMobileSessionPicker() {
      const modal = $('mobile-session-picker-modal');
      if (!modal) return;

      // ä¿®å¤ï¼šç§»é™¤ .show ç±»ä»¥è§¦å‘å…³é—­åŠ¨ç”» (opacity: 0, transform: translateY(100%))
      // åŠ¨ç”»åœ¨ .mobile-modal-content ä¸Šå®šä¹‰ï¼Œæ—¶é•¿ 0.3s
      modal.classList.remove('show');

      // ä¿®å¤ï¼šæ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿï¼Œç­‰å¾…åŠ¨ç”»ç»“æŸåå†æ·»åŠ  'hidden' (display: none)
      // å¦åˆ™ 'hidden' ä¼šç«‹å³ç”Ÿæ•ˆï¼Œå¯¼è‡´å…³é—­åŠ¨ç”»å¤±æ•ˆ
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }, 300); // 300ms å¿…é¡»åŒ¹é… CSS transition duration

      document.body.classList.remove('modal-visible');
    }

    /**
     * åˆ·æ–°ç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨åˆ—è¡¨
     * (HTMLä¸­çš„ onclick="refreshMobileSessionPicker()" éœ€è¦æ­¤å‡½æ•°)
     */
    function refreshMobileSessionPicker() {
      loadMobileSessionPickerList();
    }
  </script>




  <!-- ä¼šè¯é€‰æ‹©æ¨¡æ€æ¡† -->
  <div id="session-picker-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1052]">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="panel rounded-2xl p-6 w-[40rem] max-h-[70vh] space-y-4 relative">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ä¼šè¯ç®¡ç†</h3>
        <div id="session-count-display" class="text-sm text-slate-600">
          <!-- ä¼šè¯è®¡æ•°å°†ç”±JSåŠ¨æ€å¡«å…… -->
        </div>
      </div>

      <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
        <p class="text-sm text-slate-700 mb-2">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
        <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          åˆ›å»ºæ–°ä¼šè¯
        </button>
      </div>

      <div class="space-y-2">
        <div class="flex justify-between items-center">
          <h4 class="font-semibold text-slate-700">ç°æœ‰ä¼šè¯</h4>
          <button class="btn btn-ghost !py-1 !px-2" onclick="refreshSessionPicker()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            åˆ·æ–°
          </button>
        </div>
        <div id="session-picker-list" class="max-h-[40vh] overflow-y-auto space-y-2">
          <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
        </div>
      </div>

      <div class="border-t pt-3 text-xs text-slate-500 relative">
        <p>ğŸ’¡ æç¤ºï¼šæ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€ã€‚æ‚¨å¯ä»¥åˆ›å»ºå¤šä¸ªä¼šè¯æ¥ç®¡ç†ä¸åŒçš„è´¦å·ã€‚</p>
      </div>
    </div>
  </div>

  <!-- åˆ›å»ºæƒé™ç»„æ¨¡æ€æ¡† -->
  <div id="create-group-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeCreateGroupModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] space-y-4 relative">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">åˆ›å»ºæƒé™ç»„</h3>
        <button onclick="closeCreateGroupModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">æƒé™ç»„é”®å</label>
          <input type="text" id="new-group-key" class="input-field w-full" placeholder="ä¾‹å¦‚: custom_group">
          <p class="text-xs text-slate-500 mt-1">è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œç”¨äºå†…éƒ¨æ ‡è¯†</p>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">æƒé™ç»„åç§°</label>
          <input type="text" id="new-group-name" class="input-field w-full" placeholder="ä¾‹å¦‚: è‡ªå®šä¹‰æƒé™ç»„">
          <p class="text-xs text-slate-500 mt-1">æ˜¾ç¤ºåç§°ï¼Œç”¨äºç•Œé¢å±•ç¤º</p>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æƒé™è®¾ç½®</label>
          <div id="create-group-permissions"
            class="grid grid-cols-2 gap-2 max-h-[40vh] overflow-y-auto border border-slate-200 rounded-lg p-3">
            <!-- æƒé™åˆ—è¡¨å°†ç”±JSåŠ¨æ€å¡«å…… -->
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeCreateGroupModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitCreateGroup()" class="btn btn-primary">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘æƒé™ç»„æƒé™æ¨¡æ€æ¡† -->
  <div id="edit-group-permissions-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeEditGroupPermissionsModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">ç¼–è¾‘æƒé™ç»„: <span id="edit-group-name"></span></h3>
        <button onclick="closeEditGroupPermissionsModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æƒé™è®¾ç½®</label>
          <div id="edit-group-permissions-list"
            class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto border border-slate-200 rounded-lg p-3">
            <!-- æƒé™åˆ—è¡¨å°†ç”±JSåŠ¨æ€å¡«å…… -->
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeEditGroupPermissionsModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitEditGroupPermissions()" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†ç”¨æˆ·æƒé™æ¨¡æ€æ¡† -->
  <div id="manage-user-permissions-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeManageUserPermissionsModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">ç®¡ç†ç”¨æˆ·æƒé™: <span id="manage-user-name"></span></h3>
        <button onclick="closeManageUserPermissionsModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <p class="text-sm text-blue-700">
          <strong>æƒé™ç»„:</strong> <span id="user-base-group" class="font-mono"></span>
        </p>
        <p class="text-xs text-slate-600 mt-1">
          ğŸ’¡ ä»¥ä¸‹ä¸ºç”¨æˆ·ç›¸å¯¹äºæƒé™ç»„çš„å·®åˆ†åŒ–æƒé™ã€‚ç»¿è‰²è¡¨ç¤ºé¢å¤–æ·»åŠ çš„æƒé™ï¼Œçº¢è‰²è¡¨ç¤ºç§»é™¤çš„æƒé™ã€‚
        </p>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æƒé™è°ƒæ•´</label>
          <div id="manage-user-permissions-list"
            class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto border border-slate-200 rounded-lg p-3">
            <!-- æƒé™åˆ—è¡¨å°†ç”±JSåŠ¨æ€å¡«å…… -->
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeManageUserPermissionsModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitManageUserPermissions()" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®ä¼šè¯é™åˆ¶æ¨¡æ€æ¡† -->
  <div id="set-max-sessions-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="hideModal('set-max-sessions-modal')"></div>
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <h3 class="text-xl font-bold text-sky-600">è®¾ç½®ä¼šè¯é™åˆ¶</h3>

      <div class="space-y-2">
        <p class="text-sm text-slate-600">ç”¨æˆ·: <span id="sessions-username" class="font-semibold text-slate-800"></span>
        </p>
        <p class="text-sm text-slate-600">å½“å‰é™åˆ¶: <span id="sessions-current-max"
            class="font-semibold text-slate-800"></span></p>
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">æ–°ä¼šè¯é™åˆ¶</label>
        <input type="number" id="new-max-sessions" min="0" class="input-field" placeholder="è¾“å…¥ä¼šè¯æ•°é‡">
        <p class="text-xs text-slate-500 mt-1">0 = æ— é™åˆ¶</p>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="hideModal('set-max-sessions-modal')" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitSetMaxSessions()" class="btn btn-primary">ç¡®è®¤</button>
      </div>
    </div>
  </div>

  <!-- é‡ç½®ç”¨æˆ·å¯†ç æ¨¡æ€æ¡† -->
  <div id="reset-user-password-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="hideModal('reset-user-password-modal')"></div>
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <h3 class="text-xl font-bold text-amber-600">é‡ç½®ç”¨æˆ·å¯†ç </h3>

      <div>
        <p class="text-sm text-slate-600">ç›®æ ‡ç”¨æˆ·: <span id="reset-password-username"
            class="font-semibold text-slate-800"></span></p>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">æ–°å¯†ç </label>
          <input type="password" id="reset-new-password" class="input-field" placeholder="è¾“å…¥æ–°å¯†ç ">
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">ç¡®è®¤å¯†ç </label>
          <input type="password" id="reset-confirm-password" class="input-field" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="hideModal('reset-user-password-modal')"
          class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitResetUserPassword()" class="btn btn-primary">é‡ç½®å¯†ç </button>
      </div>
    </div>
  </div>

  <!-- å¤´åƒè£å‰ªæ¨¡æ€æ¡† -->
  <div id="avatar-crop-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1055]">
    <div class="absolute inset-0 bg-black/80" onclick="closeCropModal()"></div>
    <div class="panel rounded-2xl p-6 max-w-2xl w-full mx-4 space-y-4 relative">
      <h3 class="text-xl font-bold text-sky-600">è£å‰ªå¤´åƒ</h3>

      <div class="max-h-96 overflow-hidden bg-slate-100 rounded-lg">
        <img id="crop-image" src="" alt="å¾…è£å‰ªå›¾ç‰‡" style="max-width: 100%;">
      </div>

      <div class="flex gap-2 justify-end">
        <button onclick="closeCropModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="confirmCropAndUpload()" class="btn btn-primary">ç¡®è®¤å¹¶ä¸Šä¼ </button>
      </div>
    </div>
  </div>

  <script>
    // ==============================================================================
    // JavaScriptä»£ç éƒ¨åˆ†
    // ==============================================================================

    // å…¨å±€å˜é‡

    let refreshUserListInterval = null;
    let isInNetworkErrorState = false; // è·Ÿè¸ªç½‘ç»œé”™è¯¯çŠ¶æ€
    let cdnErrorCount = 0;
    let cdnErrorTimer = null;
    let appInitialized = false;

    let currentUserIsGuest = false;
    let currentAuthUsername = null; // å­˜å‚¨å½“å‰ç³»ç»Ÿè®¤è¯çš„ç”¨æˆ·å
    let healthAutoRefreshInterval = null; // ç³»ç»Ÿå¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
    let avatarCropper = null; // å¤´åƒè£å‰ªå™¨å®ä¾‹
    let isRegistrationCrop = false; // æ ‡å¿—ï¼šæ˜¯å¦ä¸ºæ³¨å†Œæµç¨‹æ‰“å¼€çš„è£å‰ªå™¨
    let registrationCroppedAvatarBlob = null; // æš‚å­˜æ³¨å†Œæ—¶è£å‰ªåçš„å¤´åƒBlob
    let currentLogPage = 1; // ç”¨äºæ—¥å¿—åˆ†é¡µçš„å½“å‰é¡µç 
    let croppedAvatarFile = null; // è£å‰ªåçš„å¤´åƒæ–‡ä»¶

    // ä¼šè¯ç®¡ç†ç›¸å…³å˜é‡
    let currentSessionInfo = {
      maxSessions: 1,
      currentCount: 0
    };

    // ============================================================
    // ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹ä¸UIå®¹å™¨åˆ‡æ¢åŠŸèƒ½
    // å®ç°æ™ºèƒ½æ£€æµ‹è®¾å¤‡ç±»å‹ï¼Œè‡ªåŠ¨åˆ‡æ¢ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯UI
    // ============================================================

    // å…¨å±€å˜é‡ï¼šæ ‡è®°å½“å‰æ˜¯å¦ä¸ºç§»åŠ¨ç«¯æ¨¡å¼
    let isMobileMode = false;

    /**
     * æ£€æµ‹å½“å‰è®¾å¤‡æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼ˆæ™ºèƒ½æ‰‹æœºï¼‰
     * 
     * æ£€æµ‹é€»è¾‘ï¼š
     * 1. é€šè¿‡User-Agentæ£€æµ‹å¸¸è§ç§»åŠ¨è®¾å¤‡æ ‡è¯†
     * 2. æ£€æµ‹å±å¹•å®½åº¦æ˜¯å¦å°äºç­‰äº768px
     * 3. æ£€æµ‹æ˜¯å¦æ”¯æŒè§¦æ‘¸äº‹ä»¶
     * 
     * è¿”å›å€¼ï¼š
     * @returns {boolean} trueè¡¨ç¤ºç§»åŠ¨è®¾å¤‡ï¼Œfalseè¡¨ç¤ºæ¡Œé¢è®¾å¤‡
     */
    function detectMobileDevice() {
      // æ–¹æ³•1ï¼šé€šè¿‡User-Agentå­—ç¬¦ä¸²æ£€æµ‹
      // æ£€æµ‹å¸¸è§çš„ç§»åŠ¨è®¾å¤‡User-Agentæ ‡è¯†
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i;
      const isMobileUA = mobileRegex.test(userAgent);

      // æ–¹æ³•2ï¼šæ£€æµ‹å±å¹•å®½åº¦
      // å±å¹•å®½åº¦å°äºç­‰äº768pxè®¤ä¸ºæ˜¯ç§»åŠ¨è®¾å¤‡ï¼ˆæ ‡å‡†ç§»åŠ¨ç«¯æ–­ç‚¹ï¼‰
      const isSmallScreen = window.innerWidth <= 768;

      // æ–¹æ³•3ï¼šæ£€æµ‹è§¦æ‘¸æ”¯æŒ
      // æ£€æµ‹è®¾å¤‡æ˜¯å¦æ”¯æŒè§¦æ‘¸äº‹ä»¶ï¼ˆè§¦æ‘¸å±è®¾å¤‡ï¼‰
      const hasTouch = ('ontouchstart' in window) ||
        (navigator.maxTouchPoints > 0) ||
        (navigator.msMaxTouchPoints > 0);

      // ç»¼åˆåˆ¤æ–­ï¼šæ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶å³è§†ä¸ºç§»åŠ¨è®¾å¤‡
      // 1. User-Agentæ˜ç¡®æ˜¾ç¤ºä¸ºç§»åŠ¨è®¾å¤‡
      // 2. å°å±å¹•ä¸”æ”¯æŒè§¦æ‘¸ï¼ˆçœŸå®ç§»åŠ¨è®¾å¤‡ï¼‰
      // 3. ä»…å°å±å¹•ä¹Ÿè§†ä¸ºç§»åŠ¨è®¾å¤‡ï¼ˆå…¼å®¹æ¨¡æ‹Ÿå™¨å’Œæµ‹è¯•ç¯å¢ƒï¼‰
      const isMobile = isMobileUA || (isSmallScreen && hasTouch) || isSmallScreen;

      // æ‰“å°æ£€æµ‹ç»“æœåˆ°æ§åˆ¶å°ï¼Œä¾¿äºè°ƒè¯•
      console.log('[ç§»åŠ¨ç«¯æ£€æµ‹] User-Agentæ£€æµ‹:', isMobileUA);
      console.log('[ç§»åŠ¨ç«¯æ£€æµ‹] å±å¹•å®½åº¦:', window.innerWidth, 'px, æ˜¯å¦å°å±:', isSmallScreen);
      console.log('[ç§»åŠ¨ç«¯æ£€æµ‹] è§¦æ‘¸æ”¯æŒ:', hasTouch);
      console.log('[ç§»åŠ¨ç«¯æ£€æµ‹] æœ€ç»ˆåˆ¤å®š:', isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'æ¡Œé¢è®¾å¤‡');

      return isMobile;
    }

    /**
     * åˆ‡æ¢UIå®¹å™¨æ˜¾ç¤ºï¼ˆç§»åŠ¨ç«¯/æ¡Œé¢ç«¯ï¼‰
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * æ ¹æ®è®¾å¤‡ç±»å‹ï¼Œæ˜¾ç¤ºå¯¹åº”çš„UIå®¹å™¨ï¼Œéšè—å¦ä¸€ä¸ª
     * åŒæ—¶åˆ‡æ¢bodyçš„mobile-modeç±»ï¼Œåº”ç”¨ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼
     */
    function switchUIContainer() {
      // è·å–ç§»åŠ¨ç«¯å®¹å™¨DOMå…ƒç´ 
      const mobileContainer = document.getElementById('mobile-container');
      // è·å–æ¡Œé¢ç«¯å®¹å™¨DOMå…ƒç´ 
      const desktopContainer = document.getElementById('desktop-container');

      // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æå‰è¿”å›
      if (!mobileContainer || !desktopContainer) {
        console.warn('[UIåˆ‡æ¢] è­¦å‘Šï¼šç§»åŠ¨ç«¯æˆ–æ¡Œé¢ç«¯å®¹å™¨æœªæ‰¾åˆ°');
        return;
      }

      // è°ƒç”¨è®¾å¤‡æ£€æµ‹å‡½æ•°ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
      const isMobile = detectMobileDevice();
      // æ›´æ–°å…¨å±€å˜é‡
      isMobileMode = isMobile;

      if (isMobile) {
        // === ç§»åŠ¨ç«¯æ¨¡å¼ ===
        console.log('[UIåˆ‡æ¢] åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯æ¨¡å¼');

        // ã€éœ€æ±‚2ä¿®å¤ã€‘åœ¨éšè—æ¡Œé¢ç«¯ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥å“ªä¸ªç™»å½•å®¹å™¨å½“å‰å¯è§
        // è¿™æ ·å¯ä»¥åœ¨åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯æ—¶æ˜¾ç¤ºå¯¹åº”çš„ç§»åŠ¨ç«¯ç™»å½•å®¹å™¨
        const desktopLoginVisible = !$('login-container').classList.contains('hidden');
        const desktopAuthVisible = !$('auth-login-container').classList.contains('hidden');

        // æ˜¾ç¤ºç§»åŠ¨ç«¯å®¹å™¨
        mobileContainer.style.display = 'block';
        // éšè—æ¡Œé¢ç«¯å®¹å™¨ - ä½¿ç”¨!importantç¡®ä¿å®Œå…¨éšè—
        desktopContainer.style.setProperty('display', 'none', 'important');

        // é¢å¤–ç¡®ä¿æ‰€æœ‰æ¡Œé¢ç«¯ä¸»å®¹å™¨éƒ½è¢«éšè—
        const desktopElements = [
          'auth-login-container',
          'login-container',
          'main-app',
          'multi-account-app'
        ];
        desktopElements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.style.setProperty('display', 'none', 'important');
            el.style.setProperty('visibility', 'hidden', 'important');
            el.style.setProperty('pointer-events', 'none', 'important');
          }
        });

        // ã€éœ€æ±‚2ä¿®å¤ã€‘æ ¹æ®PCç«¯å½“å‰æ˜¾ç¤ºçš„ç™»å½•å®¹å™¨ï¼Œæ˜¾ç¤ºå¯¹åº”çš„ç§»åŠ¨ç«¯ç™»å½•å®¹å™¨
        if (desktopLoginVisible) {
          // PCç«¯æ˜¾ç¤ºlogin-containerï¼Œåˆ™ç§»åŠ¨ç«¯æ˜¾ç¤ºmobile-login-container
          $('mobile-login-container').classList.remove('hidden');
          $('mobile-auth-login-container').classList.add('hidden');
          console.log('[UIåˆ‡æ¢] PCç«¯login-containerå¯è§ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯mobile-login-container');
        } else if (desktopAuthVisible) {
          // PCç«¯æ˜¾ç¤ºauth-login-containerï¼Œåˆ™ç§»åŠ¨ç«¯æ˜¾ç¤ºmobile-auth-login-container
          $('mobile-auth-login-container').classList.remove('hidden');
          $('mobile-login-container').classList.add('hidden');
          console.log('[UIåˆ‡æ¢] PCç«¯auth-login-containerå¯è§ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯mobile-auth-login-container');
        }

        // éšè—æ‰€æœ‰å¯èƒ½å¹²æ‰°çš„æ¨¡æ€æ¡†
        const modalElements = [
          'admin-panel-modal',
          'session-picker-modal'
        ];
        modalElements.forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.classList.contains('hidden')) {
            el.classList.add('hidden');
          }
        });

        // ä¸ºbodyæ·»åŠ mobile-modeç±»ï¼Œåº”ç”¨ç§»åŠ¨ç«¯ä¸“ç”¨CSSæ ·å¼
        document.body.classList.add('mobile-mode');

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯ç‰¹å®šåŠŸèƒ½
        initializeMobileUI();
      } else {
        // === æ¡Œé¢ç«¯æ¨¡å¼ ===
        console.log('[UIåˆ‡æ¢] åˆ‡æ¢åˆ°æ¡Œé¢ç«¯æ¨¡å¼');

        // ã€éœ€æ±‚2ä¿®å¤ã€‘åœ¨éšè—ç§»åŠ¨ç«¯ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥å“ªä¸ªç™»å½•å®¹å™¨å½“å‰å¯è§
        // è¿™æ ·å¯ä»¥åœ¨åˆ‡æ¢åˆ°PCç«¯æ—¶æ˜¾ç¤ºå¯¹åº”çš„PCç«¯ç™»å½•å®¹å™¨
        const mobileLoginVisible = !$('mobile-login-container').classList.contains('hidden');
        const mobileAuthVisible = !$('mobile-auth-login-container').classList.contains('hidden');

        // éšè—ç§»åŠ¨ç«¯å®¹å™¨
        mobileContainer.style.display = 'none';
        // æ˜¾ç¤ºæ¡Œé¢ç«¯å®¹å™¨
        desktopContainer.style.display = 'block';

        // ç§»é™¤mobile-modeç±»ï¼Œæ¢å¤æ¡Œé¢ç«¯æ ·å¼
        document.body.classList.remove('mobile-mode');

        const desktopElements = [
          'auth-login-container',
          'login-container',
          'main-app',
          'multi-account-app'
        ];
        desktopElements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            // ç§»é™¤ style å±æ€§ä¸­çš„ display è®¾ç½®ï¼Œ
            // è®© CSS è§„åˆ™ï¼ˆä¾‹å¦‚ 'hidden' ç±»ï¼‰é‡æ–°æ¥ç®¡å…ƒç´ çš„æ˜¾ç¤ºçŠ¶æ€
            el.style.removeProperty('display');
            el.style.removeProperty('visibility');
            el.style.removeProperty('pointer-events');
          }
        });

        // ã€éœ€æ±‚2ä¿®å¤ã€‘æ ¹æ®ç§»åŠ¨ç«¯å½“å‰æ˜¾ç¤ºçš„ç™»å½•å®¹å™¨ï¼Œæ˜¾ç¤ºå¯¹åº”çš„PCç«¯ç™»å½•å®¹å™¨
        if (mobileLoginVisible) {
          // ç§»åŠ¨ç«¯æ˜¾ç¤ºmobile-login-containerï¼Œåˆ™PCç«¯æ˜¾ç¤ºlogin-container
          $('login-container').classList.remove('hidden');
          $('auth-login-container').classList.add('hidden');
          console.log('[UIåˆ‡æ¢] ç§»åŠ¨ç«¯mobile-login-containerå¯è§ï¼Œæ˜¾ç¤ºPCç«¯login-container');
        } else if (mobileAuthVisible) {
          // ç§»åŠ¨ç«¯æ˜¾ç¤ºmobile-auth-login-containerï¼Œåˆ™PCç«¯æ˜¾ç¤ºauth-login-container
          $('auth-login-container').classList.remove('hidden');
          $('login-container').classList.add('hidden');
          console.log('[UIåˆ‡æ¢] ç§»åŠ¨ç«¯mobile-auth-login-containerå¯è§ï¼Œæ˜¾ç¤ºPCç«¯auth-login-container');
        }


      }
    }

/**
 * æ£€æŸ¥ Session UUID æ˜¯å¦æ— æ•ˆ
 * @param {string | null | undefined} uuid
 * @returns {boolean} true è¡¨ç¤ºæ— æ•ˆ, false è¡¨ç¤ºæœ‰æ•ˆ
 */
function isSessionUUIDInvalid(uuid) {
    // å°† !uuid æ”¾åœ¨æœ€å‰é¢ï¼Œé˜²æ­¢ null.trim() é”™è¯¯
    return !uuid || uuid.trim() === '' || uuid === 'null';
}

/**
 * æ£€æŸ¥ sessionUUIDï¼Œå¦‚æœæœ‰æ•ˆï¼ˆæˆ–èƒ½ä»URLæˆåŠŸè·å–ï¼‰ï¼Œåˆ™æ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°
 * @param {Function} codeToRun - åœ¨ sessionUUID éªŒè¯é€šè¿‡åè¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°
 */
function run_code_need_sessionuuid(codeToRun) {
    
    // 1. æ£€æŸ¥å½“å‰çš„ sessionUUID
    let isInvalid = isSessionUUIDInvalid(sessionUUID);

    if (isInvalid) {
        // 2. å¦‚æœæ— æ•ˆï¼Œå°è¯•ä» URL è·å–
        logMessage_Warning('sessionUUID ä¸ºç©ºï¼Œå°è¯•ä» URL ä¸­æå–');
        sessionUUID = getUUIDFromURL(); // å‡è®¾è¿™ä¼šä¿®æ”¹å¤–éƒ¨çš„ sessionUUID å˜é‡

        // 3. å†æ¬¡æ£€æŸ¥ä» URL è·å–çš„å€¼
        isInvalid = isSessionUUIDInvalid(sessionUUID);

        if (!isInvalid) {
            logMessage_Info('æˆåŠŸä» URL ä¸­æå– sessionUUID: ' + sessionUUID);
        }
    }

    // 4. æœ€ç»ˆè£å†³
    if (isInvalid) {
        // æ— è®ºæ˜¯åˆå§‹å€¼è¿˜æ˜¯ URL çš„å€¼éƒ½æ— æ•ˆ
        logMessage_Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ sessionUUIDï¼Œæ‰€éœ€æ“ä½œæ— æ³•æ‰§è¡Œ');
    } else {
        // æœ‰æ•ˆï¼Œæ‰§è¡Œä¼ å…¥çš„å›è°ƒå‡½æ•°
        codeToRun();
    }
}

function run_code_not_need_sessionuuid(codeToRun) {
     
    // 1. æ£€æŸ¥å½“å‰çš„ sessionUUID
    let isInvalid = isSessionUUIDInvalid(sessionUUID);

    if (isInvalid) {
        // 2. å¦‚æœæ— æ•ˆï¼Œå°è¯•ä» URL è·å–
        logMessage_Warning('sessionUUID ä¸ºç©ºï¼Œå°è¯•ä» URL ä¸­æå–');
        sessionUUID = getUUIDFromURL(); // å‡è®¾è¿™ä¼šä¿®æ”¹å¤–éƒ¨çš„ sessionUUID å˜é‡

        // 3. å†æ¬¡æ£€æŸ¥ä» URL è·å–çš„å€¼
        isInvalid = isSessionUUIDInvalid(sessionUUID);

        if (!isInvalid) {
            logMessage_Success('æˆåŠŸä» URL ä¸­æå– sessionUUID: ' + sessionUUID);
        }
    }

    // 4. æœ€ç»ˆè£å†³
    if (isInvalid) {
        // æ— è®ºæ˜¯åˆå§‹å€¼è¿˜æ˜¯ URL çš„å€¼éƒ½æ— æ•ˆ
        logMessage_Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ sessionUUIDï¼Œæ‰€éœ€æ“ä½œæ— æ³•æ‰§è¡Œ');
        codeToRun();
    }
        
}


    /**
     * åˆå§‹åŒ–ç§»åŠ¨ç«¯UIåŠŸèƒ½ (å·²é‡æ„)
     * * ä¸ºç§»åŠ¨ç«¯UIå…ƒç´ ç»‘å®šäº‹ä»¶å¤„ç†å™¨å’Œäº¤äº’é€»è¾‘
     * é€šè¿‡â€œä»£ç†æ¨¡å¼â€å¤ç”¨æ¡Œé¢ç«¯çš„ `handleAuthLogin` ç­‰æ ¸å¿ƒå‡½æ•°
     */
    function initializeMobileUI() {
      console.log('[ç§»åŠ¨ç«¯UI] åˆå§‹åŒ–ç§»åŠ¨ç«¯UIåŠŸèƒ½ (é‡æ„ç‰ˆ)');

      // === 1. Helper function for tab switching ===
      function showMobileAuthForm(formToShow) {
        // Get all elements
        const loginTab = document.getElementById('mobile-auth-tab-login');
        const registerTab = document.getElementById('mobile-auth-tab-register');
        const loginForm = document.getElementById('mobile-login-form');
        const registerForm = document.getElementById('mobile-register-form');
        const tfaForm = document.getElementById('mobile-auth-2fa-form');

        // Hide all forms
        if (loginForm) loginForm.classList.add('hidden');
        if (registerForm) registerForm.classList.add('hidden');
        if (tfaForm) tfaForm.classList.add('hidden');

        if (formToShow === 'register') {
          if (registerForm) registerForm.classList.remove('hidden');
          // Update Tab styles
          if (loginTab) loginTab.className = 'flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition';
          if (registerTab) registerTab.className = 'flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition';
        } else { // Default to login
          if (loginForm) loginForm.classList.remove('hidden');
          // Update Tab styles
          if (loginTab) loginTab.className = 'flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition';
          if (registerTab) registerTab.className = 'flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition';
        }

        // Clear messages
        showMobileMessage('', 'clear');
      }

      // === 2. Bind Tab buttons ===
      const loginTabBtn = document.getElementById('mobile-auth-tab-login');
      const registerTabBtn = document.getElementById('mobile-auth-tab-register');
      if (loginTabBtn) loginTabBtn.addEventListener('click', () => showMobileAuthForm('login'));
      if (registerTabBtn) registerTabBtn.addEventListener('click', () => showMobileAuthForm('register'));

      // === 3. Bind Login Type (User/Phone) toggle ===
      const mobileUsernameBtn = document.getElementById('mobile-login-username-btn');
      const mobilePhoneBtn = document.getElementById('mobile-login-phone-btn');
      const mobileAuthInputContainer = document.getElementById('mobile-username-container');
      const mobileAuthLabel = document.getElementById('mobile-login-label');
      const mobileSwitchToSms = document.getElementById('mobile-switch-to-sms');

      if (mobileUsernameBtn && mobilePhoneBtn && mobileAuthInputContainer && mobileAuthLabel && mobileSwitchToSms) {
        mobileUsernameBtn.addEventListener('click', function () {
          mobileUsernameBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          mobilePhoneBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          const currentValue = mobileAuthInputContainer.querySelector('input').value;
          mobileAuthLabel.textContent = 'ç”¨æˆ·å';
          // ç§»é™¤ +86 å®¹å™¨
          mobileAuthInputContainer.innerHTML = `
            <input type="text" id="mobile-auth-username" class="w-full" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username" value="${currentValue || ''}">
          `;
          mobileSwitchToSms.classList.add('hidden');
          // ç¡®ä¿å¯†ç åŒºæ˜¾ç¤ºï¼ŒçŸ­ä¿¡åŒºéšè—
          document.getElementById('mobile-password-section').classList.remove('hidden');
          document.getElementById('mobile-sms-section').classList.add('hidden');
        });

        mobilePhoneBtn.addEventListener('click', function () {
          mobilePhoneBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          mobileUsernameBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          const currentValue = mobileAuthInputContainer.querySelector('input').value;
          mobileAuthLabel.textContent = 'æ‰‹æœºå·';
          // æ·»åŠ  +86 å®¹å™¨
          mobileAuthInputContainer.innerHTML = `
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+86 </span>
              <input type="tel" id="mobile-auth-username" class="input-field" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel" inputmode="numeric" maxlength="11" value="${currentValue || ''}">
            </div>
          `;
          mobileSwitchToSms.classList.remove('hidden');
        });
      }

      // === 4. Bind Password/SMS toggle ===
      const mobileSwitchToSmsBtn = document.getElementById('mobile-switch-to-sms');
      const mobileSwitchToPassBtn = document.getElementById('mobile-switch-to-password');
      const mobilePassSection = document.getElementById('mobile-password-section');
      const mobileSmsSection = document.getElementById('mobile-sms-section');

      if (mobileSwitchToSmsBtn) mobileSwitchToSmsBtn.addEventListener('click', () => {
        if (mobilePassSection) mobilePassSection.classList.add('hidden');
        if (mobileSmsSection) mobileSmsSection.classList.remove('hidden');
      });
      if (mobileSwitchToPassBtn) mobileSwitchToPassBtn.addEventListener('click', () => {
        if (mobileSmsSection) mobileSmsSection.classList.add('hidden');
        if (mobilePassSection) mobilePassSection.classList.remove('hidden');
      });

      // === 5. Bind "Send Code" buttons (Proxy to desktop logic) ===
      // ä»£ç†æ¨¡å¼ï¼šå°†å€¼å¤åˆ¶åˆ°éšè—çš„æ¡Œé¢è¾“å…¥æ¡†ï¼Œç„¶åè§¦å‘æ¡Œé¢æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶

      const mobileSendLoginCodeBtn = document.getElementById('mobile-auth-send-login-code');
      if (mobileSendLoginCodeBtn) {
        // ä¿®å¤ï¼šä¸å†ä½¿ç”¨ .click() ä»£ç†ï¼Œè€Œæ˜¯å¤åˆ¶æ¡Œé¢æŒ‰é’®çš„å®Œæ•´é€»è¾‘
        mobileSendLoginCodeBtn.addEventListener('click', async function () {
          // 1. ä½¿ç”¨ç§»åŠ¨ç«¯IDè·å–æ‰‹æœºå·
          const phone = document.getElementById('mobile-auth-username').value;
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showMobileMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error');
            return;
          }

          // 2. å¤åˆ¶æ¡Œé¢æŒ‰é’®çš„åŠ è½½å’Œå€’è®¡æ—¶é€»è¾‘ (ä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®ID)
          mobileSendLoginCodeBtn.disabled = true;
          const originalText = mobileSendLoginCodeBtn.textContent;

          try {
            // 3. ç›´æ¥è°ƒç”¨API (åŒæ¡Œé¢æŒ‰é’®é€»è¾‘)
            const response = await fetch('/api/sms/send_code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                phone: phone,
                scene: 'login' // åœºæ™¯ï¼šç™»å½•
              })
            });
            const result = await response.json();

            if (result && result.success) {
              const expireMin = result.expire_minutes || 5;
              const retryAfter = result.retry_after || 180;
              // ä¿®å¤ï¼šä½¿ç”¨ showMobileMessage æˆ– showTempMessage
              showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

              // 4. å€’è®¡æ—¶ (ä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®ID)
              let countdown = retryAfter;
              const timer = setInterval(() => {
                countdown--;
                mobileSendLoginCodeBtn.textContent = countdown + 'ç§’';
                if (countdown <= 0) {
                  clearInterval(timer);
                  mobileSendLoginCodeBtn.disabled = false;
                  mobileSendLoginCodeBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              // 5. å¤„ç†å¤±è´¥å’Œé‡è¯• (ä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®ID)
              if (result?.retry_after) {
                const retrySeconds = result.retry_after;
                let countdown = retrySeconds;
                mobileSendLoginCodeBtn.textContent = countdown + 'ç§’';
                const timer = setInterval(() => {
                  countdown--;
                  mobileSendLoginCodeBtn.textContent = countdown + 'ç§’';
                  if (countdown <= 0) {
                    clearInterval(timer);
                    mobileSendLoginCodeBtn.disabled = false;
                    mobileSendLoginCodeBtn.textContent = originalText;
                  }
                }, 1000);
              } else {
                mobileSendLoginCodeBtn.disabled = false;
              }
              showMobileMessage(result?.message || 'å‘é€å¤±è´¥', 'error');
            }
          } catch (error) {
            mobileSendLoginCodeBtn.disabled = false;
            showMobileMessage('å‘é€å¤±è´¥: ' + error.message, 'error');
          }
        });
      }

      const mobileSendRegCodeBtn = document.getElementById('mobile-reg-send-code-btn');
      if (mobileSendRegCodeBtn) {
        // ä¿®å¤ï¼šä¸å†ä½¿ç”¨ .click() ä»£ç†ï¼Œè€Œæ˜¯å¤åˆ¶æ¡Œé¢æŒ‰é’®çš„å®Œæ•´é€»è¾‘
        mobileSendRegCodeBtn.addEventListener('click', async function () {
          // 1. ä½¿ç”¨ç§»åŠ¨ç«¯IDè·å–æ‰‹æœºå·
          const phone = document.getElementById('mobile-reg-phone').value;
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showMobileMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error');
            return;
          }

          // 2. å¤åˆ¶æ¡Œé¢æŒ‰é’®çš„åŠ è½½å’Œå€’è®¡æ—¶é€»è¾‘ (ä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®ID)
          mobileSendRegCodeBtn.disabled = true;
          const originalText = mobileSendRegCodeBtn.textContent;

          try {
            // 3. ç›´æ¥è°ƒç”¨API (åŒæ¡Œé¢æŒ‰é’®é€»è¾‘)
            const response = await fetch('/api/sms/send_code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                phone: phone,
                scene: 'register' // åœºæ™¯ï¼šæ³¨å†Œ
              })
            });
            const result = await response.json();

            if (result && result.success) {
              const expireMin = result.expire_minutes || 5;
              const retryAfter = result.retry_after || 180;
              // ä¿®å¤ï¼šä½¿ç”¨ showMobileMessage æˆ– showTempMessage
              showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

              // 4. å€’è®¡æ—¶ (ä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®ID)
              let countdown = retryAfter;
              const timer = setInterval(() => {
                countdown--;
                mobileSendRegCodeBtn.textContent = `${countdown}ç§’`;
                if (countdown <= 0) {
                  clearInterval(timer);
                  mobileSendRegCodeBtn.disabled = false;
                  mobileSendRegCodeBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              // 5. å¤„ç†å¤±è´¥å’Œé‡è¯• (ä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®ID)
              if (result?.retry_after) {
                const retrySeconds = result.retry_after;
                let countdown = retrySeconds;
                mobileSendRegCodeBtn.textContent = `${countdown}ç§’`;
                const timer = setInterval(() => {
                  countdown--;
                  mobileSendRegCodeBtn.textContent = `${countdown}ç§’`;
                  if (countdown <= 0) {
                    clearInterval(timer);
                    mobileSendRegCodeBtn.disabled = false;
                    mobileSendRegCodeBtn.textContent = originalText;
                  }
                }, 1000);
              } else {
                mobileSendRegCodeBtn.disabled = false;
              }
              showMobileMessage(result?.message || 'å‘é€å¤±è´¥', 'error');
            }
          } catch (error) {
            mobileSendRegCodeBtn.disabled = false;
            showMobileMessage('å‘é€å¤±è´¥: ' + error.message, 'error');
          }
        });
      }

      // === 6. Bind Main Action Buttons (Login, Register, Guest, 2FA) ===
      // ä»£ç†æ¨¡å¼ï¼šå¤åˆ¶æ‰€æœ‰å€¼ï¼Œç„¶åè°ƒç”¨æ¡Œé¢ç«¯çš„

      // --- Mobile Login ---
      const mobileLoginBtn = document.getElementById('mobile-login-btn');
      if (mobileLoginBtn) mobileLoginBtn.addEventListener('click', async () => {
        // ä¿®å¤2ï¼šä¸ºç§»åŠ¨ç«¯æŒ‰é’®æ·»åŠ åŠ è½½çŠ¶æ€
        setButtonLoading('mobile-login-btn', true, 'ç™»å½•ä¸­...');

        try {
          // 1. å¤åˆ¶æ‰€æœ‰ç›¸å…³å€¼åˆ°éšè—çš„æ¡Œé¢å­—æ®µ
          document.getElementById('auth-username').value = document.getElementById('mobile-auth-username').value;
          document.getElementById('auth-password').value = document.getElementById('mobile-auth-password').value;
          document.getElementById('auth-sms-code').value = document.getElementById('mobile-auth-sms-code').value;

          // 2. åŒæ­¥æ¡Œé¢UIçš„ *çŠ¶æ€* (è¿™å¯¹ handleAuthLogin çš„å†…éƒ¨é€»è¾‘è‡³å…³é‡è¦)
          if (!document.getElementById('mobile-password-section').classList.contains('hidden')) {
            // ç§»åŠ¨ç«¯å¤„äºå¯†ç æ¨¡å¼ -> åŒæ­¥æ¡Œé¢
            document.getElementById('auth-password-section').classList.remove('hidden');
            document.getElementById('auth-sms-section').classList.add('hidden');
          } else {
            // ç§»åŠ¨ç«¯å¤„äºçŸ­ä¿¡æ¨¡å¼ -> åŒæ­¥æ¡Œé¢
            document.getElementById('auth-password-section').classList.add('hidden');
            document.getElementById('auth-sms-section').classList.remove('hidden');
          }

          if (!document.getElementById('mobile-login-phone-btn').classList.contains('text-slate-600')) {
            // ç§»åŠ¨ç«¯å¤„äºæ‰‹æœºæ¨¡å¼ -> åŒæ­¥æ¡Œé¢
            // (æˆ‘ä»¬ä¸éœ€è¦çœŸçš„ç‚¹å‡»æŒ‰é’®ï¼Œåªéœ€è¦æ¨¡æ‹ŸçŠ¶æ€)
            document.getElementById('auth-login-phone-btn').classList.add('font-semibold');
          } else {
            // ç§»åŠ¨ç«¯å¤„äºç”¨æˆ·æ¨¡å¼ -> åŒæ­¥æ¡Œé¢
            document.getElementById('auth-login-phone-btn').classList.remove('font-semibold');
          }

          // 3. è°ƒç”¨åŸå§‹çš„æ¡Œé¢å¤„ç†å‡½æ•°
          await handleAuthLogin();

          // 4. å¦‚æœ handleAuthLogin æˆåŠŸ (æ²¡æœ‰æŠ›å‡ºé”™è¯¯)
          // æ£€æŸ¥ 2FA çŠ¶æ€æ˜¯å¦è¢«æ¿€æ´»
          const tfaForm = document.getElementById('auth-2fa-form');
          if (tfaForm && !tfaForm.classList.contains('hidden')) {
            // 2FA æµç¨‹å·²å¯åŠ¨
            // ä¿®å¤ï¼šç¡®ä¿ç§»åŠ¨ç«¯ 2FA è¡¨å•ä¹Ÿæ˜¾ç¤º
            document.getElementById('mobile-login-form').classList.add('hidden');
            document.getElementById('mobile-auth-2fa-form').classList.remove('hidden');
            document.getElementById('mobile-2fa-code').value = '';
            document.getElementById('mobile-2fa-code').focus();
            showMobileMessage('å¯†ç éªŒè¯æˆåŠŸï¼Œè¯·è¾“å…¥éªŒè¯ç ', 'success');

            // ä¿®å¤2ï¼šæ¸…é™¤ç§»åŠ¨æŒ‰é’®çš„åŠ è½½çŠ¶æ€
            setButtonLoading('mobile-login-btn', false);

          } else {
            // çœŸæ­£çš„ç™»å½•æˆåŠŸï¼ˆé 2FAï¼‰
            // æ¡Œé¢ç«¯çš„ showButtonSuccess å·²ç»è¢«è°ƒç”¨äº†ï¼Œæˆ‘ä»¬ä¹Ÿè°ƒç”¨ç§»åŠ¨ç«¯çš„
            showButtonSuccess('mobile-login-btn', 'ç™»å½•æˆåŠŸ', 800);
            // (åç»­çš„è·³è½¬é€»è¾‘åœ¨ handleAuthLogin å†…éƒ¨)
          }

        } catch (e) {
          // 5. æ•è· handleAuthLogin æŠ›å‡ºçš„é”™è¯¯
          console.error("ä»£ç†[ç™»å½•]å¤±è´¥:", e);
          // ä¿®å¤2ï¼šä½¿ç”¨ e.message æ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯
          showMobileMessage(e.message || 'ç™»å½•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
          // ä¿®å¤2ï¼šåœ¨ç§»åŠ¨ç«¯æŒ‰é’®ä¸Šæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          showButtonError('mobile-login-btn', 'ç™»å½•å¤±è´¥');

        } finally {
          // 6. æ— è®ºå¦‚ä½•ï¼Œæœ€åéƒ½è¦æ¸…é™¤åŠ è½½çŠ¶æ€ (å¦‚æœ2FAæˆ–æˆåŠŸï¼Œå®ƒä»¬å†…éƒ¨å·²å¤„ç†ï¼›è¿™é‡Œæ˜¯é’ˆå¯¹é”™è¯¯çš„å…œåº•)
          // æ£€æŸ¥ 2FA çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ 2FA æµç¨‹ï¼Œåˆ™æ¸…é™¤åŠ è½½
          const tfaForm = document.getElementById('auth-2fa-form');
          if (!tfaForm || tfaForm.classList.contains('hidden')) {
            // (ç¡®ä¿åœ¨ finally å—ä¸­ä¹Ÿæ¸…é™¤æ¡Œé¢æŒ‰é’®çš„çŠ¶æ€ï¼Œä»¥é˜² handleAuthLogin å¼‚å¸¸é€€å‡º)
            setButtonLoading('auth-login-btn', false);
            setButtonLoading('mobile-login-btn', false);
          }
        }
      });

      // --- Mobile Register ---
      const mobileRegisterBtn = document.getElementById('mobile-register-btn');
      if (mobileRegisterBtn) mobileRegisterBtn.addEventListener('click', async () => {
        try {
          // 1. å¤åˆ¶æ‰€æœ‰å€¼
          document.getElementById('auth-reg-username').value = document.getElementById('mobile-reg-username').value;
          document.getElementById('auth-reg-phone').value = document.getElementById('mobile-reg-phone').value;
          document.getElementById('auth-reg-sms-code').value = document.getElementById('mobile-reg-sms-code').value;
          document.getElementById('auth-reg-nickname').value = document.getElementById('mobile-reg-nickname').value;
          document.getElementById('auth-reg-password').value = document.getElementById('mobile-reg-password').value;
          document.getElementById('auth-reg-password-confirm').value = document.getElementById('mobile-reg-password-confirm').value;

          // 2. å¤´åƒ Blob (registrationCroppedAvatarBlob) æ˜¯å…¨å±€å˜é‡ï¼Œæ— éœ€å¤åˆ¶

          // 3. è°ƒç”¨åŸå§‹å‡½æ•°
          await handleAuthRegister();
        } catch (e) {
          console.error("ä»£ç†[æ³¨å†Œ]å¤±è´¥:", e);
          showMobileMessage('æ³¨å†Œæ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
        }
      });

      // --- Mobile Guest ---
      const mobileGuestBtn = document.getElementById('mobile-guest-btn');
      if (mobileGuestBtn) mobileGuestBtn.addEventListener('click', async () => {
        try {
          await handleGuestLogin();
        } catch (e) {
          console.error("ä»£ç†[æ¸¸å®¢ç™»å½•]å¤±è´¥:", e);
          showMobileMessage('æ¸¸å®¢ç™»å½•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
        }
      });

      // --- Mobile 2FA Verify ---
      const mobile2faBtn = document.getElementById('mobile-2fa-submit-btn');
      if (mobile2faBtn) mobile2faBtn.addEventListener('click', async () => {
        try {
          document.getElementById('auth-2fa-code').value = document.getElementById('mobile-2fa-code').value;
          await handle2FAVerify();
        } catch (e) {
          console.error("ä»£ç†[2FAéªŒè¯]å¤±è´¥:", e);
          showMobileMessage('2FAéªŒè¯æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
        }
      });

      // --- Mobile 2FA Back Button ---
      const mobile2faBackBtn = document.getElementById('mobile-2fa-back-btn');
      if (mobile2faBackBtn) mobile2faBackBtn.addEventListener('click', () => {
        showMobileAuthForm('login');
        // åŒæ—¶è§¦å‘æ¡Œé¢ç«¯çš„è¿”å›ï¼Œä»¥é‡ç½®å…¶å†…éƒ¨çŠ¶æ€
        try {
          document.getElementById('auth-2fa-back-btn').click();
        } catch (e) { }
      });

      // === 7. Bind Avatar Upload ===
      const mobileAvatarInput = document.getElementById('mobile-reg-avatar');
      if (mobileAvatarInput) {
        // åŸå§‹å‡½æ•° `previewAvatarForRegistration` ä»…ä¾èµ– eventï¼Œ
        // å¹¶ä¸”ä¼šæ­£ç¡®è®¾ç½®å…¨å±€ `registrationCroppedAvatarBlob` å˜é‡ï¼Œ
        // `handleAuthRegister` (åœ¨æ­¥éª¤6ä¸­)ä¼šè¯»å–è¯¥å˜é‡ã€‚
        // å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°é‡ç”¨å®ƒã€‚
        mobileAvatarInput.addEventListener('change', previewAvatarForRegistration);
      }

      // === 8. Check for Guest Login availability ===
      // (æ­¤åŠŸèƒ½ä¾èµ–äºæ¡Œé¢ç«¯çš„ checkGuestLoginEnabled() )
      const mobileGuestSection = document.getElementById('mobile-guest-login-section');
      if (mobileGuestSection) {
        // æˆ‘ä»¬å‡è®¾æ¡Œé¢ç«¯çš„ checkGuestLoginEnabled() å·²ç»è¿è¡Œ
        // å¹¶ä¸”å·²ç»æ­£ç¡®è®¾ç½®äº†æ¡Œé¢ç«¯ #guest-login-section çš„å¯è§æ€§
        const desktopGuestSection = document.getElementById('guest-login-section');
        if (desktopGuestSection && !desktopGuestSection.classList.contains('hidden')) {
          mobileGuestSection.classList.remove('hidden');
          console.log('[ç§»åŠ¨ç«¯UI] æ¸¸å®¢ç™»å½•å·²å¯ç”¨');
        } else {
          mobileGuestSection.classList.add('hidden');
          console.log('[ç§»åŠ¨ç«¯UI] æ¸¸å®¢ç™»å½•å·²ç¦ç”¨');
        }
      }

      // === 9. ç»‘å®šç§»åŠ¨ç«¯å•è´¦å·ï¼ˆå­¦æ ¡ï¼‰ç™»å½•æŒ‰é’® ===
      const mobileSingleLoginBtn = document.getElementById('mobile-single-login-btn');
      if (mobileSingleLoginBtn) {
        mobileSingleLoginBtn.addEventListener('click', async function () {
          // ä»£ç†æ¨¡å¼ï¼šå¤åˆ¶å€¼åˆ°æ¡Œé¢ç«¯è¾“å…¥æ¡†
          try {
            const username = document.getElementById('mobile-username-entry').value.trim();
            const password = document.getElementById('mobile-password-entry').value;

            if (!username || !password) {
              showMobileMessage('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
              return;
            }

            document.getElementById('username-entry').value = username;
            document.getElementById('password-entry').value = password;

            console.log('[ç§»åŠ¨ç«¯UI] è§¦å‘å•è´¦å·ï¼ˆå­¦æ ¡ï¼‰ç™»å½•...');

            // è°ƒç”¨æ¡Œé¢ç«¯çš„ onLogin å‡½æ•°
            await onLogin();

            // onLogin æˆåŠŸåï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯ä¸»åº”ç”¨ç•Œé¢
            if (isMobileMode) {
              // éšè—æ¡Œé¢ç«¯çš„main-app
              const desktopMainApp = document.getElementById('main-app');
              if (desktopMainApp && !desktopMainApp.classList.contains('hidden')) {
                desktopMainApp.classList.add('hidden');
                desktopMainApp.classList.remove('grid');
              }

              // éšè—ç™»å½•å®¹å™¨
              document.getElementById('mobile-login-container').classList.add('hidden');

              // æ˜¾ç¤ºç§»åŠ¨ç«¯ä¸»åº”ç”¨
              const mobileMainApp = document.getElementById('mobile-main-app');
              if (mobileMainApp) {
                mobileMainApp.classList.remove('hidden');
                console.log('[ç§»åŠ¨ç«¯UI] å·²æ˜¾ç¤º mobile-main-app');
                // åˆå§‹åŒ–é¢æ¿æ˜¾ç¤ºï¼šé»˜è®¤æ˜¾ç¤ºä»»åŠ¡é¢æ¿
                switchMobilePanel('mobile-task-panel', 'single');
              }

              // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªå’Œèœå•æŒ‰é’® - å•è´¦å·æ¨¡å¼
              updateMobileNavVisibility(true, 'single');

              // åˆ·æ–°ç§»åŠ¨ç«¯é€šçŸ¥
              if (typeof mobileRefreshNotifications === 'function') {
                await mobileRefreshNotifications();
              }
            }
          } catch (e) {
            console.error("ä»£ç†[å­¦æ ¡ç™»å½•]å¤±è´¥:", e);
            showMobileMessage('å­¦æ ¡ç™»å½•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
          }
        });
      }

      // === 9.5. ç»‘å®šç§»åŠ¨ç«¯ç”¨æˆ·ä¸‹æ‹‰æ¡†changeäº‹ä»¶ ===
      const mobileUserCombo = document.getElementById('mobile-user-combo');
      if (mobileUserCombo) {
        mobileUserCombo.addEventListener('change', onMobileUserChange);
      }

      // === 9.6. ç»‘å®šç§»åŠ¨ç«¯ç”¨æˆ·åè¾“å…¥æ¡†ï¼Œå®ç°ä¸ä¸‹æ‹‰æ¡†çš„è”åŠ¨ ===
      const mobileUsernameEntry = document.getElementById('mobile-username-entry');
      if (mobileUsernameEntry && mobileUserCombo) {
        mobileUsernameEntry.addEventListener('input', async function () {
          const username = this.value.trim();
          // æ£€æŸ¥ä¸‹æ‹‰æ¡†ä¸­æ˜¯å¦æœ‰æ­¤ç”¨æˆ·
          const exists = [...mobileUserCombo.options].some(o => o.value === username);
          mobileUserCombo.value = exists ? username : "";

          // æ¸…ç©ºå¯†ç 
          const mobilePasswordEntry = document.getElementById('mobile-password-entry');
          if (mobilePasswordEntry) mobilePasswordEntry.value = '';

          // å¦‚æœç”¨æˆ·å­˜åœ¨ï¼ŒåŠ è½½å…¶å¯†ç 
          if (exists && username) {
            try {
              const data = await callPythonAPI('on_user_selected', username);
              if (data && data.password && mobilePasswordEntry) {
                mobilePasswordEntry.value = data.password;
              }
            } catch (error) {
              console.error('[Mobile] è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
          }
        });
      }

      // === 10. ç»‘å®šç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  ===
      const navButtons = document.querySelectorAll('.mobile-nav-btn');
      navButtons.forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          navButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const navTarget = this.getAttribute('data-nav');
          console.log('[ç§»åŠ¨ç«¯UI] åˆ‡æ¢å¯¼èˆªåˆ°:', navTarget);
          // (æ­¤å¤„æ·»åŠ é¡µé¢åˆ‡æ¢é€»è¾‘...)
        });
      });

      // === 11. ç»‘å®šç§»åŠ¨ç«¯èœå•æŒ‰é’® ===
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function () {
          console.log('[ç§»åŠ¨ç«¯UI] èœå•æŒ‰é’®ç‚¹å‡»');
          // TODO: æ˜¾ç¤ºç§»åŠ¨ç«¯èœå•ï¼ˆä¸ªäººèµ„æ–™ã€è®¾ç½®ç­‰ï¼‰
          showModalAlert('èœå•åŠŸèƒ½å¼€å‘ä¸­...', 'æç¤º');
        });
      }

      // === 12. ç»‘å®šç§»åŠ¨ç«¯å¤šè´¦å·æ¨¡å¼æŒ‰é’® ===
      const mobileMultiAccountBtn = document.getElementById('mobile-multi-account-btn');
      if (mobileMultiAccountBtn) {
        mobileMultiAccountBtn.addEventListener('click', function () {
          console.log('[ç§»åŠ¨ç«¯UI] å¤šè´¦å·æ¨¡å¼æŒ‰é’®ç‚¹å‡»');
          // éšè—ç™»å½•å®¹å™¨ï¼Œæ˜¾ç¤ºå¤šè´¦å·åº”ç”¨
          const mobileLoginContainer = document.getElementById('mobile-login-container');
          const mobileMultiApp = document.getElementById('mobile-multi-account-app');
          if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
          if (mobileMultiApp) {
            mobileMultiApp.classList.remove('hidden');
            // åˆå§‹åŒ–é¢æ¿æ˜¾ç¤ºï¼šé»˜è®¤æ˜¾ç¤ºè´¦å·åˆ—è¡¨é¢æ¿
            switchMobilePanel('mobile-multi-account-panel', 'multi');
          }
          // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªå’Œèœå•æŒ‰é’® - å¤šè´¦å·æ¨¡å¼
          updateMobileNavVisibility(true, 'multi');
        });
      }

      // === ç»‘å®šç§»åŠ¨ç«¯ä¼šè¯åˆ·æ–°æŒ‰é’® ===
      const mobileRefreshSessionsBtn = document.getElementById('mobile-refresh-sessions-btn');
      if (mobileRefreshSessionsBtn) {
        mobileRefreshSessionsBtn.addEventListener('click', async function () {
          console.log('[ç§»åŠ¨ç«¯UI] åˆ·æ–°ä¼šè¯åˆ—è¡¨');
          await loadMobileSessionsList();
        });
      }

      run_code_need_sessionuuid( () => {
          // è¿™é‡Œçš„ä»£ç åªä¼šåœ¨ sessionUUID æœ‰æ•ˆæ—¶æ‰æ‰§è¡Œ
          loadMobileUserCombo().catch(e => {
              console.error('[Mobile UI] ç§»åŠ¨ç«¯ç”¨æˆ·ä¸‹æ‹‰æ¡†åå°åŠ è½½å¤±è´¥:', e);
          });
      });


      console.log('[ç§»åŠ¨ç«¯UI] ç§»åŠ¨ç«¯UIåˆå§‹åŒ–å®Œæˆ');
    }

    /**
     * åŠ è½½ç§»åŠ¨ç«¯ä¼šè¯åˆ—è¡¨ï¼ˆmobile-login-containerä¸­çš„sessions listï¼‰
     * è¿™ä¸ªå‡½æ•°ç”¨äºå¡«å…… mobile-sessions-list å®¹å™¨
     */
    async function loadMobileSessionsList() {
      const listEl = document.getElementById('mobile-sessions-list');
      const countEl = document.getElementById('mobile-session-count-display');

      if (!listEl) {
        console.error('[Mobile] æ‰¾ä¸åˆ° mobile-sessions-list å…ƒç´ ');
        return;
      }

      listEl.innerHTML = '<p class="text-slate-400 text-center py-8">åŠ è½½ä¸­...</p>';

      try {
        const headers = { 'X-Session-ID': sessionUUID || null };
        const response = await fetch('/auth/user/sessions', { headers: headers });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-8">${result.message}</p>`;
          return;
        }

        const sessions = result.sessions || [];
        const validSessions = sessions.filter(session =>
          session.session_id && session.session_id !== 'null' && session.session_id.trim() !== ''
        );

        // æ›´æ–°ä¼šè¯è®¡æ•°
        if (countEl) {
          const maxSessions = result.max_sessions || 1;
          const currentCount = validSessions.length;
          if (maxSessions === -1) {
            countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
          } else {
            const colorClass = currentCount >= maxSessions ? 'text-red-600' : 'text-slate-600';
            countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
          }
        }

        if (validSessions.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-8">æš‚æ— ä¼šè¯</p>';
          return;
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
        listEl.innerHTML = validSessions.map(session => {
          const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
          const isCurrent = session.is_current || session.session_id === sessionUUID;
          const sessionHash = session.session_hash || session.session_id.substring(0, 16);

          return `
            <div class="mobile-list-item ${isCurrent ? 'border-l-4 border-sky-500 bg-sky-50' : ''}" 
                 onclick="switchToSession('${session.session_id}')">
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${sessionHash}</span>
                  ${isCurrent ? '<span class="text-xs px-2 py-1 rounded-full bg-sky-500 text-white">å½“å‰</span>' : ''}
                </div>
                <p class="text-xs text-slate-600">åˆ›å»º: ${createdDate}</p>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('[Mobile] åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
        listEl.innerHTML = '<p class="text-red-500 text-center py-8">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
      }
    }
    /**
     * ä»å½“å‰æµè§ˆå™¨ç½‘å€ (window.location.pathname) ä¸­æå– UUID v4ã€‚
     * * @returns {string | null} æå–åˆ°çš„ UUID å­—ç¬¦ä¸²ï¼Œå¦‚æœæœªæ‰¾åˆ°æˆ–æ ¼å¼ä¸æ­£ç¡®åˆ™è¿”å› nullã€‚
     */
    function getUUIDFromURL() {
      const urlPath = window.location.pathname;

      // è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼åŸºäºæ‚¨ index.html (çº¦ 11117 è¡Œ) ä¸­çš„å®ç°
      // å®ƒä¸“é—¨æŸ¥æ‰¾ "/uuid=" åé¢è·Ÿç€çš„ä¸€ä¸ªæ ‡å‡† UUID v4
      // 1. [a-f0-9]{8}-[a-f0-9]{4} - åŒ¹é…å‰ä¸¤ç»„
      // 2. -4[a-f0-9]{3}            - åŒ¹é…ç¬¬ä¸‰ç»„ï¼Œç¡®ä¿å®ƒä»¥ '4' å¼€å¤´ (UUID v4)
      // 3. -[89ab][a-f0-9]{3}       - åŒ¹é…ç¬¬å››ç»„ï¼Œç¡®ä¿å®ƒä»¥ 8, 9, a, æˆ– b å¼€å¤´ (UUID v4 å˜ä½“)
      // 4. -[a-f0-9]{12}           - åŒ¹é…æœ€åä¸€ç»„
      // ( ... ) æ˜¯ä¸€ä¸ªæ•è·ç»„ï¼Œç”¨äºæå– UUID æœ¬èº«
      // i ä½¿å…¶ä¸åŒºåˆ†å¤§å°å†™
      const match = urlPath.match(/\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i);

      if (match && match[1]) {
        // match[0] æ˜¯å®Œæ•´åŒ¹é… (ä¾‹å¦‚: "/uuid=780de...")
        // match[1] æ˜¯æˆ‘ä»¬æ•è·çš„ UUID (ä¾‹å¦‚: "780de...")
        return match[1];
      } else {
        // æœªåœ¨è·¯å¾„ä¸­æ‰¾åˆ° "/uuid=" æˆ– UUID æ ¼å¼ä¸æ­£ç¡®
        return null;
      }
    }

    /**
     * åŠ è½½ç§»åŠ¨ç«¯ç”¨æˆ·ä¸‹æ‹‰æ¡†ï¼ˆmobile-user-comboï¼‰
     * ä»åç«¯è·å–æ‰€æœ‰ç”¨æˆ·å¹¶å¡«å……åˆ°ä¸‹æ‹‰æ¡†
     */
    async function loadMobileUserCombo() {
      if(
      run_code_not_need_sessionuuid( () => {
        //å¦‚æœæ²¡æœ‰ sessionUUIDï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡ŒloadMobileUserCombo
        console.warn('[Mobile UI] sessionUUID æ— æ•ˆï¼Œè·³è¿‡åŠ è½½ç”¨æˆ·ä¸‹æ‹‰æ¡†');
        return false
      }) === false){
        return;
      }
      const mobileUserCombo = document.getElementById('mobile-user-combo');
      if (!mobileUserCombo) {
        // console.error('[Mobile] æ‰¾ä¸åˆ° mobile-user-combo å…ƒç´ ');
        logMessage_Error('[Mobile] æ‰¾ä¸åˆ° mobile-user-combo å…ƒç´ ');
        return;
      }

      try {
        const initialData = await callPythonAPI('get_initial_data');

        // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
        mobileUserCombo.innerHTML = '<option value="">(æ–°ç”¨æˆ·)</option>';

        if (initialData.users && initialData.users.length > 0) {
          initialData.users.forEach(user => {
            const option = document.createElement('option');
            option.value = option.textContent = user;
            mobileUserCombo.appendChild(option);
          });
        }

        // è®¾ç½®ä¸Šæ¬¡é€‰æ‹©çš„ç”¨æˆ·
        if (initialData.lastUser) {
          mobileUserCombo.value = initialData.lastUser;
          // è§¦å‘ç”¨æˆ·é€‰æ‹©äº‹ä»¶ä»¥åŠ è½½å¯¹åº”æ•°æ®
          await onMobileUserChange();
        }

        console.log('[Mobile] ç”¨æˆ·ä¸‹æ‹‰æ¡†å·²åŠ è½½');
      } catch (error) {
        console.error('[Mobile] åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
      }

    }

    /**
     * ç§»åŠ¨ç«¯ç”¨æˆ·ä¸‹æ‹‰æ¡†changeäº‹ä»¶å¤„ç†
     */
    async function onMobileUserChange() {
      const mobileUserCombo = document.getElementById('mobile-user-combo');
      const mobileUsernameEntry = document.getElementById('mobile-username-entry');
      const mobilePasswordEntry = document.getElementById('mobile-password-entry');

      if (!mobileUserCombo) return;

      const username = mobileUserCombo.value;

      // åŒæ­¥ç”¨æˆ·ååˆ°è¾“å…¥æ¡†
      if (mobileUsernameEntry) {
        mobileUsernameEntry.value = username;
      }

      // æ¸…ç©ºå¯†ç 
      if (mobilePasswordEntry) {
        mobilePasswordEntry.value = '';
      }

      if (username) {
        try {
          const data = await callPythonAPI('on_user_selected', username);
          if (data && data.password && mobilePasswordEntry) {
            mobilePasswordEntry.value = data.password;
          }
        } catch (error) {
          console.error('[Mobile] è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        }
      }
    }

    /**
     * æ›´æ–°ç§»åŠ¨ç«¯å¯¼èˆªæ å’Œèœå•æŒ‰é’®çš„æ˜¾ç¤º/éšè—çŠ¶æ€
     * @param {boolean} show - trueæ˜¾ç¤ºï¼Œfalseéšè—
     * @param {string} mode - 'single' æˆ– 'multi'ï¼ŒæŒ‡å®šæ˜¾ç¤ºå“ªä¸ªå¯¼èˆªæ 
     */
    function updateMobileNavVisibility(show, mode = 'single') {
      const mobileBottomNavSingle = document.getElementById('mobile-bottom-nav-single-account');
      const mobileBottomNavMulti = document.getElementById('mobile-bottom-nav-multi-account');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileHeader = document.getElementById('mobile-header');

      if (show) {
        // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„å¯¼èˆªæ 
        if (mode === 'single' && mobileBottomNavSingle) {
          mobileBottomNavSingle.classList.remove('hidden');
          mobileBottomNavSingle.style.display = '';
        }
        if (mode === 'multi' && mobileBottomNavMulti) {
          mobileBottomNavMulti.classList.remove('hidden');
          mobileBottomNavMulti.style.display = '';
        }
        if (mobileMenuBtn) {
          mobileMenuBtn.style.display = '';
        }
        if (mobileHeader) {
          mobileHeader.classList.remove('hidden');
          mobileHeader.style.display = '';
        }
      } else {
        // éšè—æ‰€æœ‰å¯¼èˆªæ 
        if (mobileBottomNavSingle) {
          mobileBottomNavSingle.classList.add('hidden');
          mobileBottomNavSingle.style.display = 'none';
        }
        if (mobileBottomNavMulti) {
          mobileBottomNavMulti.classList.add('hidden');
          mobileBottomNavMulti.style.display = 'none';
        }
        if (mobileMenuBtn) {
          mobileMenuBtn.style.display = 'none';
        }
        // æ³¨æ„ï¼šheaderä»ç„¶æ˜¾ç¤ºï¼Œåªéšè—èœå•æŒ‰é’®
      }
    }

    /**
     * æ˜¾ç¤ºç§»åŠ¨ç«¯æ¶ˆæ¯æç¤º (å·²ä¿®æ”¹)
     * * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯å†…å®¹
     * @param {string} type - æ¶ˆæ¯ç±»å‹ï¼š'error', 'success', 'info', 'clear'
     */
    function showMobileMessage(message, type = 'info') {
      // è·å–é”™è¯¯æ¶ˆæ¯å®¹å™¨
      const errorDiv = document.getElementById('mobile-auth-error');
      // è·å–æˆåŠŸæ¶ˆæ¯å®¹å™¨
      const successDiv = document.getElementById('mobile-auth-success');

      // (æ–°) æ·»åŠ  'clear' ç±»å‹ç”¨äºéšè—æ‰€æœ‰æ¶ˆæ¯
      if (type === 'clear') {
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        return;
      }

      // å…ˆéšè—æ‰€æœ‰æ¶ˆæ¯å®¹å™¨
      if (errorDiv) errorDiv.classList.add('hidden');
      if (successDiv) successDiv.classList.add('hidden');

      // æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å®¹å™¨
      if (type === 'error') {
        if (errorDiv) {
          errorDiv.textContent = message; // è®¾ç½®æ¶ˆæ¯æ–‡æœ¬
          errorDiv.classList.remove('hidden'); // æ˜¾ç¤ºé”™è¯¯å®¹å™¨
        }
      } else if (type === 'success') {
        if (successDiv) {
          successDiv.textContent = message; // è®¾ç½®æ¶ˆæ¯æ–‡æœ¬
          successDiv.classList.remove('hidden'); // æ˜¾ç¤ºæˆåŠŸå®¹å™¨
        }
      } else {
        // 'info'ç±»å‹ï¼šä½¿ç”¨æµè§ˆå™¨åŸç”Ÿalertï¼ˆå¯åç»­æ”¹ä¸ºè‡ªå®šä¹‰Toastï¼‰
        // (åœ¨è®¤è¯æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿ç”¨ showModalAlert)
        showModalAlert(message, 'æç¤º');
      }

      // (ç§»é™¤è‡ªåŠ¨éšè—ï¼Œå› ä¸º showModalAlert ä¼šæ¥ç®¡)
    }
    /**
     * å¤„ç†çª—å£å¤§å°å˜åŒ–äº‹ä»¶
     * 
     * å½“ç”¨æˆ·è°ƒæ•´æµè§ˆå™¨çª—å£å¤§å°æˆ–æ—‹è½¬æ‰‹æœºå±å¹•æ—¶ï¼Œé‡æ–°æ£€æµ‹è®¾å¤‡ç±»å‹
     * ä½¿ç”¨é˜²æŠ–æŠ€æœ¯ï¼Œé¿å…é¢‘ç¹è§¦å‘åˆ‡æ¢
     */
    let resizeTimer = null; // é˜²æŠ–å®šæ—¶å™¨
    function handleResize() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (resizeTimer) {
        clearTimeout(resizeTimer);
      }

      // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼š300æ¯«ç§’åæ‰§è¡Œåˆ‡æ¢
      // è¿™æ ·å¯ä»¥é¿å…åœ¨è°ƒæ•´çª—å£å¤§å°è¿‡ç¨‹ä¸­é¢‘ç¹åˆ‡æ¢UI
      resizeTimer = setTimeout(function () {
        console.log('[çª—å£è°ƒæ•´] æ£€æµ‹åˆ°çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°æ£€æµ‹è®¾å¤‡ç±»å‹');
        // ä¿®å¤ï¼šåœ¨åˆ‡æ¢å‰ï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰ä¼šè¯æ¨¡æ€æ¡†å¤„äºæ‰“å¼€çŠ¶æ€
        const desktopModal = $('session-picker-modal');
        const mobileModal = $('mobile-session-picker-modal');

        const wasDesktopModalOpen = desktopModal && !desktopModal.classList.contains('hidden');
        const wasMobileModalOpen = mobileModal && !mobileModal.classList.contains('hidden');

        // å£°æ˜ isModalSwap å˜é‡ ---
        let isModalSwap = false;

        // å…³é”®ä¿®å¤ï¼šæ£€æµ‹æ–°çš„è®¾å¤‡æ¨¡å¼ï¼ˆåœ¨è°ƒç”¨ switchUIContainer ä¹‹å‰ï¼‰
        const willBeMobileMode = detectMobileDevice();

        // å…³é”®ä¿®å¤ï¼šåœ¨ switchUIContainer() ä¹‹å‰ï¼Œæ ¹æ®æ¨¡æ€æ¡†çŠ¶æ€å…ˆéšè—ç™»å½•ç•Œé¢
        // è¿™æ ·å¯ä»¥é˜²æ­¢ switchUIContainer() æ˜¾ç¤ºç§»åŠ¨ç«¯å®¹å™¨æ—¶ï¼Œç™»å½•ç•Œé¢çŸ­æš‚å¯è§
        if (willBeMobileMode && wasDesktopModalOpen) {
          // åœºæ™¯ï¼šä»æ¡Œé¢åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯ï¼Œä¸”æ¡Œé¢æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„
          console.log('[çª—å£è°ƒæ•´] æ­£åœ¨ä»æ¡Œé¢ä¼šè¯é€‰æ‹©å™¨åˆ‡æ¢åˆ°ç§»åŠ¨ç‰ˆ...');

          // æ­¥éª¤1ï¼šè®¾ç½® isModalSwap æ ‡è®°ï¼Œè¡¨ç¤ºéœ€è¦åˆ‡æ¢æ¨¡æ€æ¡†
          isModalSwap = true;

          console.log('[çª—å£è°ƒæ•´-FIX] æ­¥éª¤1ï¼šæ ‡è®°æ¨¡æ€æ¡†éœ€è¦åˆ‡æ¢');

        } else if (!willBeMobileMode && wasMobileModalOpen) {
          // åœºæ™¯ï¼šä»ç§»åŠ¨ç«¯åˆ‡æ¢åˆ°æ¡Œé¢ï¼Œä¸”ç§»åŠ¨æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„
          console.log('[çª—å£è°ƒæ•´] æ­£åœ¨ä»ç§»åŠ¨ä¼šè¯é€‰æ‹©å™¨åˆ‡æ¢åˆ°æ¡Œé¢ç‰ˆ...');

          // æ­¥éª¤1ï¼šè®¾ç½® isModalSwap æ ‡è®°ï¼Œè¡¨ç¤ºéœ€è¦åˆ‡æ¢æ¨¡æ€æ¡†
          isModalSwap = true;

          console.log('[çª—å£è°ƒæ•´-FIX] æ­¥éª¤1ï¼šæ ‡è®°æ¨¡æ€æ¡†éœ€è¦åˆ‡æ¢');
        }

        // æ­¥éª¤2ï¼šé‡æ–°æ‰§è¡ŒUIå®¹å™¨åˆ‡æ¢ (è¿™ä¼šæ›´æ–°å…¨å±€å˜é‡ isMobileMode)
        // æ³¨æ„ï¼šæ­¤æ—¶ç™»å½•ç•Œé¢å·²ç»è¢«éšè—ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
        switchUIContainer();

        // æ­¥éª¤3ï¼šæ ¹æ®æ–°çš„ isMobileMode çŠ¶æ€ï¼Œå…³é—­æ—§çš„æ¨¡æ€æ¡†å¹¶æ‰“å¼€æ–°çš„æ¨¡æ€æ¡†
        if (isModalSwap) {
          if (isMobileMode) {
            // å…³é—­æ¡Œé¢ç‰ˆå¹¶æ‰“å¼€ç§»åŠ¨ç‰ˆä¼šè¯é€‰æ‹©å™¨
            closeSessionPicker(); // å…³é—­æ¡Œé¢ç‰ˆ

            // å…³é”®ä¿®å¤ï¼šåœ¨æ˜¾ç¤ºç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨ä¹‹å‰ï¼Œç¡®ä¿ç™»å½•å®¹å™¨ä¸å¯è§
            // è™½ç„¶ä¾èµ–z-indexç†è®ºä¸Šåº”è¯¥è¶³å¤Ÿï¼Œä½†å®è·µä¸­å‘ç°éœ€è¦æ˜¾å¼éšè—
            const mobileLogin = $('mobile-login-container');
            const mobileAuth = $('mobile-auth-login-container');
            if (mobileLogin && !mobileLogin.classList.contains('hidden')) {
              mobileLogin.classList.add('hidden');
            }
            if (mobileAuth && !mobileAuth.classList.contains('hidden')) {
              mobileAuth.classList.add('hidden');
            }

            showMobileSessionPicker(); // æ‰“å¼€ç§»åŠ¨ç‰ˆ
            console.log('[çª—å£è°ƒæ•´-FIX] æ­¥éª¤2-3ï¼šåˆ‡æ¢UIå®¹å™¨å¹¶æ˜¾ç¤ºç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨');
          } else {
            // å…³é—­ç§»åŠ¨ç‰ˆå¹¶æ‰“å¼€æ¡Œé¢ç‰ˆä¼šè¯é€‰æ‹©å™¨
            closeMobileSessionPicker(); // å…³é—­ç§»åŠ¨ç‰ˆ

            // å…³é”®ä¿®å¤ï¼šåœ¨æ˜¾ç¤ºæ¡Œé¢ä¼šè¯é€‰æ‹©å™¨ä¹‹å‰ï¼Œç¡®ä¿ç™»å½•å®¹å™¨ä¸å¯è§
            const desktopLogin = $('login-container');
            const desktopAuth = $('auth-login-container');
            if (desktopLogin && !desktopLogin.classList.contains('hidden')) {
              desktopLogin.classList.add('hidden');
            }
            if (desktopAuth && !desktopAuth.classList.contains('hidden')) {
              desktopAuth.classList.add('hidden');
            }

            showSessionPicker(); // æ‰“å¼€æ¡Œé¢ç‰ˆ
            console.log('[çª—å£è°ƒæ•´-FIX] æ­¥éª¤2-3ï¼šåˆ‡æ¢UIå®¹å™¨å¹¶æ˜¾ç¤ºæ¡Œé¢ä¼šè¯é€‰æ‹©å™¨');
          }
        }
      }, 300); // é˜²æŠ–å»¶è¿Ÿï¼š300æ¯«ç§’
    }



    // ============================================================
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
    // ============================================================

    /**
     * åœ¨DOMå†…å®¹åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
     * è¿™æ˜¯æ•´ä¸ªç§»åŠ¨ç«¯UIåˆ‡æ¢åŠŸèƒ½çš„å…¥å£ç‚¹
     */
    document.addEventListener('DOMContentLoaded', function () {
      console.log('[é¡µé¢åŠ è½½] DOMå†…å®¹å·²åŠ è½½ï¼Œå¼€å§‹æ‰§è¡Œè®¾å¤‡æ£€æµ‹å’ŒUIåˆ‡æ¢');

      // æ‰§è¡Œé¦–æ¬¡UIå®¹å™¨åˆ‡æ¢
      switchUIContainer();

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–äº‹ä»¶
      // å½“ç”¨æˆ·è°ƒæ•´çª—å£æˆ–æ—‹è½¬å±å¹•æ—¶ï¼Œè‡ªåŠ¨é‡æ–°æ£€æµ‹å’Œåˆ‡æ¢
      window.addEventListener('resize', handleResize);

      // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–äº‹ä»¶ï¼ˆä¸»è¦é’ˆå¯¹ç§»åŠ¨è®¾å¤‡ï¼‰
      // å½“æ‰‹æœºä»ç«–å±åˆ‡æ¢åˆ°æ¨ªå±ï¼ˆæˆ–åä¹‹ï¼‰æ—¶è§¦å‘
      window.addEventListener('orientationchange', function () {
        console.log('[å±å¹•æ–¹å‘] æ£€æµ‹åˆ°å±å¹•æ–¹å‘å˜åŒ–');
        // å»¶è¿Ÿ100æ¯«ç§’åé‡æ–°æ£€æµ‹ï¼ˆç­‰å¾…æ–¹å‘å˜åŒ–å®Œæˆï¼‰
        setTimeout(function () {
          switchUIContainer();
        }, 100);
      });

      // ç›‘å¬åª’ä½“æŸ¥è¯¢å˜åŒ–ï¼ˆç”¨äºæµè§ˆå™¨è®¾å¤‡ä»¿çœŸï¼‰
      // å½“æµè§ˆå™¨çš„è®¾å¤‡ä»¿çœŸåˆ‡æ¢æ—¶ï¼ŒmatchMedia å¯ä»¥æ£€æµ‹åˆ°è§†å£å˜åŒ–
      // è¿™æ¯” resize äº‹ä»¶æ›´å¯é ï¼Œå› ä¸ºè®¾å¤‡ä»¿çœŸä¸æ€»æ˜¯è§¦å‘ resize
      const mobileMediaQuery = window.matchMedia('(max-width: 768px)');

      // å®šä¹‰åª’ä½“æŸ¥è¯¢å˜åŒ–å¤„ç†å‡½æ•°
      function handleMediaQueryChange(e) {
        console.log('[åª’ä½“æŸ¥è¯¢] æ£€æµ‹åˆ°è§†å£å®½åº¦å˜åŒ–ï¼Œå½“å‰æ˜¯å¦ä¸ºç§»åŠ¨ç«¯:', e.matches);
        // è°ƒç”¨ handleResize æ¥å¤„ç†æ¨¡æ€æ¡†åˆ‡æ¢
        handleResize();
      }

      // æ·»åŠ ç›‘å¬å™¨ - å…¼å®¹æ–°æ—§API
      if (mobileMediaQuery.addEventListener) {
        // ç°ä»£æµè§ˆå™¨ä½¿ç”¨ addEventListener
        mobileMediaQuery.addEventListener('change', handleMediaQueryChange);
      } else {
        // æ—§ç‰ˆæµè§ˆå™¨ä½¿ç”¨ addListener
        mobileMediaQuery.addListener(handleMediaQueryChange);
      }

      console.log('[é¡µé¢åŠ è½½] ç§»åŠ¨ç«¯æ£€æµ‹å’Œåˆ‡æ¢åŠŸèƒ½å·²å¯åŠ¨');
    });

    // ============================================================
    // ç»“æŸï¼šç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹ä¸UIå®¹å™¨åˆ‡æ¢åŠŸèƒ½
    // ============================================================


    function handleCdnError() {
      cdnErrorCount++;
      logMessage_Warning(`CDNèµ„æºåŠ è½½å¤±è´¥ (${cdnErrorCount}/3)ï¼Œç­‰å¾…åº”ç”¨åˆå§‹åŒ–...`);

      // ä¼˜åŒ–ï¼šä¸ç«‹å³æ˜¾ç¤ºé”™è¯¯ï¼Œè€Œæ˜¯å»¶è¿Ÿæ£€æŸ¥
      // å¦‚æœ3ç§’ååº”ç”¨ä»æœªåˆå§‹åŒ–ï¼Œä¸”æœ‰CDNé”™è¯¯ï¼Œåˆ™æ˜¾ç¤ºé”™è¯¯æç¤º
      if (cdnErrorTimer) {
        clearTimeout(cdnErrorTimer);
      }

      cdnErrorTimer = setTimeout(() => {
        // åªæœ‰åœ¨åº”ç”¨æœªæˆåŠŸåˆå§‹åŒ–æ—¶æ‰æ˜¾ç¤ºé”™è¯¯
        if (!appInitialized && cdnErrorCount > 0) {
          const errorOverlay = document.getElementById('cdn-error-overlay');
          if (errorOverlay) {
            // ä½¿ç”¨ç›´æ¥ DOM æ“ä½œç¡®ä¿è¦†ç›–å±‚å¯è§ã€‚
            // æ³¨æ„ï¼šæ­¤å¤„ä¸èƒ½ä¾èµ– $ å¿«æ·å‡½æ•°ï¼Œå› ä¸º handleCdnError å¯èƒ½åœ¨ $ å®šä¹‰ä¹‹å‰è¢«è°ƒç”¨ã€‚
            try {
              errorOverlay.style.setProperty('display', 'flex', 'important');
            } catch (e) {
              // æŸäº›ç¯å¢ƒä¸‹ setProperty çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯èƒ½ä¸å¯ç”¨ï¼Œå›é€€åˆ°ç›´æ¥è®¾ç½®
              errorOverlay.style.display = 'flex';
            }
            // ç§»é™¤ hidden ç±»ä»¥ç¡®ä¿å¯è§
            errorOverlay.classList.remove('hidden');
            logMessage_Error(`åº”ç”¨åˆå§‹åŒ–è¶…æ—¶ï¼ŒCDNèµ„æºåŠ è½½å¤±è´¥ (${cdnErrorCount}ä¸ªèµ„æº)`);
          }
        }
      }, 3000); // å»¶è¿Ÿ3ç§’æ˜¾ç¤ºé”™è¯¯ï¼Œç»™åº”ç”¨åˆå§‹åŒ–æœºä¼š
    }


    function showModalAlert(message, title = 'æç¤º', onCloseCallback = null) {
      const modal = $('alert-modal');
      const titleEl = $('alert-modal-title');
      const msgEl = $('alert-modal-message');
      const closeBtn = $('alert-modal-close-btn');

      if (!modal || !titleEl || !msgEl || !closeBtn) {
        // æ¨¡æ€æ¡†DOMä¸å­˜åœ¨ï¼Œå›é€€åˆ°åŸç”Ÿ alert
        logMessage_Warning('Alert modal DOM not found, falling back to native alert.');
        alert(`${title}:\n${message}`);
        if (onCloseCallback) onCloseCallback();
        return;
      }

      titleEl.textContent = title;
      // æ›¿æ¢ \n ä¸º <br> ä»¥æ”¯æŒæ¢è¡Œ
      msgEl.innerHTML = String(message).replace(/\n/g, '<br>');

      // æ ¹æ®æ ‡é¢˜è®¾ç½®é¢œè‰²
      if (title.includes('å¤±è´¥') || title.includes('é”™è¯¯')) {
        titleEl.classList.remove('text-sky-600');
        titleEl.classList.add('text-red-600');
      } else {
        titleEl.classList.remove('text-red-600');
        titleEl.classList.add('text-sky-600');
      }

      closeBtn.onclick = () => {
        closeModalAlert();
        if (onCloseCallback) onCloseCallback();
      };

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-visible'); // éšè—åœ°å›¾ç‰ˆæƒ
    }

    function closeModalAlert() {
      const modal = $('alert-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ¨¡æ€æ¡†å¯è§
      const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
      let stillVisible = false;
      otherModals.forEach(m => {
        if (m.id !== 'alert-modal' && !m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
          stillVisible = true;
        }
      });
      if (!stillVisible) {
        document.body.classList.remove('modal-visible');
      }
    }

    function showModal(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('modal-visible');
      }
    }

    function hideModal(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ¨¡æ€æ¡†å¯è§
      const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
      let stillVisible = false;
      otherModals.forEach(m => {
        if (!m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
          stillVisible = true;
        }
      });
      if (!stillVisible) {
        document.body.classList.remove('modal-visible');
      }
    }

    // --- é€šç”¨ç¡®è®¤æ¨¡æ€æ¡† (ä¿®å¤ Bug 2) ---
    let resolveConfirmPromise = null;

    function jsShowConfirm(title, message) {
      // è¿”å›ä¸€ä¸ª Promise
      return new Promise((resolve) => {
        const modal = $('confirm-modal');
        const titleEl = $('confirm-modal-title');
        const msgEl = $('confirm-modal-message');
        const okBtn = $('confirm-modal-ok-btn');
        const cancelBtn = $('confirm-modal-cancel-btn');

        if (!modal || !titleEl || !msgEl || !okBtn || !cancelBtn) {
          logMessage_Error('Confirm modal DOM not found. Falling back to native confirm.');
          // å›é€€åˆ°åŸç”Ÿ confirmï¼Œå®ƒä¹Ÿä¼šé˜»å¡å¹¶è¿”å›å€¼
          resolve(confirm(`${title}:\n${message}`));
          return;
        }

        // ä¿å­˜ resolve å‡½æ•°ï¼Œä»¥ä¾¿æŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨
        resolveConfirmPromise = resolve;

        titleEl.textContent = title || 'è¯·ç¡®è®¤';
        msgEl.innerHTML = String(message).replace(/\n/g, '<br>');

        // ç§»é™¤æ—§ç›‘å¬å™¨ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
        okBtn.onclick = null;
        cancelBtn.onclick = null;

        // ç»‘å®šæ–°ç›‘å¬å™¨
        okBtn.onclick = () => handleConfirm(true);
        cancelBtn.onclick = () => handleConfirm(false);

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('modal-visible');
      });
    }

    function handleConfirm(result) {
      const modal = $('confirm-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ¨¡æ€æ¡†å¯è§ (ä½¿ç”¨ä¸ closeModalAlert ç›¸åŒçš„é€»è¾‘)
      const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
      let stillVisible = false;
      otherModals.forEach(m => {
        if (m.id !== 'confirm-modal' && !m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
          stillVisible = true;
        }
      });
      if (!stillVisible) {
        document.body.classList.remove('modal-visible');
      }

      // è§£æ Promise
      if (resolveConfirmPromise) {
        resolveConfirmPromise(result);
        resolveConfirmPromise = null; // æ¸…ç†
      }
    }




    let AMAP_API_KEY = ""; // å…¨å±€API Keyå˜é‡
    let isRefreshingNotifications = false; // é€šçŸ¥åˆ·æ–°çš„â€œin-flightâ€æ ‡å¿—

    let isRefreshingTasks = false;


    // ç¦»çº¿æ¨¡å¼æ ‡å¿—
    let IS_OFFLINE = false;
    let sessionUUID = null;  // å½“å‰ä¼šè¯UUID

    function getUUIDFromURL() {
      const urlPath = window.location.pathname;

      // è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼åŸºäºæ‚¨ index.html (çº¦ 11117 è¡Œ) ä¸­çš„å®ç°
      // å®ƒä¸“é—¨æŸ¥æ‰¾ "/uuid=" åé¢è·Ÿç€çš„ä¸€ä¸ªæ ‡å‡† UUID v4
      // 1. [a-f0-9]{8}-[a-f0-9]{4} - åŒ¹é…å‰ä¸¤ç»„
      // 2. -4[a-f0-9]{3}            - åŒ¹é…ç¬¬ä¸‰ç»„ï¼Œç¡®ä¿å®ƒä»¥ '4' å¼€å¤´ (UUID v4)
      // 3. -[89ab][a-f0-9]{3}       - åŒ¹é…ç¬¬å››ç»„ï¼Œç¡®ä¿å®ƒä»¥ 8, 9, a, æˆ– b å¼€å¤´ (UUID v4 å˜ä½“)
      // 4. -[a-f0-9]{12}           - åŒ¹é…æœ€åä¸€ç»„
      // ( ... ) æ˜¯ä¸€ä¸ªæ•è·ç»„ï¼Œç”¨äºæå– UUID æœ¬èº«
      // i ä½¿å…¶ä¸åŒºåˆ†å¤§å°å†™
      const match = urlPath.match(/\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i);

      if (match && match[1]) {
        // match[0] æ˜¯å®Œæ•´åŒ¹é… (ä¾‹å¦‚: "/uuid=780de...")
        // match[1] æ˜¯æˆ‘ä»¬æ•è·çš„ UUID (ä¾‹å¦‚: "780de...")
        return match[1];
      } else {
        // æœªåœ¨è·¯å¾„ä¸­æ‰¾åˆ° "/uuid=" æˆ– UUID æ ¼å¼ä¸æ­£ç¡®
        return null;
      }
    }

    // ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°
    async function callPythonAPI(method, ...args) {
      logMessage_Info(`[APIè°ƒç”¨] æ–¹æ³•: ${method}, å‚æ•°æ•°é‡: ${args.length}`);
      // Webæ¨¡å¼ï¼šé€šè¿‡HTTPåè®®è°ƒç”¨åç«¯APIæ¥å£ï¼Œè¯·æ±‚å¤´ä¸­æºå¸¦ä¼šè¯UUIDæ ‡è¯†
      const headers = {
        'Content-Type': 'application/json',
      };

      // æ·»åŠ ä¼šè¯UUIDåˆ°è¯·æ±‚å¤´
      if (sessionUUID) {
        headers['X-Session-ID'] = sessionUUID;
        logMessage_Info(`[APIè°ƒç”¨] ä¼šè¯ID: ${sessionUUID}`);
      } else {
        // å¦‚æœè¿ sessionUUID éƒ½æ²¡æœ‰ï¼ˆç†è®ºä¸Šä¸åº”åœ¨å·²åŠ è½½é¡µé¢åå‘ç”Ÿï¼‰ï¼Œä¹Ÿå¯èƒ½æ„å‘³ç€ä¼šè¯é—®é¢˜
        logMessage_Warning(`[APIè°ƒç”¨] è­¦å‘Š: sessionUUIDä¸ºç©ºï¼Œå¯èƒ½å¯¼è‡´ä¼šè¯æ— æ•ˆé”™è¯¯ï¼Œå°è¯•ä»URLæå–...`);
        sessionUUID = getUUIDFromURL();
        if (sessionUUID || sessionUUID !== null || sessionUUID !== undefined || sessionUUID !== 'null') {
          logMessage_Info(`[APIè°ƒç”¨] ä»URLæå–åˆ°ä¼šè¯ID: ${sessionUUID}`);
          headers['X-Session-ID'] = sessionUUID;
        } else {
          logMessage_Warning(`[APIè°ƒç”¨] æ— æ³•ä»URLæå–ä¼šè¯ID`);
        }
      }

      logMessage_Info(`[APIè°ƒç”¨] å‘é€è¯·æ±‚åˆ° /api/${method}`);
      let response; // å°† response ç§»åˆ° try å¤–éƒ¨
      try { // åŒ…è£¹ fetch è°ƒç”¨
        response = await fetch(`/api/${method}`, {
          method: 'POST',
          headers: headers,
          credentials: 'include',  // é‡è¦ï¼šåŒ…å«cookies
          body: JSON.stringify(args.length === 1 && typeof args[0] === 'object' && args[0] !== null && !Array.isArray(args[0]) ? args[0] : args)
        });
      } catch (networkError) {
        // æ•è· fetch æœ¬èº«çš„ç½‘ç»œé”™è¯¯ (ä¾‹å¦‚ DNS è§£æå¤±è´¥ã€æœåŠ¡å™¨æ— æ³•è¿æ¥)
        logMessage_Error(`[APIè°ƒç”¨] âœ— ç½‘ç»œè¯·æ±‚å¤±è´¥ (${method}):`, networkError);

        // è¿›å…¥ç½‘ç»œé”™è¯¯çŠ¶æ€ï¼ˆå³ä½¿å®šæ—¶å™¨å·²ç»è¢«åœæ­¢ä¹Ÿè¦è®¾ç½®æ ‡å¿—ï¼‰
        if (!isInNetworkErrorState) {
          isInNetworkErrorState = true; // æ ‡è®°è¿›å…¥ç½‘ç»œé”™è¯¯çŠ¶æ€
          logMessage_Info('[APIè°ƒç”¨] è¿›å…¥ç½‘ç»œé”™è¯¯çŠ¶æ€ï¼Œåœæ­¢åç«¯æ—¥å¿—å‘é€å’ŒWebSocket');

          // åœæ­¢å¯èƒ½çš„åˆ·æ–°å®šæ—¶å™¨
          if (refreshUserListInterval) {
            logMessage_Info('[APIè°ƒç”¨] åœæ­¢ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨ (å› ç½‘ç»œé”™è¯¯)');
            clearInterval(refreshUserListInterval);
            refreshUserListInterval = null;
          }

          // æ–­å¼€WebSocketè¿æ¥å¹¶ç¦ç”¨è‡ªåŠ¨é‡è¿ï¼Œé¿å…æŒç»­çš„è¿æ¥é”™è¯¯
          if (socket) {
            if (socket.io) {
              socket.io.opts.reconnection = false;  // ç¦ç”¨è‡ªåŠ¨é‡è¿
            }
            if (socket.connected) {
              socket.disconnect();
            }
            logMessage_Info('[APIè°ƒç”¨] å·²æ–­å¼€WebSocketè¿æ¥å¹¶ç¦ç”¨è‡ªåŠ¨é‡è¿ (å› ç½‘ç»œé”™è¯¯)');
          }
        }

        // æ˜¾ç¤ºé€šç”¨ç½‘ç»œé”™è¯¯æç¤ºï¼Œå¹¶åœ¨ç”¨æˆ·å…³é—­æ—¶å°è¯•æ¢å¤
        showModalAlert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚', 'ç½‘ç»œé”™è¯¯', () => {
          // ç”¨æˆ·å…³é—­ç½‘ç»œé”™è¯¯å¼¹çª—æ—¶ï¼Œå°è¯•æ¢å¤
          if (isInNetworkErrorState) {
            logMessage_Info('[APIè°ƒç”¨] ç”¨æˆ·å…³é—­ç½‘ç»œé”™è¯¯å¼¹çª—ï¼Œå‡†å¤‡æ¢å¤è¿æ¥');
            isInNetworkErrorState = false;

            // å»¶è¿Ÿ1ç§’åé‡æ–°å¯åŠ¨å®šæ—¶å™¨å’ŒWebSocketï¼Œç»™ç½‘ç»œæ¢å¤æ—¶é—´
            setTimeout(() => {
              // æ¢å¤å®šæ—¶å™¨
              if (!refreshUserListInterval) {
                refreshUserListInterval = setInterval(refreshUserList, 5000);
                logMessage_Info('[APIè°ƒç”¨] ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨å·²æ¢å¤');
              }

              // é‡æ–°è¿æ¥WebSocket
              if (socket && !socket.connected && sessionUUID) {
                // é‡æ–°å¯ç”¨è‡ªåŠ¨é‡è¿
                if (socket.io) {
                  socket.io.opts.reconnection = true;
                }
                socket.connect();
                logMessage_Info('[APIè°ƒç”¨] æ­£åœ¨é‡æ–°è¿æ¥WebSocketï¼ˆå·²é‡æ–°å¯ç”¨è‡ªåŠ¨é‡è¿ï¼‰');
              }
            }, 1000);
          }
        });

        throw networkError; // é‡æ–°æŠ›å‡ºç½‘ç»œé”™è¯¯ï¼Œä¸­æ–­åç»­å¤„ç†
      }

      // å¤„ç†é OK å“åº” (åŒ…æ‹¬ 401, 403, 500 ç­‰)
      if (!response.ok) {
        logMessage_Info(`[APIè°ƒç”¨] âœ— å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
        let errorData = null;
        try {
          errorData = await response.json(); // å°è¯•è§£æ JSON é”™è¯¯ä½“
        } catch (parseError) {
          logMessage_Warning('[APIè°ƒç”¨] âœ— æ— æ³•è§£æé”™è¯¯å“åº”ä½“ä¸º JSON:', parseError);
          // å³ä½¿æ— æ³•è§£æï¼Œä¹Ÿè¦æ ¹æ®çŠ¶æ€ç å¤„ç†
        }

        // --- â­ Bug ä¿®å¤ï¼šå¤„ç†ä¼šè¯è¿‡æœŸ (401) ---
        if (response.status === 401 && errorData && errorData.message && errorData.message.includes('ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆ')) {
          logMessage_Error('[APIè°ƒç”¨] âœ— ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼');
          logMessage_Info('[ç³»ç»Ÿ] æ‚¨çš„ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚'); // åŒæ—¶è®°å½•åˆ°ç•Œé¢æ—¥å¿—

          // åœæ­¢ refreshUserList å®šæ—¶å™¨
          if (refreshUserListInterval) {
            logMessage_Info('[APIè°ƒç”¨] åœæ­¢ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨ (å› ä¼šè¯è¿‡æœŸ)');
            clearInterval(refreshUserListInterval);
            refreshUserListInterval = null; // æ¸…ç†å¥æŸ„
          }

          // å¼¹çª—æç¤ºç”¨æˆ·
          showModalAlert('æ‚¨çš„ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚', 'ä¼šè¯å¤±æ•ˆ');

          // å»¶è¿Ÿåè·³è½¬åˆ°ç™»å½•é¡µ
          setTimeout(() => {
            window.location.href = '/'; // è·³è½¬åˆ°æ ¹ç›®å½•
          }, 2500); // ç»™ç”¨æˆ· 2.5 ç§’æ—¶é—´çœ‹æç¤º

          // æŠ›å‡ºé”™è¯¯ï¼Œä¸­æ–­å½“å‰ API è°ƒç”¨çš„åç»­å¤„ç†
          throw new Error('ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆ');
        }
        // --- ç»“æŸ Bug ä¿®å¤ ---

        // å¤„ç†å…¶ä»–éœ€è¦é‡æ–°ç™»å½•çš„æƒ…å†µ (å¦‚ token è¿‡æœŸ/æ— æ•ˆ)
        if (errorData && errorData.need_login) {
          let errorMsg = errorData.message || 'APIè°ƒç”¨å¤±è´¥';
          logMessage_Info(`[APIè°ƒç”¨] âœ— éœ€è¦é‡æ–°ç™»å½•: ${errorMsg}`);

          // å¦‚æœæ˜¯åœ¨å…¶ä»–è®¾å¤‡ç™»å½•å¯¼è‡´çš„
          if (errorData.logged_out_elsewhere) {

            logMessage_Info('[å®‰å…¨æç¤º] æ£€æµ‹åˆ°è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå·²è‡ªåŠ¨ç™»å‡º');
            logMessage_Info('[APIè°ƒç”¨] âœ— å¤šè®¾å¤‡ç™»å½•æ£€æµ‹');

            // åˆ›å»ºå…¨å±é®ç½©å±‚ï¼Œé®ä½æ‰€æœ‰å†…å®¹
            const logoutOverlay = document.createElement('div');
            logoutOverlay.id = 'logout-elsewhere-overlay';
            logoutOverlay.style.cssText = `
                          position: fixed;
                          top: 0;
                          left: 0;
                          width: 100%;
                          height: 100%;
                          background: rgba(0, 0, 0, 0.85);
                          z-index: 9999;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        `;

            // åˆ›å»ºæ‹Ÿæ€çª—å£ï¼ˆæ¨¡æ€æ¡†å†…å®¹ï¼‰
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                          padding: 40px;
                          border-radius: 20px;
                          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                          max-width: 500px;
                          width: 90%;
                          text-align: center;
                          color: white;
                        `;

            // å›¾æ ‡
            const icon = document.createElement('div');
            icon.innerHTML = `
                          <svg style="width: 80px; height: 80px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                          </svg>
                        `;

            // æ ‡é¢˜
            const title = document.createElement('h2');
            title.textContent = 'å¤šè®¾å¤‡ç™»å½•æ£€æµ‹';
            title.style.cssText = `
                          font-size: 24px;
                          font-weight: bold;
                          margin: 0 0 20px 0;
                        `;

            // è¯´æ˜æ–‡æœ¬
            const text = document.createElement('p');
            text.textContent = 'æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œæœ¬è®¾å¤‡å·²è‡ªåŠ¨ç™»å‡ºã€‚2åˆ†é’Ÿåå°†è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚';
            text.style.cssText = `
                          font-size: 16px;
                          line-height: 1.6;
                          margin: 0 0 30px 0;
                          opacity: 0.95;
                        `;

            // å€’è®¡æ—¶æ˜¾ç¤º
            const countdown = document.createElement('div');
            countdown.style.cssText = `
                          font-size: 32px;
                          font-weight: bold;
                          margin: 0 0 30px 0;
                        `;

            // æŒ‰é’®
            const button = document.createElement('button');
            button.textContent = 'ç«‹å³è¿”å›ç™»å½•';
            button.style.cssText = `
                          background: white;
                          color: #667eea;
                          border: none;
                          padding: 12px 30px;
                          border-radius: 25px;
                          font-size: 16px;
                          font-weight: bold;
                          cursor: pointer;
                          transition: all 0.3s;
                        `;
            button.onmouseover = () => {
              button.style.transform = 'scale(1.05)';
              button.style.boxShadow = '0 5px 15px rgba(255, 255, 255, 0.3)';
            };
            button.onmouseout = () => {
              button.style.transform = 'scale(1)';
              button.style.boxShadow = 'none';
            };

            // ç»„è£…æ¨¡æ€æ¡†
            modalContent.appendChild(icon);
            modalContent.appendChild(title);
            modalContent.appendChild(text);
            modalContent.appendChild(countdown);
            modalContent.appendChild(button);
            logoutOverlay.appendChild(modalContent);
            document.body.appendChild(logoutOverlay);

            // å€’è®¡æ—¶é€»è¾‘ï¼š120ç§’ (2åˆ†é’Ÿ)
            let remainingSeconds = 120;
            const updateCountdown = () => {
              const minutes = Math.floor(remainingSeconds / 60);
              const seconds = remainingSeconds % 60;
              countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            };
            updateCountdown();

            // æ¯ç§’æ›´æ–°å€’è®¡æ—¶
            const countdownInterval = setInterval(() => {
              remainingSeconds--;
              updateCountdown();

              if (remainingSeconds <= 0) {
                clearInterval(countdownInterval);
                window.location.href = '/';
              }
            }, 1000);

            // ç‚¹å‡»æŒ‰é’®ç«‹å³è·³è½¬
            button.onclick = () => {
              clearInterval(countdownInterval);
              window.location.href = '/';
            };

            // ç”¨æˆ·æ´»åŠ¨æ£€æµ‹ï¼šå¦‚æœç”¨æˆ·åœ¨2åˆ†é’Ÿå†…æœ‰ä»»ä½•æ“ä½œï¼Œé‡ç½®å€’è®¡æ—¶
            // ï¼ˆä½†ä¿ç•™é®ç½©å±‚ï¼Œç¡®ä¿ç”¨æˆ·æ„è¯†åˆ°éœ€è¦é‡æ–°ç™»å½•ï¼‰
            const userActivityEvents = ['mousedown', 'keydown', 'touchstart'];
            const resetCountdown = () => {
              // é‡ç½®å€’è®¡æ—¶åˆ°120ç§’
              remainingSeconds = 120;
              updateCountdown();
              logMessage_Info('[å®‰å…¨æç¤º] æ£€æµ‹åˆ°ç”¨æˆ·æ´»åŠ¨ï¼Œå€’è®¡æ—¶å·²é‡ç½®');
            };

            userActivityEvents.forEach(eventType => {
              document.addEventListener(eventType, resetCountdown, { once: false });
            });

            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨çš„å‡½æ•°ï¼ˆåœ¨è·³è½¬å‰è°ƒç”¨ï¼‰
            const cleanupListeners = () => {
              userActivityEvents.forEach(eventType => {
                document.removeEventListener(eventType, resetCountdown);
              });
            };

            // æ›´æ–°æŒ‰é’®ç‚¹å‡»å¤„ç†ï¼ŒåŒ…å«æ¸…ç†
            button.onclick = () => {
              clearInterval(countdownInterval);
              cleanupListeners();
              window.location.href = '/';
            };

          } else {
            // showModalAlert(errorMsg, 'ç™»å½•å¤±æ•ˆ');
            logMessage_Info(`[å®‰å…¨æç¤º] ${errorMsg}`);


            // æ¸…é™¤æœ¬åœ°çŠ¶æ€å¹¶è¿”å›ç™»å½•é¡µ - ç­‰å¾…ç”¨æˆ·ç¡®è®¤
            Swal.fire({
              icon: 'warning',
              title: 'éœ€è¦é‡æ–°ç™»å½•',
              text: errorMsg,
              confirmButtonText: 'è¿”å›ç™»å½•',
              allowOutsideClick: false
            }).then(() => {
              window.location.href = '/';
            });
          }

          // åœæ­¢å¯èƒ½çš„åˆ·æ–°å®šæ—¶å™¨ (ä¹Ÿé€‚ç”¨äº token è¿‡æœŸç­‰æƒ…å†µ)
          if (refreshUserListInterval) {
            logMessage_Info('[APIè°ƒç”¨] åœæ­¢ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨ (å› éœ€é‡æ–°ç™»å½•)');
            clearInterval(refreshUserListInterval);
            refreshUserListInterval = null;
          }



          throw new Error(errorMsg);
        }

        // å¤„ç†å…¶ä»–æƒé™ä¸è¶³ (403) çš„é”™è¯¯
        if (response.status === 403 && errorData && errorData.message) {
          logMessage_Error(`[APIè°ƒç”¨] âœ— æƒé™ä¸è¶³ (${method}): ${errorData.message}`);
          showModalAlert(`æ“ä½œå¤±è´¥: ${errorData.message}`, 'æƒé™ä¸è¶³');
          throw new Error(`æƒé™ä¸è¶³: ${errorData.message}`);
        }

        // å¤„ç†å…¶ä»–æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500) æˆ–æœªæ˜ç¡®å¤„ç†çš„é”™è¯¯
        const genericErrorMessage = (errorData && errorData.message) ? errorData.message : response.statusText;
        logMessage_Error(`[APIè°ƒç”¨] âœ— æœªå¤„ç†çš„é”™è¯¯ (${method}): ${genericErrorMessage}`);
        // å¯ä»¥é€‰æ‹©æ˜¯å¦ç»™ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªé€šç”¨é”™è¯¯
        // showModalAlert(`å‘ç”Ÿæ„å¤–é”™è¯¯ (${response.status})ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`, 'æœåŠ¡å™¨é”™è¯¯');
        throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${genericErrorMessage}`);
      }

      // å¦‚æœå“åº” OK (2xx)
      logMessage_Info(`[APIè°ƒç”¨] âœ“ è¯·æ±‚æˆåŠŸ (${method})`);
      const result = await response.json();
      logMessage_Info(`[APIè°ƒç”¨] âœ“ è¿”å›ç»“æœ (${method}):`, result.success ? 'æˆåŠŸ' : 'å¤±è´¥');
      return result;
    }

    // åŸå§‹APIè°ƒç”¨å‡½æ•°ï¼Œç”¨äºç›´æ¥è°ƒç”¨è·¯å¾„
    async function callPythonAPI_raw(path, method = 'POST', data = null) {
      const headers = {
        'Content-Type': 'application/json',
      };

      // æ·»åŠ ä¼šè¯UUIDåˆ°è¯·æ±‚å¤´
      if (sessionUUID) {
        headers['X-Session-ID'] = sessionUUID;
      }

      const options = {
        method: method,
        headers: headers,
        credentials: 'include',
      };

      if (data && method !== 'GET') {
        options.body = JSON.stringify(data);
      }

      try {
        const response = await fetch(path, options);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      } catch (error) {
        logMessage_Error(`APIè°ƒç”¨å¤±è´¥ (${path}):`, error);
        throw error;
      }
    }

    // åœ¨æœåŠ¡å™¨ç«¯Chromeä¸­æ‰§è¡ŒJavaScript
    async function executeServerJS(script, ...args) {
      // Webæ¨¡å¼ï¼šå°†JavaScriptä»£ç å‘é€åˆ°æœåŠ¡å™¨ç«¯Chromeæµè§ˆå™¨ä¸­æ‰§è¡Œ
      const headers = {
        'Content-Type': 'application/json',
      };

      // æ·»åŠ ä¼šè¯UUIDåˆ°è¯·æ±‚å¤´
      if (sessionUUID) {
        headers['X-Session-ID'] = sessionUUID;
      }

      const response = await fetch('/execute_js', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          script: script,
          args: args
        })
      });

      if (!response.ok) {
        throw new Error(`æœåŠ¡å™¨ç«¯JSæ‰§è¡Œå¤±è´¥: ${response.statusText}`);
      }

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.message || 'JSæ‰§è¡Œå¤±è´¥');
      }

      return data.result;
    }

    // å•è´¦å·æ¨¡å¼ï¼šGPSç‚¹è¿›åº¦è®¡æ•°
    let singleProcessedPoints = 0;       // å·²å¤„ç†/å·²ä¸ŠæŠ¥çš„ç‚¹æ•°
    let singleTotalPoints = 0;           // å½“å‰ä»»åŠ¡æ€»ç‚¹æ•°ï¼ˆrun_coordsé•¿åº¦ï¼‰


    // ç»Ÿä¸€çš„ AMap å•ä¾‹ä¸åŠ è½½æ§åˆ¶
    let AMapInstance, map;
    let amapLoadingPromise = null;   // ä¿è¯åªè§¦å‘ä¸€æ¬¡åŠ è½½
    let AMapReady = false;           // é«˜å¾·åœ°å›¾SDKæ˜¯å¦å·²åŠ è½½å°±ç»ª

    let currentTasks = [];
    let selectedTaskIndex = -1;
    let currentUserData = {};
    let currentRunData = {};
    let polylines = { recommended: [], draft: null, run: null, history: null };
    let markers = [];
    let runnerMarker = null;
    let drawingInfoMarker = null;
    let tempAttendanceMarker = null;
    let tempAttendanceCircle = null;
    let isDrawing = false;
    let isPathDrawing = false;
    let leftMouseDown = false;
    const $ = (id) => document.getElementById(id);

    let multiAccountMap;
    let multiAccountMarkers = {}; // {username: AMap.Marker}
    const userColors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
    let colorIndex = 0;
    let path_planning_queue = [];
    let is_planning_path = false;

    let currentSessionUA = ""

    let pendingMultiPositions = []; // [{ username, lon, lat, name }]

    // -- åœ°å›¾åˆå§‹åŒ–Promiseï¼Œç”¨äºç¡®ä¿åœ°å›¾å®Œå…¨åŠ è½½åå†æ‰§è¡Œç»˜å›¾æ“ä½œ --
    let mapReadyPromise = null;
    let resolveMapReady = null;

    // å‚æ•°å®šä¹‰ï¼ˆè¯¦ç»†ç‰ˆï¼šæ ‡ç­¾ã€å•ä½ã€å¸®åŠ©ï¼‰
    const paramDefs = {
      // é‡‡æ ·ä¸é€Ÿåº¦
      "interval_ms": {
        label: "é‡‡æ ·é—´éš”",
        unit: "ms",
        help: "ç›¸é‚» GPS ç‚¹ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œç”¨äºæ¨¡æ‹Ÿä¸ŠæŠ¥èŠ‚å¥ã€‚"
      },
      "interval_random_ms": {
        label: "é—´éš”éšæœºèŒƒå›´",
        unit: "ms",
        help: "åœ¨é‡‡æ ·é—´éš”çš„åŸºç¡€ä¸Šä¸Šä¸‹æµ®åŠ¨çš„éšæœºæŠ–åŠ¨å¹…åº¦ã€‚"
      },
      "speed_mps": {
        label: "å¹³å‡é€Ÿåº¦",
        unit: "m/s",
        help: "ç”Ÿæˆ/å¤„ç†è·¯å¾„æ—¶çš„ç›®æ ‡å¹³å‡é€Ÿåº¦ã€‚"
      },
      "speed_random_mps": {
        label: "é€Ÿåº¦éšæœºèŒƒå›´",
        unit: "m/s",
        help: "é€Ÿåº¦çš„ä¸Šä¸‹æµ®åŠ¨èŒƒå›´ï¼Œç”¨äºæ¨¡æ‹Ÿè‡ªç„¶æ³¢åŠ¨ã€‚"
      },
      "location_random_m": {
        label: "å®šä½éšæœºåç§»åŠå¾„",

        unit: "m",
        help: "å¯¹æ¯ä¸ª GPS ç‚¹æ–½åŠ çš„éšæœºåç§»çš„åŠå¾„ï¼Œæ¨¡æ‹Ÿå®šä½å™ªå£°ã€‚"
      },

      // ä»»åŠ¡é—´éš”
      "task_gap_min_s": {
        label: "ä»»åŠ¡é—´éš™ä¸‹é™",
        unit: "s",
        help: "è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„æœ€çŸ­ç­‰å¾…æ—¶é—´ã€‚"
      },
      "task_gap_max_s": {
        label: "ä»»åŠ¡é—´éš™ä¸Šé™",
        unit: "s",
        help: "è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚"
      },

      // è·¯å¾„è§„åˆ’APIå¤±è´¥æ—¶çš„é‡è¯•ç­–ç•¥é…ç½®
      "api_fallback_line": {
        label: "è§„åˆ’å¤±è´¥æ—¶ä½¿ç”¨ç›´çº¿è¿æ¥",
        unit: "",
        help: "å¯ç”¨åï¼Œå½“æŸæ®µæ­¥è¡Œè·¯å¾„è§„åˆ’å¤±è´¥æ—¶ï¼Œä½¿ç”¨èµ·ç»ˆç‚¹ç›´çº¿ä»£æ›¿ã€‚"
      },
      "api_retries": {
        label: "APIé‡è¯•æ¬¡æ•°",
        unit: "æ¬¡",
        help: "æ­¥è¡Œè·¯å¾„æ¯ä¸€æ®µå¤±è´¥åçš„é‡è¯•æ¬¡æ•°ã€‚"
      },

      "api_retry_delay_s": {
        label: "APIé‡è¯•é—´éš”",
        unit: "s",
        help: "æ­¥è¡Œè·¯å¾„å¤±è´¥åå‘èµ·ä¸‹ä¸€æ¬¡é‡è¯•å‰çš„ç­‰å¾…æ—¶é—´ã€‚"
      },
      "ignore_task_time": {
        label: "å¿½ç•¥ä»»åŠ¡æ—¶é—´ä»…å¯¹æ¯”æ—¥æœŸ",
        unit: "",
        help: "å‹¾é€‰åï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦â€œæœªå¼€å§‹â€æˆ–â€œå·²è¿‡æœŸâ€æ—¶ï¼Œåªå¯¹æ¯”å¹´æœˆæ—¥ï¼Œå¿½ç•¥å…·ä½“æ—¶åˆ†ç§’ã€‚"
      },

      // è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ç›®æ ‡
      "min_time_m": {
        label: "ç›®æ ‡æ—¶é•¿ä¸‹é™",
        unit: "åˆ†é’Ÿ",
        help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»æ—¶é•¿æœ€å°å€¼ã€‚"
      },
      "max_time_m": {
        label: "ç›®æ ‡æ—¶é•¿ä¸Šé™",
        unit: "åˆ†é’Ÿ",
        help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»æ—¶é•¿æœ€å¤§å€¼ã€‚"
      },
      "min_dist_m": {
        label: "ç›®æ ‡è·ç¦»ä¸‹é™",
        unit: "m",
        help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»è·ç¦»ä¸‹é™ã€‚ä¸Šé™æŒ‰ 1.0â€“1.15 å€éšæœºæµ®åŠ¨ã€‚"
      },

      // ä¸»é¢˜
      "theme_style": {
        label: "ç•Œé¢ä¸»é¢˜é£æ ¼",
        unit: "",
        help: "åˆ‡æ¢åº”ç”¨ç•Œé¢çš„å¤–è§‚ã€‚ä¸»é¢˜åˆ‡æ¢åå°†è‡ªåŠ¨ä¿å­˜ã€‚",
        type: "theme_selector" // è‡ªå®šä¹‰ç±»å‹ï¼Œç”¨äºç”Ÿæˆä¸»é¢˜æŒ‰é’®
      },
      "theme_base_color": {
        label: "ä¸»é¢˜åŸºç¡€é¢œè‰²",
        unit: "",
        help: "ç•Œé¢ä¸»è‰²è°ƒï¼ˆç‚¹å‡»é¢œè‰²å—è¿›è¡Œé€‰æ‹©ï¼‰ã€‚",
        type: "color_picker" // è‡ªå®šä¹‰ç±»å‹ï¼Œç”¨äºç”Ÿæˆé¢œè‰²é€‰æ‹©å™¨
      },
      "auto_attendance_enabled": {
        label: "å¼€å¯è‡ªåŠ¨ç­¾åˆ°",
        unit: "",
        help: "å¼€å¯åï¼Œå°†åœ¨åå°è‡ªåŠ¨åˆ·æ–°é€šçŸ¥å¹¶å°è¯•ç­¾åˆ°",
        type: "checkbox"
      },
      "auto_attendance_refresh_s": {
        label: "åˆ·æ–°é—´éš”",
        unit: "ç§’",
        help: "è‡ªåŠ¨åˆ·æ–°é€šçŸ¥çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå»ºè®®ä¸ä½äº60"
      },
      "attendance_user_radius_m": {
        label: "éšæœºåŠå¾„",
        unit: "ç±³",
        help: "è‡ªåŠ¨ç­¾åˆ°æ—¶ï¼Œåœ¨æœåŠ¡å™¨å…è®¸èŒƒå›´å†…çš„æœ€å¤§éšæœºåç§»åŠå¾„ã€‚è®¾ä¸º0ä¸ºç²¾ç¡®ç­¾åˆ°ã€‚"
      }
    };

    // å‚æ•°åˆ†ç»„å®šä¹‰
    const paramGroups = [
      {
        title: "é‡‡æ ·ä¸é€Ÿåº¦",
        keys: ["interval_ms", "interval_random_ms", "speed_mps", "speed_random_mps", "location_random_m"]
      },
      {
        title: "ä»»åŠ¡é—´éš”",
        keys: ["task_gap_min_s", "task_gap_max_s", "ignore_task_time"]
      },
      {
        title: "è·¯å¾„è§„åˆ’é‡è¯•ç­–ç•¥",
        keys: ["api_fallback_line", "api_retries", "api_retry_delay_s"]
      },
      {
        title: "è‡ªåŠ¨ç”Ÿæˆç›®æ ‡",
        keys: ["min_time_m", "max_time_m", "min_dist_m"]
      },
      {
        title: "ä¸»é¢˜ä¸å¤–è§‚",
        keys: ["theme_style", "theme_base_color"]
      },
      {
        title: "è‡ªåŠ¨ç­¾åˆ°",
        keys: ["auto_attendance_enabled", "auto_attendance_refresh_s", "attendance_user_radius_m"]
      }
    ];

    let pythonParams = {};

    let runAccumulatedMs = 0;
    let draftTotalDist = 0;


    // æ˜¾å¼é”€æ¯å•è´¦å·åœ°å›¾å®ä¾‹ï¼Œé‡Šæ”¾èµ„æºå¹¶å¤ä½å˜é‡
    function destroySingleMap() {
      try {
        // å…ˆæ¸…ç†è‡ªå®šä¹‰äº¤äº’ç›‘å¬å™¨
        if (window.mapCleanup) {
          window.mapCleanup();
          window.mapCleanup = null;
        }
        if (map && typeof map.destroy === 'function') {
          map.destroy();
        }
      } catch (e) {
        logMessage_Warning('destroySingleMap warning:', e);
      } finally {
        map = null;
        polylines.recommended = [];
        polylines.draft = null;
        polylines.run = null;
        polylines.history = null;
        markers = [];
        runnerMarker = null;
        drawingInfoMarker = null;

        try { const container = document.getElementById('map-container'); if (container) container.classList.remove('drawing'); } catch (_) { }
        isDrawing = false; isPathDrawing = false; leftMouseDown = false; pendingUnlockMap = false;
        draftPath = []; draftPathLngLat = []; pendingPoints = []; isUpdating = false; lastMouseMoveTime = 0;
        try { document.body.classList.remove('modal-visible'); } catch (_) { }
      }
    }





    function updateMultiGlobalButtons(startDisabled, stopDisabled) {
      const startBtn = document.getElementById('multi-start-all-btn');
      const stopBtn = document.getElementById('multi-stop-all-btn');
      if (!startBtn || !stopBtn) return;
      // åç«¯ä¼ å…¥çš„å¸ƒå°”å€¼å³æŒ‰é’®ç¦ç”¨çŠ¶æ€
      startBtn.disabled = !!startDisabled;
      stopBtn.disabled = !!stopDisabled;
    }


    // å®‰å…¨ resize å¹¶åœ¨ä¸‹ä¸€å¸§ç»Ÿä¸€ fit è§†è§’ï¼ˆé¿å…åˆæ¬¡æ˜¾ç¤ºåç§»ï¼‰
    function safeResizeAndFitView() {
      try {
        map.resize();
        requestAnimationFrame(() => {
          resetMapView();
          // å†è¡¥ä¸€æ¬¡ fitViewï¼Œç¡®ä¿ marker æŠ•å½±æ­£ç¡®
          if (markers.length > 0) {
            map.setFitView(markers, false, [50, 50, 50, 50]);
          }
        });
      } catch (e) {
        logMessage_Warning('safeResizeAndFitView error:', e);
      }
    }





    // --- æ–°å¢ï¼šä¸»é¢˜é£æ ¼åˆ‡æ¢ ---
    function setThemeStyle(styleName) {
      // ç§»é™¤ body ä¸Šæ‰€æœ‰å¯èƒ½çš„ä¸»é¢˜ class
      document.body.classList.remove('theme-anime', 'theme-minimalist');

      // å¦‚æœä¸æ˜¯é»˜è®¤ä¸»é¢˜ï¼Œåˆ™æ·»åŠ å¯¹åº”çš„ class
      if (styleName !== 'default') {
        document.body.classList.add(styleName);
      }

      // æ›´æ–°æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
      const themeButtons = document.querySelectorAll('#params-tab .grid button[onclick^="setThemeStyle"]');
      themeButtons.forEach(btn => {
        if (btn.getAttribute('onclick') === `setThemeStyle('${styleName}')`) {
          btn.classList.add('border-2', 'border-sky-500'); // é«˜äº®é€‰ä¸­
        } else {
          btn.classList.remove('border-2', 'border-sky-500');
        }
      });

      // è°ƒç”¨ Python åç«¯ä¿å­˜è®¾ç½®
      callPythonAPI('update_param', 'theme_style', styleName);
      logMessage_Info(`ä¸»é¢˜å·²åˆ‡æ¢ä¸º: ${styleName}`);
    }


    // --- æ¢å¤é»˜è®¤ä¸»é¢˜é¢œè‰² ---
    function resetBaseColorToDefault(prefix) {
      const defaultColor = '#7dd3fc';
      const key = 'theme_base_color';

      // 1. æ›´æ–°é¢œè‰²é€‰æ‹©å™¨å’Œæ–‡æœ¬æ¡†çš„UI
      const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
      const textInput = document.getElementById(`${prefix}-${key}`);
      if (colorPicker) colorPicker.value = defaultColor;
      if (textInput) textInput.value = defaultColor;

      // 2. è°ƒç”¨ç°æœ‰å‡½æ•°æ›´æ–°ç•Œé¢ä¸»é¢˜å¹¶ä¿å­˜åˆ°åç«¯
      // setBaseColor å†…éƒ¨å·²ç»åŒ…å«äº†è°ƒç”¨ python api ä¿å­˜çš„é€»è¾‘
      setBaseColor(defaultColor, defaultColor);

      // 3. æ›´æ–°å‰ç«¯ç¼“å­˜çš„å‚æ•°å¯¹è±¡ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´
      if (pythonParams) {
        pythonParams[key] = defaultColor;
      }

      logMessage_Info("ä¸»é¢˜é¢œè‰²å·²æ¢å¤ä¸ºé»˜è®¤ã€‚");
    }

    // --- ä¸»é¢˜é¢œè‰²è®¾ç½® ---
    function setBaseColor(c, deep) {
      document.documentElement.style.setProperty('--base-color', c);
      document.documentElement.style.setProperty('--base-color-600', deep);
      document.documentElement.style.setProperty('--base-color-300', c);
      callPythonAPI('update_param', 'theme_base_color', c);
      if ($('base-color-input')) $('base-color-input').value = c;
    }
    function onColorPicked(val) { setBaseColor(val, val); }

    // ====================
    // è®¤è¯ç³»ç»Ÿ JavaScript
    // ====================

    // æ£€æŸ¥å¹¶æ˜¾ç¤ºè®¤è¯çŠ¶æ€
    async function checkAuthStatus() {
      // æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è®¤è¯
      try {
        const result = await callPythonAPI('get_initial_data');
        if (result && result.is_authenticated) {
          return true;
        }
      } catch (e) {
        logMessage_Info('æœªè®¤è¯æˆ–ä¼šè¯è¿‡æœŸ');
      }

      return false;
    }

    // æ˜¾ç¤ºè®¤è¯ç™»å½•ç•Œé¢
    function showAuthLogin() {
      $('loading-overlay').classList.add('hidden');
      $('auth-login-container').classList.remove('hidden');
      $('login-container').classList.add('hidden');
      $('main-app').classList.add('hidden');

      // æ£€æŸ¥æ˜¯å¦å…è®¸æ¸¸å®¢ç™»å½•
      checkGuestLoginEnabled();
    }

    // æ£€æŸ¥æ˜¯å¦å…è®¸æ¸¸å®¢ç™»å½•
    async function checkGuestLoginEnabled() {
      try {
        const result = await fetch('/auth/get_config');
        const data = await result.json();
        if (data.success && data.allow_guest_login) {
          $('guest-login-section').classList.remove('hidden');
        } else {
          $('guest-login-section').classList.add('hidden');
        }
      } catch (e) {
        logMessage_Error('è·å–é…ç½®å¤±è´¥:', e);
      }
    }

    // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
    function switchAuthTab(tab) {
      const loginTab = $('auth-tab-login');
      const registerTab = $('auth-tab-register');
      const loginForm = $('auth-login-form');
      const registerForm = $('auth-register-form');

      if (tab === 'login') {
        loginTab.classList.add('text-sky-600', 'border-sky-600');
        loginTab.classList.remove('text-slate-400', 'border-transparent');
        registerTab.classList.remove('text-sky-600', 'border-sky-600');
        registerTab.classList.add('text-slate-400', 'border-transparent');
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
      } else {
        registerTab.classList.add('text-sky-600', 'border-sky-600');
        registerTab.classList.remove('text-slate-400', 'border-transparent');
        loginTab.classList.remove('text-sky-600', 'border-sky-600');
        loginTab.classList.add('text-slate-400', 'border-transparent');
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      }

      // æ¸…ç©ºé”™è¯¯/æˆåŠŸæ¶ˆæ¯
      $('auth-error-msg').classList.add('hidden');
      $('auth-success-msg').classList.add('hidden');
    }

    // æ˜¾ç¤ºè®¤è¯é”™è¯¯æ¶ˆæ¯
    function showAuthError(message) {
      const errorMsg = $('auth-error-msg');
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      $('auth-success-msg').classList.add('hidden');
    }

    // æ˜¾ç¤ºè®¤è¯æˆåŠŸæ¶ˆæ¯
    function showAuthSuccess(message) {
      const successMsg = $('auth-success-msg');
      successMsg.textContent = message;
      successMsg.classList.remove('hidden');
      $('auth-error-msg').classList.add('hidden');
    }

    // UIåé¦ˆè¾…åŠ©å‡½æ•°
    function setButtonLoading(buttonId, loading, originalText = '') {
      const btn = $(buttonId);
      if (!btn) return;

      if (loading) {
        btn.dataset.originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = `<span class="inline-block animate-spin mr-2">â³</span>${originalText || 'å¤„ç†ä¸­...'}`;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || originalText;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        delete btn.dataset.originalText;
      }
    }

    function showButtonSuccess(buttonId, message = 'æˆåŠŸ', duration = 1500) {
      const btn = $(buttonId);
      if (!btn) return;

      // å…ˆæ¸…é™¤åŠ è½½çŠ¶æ€ï¼Œç¡®ä¿æŒ‰é’®å¯ç”¨
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');

      const originalText = btn.dataset.originalText || btn.textContent;
      delete btn.dataset.originalText;

      btn.innerHTML = `<span class="mr-1">âœ“</span>${message}`;
      btn.classList.add('!bg-green-600');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('!bg-green-600');
        btn.disabled = false; // ç¡®ä¿æ¢å¤åæŒ‰é’®å¯ç”¨
      }, duration);
    }

    function showButtonError(buttonId, message = 'å¤±è´¥', duration = 2000) {
      const btn = $(buttonId);
      if (!btn) return;

      // å…ˆæ¸…é™¤åŠ è½½çŠ¶æ€ï¼Œç¡®ä¿æŒ‰é’®å¯ç”¨
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');

      const originalText = btn.dataset.originalText || btn.textContent;
      delete btn.dataset.originalText;

      btn.innerHTML = `<span class="mr-1">âœ—</span>${message}`;
      btn.classList.add('!bg-red-600');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('!bg-red-600');
        btn.disabled = false; // ç¡®ä¿æ¢å¤åæŒ‰é’®å¯ç”¨
      }, duration);
    }

    // ç”¨æˆ·ç™»å½•
    async function handleAuthLogin() {
      const loginBtn = $('auth-login-btn');
      // 'username' input field holds either the username OR the phone number
      const login_id = $('auth-username').value.trim();
      const password = $('auth-password').value.trim();
      const sms_code = $('auth-sms-code').value.trim();

      let login_mode = 'username'; // Default to username
      let login_verification_method = 'password'; // Default to password

      // 1. ç¡®å®šç™»å½•æ¨¡å¼ (ç”¨æˆ·å or æ‰‹æœºå·)
      if ($('auth-login-phone-btn').classList.contains('font-semibold')) {
        login_mode = 'phone';
      }

      // 2. ç¡®å®šéªŒè¯æ–¹å¼ (å¯†ç  or çŸ­ä¿¡)
      // æ£€æŸ¥ 'auth-sms-section' (çŸ­ä¿¡åŒºåŸŸ) æ˜¯å¦ *ä¸* åŒ…å« 'hidden'
      if (!$('auth-sms-section').classList.contains('hidden')) {
        login_verification_method = 'sms';
      }

      // 3. æ‰§è¡ŒéªŒè¯
      if (!login_id) {
        showModalAlert('è¯·è¾“å…¥ç”¨æˆ·åæˆ–æ‰‹æœºå·', 'ç™»å½•å¤±è´¥');
        return;
      }

      if (login_mode === 'username') {
        // ç”¨æˆ·åç™»å½•: å¿…é¡»ä½¿ç”¨å¯†ç 
        if (!password) {
          showModalAlert('è¯·è¾“å…¥å¯†ç ', 'ç™»å½•å¤±è´¥');
          return;
        }
        if (password.length < 6 && login_id !== 'admin') {
          showModalAlert('å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦', 'ç™»å½•å¤±è´¥');
          return;
        }
      }
      else if (login_mode === 'phone') {
        // æ‰‹æœºå·ç™»å½•: éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!validateInput(login_id, 'phone').valid) {
          showModalAlert('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®', 'ç™»å½•å¤±è´¥');
          return;
        }

        if (login_verification_method === 'password') {
          // æ‰‹æœºå· + å¯†ç 
          if (!password) {
            showModalAlert('è¯·è¾“å…¥å¯†ç ', 'ç™»å½•å¤±è´¥');
            return;
          }
          if (password.length < 6) {
            showModalAlert('å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦', 'ç™»å½•å¤±è´¥');
            return;
          }
        }
        else if (login_verification_method === 'sms') {
          // æ‰‹æœºå· + éªŒè¯ç 
          if (!sms_code) {
            showModalAlert('è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ', 'ç™»å½•å¤±è´¥');
            return;
          }
          if (sms_code.length !== 6 || !/^\d{6}$/.test(sms_code)) {
            showModalAlert('çŸ­ä¿¡éªŒè¯ç æ ¼å¼ä¸æ­£ç¡®', 'ç™»å½•å¤±è´¥');
            return;
          }
        }
      }

      // 4. æ„å»ºè¯·æ±‚ä½“ (Request Body)
      const request_body = {}

      if (login_mode === 'username') {
        request_body.auth_username = login_id; // ä½¿ç”¨ç”¨æˆ·åç™»å½•
      } else if (login_mode === 'phone') {
        request_body.auth_phone = login_id; // ä½¿ç”¨æ‰‹æœºå·ç™»å½•
      }

      // æ ¹æ®éªŒè¯æ–¹å¼æ·»åŠ å¯†ç æˆ–çŸ­ä¿¡
      if (login_verification_method === 'password') {
        request_body.auth_password = password;
      } else if (login_verification_method === 'sms') {
        request_body.auth_sms_code = sms_code;
      }
      // (2FA code is handled by handle2FAVerify, not here)

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      setButtonLoading('auth-login-btn', true, 'ç™»å½•ä¸­...');

      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json',
          'X-Session-ID': sessionUUID || null
        };

        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: headers,
          credentials: 'include',  // é‡è¦ï¼šåŒ…å«cookies
          body: JSON.stringify(request_body) // <-- 5. å‘é€æ„å»ºå¥½çš„ request_body
        });

        const result = await response.json();

        if (result.success) {
          // æ£€æŸ¥æ˜¯å¦éœ€è¦2FAéªŒè¯
          if (result.requires_2fa) {
            // ä¿å­˜ç”¨æˆ·åç”¨äº2FAéªŒè¯ (åç«¯å¿…å®šè¿”å› auth_username)
            window.temp2FAUsername = result.auth_username || login_id;

            // æ¸…é™¤ç™»å½•æŒ‰é’®åŠ è½½çŠ¶æ€
            setButtonLoading('auth-login-btn', false);

            // éšè—ç™»å½•è¡¨å•ï¼Œæ˜¾ç¤º2FAè¡¨å•
            const loginForm = $('auth-login-form');
            const tfaForm = $('auth-2fa-form');
            if (loginForm) loginForm.classList.add('hidden');
            if (tfaForm) tfaForm.classList.remove('hidden');

            // æ¸…ç©ºå¹¶èšç„¦åˆ°2FAè¾“å…¥æ¡†
            const tfaCodeInput = $('auth-2fa-code');
            if (tfaCodeInput) {
              tfaCodeInput.value = '';
              tfaCodeInput.focus();
            }

            showAuthSuccess('å¯†ç éªŒè¯æˆåŠŸï¼Œè¯·è¾“å…¥éªŒè¯ç ');
            return;
          }

          // ä¿®æ­£ï¼šè®¾ç½®sessionUUIDä»¥ä¾¿åç»­APIè°ƒç”¨
          if (result.session_id) {
            sessionUUID = result.session_id;
            logMessage_Info('[ç™»å½•æˆåŠŸ] ä¼šè¯IDå·²è®¾ç½®:', sessionUUID.substring(0, 16) + '...');
          }

          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          let successMessage = 'ç™»å½•æˆåŠŸï¼';

          // å¦‚æœæœ‰å¤šè®¾å¤‡ç™»å½•è­¦å‘Š
          if (result.multi_device_warning) {
            successMessage += '\n' + result.multi_device_warning;
          }

          // å¦‚æœæœ‰ä¼šè¯æ¸…ç†æç¤º
          if (result.cleanup_message) {
            successMessage += '\n' + result.cleanup_message;
          }

          showAuthSuccess(successMessage);

          // å¦‚æœæœ‰tokenï¼Œè®°å½•æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          if (result.token) {
            logMessage_Info('Received auth token (stored in cookie)');
            logMessage_Info('[å®‰å…¨] ç™»å½•ä»¤ç‰Œå·²ç”Ÿæˆï¼Œæœ‰æ•ˆæœŸ1å°æ—¶');
          }

          // ç³»ç»Ÿè´¦å·ç™»å½•æˆåŠŸåï¼Œæ˜¾ç¤ºä¼šè¯é€‰æ‹©å™¨
          if (!result.is_guest) {
            // åœ¨ç³»ç»Ÿç™»å½•æˆåŠŸæ—¶ï¼Œå¿…é¡»è®¾ç½® currentUserData.group
            // å¦åˆ™ switchAdminTab ä¼šé”™è¯¯åœ°è®¤ä¸ºæ˜¯ 'user' æƒé™
            currentUserData.group = result.group || 'user';
            currentAuthUsername = result.auth_username;
            currentUserIsGuest = false;
            logMessage_Info(`[ç³»ç»Ÿç™»å½•] æƒé™ç»„å·²è®¾ç½®ä¸º: ${currentUserData.group}`);

            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€ï¼ŒæŒç»­æ—¶é—´è®¾ä¸º800msï¼Œé¿å…ä¸åç»­æ“ä½œå†²çª
            showButtonSuccess('auth-login-btn', 'ç™»å½•æˆåŠŸ', 800);

            setTimeout(() => {
              // æ¸…é™¤æŒ‰é’®çŠ¶æ€ï¼Œç¡®ä¿æŒ‰é’®æ¢å¤æ­£å¸¸
              setButtonLoading('auth-login-btn', false);

              // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºä¼šè¯é€‰æ‹©å™¨æ¨¡æ€æ¡†
              $('auth-login-container').classList.add('hidden');
              // æ ¹æ® isMobileMode å†³å®šæ˜¾ç¤ºå“ªä¸ªä¼šè¯é€‰æ‹©å™¨
              if (isMobileMode) {
                // éšè—ç§»åŠ¨ç«¯è®¤è¯è¡¨å•
                $('mobile-auth-login-container').classList.add('hidden');
                // æ˜¾ç¤ºç§»åŠ¨ç«¯ä¼šè¯é€‰æ‹©å™¨ (åº•éƒ¨å¼¹çª—)
                showMobileSessionPicker();

              } else {
                // æ˜¾ç¤ºæ¡Œé¢ç«¯ä¼šè¯é€‰æ‹©å™¨ (å±…ä¸­æ¨¡æ€æ¡†)
                showSessionPicker();
              }

              // æ˜¾ç¤ºæç¤ºä¿¡æ¯
              logMessage_Info('[ä¼šè¯é€‰æ‹©] è¯·é€‰æ‹©è¦è¿›å…¥çš„ä¼šè¯ï¼Œæˆ–åˆ›å»ºæ–°ä¼šè¯');
              logMessage_Info('[æç¤º] æ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€');

              // å¦‚æœè¸¢å‡ºäº†å…¶ä»–è®¾å¤‡ï¼Œæ˜¾ç¤ºä¿¡æ¯
              if (result.kicked_sessions_count > 0) {
                logMessage_Info(`[å¤šè®¾å¤‡æ£€æµ‹] å·²è‡ªåŠ¨ç™»å‡ºè¯¥è´¦å·åœ¨å…¶ä»– ${result.kicked_sessions_count} ä¸ªè®¾å¤‡ä¸Šçš„ä¼šè¯`);
              }
            }, 1000);
            return;
          }

          // æ¸¸å®¢ç™»å½•ï¼šåˆ†é…æ–°UUIDå¹¶è·³è½¬
          setTimeout(async () => {
            // éšè—è®¤è¯ç•Œé¢ï¼Œæ˜¾ç¤ºåº”ç”¨ç™»å½•ç•Œé¢
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.remove('hidden');

            // åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿çš„tabå¯è§æ€§
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–ç®¡ç†é¢æ¿å¤±è´¥:', e);
            }

            // æ˜¾ç¤ºç®¡ç†é¢æ¿æŒ‰é’®ï¼ˆæ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬æ¸¸å®¢éƒ½å¯ä»¥è®¿é—®ç®¡ç†é¢æ¿ï¼‰
            const adminBtnLogin = $('show-admin-panel-login');
            if (adminBtnLogin) adminBtnLogin.classList.remove('hidden');
            const adminBtnMulti = $('show-admin-panel-multi');
            if (adminBtnMulti) adminBtnMulti.classList.remove('hidden');
            const sessionsBtnMain = $('show-admin-panel');
            if (sessionsBtnMain) sessionsBtnMain.classList.remove('hidden');

            // å¦‚æœæ˜¯æ¸¸å®¢ï¼Œæ˜¾ç¤ºæç¤º
            if (result.is_guest) {
              logMessage_Info('[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼šæ— æ³•æ ‡è®°é€šçŸ¥å·²è¯»ã€æ— æ³•ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½ã€æ— æ³•æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡');
              logMessage_Info('[æ¸¸å®¢æç¤º] è¯·ä¿å­˜å½“å‰åœ°å€ï¼Œä¸¢å¤±åæ— æ³•æ¢å¤æ‚¨çš„æ•°æ®ï¼5åˆ†é’Ÿä¸æ´»è·ƒä¼šè¯å°†è¢«æ¸…ç†ã€‚');
            } else {
              logMessage_Info('[æ³¨å†Œç”¨æˆ·] æ‚¨çš„çŠ¶æ€å·²å…³è”åˆ°è´¦å·ï¼Œå¯åœ¨ä»»ä½•è®¾å¤‡ç™»å½•æ¢å¤ã€‚');
            }
          }, 1000);
        } else {
          // ç™»å½•å¤±è´¥ (result.success is false)
          // (ä¿®æ­£ï¼šç§»é™¤äº†é‡å¤çš„2FAæ£€æŸ¥é€»è¾‘)

          setButtonLoading('auth-login-btn', false);
          showButtonError('auth-login-btn', 'ç™»å½•å¤±è´¥');
          showModalAlert(result.message || 'ç™»å½•å¤±è´¥', 'ç™»å½•å¤±è´¥');
        }
      } catch (e) {
        logMessage_Error('ç™»å½•è¯·æ±‚å¤±è´¥:', e);
        setButtonLoading('auth-login-btn', false);
        showButtonError('auth-login-btn', 'ç½‘ç»œé”™è¯¯');
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'ç™»å½•å¤±è´¥');
      }
    }

    // 2FAéªŒè¯å¤„ç†
    async function handle2FAVerify() {
      const codeInput = $('auth-2fa-code');
      const code = codeInput ? codeInput.value.trim() : '';

      // éªŒè¯è¾“å…¥ï¼šå¿…é¡»æ˜¯6ä½æ•°å­—
      if (!code || code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
        // showAuthError('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æ•°å­—éªŒè¯ç ');
        showModalAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æ•°å­—éªŒè¯ç ', '2FAéªŒè¯å¤±è´¥');
        return;
      }

      if (!window.temp2FAUsername) {
        // showAuthError('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        showModalAlert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', '2FAéªŒè¯å¤±è´¥');
        // è¿”å›ç™»å½•è¡¨å•
        const loginForm = $('auth-login-form');
        const tfaForm = $('auth-2fa-form');
        if (loginForm) loginForm.classList.remove('hidden');
        if (tfaForm) tfaForm.classList.add('hidden');
        return;
      }

      setButtonLoading('auth-2fa-verify-btn', true, 'éªŒè¯ä¸­...');

      try {
        const response = await fetch('/auth/2fa/verify_login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID || null
          },
          credentials: 'include',
          body: JSON.stringify({
            auth_username: window.temp2FAUsername,
            code: code
          })
        });

        const result = await response.json();

        if (result.success) {
          // æ¸…ç©ºä¸´æ—¶æ•°æ®
          delete window.temp2FAUsername;

          // è®¾ç½®sessionUUID
          if (result.session_id) {
            sessionUUID = result.session_id;
            logMessage_Info('[2FAéªŒè¯æˆåŠŸ] ä¼šè¯IDå·²è®¾ç½®:', sessionUUID.substring(0, 16) + '...');
          }

          showButtonSuccess('auth-2fa-verify-btn', 'éªŒè¯æˆåŠŸ', 800);
          showAuthSuccess('2FAéªŒè¯æˆåŠŸï¼');

          // ç³»ç»Ÿè´¦å·ç™»å½•æˆåŠŸåï¼Œæ˜¾ç¤ºä¼šè¯é€‰æ‹©å™¨
          if (!result.is_guest) {
            setTimeout(() => {
              setButtonLoading('auth-2fa-verify-btn', false);

              // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºä¼šè¯é€‰æ‹©å™¨æ¨¡æ€æ¡†
              $('auth-login-container').classList.add('hidden');
              showSessionPicker();

              logMessage_Info('[ä¼šè¯é€‰æ‹©] è¯·é€‰æ‹©è¦è¿›å…¥çš„ä¼šè¯ï¼Œæˆ–åˆ›å»ºæ–°ä¼šè¯');
              logMessage_Info('[æç¤º] æ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€');

              // é‡ç½®è¡¨å•
              const loginForm = $('auth-login-form');
              const tfaForm = $('auth-2fa-form');
              if (loginForm) loginForm.classList.remove('hidden');
              if (tfaForm) tfaForm.classList.add('hidden');
              if (codeInput) codeInput.value = '';
            }, 1000);
          }
        } else {
          setButtonLoading('auth-2fa-verify-btn', false);
          showButtonError('auth-2fa-verify-btn', 'éªŒè¯å¤±è´¥');
          // showAuthError(result.message || 'éªŒè¯ç é”™è¯¯');
          showModalAlert(result.message || 'éªŒè¯ç é”™è¯¯', '2FAéªŒè¯å¤±è´¥');
          // æ¸…ç©ºéªŒè¯ç è¾“å…¥æ¡†
          if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
          }
        }
      } catch (e) {
        logMessage_Error('2FAéªŒè¯è¯·æ±‚å¤±è´¥:', e);
        setButtonLoading('auth-2fa-verify-btn', false);
        showButtonError('auth-2fa-verify-btn', 'ç½‘ç»œé”™è¯¯');
        // showAuthError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', '2FAéªŒè¯å¤±è´¥');
      }
    }

    // ç”¨æˆ·æ³¨å†Œ
    async function handleAuthRegister() {
      // 1. è·å–æ‰€æœ‰å­—æ®µçš„å€¼
      const username = $('auth-reg-username').value.trim();
      const phone = $('auth-reg-phone').value.trim();
      const smsCode = $('auth-reg-sms-code').value.trim();
      const nickname_Raw = $('auth-reg-nickname').value.trim();


      let nickname;
      if (nickname_Raw === '' || nickname_Raw === null) {
        // å¦‚æœæ˜µç§°ä¸ºç©ºï¼Œä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ˜µç§°
        nickname = username; // èµ‹å€¼
      } else {
        nickname = nickname_Raw; // èµ‹å€¼
      }


      const avatarFile = registrationCroppedAvatarBlob; // è·å–è£å‰ªåçš„æ–‡ä»¶ Blob
      const password = $('auth-reg-password').value.trim();
      const passwordConfirm = $('auth-reg-password-confirm').value.trim();

      // 2. éªŒè¯è¾“å…¥
      // éªŒè¯å¿…å¡«å­—æ®µï¼ˆæ˜µç§°å¯é€‰ï¼‰
      if (!username || !password || !passwordConfirm) {
        // showAuthError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆç”¨æˆ·åã€å¯†ç ï¼‰');
        showModalAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆç”¨æˆ·åã€å¯†ç ï¼‰', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      // éªŒè¯ç”¨æˆ·åï¼ˆå·²åœ¨ input äº‹ä»¶å¤„ç†ï¼Œæ­¤å¤„ä¸ºåŒé‡ä¿é™©ï¼‰
      const usernameValidation = validateInput(username, 'username');
      if (!usernameValidation.valid) {
        // showAuthError(usernameValidation.message);
        showModalAlert(usernameValidation.message, 'æ³¨å†Œå¤±è´¥');
        return;
      }
      // å†æ¬¡ç¡®è®¤æ— ä¸­æ–‡
      if (/[ä¸€-é¾¥]/.test(username)) {
        //  showAuthError('ç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦');
        showModalAlert('ç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      // éªŒè¯å¯†ç 
      const passwordValidation = validateInput(password, 'password');
      if (!passwordValidation.valid) {
        // showAuthError(passwordValidation.message);
        showModalAlert(passwordValidation.message, 'æ³¨å†Œå¤±è´¥');
        return;
      }

      if (password !== passwordConfirm) {
        // showAuthError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        showModalAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      // éªŒè¯æ‰‹æœºå·ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
      if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
        // showAuthError('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼');
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      if (phone) {
        try {
          const bindResult = await callPythonAPI_raw('/api/auth/check_phone', 'POST', { phone: phone });

          if (bindResult && bindResult.is_bound) {
            // å¦‚æœæ‰‹æœºå·å·²è¢«ç»‘å®šï¼Œå¼¹å‡ºæ‹Ÿæ€çª—è­¦å‘Š
            const confirmed = await jsShowConfirm(
              'æ‰‹æœºå·å·²è¢«ç»‘å®š',
              `æ‚¨è¾“å…¥çš„æ‰‹æœºå· ${phone} å·²è¢«ç”¨æˆ· ${bindResult.bound_to_user} ç»‘å®šã€‚\n\næ˜¯å¦ç»§ç»­æ³¨å†Œï¼Ÿ\n\nå¦‚æœç»§ç»­ï¼Œè¯¥æ‰‹æœºå·å°†ä»åŸè´¦å·ä¸Šå¼ºåˆ¶è§£ç»‘ã€‚`
            );

            if (!confirmed) {
              logMessage_Info("[æ³¨å†Œ] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œå› ä¸ºæ‰‹æœºå·å·²è¢«ç»‘å®šã€‚");
              return; // ç”¨æˆ·å–æ¶ˆï¼Œåœæ­¢æ³¨å†Œ
            }
            // ç”¨æˆ·ç¡®è®¤ï¼Œç»§ç»­æ‰§è¡Œæ³¨å†Œï¼ˆåç«¯ä¼šè‡ªåŠ¨å¤„ç†è§£ç»‘ï¼‰
            logMessage_Info("[æ³¨å†Œ] ç”¨æˆ·å·²ç¡®è®¤å¼ºåˆ¶è§£ç»‘æ‰‹æœºå·ï¼Œç»§ç»­æ³¨å†Œ...");
          }
        } catch (e) {
          logMessage_Error('æ£€æŸ¥æ‰‹æœºå·ç»‘å®šå¤±è´¥:', e);
          showModalAlert(`æ£€æŸ¥æ‰‹æœºå·å¤±è´¥: ${e.message}ï¼Œè¯·ç¨åé‡è¯•`, 'ç½‘ç»œé”™è¯¯');
          return;
        }
      }
      // ==============================================================================

      // æ³¨æ„ï¼šåç«¯çš„ APP_CONFIG.reg_verify_enabled ä¼šå†³å®šæ˜¯å¦*å¼ºåˆ¶*è¦æ±‚æ‰‹æœºå’ŒéªŒè¯ç 
      // å‰ç«¯åœ¨è¿™é‡ŒåªåšåŸºæœ¬æ ¼å¼æ ¡éªŒ

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      setButtonLoading('auth-register-btn', true, 'æ³¨å†Œä¸­...');

      // 3. åˆ›å»º FormData
      const formData = new FormData();
      formData.append('auth_username', username);
      formData.append('auth_password', password);
      formData.append('phone', phone);
      formData.append('nickname', nickname);
      formData.append('sms_code', smsCode);

      // 4. æ·»åŠ å¤´åƒæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (avatarFile) {
        // åç«¯æœŸæœ›çš„å­—æ®µåæ˜¯ 'avatar'
        // 'avatar.jpg' æ˜¯æˆ‘ä»¬åœ¨ confirmCropForRegistration ä¸­è®¾ç½®çš„é»˜è®¤æ–‡ä»¶å
        formData.append('avatar', avatarFile, avatarFile.name || 'avatar.jpg');
      }

      try {
        // 5. ä¿®æ”¹ fetch è¯·æ±‚
        const response = await fetch('/auth/register', {
          method: 'POST',
          // ç§»é™¤ headersï¼Œæµè§ˆå™¨ä¼šä¸º FormData è‡ªåŠ¨è®¾ç½® Content-Type: multipart/form-data
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showButtonSuccess('auth-register-btn', 'æ³¨å†ŒæˆåŠŸ');
          showAuthSuccess('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');

          // // æ³¨å†ŒæˆåŠŸåï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾é¡µå¹¶å¡«å……ç”¨æˆ·å
          // setTimeout(() => {
          //   setButtonLoading('auth-register-btn', false);
          //   // åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾
          //   switchAuthTab('login');
          //   // å¡«å……ç”¨æˆ·å
          //   $('auth-username').value = username;
          //   // èšç„¦åˆ°å¯†ç æ¡†ï¼Œæç¤ºç”¨æˆ·è¾“å…¥å¯†ç ç™»å½•
          //   $('auth-password').focus(); 
          // }, 1500);
        } else {
          setButtonLoading('auth-register-btn', false);
          showButtonError('auth-register-btn', 'æ³¨å†Œå¤±è´¥');
          // showAuthError(result.message || 'æ³¨å†Œå¤±è´¥');
          showModalAlert(result.message || 'æ³¨å†Œå¤±è´¥', 'æ³¨å†Œå¤±è´¥');
        }
      } catch (e) {
        logMessage_Error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', e);
        setButtonLoading('auth-register-btn', false);
        showButtonError('auth-register-btn', 'ç½‘ç»œé”™è¯¯');
        // showAuthError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'æ³¨å†Œå¤±è´¥');
      } finally {
        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ¸…ç©ºæš‚å­˜çš„ Blob
        registrationCroppedAvatarBlob = null;
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        setButtonLoading('auth-register-btn', false);
      }
    }

    // æ¸¸å®¢ç™»å½•
    async function handleGuestLogin() {
      try {
        // æ¸¸å®¢ç™»å½•æ—¶ç”Ÿæˆæ–°UUID
        const newUUID = generateUUID();

        const response = await fetch('/auth/guest_login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': newUUID
          }
        });

        const result = await response.json();

        if (result.success) {
          showAuthSuccess('ä»¥æ¸¸å®¢èº«ä»½ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...');
          setTimeout(() => {
            // è·³è½¬åˆ°æ–°çš„UUIDåœ°å€
            window.location.href = `/uuid=${newUUID}`;
          }, 1000);
        } else {
          // showAuthError(result.message || 'æ¸¸å®¢ç™»å½•å¤±è´¥');
          showModalAlert(result.message || 'æ¸¸å®¢ç™»å½•å¤±è´¥', 'ç™»å½•å¤±è´¥');
        }
      } catch (e) {
        // showAuthError('æ¸¸å®¢ç™»å½•è¯·æ±‚å¤±è´¥ï¼š' + e.message);
        showModalAlert('æ¸¸å®¢ç™»å½•è¯·æ±‚å¤±è´¥ï¼š' + e.message, 'ç™»å½•å¤±è´¥');
      }
    }

    // ç”ŸæˆUUIDçš„è¾…åŠ©å‡½æ•°
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // ====================
    // è®¤è¯äº‹ä»¶ç»‘å®š
    // ====================

    // åœ¨DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
    if (typeof window !== 'undefined') {
      window.addEventListener('load', () => {
        // è®¤è¯æ ‡ç­¾åˆ‡æ¢
        const loginTab = $('auth-tab-login');
        const registerTab = $('auth-tab-register');
        if (loginTab) loginTab.addEventListener('click', () => switchAuthTab('login'));
        if (registerTab) registerTab.addEventListener('click', () => switchAuthTab('register'));

        // ç™»å½•æŒ‰é’®
        const loginBtn = $('auth-login-btn');
        if (loginBtn) loginBtn.addEventListener('click', handleAuthLogin);

        // æ³¨å†ŒæŒ‰é’®
        const registerBtn = $('auth-register-btn');
        if (registerBtn) registerBtn.addEventListener('click', handleAuthRegister);

        // æ¸¸å®¢ç™»å½•æŒ‰é’®
        const guestBtn = $('auth-guest-btn');
        if (guestBtn) guestBtn.addEventListener('click', handleGuestLogin);

        // 2FAéªŒè¯æŒ‰é’®
        const tfa2VerifyBtn = $('auth-2fa-verify-btn');
        if (tfa2VerifyBtn) tfa2VerifyBtn.addEventListener('click', handle2FAVerify);

        // 2FAè¿”å›æŒ‰é’®
        const tfa2BackBtn = $('auth-2fa-back-btn');
        if (tfa2BackBtn) tfa2BackBtn.addEventListener('click', () => {
          const loginForm = $('auth-login-form');
          const tfaForm = $('auth-2fa-form');
          if (loginForm) loginForm.classList.remove('hidden');
          if (tfaForm) tfaForm.classList.add('hidden');
          // æ¸…ç©º2FAç›¸å…³æ•°æ®
          delete window.temp2FAUsername;
          const tfaCodeInput = $('auth-2fa-code');
          if (tfaCodeInput) tfaCodeInput.value = '';
        });

        // ç›‘å¬Enteré”®è§¦å‘ç™»å½•æ“ä½œ
        const authUsername = $('auth-username');
        const authPassword = $('auth-password');
        if (authUsername) authUsername.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAuthLogin();
        });
        if (authPassword) authPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAuthLogin();
        });

        // ç›‘å¬Enteré”®è§¦å‘ä¸¤æ­¥éªŒè¯ï¼ˆ2FAï¼‰
        const auth2FACode = $('auth-2fa-code');
        if (auth2FACode) auth2FACode.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handle2FAVerify();
        });

        // ç›‘å¬Enteré”®è§¦å‘ç”¨æˆ·æ³¨å†Œ
        const authRegPassword = $('auth-reg-password-confirm');
        if (authRegPassword) authRegPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAuthRegister();
        });

        // ç®¡ç†é¢æ¿æŒ‰é’®ï¼ˆå¤šä¸ªä½ç½®ï¼‰
        const adminPanelBtn = $('show-admin-panel');
        if (adminPanelBtn) adminPanelBtn.addEventListener('click', () => toggleAdminPanel(true));

        const adminPanelBtnLogin = $('show-admin-panel-login');
        if (adminPanelBtnLogin) adminPanelBtnLogin.addEventListener('click', () => toggleAdminPanel(true));

        const adminPanelBtnMulti = $('show-admin-panel-multi');
        if (adminPanelBtnMulti) adminPanelBtnMulti.addEventListener('click', () => toggleAdminPanel(true));

        // å†…è”é¢æ¿ï¼ˆç™»å½•é¡µé¢ï¼‰ä¸å†æ˜¾ç¤ºæ ‡ç­¾é¡µ - ä»…æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
        // æ‰€æœ‰æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½ä»…ç”¨äºæ¨¡æ€å¯¹è¯æ¡†é¢æ¿

        const modalAdminPanel = $('admin-panel-modal');
        if (modalAdminPanel) {
          const modalUsersTab = $('admin-tab-users_modal');
          const modalGroupsTab = $('admin-tab-groups_modal');
          const modalLogsTab = $('admin-tab-logs_modal');
          const modalHealthTab = $('admin-tab-health_modal');
          const modalProfileTab = $('admin-tab-profile_modal');
          const modalSessionsTab = $('admin-tab-sessions_modal');
          // (æ–°) è·å–ç¼ºå¤±çš„æ ‡ç­¾é¡µ
          const modalMessagesTab = $('admin-tab-messages_modal');
          const modalIpbanTab = $('admin-tab-ipban_modal');
          const modalSmsTab = $('admin-tab-sms_modal');
          const modalConfigTab = $('admin-tab-config_modal');

          if (modalUsersTab) modalUsersTab.addEventListener('click', () => switchAdminTab('users'));
          if (modalGroupsTab) modalGroupsTab.addEventListener('click', () => switchAdminTab('groups'));
          if (modalLogsTab) modalLogsTab.addEventListener('click', () => switchAdminTab('logs'));
          if (modalHealthTab) modalHealthTab.addEventListener('click', () => switchAdminTab('health'));
          if (modalProfileTab) modalProfileTab.addEventListener('click', () => switchAdminTab('profile'));
          if (modalSessionsTab) modalSessionsTab.addEventListener('click', () => switchAdminTab('sessions'));
          // (æ–°) ç»‘å®šç¼ºå¤±çš„ç‚¹å‡»äº‹ä»¶
          if (modalMessagesTab) modalMessagesTab.addEventListener('click', () => switchAdminTab('messages'));
          if (modalIpbanTab) modalIpbanTab.addEventListener('click', () => switchAdminTab('ipban'));
          if (modalSmsTab) modalSmsTab.addEventListener('click', () => switchAdminTab('sms'));
          if (modalConfigTab) modalConfigTab.addEventListener('click', () => switchAdminTab('config'));

          logMessage_Info("Admin Panel Modal Tabs event listeners bound (using _modal IDs).");
        } else {
          logMessage_Error("Could not find admin panel modal element to bind tab events.");
        }

        // æ¨¡æ€æ¡†åˆ·æ–°æŒ‰é’®ï¼ˆè¿™äº›IDæ˜¯å”¯ä¸€çš„ï¼Œåªå­˜åœ¨äºæ¨¡æ€æ¡†ä¸­ï¼‰
        const refreshUsersBtnModal = $('admin-refresh-users_modal'); // ä½¿ç”¨æ–°çš„å”¯ä¸€ ID
        const refreshGroupsBtnModal = $('admin-refresh-groups_modal');
        const refreshLogsBtnModal = $('admin-refresh-logs_modal');
        const refreshHealthBtnModal = $('admin-refresh-health_modal');
        const refreshProfileBtnModal = $('admin-refresh-profile_modal');
        const refreshSessionsBtnModal = $('admin-refresh-sessions_modal');

        // ç¡®ä¿è°ƒç”¨çš„æ˜¯æ­£ç¡®çš„åŠ è½½å‡½æ•° (å®ƒä»¬ç°åœ¨å†…éƒ¨ä¼šæ“ä½œ _modal åˆ—è¡¨)
        if (refreshUsersBtnModal) refreshUsersBtnModal.addEventListener('click', loadAdminUsers);
        if (refreshGroupsBtnModal) refreshGroupsBtnModal.addEventListener('click', loadAdminGroups);
        // [ä¿®å¤] ç»‘å®šæ—¥å¿—åˆ·æ–°å’Œåˆ†é¡µæŒ‰é’®
        if (refreshLogsBtnModal) {
          refreshLogsBtnModal.addEventListener('click', () => {
            loadAdminLogs(1); // åˆ·æ–°æ€»æ˜¯å›åˆ°ç¬¬1é¡µ
          });
        }
        const logPrevPageBtn = $('log-prev-page');
        const logNextPageBtn = $('log-next-page');
        const logLimitSelect = $('log-limit-select_modal');

        if (logPrevPageBtn) {
          logPrevPageBtn.addEventListener('click', () => {
            if (currentLogPage > 1) {
              loadAdminLogs(currentLogPage - 1);
            }
          });
        }
        if (logNextPageBtn) {
          logNextPageBtn.addEventListener('click', () => {
            // (åç«¯å·²å¤„ç†äº†é¡µç æº¢å‡ºï¼Œä½†å‰ç«¯ä¹Ÿç®€å•æ£€æŸ¥ä¸€ä¸‹)
            loadAdminLogs(currentLogPage + 1);
          });
        }
        if (logLimitSelect) {
          // å½“"æ¯é¡µè¡Œæ•°"å˜åŒ–æ—¶ï¼Œå›åˆ°ç¬¬1é¡µ
          logLimitSelect.addEventListener('change', () => {
            loadAdminLogs(1);
          });
        }

        const logPageSelect = $('log-page-select');
        if (logPageSelect) {
          logPageSelect.addEventListener('change', () => {
            const newPage = parseInt(logPageSelect.value, 10);
            if (newPage && newPage !== currentLogPage) {
              loadAdminLogs(newPage);
            }
          });
        }

        if (refreshHealthBtnModal) refreshHealthBtnModal.addEventListener('click', loadHealthStatus);
        if (refreshProfileBtnModal) refreshProfileBtnModal.addEventListener('click', loadPersonalInfo);
        if (refreshSessionsBtnModal) refreshSessionsBtnModal.addEventListener('click', loadAdminSessions);
        logMessage_Info("Admin Panel Modal Refresh Buttons event listeners bound (using _modal IDs).");


        // ============================================================
        // IPå°ç¦æ¨¡æ€æ¡†éªŒè¯é€»è¾‘
        // ============================================================
        const banTypeSelect = $('ban-type');
        const banTargetInput = $('ban-target');
        const banTargetHint = $('ban-target-hint');
        const banTargetError = $('ban-target-error');



        // ç›‘å¬ç›®æ ‡è¾“å…¥æ¡†çš„å®æ—¶è¾“å…¥
        if (banTargetInput) {
          banTargetInput.addEventListener('input', validateIPBanTarget);
        }


        // ============================================================
        // IPå°ç¦æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®š (åœ¨DOMåŠ è½½åæ‰§è¡Œ)
        // ============================================================
        // const banTypeSelect = $('ban-type');
        // const banTargetInput = $('ban-target');
        // const banTargetHint = $('ban-target-hint');
        // const banTargetError = $('ban-target-error');

        // ç›‘å¬ç±»å‹é€‰æ‹©æ¡†çš„å˜åŒ–
        if (banTypeSelect) {
          banTypeSelect.addEventListener('change', () => {
            const type = banTypeSelect.value;
            if (type === 'ip') {
              if (banTargetInput) banTargetInput.placeholder = 'è¯·è¾“å…¥IPåœ°å€ (ä¾‹å¦‚: 1.2.3.4)';
              if (banTargetHint) banTargetHint.textContent = 'ç¤ºä¾‹: 1.2.3.4';
            } else if (type === 'range') {
              if (banTargetInput) banTargetInput.placeholder = 'è¯·è¾“å…¥IPèŒƒå›´ (ä¾‹å¦‚: 192.168.1.1-192.168.1.100)';
              if (banTargetHint) banTargetHint.textContent = 'ç¤ºä¾‹: 192.168.1.1-192.168.1.100';
            }
            // åˆ‡æ¢ç±»å‹æ—¶ä¹Ÿè¿›è¡Œä¸€æ¬¡éªŒè¯
            validateIPBanTarget();
          });
        }
        // ç›‘å¬ç›®æ ‡è¾“å…¥æ¡†çš„å®æ—¶è¾“å…¥
        if (banTargetInput) {
          banTargetInput.addEventListener('input', validateIPBanTarget);
        }

        // ä¼šè¯ç®¡ç†æŒ‰é’®ï¼ˆå¤šä¸ªä½ç½®ï¼‰
        const showSessionsLogin = $('show-sessions-login');
        const showSessionsMain = $('show-admin-panel');
        const showSessionsMulti = $('show-admin-panel-multi');
        if (showSessionsLogin) showSessionsLogin.addEventListener('click', () => {
          toggleAdminPanel(true);
          switchAdminTab('sessions');
        });
        if (showSessionsMain) showSessionsMain.addEventListener('click', () => {
          toggleAdminPanel(true);
          switchAdminTab('sessions');
        });
        if (showSessionsMulti) showSessionsMulti.addEventListener('click', () => {
          toggleAdminPanel(true);
          switchAdminTab('sessions');
        });

        // å†…åµŒç™»å½•é¡µé¢ç®¡ç†é¢æ¿åˆ·æ–°æŒ‰é’® (ä»…ä¼šè¯ç®¡ç†)
        const refreshSessionsInlineBtn = $('admin-refresh-sessions-inline');
        if (refreshSessionsInlineBtn) refreshSessionsInlineBtn.addEventListener('click', loadAdminSessions_inline);

        // æ–°å¢ç”¨æˆ·/æƒé™ç»„æŒ‰é’® (ä»…ç”¨äºæ¨¡æ€æ¡†)
        const createUserModalBtn = $('admin-create-user_modal');
        const createGroupModalBtn = $('admin-create-group_modal');
        if (createUserModalBtn) createUserModalBtn.addEventListener('click', showCreateUserModal);
        if (createGroupModalBtn) createGroupModalBtn.addEventListener('click', showCreateGroupModal);

        // ä¸Šå¸æ¨¡å¼åˆ‡æ¢
        const godModeCheckbox = $('god-mode-checkbox');
        const godModeCheckboxModal = $('god-mode-checkbox_modal');
        if (godModeCheckbox) godModeCheckbox.addEventListener('change', () => loadAdminSessions_inline());
        if (godModeCheckboxModal) godModeCheckboxModal.addEventListener('change', () => loadAdminSessions());

        // å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°å¼€å…³
        const healthAutoRefreshToggle = $('health-auto-refresh-toggle');
        if (healthAutoRefreshToggle) {
          healthAutoRefreshToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
              startHealthAutoRefresh();
            } else {
              stopHealthAutoRefresh();
            }
          });
        }



        const multiAddClose = $('multi-add-user-close');
        const multiAddCancel = $('multi-add-user-cancel');
        const multiAddConfirm = $('multi-add-user-confirm');

        if (multiAddClose) multiAddClose.addEventListener('click', closeMultiAddUserModal);
        if (multiAddCancel) multiAddCancel.addEventListener('click', closeMultiAddUserModal);
        if (multiAddConfirm) multiAddConfirm.addEventListener('click', submitMultiAddUser);
      });
    }

    // ====================
    // ç®¡ç†é¢æ¿åŠŸèƒ½
    // ====================

    // æƒé™ä¸­è‹±æ–‡ç¿»è¯‘æ˜ å°„
    // æƒé™ç¿»è¯‘å­—å…¸ - å°†æƒé™é”®åç¿»è¯‘ä¸ºä¸­æ–‡æ˜¾ç¤ºåç§°
    // ç¡®ä¿æ‰€æœ‰æƒé™éƒ½èƒ½è¢«æ­£ç¡®è¯†åˆ«å’Œç¿»è¯‘
    const permissionTranslations = {
      // åŸºç¡€ä»»åŠ¡æƒé™
      'view_dashboard': 'æŸ¥çœ‹ä»ªè¡¨æ¿',
      'view_tasks': 'æŸ¥çœ‹ä»»åŠ¡',
      'create_tasks': 'åˆ›å»ºä»»åŠ¡',
      'delete_tasks': 'åˆ é™¤ä»»åŠ¡',
      'start_tasks': 'å¯åŠ¨ä»»åŠ¡',
      'stop_tasks': 'åœæ­¢ä»»åŠ¡',
      'execute_tasks': 'æ‰§è¡Œä»»åŠ¡',
      'modify_tasks': 'ä¿®æ”¹ä»»åŠ¡',
      'schedule_tasks': 'å®šæ—¶ä»»åŠ¡',
      'view_history': 'æŸ¥çœ‹å†å²è®°å½•',

      // åœ°å›¾ç›¸å…³æƒé™
      'view_map': 'æŸ¥çœ‹åœ°å›¾',
      'record_path': 'è®°å½•è·¯å¾„',
      'auto_generate_path': 'è‡ªåŠ¨ç”Ÿæˆè·¯å¾„',

      // é€šçŸ¥æƒé™
      'view_notifications': 'æŸ¥çœ‹é€šçŸ¥',
      'mark_notifications_read': 'æ ‡è®°é€šçŸ¥å·²è¯»',
      'send_notifications': 'å‘é€é€šçŸ¥',
      'manage_notifications': 'ç®¡ç†é€šçŸ¥',

      // ç”¨æˆ·ä¿¡æ¯æƒé™
      'view_user_details': 'æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…',
      'modify_user_settings': 'ä¿®æ”¹ç”¨æˆ·è®¾ç½®',
      'view_users': 'æŸ¥çœ‹ç”¨æˆ·',
      'ban_users': 'å°ç¦ç”¨æˆ·',

      // å¤šè´¦å·å’Œç­¾åˆ°æƒé™
      'execute_multi_account': 'æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡',
      'use_attendance': 'ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½',

      // æ—¥å¿—æƒé™
      'view_logs': 'æŸ¥çœ‹æ—¥å¿—',
      'clear_logs': 'æ¸…ç©ºæ—¥å¿—',

      // ç®¡ç†æƒé™
      'manage_users': 'ç®¡ç†ç”¨æˆ·',
      'create_users': 'åˆ›å»ºç”¨æˆ·',
      'delete_users': 'åˆ é™¤ç”¨æˆ·',
      'manage_permissions': 'ç®¡ç†æƒé™',
      'manage_groups': 'ç®¡ç†æƒé™ç»„',
      'assign_permissions': 'åˆ†é…æƒé™',
      'reset_user_password': 'é‡ç½®ç”¨æˆ·å¯†ç ',
      'view_audit_logs': 'æŸ¥çœ‹å®¡è®¡æ—¥å¿—',
      'view_all_sessions': 'æŸ¥çœ‹æ‰€æœ‰ä¼šè¯',
      'force_logout_users': 'å¼ºåˆ¶ç”¨æˆ·ç™»å‡º',
      'manage_system': 'ç³»ç»Ÿç®¡ç†',
      'create_permission_groups': 'åˆ›å»ºæƒé™ç»„',
      'delete_permission_groups': 'åˆ é™¤æƒé™ç»„',
      'modify_permission_groups': 'ä¿®æ”¹æƒé™ç»„',

      // ç»†åˆ†æƒé™
      'auto_fill_password': 'è‡ªåŠ¨å¡«å……å¯†ç ',
      'import_offline': 'å¯¼å…¥ç¦»çº¿æ–‡ä»¶',
      'export_data': 'å¯¼å‡ºæ•°æ®',
      'import_data': 'å¯¼å…¥æ•°æ®',
      'backup_data': 'å¤‡ä»½æ•°æ®',
      'modify_params': 'ä¿®æ”¹å‚æ•°',
      'manage_own_sessions': 'ç®¡ç†è‡ªå·±çš„ä¼šè¯',
      'manage_user_sessions': 'ç®¡ç†ç”¨æˆ·ä¼šè¯',
      'view_session_details': 'æŸ¥çœ‹ä¼šè¯è¯¦æƒ…',
      'god_mode': 'ä¸Šå¸æ¨¡å¼',

      // UIæŒ‰é’®æƒé™ï¼ˆç»†ç²’åº¦æ§åˆ¶ï¼‰
      'use_login_button': 'ä½¿ç”¨ç™»å½•æŒ‰é’®',
      'use_multi_account_button': 'ä½¿ç”¨å¤šè´¦å·æ§åˆ¶å°',
      'use_import_button': 'å¯¼å…¥ç¦»çº¿æ–‡ä»¶',

      // ç•™è¨€æ¿æƒé™
      'view_messages': 'æŸ¥çœ‹ç•™è¨€æ¿',
      'post_messages': 'å‘è¡¨ç•™è¨€',
      'delete_own_messages': 'åˆ é™¤è‡ªå·±çš„ç•™è¨€',
      'delete_any_messages': 'åˆ é™¤ä»»ä½•ç•™è¨€',
      'view_all_messages': 'æŸ¥çœ‹æ‰€æœ‰ç•™è¨€',

      // ä¼šè¯ç®¡ç†æƒé™
      'manage_sessions': 'ç®¡ç†ä¼šè¯',
      'delete_sessions': 'åˆ é™¤ä¼šè¯',

      // ç³»ç»Ÿç®¡ç†æƒé™
      'system_settings': 'ç³»ç»Ÿè®¾ç½®',
      'manage_api': 'ç®¡ç†API',

      // å…¶ä»–æƒé™
      'admin_panel': 'ç®¡ç†é¢æ¿',
      'debug_mode': 'è°ƒè¯•æ¨¡å¼'
    };

    // æƒé™ç¿»è¯‘å‡½æ•°
    // åŠŸèƒ½ï¼šå°†è‹±æ–‡æƒé™é”®åè½¬æ¢ä¸ºä¸­æ–‡ç¿»è¯‘
    // ä¼˜å…ˆä½¿ç”¨ permissionTranslations ä¸­é¢„å®šä¹‰çš„ç¿»è¯‘ï¼Œ
    // å¦‚æœæœªå®šä¹‰åˆ™æ™ºèƒ½è§£ææƒé™é”®åå¹¶ç”Ÿæˆåˆç†çš„ä¸­æ–‡ç¿»è¯‘
    function translatePermission(permissionKey) {
      // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é¢„å®šä¹‰çš„ç¿»è¯‘
      // å¦‚æœ permissionTranslations å¯¹è±¡ä¸­å·²ç»å®šä¹‰äº†è¯¥æƒé™çš„ä¸­æ–‡ç¿»è¯‘ï¼Œç›´æ¥è¿”å›
      if (permissionTranslations[permissionKey]) {
        return permissionTranslations[permissionKey];
      }

      // ç¬¬äºŒæ­¥ï¼šå¦‚æœæ²¡æœ‰é¢„å®šä¹‰ç¿»è¯‘ï¼Œè¿›è¡Œæ™ºèƒ½ç¿»è¯‘
      // åˆ›å»ºå¸¸è§åŠ¨è¯çš„ä¸­è‹±æ–‡æ˜ å°„è¡¨
      // è¿™äº›æ˜¯æƒé™ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„æ“ä½œåŠ¨è¯
      const verbMap = {
        'view': 'æŸ¥çœ‹',           // æŸ¥çœ‹ã€æµè§ˆæ“ä½œ
        'create': 'åˆ›å»º',         // åˆ›å»ºã€æ–°å»ºæ“ä½œ
        'delete': 'åˆ é™¤',         // åˆ é™¤ã€ç§»é™¤æ“ä½œ
        'edit': 'ç¼–è¾‘',           // ç¼–è¾‘ã€ä¿®æ”¹æ“ä½œ
        'modify': 'ä¿®æ”¹',         // ä¿®æ”¹æ“ä½œ
        'update': 'æ›´æ–°',         // æ›´æ–°æ“ä½œ
        'manage': 'ç®¡ç†',         // ç®¡ç†æ“ä½œï¼ˆé€šå¸¸åŒ…å«å¤šç§å­æ“ä½œï¼‰
        'start': 'å¯åŠ¨',          // å¯åŠ¨æ“ä½œ
        'stop': 'åœæ­¢',           // åœæ­¢æ“ä½œ
        'execute': 'æ‰§è¡Œ',        // æ‰§è¡Œæ“ä½œ
        'run': 'è¿è¡Œ',            // è¿è¡Œæ“ä½œ
        'use': 'ä½¿ç”¨',            // ä½¿ç”¨æ“ä½œ
        'access': 'è®¿é—®',         // è®¿é—®æ“ä½œ
        'add': 'æ·»åŠ ',            // æ·»åŠ æ“ä½œ
        'remove': 'ç§»é™¤',         // ç§»é™¤æ“ä½œ
        'export': 'å¯¼å‡º',         // å¯¼å‡ºæ“ä½œ
        'import': 'å¯¼å…¥',         // å¯¼å…¥æ“ä½œ
        'backup': 'å¤‡ä»½',         // å¤‡ä»½æ“ä½œ
        'restore': 'æ¢å¤',        // æ¢å¤æ“ä½œ
        'assign': 'åˆ†é…',         // åˆ†é…æ“ä½œ
        'revoke': 'æ’¤é”€',         // æ’¤é”€æ“ä½œ
        'grant': 'æˆäºˆ',          // æˆäºˆæ“ä½œ
        'clear': 'æ¸…ç©º',          // æ¸…ç©ºæ“ä½œ
        'reset': 'é‡ç½®',          // é‡ç½®æ“ä½œ
        'force': 'å¼ºåˆ¶',          // å¼ºåˆ¶æ“ä½œ
        'post': 'å‘è¡¨',           // å‘è¡¨æ“ä½œ
        'send': 'å‘é€',           // å‘é€æ“ä½œ
        'receive': 'æ¥æ”¶',        // æ¥æ”¶æ“ä½œ
        'download': 'ä¸‹è½½',       // ä¸‹è½½æ“ä½œ
        'upload': 'ä¸Šä¼ ',         // ä¸Šä¼ æ“ä½œ
        'approve': 'å®¡æ‰¹',        // å®¡æ‰¹æ“ä½œ
        'reject': 'æ‹’ç»',         // æ‹’ç»æ“ä½œ
        'enable': 'å¯ç”¨',         // å¯ç”¨æ“ä½œ
        'disable': 'ç¦ç”¨',        // ç¦ç”¨æ“ä½œ
        'configure': 'é…ç½®',      // é…ç½®æ“ä½œ
        'monitor': 'ç›‘æ§'         // ç›‘æ§æ“ä½œ
      };

      // åˆ›å»ºå¸¸è§åè¯çš„ä¸­è‹±æ–‡æ˜ å°„è¡¨
      // è¿™äº›æ˜¯æƒé™ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„èµ„æºå¯¹è±¡
      const nounMap = {
        'users': 'ç”¨æˆ·',          // ç”¨æˆ·
        'user': 'ç”¨æˆ·',           // å•æ•°å½¢å¼çš„ç”¨æˆ·
        'tasks': 'ä»»åŠ¡',          // ä»»åŠ¡
        'task': 'ä»»åŠ¡',           // å•æ•°å½¢å¼çš„ä»»åŠ¡
        'logs': 'æ—¥å¿—',           // æ—¥å¿—
        'log': 'æ—¥å¿—',            // å•æ•°å½¢å¼çš„æ—¥å¿—
        'sessions': 'ä¼šè¯',       // ä¼šè¯
        'session': 'ä¼šè¯',        // å•æ•°å½¢å¼çš„ä¼šè¯
        'notifications': 'é€šçŸ¥',  // é€šçŸ¥
        'notification': 'é€šçŸ¥',   // å•æ•°å½¢å¼çš„é€šçŸ¥
        'messages': 'ç•™è¨€',       // ç•™è¨€/æ¶ˆæ¯
        'message': 'ç•™è¨€',        // å•æ•°å½¢å¼çš„ç•™è¨€
        'permissions': 'æƒé™',    // æƒé™
        'permission': 'æƒé™',     // å•æ•°å½¢å¼çš„æƒé™
        'groups': 'æƒé™ç»„',       // æƒé™ç»„
        'group': 'æƒé™ç»„',        // å•æ•°å½¢å¼çš„æƒé™ç»„
        'settings': 'è®¾ç½®',       // è®¾ç½®
        'setting': 'è®¾ç½®',        // å•æ•°å½¢å¼çš„è®¾ç½®
        'system': 'ç³»ç»Ÿ',         // ç³»ç»Ÿ
        'api': 'API',             // APIï¼ˆä¿æŒå¤§å†™ï¼‰
        'data': 'æ•°æ®',           // æ•°æ®
        'files': 'æ–‡ä»¶',          // æ–‡ä»¶
        'file': 'æ–‡ä»¶',           // å•æ•°å½¢å¼çš„æ–‡ä»¶
        'accounts': 'è´¦å·',       // è´¦å·
        'account': 'è´¦å·',        // å•æ•°å½¢å¼çš„è´¦å·
        'password': 'å¯†ç ',       // å¯†ç 
        'passwords': 'å¯†ç ',      // å¤æ•°å½¢å¼çš„å¯†ç 
        'panel': 'é¢æ¿',          // é¢æ¿
        'mode': 'æ¨¡å¼',           // æ¨¡å¼
        'button': 'æŒ‰é’®',         // æŒ‰é’®
        'buttons': 'æŒ‰é’®',        // å¤æ•°å½¢å¼çš„æŒ‰é’®
        'audit': 'å®¡è®¡',          // å®¡è®¡
        'details': 'è¯¦æƒ…',        // è¯¦æƒ…
        'detail': 'è¯¦æƒ…',         // å•æ•°å½¢å¼çš„è¯¦æƒ…
        'params': 'å‚æ•°',         // å‚æ•°
        'param': 'å‚æ•°',          // å•æ•°å½¢å¼çš„å‚æ•°
        'offline': 'ç¦»çº¿æ–‡ä»¶',    // ç¦»çº¿æ–‡ä»¶
        'multi': 'å¤š',            // å¤šï¼ˆç”¨äºå¤åˆè¯ï¼‰
        'own': 'è‡ªå·±çš„',          // è‡ªå·±çš„
        'all': 'æ‰€æœ‰',            // æ‰€æœ‰
        'any': 'ä»»ä½•',            // ä»»ä½•
        'attendance': 'ç­¾åˆ°',     // ç­¾åˆ°åŠŸèƒ½
        'console': 'æ§åˆ¶å°',      // æ§åˆ¶å°
        'logout': 'ç™»å‡º',         // ç™»å‡º
        'login': 'ç™»å½•',          // ç™»å½•
        'admin': 'ç®¡ç†',          // ç®¡ç†
        'god': 'ä¸Šå¸',            // ä¸Šå¸ï¼ˆç‰¹æ®Šæƒé™ï¼‰
        'debug': 'è°ƒè¯•'           // è°ƒè¯•
      };

      // ç¬¬ä¸‰æ­¥ï¼šè§£ææƒé™é”®å
      // å°†æƒé™é”®åæŒ‰ä¸‹åˆ’çº¿åˆ†å‰²æˆå•è¯æ•°ç»„
      // ä¾‹å¦‚ï¼š"view_user_logs" -> ["view", "user", "logs"]
      const words = permissionKey.toLowerCase().split('_');

      // ç¬¬å››æ­¥ï¼šç¿»è¯‘æ¯ä¸ªå•è¯
      // åˆ›å»ºä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨ç¿»è¯‘åçš„ä¸­æ–‡å•è¯
      const translatedWords = [];

      // éå†åˆ†å‰²åçš„æ¯ä¸ªè‹±æ–‡å•è¯
      for (let i = 0; i < words.length; i++) {
        const word = words[i]; // å½“å‰å¤„ç†çš„å•è¯

        // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºåŠ¨è¯ï¼ˆé€šå¸¸åŠ¨è¯åœ¨æœ€å‰é¢ï¼‰
        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå•è¯ä¸”åœ¨åŠ¨è¯æ˜ å°„è¡¨ä¸­æ‰¾åˆ°äº†å¯¹åº”ç¿»è¯‘
        if (i === 0 && verbMap[word]) {
          translatedWords.push(verbMap[word]);
        }
        // æ£€æŸ¥æ˜¯å¦ä¸ºåè¯
        // å¦‚æœåœ¨åè¯æ˜ å°„è¡¨ä¸­æ‰¾åˆ°äº†å¯¹åº”ç¿»è¯‘
        else if (nounMap[word]) {
          translatedWords.push(nounMap[word]);
        }
        // å¦‚æœæ—¢ä¸æ˜¯å·²çŸ¥åŠ¨è¯ä¹Ÿä¸æ˜¯å·²çŸ¥åè¯
        // ä¿ç•™åŸå§‹å•è¯ä½†è¿›è¡Œé¦–å­—æ¯å¤§å†™å¤„ç†ï¼Œä½¿å…¶æ›´æ˜“è¯»
        else {
          // å°†å•è¯é¦–å­—æ¯å¤§å†™ï¼Œå…¶ä½™å­—æ¯å°å†™
          // ä¾‹å¦‚ï¼š"unknown" -> "Unknown"
          translatedWords.push(word.charAt(0).toUpperCase() + word.slice(1));
        }
      }

      // ç¬¬äº”æ­¥ï¼šç»„åˆç¿»è¯‘ç»“æœ
      // å°†æ‰€æœ‰ç¿»è¯‘åçš„ä¸­æ–‡å•è¯æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
      // ä¾‹å¦‚ï¼š["æŸ¥çœ‹", "ç”¨æˆ·", "æ—¥å¿—"] -> "æŸ¥çœ‹ç”¨æˆ·æ—¥å¿—"
      const result = translatedWords.join('');

      // ç¬¬å…­æ­¥ï¼šè¿”å›æ™ºèƒ½ç¿»è¯‘çš„ç»“æœ
      // å¦‚æœç¿»è¯‘æˆåŠŸï¼Œè¿”å›ä¸­æ–‡ç¿»è¯‘ï¼›å¦åˆ™è¿”å›åŸå§‹æƒé™é”®å
      // è¿™ç¡®ä¿äº†å³ä½¿ç¿»è¯‘å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´åŠŸèƒ½å¼‚å¸¸
      return result || permissionKey;
    }

    // åœ¨ toggleAdminPanel å‡½æ•°å†…éƒ¨æˆ–ä¹‹å‰æ·»åŠ ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥æ£€æŸ¥æƒé™
    async function checkAdminPermission(permissionName) {
      try {
        // å‡è®¾ sessionUUID å­˜å‚¨äº†å½“å‰ä¼šè¯ID
        const response = await fetch('/auth/check_permission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ permission: permissionName })
        });
        const result = await response.json();
        return result.success && result.has_permission;
      } catch (e) {
        logMessage_Error(`æ£€æŸ¥æƒé™ ${permissionName} å¤±è´¥:`, e);
        return false;
      }
    }

    async function toggleAdminPanel(show, skipAuthCheck = false) {
      const modal = $('admin-panel-modal');
      const usersTab = $('admin-tab-users_modal');
      const groupsTab = $('admin-tab-groups_modal');
      const logsTab = $('admin-tab-logs_modal');
      const healthTab = $('admin-tab-health_modal');
      const profileTab = $('admin-tab-profile_modal');
      const sessionsTab = $('admin-tab-sessions_modal'); // ä¼šè¯æ ‡ç­¾é¡µæŒ‰é’®
      const messagesTab = $('admin-tab-messages_modal'); // ç•™è¨€æ¿æ ‡ç­¾é¡µæŒ‰é’®
      const ipbanTab = $('admin-tab-ipban_modal'); // é—®é¢˜2ä¿®å¤ï¼šIPå°ç¦æ ‡ç­¾
      const smsTab = $('admin-tab-sms_modal'); // é—®é¢˜2ä¿®å¤ï¼šçŸ­ä¿¡é…ç½®æ ‡ç­¾
      const configTab = $('admin-tab-config_modal'); // æ–°å¢ï¼šç³»ç»Ÿé…ç½®æ ‡ç­¾
      const godModeToggle = $('god-mode-toggle_modal');

      if (show) {
        // ===================================================================
        // ã€ä¿®å¤1ã€‘canViewLogså˜é‡ä½œç”¨åŸŸé—®é¢˜ä¿®å¤
        // é—®é¢˜æè¿°ï¼šcanViewLogsåŸæœ¬åœ¨tryå—å†…ç”¨letå£°æ˜ï¼Œå¯¼è‡´åœ¨å¤–éƒ¨æ— æ³•è®¿é—®
        // è§£å†³æ–¹æ¡ˆï¼šå°†canViewLogså£°æ˜æå‡åˆ°ifå—ä½œç”¨åŸŸï¼Œä½¿å…¶åœ¨æ•´ä¸ªif (show)å—ä¸­å¯è§
        // ===================================================================
        let canViewMessages = false;
        let canManageSystem = false;
        let hasGodMode = false; // <-- ä¿®æ­£ #1: åœ¨æ­¤å¤„å£°æ˜å˜é‡å¹¶è®¾ç½®é»˜è®¤å€¼
        let isAuthenticated = skipAuthCheck;
        let canManageUsers = false; // <-- ä¿®æ­£ #1.1: å£°æ˜ canManageUsers
        let canViewLogs = false; // â˜…â˜…â˜… ä¿®å¤ï¼šå°†canViewLogså£°æ˜æå‡åˆ°å¤–å±‚ä½œç”¨åŸŸ â˜…â˜…â˜…

        if (!skipAuthCheck) {
          // --- æ€§èƒ½ä¼˜åŒ–ï¼šå¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æƒé™ ---
          try {
            const permissionChecks = await Promise.all([
              checkAdminPermission('manage_users'),
              checkAdminPermission('view_messages'),
              checkAdminPermission('manage_system'),
              checkAdminPermission('god_mode'), // <-- ä¿®æ­£ #2: æ·»åŠ  'god_mode' æƒé™æ£€æŸ¥
              checkAuthStatus(),
              checkAdminPermission('view_logs')
            ]);

            canManageUsers = permissionChecks[0];
            canViewMessages = permissionChecks[1];
            canManageSystem = permissionChecks[2];
            hasGodMode = permissionChecks[3]; // <-- ä¿®æ­£ #3: ä¸º hasGodMode èµ‹å€¼
            isAuthenticated = permissionChecks[4];
            canViewLogs = permissionChecks[5]; // â˜…â˜…â˜… ä¿®å¤ï¼šç§»é™¤letå…³é”®å­—ï¼Œä½¿ç”¨å¤–å±‚å˜é‡ â˜…â˜…â˜…

          } catch (e) {
            logMessage_Error('å¹¶è¡Œæ£€æŸ¥æƒé™æ—¶å‡ºé”™:', e);
            // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ‰€æœ‰æƒé™é»˜è®¤ä¸º false
            canManageUsers = false;
            canViewMessages = false;
            canManageSystem = false;
            hasGodMode = false;
            isAuthenticated = false; // è§†ä¸ºæœªè®¤è¯
            canViewLogs = false; // â˜…â˜…â˜… ä¿®å¤ï¼šç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹canViewLogsä¹Ÿæœ‰é»˜è®¤å€¼ â˜…â˜…â˜…
          }
        }

        const isGuest = currentUserIsGuest;

        // (æ–°) ä¿®å¤ï¼šä¸º users, groups, logs, health æ·»åŠ æ˜¾ç¤ºé€»è¾‘
        if (usersTab) usersTab.style.display = canManageUsers ? 'block' : 'none';
        if (groupsTab) groupsTab.style.display = canManageUsers ? 'block' : 'none';
        // ===================================================================
        // ã€ä¿®å¤2ã€‘ç®¡ç†å‘˜æ ‡ç­¾é¡µæ˜¾ç¤ºé€»è¾‘
        // åŠŸèƒ½è¯´æ˜ï¼šæ ¹æ®canViewLogsæƒé™æ§åˆ¶æ—¥å¿—å’Œå¥åº·çŠ¶æ€æ ‡ç­¾çš„æ˜¾ç¤º
        // æƒé™è¦æ±‚ï¼šéœ€è¦'view_logs'æƒé™ï¼ˆç®¡ç†å‘˜ç»„é»˜è®¤æ‹¥æœ‰æ­¤æƒé™ï¼‰
        // ===================================================================
        if (logsTab) logsTab.style.display = canViewLogs ? 'block' : 'none';
        if (healthTab) healthTab.style.display = canViewLogs ? 'block' : 'none';


        // é—®é¢˜2ä¿®å¤ï¼šIPå°ç¦å’ŒçŸ­ä¿¡é…ç½®æ ‡ç­¾åªå¯¹ç®¡ç†å‘˜æ˜¾ç¤º
        if (ipbanTab) ipbanTab.style.display = canManageUsers ? 'block' : 'none';
        if (smsTab) smsTab.style.display = canManageUsers ? 'block' : 'none';
        // ===================================================================
        // ã€ä¿®å¤3ã€‘ç³»ç»Ÿé…ç½®æ ‡ç­¾æ˜¾ç¤ºé€»è¾‘
        // åŠŸèƒ½è¯´æ˜ï¼šæ ¹æ®canManageSystemæƒé™æ§åˆ¶ç³»ç»Ÿé…ç½®æ ‡ç­¾çš„æ˜¾ç¤º
        // æƒé™è¦æ±‚ï¼šéœ€è¦'manage_system'æƒé™ï¼ˆä»…ç®¡ç†å‘˜æ‹¥æœ‰ï¼‰
        // ===================================================================
        if (configTab) configTab.style.display = canManageSystem ? 'block' : 'none';

        // æ¸¸å®¢æ¨¡å¼ï¼šåªæ˜¾ç¤ºä¼šè¯ç®¡ç†å’Œç•™è¨€æ¿ï¼Œéšè—ä¸ªäººä¿¡æ¯
        if (isGuest) {
          if (profileTab) profileTab.style.display = 'none';  // æ¸¸å®¢ä¸æ˜¾ç¤ºä¸ªäººä¿¡æ¯æ ‡ç­¾
          if (sessionsTab) sessionsTab.style.display = 'block';
          if (messagesTab) messagesTab.style.display = 'block';
          if (healthTab) healthTab.style.display = 'block'; // æ¸¸å®¢å¯ä»¥æŸ¥çœ‹å¥åº·çŠ¶æ€
        } else {
          // éæ¸¸å®¢ï¼šä¸ªäººä¿¡æ¯å’Œä¼šè¯ç®¡ç†æ ‡ç­¾é¡µå§‹ç»ˆå¯è§
          if (profileTab) profileTab.style.display = 'block';
          if (sessionsTab) sessionsTab.style.display = 'block';
          if (groupsTab) groupsTab.style.display = 'block';
        }

        // æ§åˆ¶ä¸Šå¸æ¨¡å¼å¼€å…³å¯è§æ€§
        if (godModeToggle) godModeToggle.style.display = hasGodMode ? 'flex' : 'none'; // <-- ä¿®æ­£ #4: æ­¤å¤„ hasGodMode å·²è¢«å®‰å…¨å®šä¹‰

        // --- é»˜è®¤æ˜¾ç¤ºä¼šè¯ç®¡ç†æ ‡ç­¾é¡µ ---
        switchAdminTab('sessions'); // å°†ä¼šè¯ç®¡ç†è®¾ä¸ºé»˜è®¤æ‰“å¼€çš„æ ‡ç­¾

        // --- ä¿®å¤ï¼šæ·»åŠ ä»¥ä¸‹ä¸‰è¡Œä»£ç ä»¥æ˜¾ç¤ºæ¨¡æ€æ¡† ---
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('modal-visible');
        // --- ä¿®å¤ç»“æŸ ---

      } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-visible'); // ç§»é™¤ body class
        // å…³é—­æ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      }
    }

    // åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿çš„tabå¯è§æ€§
    async function initializeInlineAdminPanel() {
      // ç®€åŒ–ç‰ˆæœ¬ - åªå¤„ç†ä¼šè¯ç®¡ç†
      const sessionsPanel = $('admin-sessions-panel');

      // ç›´æ¥åŠ è½½ä¼šè¯åˆ—è¡¨
      if (sessionsPanel) {
        loadAdminSessions_inline();
      }
    }

    // å¤„ç†ä¸»ç®¡ç†é¢æ¿æ¨¡æ€æ¡†çš„æ ‡ç­¾åˆ‡æ¢
    function switchAdminTab(tab) {
      // ============================================================
      // ä»»åŠ¡12ï¼šç®¡ç†é¢æ¿è§’è‰²éš”ç¦»
      // æ ¹æ®ç”¨æˆ·ç»„æƒé™æ§åˆ¶Tabçš„æ˜¾ç¤º/éšè—
      // ============================================================

      // è·å–å½“å‰ç”¨æˆ·çš„ç”¨æˆ·ç»„ä¿¡æ¯ï¼ˆä»å…¨å±€å˜é‡currentUserDataä¸­è¯»å–ï¼‰
      // currentUserDataåº”åœ¨ç”¨æˆ·ç™»å½•æ—¶è¢«å¡«å……ï¼ŒåŒ…å«usernameã€groupç­‰å­—æ®µ
      const userGroup = currentUserData?.group || 'user'; // é»˜è®¤ä¸ºæ™®é€šç”¨æˆ·ï¼ˆ'user'ï¼‰

      // è·å–ä¸»æ¨¡æ€æ¡†å†…çš„æ ‡ç­¾æŒ‰é’®å’Œå†…å®¹é¢æ¿çš„å¼•ç”¨ (ä½¿ç”¨ _modal åç¼€)
      const usersTab = $('admin-tab-users_modal');
      const groupsTab = $('admin-tab-groups_modal');
      const logsTab = $('admin-tab-logs_modal');
      const healthTab = $('admin-tab-health_modal');
      const profileTab = $('admin-tab-profile_modal');
      const sessionsTab = $('admin-tab-sessions_modal');
      const messagesTab = $('admin-tab-messages_modal');
      const ipbanTab = $('admin-tab-ipban_modal');
      const smsTab = $('admin-tab-sms_modal');
      const configTab = $('admin-tab-config_modal');
      const usersPanel = $('admin-users-panel_modal');
      const groupsPanel = $('admin-groups-panel_modal');
      const logsPanel = $('admin-logs-panel_modal');
      const healthPanel = $('admin-health-panel_modal');
      const profilePanel = $('admin-profile-panel_modal');
      const sessionsPanel = $('admin-sessions-panel_modal');
      const messagesPanel = $('admin-messages-panel_modal');
      const ipbanPanel = $('admin-ip-ban-modal');
      const smsPanel = $('admin-sms-config-modal');
      const configPanel = $('admin-config-panel_modal');

      // æ ¹æ®ç”¨æˆ·ç»„è¿›è¡Œæƒé™éš”ç¦»
      // å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼ˆ'user'ï¼‰ï¼Œåªæ˜¾ç¤ºå¥åº·çŠ¶æ€å’Œç•™è¨€æ¿ï¼Œéšè—ç”¨æˆ·ç»„ç®¡ç†


      // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ£€æŸ¥æ ¸å¿ƒå…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!sessionsTab || !sessionsPanel) {
        logMessage_Error("switchAdminTab: æ— æ³•æ‰¾åˆ°å¿…è¦çš„ç®¡ç†é¢æ¿å…ƒç´ ");
        return;
      }

      // é‡ç½®æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ ·å¼
      [usersTab, groupsTab, logsTab, healthTab, profileTab, sessionsTab, messagesTab, ipbanTab, smsTab, configTab].filter(t => t).forEach(t => { // æ–°å¢ configTab
        t.classList.remove('text-sky-600', 'border-sky-600');
        t.classList.add('text-slate-400', 'border-transparent');
      });

      // éšè—æ‰€æœ‰å†…å®¹é¢æ¿
      [usersPanel, groupsPanel, logsPanel, healthPanel, profilePanel, sessionsPanel, messagesPanel, ipbanPanel, smsPanel, configPanel].filter(p => p).forEach(p => { // æ–°å¢ configPanel
        p.classList.add('hidden');
      });


      // æ ¹æ®ä¼ å…¥çš„ tab å‚æ•°ï¼Œæ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®å’Œå†…å®¹é¢æ¿ï¼Œå¹¶è°ƒç”¨åŠ è½½å‡½æ•°
      if (tab === 'users') {
        usersTab.classList.add('text-sky-600', 'border-sky-600');
        usersTab.classList.remove('text-slate-400', 'border-transparent');
        usersPanel.classList.remove('hidden');
        loadAdminUsers();
        // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      } else if (tab === 'groups') {
        groupsTab.classList.add('text-sky-600', 'border-sky-600');
        groupsTab.classList.remove('text-slate-400', 'border-transparent');
        groupsPanel.classList.remove('hidden');
        loadAdminGroups();
        // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      } else if (tab === 'logs') {
        logsTab.classList.add('text-sky-600', 'border-sky-600');
        logsTab.classList.remove('text-slate-400', 'border-transparent');
        logsPanel.classList.remove('hidden');
        loadAdminLogs(1); // [ä¿®å¤] ç¡®ä¿åˆ‡æ¢åˆ°æ ‡ç­¾é¡µæ—¶æ€»æ˜¯åŠ è½½ç¬¬1é¡µ
        // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      } else if (tab === 'health') {
        healthTab.classList.add('text-sky-600', 'border-sky-600');
        healthTab.classList.remove('text-slate-400', 'border-transparent');
        healthPanel.classList.remove('hidden');
        loadHealthStatus();
        // å¯åŠ¨å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        startHealthAutoRefresh();
      } else if (tab === 'profile') {
        profileTab.classList.add('text-sky-600', 'border-sky-600');
        profileTab.classList.remove('text-slate-400', 'border-transparent');
        profilePanel.classList.remove('hidden');
        loadPersonalInfo();
        // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      } else if (tab === 'sessions') {
        sessionsTab.classList.add('text-sky-600', 'border-sky-600');
        sessionsTab.classList.remove('text-slate-400', 'border-transparent');
        sessionsPanel.classList.remove('hidden');
        loadAdminSessions();
        // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      } else if (tab === 'messages') {
        // ============================================================
        // IPå°ç¦æ£€æŸ¥ï¼šç•™è¨€æ¿åŠŸèƒ½
        // åœ¨åˆ‡æ¢åˆ°ç•™è¨€æ¿æ ‡ç­¾æ—¶ï¼Œå…ˆé€šè¿‡APIæ£€æŸ¥å½“å‰å®¢æˆ·ç«¯IPæ˜¯å¦è¢«å°ç¦
        // ============================================================
        if (messagesTab && messagesPanel) {
          // ç«‹å³æ£€æŸ¥IPå°ç¦çŠ¶æ€ï¼ˆè°ƒç”¨åç«¯APIï¼‰
          checkIPBanAndProceed('messages_only').then(isBanned => {
            if (isBanned) {
              // IPè¢«å°ç¦ï¼Œæ˜¾ç¤ºæç¤ºå¹¶é˜»æ­¢åˆ‡æ¢
              showModalAlert('æ‚¨çš„IPå·²è¢«é™åˆ¶è®¿é—®ç•™è¨€åŠŸèƒ½', 'è®¿é—®è¢«æ‹’ç»');
              // ä¸åˆ‡æ¢åˆ°messagesæ ‡ç­¾ï¼Œä¿æŒå½“å‰æ ‡ç­¾
              return;
            }

            // IPæœªè¢«å°ç¦ï¼Œæ­£å¸¸åˆ‡æ¢åˆ°ç•™è¨€æ¿æ ‡ç­¾
            messagesTab.classList.add('text-sky-600', 'border-sky-600');
            messagesTab.classList.remove('text-slate-400', 'border-transparent');
            messagesPanel.classList.remove('hidden');
            loadMessages();
            // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
            stopHealthAutoRefresh();
          }).catch(err => {
            // æ£€æŸ¥å‡ºé”™ï¼Œä¸ºå®‰å…¨èµ·è§ä¹Ÿé˜»æ­¢è®¿é—®
            logMessage_Error('[IPå°ç¦æ£€æŸ¥] æ£€æŸ¥å¤±è´¥:', err);
            showModalAlert('æ— æ³•éªŒè¯è®¿é—®æƒé™ï¼Œè¯·ç¨åé‡è¯•', 'é”™è¯¯');
          });
        }
      } else if (tab === 'ipban') {
        if (ipbanTab && ipbanPanel) {
          ipbanTab.classList.add('text-sky-600', 'border-sky-600');
          ipbanTab.classList.remove('text-slate-400', 'border-transparent');
          ipbanPanel.classList.remove('hidden');
          loadIPBans();
          // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
          stopHealthAutoRefresh();
        }
      } else if (tab === 'sms') {
        if (smsTab && smsPanel) {
          smsTab.classList.add('text-sky-600', 'border-sky-600');
          smsTab.classList.remove('text-slate-400', 'border-transparent');
          smsPanel.classList.remove('hidden');
          loadSMSConfig();
          // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
          stopHealthAutoRefresh();
        }
      } else if (tab === 'config') { // æ–°å¢
        if (configTab && configPanel) {
          configTab.classList.add('text-sky-600', 'border-sky-600');
          configTab.classList.remove('text-slate-400', 'border-transparent');
          configPanel.classList.remove('hidden');
          loadSystemConfig();
          // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
          stopHealthAutoRefresh();
        }
      } else {
        // é»˜è®¤æ˜¾ç¤ºä¸ªäººä¿¡æ¯é¡µé¢
        if (profileTab && profilePanel) {
          profileTab.classList.add('text-sky-600', 'border-sky-600');
          profileTab.classList.remove('text-slate-400', 'border-transparent');
          profilePanel.classList.remove('hidden');
          loadPersonalInfo();
        }
        // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
        stopHealthAutoRefresh();
      }
    }
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨æ•°æ®åˆ°åµŒå…¥å¼ç®¡ç†é¢æ¿
    async function loadAdminSessions_inline() {
      const listEl = $('admin-sessions-list-inline');

      if (!listEl) {
        logMessage_Error("loadAdminSessions_inline: æ— æ³•æ‰¾åˆ°ä¼šè¯åˆ—è¡¨å®¹å™¨ 'admin-sessions-list-inline'ã€‚");
        return;
      }

      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        // æ£€æŸ¥æ˜¯å¦å¼€å¯ä¸Šå¸æ¨¡å¼
        const godModeCheckbox = $('god-mode-checkbox');
        const isGodMode = godModeCheckbox && godModeCheckbox.checked;

        let response;
        if (isGodMode) {
          // ä¸Šå¸æ¨¡å¼ï¼šè·å–æ‰€æœ‰ä¼šè¯
          response = await fetch('/auth/admin/all_sessions', {
            headers: {
              'X-Session-ID': sessionUUID
            }
          });
        } else {
          // æ™®é€šæ¨¡å¼ï¼šåªè·å–å½“å‰ç”¨æˆ·çš„ä¼šè¯
          response = await fetch('/auth/user/sessions', {
            headers: {
              'X-Session-ID': sessionUUID // ç¡®ä¿ sessionUUID æ˜¯å½“å‰æœ‰æ•ˆçš„ä¼šè¯ ID
            }
          });
        }

        if (!response.ok) {
          // å¤„ç†é OK å“åº” (ä¾‹å¦‚ 401 æœªæˆæƒ, 500 æœåŠ¡å™¨é”™è¯¯)
          let errorMsg = `HTTP error ${response.status}`;
          try {
            const errorData = await response.json();
            errorMsg = errorData.message || errorMsg;
          } catch (parseError) { /* å¦‚æœé”™è¯¯å“åº”ä½“ä¸æ˜¯ JSONï¼Œåˆ™å¿½ç•¥ */ }
          throw new Error(errorMsg); // æŠ›å‡ºé”™è¯¯ï¼Œç”±ä¸‹é¢çš„ catch å—å¤„ç†
        }

        const result = await response.json()

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const sessions = result.sessions || [];

        // æ›´æ–°ä¼šè¯ä¿¡æ¯ï¼ˆä»åç«¯è·å–max_sessionsä¿¡æ¯ï¼‰
        const maxSessions = result.max_sessions !== undefined && result.max_sessions !== null ? result.max_sessions : -1;

        // è¿‡æ»¤æ‰æ— æ•ˆä¼šè¯ï¼ˆsession_id ä¸º nullã€undefined æˆ–ç©ºå­—ç¬¦ä¸²çš„ä¼šè¯ï¼‰
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');

        // æ›´æ–°ä¼šè¯è®¡æ•°æ˜¾ç¤º
        if (isGodMode) {
          updateAdminSessionCountDisplayInline(validSessions.length, -1); // ä¸Šå¸æ¨¡å¼æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
        } else {
          updateAdminSessionCountDisplayInline(validSessions.length, maxSessions);
        }

        let html = '';
        if (!currentUserIsGuest) { // <-- æ£€æŸ¥æ˜¯å¦ä¸æ˜¯æ¸¸å®¢
          // åªæœ‰éæ¸¸å®¢æ‰æ˜¾ç¤ºåˆ›å»ºæŒ‰é’®
          html += `
                  <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-lg">
                    <p class="text-sm text-slate-700 mb-2">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
                    <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">åˆ›å»ºæ–°ä¼šè¯</button>
                  </div>
                `;
        } else {
          // å¯ä»¥ç»™æ¸¸å®¢ä¸€ä¸ªæç¤ºï¼Œè¯´æ˜ä»–ä»¬åªæœ‰ä¸€ä¸ªå½“å‰ä¼šè¯
          html += `
                  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700">æ¸¸å®¢æ¨¡å¼ï¼šå½“å‰ä¼šè¯å¦‚ä¸‹ã€‚å¦‚éœ€ä½¿ç”¨å¤šä¸ªä¼šè¯ï¼Œè¯·æ³¨å†Œè´¦å·ã€‚</p>
                  </div>
                `;
        }

        if (validSessions.length === 0) {
          html += '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯</p>';
        } else {
          html += validSessions.map(session => {
            const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
            const isCurrent = session.is_current || session.session_id === sessionUUID;
            const sessionHash = session.session_hash || session.session_id.substring(0, 16); // å¦‚æœå“ˆå¸Œå€¼ä¸å­˜åœ¨ï¼Œä½¿ç”¨ä¼šè¯IDå‰16ä½ä½œä¸ºå¤‡é€‰

            // ä¸Šå¸æ¨¡å¼æ˜¾ç¤ºæ‰€æœ‰è€…ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸¸å®¢æ¨¡å¼æ ‡è¯†
            let ownerInfo = '';
            if (isGodMode) {
              if (session.username) {
                ownerInfo = `<p class="text-xs text-slate-500">åˆ›å»ºè€…: ${session.username}</p>`;
              } else {
                // æ²¡æœ‰usernameçš„ä¼šè¯è§†ä¸ºæ¸¸å®¢æ¨¡å¼
                ownerInfo = `<p class="text-xs text-amber-600">åˆ›å»ºè€…: æ¸¸å®¢æ¨¡å¼</p>`;
              }
            }

            return `
                      <div class="border ${isCurrent ? 'border-sky-500 bg-sky-50' : 'border-slate-200'} rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <p class="font-semibold text-slate-800 break-all"> ä¼šè¯ ${session.session_id} </p>
                             ${isCurrent ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2">(å½“å‰ä¼šè¯)</span></p>' : ''}
                            <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                            <p class="text-xs text-slate-500">çŠ¶æ€: ${session.is_multi_account_mode
                ? (session.login_success ? '<span class="font-semibold text-purple-600">å¤šè´¦å·æ¨¡å¼ (å·²ç™»å½•)</span>' : '<span class="font-semibold text-purple-400">å¤šè´¦å·æ¨¡å¼ (æœªç™»å½•)</span>')
                : (session.login_success ? '<span class="font-semibold text-green-600">å·²ç™»å½•</span>' : 'æœªç™»å½•')
              }</p>
                            ${ownerInfo}
                          </div>
                          <div class="flex gap-2">
                            ${!isCurrent ? `
                              <button class="btn btn-ghost !py-1 !px-2 text-xs" onclick="selectSession('${session.session_id}')">é€‰æ‹©</button>
                              <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" onclick="deleteSession('${session.session_id}')">åˆ é™¤</button>
                            ` : ''}
                            ${isGodMode ? `<button class="btn btn-danger !py-1 !px-2 text-xs" onclick="destroySession('${session.session_id}')">é”€æ¯</button>` : ''}
                          </div>
                        </div>
                      </div>
                    `;
          }).join('');
        }

        listEl.innerHTML = html;
      } catch (e) {
        logMessage_Error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:", e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    function updateAdminSessionCountDisplayInline(currentCount, maxSessions) {
      const countEl = $('admin-session-count-display-inline');
      if (!countEl) return;

      if (currentUserIsGuest) {
        countEl.innerHTML = `<span class="text-blue-600">ä¼šè¯æ•°: 1 / æ¸¸å®¢ä»…é™å•ä¼šè¯</span>`;
      } else {
        if (maxSessions === -1) {
          countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
        } else {
          const isNearLimit = currentCount >= maxSessions * 0.8;
          const isAtLimit = currentCount >= maxSessions;
          const colorClass = isAtLimit ? 'text-red-600' : (isNearLimit ? 'text-amber-600' : 'text-slate-600');
          countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
        }
      }
    }

    // ====================
    // æ—¥å¿—æŸ¥çœ‹
    // ====================
    async function loadAdminLogs(newPage = 1) {
      currentLogPage = newPage; // æ›´æ–°å½“å‰é¡µç 

      const contentEl = $('admin-logs-content_modal');
      const limitSelect = $('log-limit-select_modal');
      // --- ä¿®æ”¹ï¼šè·å–æ–°çš„ select å’Œ span ---
      const pageSelect = $('log-page-select');
      const pageTotal = $('log-page-total');
      const prevBtn = $('log-prev-page');
      const nextBtn = $('log-next-page');

      // --- ä¿®æ”¹ï¼šæ›´æ–° DOM å…ƒç´ æ£€æŸ¥ ---
      if (!contentEl || !limitSelect || !pageSelect || !pageTotal || !prevBtn || !nextBtn) {
        logMessage_Error("loadAdminLogs: æ— æ³•æ‰¾åˆ°æ—¥å¿—é¢æ¿çš„å¿…è¦DOMå…ƒç´ ");
        return;
      }

      contentEl.textContent = 'åŠ è½½ä¸­...';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      pageSelect.disabled = true; // --- æ–°å¢ï¼šåŠ è½½æ—¶ç¦ç”¨é€‰æ‹©æ¡†

      try {
        const limit = limitSelect ? limitSelect.value : 100;
        const response = await fetch(`/logs/view?page=${currentLogPage}&limit=${limit}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          contentEl.textContent = `åŠ è½½å¤±è´¥: ${result.message}`;
          // --- ä¿®æ”¹ï¼šæ›´æ–°å¤±è´¥çŠ¶æ€ ---
          pageSelect.innerHTML = '<option value="1">1</option>';
          pageTotal.textContent = '(åŠ è½½å¤±è´¥)';
          return;
        }

        if (result.logs.length === 0) {
          contentEl.textContent = 'æš‚æ— æ—¥å¿—';
          // --- ä¿®æ”¹ï¼šæ›´æ–°ç©ºçŠ¶æ€ ---
          pageSelect.innerHTML = '<option value="1">ç¬¬ 1 / 1 é¡µ</option>';
          pageTotal.textContent = '(å…± 0 è¡Œ)';
          return;
        }

        contentEl.textContent = result.logs.join('');

        // --- ä¿®æ”¹ï¼šå¡«å……åˆ†é¡µé€‰æ‹©æ¡† ---
        const pagination = result.pagination;
        pageTotal.textContent = `(å…± ${pagination.total_lines} è¡Œ)`;

        // æ¸…ç©ºå¹¶å¡«å…… select
        pageSelect.innerHTML = '';
        for (let i = 1; i <= pagination.total_pages; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `ç¬¬ ${i} / ${pagination.total_pages} é¡µ`;
          if (i === pagination.current_page) {
            option.selected = true;
          }
          pageSelect.appendChild(option);
        }

        // æ¢å¤æŒ‰é’®å’Œé€‰æ‹©æ¡†çŠ¶æ€
        prevBtn.disabled = pagination.current_page <= 1;
        nextBtn.disabled = pagination.current_page >= pagination.total_pages;
        pageSelect.disabled = false; // --- æ–°å¢ï¼šæ¢å¤é€‰æ‹©æ¡†

      } catch (e) {
        logMessage_Error("åŠ è½½æ—¥å¿—å¤±è´¥:", e);
        contentEl.textContent = `åŠ è½½å¤±è´¥: ${e.message}`;
        // --- ä¿®æ”¹ï¼šæ›´æ–°å¤±è´¥çŠ¶æ€ ---
        pageSelect.innerHTML = '<option value="1">1</option>';
        pageTotal.textContent = '(åŠ è½½å¤±è´¥)';
      }
    }

    // ====================
    // å¥åº·çŠ¶æ€æ£€æµ‹
    // ====================
    async function loadHealthStatus() {
      const contentEl = $('admin-health-content_modal');

      if (!contentEl) {
        logMessage_Error("loadHealthStatus: æ— æ³•æ‰¾åˆ°å¥åº·çŠ¶æ€å®¹å™¨");
        return;
      }

      contentEl.innerHTML = '<p class="text-slate-400 text-center py-10">æ£€æµ‹ä¸­...</p>';

      try {
        const startTime = Date.now();
        const response = await fetch('/health');
        const responseTime = Date.now() - startTime;
        const result = await response.json();

        const statusColor = result.status === 'ok' ? 'green' : 'red';
        const statusText = result.status === 'ok' ? 'è¿è¡Œæ­£å¸¸' : 'å‡ºç°é”™è¯¯';

        contentEl.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-4">
              <h5 class="font-semibold text-${statusColor}-800 mb-2">æœåŠ¡å™¨çŠ¶æ€</h5>
              <p class="text-2xl font-bold text-${statusColor}-600">${statusText}</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h5 class="font-semibold text-blue-800 mb-2">å“åº”æ—¶é—´</h5>
              <p class="text-2xl font-bold text-blue-600">${responseTime}ms</p>
            </div>
          </div>
          <div class="mt-4 bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h5 class="font-semibold text-slate-800 mb-2">ç³»ç»Ÿä¿¡æ¯</h5>
            <pre class="text-xs text-slate-600 whitespace-pre-wrap">${JSON.stringify(result, null, 2)}</pre>
          </div>
        `;
      } catch (e) {
        logMessage_Error("åŠ è½½å¥åº·çŠ¶æ€å¤±è´¥:", e);
        contentEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    // ============================================================
    // ä»»åŠ¡23ï¼šå¥åº·é¢æ¿å€’è®¡æ—¶åŠŸèƒ½
    // åœ¨è‡ªåŠ¨åˆ·æ–°æ—¶æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œè®©ç”¨æˆ·çŸ¥é“ä¸‹æ¬¡åˆ·æ–°çš„æ—¶é—´
    // ============================================================

    // å…¨å±€å˜é‡ï¼šå€’è®¡æ—¶å®šæ—¶å™¨
    let healthCountdownInterval = null;
    // å…¨å±€å˜é‡ï¼šå½“å‰å€’è®¡æ—¶ç§’æ•°
    let healthCountdownSeconds = 5;

    // å¯åŠ¨å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
    function startHealthAutoRefresh() {
      // å…ˆæ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨
      stopHealthAutoRefresh();

      // æ£€æŸ¥è‡ªåŠ¨åˆ·æ–°å¼€å…³çŠ¶æ€
      const autoRefreshToggle = $('health-auto-refresh-toggle');
      if (!autoRefreshToggle || !autoRefreshToggle.checked) {
        return;
      }

      // é‡ç½®å€’è®¡æ—¶
      healthCountdownSeconds = 5;
      updateHealthCountdown();

      // å¯åŠ¨å€’è®¡æ—¶æ˜¾ç¤ºï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
      healthCountdownInterval = setInterval(() => {
        healthCountdownSeconds--;
        updateHealthCountdown();

        // å€’è®¡æ—¶ç»“æŸæ—¶é‡ç½®ä¸º5ç§’
        if (healthCountdownSeconds <= 0) {
          healthCountdownSeconds = 5;
        }
      }, 1000);

      // è®¾ç½®5ç§’é—´éš”çš„å®šæ—¶å™¨è¿›è¡Œå®é™…åˆ·æ–°
      healthAutoRefreshInterval = setInterval(() => {
        // å†æ¬¡æ£€æŸ¥å¼€å…³çŠ¶æ€ï¼Œé˜²æ­¢ç”¨æˆ·å…³é—­åä»åœ¨åˆ·æ–°
        const toggle = $('health-auto-refresh-toggle');
        if (toggle && toggle.checked) {
          loadHealthStatus();
          // åˆ·æ–°åé‡ç½®å€’è®¡æ—¶
          healthCountdownSeconds = 5;
        } else {
          stopHealthAutoRefresh();
        }
      }, 5000);
    }

    /**
     * æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
     * åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºè·ç¦»ä¸‹æ¬¡åˆ·æ–°è¿˜æœ‰å¤šå°‘ç§’
     */
    function updateHealthCountdown() {
      const countdownDisplay = $('health-countdown-display');
      if (countdownDisplay) {
        // å¦‚æœå€’è®¡æ—¶å¤§äº0ï¼Œæ˜¾ç¤ºå‰©ä½™ç§’æ•°ï¼›å¦åˆ™æ˜¾ç¤º"åˆ·æ–°ä¸­..."
        if (healthCountdownSeconds > 0) {
          countdownDisplay.textContent = ` - ${healthCountdownSeconds}ç§’ååˆ·æ–°`;
        } else {
          countdownDisplay.textContent = ' - åˆ·æ–°ä¸­...';
        }
      }
    }

    // åœæ­¢å¥åº·çŠ¶æ€è‡ªåŠ¨åˆ·æ–°
    function stopHealthAutoRefresh() {
      // æ¸…é™¤åˆ·æ–°å®šæ—¶å™¨
      if (healthAutoRefreshInterval) {
        clearInterval(healthAutoRefreshInterval);
        healthAutoRefreshInterval = null;
      }
      // ä»»åŠ¡23ï¼šæ¸…é™¤å€’è®¡æ—¶å®šæ—¶å™¨
      if (healthCountdownInterval) {
        clearInterval(healthCountdownInterval);
        healthCountdownInterval = null;
      }
      // æ¸…é™¤å€’è®¡æ—¶æ˜¾ç¤º
      const countdownDisplay = $('health-countdown-display');
      if (countdownDisplay) {
        countdownDisplay.textContent = '';
      }
    }

    // ====================
    // ä¸ªäººä¿¡æ¯ç®¡ç†
    // ====================
    async function loadPersonalInfo() {
      try {
        const response = await fetch('/auth/user/details', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          showModalAlert(`åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥: ${result.message}`, 'é”™è¯¯');
          return;
        }

        const user = result.user;

        // è°ƒè¯•ç”¨ï¼šå°†ç”¨æˆ·æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°
        // logMessage_Info('[loadPersonalInfo] User data:', user);
        // logMessage_Info('[loadPersonalInfo] Avatar URL:', user.avatar_url);

        // å­˜å‚¨å½“å‰è®¤è¯ç”¨æˆ·åç”¨äºåç»­æ“ä½œ
        if (user.auth_username) {
          currentAuthUsername = user.auth_username;
        }

        // ==============================================================================
        // ä»»åŠ¡ 2/3ï¼šæ›´æ–°ä¸ªäººä¿¡æ¯é¢æ¿çš„UI
        // ==============================================================================

        // æ›´æ–°åŸºæœ¬ä¿¡æ¯
        const nicknameInput = $('profile-nickname');
        const phoneInput = $('profile-phone');
        if (nicknameInput) nicknameInput.value = user.nickname || '';
        if (phoneInput) phoneInput.value = user.phone || 'æœªç»‘å®š';

        const phoneWrapper = phoneInput ? phoneInput.closest('.phone-input-wrapper') : null;
        if (phoneWrapper) {
          const prefix = phoneWrapper.querySelector('.phone-prefix');
          // ç¼“å­˜åˆ¤æ–­ç»“æœ
          const isUnbound = (!phoneInput.value || phoneInput.value === 'æœªç»‘å®š');

          if (prefix) {
            // å¦‚æœå€¼æ˜¯"æœªç»‘å®š"æˆ–ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™éšè—å‰ç¼€
            prefix.style.display = isUnbound ? 'none' : 'inline';
          }
          // [æ–°ä¿®å¤] æ ¹æ®å‰ç¼€æ˜¯å¦éšè—ï¼Œåˆ‡æ¢ wrapper ä¸Šçš„ class
          phoneWrapper.classList.toggle('prefix-hidden', isUnbound);
        }

        // æ ¹æ® config å†³å®šæ˜¯å¦æ˜¾ç¤ºâ€œä¿®æ”¹æ‰‹æœºå·â€æŒ‰é’®
        const modifyPhoneBtn = $('profile-modify-phone-btn');
        const phoneHint = $('profile-phone-hint');

        // ç¡®ä¿ window.APP_CONFIG å­˜åœ¨
        const config = window.APP_CONFIG || { enable_phone_modification: false };

        if (config.enable_phone_modification) {
          if (modifyPhoneBtn) modifyPhoneBtn.style.display = 'block';
          if (phoneHint) phoneHint.style.display = 'block';
        } else {
          if (modifyPhoneBtn) modifyPhoneBtn.style.display = 'none';
          if (phoneHint) phoneHint.style.display = 'none';
          // å¦‚æœåŠŸèƒ½å…³é—­ï¼Œæ‰‹æœºå·è¾“å…¥æ¡†ä¹Ÿåº”åªè¯»
          if (phoneInput) phoneInput.readOnly = true;
        }
        // ==============================================================================

        // æ›´æ–°å¤´åƒæ˜¾ç¤º
        const avatarDisplay = $('profile-avatar-display');
        const avatarInput = $('profile-avatar-input');
        if (avatarDisplay) {
          const avatarUrl = user.avatar_url || user.avatar || '';
          logMessage_Info('[loadPersonalInfo] Processing avatar URL:', avatarUrl);
          if (avatarUrl) {
            // å¦‚æœæ˜¯APIå¤´åƒURLï¼Œéœ€è¦é€šè¿‡fetchè·å–å¹¶è½¬æ¢ä¸ºdata URL
            if (avatarUrl.startsWith('/api/avatar/')) {
              loadAvatarWithAuth(avatarUrl, avatarDisplay);
            } else {
              // æ—§æ ¼å¼çš„å¤´åƒURLæˆ–å¤–éƒ¨URLï¼Œç›´æ¥ä½¿ç”¨
              const timestamp = new Date().getTime();
              const urlWithTimestamp = avatarUrl.includes('?')
                ? `${avatarUrl}&t=${timestamp}`
                : `${avatarUrl}?t=${timestamp}`;
              logMessage_Info('[loadPersonalInfo] Setting avatar display src to:', urlWithTimestamp);
              avatarDisplay.src = urlWithTimestamp;
            }
          } else {
            logMessage_Info('[loadPersonalInfo] No avatar URL, using default icon');
            // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
            avatarDisplay.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EğŸ‘¤%3C/text%3E%3C/svg%3E';
          }
        }
        if (avatarInput) {
          avatarInput.value = user.avatar_url || user.avatar || '';
        }

        // æ›´æ–°2FAçŠ¶æ€
        const tfaStatus = $('profile-2fa-enabled');
        const tfaActions = $('profile-2fa-actions');
        const tfaEnabledActions = $('profile-2fa-enabled-actions');
        const tfaSetup = $('profile-2fa-setup');

        // ä½¿ç”¨æ–¹æ‹¬å·è®¿é—®å¸¦ç‰¹æ®Šå­—ç¬¦çš„å±æ€§å
        const tfaEnabled = user['2fa_enabled'] || user.tfa_enabled || false;

        if (tfaStatus) {
          tfaStatus.textContent = tfaEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
          tfaStatus.className = tfaEnabled ? 'text-green-600 font-semibold' : 'text-slate-600';
        }

        // æ ¹æ®2FAçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
        if (tfaEnabled) {
          if (tfaActions) tfaActions.classList.add('hidden');
          if (tfaSetup) tfaSetup.classList.add('hidden');
          if (tfaEnabledActions) tfaEnabledActions.classList.remove('hidden');
        } else {
          if (tfaActions) tfaActions.classList.remove('hidden');
          if (tfaEnabledActions) tfaEnabledActions.classList.add('hidden');
          if (tfaSetup) tfaSetup.classList.add('hidden');
        }

        // æ›´æ–°ä¸»é¢˜é€‰æ‹©
        const themeSelect = $('profile-theme-select');
        if (themeSelect && user.theme) {
          themeSelect.value = user.theme;
        }
      } catch (e) {
        logMessage_Error("åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥:", e);
        showModalAlert(`åŠ è½½å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function updateAvatar() {
      const avatarInput = $('profile-avatar-input');
      if (!avatarInput || !avatarInput.value.trim()) {
        showModalAlert('è¯·è¾“å…¥å¤´åƒURL', 'æç¤º');
        return;
      }

      try {
        const response = await fetch('/auth/user/update_avatar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            avatar_url: avatarInput.value.trim()
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('å¤´åƒæ›´æ–°æˆåŠŸï¼', 'æˆåŠŸ');
          loadPersonalInfo(); // é‡æ–°åŠ è½½æ˜¾ç¤º
        } else {
          showModalAlert(`æ›´æ–°å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("æ›´æ–°å¤´åƒå¤±è´¥:", e);
        showModalAlert(`æ›´æ–°å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    // ä½¿ç”¨è®¤è¯åŠ è½½å¤´åƒ
    async function loadAvatarWithAuth(avatarUrl, imgElement) {
      try {
        logMessage_Info('[loadAvatarWithAuth] Fetching avatar:', avatarUrl);
        const response = await fetch(avatarUrl, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        if (!response.ok) {
          logMessage_Error('[loadAvatarWithAuth] Failed to fetch avatar:', response.status);
          // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ
          imgElement.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EğŸ‘¤%3C/text%3E%3C/svg%3E';
          return;
        }

        // è·å–å›¾ç‰‡blob
        const blob = await response.blob();

        // è½¬æ¢ä¸ºdata URL
        const reader = new FileReader();
        reader.onloadend = function () {
          logMessage_Info('[loadAvatarWithAuth] Avatar loaded successfully');
          imgElement.src = reader.result;
        };
        reader.readAsDataURL(blob);
      } catch (e) {
        logMessage_Error('[loadAvatarWithAuth] Error loading avatar:', e);
        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ
        imgElement.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EğŸ‘¤%3C/text%3E%3C/svg%3E';
      }
    }

    function previewAvatar(event) {
      isRegistrationCrop = false; // æ˜ç¡®è®¾ç½®ä¸Šä¸‹æ–‡ä¸º 'profile'
      const file = event.target.files[0];
      if (!file) return;

      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        showModalAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'é”™è¯¯');
        event.target.value = ''; // æ¸…é™¤é€‰æ‹©
        return;
      }

      // è¯»å–æ–‡ä»¶å¹¶æ‰“å¼€è£å‰ªæ¨¡æ€æ¡†
      const reader = new FileReader();
      reader.onload = function (e) {
        const cropImage = $('crop-image');
        if (cropImage) {
          cropImage.src = e.target.result;

          // é”€æ¯æ—§çš„è£å‰ªå™¨å®ä¾‹
          if (avatarCropper) {
            avatarCropper.destroy();
          }

          // åˆ›å»ºæ–°çš„è£å‰ªå™¨
          avatarCropper = new Cropper(cropImage, {
            aspectRatio: 1, // 1:1 æ­£æ–¹å½¢
            viewMode: 1,
            minContainerWidth: 300,
            minContainerHeight: 300,
            autoCropArea: 0.8,
            responsive: true,
            guides: true,
            center: true,
            highlight: true,
            cropBoxResizable: true,
            cropBoxMovable: true,
            toggleDragModeOnDblclick: false
          });

          // æ˜¾ç¤ºè£å‰ªæ¨¡æ€æ¡†
          showModal('avatar-crop-modal');
        }
      };
      reader.readAsDataURL(file);
    }

    // ä¸“ç”¨äºæ³¨å†Œæµç¨‹çš„é¢„è§ˆå‡½æ•°
    function previewAvatarForRegistration(event) {
      isRegistrationCrop = true; // æ˜ç¡®è®¾ç½®ä¸Šä¸‹æ–‡ä¸º 'register'
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showModalAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'é”™è¯¯');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const cropImage = $('crop-image');
        if (cropImage) {
          cropImage.src = e.target.result;
          if (avatarCropper) avatarCropper.destroy();
          avatarCropper = new Cropper(cropImage, {
            aspectRatio: 1, viewMode: 1, minContainerWidth: 300, minContainerHeight: 300,
            autoCropArea: 0.8, responsive: true, guides: true, center: true,
            highlight: true, cropBoxResizable: true, cropBoxMovable: true,
            toggleDragModeOnDblclick: false
          });
          showModal('avatar-crop-modal');
        }
      };
      reader.readAsDataURL(file);
    }

    function closeCropModal() {
      // é”€æ¯è£å‰ªå™¨
      if (avatarCropper) {
        avatarCropper.destroy();
        avatarCropper = null;
      }

      // æ¸…é™¤æ–‡ä»¶è¾“å…¥ (ä¸¤ä¸ªè¾“å…¥æ¡†éƒ½æ¸…é™¤)
      const fileInput = $('profile-avatar-file');
      if (fileInput) fileInput.value = '';
      const regFileInput = $('auth-reg-avatar');
      if (regFileInput) regFileInput.value = '';

      isRegistrationCrop = false; // é‡ç½®æ ‡å¿—

      hideModal('avatar-crop-modal');
    }

    // ä¸“ç”¨äºæ³¨å†Œæµç¨‹çš„ç¡®è®¤å‡½æ•°
    async function confirmCropForRegistration() {
      if (!avatarCropper) {
        showModalAlert('è£å‰ªå™¨æœªåˆå§‹åŒ–', 'é”™è¯¯');
        return;
      }

      const canvas = avatarCropper.getCroppedCanvas({
        width: 200, height: 200, imageSmoothingQuality: 'high'
      });
      if (!canvas) {
        showModalAlert('è£å‰ªå¤±è´¥', 'é”™è¯¯');
        return;
      }

      // å°† canvas è½¬æ¢ä¸º blob å¹¶æš‚å­˜
      canvas.toBlob(function (blob) {
        registrationCroppedAvatarBlob = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });

        // æ›´æ–°æ³¨å†Œè¡¨å•çš„é¢„è§ˆå›¾
        const previewImg = $('auth-reg-avatar-preview');
        if (previewImg) {
          previewImg.src = URL.createObjectURL(registrationCroppedAvatarBlob);
        }

        // å…³é—­æ¨¡æ€æ¡†
        closeCropModal();
      }, 'image/jpeg', 0.9);
    }


    async function confirmCropForRegistration() {
      if (!avatarCropper) {
        showModalAlert('è£å‰ªå™¨æœªåˆå§‹åŒ–', 'é”™è¯¯');
        return;
      }

      const canvas = avatarCropper.getCroppedCanvas({
        width: 200, height: 200, imageSmoothingQuality: 'high'
      });
      if (!canvas) {
        showModalAlert('è£å‰ªå¤±è´¥', 'é”™è¯¯');
        return;
      }

      // å°† canvas è½¬æ¢ä¸º blob å¹¶æš‚å­˜
      canvas.toBlob(function (blob) {
        // æš‚å­˜è£å‰ªåçš„æ–‡ä»¶ Blobï¼Œç”¨äºæ³¨å†Œæ—¶æäº¤
        registrationCroppedAvatarBlob = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });

        // æ›´æ–°æ³¨å†Œè¡¨å•çš„é¢„è§ˆå›¾
        const previewImg = $('auth-reg-avatar-preview');
        if (previewImg) {
          // ä½¿ç”¨ createObjectURL æ›´æ–°é¢„è§ˆå›¾
          previewImg.src = URL.createObjectURL(registrationCroppedAvatarBlob);
        }

        // å…³é—­æ¨¡æ€æ¡†
        closeCropModal();
      }, 'image/jpeg', 0.9);
    }

    async function confirmCropAndUpload() {
      // æ£€æŸ¥ä¸Šä¸‹æ–‡æ ‡å¿— (isRegistrationCrop æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥æ·»åŠ çš„å…¨å±€å˜é‡)
      if (isRegistrationCrop) {
        // æ³¨å†Œæµç¨‹ï¼šè°ƒç”¨æ–°çš„è¾…åŠ©å‡½æ•°ï¼Œåªæš‚å­˜ Blobï¼Œä¸ä¸Šä¼ 
        await confirmCropForRegistration();
      } else {
        // ä¸ªäººèµ„æ–™æµç¨‹ï¼šç«‹å³ä¸Šä¼ ï¼ˆä¿æŒåŸé€»è¾‘ä¸å˜ï¼‰
        if (!avatarCropper) {
          showModalAlert('è£å‰ªå™¨æœªåˆå§‹åŒ–', 'é”™è¯¯');
          return;
        }

        // è·å–è£å‰ªåçš„canvas
        const canvas = avatarCropper.getCroppedCanvas({
          width: 200,
          height: 200,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high'
        });

        if (!canvas) {
          showModalAlert('è£å‰ªå¤±è´¥', 'é”™è¯¯');
          return;
        }

        // å°†canvasè½¬æ¢ä¸ºblob
        canvas.toBlob(async function (blob) {
          // åˆ›å»ºæ–‡ä»¶å¯¹è±¡
          const avatarFile = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });

          // å…³é—­è£å‰ªæ¨¡æ€æ¡†
          closeCropModal();

          // ç›´æ¥ä¸Šä¼ 
          const formData = new FormData();
          formData.append('avatar', avatarFile);

          try {
            const response = await fetch('/auth/user/upload_avatar', {
              method: 'POST',
              headers: {
                'X-Session-ID': sessionUUID
              },
              body: formData
            });
            const result = await response.json();

            if (result.success) {
              showModalAlert('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'æˆåŠŸ');

              // æ¸…é™¤è£å‰ªåçš„æ–‡ä»¶
              croppedAvatarFile = null;

              // æ¸…é™¤æ–‡ä»¶è¾“å…¥
              const fileInput = $('profile-avatar-file');
              if (fileInput) {
                fileInput.value = '';
              }

              // é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
              await loadPersonalInfo();
            } else {
              showModalAlert(`ä¸Šä¼ å¤±è´¥: ${result.message}`, 'é”™è¯¯');
            }
          } catch (e) {
            logMessage_Error("ä¸Šä¼ å¤´åƒå¤±è´¥:", e);
            showModalAlert(`ä¸Šä¼ å¤±è´¥: ${e.message}\n\nâš ï¸ æ­¤åŠŸèƒ½éœ€è¦åç«¯API /auth/user/upload_avatar æ”¯æŒ`, 'é”™è¯¯');
          }
        }, 'image/jpeg', 0.9);
      }
    }

    async function uploadAvatar() {
      // ä¼˜å…ˆä½¿ç”¨è£å‰ªåçš„æ–‡ä»¶
      let fileToUpload = croppedAvatarFile;

      // å¦‚æœæ²¡æœ‰è£å‰ªçš„æ–‡ä»¶ï¼Œä½¿ç”¨åŸæ–‡ä»¶
      if (!fileToUpload) {
        const fileInput = $('profile-avatar-file');
        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
          showModalAlert('è¯·å…ˆé€‰æ‹©å¹¶è£å‰ªå›¾ç‰‡æ–‡ä»¶', 'æç¤º');
          return;
        }
        fileToUpload = fileInput.files[0];
      }

      const formData = new FormData();
      formData.append('avatar', fileToUpload);

      try {
        const response = await fetch('/auth/user/upload_avatar', {
          method: 'POST',
          headers: {
            'X-Session-ID': sessionUUID
          },
          body: formData
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'æˆåŠŸ');

          // æ¸…é™¤è£å‰ªåçš„æ–‡ä»¶
          croppedAvatarFile = null;

          // æ¸…é™¤æ–‡ä»¶è¾“å…¥
          const fileInput = $('profile-avatar-file');
          if (fileInput) {
            fileInput.value = '';
          }

          // é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
          await loadPersonalInfo();
        } else {
          showModalAlert(`ä¸Šä¼ å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("ä¸Šä¼ å¤´åƒå¤±è´¥:", e);
        showModalAlert(`ä¸Šä¼ å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    // æ›´æ–°åŸºæœ¬ä¿¡æ¯ï¼ˆæ˜µç§°å’Œæ‰‹æœºå·ï¼‰
    async function updateBasicInfo() {
      const nickname = $('profile-nickname');
      const phone = $('profile-phone');

      if (!nickname || !phone) return;

      if (!nickname.value.trim()) {
        showModalAlert('æ˜µç§°ä¸èƒ½ä¸ºç©º', 'æç¤º');
        return;
      }

      if (!currentAuthUsername) {
        showModalAlert('æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°åŠ è½½', 'é”™è¯¯');
        return;
      }

      try {
        const response = await fetch('/api/admin/users/' + encodeURIComponent(currentAuthUsername) + '/basic_info', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            nickname: nickname.value.trim()
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert('åŸºæœ¬ä¿¡æ¯æ›´æ–°æˆåŠŸ', 'æˆåŠŸ');
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (error) {
        logMessage_Error('æ›´æ–°åŸºæœ¬ä¿¡æ¯å¤±è´¥', error);
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'é”™è¯¯');
      }
    }

    // ä¿®æ”¹æ‰‹æœºå·
    async function modifyPhone() {
      showModalAlert('ä¿®æ”¹æ‰‹æœºå·åŠŸèƒ½éœ€è¦çŸ­ä¿¡éªŒè¯ï¼Œå½“å‰ç‰ˆæœ¬æš‚æœªå¼€æ”¾', 'æç¤º');
      // TODO: å®ç°ä¿®æ”¹æ‰‹æœºå·æµç¨‹
      // 1. å‘é€éªŒè¯ç åˆ°æ–°æ‰‹æœºå·
      // 2. è¾“å…¥éªŒè¯ç 
      // 3. æ›´æ–°æ‰‹æœºå·
    }

    async function updatePassword() {
      const currentPassword = $('profile-current-password');
      const newPassword = $('profile-new-password');
      const confirmPassword = $('profile-confirm-password');

      if (!currentPassword || !newPassword || !confirmPassword) return;

      if (!currentPassword.value || !newPassword.value || !confirmPassword.value) {
        showModalAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'æç¤º');
        return;
      }

      if (newPassword.value !== confirmPassword.value) {
        showModalAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'é”™è¯¯');
        return;
      }

      if (newPassword.value.length < 6) {
        showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      if (!currentAuthUsername) {
        showModalAlert('æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯', 'é”™è¯¯');
        return;
      }

      try {
        const response = await fetch('/auth/admin/reset_password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: currentAuthUsername,
            old_password: currentPassword.value,
            new_password: newPassword.value
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'æˆåŠŸ');
          currentPassword.value = '';
          newPassword.value = '';
          confirmPassword.value = '';
        } else {
          showModalAlert(`ä¿®æ”¹å¤±è´¥: ${result.message || 'è¯·æ£€æŸ¥å½“å‰å¯†ç æ˜¯å¦æ­£ç¡®'}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("ä¿®æ”¹å¯†ç å¤±è´¥:", e);
        showModalAlert(`ä¿®æ”¹å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function generate2FA() {
      try {
        const response = await fetch('/auth/2fa/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          showModalAlert(`ç”Ÿæˆ2FAå¤±è´¥: ${result.message}`, 'é”™è¯¯');
          return;
        }

        // æ˜¾ç¤º2FAè®¾ç½®åŒºåŸŸ
        const setupDiv = $('profile-2fa-setup');
        const actionsDiv = $('profile-2fa-actions');
        if (setupDiv) setupDiv.classList.remove('hidden');
        if (actionsDiv) actionsDiv.classList.add('hidden');

        // æ˜¾ç¤ºå¯†é’¥
        const secretSpan = $('profile-2fa-secret');
        if (secretSpan && result.secret) {
          secretSpan.textContent = result.secret;
        }

        // ä½¿ç”¨QRCode.jsç”ŸæˆäºŒç»´ç 
        const qrCanvas = $('profile-2fa-qr');
        if (qrCanvas && result.qr_uri) {
          if (typeof QRCode !== 'undefined') {
            // è®¾ç½®canvaså°ºå¯¸
            qrCanvas.width = 200;
            qrCanvas.height = 200;

            QRCode.toCanvas(qrCanvas, result.qr_uri, { width: 200 }, function (error) {
              if (error) {
                logMessage_Error('QR Code generation error:', error);
                showModalAlert('äºŒç»´ç ç”Ÿæˆå¤±è´¥', 'é”™è¯¯');
              } else {
                logMessage_Info('QR Code generated successfully');
              }
            });
          } else {
            logMessage_Error('QRCodeåº“æœªåŠ è½½');
            showModalAlert('QRCodeåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'é”™è¯¯');
          }
        }
      } catch (e) {
        logMessage_Error("ç”Ÿæˆ2FAå¤±è´¥:", e);
        showModalAlert(`ç”Ÿæˆå¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function enable2FA() {
      const codeInput = $('profile-2fa-code');
      if (!codeInput || !codeInput.value) {
        showModalAlert('è¯·è¾“å…¥éªŒè¯ç ', 'æç¤º');
        return;
      }

      try {
        const response = await fetch('/auth/2fa/enable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            code: codeInput.value
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('2FAå¯ç”¨æˆåŠŸï¼', 'æˆåŠŸ');
          // éšè—è®¾ç½®åŒºåŸŸ
          const setupDiv = $('profile-2fa-setup');
          const actionsDiv = $('profile-2fa-actions');
          if (setupDiv) setupDiv.classList.add('hidden');
          if (actionsDiv) actionsDiv.classList.remove('hidden');
          // é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯
          loadPersonalInfo();
        } else {
          showModalAlert(`å¯ç”¨å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("å¯ç”¨2FAå¤±è´¥:", e);
        showModalAlert(`å¯ç”¨å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function disable2FA() {
      const confirmed = await jsShowConfirm('ç¡®è®¤å…³é—­2FA', 'å…³é—­åŒå› ç´ è®¤è¯åï¼Œè´¦å·å®‰å…¨æ€§å°†é™ä½ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/2fa/disable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('2FAå·²å…³é—­', 'æˆåŠŸ');
          // é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯ä»¥æ›´æ–°ç•Œé¢
          loadPersonalInfo();
        } else {
          showModalAlert(`å…³é—­å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("å…³é—­2FAå¤±è´¥:", e);
        showModalAlert(`å…³é—­å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function test2FA() {
      // åˆ›å»ºæµ‹è¯•å¯¹è¯æ¡†
      const testCode = await new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">æµ‹è¯•2FA</h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 mb-2">è¯·è¾“å…¥éªŒè¯å™¨ä¸­çš„6ä½éªŒè¯ç </label>
              <input type="text" id="test-2fa-code-input" class="input-field w-full" placeholder="è¾“å…¥6ä½éªŒè¯ç " maxlength="6" inputmode="numeric">
            </div>
            <div class="flex gap-2 justify-end">
              <button class="btn btn-ghost" onclick="this.closest('.fixed').remove()">å–æ¶ˆ</button>
              <button class="btn btn-primary" id="confirm-test-2fa">éªŒè¯</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const confirmBtn = modal.querySelector('#confirm-test-2fa');
        const codeInput = modal.querySelector('#test-2fa-code-input');

        confirmBtn.onclick = () => {
          const code = codeInput.value;
          if (!code || code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
            showModalAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æ•°å­—éªŒè¯ç ', 'é”™è¯¯');
            return;
          }
          modal.remove();
          resolve(code);
        };
      });

      if (!testCode) return;

      try {
        const response = await fetch('/auth/2fa/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            code: testCode
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('2FAéªŒè¯æˆåŠŸï¼æ‚¨çš„åŒå› ç´ è®¤è¯å·¥ä½œæ­£å¸¸ã€‚', 'æˆåŠŸ');
        } else {
          showModalAlert(`éªŒè¯å¤±è´¥: ${result.message || 'éªŒè¯ç é”™è¯¯'}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("æµ‹è¯•2FAå¤±è´¥:", e);
        showModalAlert(`æµ‹è¯•å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function updateTheme() {
      const themeSelect = $('profile-theme-select');
      if (!themeSelect) return;

      try {
        const response = await fetch('/auth/user/update_theme', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            theme: themeSelect.value
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('ä¸»é¢˜æ›´æ–°æˆåŠŸï¼', 'æˆåŠŸ');
        } else {
          showModalAlert(`æ›´æ–°å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("æ›´æ–°ä¸»é¢˜å¤±è´¥:", e);
        showModalAlert(`æ›´æ–°å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    // ====================
    // æ–°å¢åŠŸèƒ½ï¼šåˆ›å»ºç”¨æˆ·å¯¹è¯æ¡†
    // ====================
    function showCreateUserModal() {
      const modal = $('newUserModal');
      if (modal) {
        // æ¸…ç©ºæ—§è¾“å…¥
        $('newUsername').value = "";
        $('newPassword').value = "";

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';


        const confirmBtn = $('newUserConfirm'); // è·å–æŒ‰é’®å¼•ç”¨
        confirmBtn.onclick = async () => {
          const inputUsername = $('newUsername').value.trim();
          const inputPassword = $('newPassword').value;

          if (!inputUsername || !inputPassword) {
            showModalAlert("è´¦å·å’Œå¯†ç å‡ä¸èƒ½ä¸ºç©º");
            return;
          }
          if (!inputPassword || inputPassword.length < 6) {
            showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
            return;
          }

          // é»˜è®¤ group ä¸º 'user'ï¼Œå› ä¸ºæ­¤æ¨¡æ€æ¡†æ²¡æœ‰ç»„é€‰æ‹©å™¨
          const group = 'user';

          // --- æ–°å¢ï¼šè®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€ ---
          setButtonLoading('newUserConfirm', true, 'åˆ›å»ºä¸­...');

          try {
            // è°ƒç”¨åç«¯ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·çš„API
            const response = await fetch('/auth/admin/create_user', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                username: inputUsername,
                password: inputPassword,
                group: group
              })
            });

            const result = await response.json();

            if (result.success) {
              showModalAlert("ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼");
              closeNewUserModal();
              // åˆ·æ–°ç®¡ç†é¢æ¿ä¸­çš„ç”¨æˆ·åˆ—è¡¨
              if (typeof loadAdminUsers === 'function') {
                loadAdminUsers();
              }
            } else {
              showModalAlert(`åˆ›å»ºå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
          } catch (e) {
            showModalAlert(`åˆ›å»ºæ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`);
            logMessage_Error("åˆ›å»ºç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯:", e);
          } finally {
            // --- æ–°å¢ï¼šæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½æ¢å¤æŒ‰é’®çŠ¶æ€ ---
            setButtonLoading('newUserConfirm', false, 'ç¡®è®¤');
          }
        };
      }
    }

    // ====================
    // æ–°å¢åŠŸèƒ½ï¼šåˆ›å»ºæƒé™ç»„å¯¹è¯æ¡†
    // ====================
    let currentEditGroupKey = null;
    let currentManageUsername = null;

    async function showCreateGroupModal() {
      const modal = $('create-group-modal');
      if (!modal) return;

      // æ¸…ç©ºè¾“å…¥
      const keyInput = $('new-group-key');
      const nameInput = $('new-group-name');
      if (keyInput) keyInput.value = '';
      if (nameInput) nameInput.value = '';

      // åŠ è½½æƒé™åˆ—è¡¨
      try {
        const response = await fetch('/auth/admin/list_groups', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (result.success && result.groups) {
          // ä»ç¬¬ä¸€ä¸ªæƒé™ç»„è·å–æ‰€æœ‰å¯ç”¨æƒé™
          const firstGroup = Object.values(result.groups)[0];
          if (firstGroup && firstGroup.permissions) {
            const permissionsContainer = $('create-group-permissions');
            if (permissionsContainer) {
              permissionsContainer.innerHTML = Object.keys(firstGroup.permissions).map(perm => `
                <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}">
                  <span class="text-sm text-slate-700">${translatePermission(perm)}</span>
                </label>
              `).join('');
            }
          }
        }
      } catch (e) {
        logMessage_Error('åŠ è½½æƒé™åˆ—è¡¨å¤±è´¥:', e);
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeCreateGroupModal() {
      const modal = $('create-group-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    async function submitCreateGroup() {
      const keyInput = $('new-group-key');
      const nameInput = $('new-group-name');

      if (!keyInput || !nameInput) return;

      const groupKey = keyInput.value.trim();
      const groupName = nameInput.value.trim();

      if (!groupKey || !nameInput) {
        showModalAlert('è¯·å¡«å†™æƒé™ç»„é”®åå’Œåç§°', 'é”™è¯¯');
        return;
      }

      // æ”¶é›†é€‰ä¸­çš„æƒé™
      const permissionsContainer = $('create-group-permissions');
      if (!permissionsContainer) return;

      const permissions = {};
      const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const perm = cb.getAttribute('data-permission');
        permissions[perm] = cb.checked;
      });

      try {
        const response = await fetch('/auth/admin/create_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            group_key: groupKey,
            group_name: groupName,
            permissions: permissions
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`æƒé™ç»„ ${groupName} åˆ›å»ºæˆåŠŸ`, 'æˆåŠŸ');
          closeCreateGroupModal();
          loadAdminGroups();
        } else {
          showModalAlert(result.message || 'åˆ›å»ºå¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function loadAdminUsers() {
      try {
        const response = await fetch('/auth/admin/list_users', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          $('admin-users-list').innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const listEl = $('admin-users-list_modal');
        if (result.users.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç”¨æˆ·</p>';
          return;
        }

        // åŒæ—¶è·å–æƒé™ç»„åˆ—è¡¨
        const groupsResp = await fetch('/auth/admin/list_groups', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const groupsData = await groupsResp.json();
        const groups = groupsData.success ? Object.keys(groupsData.groups) : ['guest', 'user', 'admin'];

        listEl.innerHTML = result.users.map(user => {
          const createdDate = new Date(user.created_at * 1000).toLocaleString();
          const lastLoginDate = user.last_login ? new Date(user.last_login * 1000).toLocaleString() : 'ä»æœªç™»å½•';
          const isBanned = user.banned || false;
          const bannedBadge = isBanned ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2">å·²å°ç¦</span>' : '';

          const groupSelect = `
        <select class="text-sm border border-slate-300 rounded px-2 py-1" onchange="updateUserGroup('${user.auth_username}', this.value)">
          ${groups.map(g => `<option value="${g}" ${g === user.group ? 'selected' : ''}>${g}</option>`).join('')}
        </select>
      `;

          return `
        <div class="border border-slate-200 rounded-lg p-3 mb-2">
          <div class="flex justify-between items-start gap-3">
            <div class="flex items-start gap-3 flex-1">
              <div id="avatar-${user.auth_username}" class="flex-shrink-0 w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden border-2 border-slate-300">
                <span class="text-2xl text-slate-400">ğŸ‘¤</span>
              </div>
              <div class="flex-1">
                <p class="font-semibold text-slate-800">${user.auth_username}${bannedBadge}</p>
                <p class="text-xs text-slate-500">æ˜µç§°: ${user.nickname || 'æœªè®¾ç½®'}</p>
                <p class="text-xs text-slate-500">æ‰‹æœºå·: ${user.phone || 'æœªç»‘å®š'}</p>
                <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                <p class="text-xs text-slate-500">æœ€åç™»å½•: ${lastLoginDate}</p>
                <p class="text-xs text-slate-500">ç™»å½•IP: ${user.last_login_ip || 'æ— è®°å½•'} (${user.last_login_city || 'æœªçŸ¥'})</p>
                <p class="text-xs text-slate-500">ä¼šè¯é™åˆ¶: ${user.max_sessions === -1 ? 'æ— é™åˆ¶' : user.max_sessions + 'ä¸ª'}</p>
                <p class="text-xs ${(user['2fa_enabled'] || user.tfa_enabled) ? 'text-green-600' : 'text-slate-400'}">2FA: ${(user['2fa_enabled'] || user.tfa_enabled) ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</p>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="text-xs text-slate-600">æƒé™ç»„:</span>
              ${groupSelect}
              <div class="flex flex-col gap-1.5 mt-2" id="user-actions-${user.auth_username}">
                <div class="flex gap-1 flex-wrap justify-end">
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="showUserLogs('${user.auth_username}')">æŸ¥çœ‹æ—¥å¿—</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="manageUserPermissions('${user.auth_username}')">æƒé™</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="setUserMaxSessions('${user.auth_username}', ${user.max_sessions || 1})">ä¼šè¯</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="modifyUserNickname('${user.auth_username}', '${escapeHtml(user.nickname || '')}')">ä¿®æ”¹æ˜µç§°</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="modifyUserPhone('${user.auth_username}', '${user.phone || ''}')">ä¿®æ”¹æ‰‹æœº</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="resetUserPassword('${user.auth_username}')">é‡ç½®å¯†ç </button>
                </div>
                <div class="flex gap-1 flex-wrap justify-end">
                  ${(user['2fa_enabled'] || user.tfa_enabled) ? `<button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="forceDisable2FA('${user.auth_username}')">å…³é—­2FA</button>` : ''}
                  ${isBanned ?
              `<button class="btn btn-success !py-0.5 !px-2 !text-xs" onclick="unbanUser('${user.auth_username}')">è§£å°</button>` :
              `<button class="btn btn-warning !py-0.5 !px-2 !text-xs" onclick="banUser('${user.auth_username}')">å°ç¦</button>`
            }
                  <button class="btn btn-warning !py-0.5 !px-2 !text-xs" onclick="clearUserAvatar('${user.auth_username}')">æ¸…é™¤å¤´åƒ</button>
                  <button class="btn btn-danger !py-0.5 !px-2 !text-xs" onclick="deleteUser('${user.auth_username}')">åˆ é™¤</button>
                </div>
              </div>
          </div>
        </div>
      </div>
      `;
        }).join('');

        // åŠ è½½æ¯ä¸ªç”¨æˆ·çš„å¤´åƒ
        result.users.forEach(user => {
          loadUserAvatar(user.auth_username);
        });
      } catch (e) {
        $('admin-users-list').innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    async function updateUserGroup(username, newGroup) {
      try {
        const response = await fetch('/auth/admin/update_user_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            target_username: username,
            new_group: newGroup
          })
        });

        const result = await response.json();
        if (result.success) {
          logMessage_Info(`ç”¨æˆ· ${username} çš„æƒé™ç»„å·²æ›´æ–°ä¸º ${newGroup}`);
        } else {
          // ä½¿ç”¨ showModalAlert æ›¿æ¢ alert
          showModalAlert(`æ›´æ–°å¤±è´¥: ${result.message}`, 'æ“ä½œå¤±è´¥');
          loadAdminUsers(); // é‡æ–°åŠ è½½ä»¥æ¢å¤åŸçŠ¶æ€
        }
      } catch (e) {
        // ä½¿ç”¨ showModalAlert æ›¿æ¢ alert
        showModalAlert(`æ›´æ–°å¤±è´¥: ${e.message}`, 'ç½‘ç»œé”™è¯¯');
        loadAdminUsers();
      }
    }

    // ====================
    // ç”¨æˆ·ç®¡ç†åŠŸèƒ½å‡½æ•°
    // ====================
    async function banUser(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤å°ç¦', `ç¡®å®šè¦å°ç¦ç”¨æˆ· ${username} å—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/ban_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} å·²è¢«å°ç¦`, 'æˆåŠŸ');
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'å°ç¦å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function unbanUser(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤è§£å°', `ç¡®å®šè¦è§£å°ç”¨æˆ· ${username} å—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/unban_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} å·²è§£å°`, 'æˆåŠŸ');
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'è§£å°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function forceDisable2FA(username) {
      const confirmed = await jsShowConfirm('å¼ºåˆ¶å…³é—­2FA', `ç¡®å®šè¦ä¸ºç”¨æˆ· ${username} å…³é—­åŒå› ç´ è®¤è¯å—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/force_disable_2fa', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            target_username: username
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„2FAå·²å…³é—­`, 'æˆåŠŸ');
          loadAdminUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨ä»¥æ›´æ–°ç•Œé¢
        } else {
          showModalAlert(result.message || 'æ“ä½œå¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function resetUserPassword(username) {
      // ä½¿ç”¨promptè·å–æ–°å¯†ç 
      const newPassword = await new Promise((resolve) => {
        // åˆ›å»ºä¸€ä¸ªç®€å•çš„è¾“å…¥å¯¹è¯æ¡†
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">é‡ç½®å¯†ç  - ${username}</h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 mb-2">æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</label>
              <input type="password" id="reset-password-input" class="input-field w-full" placeholder="è¾“å…¥æ–°å¯†ç ">
            </div>
            <div class="flex gap-2 justify-end">
              <button class="btn btn-ghost" onclick="this.closest('.fixed').remove()">å–æ¶ˆ</button>
              <button class="btn btn-primary" id="confirm-reset-password">ç¡®è®¤é‡ç½®</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const confirmBtn = modal.querySelector('#confirm-reset-password');
        const passwordInput = modal.querySelector('#reset-password-input');

        confirmBtn.onclick = () => {
          const password = passwordInput.value;
          if (!password || password.length < 6) {
            showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
            return;
          }
          modal.remove();
          resolve(password);
        };
      });

      if (!newPassword) return;

      try {
        const response = await fetch('/auth/admin/force_reset_password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            target_username: username,
            new_password: newPassword
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„å¯†ç å·²é‡ç½®`, 'æˆåŠŸ');
        } else {
          showModalAlert(result.message || 'é‡ç½®å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function deleteUser(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/delete_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} å·²åˆ é™¤`, 'æˆåŠŸ');
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function loadUserAvatar(username) {
      try {
        const response = await fetch(`/auth/user/avatar?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const result = await response.json();
        const avatarDiv = document.getElementById(`avatar-${username}`);

        if (!avatarDiv) return;

        if (result.success && result.avatar_url) {
          // æ·»åŠ session_idä½œä¸ºæŸ¥è¯¢å‚æ•°åˆ°å¤´åƒURL
          const avatarUrlWithSession = `${result.avatar_url}?session_id=${sessionUUID}`;
          avatarDiv.innerHTML = `<img src="${avatarUrlWithSession}" alt="${username}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="text-2xl text-slate-400" style="display:none;">ğŸ‘¤</span>`;
        } else {
          avatarDiv.innerHTML = `<span class="text-2xl text-slate-400">ğŸ‘¤</span>`;
        }
      } catch (e) {
        logMessage_Error(`åŠ è½½ç”¨æˆ·å¤´åƒå¤±è´¥ ${username}:`, e);
      }
    }

    async function clearUserAvatar(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤æ¸…é™¤å¤´åƒ', `ç¡®å®šè¦æ¸…é™¤ç”¨æˆ· ${username} çš„å¤´åƒå—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/clear_user_avatar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`å·²æ¸…é™¤ç”¨æˆ· ${username} çš„å¤´åƒ`, 'æˆåŠŸ');
          // ç«‹å³æ›´æ–°å¤´åƒæ˜¾ç¤º
          loadUserAvatar(username);
        } else {
          showModalAlert(result.message || 'æ¸…é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function setUserMaxSessions(username, currentMax) {
      // å¡«å……æ¨¡æ€æ¡†ä¿¡æ¯
      $('sessions-username').textContent = username;
      $('sessions-current-max').textContent = currentMax === -1 ? 'æ— é™åˆ¶' : currentMax;
      $('new-max-sessions').value = currentMax === -1 ? 0 : currentMax;

      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      showModal('set-max-sessions-modal');
    }

    async function submitSetMaxSessions() {
      const username = $('sessions-username').textContent;
      const newMaxInput = $('new-max-sessions');
      const newMax = parseInt(newMaxInput.value);

      if (isNaN(newMax) || newMax < 0) {
        showModalAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆ0æˆ–æ›´å¤§ï¼‰', 'é”™è¯¯');
        return;
      }

      // 0è¡¨ç¤ºæ— é™åˆ¶ï¼Œè½¬æ¢ä¸º-1
      const maxSessions = newMax === 0 ? -1 : newMax;

      try {
        const response = await fetch('/auth/admin/update_max_sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username, max_sessions: maxSessions })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`å·²æ›´æ–°ç”¨æˆ· ${username} çš„æœ€å¤§ä¼šè¯æ•°ä¸º: ${maxSessions === -1 ? 'æ— é™åˆ¶' : maxSessions}`, 'æˆåŠŸ');
          hideModal('set-max-sessions-modal');
          loadAdminUsers();
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function manageUserPermissions(username) {
      currentManageUsername = username;
      const modal = $('manage-user-permissions-modal');
      if (!modal) return;

      try {
        // è·å–ç”¨æˆ·æƒé™ä¿¡æ¯
        const response = await fetch('/auth/admin/get_user_permissions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username: username })
        });
        const result = await response.json();

        if (!result.success) {
          showModalAlert('æ— æ³•åŠ è½½ç”¨æˆ·æƒé™ä¿¡æ¯', 'é”™è¯¯');
          return;
        }

        // è®¾ç½®ç”¨æˆ·åå’Œæƒé™ç»„
        const nameEl = $('manage-user-name');
        const groupEl = $('user-base-group');
        if (nameEl) nameEl.textContent = username;
        if (groupEl) groupEl.textContent = result.group || 'guest';

        if (groupEl === 'super_admin') {
          showModalAlert('æ— æ³•ä¿®æ”¹è¶…çº§ç®¡ç†å‘˜çš„æƒé™', 'é”™è¯¯');
        }
        // æ¸²æŸ“æƒé™åˆ—è¡¨ï¼ˆæ˜¾ç¤ºå·®åˆ†åŒ–æƒé™ï¼‰
        const permissionsContainer = $('manage-user-permissions-list');
        if (permissionsContainer && result.all_permissions) {
          const groupPerms = result.group_permissions || {};
          const addedPerms = result.added_permissions || {};
          const removedPerms = result.removed_permissions || {};

          permissionsContainer.innerHTML = Object.keys(result.all_permissions).map(perm => {
            const groupHas = groupPerms[perm] || false;
            const isAdded = addedPerms[perm] === true;
            const isRemoved = removedPerms[perm] === true;
            const currentValue = result.all_permissions[perm];

            let statusClass = '';
            let statusText = '';
            if (isAdded) {
              statusClass = 'bg-green-50 border-green-200';
              statusText = '(æ–°å¢)';
            } else if (isRemoved) {
              statusClass = 'bg-red-50 border-red-200';
              statusText = '(ç§»é™¤)';
            }

            return `
              <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer border ${statusClass}">
                <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}" data-group-value="${groupHas}" ${currentValue ? 'checked' : ''}>
                <span class="text-sm text-slate-700 flex-1">${translatePermission(perm)}</span>
                ${statusText ? `<span class="text-xs ${isAdded ? 'text-green-600' : 'text-red-600'}">${statusText}</span>` : ''}
              </label>
            `;
          }).join('');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } catch (e) {
        showModalAlert('åŠ è½½å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function closeManageUserPermissionsModal() {
      const modal = $('manage-user-permissions-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      currentManageUsername = null;
    }

    async function submitManageUserPermissions() {
      if (!currentManageUsername) return;

      const permissionsContainer = $('manage-user-permissions-list');
      if (!permissionsContainer) return;

      // æ”¶é›†å·®åˆ†åŒ–æƒé™
      const addedPermissions = {};
      const removedPermissions = {};

      const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const perm = cb.getAttribute('data-permission');
        const groupValue = cb.getAttribute('data-group-value') === 'true';
        const currentValue = cb.checked;

        // å¦‚æœå½“å‰å€¼ä¸æƒé™ç»„å€¼ä¸åŒï¼Œè®°å½•å·®å¼‚
        if (currentValue !== groupValue) {
          if (currentValue) {
            addedPermissions[perm] = true;
          } else {
            removedPermissions[perm] = true;
          }
        }
      });

      try {
        const response = await fetch('/auth/admin/set_user_permission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: currentManageUsername,
            added_permissions: addedPermissions,
            removed_permissions: removedPermissions
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${currentManageUsername} çš„æƒé™å·²æ›´æ–°`, 'æˆåŠŸ');
          closeManageUserPermissionsModal();
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function showResetPasswordModal(username) {
      // è®¾ç½®ç›®æ ‡ç”¨æˆ·å
      $('reset-password-username').textContent = username;
      // æ¸…ç©ºè¾“å…¥æ¡†
      $('reset-new-password').value = '';
      $('reset-confirm-password').value = '';
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      showModal('reset-user-password-modal');
    }

    async function submitResetUserPassword() {
      const username = $('reset-password-username').textContent;
      const newPassword = $('reset-new-password').value;
      const confirmPassword = $('reset-confirm-password').value;

      if (!newPassword || !confirmPassword) {
        showModalAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'æç¤º');
        return;
      }

      if (newPassword.length < 6) {
        showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      if (newPassword !== confirmPassword) {
        showModalAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'é”™è¯¯');
        return;
      }

      try {
        const response = await fetch('/auth/admin/reset_password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username,
            new_password: newPassword
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„å¯†ç å·²é‡ç½®`, 'æˆåŠŸ');
          hideModal('reset-user-password-modal');
        } else {
          showModalAlert(result.message || 'å¯†ç é‡ç½®å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    // ====================
    // é—®é¢˜4å’Œ9ä¿®å¤ï¼šç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æ‰‹æœºå·åŠŸèƒ½ï¼ˆäºŒçº§æ¨¡æ€çª—ï¼‰
    // ====================
    function modifyUserPhone(username, currentPhone) {
      // æ‰“å¼€äºŒçº§æ¨¡æ€æ¡†
      $('admin-modify-phone-username').value = username;
      $('admin-modify-phone-current').value = currentPhone || 'æœªç»‘å®š';
      $('admin-modify-phone-new').value = '';
      $('admin-modify-phone-code').value = '';
      $('admin-modify-phone-modal').classList.remove('hidden');

      const adminCurrentPhoneInput = $('admin-modify-phone-current');
      const adminCurrentPhoneWrapper = adminCurrentPhoneInput ? adminCurrentPhoneInput.closest('.phone-input-wrapper') : null;
      if (adminCurrentPhoneWrapper) {
        const prefix = adminCurrentPhoneWrapper.querySelector('.phone-prefix');
        // ç¼“å­˜åˆ¤æ–­ç»“æœ
        const isUnbound = (!adminCurrentPhoneInput.value || adminCurrentPhoneInput.value === 'æœªç»‘å®š');

        if (prefix) {
          prefix.style.display = isUnbound ? 'none' : 'inline';
        }
        // [æ–°ä¿®å¤] æ ¹æ®å‰ç¼€æ˜¯å¦éšè—ï¼Œåˆ‡æ¢ wrapper ä¸Šçš„ class
        adminCurrentPhoneWrapper.classList.toggle('prefix-hidden', isUnbound);
      }

    }

    function closeAdminModifyPhoneModal() {
      $('admin-modify-phone-modal').classList.add('hidden');
    }

    async function sendAdminModifyPhoneCode() {
      const newPhone = $('admin-modify-phone-new').value.trim();
      if (!newPhone || !/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
      }

      const sendBtn = $('admin-modify-phone-send-btn');
      sendBtn.disabled = true;
      const originalText = sendBtn.textContent;

      try {
        // ä¿®æ­£ï¼šä½¿ç”¨ fetch è°ƒç”¨ç‹¬ç«‹çš„ /api/sms/send_code æ¥å£
        const response = await fetch('/api/sms/send_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: newPhone,
            scene: 'modify' // åœºæ™¯ï¼šç®¡ç†å‘˜ä¿®æ”¹
          })
        });
        const result = await response.json();

        if (result && result.success) {
          const expireMin = result.expire_minutes || 5;
          const retryAfter = result.retry_after || 180;
          showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

          // å€’è®¡æ—¶
          let countdown = retryAfter;
          const timer = setInterval(() => {
            countdown--;
            sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            if (countdown <= 0) {
              clearInterval(timer);
              sendBtn.disabled = false;
              sendBtn.textContent = originalText;
            }
          }, 1000);
        } else {
          if (result?.retry_after) {
            let countdown = result.retry_after;
            sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            const timer = setInterval(() => {
              countdown--;
              sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
              if (countdown <= 0) {
                clearInterval(timer);
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
              }
            }, 1000);
          } else {
            sendBtn.disabled = false;
          }
          showModalAlert(result?.message || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        sendBtn.disabled = false;
        showModalAlert('å‘é€å¤±è´¥: ' + error.message);
      }
    }

    async function submitAdminModifyPhone() {
      const username = $('admin-modify-phone-username').value;
      const newPhone = $('admin-modify-phone-new').value.trim();
      const code = $('admin-modify-phone-code').value.trim();

      if (!newPhone) {
        showModalAlert('è¯·è¾“å…¥æ–°æ‰‹æœºå·');
        return;
      }

      if (!/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼');
        return;
      }

      // åœ¨æäº¤å‰ï¼Œå…ˆæ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²è¢«ç»‘å®š
      try {
        const bindResult = await callPythonAPI_raw('/api/auth/check_phone', 'POST', { phone: newPhone });

        // æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šï¼Œå¹¶ä¸”ç»‘å®šçš„ä¸æ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„è¿™ä¸ªç”¨æˆ·
        if (bindResult && bindResult.is_bound && bindResult.bound_to_user !== username) {
          // æ‰‹æœºå·è¢«å…¶ä»–äººå ç”¨äº†ï¼Œå¼¹çª—ç¡®è®¤
          const confirmed = await jsShowConfirm(
            'æ‰‹æœºå·å·²è¢«ç»‘å®š',
            `æ‚¨è¾“å…¥çš„æ–°æ‰‹æœºå· ${newPhone} å·²è¢«ç”¨æˆ· ${bindResult.bound_to_user} ç»‘å®šã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ\n\nå¦‚æœç»§ç»­ï¼Œè¯¥æ‰‹æœºå·å°†ä»åŸè´¦å·ä¸Šå¼ºåˆ¶è§£ç»‘å¹¶ç»‘å®šåˆ° ${username} è´¦å·ä¸Šã€‚`
          );

          if (!confirmed) {
            logMessage_Info("[ç®¡ç†å‘˜ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œå› ä¸ºæ‰‹æœºå·å·²è¢«ç»‘å®šã€‚");
            return; // ç”¨æˆ·å–æ¶ˆæ“ä½œ
          }
          logMessage_Info("[ç®¡ç†å‘˜ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å·²ç¡®è®¤å¼ºåˆ¶è§£ç»‘ï¼Œç»§ç»­æ“ä½œ...");
        } else if (bindResult && bindResult.is_bound && bindResult.bound_to_user === username) {
          // æ‰‹æœºå·å·²ç»ç»‘å®šåœ¨å½“å‰ç”¨æˆ·èº«ä¸Šäº†ï¼Œè¿™ä¸ç®—é”™è¯¯ï¼Œç›´æ¥æç¤ºå¹¶å…³é—­å³å¯
          showModalAlert('æ­¤æ‰‹æœºå·å·²ç»‘å®šåˆ°è¯¥ç”¨æˆ·ã€‚', 'æç¤º');
          closeAdminModifyPhoneModal();
          return;
        }
        // å¦‚æœæœªç»‘å®š (is_bound: false) æˆ– æ£€æŸ¥APIå¤±è´¥ (bindResult is null/false)ï¼Œ
        // åˆ™ç»§ç»­æ‰§è¡Œï¼ˆåç«¯APIä¼šåšæœ€ç»ˆéªŒè¯ï¼Œä¾‹å¦‚éªŒè¯ç ï¼‰

      } catch (e) {
        logMessage_Error('æ£€æŸ¥æ‰‹æœºå·ç»‘å®šå¤±è´¥:', e);
        showModalAlert(`æ£€æŸ¥æ‰‹æœºå·å¤±è´¥: ${e.message}ï¼Œè¯·ç¨åé‡è¯•`, 'ç½‘ç»œé”™è¯¯');
        return; // æ£€æŸ¥å¤±è´¥æ—¶åœæ­¢æ“ä½œ
      }


      try {
        const response = await fetch('/auth/admin/update_user_phone', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: username,
            new_phone: newPhone,
            sms_code: code || ''
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„æ‰‹æœºå·å·²æ›´æ–°`, 'æˆåŠŸ');
          closeAdminModifyPhoneModal();
          loadAdminUsers();
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }


    // --- ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æ˜µç§° ---
    function modifyUserNickname(username, currentNickname) {
      // æ‰“å¼€äºŒçº§æ¨¡æ€æ¡†
      $('admin-modify-nickname-username').value = username;
      $('admin-modify-nickname-new').value = currentNickname || ''; // é¢„å¡«å……å½“å‰æ˜µç§°
      $('admin-modify-nickname-modal').classList.remove('hidden');
    }

    function closeAdminModifyNicknameModal() {
      $('admin-modify-nickname-modal').classList.add('hidden');
    }

    async function submitAdminModifyNickname() {
      const username = $('admin-modify-nickname-username').value;
      const newNickname = $('admin-modify-nickname-new').value.trim();

      if (!newNickname) {
        showModalAlert('è¯·è¾“å…¥æ–°æ˜µç§°');
        return;
      }

      try {
        // è°ƒç”¨æ–°çš„åç«¯API
        const response = await fetch('/auth/admin/update_user_nickname', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: username,
            nickname: newNickname
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„æ˜µç§°å·²æ›´æ–°`, 'æˆåŠŸ');
          closeAdminModifyNicknameModal();
          loadAdminUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }


    // ====================
    // åŠ è½½ç”¨æˆ·å¤´åƒ
    // ====================
    // æƒé™ç»„ç®¡ç†åŠŸèƒ½å‡½æ•°
    // ====================
    async function deleteGroup(groupKey) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤æƒé™ç»„ ${groupKey} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/delete_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ group_key: groupKey })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`æƒé™ç»„ ${groupKey} å·²åˆ é™¤`, 'æˆåŠŸ');
          loadAdminGroups();
        } else {
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function editGroupPermissions(groupKey) {
      currentEditGroupKey = groupKey;
      if (groupKey === null || groupKey === undefined) return;
      if (groupKey === 'super_admin') {
        showModalAlert('æ— æ³•ç¼–è¾‘è¶…çº§ç®¡ç†å‘˜æƒé™ç»„', 'é”™è¯¯');
        return;
      }
      const modal = $('edit-group-permissions-modal');
      if (!modal) return;

      try {
        // è·å–æƒé™ç»„ä¿¡æ¯
        const response = await fetch('/auth/admin/list_groups', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (!result.success || !result.groups || !result.groups[groupKey]) {
          showModalAlert('æ— æ³•åŠ è½½æƒé™ç»„ä¿¡æ¯', 'é”™è¯¯');
          return;
        }

        const group = result.groups[groupKey];
        const nameEl = $('edit-group-name');
        if (nameEl) {
          nameEl.textContent = `${group.name} (${groupKey})`;
        }

        // æ¸²æŸ“æƒé™åˆ—è¡¨
        const permissionsContainer = $('edit-group-permissions-list');
        if (permissionsContainer && group.permissions) {
          permissionsContainer.innerHTML = Object.keys(group.permissions).map(perm => `
            <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer">
              <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}" ${group.permissions[perm] ? 'checked' : ''}>
              <span class="text-sm text-slate-700">${translatePermission(perm)}</span>
            </label>
          `).join('');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } catch (e) {
        showModalAlert('åŠ è½½å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function closeEditGroupPermissionsModal() {
      const modal = $('edit-group-permissions-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      currentEditGroupKey = null;
    }

    async function submitEditGroupPermissions() {
      if (!currentEditGroupKey) return;

      const permissionsContainer = $('edit-group-permissions-list');
      if (!permissionsContainer) return;

      // æ”¶é›†æƒé™
      const permissions = {};
      const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const perm = cb.getAttribute('data-permission');
        permissions[perm] = cb.checked;
      });

      try {
        const response = await fetch('/auth/admin/update_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            group_key: currentEditGroupKey,
            permissions: permissions
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`æƒé™ç»„ ${currentEditGroupKey} å·²æ›´æ–°`, 'æˆåŠŸ');
          closeEditGroupPermissionsModal();
          loadAdminGroups();
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function loadAdminGroups() {
      try {
        const response = await fetch('/auth/admin/list_groups', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          $('admin-groups-list').innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const listEl = $('admin-groups-list_modal');
        const groups = result.groups;

        listEl.innerHTML = Object.keys(groups).map(groupKey => {
          const group = groups[groupKey];
          const perms = group.permissions;
          const isSystemGroup = group.system || ['guest', 'user', 'admin', 'super_admin'].includes(groupKey);
          const systemBadge = isSystemGroup ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-2">ç³»ç»Ÿé¢„è®¾</span>' : '';

          // ============================================================
          // ä»»åŠ¡13ï¼šæƒé™ç»„Bugä¿®å¤ï¼ˆURLç¼–ç å’ŒHTMLè½¬ä¹‰ï¼‰
          // å¯¹groupKeyè¿›è¡ŒHTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSSæ”»å‡»å’Œç‰¹æ®Šå­—ç¬¦é—®é¢˜
          // ============================================================
          // å°†å•å¼•å·å’ŒåŒå¼•å·è½¬ä¹‰ï¼Œç¡®ä¿åœ¨HTMLå±æ€§ä¸­å®‰å…¨ä½¿ç”¨
          const escapedGroupKey = groupKey.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
          // å¯¹äºæ˜¾ç¤ºçš„æ–‡æœ¬ï¼Œä¹Ÿè¿›è¡ŒHTMLå®ä½“è½¬ä¹‰
          const displayGroupKey = groupKey.replace(/</g, '&lt;').replace(/>/g, '&gt;');

          return `
        <div class="border border-slate-200 rounded-lg p-4 mb-2">
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-semibold text-slate-800">${group.name} (${displayGroupKey})${systemBadge}</h5>
            <div class="flex gap-2">
              <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="editGroupPermissions('${escapedGroupKey}')">ç¼–è¾‘æƒé™</button>
              ${!isSystemGroup ? `<button class="btn btn-danger !py-0.5 !px-2 !text-xs" onclick="deleteGroup('${escapedGroupKey}')">åˆ é™¤</button>` : ''}
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            ${Object.keys(perms).map(perm => `
              <div class="flex items-center gap-2">
                <span class="${perms[perm] ? 'text-green-600' : 'text-slate-400'}">${perms[perm] ? 'âœ“' : 'âœ—'}</span>
                <span class="text-slate-600">${translatePermission(perm)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
        }).join('');
      } catch (e) {
        $('admin-groups-list').innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    async function loadAdminSessions() {
      const listEl = $('admin-sessions-list_modal'); // <-- å°† listEl å®šä¹‰ç§»åˆ° try å¤–éƒ¨çš„æœ€å¼€å§‹

      // --- æ£€æŸ¥ listEl æ˜¯å¦å­˜åœ¨ï¼Œç§»åˆ° try å¤–éƒ¨ ---
      if (!listEl) {
        logMessage_Error("loadAdminSessions: æ— æ³•æ‰¾åˆ°ä¼šè¯åˆ—è¡¨å®¹å™¨ 'admin-sessions-list_modal'ã€‚");
        // å¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œæ˜¾ç¤ºä¸€ä¸ªé€šç”¨çš„é”™è¯¯æç¤º
        showModalAlert("æ— æ³•åŠ è½½ä¼šè¯åˆ—è¡¨ï¼šç•Œé¢å…ƒç´ ä¸¢å¤±ã€‚", "é”™è¯¯");
        return; // å¦‚æœå…ƒç´ æ‰¾ä¸åˆ°ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…åç»­é”™è¯¯
      }
      // --- ç»“æŸç§»åŠ¨æ£€æŸ¥ ---

      try {
        // listEl å˜é‡ç°åœ¨åœ¨å¤–éƒ¨å·²å®šä¹‰å¹¶æ£€æŸ¥è¿‡

        listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>'; // <-- ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨

        // æ£€æŸ¥æ˜¯å¦å¼€å¯ä¸Šå¸æ¨¡å¼
        const godModeCheckbox = $('god-mode-checkbox_modal');
        const isGodMode = godModeCheckbox && godModeCheckbox.checked;

        let response;
        if (isGodMode) {
          // ä¸Šå¸æ¨¡å¼ï¼šè·å–æ‰€æœ‰ä¼šè¯
          response = await fetch('/auth/admin/all_sessions', {
            headers: {
              'X-Session-ID': sessionUUID
            }
          });
        } else {
          // æ™®é€šæ¨¡å¼ï¼šåªè·å–å½“å‰ç”¨æˆ·çš„ä¼šè¯
          response = await fetch('/auth/user/sessions', {
            headers: {
              'X-Session-ID': sessionUUID
            }
          });
        }
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`; // <-- ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨
          return;
        }

        // const listEl = $('admin-sessions-list_modal'); // <-- ç¡®ä¿è¿™è¡Œå·²åˆ é™¤æˆ–æ³¨é‡Šæ‰
        const sessions = result.sessions || [];

        // æ›´æ–°ä¼šè¯ä¿¡æ¯ï¼ˆä»åç«¯è·å–max_sessionsä¿¡æ¯ï¼‰
        const maxSessions = result.max_sessions !== undefined && result.max_sessions !== null ? result.max_sessions : -1;

        // è¿‡æ»¤æ‰æ— æ•ˆä¼šè¯ï¼ˆsession_id ä¸º nullã€undefined æˆ–ç©ºå­—ç¬¦ä¸²çš„ä¼šè¯ï¼‰
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');

        // æ›´æ–°ä¼šè¯è®¡æ•°æ˜¾ç¤º
        if (isGodMode) {
          updateAdminSessionCountDisplay(validSessions.length, -1); // ä¸Šå¸æ¨¡å¼æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
        } else {
          updateAdminSessionCountDisplay(validSessions.length, maxSessions);
        }

        // æ·»åŠ åˆ›å»ºæ–°ä¼šè¯æŒ‰é’® (æ¸¸å®¢æ¨¡å¼ä¸æ˜¾ç¤ºæ­¤æŒ‰é’®ï¼Œå‚è€ƒinlineç‰ˆæœ¬)
        let html = '';
        const isGuest = currentUserIsGuest;
        if (!isGodMode) {
          if (!isGuest) {
            // åªæœ‰éæ¸¸å®¢æ‰æ˜¾ç¤ºåˆ›å»ºæŒ‰é’®
            html = `
      <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-lg">
        <p class="text-sm text-slate-700 mb-2">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
        <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">åˆ›å»ºæ–°ä¼šè¯</button>
      </div>
    `;
          } else {
            // ç»™æ¸¸å®¢ä¸€ä¸ªæç¤ºï¼Œè¯´æ˜ä»–ä»¬åªæœ‰ä¸€ä¸ªå½“å‰ä¼šè¯
            html = `
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-700">æ¸¸å®¢æ¨¡å¼ï¼šå½“å‰ä¼šè¯å¦‚ä¸‹ã€‚å¦‚éœ€ä½¿ç”¨å¤šä¸ªä¼šè¯ï¼Œè¯·æ³¨å†Œè´¦å·ã€‚</p>
      </div>
    `;
          }
        }

        if (validSessions.length === 0) {
          html += '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯</p>';
        } else {
          html += validSessions.map(session => {
            const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
            const isCurrent = session.is_current || session.session_id === sessionUUID;
            const sessionHash = session.session_hash || session.session_id.substring(0, 16);

            // ä¸Šå¸æ¨¡å¼æ˜¾ç¤ºæ‰€æœ‰è€…ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸¸å®¢æ¨¡å¼æ ‡è¯†
            let ownerInfo = '';
            if (isGodMode) {
              if (session.username) {
                ownerInfo = `<p class="text-xs text-slate-500">åˆ›å»ºè€…: ${session.username}</p>`;
              } else {
                // æ²¡æœ‰usernameçš„ä¼šè¯è§†ä¸ºæ¸¸å®¢æ¨¡å¼
                ownerInfo = `<p class="text-xs text-amber-600">åˆ›å»ºè€…: æ¸¸å®¢æ¨¡å¼</p>`;
              }
            }

            return `
          <div class="border ${isCurrent ? 'border-sky-500 bg-sky-50' : 'border-slate-200'} rounded-lg p-3 mb-2">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold text-slate-800 break-all">ä¼šè¯ ${session.session_id}</p>
                ${isCurrent ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2">(å½“å‰ä¼šè¯)</span></p>' : ''}
                <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                <p class="text-xs text-slate-500">çŠ¶æ€: ${session.is_multi_account_mode
                ? (session.login_success ? '<span class="font-semibold text-purple-600">å¤šè´¦å·æ¨¡å¼ (å·²ç™»å½•)</span>' : '<span class="font-semibold text-purple-400">å¤šè´¦å·æ¨¡å¼ (æœªç™»å½•)</span>')
                : (session.login_success ? '<span class="font-semibold text-green-600">å·²ç™»å½•</span>' : 'æœªç™»å½•')
              }</p>
                ${ownerInfo}
              </div>
              <div class="flex gap-2">
                ${!isCurrent ? `
                  <button class="btn btn-ghost !py-1 !px-2 text-xs" onclick="selectSession('${session.session_id}')">é€‰æ‹©</button>
                  <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" onclick="deleteSession('${session.session_id}')">åˆ é™¤</button>
                ` : ''}
                ${isGodMode ? `<button class="btn btn-danger !py-1 !px-2 text-xs" onclick="destroySession('${session.session_id}')">é”€æ¯</button>` : ''}
              </div>
            </div>
          </div>
        `;
          }).join('');
        } // <-- çœç•¥ä¸å˜çš„æˆåŠŸæ¸²æŸ“é€»è¾‘...

        listEl.innerHTML = html; // <-- ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨

      } catch (e) {
        // ç°åœ¨ catch å—å¯ä»¥å®‰å…¨è®¿é—®å¤–éƒ¨å®šä¹‰çš„ listEl
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    // ========== ç•™è¨€æ¿åŠŸèƒ½ ========== //

    /**
     * ============================================================
     * IPå°ç¦æ£€æŸ¥è¾…åŠ©å‡½æ•°
     * ç”¨äºåœ¨å‰ç«¯æ‰§è¡ŒIPå°ç¦æ£€æŸ¥ï¼ˆè°ƒç”¨åç«¯APIï¼‰
     * ============================================================
     * 
     * @param {string} scope - æ£€æŸ¥èŒƒå›´ï¼ˆ'all'æˆ–'messages_only'ï¼‰
     * @returns {Promise<boolean>} - è¿”å›trueè¡¨ç¤ºIPè¢«å°ç¦ï¼Œfalseè¡¨ç¤ºæœªè¢«å°ç¦
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     *   é€šè¿‡è°ƒç”¨åç«¯çš„/api/admin/check_ip_banæ¥å£ï¼Œæ£€æŸ¥å½“å‰å®¢æˆ·ç«¯IPæ˜¯å¦è¢«å°ç¦ã€‚
     *   è¿™ä¸ªå‡½æ•°è¢«ç”¨åœ¨switchAdminTab('messages')å’ŒpostMessage()å‡½æ•°ä¸­ã€‚
     * 
     * ä½¿ç”¨ç¤ºä¾‹ï¼š
     *   const isBanned = await checkIPBanAndProceed('messages_only');
     *   if (isBanned) {
     *     showModalAlert('æ‚¨çš„IPå·²è¢«é™åˆ¶è®¿é—®ç•™è¨€åŠŸèƒ½');
     *     return;
     *   }
     */
    async function checkIPBanAndProceed(scope = 'all') {
      try {
        // è°ƒç”¨åç«¯APIæ£€æŸ¥IPå°ç¦çŠ¶æ€
        // åç«¯ä¼šè‡ªåŠ¨ä»request.remote_addrè·å–å®¢æˆ·ç«¯IP
        const response = await fetch('/api/admin/check_ip_ban', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ scope: scope })
        });

        const result = await response.json();

        // result.is_banned: trueè¡¨ç¤ºIPè¢«å°ç¦ï¼Œfalseè¡¨ç¤ºæœªè¢«å°ç¦
        return result.is_banned === true;
      } catch (err) {
        // ç½‘ç»œé”™è¯¯æˆ–è§£æé”™è¯¯ï¼Œä¸ºå®‰å…¨èµ·è§è¿”å›falseï¼ˆå…è®¸è®¿é—®ï¼‰
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´æ­¤è¡Œä¸º
        logMessage_Error('[IPå°ç¦æ£€æŸ¥] æ£€æŸ¥å¤±è´¥:', err);
        return false;
      }
    }

    async function loadMessages() {
      const listEl = $('admin-messages-list_modal');
      const guestFields = $('message-guest-fields');

      if (!listEl) {
        logMessage_Error("loadMessages: æ— æ³•æ‰¾åˆ°ç•™è¨€åˆ—è¡¨å®¹å™¨");
        return;
      }

      // æ ¹æ®ç”¨æˆ·ç±»å‹æ˜¾ç¤º/éšè—æ¸¸å®¢å­—æ®µ
      const isGuest = currentUserIsGuest;
      if (guestFields) {
        guestFields.style.display = isGuest ? 'block' : 'none';
      }

      // å­—ç¬¦è®¡æ•°å™¨
      const contentInput = $('message-content');
      const charCount = $('message-char-count');
      if (contentInput && charCount) {
        contentInput.addEventListener('input', () => {
          charCount.textContent = contentInput.value.length;
        });
      }

      try {
        listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

        const response = await fetch('/api/messages/list', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const messages = result.messages || [];

        if (messages.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç•™è¨€</p>';
          return;
        }

        // æ£€æŸ¥åˆ é™¤æƒé™
        const canDeleteAny = await checkAdminPermission('delete_any_messages');
        const canDeleteOwn = await checkAdminPermission('delete_own_messages');
        // ä½¿ç”¨ç³»ç»Ÿè®¤è¯ç”¨æˆ·å (currentAuthUsername) è€Œä¸æ˜¯å­¦æ ¡è´¦å·ç”¨æˆ·å (currentUserData?.username)
        const currentUsername = currentAuthUsername;

        const html = messages.map(msg => {
          // ä¿®å¤ï¼šæ£€æŸ¥ msg.auth_username æ˜¯å¦ç­‰äº currentAuthUsername
          const isOwnMessage = !msg.is_guest && msg.auth_username === currentUsername;
          // æ£€æŸ¥åˆ é™¤æƒé™ (æ­¤è¡Œé€»è¾‘æ˜¯æ­£ç¡®çš„)
          const canDelete = canDeleteAny || (canDeleteOwn && isOwnMessage);
          // æ˜¾ç¤ºåç§°ï¼šä¼˜å…ˆä½¿ç”¨nicknameï¼Œå…¶æ¬¡usernameæˆ–auth_username
          const displayName = msg.nickname || msg.username || msg.auth_username || 'åŒ¿å';
          // æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºæœ¬åœ°æ—¶é—´
          const date = new Date(msg.timestamp * 1000);
          const dateStr = date.toLocaleString('zh-CN');
          // è·å–å¤´åƒURLï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å¤´åƒ
          const rawAvatarUrl = msg.avatar_url || 'default_avatar.png';
          // è·å–IPå½’å±åœ°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸æ˜¾ç¤º
          const ipCity = msg.ip_city || '';



          let finalAvatarSrc;
          if (rawAvatarUrl.startsWith('/api/avatar/')) {
            // å·²ç»æ˜¯å®Œæ•´è·¯å¾„äº† (ä¾‹å¦‚ /api/avatar/hash.png)ï¼Œç›´æ¥ä½¿ç”¨
            finalAvatarSrc = rawAvatarUrl;
          } else {
            // æ˜¯æ–‡ä»¶å (ä¾‹å¦‚ default_avatar.png æˆ–æ—§çš„ hash.png)ï¼Œæ·»åŠ å‰ç¼€
            finalAvatarSrc = `/api/avatar/${rawAvatarUrl}`;
          }

          // ä¸ºå¤´åƒURLé™„åŠ  session_id æŸ¥è¯¢å‚æ•°ä»¥é€šè¿‡è®¤è¯
          // ç¡®ä¿ sessionUUID å…¨å±€å˜é‡å¯ç”¨
          if (typeof sessionUUID !== 'undefined' && sessionUUID) {
            // æ£€æŸ¥URLæ˜¯å¦å·²æœ‰æŸ¥è¯¢å‚æ•°
            if (finalAvatarSrc.includes('?')) {
              finalAvatarSrc += `&session_id=${sessionUUID}`;
            } else {
              finalAvatarSrc += `?session_id=${sessionUUID}`;
            }
          }

          return `
            <div class="bg-white border border-slate-200 rounded-lg p-4 space-y-2">
              <div class="flex justify-between items-start gap-3">
                <!-- å·¦ä¾§ï¼šå¤´åƒå’Œç”¨æˆ·ä¿¡æ¯ -->
                <div class="flex gap-3 flex-1">
                  <!-- ç”¨æˆ·å¤´åƒ -->
                  <div class="flex-shrink-0 w-12 h-12 rounded-full bg-slate-200 overflow-hidden border-2 border-slate-300">
                    <img src="${finalAvatarSrc}" alt="å¤´åƒ" class="w-full h-full object-cover"
                      onerror="const p = this.parentElement; p.innerHTML='<span class=\\'text-2xl text-slate-400\\'>ğŸ‘¤</span>'; p.classList.add('flex', 'items-center', 'justify-center');">
                  </div>
                  <!-- ç”¨æˆ·ä¿¡æ¯ -->
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-semibold text-slate-700">${escapeHtml(displayName)}</span>
                      ${msg.is_guest ? '<span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded">æ¸¸å®¢</span>' : ''}
                      ${ipCity ? `<span class="text-xs text-slate-500">æ¥è‡ª ${escapeHtml(ipCity)}</span>` : ''}
                    </div>
                    ${msg.email ? `<p class="text-xs text-slate-500">${escapeHtml(msg.email)}</p>` : ''}
                    <p class="text-xs text-slate-400">${dateStr}</p>
                  </div>
                </div>
                <!-- å³ä¾§ï¼šåˆ é™¤æŒ‰é’® -->
                ${canDelete ? `
                  <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" 
                    onclick="deleteMessage('${msg.id}')">åˆ é™¤</button>
                ` : ''}
              </div>
              <!-- ç•™è¨€å†…å®¹ -->
              <p class="text-slate-700 whitespace-pre-wrap break-words pl-15">${escapeHtml(msg.content)}</p>
            </div>
          `;
        }).join('');

        listEl.innerHTML = html;

      } catch (e) {
        logMessage_Error('åŠ è½½ç•™è¨€å¤±è´¥:', e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    async function postMessage() {
      // ============================================================
      // IPå°ç¦æ£€æŸ¥ï¼šå‘è¡¨ç•™è¨€åŠŸèƒ½
      // åœ¨å‘è¡¨ç•™è¨€å‰ï¼Œå…ˆæ£€æŸ¥å½“å‰å®¢æˆ·ç«¯IPæ˜¯å¦è¢«å°ç¦
      // ============================================================
      const isBanned = await checkIPBanAndProceed('messages_only');
      if (isBanned) {
        // IPè¢«å°ç¦ï¼Œé˜»æ­¢å‘è¡¨ç•™è¨€
        showModalAlert('æ‚¨çš„IPå·²è¢«é™åˆ¶è®¿é—®ç•™è¨€åŠŸèƒ½', 'è®¿é—®è¢«æ‹’ç»');
        return;
      }

      const contentInput = $('message-content');
      const nicknameInput = $('message-nickname');
      const emailInput = $('message-email');
      const postBtn = $('post-message-btn');

      if (!contentInput || !postBtn) return;

      const content = contentInput.value.trim();
      const nickname = nicknameInput ? nicknameInput.value.trim() : '';
      const email = emailInput ? emailInput.value.trim() : '';

      if (!content) {
        showModalAlert('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'æç¤º');
        return;
      }

      const isGuest = currentUserData?.is_guest;

      if (isGuest) {
        if (!nickname) {
          showModalAlert('æ¸¸å®¢å¿…é¡»å¡«å†™æ˜µç§°', 'æç¤º');
          return;
        }
        if (!email) {
          showModalAlert('æ¸¸å®¢å¿…é¡»å¡«å†™é‚®ç®±', 'æç¤º');
          return;
        }
      }

      try {
        postBtn.disabled = true;
        postBtn.textContent = 'å‘è¡¨ä¸­...';

        const response = await fetch('/api/messages/post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            content: content,
            nickname: nickname,
            email: email
          })
        });

        const result = await response.json();

        if (result.success) {
          contentInput.value = '';
          if (nicknameInput) nicknameInput.value = '';
          if (emailInput) emailInput.value = '';
          const charCount = $('message-char-count');
          if (charCount) charCount.textContent = '0';

          showModalAlert('ç•™è¨€å‘è¡¨æˆåŠŸ', 'æˆåŠŸ');
          await loadMessages();
        } else {
          showModalAlert(result.message || 'å‘è¡¨ç•™è¨€å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error('å‘è¡¨ç•™è¨€å¤±è´¥:', e);
        showModalAlert('å‘è¡¨ç•™è¨€å¤±è´¥: ' + e.message, 'é”™è¯¯');
      } finally {
        postBtn.disabled = false;
        postBtn.textContent = 'å‘è¡¨ç•™è¨€';
      }
    }

    async function deleteMessage(messageId) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ');
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch('/api/messages/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            message_id: messageId
          })
        });

        const result = await response.json();

        if (result.success) {
          showModalAlert('ç•™è¨€å·²åˆ é™¤', 'æˆåŠŸ');
          await loadMessages();
        } else {
          showModalAlert(result.message || 'åˆ é™¤ç•™è¨€å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error('åˆ é™¤ç•™è¨€å¤±è´¥:', e);
        showModalAlert('åˆ é™¤ç•™è¨€å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    // ============================================================
    // ä»»åŠ¡14ï¼šç”¨æˆ·æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½
    // æä¾›æŸ¥çœ‹ç”¨æˆ·ç™»å½•è®°å½•å’Œæ“ä½œè®°å½•çš„åŠŸèƒ½
    // ============================================================

    /**
     * æ˜¾ç¤ºç”¨æˆ·æ—¥å¿—Modalå¹¶åŠ è½½ç™»å½•è®°å½•
     * @param {string} username - è¦æŸ¥çœ‹æ—¥å¿—çš„ç”¨æˆ·å
     */
    // é—®é¢˜10ä¿®å¤ï¼šshowUserLogsæ”¹ä¸ºäºŒçº§æ¨¡æ€çª—
    function showUserLogs(username) {
      // æ‰“å¼€äºŒçº§æ¨¡æ€æ¡†
      $('user-logs-secondary-modal').classList.remove('hidden');

      // è®¾ç½®å½“å‰æŸ¥çœ‹çš„ç”¨æˆ·å
      const usernameDisplay = $('current-log-username-secondary');
      if (usernameDisplay) usernameDisplay.textContent = username;

      // é‡ç½®TabçŠ¶æ€ï¼ˆæ˜¾ç¤ºç™»å½•è®°å½•ï¼‰
      const loginTab = $('log-tab-login-secondary');
      const auditTab = $('log-tab-audit-secondary');
      const loginContent = $('log-login-content-secondary');
      const auditContent = $('log-audit-content-secondary');

      if (loginTab) {
        loginTab.classList.add('text-sky-600', 'border-sky-600');
        loginTab.classList.remove('text-slate-400', 'border-transparent');
      }
      if (auditTab) {
        auditTab.classList.add('text-slate-400', 'border-transparent');
        auditTab.classList.remove('text-sky-600', 'border-sky-600');
      }
      if (loginContent) loginContent.classList.remove('hidden');
      if (auditContent) auditContent.classList.add('hidden');

      // åŠ è½½ç™»å½•è®°å½•
      loadUserLoginLogsSecondary(username);
    }

    function closeUserLogsSecondaryModal() {
      $('user-logs-secondary-modal').classList.add('hidden');
    }

    function switchUserLogTab(tab) {
      const loginTab = $('log-tab-login-secondary');
      const auditTab = $('log-tab-audit-secondary');
      const loginContent = $('log-login-content-secondary');
      const auditContent = $('log-audit-content-secondary');
      const username = $('current-log-username-secondary').textContent;

      if (tab === 'login') {
        loginTab.classList.add('text-sky-600', 'border-sky-600');
        loginTab.classList.remove('text-slate-400', 'border-transparent');
        auditTab.classList.add('text-slate-400', 'border-transparent');
        auditTab.classList.remove('text-sky-600', 'border-sky-600');
        loginContent.classList.remove('hidden');
        auditContent.classList.add('hidden');
        loadUserLoginLogsSecondary(username);
      } else if (tab === 'audit') {
        auditTab.classList.add('text-sky-600', 'border-sky-600');
        auditTab.classList.remove('text-slate-400', 'border-transparent');
        loginTab.classList.add('text-slate-400', 'border-transparent');
        loginTab.classList.remove('text-sky-600', 'border-sky-600');
        auditContent.classList.remove('hidden');
        loginContent.classList.add('hidden');
        loadUserAuditLogsSecondary(username);
      }
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æ—¥å¿—å¯¹è±¡ç”ŸæˆçŠ¶æ€å¾½ç« 
     * @param {object} log - åç«¯è¿”å›çš„æ—¥å¿—æ¡ç›®
     * @returns {string} HTML å­—ç¬¦ä¸²
     */
    function getLoginStatusBadge(log) {
      if (log.success) {
        if (log.reason === 'guest_login') {
          return '<span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-600">æ¸¸å®¢ç™»å½•</span>';
        }
        return '<span class="text-xs px-2 py-1 rounded bg-green-100 text-green-600">ç™»å½•æˆåŠŸ</span>';
      }

      // å¤„ç†å¤±è´¥åŸå› 
      let reasonText = 'ç™»å½•å¤±è´¥';
      let reasonClass = 'bg-red-100 text-red-700'; // é»˜è®¤ä¸ºçº¢è‰²

      switch (log.reason) {
        case 'brute_force_locked':
          reasonText = 'å°è¯•è¿‡å¤š';
          break;
        case 'user_not_found':
          reasonText = 'ç”¨æˆ·ä¸å­˜åœ¨';
          break;
        case 'user_banned':
          reasonText = 'è´¦å·å·²å°ç¦';
          break;
        case 'wrong_password':
          reasonText = 'å¯†ç é”™è¯¯';
          break;
        case '2fa_failed':
          reasonText = '2FAéªŒè¯å¤±è´¥';
          reasonClass = 'bg-orange-100 text-orange-700'; // 2FAå¤±è´¥ä½¿ç”¨æ©™è‰²
          break;
      }
      return `<span class="text-xs px-2 py-1 rounded ${reasonClass}">${reasonText}</span>`;
    }

    /**
     * åŠ è½½ç”¨æˆ·çš„ç™»å½•è®°å½•ï¼ˆäºŒçº§æ¨¡æ€çª—ç‰ˆæœ¬ï¼‰
     * @param {string} username - ç”¨æˆ·å
     */
    async function loadUserLoginLogsSecondary(username) {
      const content = $('log-login-content-secondary');
      if (!content) return;

      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        // è°ƒç”¨åç«¯APIè·å–ç™»å½•è®°å½•
        const response = await fetch(`/api/admin/logs/login_history?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          // æ¸²æŸ“ç™»å½•è®°å½•åˆ—è¡¨
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ç™»å½•æ—¶é—´: ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IPåœ°å€: ${log.ip_address || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    è®¾å¤‡ä¿¡æ¯: ${log.user_agent || 'N/A'}
                  </p>
                  ${log.location ? `<p class="text-sm text-slate-600 mt-1">ä½ç½®: ${log.location}</p>` : ''}
                </div>
                <div class="flex-shrink-0">
                  ${getLoginStatusBadge(log)}
                </div>
              </div>
            </div>
          `).join('');
        } else {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç™»å½•è®°å½•</p>';
        }
      } catch (e) {
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    /**
     * åŠ è½½ç”¨æˆ·çš„æ“ä½œè®°å½•ï¼ˆäºŒçº§æ¨¡æ€çª—ç‰ˆæœ¬ï¼‰
     * @param {string} username - ç”¨æˆ·å
     */
    async function loadUserAuditLogsSecondary(username) {
      const content = $('log-audit-content-secondary');
      if (!content) return;

      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        // è°ƒç”¨åç«¯APIè·å–æ“ä½œè®°å½•
        const response = await fetch(`/api/admin/logs/audit?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          // æ¸²æŸ“æ“ä½œè®°å½•åˆ—è¡¨
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    æ—¶é—´: ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    æ“ä½œç±»å‹: ${log.action || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    è¯¦æƒ…: ${log.details || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IPåœ°å€: ${log.ip_address || 'N/A'}
                  </p>
                </div>
              </div>
            </div>
          `).join('');
        } else {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— æ“ä½œè®°å½•</p>';
        }
      } catch (e) {
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    /**
     * åŠ è½½ç”¨æˆ·çš„ç™»å½•è®°å½•
     * @param {string} username - ç”¨æˆ·å
     */
    async function loadUserLoginLogs(username) {
      const content = $('log-login-content');
      if (!content) return;

      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        // è°ƒç”¨åç«¯APIè·å–ç™»å½•è®°å½•ï¼Œä½¿ç”¨encodeURIComponentå¯¹ç”¨æˆ·åè¿›è¡ŒURLç¼–ç 
        const response = await fetch(`/api/admin/logs/login_history?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          // æ¸²æŸ“ç™»å½•è®°å½•åˆ—è¡¨
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ç™»å½•æ—¶é—´: ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IPåœ°å€: ${log.ip_address || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    è®¾å¤‡ä¿¡æ¯: ${log.user_agent || 'N/A'}
                  </p>
                  ${log.location ? `<p class="text-sm text-slate-600 mt-1">ä½ç½®: ${log.location}</p>` : ''}
                </div>
                <div class="flex-shrink-0">
                  ${getLoginStatusBadge(log)}
                </div>
              </div>
            </div>
          `).join('');
        } else {
          // æ²¡æœ‰è®°å½•æ—¶æ˜¾ç¤ºæç¤º
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç™»å½•è®°å½•</p>';
        }
      } catch (e) {
        logMessage_Error('åŠ è½½ç™»å½•è®°å½•å¤±è´¥:', e);
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    /**
     * åŠ è½½ç”¨æˆ·çš„æ“ä½œå®¡è®¡è®°å½•
     * @param {string} username - ç”¨æˆ·å
     */
    async function loadUserAuditLogs(username) {
      const content = $('log-audit-content');
      if (!content) return;

      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        // è°ƒç”¨åç«¯APIè·å–æ“ä½œè®°å½•ï¼Œä½¿ç”¨encodeURIComponentå¯¹ç”¨æˆ·åè¿›è¡ŒURLç¼–ç 
        const response = await fetch(`/api/admin/logs/audit?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          // æ¸²æŸ“æ“ä½œè®°å½•åˆ—è¡¨
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    æ“ä½œ: ${log.action || 'N/A'}
                  </p>
                  ${log.details ? `<p class="text-sm text-slate-500 mt-1">${log.details}</p>` : ''}
                  ${log.ip_address ? `<p class="text-xs text-slate-400 mt-1">IP: ${log.ip_address}</p>` : ''}
                </div>
          `).join('');
        } else {
          // æ²¡æœ‰è®°å½•æ—¶æ˜¾ç¤ºæç¤º
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— æ“ä½œè®°å½•</p>';
        }
      } catch (e) {
        logMessage_Error('åŠ è½½æ“ä½œè®°å½•å¤±è´¥:', e);
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    /**
     * å…³é—­ç”¨æˆ·æ—¥å¿—Modalï¼Œè¿”å›ç”¨æˆ·åˆ—è¡¨
     */
    function closeUserLogsModal() {
      // éšè—æ—¥å¿—é¢æ¿
      const logsModal = $('admin-user-logs-modal');
      if (logsModal) logsModal.classList.add('hidden');

      // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨é¢æ¿
      const usersPanel = $('admin-users-panel_modal');
      if (usersPanel) usersPanel.classList.remove('hidden');
    }

    // ====================
    // ä»»åŠ¡18ï¼šIPå°ç¦ç®¡ç†å‡½æ•°
    // ====================

    /**
     * åŠ è½½IPå°ç¦åˆ—è¡¨
     */
    async function loadIPBans() {
      try {
        const response = await fetch('/api/admin/ip_bans', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        const listEl = $('ip-ban-list');
        if (result.success && result.bans && result.bans.length > 0) {
          listEl.innerHTML = result.bans.map(ban => `
            <div class="border p-2 rounded flex justify-between items-center">
              <div>
                <span class="font-semibold">${escapeHtml(ban.target)}</span>
                <span class="text-xs text-slate-500 ml-2">[${ban.type}]</span>
                <span class="text-xs text-slate-500 ml-2">${ban.scope === 'all' ? 'å…¨éƒ¨' : 'ä»…ç•™è¨€æ¿'}</span>
              </div>
              <button onclick="removeIPBan('${ban.id}')" class="btn btn-danger !py-1 !px-2 !text-xs min-h-[44px]">åˆ é™¤</button>
            </div>
          `).join('');
        } else {
          listEl.innerHTML = '<p class="text-center py-4">æš‚æ— å°ç¦è§„åˆ™</p>';
        }
      } catch (e) {
        showModalAlert('åŠ è½½å¤±è´¥: ' + e.message);
      }
    }

    // ====================
    // IPå°ç¦ç®¡ç†å‡½æ•°
    // ====================

    // IPæ­£åˆ™è¡¨è¾¾å¼
    const ipRegex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

    // IPè½¬æ•´æ•°è¾…åŠ©å‡½æ•°
    function ipToInt(ip) {
      try {
        // ä½¿ç”¨ä½è¿ç®—å°†IPåœ°å€çš„å››ä¸ªå…«ä½å­—èŠ‚è½¬æ¢ä¸ºä¸€ä¸ª32ä½æ•´æ•°
        return ip.split('.').reduce((int, octet) => (int << 8) + parseInt(octet, 10), 0) >>> 0;
      } catch (e) {
        return 0; // è§£æå¤±è´¥è¿”å›0
      }
    }

    // ============================================================
    // IPå°ç¦æ¨¡æ€æ¡†éªŒè¯é€»è¾‘
    // ============================================================

    /**
     * éªŒè¯IPå°ç¦ç›®æ ‡è¾“å…¥
     * @returns {boolean} - æ˜¯å¦éªŒè¯é€šè¿‡
     */
    function validateIPBanTarget() {
      // DOMå…ƒç´ åœ¨å‡½æ•°è°ƒç”¨æ—¶æ‰è·å–
      const banTypeSelect = $('ban-type');
      const banTargetInput = $('ban-target');
      const banTargetError = $('ban-target-error');

      if (!banTypeSelect || !banTargetInput || !banTargetError) {
        logMessage_Error("validateIPBanTarget: æ— æ³•æ‰¾åˆ°IPå°ç¦æ¨¡æ€æ¡†çš„DOMå…ƒç´ ");
        return false;
      }

      const type = banTypeSelect.value;
      const target = banTargetInput.value.trim();

      if (!target) {
        banTargetError.textContent = 'å°ç¦ç›®æ ‡ä¸èƒ½ä¸ºç©º';
        banTargetError.classList.remove('hidden');
        banTargetInput.classList.add('border-red-500');
        return false;
      }

      if (type === 'ip' && !ipRegex.test(target)) {
        banTargetError.textContent = 'æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„å•ä¸ªIPåœ°å€ (ä¾‹å¦‚: 1.2.3.4)';
        banTargetError.classList.remove('hidden');
        banTargetInput.classList.add('border-red-500');
        return false;
      }

      if (type === 'range') {
        const parts = target.split('-');
        if (parts.length !== 2 || !ipRegex.test(parts[0].trim()) || !ipRegex.test(parts[1].trim())) {
          banTargetError.textContent = 'æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„IPèŒƒå›´ (ä¾‹å¦‚: 192.168.1.1-192.168.1.100)';
          banTargetError.classList.remove('hidden');
          banTargetInput.classList.add('border-red-500');
          return false;
        }
        // éªŒè¯IPå¤§å°
        const startIpInt = ipToInt(parts[0].trim());
        const endIpInt = ipToInt(parts[1].trim());
        if (startIpInt > endIpInt) {
          banTargetError.textContent = 'æ ¼å¼é”™è¯¯ï¼šèµ·å§‹IPå¿…é¡»å°äºæˆ–ç­‰äºç»“æŸIP';
          banTargetError.classList.remove('hidden');
          banTargetInput.classList.add('border-red-500');
          return false;
        }
      }

      // éªŒè¯é€šè¿‡
      banTargetError.classList.add('hidden');
      banTargetInput.classList.remove('border-red-500');
      return true;
    }


    /**
     * æ·»åŠ IPå°ç¦è§„åˆ™
     */
    async function addIPBan() {
      // 1. æ‰§è¡ŒéªŒè¯
      if (!validateIPBanTarget()) {
        // éªŒè¯å‡½æ•° validateIPBanTarget() ä¼šè‡ªåŠ¨æ˜¾ç¤ºé”™è¯¯æç¤º
        showModalAlert('è¾“å…¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥çº¢è‰²æç¤º', 'æ·»åŠ å¤±è´¥');
        return;
      }

      // 2. éªŒè¯é€šè¿‡ï¼Œè·å–å€¼
      const target = $('ban-target').value.trim();
      const type = $('ban-type').value;
      const scope = $('ban-scope').value;

      // 3. å‘é€è¯·æ±‚
      try {
        const response = await fetch('/api/admin/ip_bans', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ target, type, scope })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert('å°ç¦è§„åˆ™å·²æ·»åŠ ');
          $('ban-target').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

          const banTargetError = $('ban-target-error');
          const banTargetInput = $('ban-target');

          if (banTargetError) banTargetError.classList.add('hidden');


          banTargetError.classList.add('hidden'); // éšè—é”™è¯¯æç¤º
          banTargetInput.classList.remove('border-red-500'); // ç§»é™¤é”™è¯¯æ ·å¼
          loadIPBans(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
          showModalAlert(result.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    /**
     * åˆ é™¤IPå°ç¦è§„åˆ™
     */
    async function removeIPBan(banId) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤æ­¤å°ç¦è§„åˆ™å—ï¼Ÿ');
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/admin/ip_bans/${banId}`, {
          method: 'DELETE',
          headers: { 'X-Session-ID': sessionUUID }
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert('å°ç¦è§„åˆ™å·²åˆ é™¤');
          loadIPBans();
        } else {
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    // ====================
    // ä»»åŠ¡20ï¼šçŸ­ä¿¡æœåŠ¡é…ç½®å‡½æ•°
    // ====================

    /**
     * åŠ è½½çŸ­ä¿¡æœåŠ¡é…ç½®
     */
    /**
     * åŠ è½½çŸ­ä¿¡æœåŠ¡é…ç½®
     * ä»åç«¯APIè·å–çŸ­ä¿¡é…ç½®å¹¶å¡«å……åˆ°è¡¨å•ä¸­
     */
    async function loadSMSConfig() {
      try {
        // å‘é€GETè¯·æ±‚è·å–çŸ­ä¿¡é…ç½®
        const response = await fetch('/api/admin/sms/config', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        // æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
        if (result.success) {
          // ä¸»å¼€å…³ï¼šå¯ç”¨çŸ­ä¿¡æœåŠ¡
          $('sms-enabled').checked = result.config.enable_sms_service || false;

          // æ–°å¢ï¼šä¸‰ä¸ªå­å¼€å…³é…ç½®é¡¹
          // å…è®¸ç”¨æˆ·ä¿®æ”¹æ‰‹æœºå·
          $('sms-enable-phone-modification').checked = result.config.enable_phone_modification || false;
          // å…è®¸æ‰‹æœºå·ç™»å½•
          $('sms-enable-phone-login').checked = result.config.enable_phone_login || false;
          // æ³¨å†Œæ—¶éœ€è¦çŸ­ä¿¡éªŒè¯
          $('sms-enable-phone-registration-verify').checked = result.config.enable_phone_registration_verify || false;

          // çŸ­ä¿¡å®é…ç½®ä¿¡æ¯
          $('sms-username').value = result.config.username || '';
          $('sms-apikey').value = result.config.api_key || '';
          $('sms-signature').value = result.config.signature || '';
          $('sms-template').value = result.config.template_register || '';
          $('sms-code-expire').value = result.config.code_expire_minutes || 5;

          // é€Ÿç‡é™åˆ¶é…ç½®
          $('sms-limit-account').value = result.config.rate_limit_per_account_day || 10;
          $('sms-limit-ip').value = result.config.rate_limit_per_ip_day || 20;
          $('sms-limit-phone').value = result.config.rate_limit_per_phone_day || 5;

          // Webhookå›è°ƒåœ°å€ï¼ˆåªè¯»ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼‰
          $('sms-webhook-url').value = `${window.location.origin}/sms-reply-webhook`;
        }
      } catch (e) {
        // æ•è·å¼‚å¸¸å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        showModalAlert('åŠ è½½é…ç½®å¤±è´¥: ' + e.message);
      }
    }

    /**
     * ä¿å­˜çŸ­ä¿¡æœåŠ¡é…ç½®
     * æ”¶é›†è¡¨å•æ•°æ®å¹¶å‘é€åˆ°åç«¯APIä¿å­˜
     */
    async function saveSMSConfig() {
      // æ”¶é›†æ‰€æœ‰é…ç½®é¡¹çš„å€¼
      const config = {
        // ä¸»å¼€å…³ï¼šå¯ç”¨çŸ­ä¿¡æœåŠ¡
        enable_sms_service: $('sms-enabled').checked,

        // æ–°å¢ï¼šä¸‰ä¸ªå­å¼€å…³é…ç½®é¡¹
        enable_phone_modification: $('sms-enable-phone-modification').checked,
        enable_phone_login: $('sms-enable-phone-login').checked,
        enable_phone_registration_verify: $('sms-enable-phone-registration-verify').checked,

        // çŸ­ä¿¡å®é…ç½®ä¿¡æ¯ï¼ˆtrim()å»é™¤é¦–å°¾ç©ºæ ¼ï¼‰
        username: $('sms-username').value.trim(),
        api_key: $('sms-apikey').value.trim(),
        signature: $('sms-signature').value.trim(),
        template_register: $('sms-template').value.trim(),

        // æ•°å€¼ç±»å‹é…ç½®ï¼ˆä½¿ç”¨parseIntè½¬æ¢ï¼Œå¦‚æœè½¬æ¢å¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
        code_expire_minutes: parseInt($('sms-code-expire').value) || 5,
        rate_limit_per_account_day: parseInt($('sms-limit-account').value) || 10,
        rate_limit_per_ip_day: parseInt($('sms-limit-ip').value) || 20,
        rate_limit_per_phone_day: parseInt($('sms-limit-phone').value) || 5
      };

      try {
        // å‘é€POSTè¯·æ±‚ä¿å­˜é…ç½®
        const response = await fetch('/api/admin/sms/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(config)
        });

        // è§£æå“åº”ç»“æœ
        const result = await response.json();
        if (result.success) {
          // ä¿å­˜æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          showModalAlert('é…ç½®å·²ä¿å­˜');
        } else {
          // ä¿å­˜å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
          showModalAlert(result.message || 'ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        // æ•è·ç½‘ç»œå¼‚å¸¸æˆ–å…¶ä»–é”™è¯¯
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    /**
     * å¤„ç†çŸ­ä¿¡æœåŠ¡ä¸»å¼€å…³çš„å˜åŒ–äº‹ä»¶
     * å½“ä¸»å¼€å…³è¢«å…³é—­æ—¶ï¼Œè‡ªåŠ¨å…³é—­æ‰€æœ‰å­å¼€å…³
     * å½“ä¸»å¼€å…³è¢«æ‰“å¼€æ—¶ï¼Œä¸è‡ªåŠ¨ä¿®æ”¹å­å¼€å…³çŠ¶æ€
     */
    function handleSmsMainSwitchChange() {
      // è·å–ä¸»å¼€å…³çš„å½“å‰çŠ¶æ€
      const mainSwitchEnabled = $('sms-enabled').checked;

      // å¦‚æœä¸»å¼€å…³è¢«å…³é—­ï¼ˆfalseï¼‰ï¼Œåˆ™è‡ªåŠ¨å…³é—­æ‰€æœ‰å­å¼€å…³
      if (!mainSwitchEnabled) {
        // å…³é—­"å…è®¸ç”¨æˆ·ä¿®æ”¹æ‰‹æœºå·"å¼€å…³
        $('sms-enable-phone-modification').checked = false;
        // å…³é—­"å…è®¸æ‰‹æœºå·ç™»å½•"å¼€å…³
        $('sms-enable-phone-login').checked = false;
        // å…³é—­"æ³¨å†Œæ—¶éœ€è¦çŸ­ä¿¡éªŒè¯"å¼€å…³
        $('sms-enable-phone-registration-verify').checked = false;
      }
      // å¦‚æœä¸»å¼€å…³è¢«æ‰“å¼€ï¼ˆtrueï¼‰ï¼Œä¸ä¿®æ”¹å­å¼€å…³çŠ¶æ€ï¼Œç”±ç”¨æˆ·è‡ªè¡Œå†³å®š
    }

    /**
     * æŸ¥è¯¢çŸ­ä¿¡ä½™é¢
     */
    async function checkSMSBalance() {
      const btn = $('btn-check-sms-balance');
      const originalText = 'ğŸ’° æŸ¥è¯¢ä½™é¢';

      // 1. è®¾ç½®åŠ è½½çŠ¶æ€
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'æŸ¥è¯¢ä¸­...';
      }

      try {
        const response = await fetch('/api/admin/sms/check_balance', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (result.success) {
          // 2. å¡«å……æ–°çš„äºŒçº§æ¨¡æ€æ¡†
          const valEl = $('sms-balance-modal-value');
          const sentEl = $('sms-balance-modal-sent');
          const msgEl = $('sms-balance-modal-message');

          if (valEl) valEl.textContent = result.balance;
          if (sentEl) sentEl.textContent = result.sent_today;
          if (msgEl) {
            msgEl.textContent = result.message;

            // 3. å¤„ç†é€Ÿç‡é™åˆ¶æˆ–é”™è¯¯æ¶ˆæ¯çš„æ ·å¼
            if (result.message && (result.message.includes('é¢‘ç¹') || result.message.includes('å¤±è´¥'))) {
              // è­¦å‘Š/é™åˆ¶æ¶ˆæ¯
              msgEl.classList.add('text-amber-600', 'bg-amber-50');
              msgEl.classList.remove('text-slate-500', 'bg-slate-50');
            } else {
              // æˆåŠŸæ¶ˆæ¯
              msgEl.classList.remove('text-amber-600', 'bg-amber-50');
              msgEl.classList.add('text-slate-500', 'bg-slate-50');
            }
          }

          // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
          openSMSBalanceModal();

        } else {
          // 5. æ˜¾ç¤ºæŸ¥è¯¢å¤±è´¥ï¼ˆésuccessï¼‰
          showModalAlert(result.message || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (e) {
        // 6. æ•è·ç½‘ç»œç­‰å¼‚å¸¸
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      } finally {
        // 7. æ¢å¤æŒ‰é’®çŠ¶æ€
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    }

    /**
     * æ‰“å¼€çŸ­ä¿¡ä½™é¢æ¨¡æ€çª—
     */
    function openSMSBalanceModal() {
      showModal('sms-balance-modal');
    }

    /**
     * å…³é—­çŸ­ä¿¡ä½™é¢æ¨¡æ€çª—
     */
    function closeSMSBalanceModal() {
      hideModal('sms-balance-modal');
    }

    // ==================== çŸ­ä¿¡å‘é€å†å²åŠŸèƒ½ ====================

    /**
     * æ‰“å¼€çŸ­ä¿¡å‘é€å†å²æ¨¡æ€çª—
     */
    function openSMSHistoryModal() {
      $('sms-history-modal').classList.remove('hidden');
      loadSMSHistory();
    }

    /**
     * å…³é—­çŸ­ä¿¡å‘é€å†å²æ¨¡æ€çª—
     */
    function closeSMSHistoryModal() {
      $('sms-history-modal').classList.add('hidden');
    }

    /**
     * åŠ è½½çŸ­ä¿¡å‘é€å†å²è®°å½•
     */
    async function loadSMSHistory() {
      try {
        // è·å–è¿‡æ»¤æ¡ä»¶
        const dateFilter = $('sms-history-date-filter').value;
        const phoneFilter = $('sms-history-phone-filter').value.trim();

        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams();
        if (dateFilter) params.append('date', dateFilter);
        if (phoneFilter) params.append('phone', phoneFilter);

        const response = await fetch(`/api/admin/sms/history?${params.toString()}`, {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        const listContainer = $('sms-history-list');

        if (result.success && result.records && result.records.length > 0) {
          listContainer.innerHTML = result.records.map(record => `
            <div class="border-2 border-slate-200 rounded-lg p-4 hover:border-sky-300 transition-colors bg-white">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <span class="text-xs text-slate-500">ğŸ“± æ‰‹æœºå·</span>
                  <p class="font-semibold text-slate-700">+86 ${record.phone || 'N/A'}</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">ğŸ‘¤ ç”¨æˆ·å</span>
                  <p class="font-semibold text-slate-700">${record.username || 'æœªçŸ¥'}</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">ğŸ• æ—¶é—´</span>
                  <p class="text-sm text-slate-600">${record.datetime || 'N/A'}</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">ğŸŒ IPåœ°å€</span>
                  <p class="text-sm text-slate-600">${record.ip || 'N/A'}</p>
                </div>
                <div class="md:col-span-2">
                  <span class="text-xs text-slate-500">ğŸ’¬ çŸ­ä¿¡å†…å®¹</span>
                  <p class="text-sm text-slate-600 bg-slate-50 p-2 rounded mt-1">${escapeHtml(record.content || '')}</p>
                </div>
                ${record.session_id && record.session_id !== '' && record.session_id !== 'null' ? `
                <div class="md:col-span-2">
                  <span class="text-xs text-slate-500">ğŸ” ä¼šè¯ID</span>
                  <p class="text-xs text-slate-400 font-mono">${record.session_id}</p>
                </div>
                ` : ''}
              </div>
            </div>
          `).join('');
        } else {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— è®°å½•</p>';
        }
      } catch (e) {
        showModalAlert('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + e.message);
      }
    }

    // ==================== éªŒè¯ç ç®¡ç†åŠŸèƒ½ ====================

    // å…¨å±€å€’è®¡æ—¶å®šæ—¶å™¨å˜é‡
    let verificationCodesCountdownInterval = null;

    /**
     * æ›´æ–°éªŒè¯ç å€’è®¡æ—¶çš„å‡½æ•°
     */
    function updateVerificationCodeCountdowns() {
      const countdownElements = document.querySelectorAll('.verification-code-countdown');
      if (countdownElements.length === 0) {
        // å¦‚æœæ²¡æœ‰å€’è®¡æ—¶å…ƒç´ ï¼ˆä¾‹å¦‚åˆ—è¡¨ä¸ºç©ºæˆ–å·²å…³é—­ï¼‰ï¼Œåœæ­¢å®šæ—¶å™¨
        stopVerificationCodesCountdown();
        return;
      }

      const now = Math.floor(Date.now() / 1000); // å½“å‰æ—¶é—´ï¼ˆç§’ï¼‰

      countdownElements.forEach(el => {
        const expiresAt = parseInt(el.dataset.expiresAt, 10);
        if (isNaN(expiresAt)) {
          el.textContent = "å·²å¤±æ•ˆ";
          return;
        }

        const expiresIn = Math.max(0, expiresAt - now);
        const minutes = Math.floor(expiresIn / 60);
        const seconds = expiresIn % 60;

        el.textContent = `${minutes}åˆ†${seconds}ç§’`;

        if (expiresIn <= 0) {
          el.textContent = "å·²å¤±æ•ˆ";
          el.classList.add('text-red-600', 'font-semibold');
        } else if (expiresIn < 120) { // å°äº2åˆ†é’Ÿ
          el.classList.add('text-red-600', 'font-semibold');
          el.classList.remove('text-slate-600');
        }
      });
    }

    /**
     * å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨
     */
    function startVerificationCodesCountdown() {
      stopVerificationCodesCountdown(); // å…ˆåœæ­¢æ—§çš„
      updateVerificationCodeCountdowns(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      verificationCodesCountdownInterval = setInterval(updateVerificationCodeCountdowns, 1000); // æ¯ç§’æ›´æ–°
    }

    /**
     * åœæ­¢å€’è®¡æ—¶å®šæ—¶å™¨
     */
    function stopVerificationCodesCountdown() {
      if (verificationCodesCountdownInterval) {
        clearInterval(verificationCodesCountdownInterval);
        verificationCodesCountdownInterval = null;
      }
    }


    /**
     * æ‰“å¼€éªŒè¯ç ç®¡ç†æ¨¡æ€çª—
     */
    function openVerificationCodesModal() {
      $('verification-codes-modal').classList.remove('hidden');
      loadVerificationCodes();
      // startVerificationCodesCountdown();
    }

    /**
     * å…³é—­éªŒè¯ç ç®¡ç†æ¨¡æ€çª—
     */
    function closeVerificationCodesModal() {
      $('verification-codes-modal').classList.add('hidden');
      stopVerificationCodesCountdown();
    }

    /**
     * åŠ è½½å½“å‰æœ‰æ•ˆçš„éªŒè¯ç åˆ—è¡¨
     */
    async function loadVerificationCodes() {
      try {
        const response = await fetch('/api/admin/sms/verification_codes', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        const listContainer = $('verification-codes-list');

        if (result.success && result.codes && result.codes.length > 0) {
          listContainer.innerHTML = result.codes.map(item => {
            const expiresIn = Math.max(0, Math.floor(item.expires_in / 60));
            const expiresSec = Math.max(0, item.expires_in % 60);
            return `
            <div class="border-2 border-slate-200 rounded-lg p-4 bg-white hover:border-sky-300 transition-colors">
              <div class="flex items-center justify-between gap-4">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <span class="text-xs text-slate-500">ğŸ“± æ‰‹æœºå·</span>
                    <p class="font-semibold text-slate-700">+86 ${item.phone}</p>
                  </div>
                  <div>
                    <span class="text-xs text-slate-500">ğŸ”¢ éªŒè¯ç </span>
                    <p class="font-mono text-lg font-bold text-sky-600">${item.code}</p>
                  </div>
                  <div>
                    <span class="text-xs text-slate-500">â° å‰©ä½™æ—¶é—´</span>
                    <p class="verification-code-countdown text-sm ${expiresIn < 2 ? 'text-red-600 font-semibold' : 'text-slate-600'}"
                       data-expires-at="${item.expires_at}">
                      ${expiresIn}åˆ†${expiresSec}ç§’
                    </p>
                  </div>
                </div>
                <button onclick="invalidateVerificationCode('${item.phone}')" 
                  class="btn btn-ghost border border-red-300 text-red-600 hover:bg-red-50 whitespace-nowrap">
                  âŒ å¤±æ•ˆ
                </button>
              </div>
            </div>
          `}).join('');
        } else {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">å½“å‰æ²¡æœ‰æœ‰æ•ˆçš„éªŒè¯ç </p>';
        }

        // --- ä¿®æ­£ï¼šåœ¨æ­¤å¤„å¯åŠ¨å€’è®¡æ—¶ï¼Œç¡®ä¿å…ƒç´ å·²æ¸²æŸ“ ---
        startVerificationCodesCountdown();

      } catch (e) {
        showModalAlert('åŠ è½½éªŒè¯ç åˆ—è¡¨å¤±è´¥: ' + e.message);
        // --- ä¿®æ­£ï¼šåŠ è½½å¤±è´¥æ—¶åœæ­¢å€’è®¡æ—¶ ---
        stopVerificationCodesCountdown();
      }
    }

    /**
     * ä½¿éªŒè¯ç å¤±æ•ˆ
     */
    async function invalidateVerificationCode(phone) {
      const confirmed = await jsShowConfirm('ç¡®è®¤å¤±æ•ˆ', `ç¡®å®šè¦ä½¿æ‰‹æœºå· +86 ${phone} çš„éªŒè¯ç å¤±æ•ˆå—ï¼Ÿ`);
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch('/api/admin/sms/invalidate_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ phone: phone })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('éªŒè¯ç å·²å¤±æ•ˆ', 'æˆåŠŸ');
          loadVerificationCodes(); // åˆ·æ–°åˆ—è¡¨
        } else {
          showModalAlert(result.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    /**
     * æ‰‹åŠ¨æ·»åŠ éªŒè¯ç ï¼ˆæ¨¡æ‹Ÿå‘é€ï¼‰
     */
    async function addManualVerificationCode() {
      const phone = $('manual-code-phone').value.trim();
      let code = $('manual-code-value').value.trim();

      // éªŒè¯éªŒè¯ç æ ¼å¼
      if (!code) {
        // å¦‚æœéªŒè¯ç ä¸ºç©ºï¼Œéšæœºç”Ÿæˆä¸€ä¸ª6ä½æ•°éªŒè¯ç 
        code = Math.floor(100000 + Math.random() * 900000).toString();
        // å°†ç”Ÿæˆçš„ä»£ç å›å¡«åˆ°è¾“å…¥æ¡†
        $('manual-code-value').value = code;
      } else if (!/^\d{6}$/.test(code)) {
        // --- ä¿®æ­£ï¼šå¦‚æœä¸ä¸ºç©ºï¼Œä½†æ ¼å¼ä¸æ­£ç¡® ---
        showModalAlert('éªŒè¯ç å¿…é¡»æ˜¯6ä½æ•°å­—');
        return;
      }

      // éªŒè¯éªŒè¯ç æ ¼å¼
      if (!code || !/^\d{6}$/.test(code)) {
        showModalAlert('è¯·è¾“å…¥6ä½æ•°å­—éªŒè¯ç ');
        return;
      }

      try {
        const response = await fetch('/api/admin/sms/add_manual_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: phone,
            code: code
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('éªŒè¯ç å·²æ·»åŠ ', 'æˆåŠŸ');
          $('manual-code-phone').value = '';
          $('manual-code-value').value = '';
          loadVerificationCodes(); // åˆ·æ–°åˆ—è¡¨
        } else {
          showModalAlert(result.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ========== æŒ‰é’®æƒé™æ ¡éªŒ ========== //

    async function checkButtonPermission(buttonId, permissionName) {
      const hasPermission = await checkAdminPermission(permissionName);
      if (!hasPermission) {
        showModalAlert(`æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½`, 'æƒé™ä¸è¶³');
        return false;
      }
      return true;
    }

    function updateAdminSessionCountDisplay(currentCount, maxSessions) {
      const countEl = $('admin-session-count-display');
      if (!countEl) return;

      // ä¿®å¤ï¼šåœ¨æ¸¸å®¢æ¨¡å¼ä¸‹æ˜¾ç¤ºç‰¹å®šä¿¡æ¯
      if (currentUserIsGuest) {
        countEl.innerHTML = `<span class="text-blue-600">ä¼šè¯æ•°: 1 / æ¸¸å®¢ä»…é™å•ä¼šè¯</span>`;
      } else if (maxSessions === -1) {
        countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
      } else {
        const isNearLimit = currentCount >= maxSessions * 0.8;
        const isAtLimit = currentCount >= maxSessions;
        const colorClass = isAtLimit ? 'text-red-600' : (isNearLimit ? 'text-amber-600' : 'text-slate-600');
        countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
      }
    }

    // ====================
    // ä¸Šå¸æ¨¡å¼ï¼šé”€æ¯ä¼šè¯
    // ====================
    async function destroySession(sessionId) {
      const sessionHash = sessionId.substring(0, 16);
      const confirmed = await jsShowConfirm('ç¡®è®¤é”€æ¯', `ç¡®å®šè¦é”€æ¯ä¼šè¯\n${sessionHash}...\nå—ï¼Ÿ\næ­¤æ“ä½œå°†å¼ºåˆ¶ç»ˆæ­¢è¯¥ä¼šè¯ï¼`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/destroy_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ session_id: sessionId })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ä¼šè¯ ${sessionId} å·²é”€æ¯`, 'æˆåŠŸ');
          loadAdminSessions();
          loadAdminSessions_inline();
        } else {
          showModalAlert(result.message || 'é”€æ¯å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    // é€‰æ‹©ä¼šè¯å¹¶è·³è½¬
    async function selectSession(sessionId) {
      // 1. ä½¿ç”¨ jsShowConfirm è¿›è¡Œç¡®è®¤
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ‡æ¢', `ç¡®å®šè¦åˆ‡æ¢åˆ°ä¼šè¯\n ${sessionId} \nå—ï¼Ÿ`);

      if (!confirmed) {
        logMessage_Info("[ä¼šè¯åˆ‡æ¢] ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚");
        return; // ç”¨æˆ·å–æ¶ˆ
      }

      // 2. æ˜¾ç¤ºåŠ è½½æç¤º (SweetAlert2)
      Swal.fire({
        title: 'æ­£åœ¨åˆ‡æ¢ä¼šè¯...',
        text: 'æ­£åœ¨æ›´æ–°è®¤è¯ä¿¡æ¯ï¼Œè¯·ç¨å€™',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      logMessage_Info(`[ä¼šè¯åˆ‡æ¢] å‡†å¤‡åˆ‡æ¢åˆ°ä¼šè¯ ${sessionId.substring(0, 16)}...`);

      try {
        // 3. è°ƒç”¨åç«¯ API /auth/switch_session æ¥æ›´æ–° Cookie
        //    éœ€è¦å‘é€å½“å‰ sessionUUID (ç”¨äºéªŒè¯æƒé™) å’Œ target_session_id
        const response = await fetch('/auth/switch_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID // å½“å‰çª—å£çš„ session IDï¼Œç”¨äºéªŒè¯èº«ä»½
          },
          credentials: 'include', // å¿…é¡»å‘é€ Cookie ä»¥ä¾¿åç«¯éªŒè¯å½“å‰ç”¨æˆ·
          body: JSON.stringify({
            target_session_id: sessionId // è¦åˆ‡æ¢åˆ°çš„ç›®æ ‡ session ID
          })
        });

        const result = await response.json();

        // 4. å…³é—­åŠ è½½æç¤º
        Swal.close();

        if (response.ok && result.success) {
          // åç«¯æˆåŠŸå¤„ç†å¹¶å·²åœ¨å“åº”ä¸­è®¾ç½®äº†æ–°çš„ Set-Cookie
          logMessage_Info(`[ä¼šè¯åˆ‡æ¢] âœ“ è®¤è¯ä¿¡æ¯æ›´æ–°æˆåŠŸï¼Œå‡†å¤‡è·³è½¬åˆ° ${sessionId.substring(0, 16)}...`);
          // æ˜¾ç¤ºçŸ­æš‚çš„æˆåŠŸæç¤º
          Swal.fire({
            icon: 'success',
            title: 'åˆ‡æ¢å‡†å¤‡å°±ç»ª',
            text: 'å³å°†è·³è½¬åˆ°ç›®æ ‡ä¼šè¯...',
            timer: 1000, // æ˜¾ç¤º1ç§’
            showConfirmButton: false
          }).then(() => {
            // 5. æ‰§è¡Œè·³è½¬ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦ä¸Šæ–°çš„ Cookie
            window.location.href = `/uuid=${sessionId}`;
          });
        } else {
          // 6. åç«¯ API è¿”å›å¤±è´¥ (ä¾‹å¦‚å½“å‰è®¤è¯å¤±æ•ˆã€æƒé™ä¸è¶³ç­‰)
          logMessage_Info(`[ä¼šè¯åˆ‡æ¢] âœ— åˆ‡æ¢å¤±è´¥: ${result.message}`);
          Swal.fire({
            icon: 'error',
            title: 'åˆ‡æ¢å¤±è´¥',
            text: result.message || 'æ— æ³•æ›´æ–°è®¤è¯ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•ã€‚'
          });
          // å¦‚æœåç«¯æŒ‡ç¤ºéœ€è¦é‡æ–°ç™»å½•
          if (result.need_login) {
            Swal.fire({
              icon: 'warning',
              title: 'éœ€è¦é‡æ–°ç™»å½•',
              text: result.message || 'è®¤è¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•',
              confirmButtonText: 'è¿”å›ç™»å½•',
              allowOutsideClick: false
            }).then(() => {
              window.location.href = '/';
            });
          }
        }
      } catch (e) {
        // 7. ç½‘ç»œæˆ–å…¶ä»–è„šæœ¬é”™è¯¯
        Swal.close(); // ç¡®ä¿å…³é—­åŠ è½½æç¤º
        logMessage_Info(`[ä¼šè¯åˆ‡æ¢] âœ— åˆ‡æ¢æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`);
        Swal.fire({
          icon: 'error',
          title: 'åˆ‡æ¢å‡ºé”™',
          text: `ç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`
        });
      }
    }

    async function deleteSession(sessionId) {
      // 1. ä½¿ç”¨ jsShowConfirm è¿›è¡Œç¡®è®¤
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤ä¼šè¯\n ${sessionId} \nå—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`
      );

      if (!confirmed) {
        logMessage_Info("[ä¼šè¯åˆ é™¤] ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚");
        return; // ç”¨æˆ·å–æ¶ˆ
      }

      // 2. æ˜¾ç¤ºåŠ è½½æç¤º (SweetAlert2)
      Swal.fire({
        title: 'æ­£åœ¨åˆ é™¤ä¼šè¯...',
        text: 'è¯·ç¨å€™',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      logMessage_Info(`[ä¼šè¯åˆ é™¤] å‡†å¤‡åˆ é™¤ä¼šè¯ ${sessionId}...`);

      try {
        // 3. è°ƒç”¨åç«¯ API /auth/user/delete_session
        const response = await fetch('/auth/user/delete_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID // ä½¿ç”¨å½“å‰ä¼šè¯è®¤è¯
          },
          body: JSON.stringify({
            session_id: sessionId // è¦åˆ é™¤çš„ç›®æ ‡ä¼šè¯
          })
        });

        const result = await response.json();

        // 4. å…³é—­åŠ è½½æç¤º
        Swal.close();

        if (result.success) {
          logMessage_Info(`[ä¼šè¯åˆ é™¤] âœ“ ä¼šè¯ ${sessionId} å·²åˆ é™¤ã€‚`);
          // 5. æ˜¾ç¤ºçŸ­æš‚çš„æˆåŠŸæç¤º
          Swal.fire({
            icon: 'success',
            title: 'åˆ é™¤æˆåŠŸ',
            timer: 1500, // æ˜¾ç¤º1.5ç§’
            showConfirmButton: false
          }).then(() => {
            // 6. æˆåŠŸååˆ·æ–°ä¼šè¯åˆ—è¡¨
            //    éœ€è¦åˆ¤æ–­å½“å‰åœ¨å“ªä¸ªé¢æ¿æ“ä½œï¼Œè°ƒç”¨å¯¹åº”çš„åˆ·æ–°å‡½æ•°
            const adminModal = document.getElementById('admin-panel-modal');
            if (adminModal && !adminModal.classList.contains('hidden')) {
              // å¦‚æœç®¡ç†æ¨¡æ€æ¡†æ˜¯å¯è§çš„ï¼Œåˆ·æ–°æ¨¡æ€æ¡†å†…çš„åˆ—è¡¨
              loadAdminSessions();
            } else {
              // å¦åˆ™ï¼Œåˆ·æ–°ç™»å½•é¡µå†…åµŒé¢æ¿çš„åˆ—è¡¨
              loadAdminSessions_inline();
            }
          });
        } else {
          // 7. åç«¯ API è¿”å›å¤±è´¥
          logMessage_Info(`[ä¼šè¯åˆ é™¤] âœ— åˆ é™¤å¤±è´¥: ${result.message}`);
          Swal.fire({
            icon: 'error',
            title: 'åˆ é™¤å¤±è´¥',
            text: result.message || 'æ— æ³•åˆ é™¤ä¼šè¯ï¼Œè¯·ç¨åé‡è¯•ã€‚'
          });
        }
      } catch (e) {
        // 8. ç½‘ç»œæˆ–å…¶ä»–è„šæœ¬é”™è¯¯
        Swal.close(); // ç¡®ä¿å…³é—­åŠ è½½æç¤º
        logMessage_Info(`[ä¼šè¯åˆ é™¤] âœ— åˆ é™¤æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`);
        Swal.fire({
          icon: 'error',
          title: 'åˆ é™¤å‡ºé”™',
          text: `ç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`
        });
      }
    }

    // ====================
    // ä¼šè¯é€‰æ‹©å™¨æ¨¡æ€æ¡†å‡½æ•°
    // ====================

    function showSessionPicker() {
      const modal = $('session-picker-modal');
      if (!modal) return;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-visible');

      // è‡ªåŠ¨åŠ è½½ä¼šè¯åˆ—è¡¨
      loadSessionPickerList();
    }

    function closeSessionPicker() {
      const modal = $('session-picker-modal');
      if (!modal) return;

      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('modal-visible');
    }

    async function loadSessionPickerList() {
      const listEl = $('session-picker-list');
      if (!listEl) return;

      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        // æ„å»ºè¯·æ±‚å¤´ï¼Œå‘é€null
        const headers = {
          'X-Session-ID': sessionUUID || null
        };

        const response = await fetch('/auth/user/sessions', {
          headers: headers
        });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const sessions = result.sessions || [];

        // æ›´æ–°ä¼šè¯ä¿¡æ¯ï¼ˆä»åç«¯è·å–max_sessionsä¿¡æ¯ï¼‰
        currentSessionInfo.maxSessions = result.max_sessions || 1;

        // è¿‡æ»¤æ‰æ— æ•ˆä¼šè¯ï¼ˆsession_id ä¸º nullã€undefined æˆ–ç©ºå­—ç¬¦ä¸²çš„ä¼šè¯ï¼‰
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');

        currentSessionInfo.currentCount = validSessions.length;

        // æ›´æ–°ä¼šè¯è®¡æ•°æ˜¾ç¤º
        updateSessionCountDisplay();

        if (validSessions.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯ï¼Œè¯·åˆ›å»ºæ–°ä¼šè¯</p>';
          return;
        }

        listEl.innerHTML = validSessions.map(session => {
          const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
          const isCurrent = session.is_current || session.session_id === sessionUUID;
          const sessionHash = session.session_hash || session.session_id.substring(0, 16);

          return `
            <div class="border ${isCurrent ? 'border-sky-500 bg-sky-50' : 'border-slate-200'} rounded-lg p-3 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="font-semibold text-slate-800 break-all"> ä¼šè¯ ${session.session_id}
                    
                  </p>
                  ${isCurrent ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2 px-2 py-0.5 bg-sky-100 rounded-full">(å½“å‰)</span></p>' : ''}
                  <p class="text-xs text-slate-500 mt-1">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                  <p class="text-xs mt-1">
                    <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${session.is_multi_account_mode
              ? (session.login_success ? 'bg-purple-100 text-purple-700' : 'bg-purple-50 text-purple-400') // å¤šè´¦å· (å·²ç™»å½•/æœªç™»å½•)
              : (session.login_success ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700') // å•è´¦å·
            }">
                      ${session.is_multi_account_mode
              ? (session.login_success ? 'â– å¤šè´¦å· (å·²ç™»å½•)' : 'â– å¤šè´¦å· (æœªç™»å½•)') // å¤šè´¦å·
              : (session.login_success ? 'âœ“ å·²ç™»å½•' : 'â—‹ æœªç™»å½•') // å•è´¦å·
            }
                    </span>
                  </p>
                </div>
                <div class="flex flex-col gap-2">
                  ${!isCurrent ? `
                    <button class="btn btn-primary !py-1 !px-3 text-xs" onclick="selectSessionFromPicker('${session.session_id}')">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                      </svg>
                      è¿›å…¥
                    </button>
                    <button class="btn btn-ghost !py-1 !px-3 !text-red-600 text-xs border border-red-200 hover:bg-red-50" onclick="deleteSessionFromPicker('${session.session_id}')">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                      åˆ é™¤
                    </button>
                  ` : '<span class="text-xs text-slate-400">å½“å‰ä¼šè¯</span>'}
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        logMessage_Error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    function refreshSessionPicker() {
      loadSessionPickerList();
    }

    function updateSessionCountDisplay() {
      const countEl = $('session-count-display');
      if (!countEl) return;

      const { currentCount, maxSessions } = currentSessionInfo;

      if (maxSessions === -1) {
        countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
      } else {
        const isNearLimit = currentCount >= maxSessions * 0.8;
        const isAtLimit = currentCount >= maxSessions;
        const colorClass = isAtLimit ? 'text-red-600' : (isNearLimit ? 'text-amber-600' : 'text-slate-600');
        countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
      }
    }

    async function selectSessionFromPicker(sessionId) {
      logMessage_Info(`å‡†å¤‡åˆ‡æ¢åˆ°ä¼šè¯ ${sessionId.substring(0, 16)}...`);
      closeSessionPicker(); // å…ˆå…³é—­é€‰æ‹©å™¨

      try {
        logMessage_Info(`æ­£åœ¨ä¸ºç›®æ ‡ä¼šè¯ ${sessionId.substring(0, 16)} åˆ·æ–°è®¤è¯ä»¤ç‰Œ...`);

        // --- ä¿®æ”¹ï¼šè°ƒç”¨åˆ‡æ¢ä¼šè¯çš„API ---
        const response = await fetch('/auth/switch_session', { // <--- æ­£ç¡®çš„APIç«¯ç‚¹
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID // å‘é€å½“å‰ä¼šè¯IDä»¥éªŒè¯ç”¨æˆ·èº«ä»½
          },
          credentials: 'include', // åŒ…å« Cookieï¼Œç”¨äºéªŒè¯å½“å‰ç”¨æˆ·å’Œè·å–æ–° Cookie
          body: JSON.stringify({
            target_session_id: sessionId // <--- æ­£ç¡®çš„å‚æ•°ï¼šå‘ŠçŸ¥åç«¯è¦åˆ‡æ¢åˆ°çš„ç›®æ ‡ä¼šè¯ID
          })
        });
        // --- ç»“æŸä¿®æ”¹ ---

        const result = await response.json();

        // åç«¯ /auth/switch_session æˆåŠŸåä¼šè®¾ç½®æ–°çš„ auth_token cookie
        if (response.ok && result.success) {
          logMessage_Info(`ä»¤ç‰Œæ›´æ–°æˆåŠŸï¼Œæ­£åœ¨è·³è½¬åˆ°ä¼šè¯ ${sessionId.substring(0, 16)}...`);
          // ç›´æ¥è·³è½¬ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦ä¸Šåç«¯è®¾ç½®çš„æ–° Cookie
          window.location.href = `/uuid=${sessionId}`;
        } else {
          // å¦‚æœåç«¯è¿”å›é”™è¯¯ï¼ˆä¾‹å¦‚å½“å‰è®¤è¯å¤±æ•ˆï¼‰
          logMessage_Info(`[é”™è¯¯] æ— æ³•åˆ‡æ¢ä¼šè¯: ${result.message}`);
          showModalAlert(`æ— æ³•åˆ‡æ¢ä¼šè¯: ${result.message}`, 'åˆ‡æ¢å¤±è´¥');
          // å¦‚æœåç«¯æŒ‡ç¤ºéœ€è¦é‡æ–°ç™»å½•
          if (result.need_login) {
            Swal.fire({
              icon: 'warning',
              title: 'éœ€è¦é‡æ–°ç™»å½•',
              text: result.message || 'è®¤è¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•',
              confirmButtonText: 'è¿”å›ç™»å½•',
              allowOutsideClick: false
            }).then(() => {
              window.location.href = '/';
            });
          }
        }
      } catch (e) {
        logMessage_Error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', e);
        logMessage_Info(`[é”™è¯¯] åˆ‡æ¢ä¼šè¯æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`);
        showModalAlert(`åˆ‡æ¢ä¼šè¯æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`, 'åˆ‡æ¢å¤±è´¥');
      }
    }

    async function createNewSessionFromPicker() {
      try {
        logMessage_Info("[ä¼šè¯åˆ›å»º] æ­£åœ¨è·å–æœ€æ–°ä¼šè¯ä¿¡æ¯...");
        // è°ƒç”¨åç«¯ API è·å–æœ€æ–°ä¼šè¯æ•°æ®
        const response = await fetch('/auth/user/sessions', {
          headers: {
            'X-Session-ID': sessionUUID || null // ç¡®ä¿å‘é€å½“å‰ä¼šè¯ID
          }
        });
        const result = await response.json();

        if (result.success) {
          // æ›´æ–°å…¨å±€ currentSessionInfo å¯¹è±¡
          currentSessionInfo.maxSessions = result.max_sessions !== undefined && result.max_sessions !== null ? result.max_sessions : -1; // ä½¿ç”¨åç«¯è¿”å›çš„å€¼ï¼Œ-1è¡¨ç¤ºæ— é™åˆ¶
          // è¿‡æ»¤æ‰æ— æ•ˆä¼šè¯ï¼ˆsession_id ä¸º nullã€undefined æˆ–ç©ºå­—ç¬¦ä¸²çš„ä¼šè¯ï¼‰
          const validSessions = (result.sessions || []).filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');
          currentSessionInfo.currentCount = validSessions.length;
          logMessage_Info(`[ä¼šè¯åˆ›å»º] ä¼šè¯ä¿¡æ¯å·²æ›´æ–°: å½“å‰ ${currentSessionInfo.currentCount} / æœ€å¤§ ${currentSessionInfo.maxSessions === -1 ? 'æ— é™åˆ¶' : currentSessionInfo.maxSessions}`);
          // åŒæ—¶æ›´æ–°æ˜¾ç¤ºï¼ˆå¦‚æœ session-picker-modal æ˜¯æ‰“å¼€çš„ï¼‰
          updateSessionCountDisplay();
          // ä¹Ÿæ›´æ–° admin panel modal å†…çš„æ˜¾ç¤º (å¦‚æœå®ƒæ˜¯æ‰“å¼€çš„)
          updateAdminSessionCountDisplay(currentSessionInfo.currentCount, currentSessionInfo.maxSessions);
          // ä¹Ÿæ›´æ–° inline admin panel å†…çš„æ˜¾ç¤º (å¦‚æœå®ƒæ˜¯å¯è§çš„)
          updateAdminSessionCountDisplayInline(currentSessionInfo.currentCount, currentSessionInfo.maxSessions);
        } else {
          // è·å–å¤±è´¥ï¼Œè®°å½•è­¦å‘Šï¼Œä½†ç»§ç»­å°è¯•åˆ›å»ºï¼ˆä½¿ç”¨å¯èƒ½è¿‡æ—¶çš„é™åˆ¶ï¼‰
          logMessage_Info(`[ä¼šè¯åˆ›å»º] è­¦å‘Š: è·å–æœ€æ–°ä¼šè¯ä¿¡æ¯å¤±è´¥: ${result.message}`);
          showModalAlert('æ— æ³•è·å–æœ€æ–°çš„ä¼šè¯é™åˆ¶ä¿¡æ¯ï¼Œå°†ç»§ç»­å°è¯•åˆ›å»ºã€‚', 'è­¦å‘Š');
        }
      } catch (error) {
        // ç½‘ç»œæˆ–å…¶ä»–é”™è¯¯
        logMessage_Info(`[ä¼šè¯åˆ›å»º] é”™è¯¯: è·å–æœ€æ–°ä¼šè¯ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: ${error}`);
        showModalAlert(`è·å–æœ€æ–°çš„ä¼šè¯é™åˆ¶ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: ${error.message}ï¼Œå°†ç»§ç»­å°è¯•åˆ›å»ºã€‚`, 'ç½‘ç»œé”™è¯¯');
      }



      // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°æœ€å¤§ä¼šè¯æ•°
      if (currentSessionInfo.maxSessions !== -1 && currentSessionInfo.currentCount >= currentSessionInfo.maxSessions) {
        // å·²è¾¾ä¸Šé™ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦åˆ é™¤æœ€æ—§çš„ä¼šè¯
        const result = await Swal.fire({
          title: 'ä¼šè¯æ•°é‡å·²è¾¾ä¸Šé™',
          html: `æ‚¨å·²è¾¾åˆ°æœ€å¤§ä¼šè¯æ•°é‡é™åˆ¶ï¼ˆ${currentSessionInfo.maxSessions}ä¸ªï¼‰ã€‚<br><br>æ˜¯å¦è¦è‡ªåŠ¨åˆ é™¤æœ€æ—©çš„ä¼šè¯å¹¶åˆ›å»ºæ–°ä¼šè¯ï¼Ÿ`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'ç¡®å®šï¼Œåˆ é™¤æœ€æ—§ä¼šè¯',
          cancelButtonText: 'å–æ¶ˆ',
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33'
        });

        if (!result.isConfirmed) {
          logMessage_Info("[ä¼šè¯åˆ›å»º] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼šä¼šè¯æ•°å·²è¾¾ä¸Šé™ã€‚");
          return;
        }

        // ç”¨æˆ·ç¡®è®¤ï¼Œæ‰¾åˆ°æœ€æ—§çš„ä¼šè¯å¹¶åˆ é™¤
        try {
          const response = await fetch('/auth/user/sessions', {
            headers: { 'X-Session-ID': sessionUUID || null }
          });
          const sessionsResult = await response.json();

          if (sessionsResult.success && sessionsResult.sessions && sessionsResult.sessions.length > 0) {
            // è¿‡æ»¤æ‰å½“å‰ä¼šè¯å’Œæ— æ•ˆä¼šè¯ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åºæ‰¾åˆ°æœ€æ—§çš„
            const validSessions = sessionsResult.sessions.filter(s =>
              s.session_id &&
              s.session_id !== 'null' &&
              s.session_id.trim() !== '' &&
              s.session_id !== sessionUUID
            );

            if (validSessions.length > 0) {
              // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæœ€æ—§çš„åœ¨å‰
              validSessions.sort((a, b) => (a.created_at || 0) - (b.created_at || 0));
              const oldestSession = validSessions[0];

              logMessage_Info(`[ä¼šè¯ç®¡ç†] æ­£åœ¨åˆ é™¤æœ€æ—§çš„ä¼šè¯: ${oldestSession.session_id.substring(0, 16)}...`);

              // åˆ é™¤æœ€æ—§çš„ä¼šè¯
              const deleteResponse = await fetch('/auth/user/delete_session', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Session-ID': sessionUUID
                },
                body: JSON.stringify({ session_id: oldestSession.session_id })
              });

              const deleteResult = await deleteResponse.json();
              if (deleteResult.success) {
                logMessage_Info(`[ä¼šè¯ç®¡ç†] å·²åˆ é™¤æœ€æ—§çš„ä¼šè¯`);
              } else {
                logMessage_Info(`[ä¼šè¯ç®¡ç†] åˆ é™¤ä¼šè¯å¤±è´¥: ${deleteResult.message}`);
              }
            }
          }
        } catch (e) {
          logMessage_Info(`[ä¼šè¯ç®¡ç†] åˆ é™¤æ—§ä¼šè¯æ—¶å‡ºé”™: ${e.message}`);
        }
      }

      const newUUID = generateUUID();
      logMessage_Info(`æ­£åœ¨åˆ›å»ºæ–°ä¼šè¯ ${newUUID}`);
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤æ“ä½œ',
        'æ‚¨ç¡®å®šè¦åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯å—ï¼Ÿ'
      );

      if (!confirmed) {
        logMessage_Info("[ä¼šè¯åˆ›å»º] ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚");
        return; // ç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
      }


      // 2. æ˜¾ç¤ºåŠ è½½æç¤º (ä¿®å¤ï¼šç§»åŠ¨ç«¯ä½¿ç”¨æŒ‰é’®åŠ è½½çŠ¶æ€ï¼Œæ¡Œé¢ç«¯ä½¿ç”¨SweetAlert)
      let mobileButton = null;
      if (isMobileMode) {
        mobileButton = $('mobile-create-session-btn');
        if (mobileButton) {
          mobileButton.disabled = true;
          // ä¿®å¤ï¼šä½¿ç”¨æ›´ç®€æ´çš„åŠ è½½æ–‡æœ¬
          mobileButton.innerHTML = 'æ­£åœ¨åˆ›å»º...';
        }
      } else {
        // 2. æ˜¾ç¤ºåŠ è½½æç¤º (ä½¿ç”¨ SweetAlert2)
        Swal.fire({
          title: 'æ­£åœ¨åˆ›å»ºæ–°ä¼šè¯...',
          text: 'è¯·ç¨å€™',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
      }


      logMessage_Info(`[ä¼šè¯åˆ›å»º] å‡†å¤‡åˆ›å»ºæ–°ä¼šè¯...`);
      // è¿™ä¸ªç ´bugä¿®äº†æˆ‘å¥½ä¹…
      try {
        // è°ƒç”¨åç«¯APIåˆ›å»ºä¼šè¯æŒä¹…åŒ–æ–‡ä»¶
        const response = await fetch('/auth/user/create_session_persistence', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            session_id: newUUID
          })
        });


        const result = await response.json();

        if (result.success) {
          logMessage_Info(`ä¼šè¯æŒä¹…åŒ–æ–‡ä»¶å·²åˆ›å»º: ${result.message}`);
          if (result.cleanup_message) {
            logMessage_Info(`æç¤º: ${result.cleanup_message}`);
          }
          if (isMobileMode) {
            closeMobileSessionPicker(); // è°ƒç”¨ç§»åŠ¨ç«¯å…³é—­å‡½æ•°
          } else {
            closeSessionPicker(); // è°ƒç”¨æ¡Œé¢ç«¯å…³é—­å‡½æ•°
          }
          window.location.href = `/uuid=${newUUID}`;
        } else {
          logMessage_Info(`åˆ›å»ºä¼šè¯å¤±è´¥: ${result.message}`);

          // ä¿®å¤ï¼šç§»åŠ¨ç«¯ä½¿ç”¨ showModalAlert æ›¿æ¢ Swal.fire
          if (isMobileMode) {
            showModalAlert(result.message, 'åˆ›å»ºå¤±è´¥');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (mobileButton) {
              mobileButton.disabled = false;
              // ä¿®å¤ï¼šæ¢å¤æŒ‰é’®çš„å®Œæ•´HTMLå†…å®¹
              mobileButton.innerHTML = `
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              åˆ›å»ºæ–°ä¼šè¯
            `;
            }
          } else {
            Swal.fire({
              icon: 'error',
              title: 'åˆ›å»ºå¤±è´¥',
              text: result.message
            });
          }
        }
      } catch (e) {
        logMessage_Info(`åˆ›å»ºä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`);



        // ç¡®ä¿å…³é—­â€œæ­£åœ¨åˆ›å»º...â€çš„åŠ è½½æç¤º
        if (isMobileMode) {
          // æ¢å¤ç§»åŠ¨ç«¯æŒ‰é’®
          if (mobileButton) {
            mobileButton.disabled = false;
            // ä¿®å¤ï¼šæ¢å¤æŒ‰é’®çš„å®Œæ•´HTMLå†…å®¹
            mobileButton.innerHTML = `
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              åˆ›å»ºæ–°ä¼šè¯
            `;
          }
        } else {
          Swal.close();
        }

        // å‘ç”¨æˆ·æ˜¾ç¤ºé”™è¯¯
        showModalAlert(`åˆ›å»ºä¼šè¯å¤±è´¥: ${e.message}`, 'åˆ›å»ºå¤±è´¥');

      }
    }

    async function deleteSessionFromPicker(sessionId) {
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼'
      );
      if (!confirmed) return;

      // [ä¿®æ­£] ç§»é™¤å¯¹æ¡Œé¢ç«¯ listEl çš„æ— æ•ˆå¼•ç”¨
      // const listEl = $('session-picker-list');

      // [ä¼˜åŒ–] æ·»åŠ åŠ è½½æç¤º
      Swal.fire({
        title: 'æ­£åœ¨åˆ é™¤ä¼šè¯...',
        text: 'è¯·ç¨å€™',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      try {
        const response = await fetch('/auth/user/delete_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            session_id: sessionId
          })
        });

        const result = await response.json();

        // [ä¼˜åŒ–] æ— è®ºæˆåŠŸå¤±è´¥ï¼Œå…ˆå…³é—­åŠ è½½æç¤º
        Swal.close();


        if (result.success) {
          // [ä¼˜åŒ–] ä½¿ç”¨æ‹Ÿæ€çª—æç¤º
          showModalAlert('ä¼šè¯å·²åˆ é™¤', 'æˆåŠŸ');
          // [æ ¸å¿ƒä¿®æ­£] æ™ºèƒ½åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªæ¨¡æ€æ¡†æ‰“å¼€ï¼Œå¹¶åˆ·æ–°å¯¹åº”çš„åˆ—è¡¨
          const mobilePicker = $('mobile-session-picker-modal');
          const desktopPicker = $('session-picker-modal');

          if (mobilePicker && !mobilePicker.classList.contains('hidden')) {
            // å¦‚æœæ˜¯ç§»åŠ¨ç«¯é€‰æ‹©å™¨å¯è§ï¼Œåˆ·æ–°ç§»åŠ¨ç«¯åˆ—è¡¨
            logMessage_Info("[ä¼šè¯åˆ é™¤] æ­£åœ¨åˆ·æ–°ç§»åŠ¨ç«¯ä¼šè¯åˆ—è¡¨...");
            loadMobileSessionPickerList();
          } else if (desktopPicker && !desktopPicker.classList.contains('hidden')) {
            // å¦‚æœæ˜¯æ¡Œé¢ç«¯é€‰æ‹©å™¨å¯è§ï¼Œåˆ·æ–°æ¡Œé¢ç«¯åˆ—è¡¨
            logMessage_Info("[ä¼šè¯åˆ é™¤] æ­£åœ¨åˆ·æ–°æ¡Œé¢ç«¯ä¼šè¯åˆ—è¡¨...");
            loadSessionPickerList();
          } else {
            // å…œåº•æ–¹æ¡ˆï¼šä¸¤ä¸ªéƒ½åˆ·æ–°ï¼ˆæˆ–æ ¹æ® isMobileMode åˆ·æ–°ï¼‰
            logMessage_Info("[ä¼šè¯åˆ é™¤] æ­£åœ¨åˆ·æ–°ï¼ˆå…œåº•ï¼‰...");
            if (isMobileMode) {
              loadMobileSessionPickerList();
            } else {
              loadSessionPickerList();
            }
          }
        } else {
          // [ä¼˜åŒ–] ä½¿ç”¨æ‹Ÿæ€çª—æç¤º
          showModalAlert('åˆ é™¤å¤±è´¥: ' + result.message, 'é”™è¯¯');
        }
      } catch (e) {
        // [ä¼˜åŒ–] ç¡®ä¿åŠ è½½æç¤ºè¢«å…³é—­
        Swal.close();
        // [ä¼˜åŒ–] ä½¿ç”¨æ‹Ÿæ€çª—æç¤º
        showModalAlert('åˆ é™¤å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    // è¾“å…¥éªŒè¯å‡½æ•°
    function validateInput(input, type) {
      if (!input || input.trim() === '') {
        return { valid: false, message: 'è¾“å…¥ä¸èƒ½ä¸ºç©º' };
      }

      switch (type) {
        case 'username':
          if (input.length < 3 || input.length > 50) {
            return { valid: false, message: 'ç”¨æˆ·åé•¿åº¦åº”åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´' };
          }
          if (!/^[a-zA-Z0-9_-]+$/.test(input)) {
            return { valid: false, message: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦' };
          }
          break;
        case 'password':
          if (input.length < 6) {
            return { valid: false, message: 'å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦' };
          }
          break;
        case 'email':
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(input)) {
            return { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' };
          }
          break;
      }

      return { valid: true };
    }

    // --- åˆå§‹åŒ– ---
    async function initializeApp() {
      try {
        // UUIDæ ¼å¼éªŒè¯å‡½æ•° - éªŒè¯æ˜¯å¦ç¬¦åˆæ ‡å‡†çš„UUID v4æ ¼å¼
        function isValidUUID(uuid) {
          const uuidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}$/i;
          return uuidPattern.test(uuid);
        }

        // éšè—åŠ è½½è¦†ç›–å±‚çš„é€šç”¨å‡½æ•°
        function hideLoadingOverlays() {
          $('loading-overlay').classList.add('hidden');
          $('cdn-error-overlay').classList.add('hidden');
        }

        // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
        function showUserFriendlyError(title, message, isWarning = false) {
          const type = isWarning ? 'warning' : 'error';
          Swal.fire({
            title: title,
            text: message,
            icon: type,
            confirmButtonText: 'ç¡®å®š'
          });
        }

        $('loading-overlay').classList.remove('hidden');

        // æ£€æµ‹Webæ¨¡å¼å¹¶æå–UUID

        const urlPath = window.location.pathname;
        // ä½¿ç”¨æ ‡å‡†UUID v4æ ¼å¼çš„æ­£åˆ™è¡¨è¾¾å¼
        const match = urlPath.match(/\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i);

        if (match) {
          // æƒ…å†µ2ï¼šè®¿é—®å«UUIDçš„ç½‘å€
          sessionUUID = match[1];

          // éªŒè¯UUIDæ ¼å¼
          if (!isValidUUID(sessionUUID)) {

            hideLoadingOverlays();
            logMessage_Error('æ— æ•ˆçš„UUIDæ ¼å¼:', sessionUUID);



            // ä½¿ç”¨ Swal.fire æ˜¾ç¤ºé”™è¯¯å¹¶ç­‰å¾…ç”¨æˆ·ç¡®è®¤
            Swal.fire({
              title: 'æ— æ•ˆçš„ä¼šè¯', // å¼¹çª—æ ‡é¢˜
              text: 'UUIDæ ¼å¼ä¸æ­£ç¡®\nå°†è·³è½¬åˆ°ç™»å½•é¡µé¢', // å¼¹çª—æ¶ˆæ¯
              icon: 'warning', // 'true' for isWarning å¯¹åº” 'warning' å›¾æ ‡
              confirmButtonText: 'ç¡®å®š' // æŒ‰é’®æ–‡å­—
            }).then(() => {
              // è¿™ä¸ª .then() ä¸­çš„ä»£ç ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æŒ‰é’®åæ‰§è¡Œ
              logMessage_Info('ç”¨æˆ·ç¡®è®¤æ— æ•ˆUUIDå¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
              window.location.href = '/'; // æ‰§è¡Œè·³è½¬
            });

            // showUserFriendlyError('æ— æ•ˆçš„ä¼šè¯', 'UUIDæ ¼å¼ä¸æ­£ç¡®ï¼Œå°†è·³è½¬åˆ°ç™»å½•é¡µé¢', true);
            // setTimeout(() => {
            //   window.location.href = '/';
            // }, 2000);


            return;

          }
          $('loading-overlay').classList.remove('hidden');
          logMessage_Info('Webæ¨¡å¼: æ£€æµ‹åˆ°æœ‰æ•ˆUUID =', sessionUUID);
          let result = null;
          // æ£€æŸ¥UUIDç±»å‹
          try {
            try {
              const response = await fetch('/auth/check_uuid_type', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ uuid: sessionUUID })
              });

              result = await response.json();

              if (!result.success) {
                logMessage_Error('æ£€æŸ¥UUIDå¤±è´¥:', result.message);
                hideLoadingOverlays();

                // showUserFriendlyError('ä¼šè¯éªŒè¯å¤±è´¥', result.message, true);
                // // è·³è½¬åˆ°æ— UUIDç½‘å€
                // setTimeout(() => {
                //   window.location.href = '/';
                // }, 2000);

                let message = "æ— æ³•é€šè¿‡UUIDåˆ¤æ–­ä¼šè¯åˆ—å¸­\nå°†è·³è½¬åˆ°ç™»å½•é¡µé¢"
                if (result.message !== '') {
                  message = "æ— æ³•é€šè¿‡UUIDåˆ¤æ–­ä¼šè¯åˆ—å¸­\n" + result.message + "\nå°†è·³è½¬åˆ°ç™»å½•é¡µé¢"
                }

                Swal.fire({
                  title: 'æ— æ•ˆçš„ä¼šè¯ç±»å‹', // å¼¹çª—æ ‡é¢˜
                  text: message, // å¼¹çª—æ¶ˆæ¯
                  icon: 'warning', // 'true' for isWarning å¯¹åº” 'warning' å›¾æ ‡
                  confirmButtonText: 'ç¡®å®š' // æŒ‰é’®æ–‡å­—
                }).then(() => {
                  // è¿™ä¸ª .then() ä¸­çš„ä»£ç ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æŒ‰é’®åæ‰§è¡Œ
                  logMessage_Info('ç”¨æˆ·ç¡®è®¤æ£€æŸ¥UUIDå¤±è´¥å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                  window.location.href = '/'; // æ‰§è¡Œè·³è½¬
                });

                return;
              }
            } catch (e) {
              logMessage_Error('æ£€æŸ¥UUIDè¯·æ±‚å¤±è´¥:', e);
              throw e;
            }
            $('loading-overlay').classList.remove('hidden');
            try {
              if (result.uuid_type === 'guest') {
                try {
                  // æ¸¸å®¢UUID - ç›´æ¥æ¢å¤ä¼šè¯
                  logMessage_Info('æ£€æµ‹åˆ°æ¸¸å®¢UUIDï¼Œç›´æ¥æ¢å¤ä¼šè¯');
                  hideLoadingOverlays(); // ç¡®ä¿éšè—åŠ è½½é®æŒ¡
                  // UUIDå­˜åœ¨ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯å¯¼èˆª
                  if (isMobileMode) {
                    const mobileHeader = document.getElementById('mobile-header');
                    const mobileBottomNavSingle = document.getElementById('mobile-bottom-nav-single-account');
                    if (mobileHeader) {
                      mobileHeader.classList.remove('hidden');
                      mobileHeader.style.display = ''; // ç§»é™¤å†…è”æ ·å¼
                    }
                    if (mobileBottomNavSingle) {
                      mobileBottomNavSingle.classList.remove('hidden');
                      mobileBottomNavSingle.style.display = ''; // ç§»é™¤å†…è”æ ·å¼
                    }
                  }
                } catch (e) {
                  logMessage_Error('å¤„ç†æ¸¸å®¢UUIDå¤±è´¥:', e);
                  throw e;
                }
                // ç»§ç»­æ­£å¸¸åˆå§‹åŒ–æµç¨‹
              } else if (result.uuid_type === 'system_account') {
                try {
                  // ç³»ç»Ÿè´¦å·UUID - å…è®¸è®¿é—®ï¼Œåç«¯ä¼šåœ¨APIè°ƒç”¨æ—¶éªŒè¯token
                  // æ³¨æ„ï¼šauth_tokenæ˜¯httponly cookieï¼ŒJavaScriptæ— æ³•è®¿é—®ï¼Œæ‰€ä»¥å‰ç«¯ä¸åšæ£€æŸ¥
                  logMessage_Info('æ£€æµ‹åˆ°ç³»ç»Ÿè´¦å·UUIDï¼Œå…è®¸è®¿é—®ï¼ˆåç«¯å°†éªŒè¯tokenï¼‰');
                  hideLoadingOverlays(); // ç¡®ä¿éšè—åŠ è½½é®æŒ¡
                  // UUIDå­˜åœ¨ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯å¯¼èˆª
                  if (isMobileMode) {
                    const mobileHeader = document.getElementById('mobile-header');
                    const mobileBottomNavSingle = document.getElementById('mobile-bottom-nav-single-account');
                    if (mobileHeader) {
                      mobileHeader.classList.remove('hidden');
                      mobileHeader.style.display = ''; // ç§»é™¤å†…è”æ ·å¼
                    }
                    if (mobileBottomNavSingle) {
                      mobileBottomNavSingle.classList.remove('hidden');
                      mobileBottomNavSingle.style.display = ''; // ç§»é™¤å†…è”æ ·å¼
                    }
                  }
                  // ç»§ç»­æ­£å¸¸åˆå§‹åŒ–æµç¨‹
                } catch (e) {
                  logMessage_Error('å¤„ç†ç³»ç»Ÿè´¦å·UUIDå¤±è´¥:', e);
                  throw e;
                }
                // å¦‚æœtokenæ— æ•ˆæˆ–è¿‡æœŸï¼Œåç«¯APIè°ƒç”¨ä¼šè¿”å›401é”™è¯¯ï¼Œå‰ç«¯ä¼šå¤„ç†å¹¶é‡å®šå‘åˆ°ç™»å½•
              } else {
                // æœªçŸ¥UUID - å¼¹çª—æç¤ºåè·³è½¬åˆ°æ— UUIDç½‘å€
                try {
                  logMessage_Info('æ£€æµ‹åˆ°æœªçŸ¥UUIDï¼Œå‡†å¤‡å¼¹çª—æç¤ºåè·³è½¬åˆ°ç™»å½•é¡µé¢');

                  // å¼ºåˆ¶è®¾ç½®èƒŒæ™¯ã€å±…ä¸­å¹¶ç¦ç”¨è¾“å…¥æ¡†
                  const loginContainer = document.getElementById('login-container');
                  const mainApp = document.getElementById('main-app');
                  const multiApp = document.getElementById('multi-account-app');
                  const authContainer = document.getElementById('auth-login-container');

                  // 1. å¼ºåˆ¶éšè—å…¶ä»–å®¹å™¨
                  if (loginContainer) loginContainer.classList.add('hidden');
                  if (mainApp) mainApp.classList.add('hidden');
                  if (multiApp) multiApp.classList.add('hidden');

                  // 2. å¼ºåˆ¶æ˜¾ç¤ºå¹¶ä½¿ç”¨ fixed å®šä½å’Œ flex å±…ä¸­ auth-login-container
                  if (authContainer) {
                    authContainer.classList.remove('hidden');
                    // ç§»é™¤å¯èƒ½å†²çªçš„ h-full, w-full (å¦‚æœHTMLç»“æ„ä¸­æœ‰çš„è¯)
                    authContainer.classList.remove('h-full', 'w-full');
                    // æ·»åŠ  fixed å®šä½è¦†ç›–å…¨å±å’Œ flex å±…ä¸­
                    authContainer.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center');
                    // ç¡®ä¿èƒŒæ™¯å¯è§ï¼ˆæœ‰æ—¶éœ€è¦ z-indexï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼‰
                    // authContainer.style.zIndex = '10'; // ä¸€èˆ¬ä¸éœ€è¦
                  }

                  // 3. ç¦ç”¨ auth-login-container å†…çš„è¾“å…¥æ¡†
                  const inputsToDisable = [
                    'auth-username',
                    'auth-password',
                    'auth-reg-username',
                    'auth-reg-password',
                    'auth-reg-password-confirm'
                  ];
                  inputsToDisable.forEach(inputId => {
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) {
                      inputElement.disabled = true;
                      // å¯é€‰ï¼šæ·»åŠ è§†è§‰æç¤ºï¼Œä¾‹å¦‚é™ä½é€æ˜åº¦
                      // inputElement.style.opacity = '0.7';
                      // inputElement.style.cursor = 'not-allowed';
                    }
                  });

                  if (authContainer) authContainer.classList.remove('hidden');
                  // Swal.fireä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œåœ¨ç”¨æˆ·å…³é—­æç¤ºå¼¹çª—åè¯¥Promiseä¼šè¢«è§£æ
                  Swal.fire({
                    title: 'ä¼šè¯ä¸å­˜åœ¨', // å¼¹çª—æ ‡é¢˜
                    text: 'è¯¥ä¼šè¯å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ç™»å½•', // å¼¹çª—æ¶ˆæ¯
                    icon: 'warning', // 'true' for isWarning å¯¹åº” 'warning' å›¾æ ‡
                    confirmButtonText: 'ç¡®å®š' // æŒ‰é’®æ–‡å­—
                  }).then(() => {
                    // è¿™ä¸ª .then() ä¸­çš„ä»£ç ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æŒ‰é’®åæ‰§è¡Œ
                    logMessage_Info('ç”¨æˆ·ç¡®è®¤å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                    window.location.href = '/';
                  });
                  return;
                } catch (e) {
                  logMessage_Error('å¤„ç†æœªçŸ¥UUIDå¤±è´¥:', e);
                  throw e;
                }
              }
            } catch (e) {
              logMessage_Error('å¤„ç†UUIDç±»å‹å¤±è´¥:', e);
              throw e;
            }
          } catch (e) {
            logMessage_Error('æ£€æŸ¥UUIDç±»å‹å¤±è´¥:', e);
            hideLoadingOverlays(); // ç¡®ä¿éšè—åŠ è½½é®æŒ¡
            Swal.fire({
              title: 'ç½‘ç»œé”™è¯¯', // å¼¹çª—æ ‡é¢˜
              text: 'æ— æ³•éªŒè¯ä¼šè¯çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', // å¼¹çª—æ¶ˆæ¯
              icon: 'warning', // 'true' for isWarning å¯¹åº” 'warning' å›¾æ ‡
              confirmButtonText: 'ç¡®å®š' // æŒ‰é’®æ–‡å­—
            }).then(() => {
              // è¿™ä¸ª .then() ä¸­çš„ä»£ç ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æŒ‰é’®åæ‰§è¡Œ
              logMessage_Info('ç”¨æˆ·ç¡®è®¤æ£€æŸ¥UUIDç±»å‹å¤±è´¥å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
              window.location.href = '/'; // æ‰§è¡Œè·³è½¬
            });
            // showUserFriendlyError('ç½‘ç»œé”™è¯¯', 'æ— æ³•éªŒè¯ä¼šè¯çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            // // å‡ºé”™æ—¶ä¹Ÿè·³è½¬åˆ°æ— UUIDç½‘å€
            // setTimeout(() => {
            //   window.location.href = '/';
            // }, 3000);
            return;
          }
        } else {
          // æƒ…å†µ1ï¼šè®¿é—®ä¸å«UUIDçš„ç½‘å€
          logMessage_Info('Webæ¨¡å¼: æœªæ£€æµ‹åˆ°UUIDï¼Œæ˜¾ç¤ºè®¤è¯ç™»å½•é¡µé¢');
          //ç§»é™¤åŠ è½½æç¤º
          hideLoadingOverlays();

          // æ˜¾ç¤ºè®¤è¯ç™»å½•ç•Œé¢ï¼Œç­‰å¾…ç”¨æˆ·ç™»å½•/æ¸¸å®¢æ¨¡å¼
          if (isMobileMode) {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºç§»åŠ¨ç«¯è®¤è¯é¡µï¼Œå¹¶éšè—å­¦æ ¡ç™»å½•é¡µ
            console.log("[Mobile Init] æ— UUIDï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯è®¤è¯é¡µé¢");
            $('mobile-auth-login-container').classList.remove('hidden');
            $('mobile-login-container').classList.add('hidden');
            // ç¡®ä¿æ¡Œé¢ç«¯éšè—
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');
          } else {
            // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºæ¡Œé¢ç«¯è®¤è¯é¡µ
            showAuthLogin();
          }
          return; // åœæ­¢åˆå§‹åŒ–ï¼Œç­‰å¾…è®¤è¯å®Œæˆåé‡æ–°åˆå§‹åŒ–
        }

        $('loading-overlay').classList.remove('hidden');

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        const isAuthenticated = await checkAuthStatus();

        // åœ¨æ£€æŸ¥ isAuthenticated ä¹‹å‰ï¼Œå¿…é¡»å…ˆæ£€æŸ¥ isMobileMode
        // switchUIContainer() åœ¨ DOMContentLoaded æ—¶å·²ç»è¿è¡Œå¹¶è®¾ç½®äº† isMobileMode

        if (!isAuthenticated) {
          hideLoadingOverlays(); // è®¤è¯å¤±è´¥æ—¶éšè—åŠ è½½é®æŒ¡

          if (isMobileMode) {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºç§»åŠ¨ç«¯è®¤è¯é¡µï¼Œå¹¶éšè—å¯¼èˆªæ 
            console.log("[Mobile Init] æœªè®¤è¯ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯è®¤è¯é¡µé¢");
            // å¯¼èˆªæ å·²é€šè¿‡UUIDåˆ¤æ–­æ§åˆ¶ï¼Œæ— éœ€åœ¨æ­¤å¤„ç†
            $('mobile-auth-login-container').classList.remove('hidden');
            $('mobile-login-container').classList.add('hidden');
            // ç¡®ä¿æ¡Œé¢ç«¯éšè—
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');
          } else {
            // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºæ¡Œé¢ç«¯è®¤è¯é¡µ
            console.log("[Desktop Init] æœªè®¤è¯ï¼Œæ˜¾ç¤ºæ¡Œé¢ç«¯è®¤è¯é¡µé¢");
            showAuthLogin(); // (è¿™ä¸ªå‡½æ•°åªå¤„ç†æ¡Œé¢ç«¯)
          }
          return; // åœæ­¢åˆå§‹åŒ–ï¼Œç­‰å¾…è®¤è¯
        }
        $('loading-overlay').classList.remove('hidden');

        // è®¤è¯æˆåŠŸï¼Œç»§ç»­åˆå§‹åŒ–
        // hideLoadingOverlays();


        // æ ‡è®°åº”ç”¨å·²æˆåŠŸåˆå§‹åŒ–
        appInitialized = true;

        // åœ¨ç¡®è®¤ sessionUUID æœ‰æ•ˆä¸”åº”ç”¨å‡†å¤‡å°±ç»ªå
        if (sessionUUID /* && åº”ç”¨å‡†å¤‡å°±ç»ªçš„æ¡ä»¶ */) {
          connectWebSocket();
        }



        // å–æ¶ˆCDNé”™è¯¯å®šæ—¶å™¨ï¼ˆå¦‚æœè¿˜åœ¨ç­‰å¾…ï¼‰
        if (cdnErrorTimer) {
          clearTimeout(cdnErrorTimer);
          cdnErrorTimer = null;
        }

        //ç§»é™¤åŠ è½½æç¤º
        // hideLoadingOverlays();

        logMessage_Info('åº”ç”¨åˆå§‹åŒ–æˆåŠŸï¼ŒCDNèµ„æºçŠ¶æ€æ­£å¸¸æˆ–å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ');

        const initialData = await callPythonAPI('get_initial_data');

        currentUserIsGuest = initialData.is_guest || false; // <-- å­˜å‚¨ä»åç«¯è·å–çš„çŠ¶æ€
        currentAuthUsername = initialData.auth_username || null; // <-- [ADD THIS LINE] ä¿®å¤ï¼šåœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ç³»ç»Ÿç”¨æˆ·å
        logMessage_Info(`initializeApp: currentUserIsGuest = ${currentUserIsGuest}, auth_username = ${currentAuthUsername}`); // <-- [MODIFY THIS LINE]

        const userCombo = $('user-combo');
        userCombo.innerHTML = '<option value="">(æ–°ç”¨æˆ·)</option>';
        initialData.users.forEach(user => {
          const option = document.createElement('option');
          option.value = option.textContent = user;
          userCombo.appendChild(option);
        });

        createParamInputs($('params-container'), 'param', onParamChange);
        if (initialData.lastUser) userCombo.value = initialData.lastUser;
        await onUserChange();


        const hasSchoolLogin = initialData.isLoggedIn && initialData.userInfo;
        const hasSystemAuth = initialData.is_authenticated && !initialData.is_guest;
        const isGuestMode = initialData.is_authenticated && initialData.is_guest;
        // const hasLoadedTasks = sessionModeInfo && sessionModeInfo.has_tasks;  // æ£€æŸ¥æ˜¯å¦æœ‰å·²åŠ è½½çš„ä»»åŠ¡

        // $('loading-overlay').classList.remove('hidden');

        // æ£€æŸ¥ä¼šè¯æ¨¡å¼ï¼ˆå•è´¦å·/å¤šè´¦å·ï¼‰
        let sessionModeInfo = null;
        try {
          sessionModeInfo = await callPythonAPI('get_session_mode_info');
          // logMessage_Info('ä¼šè¯æ¨¡å¼ä¿¡æ¯:', sessionModeInfo);
        } catch (e) {
          logMessage_Error('è·å–ä¼šè¯æ¨¡å¼ä¿¡æ¯å¤±è´¥:', e);
          hideLoadingOverlays();
          Swal.fire({
            title: 'ç½‘ç»œé”™è¯¯', // å¼¹çª—æ ‡é¢˜
            text: 'è·å–ä¼šè¯æ¨¡å¼ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', // å¼¹çª—æ¶ˆæ¯
            icon: 'warning', // 'true' for isWarning å¯¹åº” 'warning' å›¾æ ‡
            confirmButtonText: 'ç¡®å®š' // æŒ‰é’®æ–‡å­—
          }).then(() => {
            // è¿™ä¸ª .then() ä¸­çš„ä»£ç ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æŒ‰é’®åæ‰§è¡Œ
            logMessage_Info('ç”¨æˆ·ç¡®è®¤è·å–ä¼šè¯æ¨¡å¼ä¿¡æ¯å¤±è´¥å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
            window.location.href = '/'; // æ‰§è¡Œè·³è½¬
          });
          return;
        }

        const hasLoadedTasks = sessionModeInfo && sessionModeInfo.has_tasks;

        $('loading-overlay').classList.remove('hidden');

        resetUI();

        // å¦‚æœä¼šè¯ä¹‹å‰æ˜¯å¤šè´¦å·æ¨¡å¼ï¼Œç›´æ¥æ¢å¤åˆ°å¤šè´¦å·æ¨¡å¼
        if (sessionModeInfo && sessionModeInfo.is_multi_account_mode) {
          logMessage_Info('æ£€æµ‹åˆ°ä¼šè¯ä¹‹å‰å¤„äºå¤šè´¦å·æ¨¡å¼ï¼Œæ­£åœ¨æ¢å¤...');

          // å¿…é¡»åœ¨å¤šè´¦å·æ¨¡å¼æ¢å¤æ—¶æ³¨å…¥ auth_group
          currentUserData.group = initialData.auth_group || 'user';

          // é€šçŸ¥åç«¯è¿›å…¥å¤šè´¦å·æ¨¡å¼ï¼ˆæ¢å¤åç«¯çŠ¶æ€ï¼‰
          try {
            const result = await callPythonAPI('enter_multi_account_mode');
            if (!result.success) {
              logMessage_Error('æ— æ³•è¿›å…¥å¤šè´¦å·æ¨¡å¼ï¼Œè¿”å›ç™»å½•ç•Œé¢');
              return;
            }
            // ä½¿ç”¨åç«¯è¿”å›çš„å‚æ•°ï¼ˆå¦‚æœä¼šè¯ä¸­æ²¡æœ‰ä¿å­˜ï¼‰
            if (!sessionModeInfo.global_params && result.params) {
              pythonParams = result.params;
            }
          } catch (e) {
            logMessage_Error('è°ƒç”¨ enter_multi_account_mode å¤±è´¥:', e);
            return;
          }

          hideLoadingOverlays();
          // ç¡®ä¿API Keyå·²é…ç½®å¹¶åŠ è½½åœ°å›¾ï¼ˆå¤šè´¦å·æ¨¡å¼ä¹Ÿéœ€è¦åœ°å›¾ï¼‰
          AMAP_API_KEY = initialData.amap_key || "";
          if (AMAP_API_KEY) {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆå¤šè´¦å·æ¨¡å¼æ¢å¤ï¼‰', e);
            }
          }
          $('loading-overlay').classList.remove('hidden');

          // éšè—ç™»å½•ç•Œé¢å’Œè®¤è¯ç•Œé¢
          $('auth-login-container').classList.add('hidden');
          $('login-container').classList.add('hidden');

          // [ä¿®å¤] æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å¤šè´¦å·ç•Œé¢
          if (isMobileMode) {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºmobile-multi-account-appï¼Œéšè—mobile-login-containerå’Œmobile-auth-login-container
            const mobileMultiApp = document.getElementById('mobile-multi-account-app');
            const mobileLoginContainer = document.getElementById('mobile-login-container');
            const mobileAuthContainer = document.getElementById('mobile-auth-login-container');
            if (mobileMultiApp) {
              mobileMultiApp.classList.remove('hidden');
              console.log('[ä¼šè¯æ¢å¤] ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º mobile-multi-account-app');
            }
            if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
            if (mobileAuthContainer) mobileAuthContainer.classList.add('hidden');
            
            // æ˜¾ç¤ºç§»åŠ¨ç«¯å¤šè´¦å·æ¨¡å¼å¯¼èˆªæ 
            updateMobileNavVisibility(true, 'multi');
            
            // ç¡®ä¿æ¡Œé¢ç«¯åº”ç”¨éšè—
            $('multi-account-app').classList.add('hidden');
            $('main-app').classList.add('hidden');
          } else {
            // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºmulti-account-app
            $('multi-account-app').classList.remove('hidden');
            $('multi-account-app').classList.add('grid');
            $('main-app').classList.add('hidden');
            console.log('[ä¼šè¯æ¢å¤] æ¡Œé¢ç«¯ï¼šæ˜¾ç¤º multi-account-app');
          }
          // hideLoadingOverlays();

          // åˆ›å»ºå¤šè´¦å·åœ°å›¾ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆ›å»ºï¼‰
          if (!multiAccountMap && AMapInstance) {
            try {
              // æµè§ˆå™¨ä¼šå°½é‡å°†å›¾åƒæ•°æ®ç¼“å­˜åœ¨GPUå†…å­˜ä¸­ï¼Œä»è€Œæé«˜å¤šä¸ªgetImageDataè¯»å–æ“ä½œçš„é€Ÿåº¦
              multiAccountMap = new AMapInstance.Map('multi-map-container', {
                viewMode: '3D',
                pitch: 55,
                rotation: 0,
                zoom: 17,
                center: [113.390342, 22.527403],
                renderOptions: {
                  willReadFrequently: true  // ä¼˜åŒ–canvasæ€§èƒ½
                }
              });

              // å¤šè´¦å·åœ°å›¾çš„ 3D æ§åˆ¶æ†
              const ctrlBar = new AMapInstance.ControlBar({
                position: { left: '12px', top: '12px' },
                showZoomBar: false,
                showControlButton: true
              });
              multiAccountMap.addControl(ctrlBar);

              // å»ºç­‘ç‰©å›¾å±‚
              try {
                const buildings = new AMapInstance.BuildingLayer();
                buildings.setMap(multiAccountMap);
              } catch (e) {
                logMessage_Warning('BuildingLayer not available (multi):', e);
              }

              multiAccountMap.on('zoomchange', () => {
                if (!multiAccountMap) return;
                const z = multiAccountMap.getZoom();
                const zoomLevelEl = $('multi-zoom-level');
                if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
              });

              // ä¿å­˜æ¸…ç†å‡½æ•°
              if (window.multiMapCleanup) window.multiMapCleanup();
              window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

              multiAccountMap.setStatus({
                doubleClickZoom: true,
                dragEnable: true,
                scrollWheel: true,
                keyboardEnable: true
              });

              // å…œåº•é‡å»ºå¹¶ç»‘å®šå¤šè´¦å·æ§ä»¶
              ensureMultiControls();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å¤šè´¦å·åœ°å›¾å¤±è´¥:', e);
            }
          }

          // åˆå§‹åŒ–é…ç½®ç”¨æˆ·ä¸‹æ‹‰åˆ—è¡¨
          try {
            const configUsers = await callPythonAPI('multi_get_all_config_users');
            const select = $('multi-config-user-select');
            select.innerHTML = '<option value="">(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)</option>';
            configUsers.users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = opt.textContent = u;
              select.appendChild(opt);
            });
          } catch (e) {
            logMessage_Error('åŠ è½½é…ç½®ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', e);
          }

          // æ¢å¤å…¨å±€å‚æ•°å¹¶åˆå§‹åŒ–å…¨å±€å‚æ•°UI
          if (sessionModeInfo.global_params) {
            pythonParams = sessionModeInfo.global_params;
          }

          // åˆå§‹åŒ–å…¨å±€å‚æ•°UIå®¹å™¨
          try {
            const container = $('multi-global-params-container');
            container.innerHTML = '';
            createParamInputs(container, 'multi-param', onGlobalParamChange);
            updateParamInputs(container, 'multi-param', pythonParams);
          } catch (e) {
            logMessage_Error('åˆå§‹åŒ–å…¨å±€å‚æ•°UIå¤±è´¥:', e);
          }

          // ç»‘å®šå³æ—¶åˆ·æ–°å’Œæ›´æ–°æŒ‰é’®çŠ¶æ€
          try {
            bindImmediateRefreshForUserSelects();
            updateMultiGlobalButtons(true, true);

            // åŒæ­¥"ä»…æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡"é€‰é¡¹åˆ°åç«¯
            await callPythonAPI('set_multi_run_only_incomplete',
              document.getElementById('multi-run-only-incomplete-check').checked
            );
          } catch (e) {
            logMessage_Error('ç»‘å®šå¤šè´¦å·UIäº‹ä»¶å¤±è´¥:', e);
          }

          // ä»åç«¯æ¢å¤è´¦å·åˆ—è¡¨
          try {
            const accountsResult = await callPythonAPI('multi_get_all_accounts_status');
            if (accountsResult && accountsResult.accounts) {
              renderMultiAccountList(accountsResult.accounts);
              logMessage(`å·²æ¢å¤å¤šè´¦å·æ¨¡å¼ï¼Œå½“å‰æœ‰ ${accountsResult.accounts.length} ä¸ªè´¦å·`);
            } else {
              logMessage(`å·²æ¢å¤å¤šè´¦å·æ¨¡å¼ï¼Œå½“å‰æœ‰ 0 ä¸ªè´¦å·`);
            }
          } catch (e) {
            logMessage_Error('æ¢å¤è´¦å·åˆ—è¡¨å¤±è´¥:', e);
            logMessage(`å·²æ¢å¤å¤šè´¦å·æ¨¡å¼ï¼Œå½“å‰æœ‰ ${sessionModeInfo.multi_account_count || 0} ä¸ªè´¦å·ï¼ˆåˆ—è¡¨åŠ è½½å¤±è´¥ï¼‰`);
          }

          // åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿
          setTimeout(async () => {
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿å¤±è´¥:', e);
            }
          }, 100);

          // è®¾ç½®ä¸»é¢˜è‰²
          const base = pythonParams.theme_base_color || '#7dd3fc';
          setBaseColor(base, base);

          hideLoadingOverlays();
          // return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåç»­å•è´¦å·æ¨¡å¼çš„é€»è¾‘
        }


        // å¦‚æœæ˜¯å•è´¦å·æ¨¡å¼ï¼Œåˆ™æ¢å¤å•è´¦å·ä¼šè¯
        // æ¢å¤æ¡ä»¶ï¼šå·²ç™»å½•å­¦æ ¡è´¦å· æˆ– æœ‰å·²åŠ è½½çš„ä»»åŠ¡ï¼ˆå¦‚å¯¼å…¥çš„ç¦»çº¿æ–‡ä»¶ï¼‰
        else if (hasSchoolLogin || hasLoadedTasks) {
          // å­¦æ ¡è´¦å·å·²ç™»å½•æˆ–æœ‰å·²åŠ è½½ä»»åŠ¡ï¼Œç›´æ¥æ˜¾ç¤ºä¸»ç•Œé¢
          // ä¼˜å…ˆä½¿ç”¨å­¦æ ¡ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä¼šè¯ä¸­ä¿å­˜çš„ç¦»çº¿æ¨¡å¼ç”¨æˆ·æ•°æ®
          currentUserData = initialData.userInfo || (sessionModeInfo && sessionModeInfo.user_data) || {};

          // å¿…é¡»å°† auth_group æ³¨å…¥ currentUserDataï¼Œå¦åˆ™æƒé™ç³»ç»Ÿä¼šé»˜è®¤ä¸º 'user'
          currentUserData.group = initialData.auth_group || 'guest';

          if (initialData.device_ua) {
            currentSessionUA = initialData.device_ua;
            logMessage_Info(`[ä¼šè¯æ¢å¤] æˆåŠŸæ¢å¤ User-Agent: ${currentSessionUA.substring(0, 50)}...`);
          } else {
            logMessage_Warning("[ä¼šè¯æ¢å¤] æœªèƒ½ä» initialData ä¸­æ¢å¤ User-Agentã€‚");
            currentSessionUA = "NULL (Restored)"; // è‡³å°‘æä¾›ä¸€ä¸ªéç©ºå€¼ä»¥ç¤ºåŒºåˆ«
          }

          hideLoadingOverlays();
          // æ¢å¤ä¼šè¯æ—¶ç¡®ä¿API Keyå·²é…ç½®å¹¶åŠ è½½åœ°å›¾
          AMAP_API_KEY = initialData.amap_key || "";
          if (AMAP_API_KEY) {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆä¼šè¯æ¢å¤ï¼‰', e);
            }
          } else {
            // å·²ç™»å½•ä½†æ²¡æœ‰API Keyï¼Œå¼¹å‡ºæç¤º
            hideLoadingOverlays();
            logMessage_Info("[è­¦å‘Š] æœªé…ç½®é«˜å¾·åœ°å›¾API Keyï¼Œè¯·åœ¨å¼¹çª—ä¸­è¾“å…¥ã€‚");
            $('amap-key-modal').classList.remove('hidden');
            $('amap-key-modal').classList.add('flex');
            document.body.classList.add('modal-visible');
          }
          $('loading-overlay').classList.remove('hidden');

          if (refreshUserListInterval) clearInterval(refreshUserListInterval); // æ¸…é™¤æ—§çš„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          refreshUserListInterval = setInterval(refreshUserList, 5000); // <--- åœ¨è¿™é‡Œå¯åŠ¨
          logMessage_Info('refreshUserList interval started.'); // æ·»åŠ æ—¥å¿—ç¡®è®¤å¯åŠ¨

          showMainApp();
          const name = currentUserData.name || 'ç¦»çº¿æ¨¡å¼';  // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¾ç¤º"ç¦»çº¿æ¨¡å¼"
          $('user-name-label').textContent = `å§“å: ${name}`;
          $('user-id-label').textContent = `å­¦å·: ${currentUserData.student_id || 'æœªç™»å½•'}`;
          updateDashboard();
          await refreshTasks();

          // ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰åå°ä»»åŠ¡åœ¨è¿è¡Œ (ä» 6730 è¡Œç§»åŠ¨è‡³æ­¤)
          let isTaskRestored = false;
          try {
            isTaskRestored = await checkBackgroundTaskOnLoad();
          } catch (err) {
            logMessage_Warning('æ£€æŸ¥åå°ä»»åŠ¡å¤±è´¥:', err);
          }
          // if (isTaskRestored) {
          //   startBackgroundTaskPolling();

          // }

          // // æ¢å¤ä¹‹å‰é€‰ä¸­çš„ä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
          // if (sessionModeInfo && sessionModeInfo.selected_task_index !== undefined && sessionModeInfo.selected_task_index >= 0) {
          //   try {
          //     logMessage_Info(`æ­£åœ¨æ¢å¤ä¹‹å‰é€‰ä¸­çš„ä»»åŠ¡ (ç´¢å¼•: ${sessionModeInfo.selected_task_index})...`);
          //     await selectTask(sessionModeInfo.selected_task_index);


          //     await pollBackgroundTaskStatus(); // æ¢å¤é€‰ä¸­ä»»åŠ¡åç«‹å³æ›´æ–°çŠ¶æ€
          //     const result = await callPythonAPI_raw('/api/background_task/status', 'GET', null);

          //     // startBackgroundTaskPolling(); // å¯åŠ¨è½®è¯¢
          //     // checkBackgroundTaskOnLoad();

          //   } catch (e) {
          //     logMessage_Error('æ¢å¤é€‰ä¸­ä»»åŠ¡å¤±è´¥:', e);
          //   }
          // }

          const base = pythonParams.theme_base_color || '#7dd3fc';
          setBaseColor(base, base);

          // åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿ï¼ˆæ¢å¤ä¼šè¯æ—¶éœ€è¦ï¼‰
          setTimeout(async () => {
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿å¤±è´¥:', e);
            }
          }, 100);

          // æ˜¾ç¤ºç®¡ç†æŒ‰é’®ï¼ˆæ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬æ¸¸å®¢éƒ½å¯ä»¥è®¿é—®ï¼‰
          const adminBtn = $('show-admin-panel');
          if (adminBtn) adminBtn.classList.remove('hidden');
          hideLoadingOverlays();
          await fetchNotifications();

        }
        // æ²¡æœ‰è¿›å…¥å¤šè´¦å·æ¨¡å¼æˆ–è€…å•è´¦å·æ¨¡å¼
        else if (hasSystemAuth || isGuestMode) {
          // å¿…é¡»åœ¨è¿™é‡Œé‡æ–°è®¾ç½® currentUserData.group
          // å› ä¸º resetUI() (åœ¨ line 11139) ä¼šå°†å…¶æ¸…ç©º
          // (initialData æ˜¯åœ¨å‡½æ•°å¼€å¤´ 11100 è¡Œé™„è¿‘è·å–çš„)
          currentUserData.group = initialData.auth_group || 'guest';
          logMessage_Info(`[Auth Restore] æ¢å¤ç³»ç»Ÿæƒé™ç»„: ${currentUserData.group}`);

          $('loading-overlay').classList.remove('hidden');
          // ç³»ç»Ÿè´¦å·å·²ç™»å½•ï¼ˆadmin/æ™®é€šç”¨æˆ·ï¼‰æˆ–æ¸¸å®¢æ¨¡å¼ï¼Œéšè—è®¤è¯é¢æ¿ï¼Œæ˜¾ç¤ºå­¦æ ¡ç™»å½•é¢æ¿

          if (isMobileMode) {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºç§»åŠ¨ç«¯å­¦æ ¡ç™»å½•é€‰æ‹©å™¨ï¼Œå¹¶æ˜¾ç¤ºå¯¼èˆªæ 
            console.log("[Mobile Init] å·²è®¤è¯ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯å­¦æ ¡è´¦å·ç™»å½•/ä¼šè¯ç®¡ç†");
            // å¯¼èˆªæ å·²é€šè¿‡UUIDåˆ¤æ–­æ§åˆ¶ï¼Œæ— éœ€åœ¨æ­¤å¤„ç†
            $('mobile-auth-login-container').classList.add('hidden');
            $('mobile-login-container').classList.remove('hidden');
            // ç¡®ä¿æ¡Œé¢ç«¯éšè—
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');

            // ã€æ–°å¢ã€‘éšè—åº•éƒ¨å¯¼èˆªæ å’Œèœå•æŒ‰é’®ï¼ˆç”¨æˆ·å°šæœªç™»å½•å­¦æ ¡è´¦å·ï¼‰
            updateMobileNavVisibility(false);

            // ã€æ–°å¢ã€‘åŠ è½½ç§»åŠ¨ç«¯ä¼šè¯åˆ—è¡¨å’Œç”¨æˆ·ä¸‹æ‹‰æ¡†
            setTimeout(async () => {
              try {
                await loadMobileSessionsList();
                // await loadMobileUserCombo();
              } catch (e) {
                console.error('[Mobile Init] åŠ è½½ç§»åŠ¨ç«¯æ•°æ®å¤±è´¥:', e);
              }
            }, 100);
          } else {
            // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºæ¡Œé¢ç«¯å­¦æ ¡ç™»å½•é€‰æ‹©å™¨
            console.log("[Desktop Init] å·²è®¤è¯ï¼Œæ˜¾ç¤ºæ¡Œé¢ç«¯å­¦æ ¡è´¦å·ç™»å½•/ä¼šè¯ç®¡ç†");
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.remove('hidden');
          }

          // åˆ·æ–°ç”¨æˆ·é€‰æ‹©å’Œ UA æ ‡ç­¾
          await onUserChange();

          // åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿ï¼Œé»˜è®¤æ˜¾ç¤ºä¼šè¯æ ‡ç­¾é¡µå¹¶åŠ è½½æ•°æ®
          setTimeout(async () => {
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿å¤±è´¥:', e);
            }
          }, 100);

          // åŠ è½½åœ°å›¾API Key
          AMAP_API_KEY = initialData.amap_key || "";
          if (AMAP_API_KEY) {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆç³»ç»Ÿè´¦å·æ¢å¤ï¼‰', e);
            }
          }

          hideLoadingOverlays();
          // å¦‚æœæ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œæ˜¾ç¤ºæç¤º
          if (isGuestMode) {
            logMessage_Info('[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼Œè¯·ä¿å­˜å½“å‰åœ°å€ä»¥ä¾¿æ¢å¤ä¼šè¯');

            // Swal.fire({
            //   title: 'è¯·æ³¨æ„', // å¼¹çª—æ ‡é¢˜
            //   text: '[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼Œè¯·ä¿å­˜å½“å‰åœ°å€ä»¥ä¾¿æ¢å¤ä¼šè¯', // å¼¹çª—æ¶ˆæ¯
            //   icon: 'warning', // 'true' for isWarning å¯¹åº” 'warning' å›¾æ ‡
            //   confirmButtonText: 'ç¡®å®š' // æŒ‰é’®æ–‡å­—
            // }).then(() => {
            //   // è¿™ä¸ª .then() ä¸­çš„ä»£ç ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æŒ‰é’®åæ‰§è¡Œ
            //   // logMessage_Info('ç”¨æˆ·ç¡®è®¤æ— æ•ˆUUIDå¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
            //   // window.location.href = '/'; // æ‰§è¡Œè·³è½¬
            // });

            // showModalAlert(
            //   '[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼Œè¯·ä¿å­˜å½“å‰åœ°å€ä»¥ä¾¿æ¢å¤ä¼šè¯', // æ¶ˆæ¯
            //   'è¯·æ³¨æ„' // æ ‡é¢˜
            // );

            const guestToast = $('guest-warning-toast');
            const guestOverlay = $('guest_warning_overlay');
            if (guestToast) {
              // åŒæ—¶æ˜¾ç¤ºé®ç½©å±‚å’Œå¼¹çª—
              if (guestOverlay) {
                guestOverlay.classList.remove('hidden');
              }
              guestToast.classList.remove('hidden');
            }

          }




          $('loading-overlay').classList.remove('hidden');


          // æ˜¾ç¤ºç®¡ç†é¢æ¿æŒ‰é’®ï¼ˆæ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬æ¸¸å®¢éƒ½å¯ä»¥è®¿é—®ï¼‰
          const adminBtnLogin = $('show-admin-panel-login');
          if (adminBtnLogin) {
            adminBtnLogin.classList.remove('hidden');
          }
          const adminBtnMulti = $('show-admin-panel-multi');
          if (adminBtnMulti) adminBtnMulti.classList.remove('hidden');

          hideLoadingOverlays();

        } else {
          // å®Œå…¨æœªç™»å½•ï¼Œæ˜¾ç¤ºè®¤è¯é¢æ¿ï¼Œæ£€æŸ¥API Keyå’Œæ¸¸å®¢ç™»å½•é€‰é¡¹
          AMAP_API_KEY = initialData.amap_key || "";
          if (!AMAP_API_KEY) {
            logMessage_Info("[è­¦å‘Š] æœªé…ç½®é«˜å¾·åœ°å›¾API Keyï¼Œè¯·åœ¨å¼¹çª—ä¸­è¾“å…¥ã€‚");
            $('amap-key-modal').classList.remove('hidden');
            $('amap-key-modal').classList.add('flex');
          } else {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('AMap SDK åŠ è½½å¤±è´¥ï¼ˆready é˜¶æ®µï¼‰', e);
            }
          }



          // æ£€æŸ¥æ˜¯å¦å…è®¸æ¸¸å®¢ç™»å½•å¹¶æ˜¾ç¤ºæŒ‰é’® (showAuthLogin å†…éƒ¨å·²è°ƒç”¨)
          // checkGuestLoginEnabled(); // (æ­¤è°ƒç”¨åœ¨ showAuthLogin å†…éƒ¨)
          hideLoadingOverlays();
        }

        if (pythonParams.theme_style) {
          setThemeStyle(pythonParams.theme_style);
        }

        // ç«‹åˆ»åˆ·æ–°ä¸€æ¬¡ç”¨æˆ·åˆ—è¡¨ï¼ˆè°ƒç”¨çš„æ˜¯æ–° refreshUserListï¼‰
        await refreshUserList();

        const loadingOverlay = $('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        bindImmediateRefreshForUserSelects();

        // --- ç»‘å®šç­¾åˆ°Tabå†…çš„å‚æ•°æ§ä»¶ ---
        const attEnabled = $('param-auto_attendance_enabled');
        const attRefresh = $('param-auto_attendance_refresh_s');
        const attRadius = $('param-attendance_user_radius_m');
        if (attEnabled) attEnabled.addEventListener('change', onParamChange);
        if (attRefresh) attRefresh.addEventListener('change', onParamChange);
        if (attRadius) attRadius.addEventListener('change', onParamChange);

        // ç»‘å®šAPI Keyæ¨¡æ€æ¡†çš„ç¡®è®¤æŒ‰é’®äº‹ä»¶
        $('confirm-amap-key-btn').addEventListener('click', onConfirmAmapKey);

        // å°†å®šæ—¶åˆ·æ–°ç§»åŠ¨åˆ° API å°±ç»ªåå†å¯åŠ¨
        // setInterval(refreshUserList, 5000);
      } catch (err) {
        hideModal('loading-overlay');
        showModalAlert('æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚', 'ç½‘ç»œé”™è¯¯');
        IS_OFFLINE = true;
      }
    }
    let socket = null; // å…¨å±€ socket å˜é‡

    // åœ¨ initializeApp æˆåŠŸè·å–åˆ° sessionUUID åæˆ–è€…è®¤è¯æˆåŠŸåè°ƒç”¨æ­¤å‡½æ•°
    function connectWebSocket() {
      if (socket && socket.connected) {
        logMessage_Info("WebSocket already connected.");
        return;
      }

      if (!sessionUUID) {
        logMessage_Warning("Cannot connect WebSocket: sessionUUID is missing.");
        return;
      }

      logMessage_Info("Attempting to connect WebSocket...");
      // è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ³¨æ„è·¯å¾„å¯èƒ½éœ€è¦æ ¹æ®å®é™…éƒ¨ç½²è°ƒæ•´
      socket = io({
        // å¦‚æœéƒ¨ç½²åœ¨éæ ¹è·¯å¾„ï¼Œå¯èƒ½éœ€è¦æŒ‡å®š path
        // path: '/socket.io'
        autoConexceptnect: false,  // æ‰‹åŠ¨æ§åˆ¶è¿æ¥ï¼Œé¿å…è‡ªåŠ¨é‡è¿å¹²æ‰°ç½‘ç»œé”™è¯¯å¤„ç†
        reconnection: true,  // å…è®¸é‡è¿ï¼ˆåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼‰
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      // æ‰‹åŠ¨è¿æ¥
      socket.connect();

      socket.on('connect', () => {
        logMessage_Info('WebSocket connected successfully. SID:', socket.id);
        // è¿æ¥æˆåŠŸåï¼Œç«‹å³å‘é€ 'join' äº‹ä»¶ï¼Œå‘ŠçŸ¥æœåŠ¡å™¨ session_id
        socket.emit('join', { session_id: sessionUUID });
        // (å¯é€‰) åœ¨æ—¥å¿—çª—å£æ˜¾ç¤ºè¿æ¥æˆåŠŸ
        // logMessage_Info("[System] WebSocket å·²è¿æ¥");
      });

      socket.on('disconnect', (reason) => {
        logMessage_Warning('WebSocket disconnected:', reason);
        logMessage_Info("[System] WebSocket è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡è¿...");
        // Socket.IOåº“ä¼šè‡ªåŠ¨å°è¯•é‡æ–°å»ºç«‹WebSocketè¿æ¥
      });

      socket.on('connect_error', (error) => {
        // åªåœ¨éç½‘ç»œé”™è¯¯çŠ¶æ€æ—¶è®°å½•é”™è¯¯ï¼Œé¿å…ç”Ÿæˆå¤§é‡é”™è¯¯æ—¥å¿—
        if (!isInNetworkErrorState) {
          logMessage_Error('WebSocket connection error:', error);
          logMessage_Info("[System-Error] WebSocket è¿æ¥å¤±è´¥");
        }
      });

      // ç›‘å¬æœåŠ¡å™¨å‘é€çš„ 'log_message' äº‹ä»¶
      socket.on('log_message', (data) => {
        if (data && data.msg) {
          // è°ƒç”¨ç°æœ‰çš„ logMessage_Info å‡½æ•°æ˜¾ç¤ºæ—¥å¿—
          logMessage(data.msg, 'INFO', 'Backend');
        }
      });

      // ===============================================
      // === ç›‘å¬åç«¯æ¨é€çš„UIæ›´æ–°äº‹ä»¶ ===
      // ===============================================

      // ç›‘å¬å¤šè´¦å·å¡ç‰‡å†…å®¹æ›´æ–°
      socket.on('multi_status_update', (data) => {
        if (data && data.username && data.data) {
          // logMessage_Debug(`[Socket] æ”¶åˆ° ${data.username} çŠ¶æ€æ›´æ–°`);
          multi_updateAccountStatus(data.username, data.data);
        }
      });

      // ç›‘å¬å¤šè´¦å·åˆ—è¡¨ç»“æ„æ›´æ–° (ä¾‹å¦‚ï¼šæ·»åŠ è´¦å·å)
      socket.on('accounts_updated', (data) => {
        if (data && data.accounts) {
          logMessage(`[Socket] æ”¶åˆ°è´¦å·åˆ—è¡¨æ›´æ–°ï¼Œå…± ${data.accounts.length} ä¸ªè´¦å·`, 'INFO', 'Socket');
          onAccountsUpdated(data.accounts); // onAccountsUpdated ä¼šè°ƒç”¨ renderMultiAccountList
        }
      });

      // ç›‘å¬å¤šè´¦å·å…¨å±€æŒ‰é’®çŠ¶æ€æ›´æ–°
      socket.on('multi_global_buttons_update', (data) => {
        if (data) {
          // logMessage_Debug(`[Socket] æ”¶åˆ°å…¨å±€æŒ‰é’®çŠ¶æ€æ›´æ–°`);
          updateMultiGlobalButtons(data.start_disabled, data.stop_disabled);
          // å•ç‹¬å¤„ç†é€€å‡ºæŒ‰é’®
          const exitBtn = document.getElementById("exit-multi-mode-btn");
          if (exitBtn) {
            exitBtn.disabled = !!data.exit_disabled;
          }
        }
      });

      // ç›‘å¬å¤šè´¦å·ä½ç½®æ›´æ–°
      socket.on('multi_position_update', (data) => {
        if (data && data.username && typeof data.lon === 'number' && typeof data.lat === 'number') {
          multi_updateRunnerPosition(data.username, data.lon, data.lat, data.name || data.username);
        }
      });

      // ç›‘å¬å•è´¦å·å½“å‰ä½ç½®ä½ç½®æ›´æ–°
      socket.on('runner_position_update', (data) => {
        if (data) {
          // æ£€æŸ¥åç«¯å‘æ¥çš„ä»»åŠ¡ç´¢å¼• (data.task_index)
          if (data.task_index !== undefined && data.task_index !== selectedTaskIndex) {
            logMessage_Info(`[Socket] ä»»åŠ¡åˆ‡æ¢: æ­£åœ¨æ‰§è¡Œä»»åŠ¡ #${data.task_index}`);
            // 1. æ›´æ–°å…¨å±€çš„ selectedTaskIndex
            selectedTaskIndex = data.task_index;

            // 2. é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä»¥é«˜äº®æ˜¾ç¤ºå½“å‰ä»»åŠ¡ 
            renderTaskList();

            return;
          }

          // åªæœ‰å½“ task_index åŒ¹é…æ—¶ï¼Œæ‰æ›´æ–°ä½ç½®
          updateRunnerPosition(data.lon, data.lat, data.distance, data.target_sequence, data.duration, data.center_now);
        }
      });

      // ç›‘å¬å•è´¦å·ä»»åŠ¡å®Œæˆ
      socket.on('task_completed', (data) => {
        if (data && typeof data.task_index !== 'undefined') {
          onTaskCompleted(data.task_index);
        }
      });

      // ç›‘å¬å•è´¦å·è·‘æ­¥åœæ­¢
      socket.on('run_stopped', () => {
        onRunStopped();
      });
      // ç›‘å¬åå°æ¨é€çš„é€šçŸ¥æ›´æ–°
      socket.on('onNotificationsUpdated', (data) => {
        logMessage("æ”¶åˆ°åå°æ¨é€çš„é€šçŸ¥æ›´æ–°", 'INFO', 'Socket');
        // data å°±æ˜¯ get_notifications è¿”å›çš„å®Œæ•´ result å¯¹è±¡
        if (data && data.success) {
          // è°ƒç”¨ç°æœ‰çš„JSå‡½æ•°æ¥å¤„ç†æ•°æ®å¹¶æ›´æ–°UI
          onNotificationsUpdated(data);
        }
      });

      // ç›‘å¬éªŒè¯ç åˆ—è¡¨æ›´æ–°äº‹ä»¶
      socket.on('verification_codes_updated', () => {
        logMessage_Info("[Socket] æ”¶åˆ°éªŒè¯ç åˆ—è¡¨æ›´æ–°æ¨é€");
        // æ£€æŸ¥æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
        const modal = $('verification-codes-modal');
        if (modal && !modal.classList.contains('hidden')) {
          logMessage_Info("éªŒè¯ç æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...");
          loadVerificationCodes(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
          logMessage_Info("éªŒè¯ç æ¨¡æ€æ¡†æœªæ‰“å¼€ï¼Œè·³è¿‡åˆ·æ–°ã€‚");
        }
      });



    }


    // Webæ¨¡å¼åº”ç”¨åˆå§‹åŒ–å…¥å£
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeApp().catch(err => {
          logMessage_Error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', err);
          // ç«‹å³æ˜¾ç¤ºCDNé”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰
          appInitialized = false;
          if (cdnErrorCount > 0) {
            if (cdnErrorTimer) clearTimeout(cdnErrorTimer);
            const errorOverlay = document.getElementById('cdn-error-overlay');
            if (errorOverlay) {
              errorOverlay.style.setProperty('display', 'flex', 'important');
            }
          }
        });
      });
    } else {
      // DOMæ–‡æ¡£å·²å®ŒæˆåŠ è½½ï¼Œç›´æ¥æ‰§è¡Œåˆå§‹åŒ–æµç¨‹
      initializeApp().catch(err => {
        logMessage_Error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', err);
        // ç«‹å³æ˜¾ç¤ºCDNé”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰
        appInitialized = false;
        if (cdnErrorCount > 0) {
          if (cdnErrorTimer) clearTimeout(cdnErrorTimer);
          const errorOverlay = document.getElementById('cdn-error-overlay');
          if (errorOverlay) {
            errorOverlay.style.setProperty('display', 'flex', 'important');
          }
        }
      });
    }

    function enhanceMapInteraction(mapInstance) {
      if (!mapInstance) return () => { }; // é˜²å¾¡ï¼šå¦‚æœå®ä¾‹æ— æ•ˆï¼Œè¿”å›ç©ºæ¸…ç†å‡½æ•°
      const container = mapInstance.getContainer();
      if (!container) return () => { }; // é˜²å¾¡ï¼šå¦‚æœå®¹å™¨æ— æ•ˆ

      const handlers = [];

      const addManagedListener = (element, type, listener, options) => {
        element.addEventListener(type, listener, options);
        handlers.push({ element, type, listener, options });
      };

      const wheelHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!mapInstance) return; // é˜²å¾¡æ£€æŸ¥
        if (e.deltaY < 0) mapInstance.zoomIn();
        else mapInstance.zoomOut();
      };
      addManagedListener(container, 'wheel', wheelHandler, { passive: false });

      const contextMenuHandler = (e) => e.preventDefault();
      addManagedListener(container, 'contextmenu', contextMenuHandler);

      const DRAG_SAME_DIRECTION = true;
      let rmbLongPressTimer = null, mmbLongPressTimer = null, rmbDragging = false, mmbDragging = false, lastClientX = 0, lastClientY = 0;

      function doPanBy(mouseX, mouseY) {
        if (!mapInstance) return; // é˜²å¾¡æ£€æŸ¥
        const dx = mouseX - lastClientX; const dy = mouseY - lastClientY;
        if (dx !== 0 || dy !== 0) {
          const panDx = DRAG_SAME_DIRECTION ? dx : -dx; const panDy = DRAG_SAME_DIRECTION ? dy : -dy;
          mapInstance.panBy(panDx, panDy); lastClientX = mouseX; lastClientY = mouseY;
        }
      }

      const mouseDownHandler = (e) => {
        if (e.button === 0) return; lastClientX = e.clientX; lastClientY = e.clientY;
        if (e.button === 1) { e.preventDefault(); e.stopPropagation(); mmbLongPressTimer = setTimeout(() => { mmbDragging = true; }, 0); }
        if (e.button === 2) { e.preventDefault(); e.stopPropagation(); rmbLongPressTimer = setTimeout(() => { rmbDragging = true; }, 0); }
      };
      addManagedListener(container, 'mousedown', mouseDownHandler);

      const mouseMoveHandler = (e) => { if (rmbDragging || mmbDragging) { e.preventDefault(); e.stopPropagation(); doPanBy(e.clientX, e.clientY); } };
      addManagedListener(container, 'mousemove', mouseMoveHandler);

      function endDrag(button) {
        if (button === 2) { clearTimeout(rmbLongPressTimer); rmbLongPressTimer = null; rmbDragging = false; }
        if (button === 1) { clearTimeout(mmbLongPressTimer); mmbLongPressTimer = null; mmbDragging = false; }
      }

      const mouseUpHandler = (e) => {
        endDrag(e.button);
        // æ ¸å¿ƒä¿®å¤ï¼šåœ¨ä»»ä½•é¼ æ ‡æŒ‰é”®ï¼ˆç‰¹åˆ«æ˜¯ä¸­/å³é”®ï¼‰æŠ¬èµ·åï¼Œ
        // å¦‚æœä»å¤„äºç»˜åˆ¶æ¨¡å¼ï¼Œåˆ™å¼ºåˆ¶é‡ç”³åœ°å›¾ä¸å¯æ‹–æ‹½çš„çŠ¶æ€ï¼Œ
        // é˜²æ­¢æ‹–æ‹½çŠ¶æ€è¢«æ„å¤–é‡ç½®ï¼Œä»è€Œä¿®å¤å·¦é”®æ—¢èƒ½ç”»å›¾åˆèƒ½æ‹–åŠ¨åœ°å›¾çš„BUGã€‚
        if (isDrawing && map) {
          map.setStatus({ dragEnable: false });
        }
      };
      addManagedListener(container, 'mouseup', mouseUpHandler);

      const mouseLeaveHandler = () => { endDrag(1); endDrag(2); };
      addManagedListener(container, 'mouseleave', mouseLeaveHandler);

      const windowMouseUpHandler = () => { leftMouseDown = false; isPathDrawing = false; endDrag(1); endDrag(2); };
      addManagedListener(window, 'mouseup', windowMouseUpHandler, true);

      // è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°
      return () => {
        handlers.forEach(({ element, type, listener, options }) => {
          element.removeEventListener(type, listener, options);
        });
      };
    }

    // ç»Ÿä¸€ä¸€æ¬¡æ€§åŠ è½½ AMap SDK
    function loadAMapOnce() {
      if (AMapReady && AMapInstance) return Promise.resolve(AMapInstance);
      if (amapLoadingPromise) return amapLoadingPromise;

      // ä¼˜å…ˆå¤ç”¨ window.AMapï¼ˆå¤šè´¦å·é‡Œå·²è½½å…¥è¿‡ï¼‰
      if (window.AMap && window.AMap.ControlBar) { // æ£€æŸ¥ä¸€ä¸ªæ’ä»¶æ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­æ˜¯å¦å®Œæ•´åŠ è½½
        AMapInstance = window.AMap;
        AMapReady = true;
        amapLoadingPromise = Promise.resolve(AMapInstance);
        return amapLoadingPromise;
      }

      // æ–°å¢ï¼šåŠ è½½å‰æ£€æŸ¥Keyæ˜¯å¦å­˜åœ¨
      if (!AMAP_API_KEY) {
        logMessage_Info("[é”™è¯¯] å°è¯•åŠ è½½åœ°å›¾å¤±è´¥ï¼šAPI Keyä¸ºç©ºã€‚");
        // å†æ¬¡å¼¹å‡ºæç¤ºæ¡†
        $('amap-key-modal').classList.remove('hidden');
        $('amap-key-modal').classList.add('flex');
        // è¿”å›ä¸€ä¸ªè¢«æ‹’ç»çš„Promiseï¼Œä¸­æ–­åŠ è½½é“¾
        return Promise.reject("API Key is missing.");
      }

      // é¦–æ¬¡åŠ è½½ SDKï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå¹¶å¸¦ä¸Šæ‰€æœ‰éœ€è¦çš„æ’ä»¶
      amapLoadingPromise = AMapLoader.load({
        key: AMAP_API_KEY, // ä¿®æ”¹ï¼šä½¿ç”¨å…¨å±€å˜é‡
        version: "2.0",
        plugins: ['AMap.ControlBar', 'AMap.BuildingLayer', 'AMap.Walking'] // åœ¨è¿™é‡Œä¸€æ¬¡æ€§å£°æ˜æ‰€æœ‰æ’ä»¶
      })
        .then((AMap) => {
          AMapInstance = AMap;
          AMapReady = true;
          logMessage_Info("é«˜å¾·åœ°å›¾SDKåŠæ‰€æœ‰æ’ä»¶åŠ è½½æˆåŠŸã€‚");
          return AMapInstance;
        })
        .catch((err) => {
          logMessage_Error("AMap åŠ è½½å¤±è´¥", err);
          logMessage_Info("[JS-Error] é«˜å¾·åœ°å›¾SDKåŠ è½½å¤±è´¥ï¼åœ°å›¾åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚");
          AMapReady = false;
          AMapInstance = null;
          amapLoadingPromise = null;
          throw err;
        });

      return amapLoadingPromise;
    }

    // ç¡®ä¿â€œå•è´¦å·åœ°å›¾â€åœ¨å®¹å™¨æ˜¾ç¤ºååˆ›å»ºï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
    function ensureSingleMap() {
      if (map || !AMapReady || !AMapInstance) return;
      const container = document.getElementById('map-container');
      if (!container) return;
      const isHidden = container.offsetParent === null;
      if (isHidden) return; // å®¹å™¨æœªæ˜¾ç¤ºæ—¶ä¸åˆ›å»º
      initMap(AMapInstance);
    }

    // æ–°å¢ï¼šå¼ºåˆ¶æŠ•å½±åˆ·æ–°
    function forceProjectionRefresh() {
      if (!map) return;
      try {
        // ä¸´æ—¶å…³é—­æ‹–æ‹½ï¼Œè§¦å‘äº¤äº’å±‚çŠ¶æ€é‡å»º
        map.setStatus({ dragEnable: false });

        // åˆ·æ–°å°ºå¯¸
        map.resize();

        // ä¸‹ä¸€å¸§ç»Ÿä¸€æ‹Ÿåˆè¦†ç›–ç‰©æˆ–æ‰“å¡ç‚¹
        requestAnimationFrame(() => {
          const overlays = [...polylines.recommended];
          if (polylines.draft) overlays.push(polylines.draft);
          if (polylines.run) overlays.push(polylines.run);
          if (polylines.history) overlays.push(polylines.history);

          if (overlays.length > 0) {
            map.setFitView(overlays, false, [60, 60, 60, 60]);
          } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
            const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
            map.setFitView(pts, false, [60, 60, 60, 60]);
          } else {
            map.setZoomAndCenter(17, [113.390342, 22.527403]);
          }

          // æ¢å¤æ‹–æ‹½
          map.setStatus({ dragEnable: true });
        });
      } catch (e) {
        logMessage_Warning('forceProjectionRefresh warning:', e);
      }
    }


    function ensureSingleControls() {
      const container = document.getElementById('map-container');
      if (!container) return;

      // æ£€æŸ¥æ§ä»¶DOMæ˜¯å¦ä»åœ¨ï¼ˆè¢« AMap destroy æ¸…ç©ºæ—¶éœ€è¦é‡å»ºï¼‰
      const hasZoomIn = !!document.getElementById('zoom-in');
      const hasZoomOut = !!document.getElementById('zoom-out');
      const hasReset = !!document.getElementById('reset-view-btn');

      if (hasZoomIn && hasZoomOut && hasReset) {
        // æ§ä»¶è¿˜åœ¨ï¼Œåªéœ€è¦ç¡®ä¿äº‹ä»¶ç»‘å®š
        attachSingleControlHandlers();
        return;
      }

      // é‡å»ºæ§ä»¶ç›’ï¼ˆä¸åŸHTMLä¸€è‡´ï¼‰
      const overlay = document.createElement('div');
      overlay.className = 'absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200';
      overlay.innerHTML = `
    <button id="zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
  `;
      container.appendChild(overlay);

      attachSingleControlHandlers();
    }

    function attachSingleControlHandlers() {
      const zi = document.getElementById('zoom-in');
      const zo = document.getElementById('zoom-out');
      const rv = document.getElementById('reset-view-btn');

      // é˜²é‡å¤ç»‘å®šï¼šæ ‡è®°å·²ç»‘å®š
      if (zi && !zi._bound) {
        zi.addEventListener('click', () => { if (map) map.zoomIn(); });
        zi._bound = true;
      }
      if (zo && !zo._bound) {
        zo.addEventListener('click', () => { if (map) map.zoomOut(); });
        zo._bound = true;
      }
      if (rv && !rv._bound) {
        rv.addEventListener('click', resetMapView);
        rv._bound = true;
      }
    }

    function ensureMultiControls() {
      const container = document.getElementById('multi-map-container');
      if (!container) return;

      const hasZoomIn = !!document.getElementById('multi-zoom-in');
      const hasZoomOut = !!document.getElementById('multi-zoom-out');
      const hasReset = !!document.getElementById('multi-reset-view-btn');

      if (hasZoomIn && hasZoomOut && hasReset) {
        attachMultiControlHandlers();
        return;
      }

      const overlay = document.createElement('div');
      overlay.className = 'absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200';
      overlay.innerHTML = `
    <button id="multi-zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="multi-zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="multi-zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="multi-reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
  `;
      container.appendChild(overlay);

      attachMultiControlHandlers();
    }

    function attachMultiControlHandlers() {
      const zi = document.getElementById('multi-zoom-in');
      const zo = document.getElementById('multi-zoom-out');
      const rv = document.getElementById('multi-reset-view-btn');

      if (zi && !zi._bound) {
        zi.addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomIn(); });
        zi._bound = true;
      }
      if (zo && !zo._bound) {
        zo.addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomOut(); });
        zo._bound = true;
      }
      if (rv && !rv._bound) {
        rv.addEventListener('click', multi_resetMapView);
        rv._bound = true;
      }
    }



    // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
    function initMap(AMap) {
      if (map) return;
      AMapInstance = AMap;
      // æµè§ˆå™¨ä¼šå°½é‡å°†å›¾åƒæ•°æ®ç¼“å­˜åœ¨GPUå†…å­˜ä¸­ï¼Œä»è€Œæé«˜å¤šä¸ªgetImageDataè¯»å–æ“ä½œçš„é€Ÿåº¦
      map = new AMapInstance.Map('map-container', {
        viewMode: '3D', pitch: 55, rotation: 0, zoom: 17,
        center: [113.390342, 22.527403],
        renderOptions: {
          willReadFrequently: true  // ä¼˜åŒ–canvasæ€§èƒ½
        }
      });

      const ctrlBar = new AMapInstance.ControlBar({
        position: { left: '12px', top: '12px' }, showZoomBar: false, showControlButton: true
      });
      map.addControl(ctrlBar);

      try { const buildings = new AMapInstance.BuildingLayer(); buildings.setMap(map); } catch (e) { logMessage_Warning('BuildingLayer not available:', e); }

      map.on('mousedown', onMapMouseDown);
      map.on('mousemove', onMapMouseMove);
      map.on('mouseup', onMapMouseUp);
      map.on('zoomchange', () => {
        if (!map) return;
        const z = map.getZoom();
        const zoomLevelEl = $('zoom-level');
        if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
      });

      if (window.mapCleanup) window.mapCleanup();
      window.mapCleanup = enhanceMapInteraction(map);
      map.setStatus({ doubleClickZoom: true, dragEnable: true, scrollWheel: true, keyboardEnable: true });

      // æ¢å¤ç®€æ´çš„completeäº‹ä»¶ï¼Œä»…ç”¨äºæ—¥å¿—æˆ–æœªæ¥æ‰©å±•
      map.on('complete', () => {
        logMessage_Info("åœ°å›¾å®ä¾‹å·²åŠ è½½ã€‚");
        // å½“åœ°å›¾åŠ è½½å®Œæˆåï¼Œå…‘ç°Promiseï¼Œé€šçŸ¥ç­‰å¾…æ–¹
        if (resolveMapReady) {
          resolveMapReady(map);
        }
      });
    }


    function showMainApp() {
      // åœ¨æ˜¾ç¤ºä¸»åº”ç”¨æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Promiseç”¨äºç­‰å¾…åœ°å›¾åŠ è½½
      mapReadyPromise = new Promise(resolve => {
        resolveMapReady = resolve;
      });
      
      // [ä¿®å¤] æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å•è´¦å·ç•Œé¢
      if (isMobileMode) {
        // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºmobile-main-appï¼Œéšè—ç™»å½•å®¹å™¨
        const mobileMainApp = document.getElementById('mobile-main-app');
        const mobileLoginContainer = document.getElementById('mobile-login-container');
        const mobileAuthContainer = document.getElementById('mobile-auth-login-container');
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');
        
        if (mobileMainApp) {
          mobileMainApp.classList.remove('hidden');
          console.log('[å•è´¦å·æ¨¡å¼] ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º mobile-main-app');
        }
        if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
        if (mobileAuthContainer) mobileAuthContainer.classList.add('hidden');
        if (mobileMultiApp) mobileMultiApp.classList.add('hidden');
        
        // æ˜¾ç¤ºç§»åŠ¨ç«¯å•è´¦å·æ¨¡å¼å¯¼èˆªæ 
        updateMobileNavVisibility(true, 'single');
        
        // ç¡®ä¿æ¡Œé¢ç«¯åº”ç”¨éšè—
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.add('hidden');
        $('login-container').classList.add('hidden');
        $('auth-login-container').classList.add('hidden');
      } else {
        // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºmain-app
        $('auth-login-container').classList.add('hidden');
        $('login-container').classList.add('hidden');
        $('main-app').classList.remove('hidden');
        $('main-app').classList.add('grid');
        console.log('[å•è´¦å·æ¨¡å¼] æ¡Œé¢ç«¯ï¼šæ˜¾ç¤º main-app');
      }

      logMessage_Info("å·²è¿›å…¥å•è´¦å·æ¨¡å¼ã€‚");

      // 1. ç¡®ä¿æ—§å®ä¾‹è¢«é”€æ¯
      destroySingleMap();

      // 2. ç»ˆæä¿®å¤ï¼šä¸ç«‹å³åˆ›å»ºåœ°å›¾ï¼Œè€Œæ˜¯å»¶è¿Ÿåˆ›å»º
      // è¿™ä¸ªå»¶è¿Ÿç»™äºˆæµè§ˆå™¨è¶³å¤Ÿæ—¶é—´æ¥å®ŒæˆUIå¸ƒå±€ä» hidden åˆ° grid çš„åˆ‡æ¢å’Œæ¸²æŸ“
      logMessage_Info("ç­‰å¾…UIæ¸²æŸ“ç¨³å®š...");
      setTimeout(() => {
        logMessage_Info("UIç¨³å®šï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...");
        loadAMapOnce().then(() => {
          initMap(AMapInstance); // åœ¨è¿™é‡Œæ‰çœŸæ­£åˆ›å»ºåœ°å›¾å®ä¾‹
          ensureSingleControls();

          // ç”±äºåœ°å›¾åˆ›å»ºæ—¶å®¹å™¨å°ºå¯¸å·²æ­£ç¡®ï¼Œåç»­çš„ä»»åŠ¡åŠ è½½å’Œç»˜åˆ¶æµç¨‹å°†è‡ªç„¶æ­£ç¡®
          // selectTask() ä¼šåœ¨ refreshTasks() ä¸­è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ map å®ä¾‹å·²å­˜åœ¨
        }).catch((e) => logMessage_Error('AMap åŠ è½½å¤±è´¥ï¼ˆå»¶è¿Ÿåˆ›å»ºé˜¶æ®µï¼‰', e));
      }, 100); // 100æ¯«ç§’çš„å»¶è¿Ÿå¯¹äºç°ä»£æµè§ˆå™¨å·²ç»°ç»°æœ‰ä½™
    }

    function resetUI() {
      $('main-app').classList.add('hidden'); $('main-app').classList.remove('grid'); $('login-container').classList.remove('hidden');
      $('user-name-label').textContent = 'å§“å: NULL'; $('user-id-label').textContent = 'å­¦å·: NULL';
      const logoutBtn = $('logout-button'); logoutBtn.classList.remove('!text-amber-500'); logoutBtn.classList.add('!text-red-600');
      currentTasks = []; selectedTaskIndex = -1; currentUserData = {}; currentRunData = {};
      $('task-list').innerHTML = ''; $('history-list').innerHTML = ''; $('target-points-text').innerHTML = '';

      // ç¦»çº¿æ ‡å¿—å¤ä½ï¼ŒUA æ ‡ç­¾ä¸éšæœºæŒ‰é’®æ¢å¤
      IS_OFFLINE = false;
      const uaLabel = $('ua-label'); if (uaLabel) uaLabel.textContent = ' (æœªåŠ è½½) ';
      const uaBtn = $('random-ua-btn'); if (uaBtn) uaBtn.disabled = false;


      // å…ˆç§»é™¤å½•åˆ¶æ ·å¼ä¸äº¤äº’ç¦ç”¨ï¼ˆå³ä½¿åœ°å›¾å·²é”€æ¯ä¹Ÿæ¸…ç†DOMï¼‰
      try {
        const container = document.getElementById('map-container');
        if (container) container.classList.remove('drawing');
      } catch (_) { }
      isDrawing = false;
      isPathDrawing = false;
      leftMouseDown = false;
      pendingUnlockMap = false;
      // æ¸…ç©ºç»˜åˆ¶ä¸´æ—¶é˜Ÿåˆ—ä¸èŠ‚æµ
      draftPath = [];
      draftPathLngLat = [];
      pendingPoints = [];
      isUpdating = false;
      lastMouseMoveTime = 0;
      // æ¨¡æ€å…¨å±€æ ‡è®°æ¸…ç†
      try { document.body.classList.remove('modal-visible'); } catch (_) { }

      // Reset button states
      $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
      $('start-run-button').classList.remove('btn-danger');
      $('start-run-button').classList.add('btn-primary');
      $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
      $('start-all-button').classList.remove('btn-danger');
      $('start-all-button').classList.add('btn-secondary');

      // å¦‚æœåå°ä»»åŠ¡è½®è¯¢æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢è½®è¯¢
      stopBackgroundTaskPolling();

      updateDashboard();

      destroySingleMap();

      onUserChange();
    }




    function clearMapOverlays() {
      if (!map) return;
      polylines.recommended.forEach(p => map.remove(p)); polylines.recommended = [];
      if (polylines.draft) map.remove(polylines.draft);
      if (polylines.run) map.remove(polylines.run);
      if (polylines.history) map.remove(polylines.history);
      polylines.draft = polylines.run = polylines.history = null;
      map.remove(markers); markers = [];
      if (runnerMarker) { map.remove(runnerMarker); runnerMarker = null; }
      if (drawingInfoMarker) { map.remove(drawingInfoMarker); drawingInfoMarker = null; }
    }

    // æ˜¾å¼é”€æ¯å•è´¦å·åœ°å›¾å®ä¾‹ï¼Œé‡Šæ”¾èµ„æºå¹¶å¤ä½å˜é‡
    function destroySingleMap() {
      try {
        if (map && typeof map.destroy === 'function') {
          map.destroy();
        }
      } catch (e) {
        logMessage_Warning('destroySingleMap warning:', e);
      } finally {
        map = null;
        // è¦†ç›–ç‰©ä¸çŠ¶æ€å˜é‡å¤ä½ï¼ˆä¿é™©ï¼‰
        polylines.recommended = [];
        polylines.draft = null;
        polylines.run = null;
        polylines.history = null;
        markers = [];
        runnerMarker = null;
        drawingInfoMarker = null;

        // å½•åˆ¶æ¨¡å¼ & äº¤äº’åŒä¿é™©å¤ä½
        try {
          const container = document.getElementById('map-container');
          if (container) container.classList.remove('drawing');
        } catch (_) { }
        isDrawing = false;
        isPathDrawing = false;
        leftMouseDown = false;
        pendingUnlockMap = false;
        // ç»˜åˆ¶é˜Ÿåˆ—ä¸èŠ‚æµçŠ¶æ€æ¸…ç†
        draftPath = [];
        draftPathLngLat = [];
        pendingPoints = [];
        isUpdating = false;
        lastMouseMoveTime = 0;

        // æ¨¡æ€æ®‹ç•™ä¿é™©æ¸…ç†ï¼ˆé˜²äº¤äº’ç¦ç”¨ï¼‰
        try { document.body.classList.remove('modal-visible'); } catch (_) { }
      }
    }

    // --- äº‹ä»¶ç›‘å¬ç»‘å®š ---
    $('user-combo').addEventListener('change', onUserChange);
    $('username-entry').addEventListener('input', async (e) => {
      // ============================================================
      // ç™»å½•æŒ‰é’®ç¦ç”¨ï¼šå¼€å§‹æ‰§è¡Œæ—¶ç¦ç”¨login-button
      // ============================================================
      const loginBtn = $('login-button');
      if (loginBtn) {
        loginBtn.disabled = true;  // ç¦ç”¨ç™»å½•æŒ‰é’®
      }

      try {
        const username = e.target.value.trim();
        $('password-entry').value = "";
        const userCombo = $('user-combo');
        const exists = [...userCombo.options].some(o => o.value === username);
        userCombo.value = exists ? username : "";
        // if (!username) {
        //   $('ua-label').textContent = '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
        //   return;
        // }
        const data = await callPythonAPI('on_user_selected', username);
        if (data && data.password) $('password-entry').value = data.password;
        logMessage_Info('è·å–åˆ°çš„data.ua:', data ? data.ua : 'null');
        const ua_data = (data && data.ua) ? data.ua : '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
        $('ua-label').textContent = ua_data;
        logMessage_Info('User ua label set to:', ua_data);

        // if (data && data.ua) {
        //   $('ua-label').textContent = data.ua;
        // } else {
        //   $('ua-label').textContent = '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
        // }
        pythonParams = (data && data.params) ? data.params : pythonParams;
        updateParamInputs($('params-container'), 'param', pythonParams);
        const base = pythonParams.theme_base_color || '#7dd3fc'; setBaseColor(base, base);
      } finally {
        // ============================================================
        // ç™»å½•æŒ‰é’®æ¢å¤ï¼šæ‰§è¡Œå®Œæˆåæ¢å¤login-button
        // ============================================================
        if (loginBtn) {
          loginBtn.disabled = false;  // æ¢å¤ç™»å½•æŒ‰é’®
        }
      }
    });
    $('random-ua-btn').addEventListener('click', async () => $('ua-label').textContent = await callPythonAPI('generate_new_ua'));
    $('login-button').addEventListener('click', async (e) => {
      // æ ¡éªŒç™»å½•æŒ‰é’®æƒé™
      if (!await checkButtonPermission('login-button', 'use_login_button')) {
        return;
      }
      await onLogin();
    });
    $('logout-button').addEventListener('click', onLogout);
    $('refresh-button').addEventListener('click', refreshTasks);
    $('record-button').addEventListener('click', toggleRecordMode);
    $('clear-button').addEventListener('click', () => clearCurrentPath(true));
    $('process-button').addEventListener('click', processCurrentPath);
    $('start-run-button').addEventListener('click', toggleRun);
    $('start-all-button').addEventListener('click', toggleAllRuns);
    $('export-button').addEventListener('click', exportTask);
    $('import-button').addEventListener('click', async (e) => {
      // æ ¡éªŒå¯¼å…¥æŒ‰é’®æƒé™
      if (!await checkButtonPermission('import-button', 'use_import_button')) {
        return;
      }
      await importTask();
    });
    // $('zoom-in').addEventListener('click', () => { if (map) map.zoomIn(); });
    // $('zoom-out').addEventListener('click', () => { if (map) map.zoomOut(); });
    // $('reset-view-btn').addEventListener('click', resetMapView);
    $('show-user-details').addEventListener('click', (e) => {
      e.stopPropagation(); // ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¨¡æ€æ¡†èƒŒæ™¯
      showUserDetails();
    });
    $('show-task-details').addEventListener('click', (e) => {
      e.stopPropagation(); // ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¨¡æ€æ¡†èƒŒæ™¯
      showTaskDetails();
    });
    $('auto-gen-button').addEventListener('click', () => {
      $('auto-gen-modal').classList.remove('hidden');
      $('auto-gen-modal').classList.add('flex'); // ç¡®ä¿å±…ä¸­
      document.body.classList.add('modal-visible'); // éšè—Logo
    });
    $('cancel-gen-button').addEventListener('click', () => {
      $('auto-gen-modal').classList.add('hidden');
      $('auto-gen-modal').classList.remove('flex'); // ç§»é™¤å±…ä¸­
      document.body.classList.remove('modal-visible'); // æ¢å¤Logo
    });
    $('confirm-gen-button').addEventListener('click', onConfirmAutoGenerate);

    // --- ç»‘å®šé€šçŸ¥æŒ‰é’® ---
    $('show-notifications-btn').addEventListener('click', (e) => {
      e.stopPropagation(); // ä¿®å¤ï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¨¡æ€æ¡†èƒŒæ™¯
      showNotifications();
    });

    $('mark-all-read-btn').addEventListener('click', markAllAsRead);
    $('refresh-notifications-btn').addEventListener('click', () => refreshNotificationsUI(true, true)); // æ‰‹åŠ¨åˆ·æ–°

    $('multi-download-template-btn').addEventListener('click', multi_downloadTemplate);


    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å‡½æ•° (JSç«¯) ---


    // å¤„ç†API Keyç¡®è®¤äº‹ä»¶
    async function onConfirmAmapKey() {
      const input = $('amap-key-input');
      const newKey = input.value.trim();
      if (!newKey) {
        showModalAlert('API Key ä¸èƒ½ä¸ºç©ºï¼');
        return;
      }

      const btn = $('confirm-amap-key-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = `<span class="inline-block animate-spin mr-2">â³</span>ä¿å­˜ä¸­...`;

      try {
        const result = await callPythonAPI('save_amap_key', newKey);
        if (result.success) {
          AMAP_API_KEY = newKey;
          const modal = $('amap-key-modal');
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.classList.remove('modal-visible');
          logMessage_Info("API Keyå·²æ›´æ–°ï¼Œæ­£åœ¨å°è¯•é‡æ–°åŠ è½½åœ°å›¾...");

          // å…³é”®ï¼šä¿å­˜æˆåŠŸåï¼Œé‡æ–°è§¦å‘åœ°å›¾åŠ è½½
          try {
            await loadAMapOnce();
            // å¦‚æœåœ°å›¾åŠ è½½æˆåŠŸï¼Œå¯èƒ½éœ€è¦åˆå§‹åŒ–ä¸€äº›ä¾èµ–åœ°å›¾çš„UI
            // ä¾‹å¦‚ï¼Œå¦‚æœå·²ç»è¿›å…¥äº†ä¸»ç•Œé¢ï¼Œåˆ™éœ€è¦ç¡®ä¿åœ°å›¾è¢«åˆ›å»º
            ensureSingleMap();
          } catch (e) {
            logMessage_Error('ä¿å­˜KeyååŠ è½½AMap SDKå¤±è´¥', e);
            logMessage_Info("[é”™è¯¯] æ–°çš„API Keyä¼¼ä¹æ— æ•ˆï¼Œåœ°å›¾åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥åé‡è¯•ã€‚");
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå¯ä»¥å†æ¬¡å¼¹å‡ºçª—å£
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-visible');
          }

        } else {
          showModalAlert(`ä¿å­˜å¤±è´¥: ${result.message}`);
        }
      } catch (e) { // [æ–°ä»£ç ] æ•è·APIè°ƒç”¨æœ¬èº«çš„é”™è¯¯
        logMessage_Error("ä¿å­˜API Keyæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:", e);
        showModalAlert(`ä¿å­˜å¤±è´¥: ${e.message}`);
      } finally { // [æ–°ä»£ç ] æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function bindImmediateRefreshForUserSelects() {
      const loginSelect = $('user-combo');
      const multiSelect = $('multi-config-user-select');

      if (loginSelect && !loginSelect._refreshBound) {
        loginSelect.addEventListener('focus', refreshUserList);
        loginSelect.addEventListener('click', refreshUserList);
        loginSelect._refreshBound = true;
      }

      if (multiSelect && !multiSelect._refreshBound) {
        multiSelect.addEventListener('focus', refreshUserList);
        multiSelect.addEventListener('click', refreshUserList);
        multiSelect._refreshBound = true;
      }
    }

    // --- ä¸“é—¨ç”¨äºåç«¯å¼ºåˆ¶åˆ·æ–°UIçš„å‡½æ•° ---

    async function multi_downloadTemplate() {
      const result = await callPythonAPI('multi_download_import_template');
      if (!result || !result.success) {
        showModalAlert(result?.message || 'æ¨¡æ¿ä¸‹è½½å¤±è´¥');
        return;
      }

      // Webæ¨¡å¼ï¼šä»è¿”å›çš„base64å†…å®¹åˆ›å»ºä¸‹è½½
      if (result.content && result.filename) {
        const binaryString = atob(result.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: result.mimetype || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage_Info(`æ¨¡æ¿å·²ä¸‹è½½ï¼š${result.filename}`);
      }
    }






    // ç”¨ get_initial_data å…¼å®¹åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
    async function refreshUserList() {
      // å¦‚æœå¤„äºç½‘ç»œé”™è¯¯çŠ¶æ€ï¼Œè·³è¿‡åˆ·æ–°é¿å…äº§ç”Ÿæ›´å¤šé”™è¯¯
      if (isInNetworkErrorState) {
        return;
      }

      // ---æ£€æŸ¥ sessionUUID æ˜¯å¦æœ‰æ•ˆ ---
      if (!sessionUUID || sessionUUID === 'null' || sessionUUID.trim() === '') {
        // logMessage_Info('sessionUUID å°šæœªåˆ†é…æˆ–æ— æ•ˆï¼Œæ— æ³•åˆ·æ–°ç”¨æˆ·åˆ—è¡¨ã€‚');
        return; // å¦‚æœ UUID æ— æ•ˆï¼Œåˆ™æå‰é€€å‡ºï¼Œä¸æ‰§è¡Œ API è°ƒç”¨
      }
      try {
        const initialData = await callPythonAPI('get_initial_data');
        // å…¼å®¹ç»“æ„ { users: [...], lastUser: '...' }
        const users = Array.isArray(initialData?.users) ? initialData.users : [];

        const select = document.getElementById("user-combo");                // ç™»å½•é¡µé€‰æ‹©æ¡†
        const multiSelect = document.getElementById("multi-config-user-select"); // å¤šè´¦å·æ¨¡å¼é€‰æ‹©æ¡†

        function updateSelect(selectElem, users) {
          if (!selectElem) return;
          // è®°å½•å½“å‰é€‰æ‹©ä¸æ»šåŠ¨ä½ç½®
          const previousValue = selectElem.value;
          const previousScrollTop = selectElem.scrollTop;

          // æ¸…ç©ºåé‡å»º
          selectElem.innerHTML = '';

          // ç»Ÿä¸€é¦–é¡¹ï¼šæ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)';
          selectElem.appendChild(opt);

          users.forEach(u => {
            const o = document.createElement('option');
            o.value = u;
            o.textContent = u;
            o.title = u; // é•¿æ–‡æœ¬ tooltip
            selectElem.appendChild(o);
          });

          // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
          if (users.includes(previousValue)) {
            selectElem.value = previousValue;
          } else {
            selectElem.value = '';
          }

          // æ¢å¤æ»šåŠ¨ä½ç½®
          selectElem.scrollTop = previousScrollTop;
        }

        updateSelect(select, users);
        updateSelect(multiSelect, users);
      } catch (err) {
        logMessage_Error("åˆ·æ–°ç”¨æˆ·åˆ—è¡¨å¤±è´¥", err);
      }
    }

    // å®šæ—¶åˆ·æ–°ï¼Œä¾‹å¦‚æ¯ 5 ç§’
    setInterval(refreshUserList, 5000);


    async function onUserChange() {
      // ============================================================
      // ç™»å½•æŒ‰é’®ç¦ç”¨ï¼šå¼€å§‹æ‰§è¡Œæ—¶ç¦ç”¨login-button
      // ============================================================
      const loginBtn = $('login-button');
      if (loginBtn) {
        loginBtn.disabled = true;  // ç¦ç”¨ç™»å½•æŒ‰é’®
      }

      try {
        const username = $('user-combo').value;
        const data = await callPythonAPI('on_user_selected', username);
        $('username-entry').value = username;
        $('password-entry').value = data.password || "";
        $('ua-label').textContent = data.ua || '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
        pythonParams = data.params || pythonParams;
        updateParamInputs($('params-container'), 'param', pythonParams);

        // åº”ç”¨ä¸»é¢˜é¢œè‰²
        const base = pythonParams.theme_base_color || '#7dd3fc';
        setBaseColor(base, base);

        // æ–°å¢ï¼šåº”ç”¨ä¸»é¢˜é£æ ¼
        const style = pythonParams.theme_style || 'default';
        setThemeStyle(style);
      } finally {
        // ============================================================
        // ç™»å½•æŒ‰é’®æ¢å¤ï¼šæ‰§è¡Œå®Œæˆåæ¢å¤login-button
        // ============================================================
        if (loginBtn) {
          loginBtn.disabled = false;  // æ¢å¤ç™»å½•æŒ‰é’®
        }
      }
    }

    async function onLogin() {
      logMessage_Info('[å‰ç«¯-ç™»å½•] å¼€å§‹ç™»å½•æµç¨‹...');
      const user = $('username-entry').value.trim();
      const pass = $('password-entry').value;

      logMessage_Info(`[å‰ç«¯-ç™»å½•] ç”¨æˆ·å: ${user}`);
      if (!user) {
        logMessage_Info('[å‰ç«¯-ç™»å½•] é”™è¯¯: ç”¨æˆ·åä¸ºç©º');
        showModalAlert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }

      // åœ¨çº¿ç™»å½•å‰ï¼Œå¤ä½ç¦»çº¿æ ‡å¿—ä¸ UA æŒ‰é’®
      IS_OFFLINE = false;
      const uaBtn = $('random-ua-btn'); if (uaBtn) uaBtn.disabled = false;

      // åœ¨ç™»å½•å‰ï¼Œä»ç™»å½•é¡µçš„UAæ ‡ç­¾æ•è·å½“å‰çš„UA
      const uaOnLoginScreen = $('ua-label')?.textContent || "";
      logMessage_Info(`[å‰ç«¯-ç™»å½•] å½“å‰UA: ${uaOnLoginScreen.substring(0, 50)}...`);

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      setButtonLoading('login-button', true, 'ç™»å½•ä¸­...');

      logMessage_Info('[å‰ç«¯-ç™»å½•] è°ƒç”¨åç«¯APIè¿›è¡Œç™»å½•éªŒè¯...');
      const result = await callPythonAPI('login', user, pass);
      if (result.success) {
        logMessage_Info('[å‰ç«¯-ç™»å½•] âœ“ ç™»å½•æˆåŠŸï¼');
        showButtonSuccess('login-button', 'ç™»å½•æˆåŠŸ');
        // ä¿®å¤Issue 3: åœ¨æ˜¾ç¤ºä¸»ç•Œé¢å‰å…ˆåŠ è½½AMap API Key
        if (result.amap_key) {
          logMessage_Info('[å‰ç«¯-ç™»å½•] åŠ è½½é«˜å¾·åœ°å›¾API...');
          AMAP_API_KEY = result.amap_key;
          try {
            await loadAMapOnce();
            logMessage_Info('[å‰ç«¯-ç™»å½•] âœ“ åœ°å›¾åŠ è½½æˆåŠŸ');
          } catch (e) {
            logMessage_Error('[å‰ç«¯-ç™»å½•] âœ— åœ°å›¾åŠ è½½å¤±è´¥:', e);
          }
        }

        logMessage_Info('[å‰ç«¯-ç™»å½•] æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢...');
        showMainApp();
        $('loading-overlay').classList.add('hidden');
        currentUserData = result.userInfo;
        // å°† auth_group æ³¨å…¥ currentUserData
        currentUserData.group = result.auth_group || 'user';
        currentSessionUA = uaOnLoginScreen;
        const name = currentUserData.name || '';
        $('user-name-label').textContent = `å§“å: ${name}`;
        $('user-id-label').textContent = `å­¦å·: ${currentUserData.student_id}`;
        logMessage_Info(`[å‰ç«¯-ç™»å½•] ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°: ${name} (${currentUserData.student_id})`);

        logMessage_Info('[å‰ç«¯-ç™»å½•] æ›´æ–°ä»ªè¡¨ç›˜...');
        updateDashboard();

        logMessage_Info('[å‰ç«¯-ç™»å½•] åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...');
        await refreshTasks();

        logMessage_Info('[å‰ç«¯-ç™»å½•] è·å–é€šçŸ¥...');
        // åœ¨è·å–é€šçŸ¥å‰ï¼Œå…ˆéšè—é€šçŸ¥å¾½ç« ï¼Œç›´åˆ°è·å¾—ç¡®åˆ‡æ•°é‡
        const notificationBadge = $('notification-badge');
        if (notificationBadge) {
          notificationBadge.classList.add('hidden');
        }

        // ã€ä¼˜åŒ–ã€‘ç™»å½•è¿”å›çš„ç»“æœä¸­å·²ç»åŒ…å«é¢„åŠ è½½çš„é€šçŸ¥ï¼Œæ— éœ€å†æ¬¡è¯·æ±‚
        if (result.cached_notifications && result.cached_notifications.notices.length > 0) {
          logMessage_Info(`ä½¿ç”¨ç™»å½•æ—¶é¢„åŠ è½½çš„ ${result.cached_notifications.notices.length} æ¡é€šçŸ¥`);
          // æ›´æ–°å¾½ç« 
          if (result.cached_notifications.unreadCount > 0) {
            notificationBadge.textContent = result.cached_notifications.unreadCount > 9 ? '9+' : result.cached_notifications.unreadCount;
            notificationBadge.classList.remove('hidden');
          }
          // ç¼“å­˜åˆ°å…¨å±€å˜é‡
          window.currentNotifications = result.cached_notifications.notices;
        } else {
          // å¦‚æœç™»å½•å“åº”ä¸­æ²¡æœ‰é¢„åŠ è½½é€šçŸ¥ï¼Œåˆ™ä¸»åŠ¨è·å–
          await fetchNotifications();
        }

        const base = pythonParams.theme_base_color || '#7dd3fc';
        setBaseColor(base, base);
        // æ˜¾ç¤ºç®¡ç†æŒ‰é’®ï¼ˆæ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬æ¸¸å®¢éƒ½å¯ä»¥è®¿é—®ï¼‰
        const adminBtn = $('show-admin-panel');
        if (adminBtn) adminBtn.classList.remove('hidden');
        const adminBtnLogin = $('show-admin-panel-login');
        if (adminBtnLogin) adminBtnLogin.classList.remove('hidden');
        $('loading-overlay').classList.add('hidden');
        logMessage_Info('[å‰ç«¯-ç™»å½•] âœ“ ç™»å½•æµç¨‹å®Œæˆï¼');
      } else {
        logMessage_Info(`[å‰ç«¯-ç™»å½•] âœ— ç™»å½•å¤±è´¥: ${result.message}`);
        setButtonLoading('login-button', false);
        showButtonError('login-button', 'ç™»å½•å¤±è´¥');
        showModalAlert(result.message, 'ç™»å½•å¤±è´¥');
      }
    }



    async function onLogout() {
      await callPythonAPI('logout');
      currentSessionUA = "";
      resetUI();


      if (refreshUserListInterval) {
        clearInterval(refreshUserListInterval);
        refreshUserListInterval = null;
        logMessage_Info('refreshUserList interval cleared on logout.');
      }

      // ç­‰å¾… 0.5 ç§’ä»¥ä¾¿å®Œæˆæ¸…ç†ï¼Œå†åŠ è½½ç®¡ç†ä¼šè¯
      await new Promise(resolve => setTimeout(resolve, 500));
      loadAdminSessions_inline();
    }


    async function refreshTasks() {
      if (isRefreshingTasks) {
        // å¹¶å‘ä¿æŠ¤ï¼šå·²æœ‰åˆ·æ–°åœ¨è¿›è¡Œä¸­æ—¶ç›´æ¥è¿”å›
        return;
      }
      isRefreshingTasks = true;

      // ä¸´æ—¶ç¦ç”¨åˆ·æ–°æŒ‰é’®ï¼Œç”¨æˆ·ä½“éªŒæ›´æ˜ç¡®
      const btn = $('refresh-button');
      if (btn) btn.disabled = true;

      try {
        const taskResult = await callPythonAPI('load_tasks');
        if (taskResult && taskResult.success) {
          currentTasks = taskResult.tasks;
          renderTaskList();
          return;
        }

        // å°å»¶è¿Ÿé‡è¯•ä¸€æ¬¡ï¼ˆå…œåº•ï¼‰ï¼Œä½†ä»ä¿æŒé˜²æŠ–
        await new Promise(r => setTimeout(r, 300));
        const retry = await callPythonAPI('load_tasks');
        if (retry && retry.success) {
          currentTasks = retry.tasks;
          renderTaskList();

          await fetchNotifications();

        } else {
          logMessage_Info("åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç‚¹å‡»å·¦ä¾§â€œåˆ·æ–°â€é‡è¯•ã€‚");
        }
      } finally {
        isRefreshingTasks = false;
        if (btn) btn.disabled = false;
      }
    }


    function renderTaskList() {
      const taskListDiv = $('task-list'); taskListDiv.innerHTML = "";
      if (currentTasks.length === 0) { taskListDiv.innerHTML = `<div class="text-slate-400 text-center py-10">æš‚æ— ä»»åŠ¡</div>`; return; }
      currentTasks.forEach((task, index) => {
        const item = document.createElement('div');
        const pathStatus = task.run_coords?.length > 0 ? 'å·²ç”Ÿæˆ' : (task.draft_coords?.length > 0 ? 'è‰ç¨¿' : 'æ— è·¯å¾„');
        let statusClass = 'text-amber-600', statusText = 'æœªå®Œæˆ', statusIcon = 'ğŸ•’';

        // å·²å®Œæˆï¼ˆå®½æ¾æ¯”è¾ƒï¼Œå…¼å®¹æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
        if (task.status == 1) { statusClass = 'text-emerald-600'; statusText = 'å·²å®Œæˆ'; statusIcon = 'âœ…'; }

        // è¿‡æœŸä¼˜å…ˆæ˜¾ç¤º
        if (task.info_text === 'å·²è¿‡æœŸ') { statusClass = 'text-red-600'; statusText = 'å·²è¿‡æœŸ'; statusIcon = 'â›”'; }

        // è‹¥åç«¯ info_text è¡¨ç¤ºâ€œå¼€å§‹äº: YYYY-MM-DDâ€ï¼Œåˆ™æŠŠå·¦ä¾§çŠ¶æ€æ˜¾ç¤ºä¸ºâ€œæœªå¼€å§‹â€
        if (!(task.status == 1)) {
          if (typeof task.info_text === 'string' && task.info_text.startsWith('å¼€å§‹äº')) {
            statusClass = 'text-slate-600';
            statusText = 'æœªå¼€å§‹';
            statusIcon = 'â³';
          }
        }

        item.className = 'p-3 rounded-xl cursor-pointer border border-transparent transition-colors duration-200 hover:bg-white/70';
        item.innerHTML = `
      <div class="flex items-center gap-3">
        <p class="font-bold text-slate-700 text-sm truncate">${task.run_name}</p>
      </div>
      <div class="flex justify-between items-center mt-2 text-xs">
        <span class="font-semibold ${statusClass} flex items-center gap-1">${statusIcon} ${statusText}</span>
        <span class="text-slate-500">${task.info_text || ''}</span>
        <span class="badge">${pathStatus}</span>
      </div>
    `;
        item.dataset.index = index;
        if (task.status === 1) item.classList.add('opacity-60');
        if (index === selectedTaskIndex) item.classList.add('selected');
        item.addEventListener('click', () => selectTask(index));
        taskListDiv.appendChild(item);
      });
    }

    async function forceLoadTaskDataForPolling(taskIndex) {
      if (taskIndex < 0 || taskIndex >= currentTasks.length) return;
      // é¿å…é‡å¤åŠ è½½
      if (currentRunData && currentRunData.task_index === taskIndex) return;

      logMessage_Info(`[Polling] å¼ºåˆ¶åŠ è½½ä»»åŠ¡ #${taskIndex} çš„æ•°æ®...`);
      try {
        const result = await callPythonAPI('get_task_details', taskIndex);
        if (result.success) {
          currentRunData = result.details;
          currentRunData.task_index = taskIndex; // æ ‡è®°å·²åŠ è½½
          updateDashboard();
          drawOnMap();
          loadHistory(taskIndex);

          // é‡ç½®è¯¥ä»»åŠ¡çš„è¿›åº¦è·Ÿè¸ª
          singleProcessedPoints = 0;
          singleTotalPoints = (currentRunData.run_coords?.length || 0);
          updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
        } else {
          logMessage_Error(`[Polling] å¼ºåˆ¶åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥: ${result.message}`);
        }
      } catch (e) {
        logMessage_Error(`[Polling] å¼ºåˆ¶åŠ è½½ä»»åŠ¡æ—¶å‡ºé”™: ${e}`);
      }
    }

    async function selectTask(index, Update_Dashboard = true) {
      logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] å¼€å§‹é€‰æ‹©ä»»åŠ¡ï¼Œç´¢å¼•: ${index}`, 'DEBUG');
      logMessage_Info(`[å‰ç«¯-ä»»åŠ¡é€‰æ‹©] é€‰æ‹©ä»»åŠ¡ #${index}`);

      // é˜²æ­¢åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ‡æ¢ä»»åŠ¡ï¼ˆä½†å…è®¸é‡æ–°é€‰æ‹©å½“å‰ä»»åŠ¡ï¼‰
      if (backgroundTaskPollInterval && selectedTaskIndex !== index) {
        logMessage_Warning("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•åˆ‡æ¢ä»»åŠ¡ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        showModalAlert("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•åˆ‡æ¢ä»»åŠ¡ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        return;
      }

      if (isDrawing) {
        logMessage_Info("è¯·å…ˆç»“æŸå½“å‰è·¯å¾„ç»˜åˆ¶ï¼", 'WARN');
        return;
      }
      if (selectedTaskIndex === index) {
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] ä»»åŠ¡å·²é€‰ä¸­ï¼Œæ— éœ€é‡å¤é€‰æ‹©: ${index}`, 'DEBUG');
        return;
      }

      const taskListDiv = $('task-list');
      if (selectedTaskIndex > -1 && taskListDiv.children[selectedTaskIndex]) {
        taskListDiv.children[selectedTaskIndex].classList.remove('selected');
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] å–æ¶ˆé€‰ä¸­ä¸Šä¸€ä¸ªä»»åŠ¡: ${selectedTaskIndex}`, 'DEBUG');
      }
      selectedTaskIndex = index;
      if (taskListDiv.children[selectedTaskIndex]) {
        taskListDiv.children[selectedTaskIndex].classList.add('selected');
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] é«˜äº®æ˜¾ç¤ºå½“å‰ä»»åŠ¡: ${index}`, 'DEBUG');
      }

      // --- BUGä¿®å¤ ---
      const selectedTask = currentTasks[index];
      // åˆ¤æ–­æ˜¯å¦ä¸ºç¦»çº¿å¯¼å…¥çš„ä»»åŠ¡
      if (selectedTask && selectedTask.info_text === "ç¦»çº¿") {
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] ç¦»çº¿æ¨¡å¼ä»»åŠ¡ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®`, 'INFO');
        // ç¦»çº¿æ¨¡å¼: ç›´æ¥ä½¿ç”¨å‰ç«¯å·²æœ‰çš„å®Œæ•´æ•°æ®ï¼Œä¸å†è¯·æ±‚åç«¯
        currentRunData = selectedTask;
        if (Update_Dashboard) {
          updateDashboard();
        }
        drawOnMap();
        loadHistory(index); // åŠ è½½å†å²ï¼ˆç¦»çº¿æ¨¡å¼ä¸‹é€šå¸¸ä¸ºç©ºï¼‰
        singleProcessedPoints = 0;
        singleTotalPoints = (currentRunData.run_coords?.length || 0);
        updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ“ ç¦»çº¿ä»»åŠ¡åŠ è½½å®Œæˆï¼Œæ€»ç‚¹æ•°: ${singleTotalPoints}`, 'INFO');
      } else {
        // åœ¨çº¿æ¨¡å¼: æŒ‰åŸé€»è¾‘ä»åç«¯è·å–è¯¦æƒ…
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] åœ¨çº¿æ¨¡å¼ï¼Œä»åç«¯è·å–ä»»åŠ¡è¯¦æƒ…...`, 'INFO');
        const result = await callPythonAPI('get_task_details', index);
        if (result.success) {
          logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ“ ä»»åŠ¡è¯¦æƒ…è·å–æˆåŠŸ`, 'INFO');
          currentRunData = result.details;
          updateDashboard();

          drawOnMap();
          // setTimeout(() => {
          //   if (selectedTaskIndex === index) {
          //     logMessage_Info("æ‰§è¡ŒäºŒæ¬¡æ¸²æŸ“ä»¥ä¿®æ­£åˆå§‹ä½ç§»...", 'DEBUG');
          //     drawOnMap();
          //   }
          // }, 100); // ç¨å¾®å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿æ¸²æŸ“ç¨³å®š

          loadHistory(index);
          singleProcessedPoints = 0;
          singleTotalPoints = (currentRunData.run_coords?.length || 0);
          updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
          logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ“ åœ¨çº¿ä»»åŠ¡åŠ è½½å®Œæˆï¼Œæ€»ç‚¹æ•°: ${singleTotalPoints}`, 'INFO');
        } else {
          logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ— è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ${result.message}`, 'ERROR');
          logMessage_Info(result.message);
        }
      }
    }


    // --- å¤šè´¦å·æ¨¡å¼äº‹ä»¶ç›‘å¬ ---
    $('multi-account-btn').addEventListener('click', async (e) => {
      // æ ¡éªŒå¤šè´¦å·æ§åˆ¶å°æŒ‰é’®æƒé™
      if (!await checkButtonPermission('multi-account-btn', 'use_multi_account_button')) {
        return;
      }
      await switchToMultiMode();
    });
    $('exit-multi-mode-btn').addEventListener('click', exitMultiMode);
    $('multi-start-all-btn').addEventListener('click', multi_startAll);
    $('multi-stop-all-btn').addEventListener('click', multi_stopAll);
    $('multi-load-all-from-config-btn').addEventListener('click', multi_loadAllFromConfig);
    $('multi-add-from-config-btn').addEventListener('click', multi_addFromConfig);
    $('multi-import-excel-btn').addEventListener('click', multi_importFromExcel);
    $('multi-export-excel-btn').addEventListener('click', multi_exportToExcel);
    // $('multi-zoom-in').addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomIn(); });
    // $('multi-zoom-out').addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomOut(); });
    // $('multi-reset-view-btn').addEventListener('click', multi_resetMapView);

    // ä¸ºå¤šè´¦å·åˆ—è¡¨å·¥å…·æ ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    $('multi-remove-all-btn').addEventListener('click', multi_removeAll);
    $('multi-remove-selected-btn').addEventListener('click', multi_removeSelected);
    $('multi-refresh-all-btn').addEventListener('click', multi_refreshAll);
    $('multi-select-all-check').addEventListener('change', multi_toggleSelectAll);
    $('multi-start-selected-btn').addEventListener('click', multi_startSelected);
    $('multi-stop-selected-btn').addEventListener('click', multi_stopSelected);
    $('multi-refresh-selected-btn').addEventListener('click', multi_refreshSelected);


    // --- ç®¡ç†é¢æ¿æ ‡ç­¾é¡µäº‹ä»¶ç›‘å¬ ---
    $('admin-tab-users_modal')?.addEventListener('click', () => switchAdminTab('users'));
    $('admin-tab-groups_modal')?.addEventListener('click', () => switchAdminTab('groups'));
    $('admin-tab-logs_modal')?.addEventListener('click', () => switchAdminTab('logs'));
    $('admin-tab-health_modal')?.addEventListener('click', () => switchAdminTab('health'));
    $('admin-tab-profile_modal')?.addEventListener('click', () => switchAdminTab('profile'));
    $('admin-tab-sessions_modal')?.addEventListener('click', () => switchAdminTab('sessions'));
    $('admin-tab-messages_modal')?.addEventListener('click', () => switchAdminTab('messages'));
    $('admin-tab-ipban_modal')?.addEventListener('click', () => switchAdminTab('ipban'));
    $('admin-tab-sms_modal')?.addEventListener('click', () => switchAdminTab('sms'));

    // ============================================================
    // ä»»åŠ¡14ï¼šç”¨æˆ·æ—¥å¿—Tabåˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
    // ä¸ºç™»å½•è®°å½•å’Œæ“ä½œè®°å½•Tabæ·»åŠ ç‚¹å‡»äº‹ä»¶
    // ============================================================

    // ç™»å½•è®°å½•Tabç‚¹å‡»äº‹ä»¶ï¼šåˆ‡æ¢åˆ°ç™»å½•è®°å½•è§†å›¾
    const loginTabBtn = $('log-tab-login');
    if (loginTabBtn) {
      loginTabBtn.addEventListener('click', () => {
        // æ¿€æ´»ç™»å½•è®°å½•Tabæ ·å¼
        loginTabBtn.classList.add('text-sky-600', 'border-sky-600');
        loginTabBtn.classList.remove('text-slate-400', 'border-transparent');

        // å–æ¶ˆæ¿€æ´»æ“ä½œè®°å½•Tabæ ·å¼
        const auditTabBtn = $('log-tab-audit');
        if (auditTabBtn) {
          auditTabBtn.classList.remove('text-sky-600', 'border-sky-600');
          auditTabBtn.classList.add('text-slate-400', 'border-transparent');
        }

        // æ˜¾ç¤ºç™»å½•è®°å½•å†…å®¹ï¼Œéšè—æ“ä½œè®°å½•å†…å®¹
        const loginContent = $('log-login-content');
        const auditContent = $('log-audit-content');
        if (loginContent) loginContent.classList.remove('hidden');
        if (auditContent) auditContent.classList.add('hidden');

        // é‡æ–°åŠ è½½ç™»å½•è®°å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
        const username = $('current-log-username')?.textContent;
        if (username && username !== 'N/A') {
          loadUserLoginLogs(username);
        }
      });
    }

    // æ“ä½œè®°å½•Tabç‚¹å‡»äº‹ä»¶ï¼šåˆ‡æ¢åˆ°æ“ä½œè®°å½•è§†å›¾
    const auditTabBtn = $('log-tab-audit');
    if (auditTabBtn) {
      auditTabBtn.addEventListener('click', () => {
        // æ¿€æ´»æ“ä½œè®°å½•Tabæ ·å¼
        auditTabBtn.classList.add('text-sky-600', 'border-sky-600');
        auditTabBtn.classList.remove('text-slate-400', 'border-transparent');

        // å–æ¶ˆæ¿€æ´»ç™»å½•è®°å½•Tabæ ·å¼
        const loginTabBtn = $('log-tab-login');
        if (loginTabBtn) {
          loginTabBtn.classList.remove('text-sky-600', 'border-sky-600');
          loginTabBtn.classList.add('text-slate-400', 'border-transparent');
        }

        // æ˜¾ç¤ºæ“ä½œè®°å½•å†…å®¹ï¼Œéšè—ç™»å½•è®°å½•å†…å®¹
        const loginContent = $('log-login-content');
        const auditContent = $('log-audit-content');
        if (loginContent) loginContent.classList.add('hidden');
        if (auditContent) auditContent.classList.remove('hidden');

        // åŠ è½½æ“ä½œè®°å½•
        const username = $('current-log-username')?.textContent;
        if (username && username !== 'N/A') {
          loadUserAuditLogs(username);
        }
      });
    }

    // ç•™è¨€æ¿åˆ·æ–°æŒ‰é’®
    $('admin-refresh-messages_modal')?.addEventListener('click', loadMessages);
    // ç»‘å®šæ¸¸å®¢æç¤ºå¼¹çª—çš„å…³é—­æŒ‰é’®
    const guestWarningCloseBtn = $('guest-warning-close-btn');
    const guestWarningOverlay = $('guest_warning_overlay');
    if (guestWarningCloseBtn) {
      guestWarningCloseBtn.addEventListener('click', () => {
        const guestToast = $('guest-warning-toast');
        // åŒæ—¶éšè—å¼¹çª—å’Œé®ç½©å±‚
        if (guestToast) {
          guestToast.classList.add('hidden');
        }
        if (guestWarningOverlay) {
          guestWarningOverlay.classList.add('hidden');
        }
      });
    }
    // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­å¼¹çª—
    if (guestWarningOverlay) {
      guestWarningOverlay.addEventListener('click', () => {
        const guestToast = $('guest-warning-toast');
        if (guestToast) {
          guestToast.classList.add('hidden');
        }
        guestWarningOverlay.classList.add('hidden');
      });
    }

    // --- å¤šè´¦å·æ¨¡å¼æ ¸å¿ƒå‡½æ•° ---
    async function switchToMultiMode() {

      $('multi-account-count').textContent = 0;

      const result = await callPythonAPI('enter_multi_account_mode');
      if (!result.success) return;
      
      // [ä¿®å¤] æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å¤šè´¦å·ç•Œé¢
      if (isMobileMode) {
        // ç§»åŠ¨ç«¯ï¼šéšè—ç™»å½•å®¹å™¨ï¼Œæ˜¾ç¤ºmobile-multi-account-app
        const mobileLoginContainer = document.getElementById('mobile-login-container');
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');
        const mobileMainApp = document.getElementById('mobile-main-app');
        
        if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
        if (mobileMainApp) mobileMainApp.classList.add('hidden');
        if (mobileMultiApp) {
          mobileMultiApp.classList.remove('hidden');
          switchMobilePanel('mobile-multi-account-panel', 'multi');
          console.log('[åˆ‡æ¢æ¨¡å¼] ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º mobile-multi-account-app');
        }
        
        // æ˜¾ç¤ºç§»åŠ¨ç«¯å¤šè´¦å·æ¨¡å¼å¯¼èˆªæ 
        updateMobileNavVisibility(true, 'multi');
        
        // ç¡®ä¿æ¡Œé¢ç«¯åº”ç”¨éšè—
        $('login-container').classList.add('hidden');
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.add('hidden');
      } else {
        // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºmulti-account-app
        $('login-container').classList.add('hidden');
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.remove('hidden');
        $('multi-account-app').classList.add('grid');
        console.log('[åˆ‡æ¢æ¨¡å¼] æ¡Œé¢ç«¯ï¼šæ˜¾ç¤º multi-account-app');
      }
      
      document.body.classList.remove('modal-visible');



      // ç»Ÿä¸€åŠ è½½ä¸€æ¬¡ SDKï¼ˆè‹¥å·²åŠ è½½åˆ™ç«‹å³è¿”å›ï¼‰
      try {
        await loadAMapOnce();
      } catch (e) {
        logMessage_Error('AMap æœªå°±ç»ªï¼Œæ— æ³•è¿›å…¥å¤šè´¦å·åœ°å›¾', e);
        return;
      }


      // åˆ›å»ºå¤šè´¦å·åœ°å›¾
      if (!multiAccountMap && AMapInstance) {
        // æµè§ˆå™¨ä¼šå°½é‡å°†å›¾åƒæ•°æ®ç¼“å­˜åœ¨GPUå†…å­˜ä¸­ï¼Œä»è€Œæé«˜å¤šä¸ªgetImageDataè¯»å–æ“ä½œçš„é€Ÿåº¦
        multiAccountMap = new AMapInstance.Map('multi-map-container', {
          viewMode: '3D',
          pitch: 55,
          rotation: 0,
          zoom: 17,
          center: [113.390342, 22.527403],
          renderOptions: {
            willReadFrequently: true  // ä¼˜åŒ–canvasæ€§èƒ½
          }
        });

        // å¤šè´¦å·åœ°å›¾çš„ 3D æ§åˆ¶æ† (ç›´æ¥åˆ›å»º)
        const ctrlBar = new AMapInstance.ControlBar({
          position: { left: '12px', top: '12px' },
          showZoomBar: false,
          showControlButton: true
        });
        multiAccountMap.addControl(ctrlBar);


        // å»ºç­‘ç‰©å›¾å±‚ (ç›´æ¥åˆ›å»º)
        try {
          const buildings = new AMapInstance.BuildingLayer();
          buildings.setMap(multiAccountMap);
        } catch (e) {
          logMessage_Warning('BuildingLayer not available (multi):', e);
        }

        multiAccountMap.on('zoomchange', () => {
          const z = multiAccountMap.getZoom();
          $('multi-zoom-level').textContent = String(z.toFixed(1));
        });

        multiAccountMap.on('zoomchange', () => {
          if (!multiAccountMap) return; // é˜²å¾¡æ£€æŸ¥
          const z = multiAccountMap.getZoom();
          const zoomLevelEl = $('multi-zoom-level');
          if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
        });

        // ä¿å­˜æ¸…ç†å‡½æ•°
        if (window.multiMapCleanup) window.multiMapCleanup();
        window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

        multiAccountMap.setStatus({
          doubleClickZoom: true,
          dragEnable: true,
          scrollWheel: true,
          keyboardEnable: true
        });

        // å…œåº•é‡å»ºå¹¶ç»‘å®šå¤šè´¦å·æ§ä»¶
        ensureMultiControls();
      }





      const configUsers = await callPythonAPI('multi_get_all_config_users');
      const select = $('multi-config-user-select');
      select.innerHTML = '<option value="">(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)</option>';
      configUsers.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = u;
        select.appendChild(opt);
      });

      // åˆå§‹åŒ–å…¨å±€å‚æ•°UI
      const container = $('multi-global-params-container');
      container.innerHTML = '';
      createParamInputs(container, 'multi-param', onGlobalParamChange);
      pythonParams = result.params;
      updateParamInputs(container, 'multi-param', pythonParams);

      await callPythonAPI('set_multi_run_only_incomplete',
        document.getElementById('multi-run-only-incomplete-check').checked
      );

      // ç¡®ä¿å¤šè´¦å·é€‰æ‹©æ¡†ä¹Ÿæœ‰â€œç‚¹å‡»/èšç„¦å³åˆ·æ–°â€
      bindImmediateRefreshForUserSelects();

      // self.log("å·²è¿›å…¥å¤šè´¦å·æ¨¡å¼ã€‚")
      updateMultiGlobalButtons(true, true); // åˆå§‹ç¦ç”¨ï¼Œåç«¯å¾ˆå¿«ä¼šæ ¹æ®çœŸå®çŠ¶æ€åˆ·æ–°

    }

    async function exitMultiMode() {
      path_planning_queue = [];
      is_planning_path = false;
      await callPythonAPI('exit_multi_account_mode');
      
      // [ä¿®å¤] æ ¹æ®è®¾å¤‡ç±»å‹éšè—å¯¹åº”çš„å¤šè´¦å·ç•Œé¢ï¼Œæ˜¾ç¤ºç™»å½•å®¹å™¨
      if (isMobileMode) {
        // ç§»åŠ¨ç«¯ï¼šéšè—mobile-multi-account-appï¼Œæ˜¾ç¤ºmobile-login-container
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');
        const mobileLoginContainer = document.getElementById('mobile-login-container');
        
        if (mobileMultiApp) mobileMultiApp.classList.add('hidden');
        if (mobileLoginContainer) mobileLoginContainer.classList.remove('hidden');
        
        // éšè—å¯¼èˆªæ 
        updateMobileNavVisibility(false);
        
        console.log('[é€€å‡ºå¤šè´¦å·] ç§»åŠ¨ç«¯ï¼šéšè— mobile-multi-account-appï¼Œæ˜¾ç¤º mobile-login-container');
      } else {
        // æ¡Œé¢ç«¯ï¼šéšè—multi-account-appï¼Œæ˜¾ç¤ºlogin-container
        $('multi-account-app').classList.add('hidden');
        $('multi-account-app').classList.remove('grid');
        $('login-container').classList.remove('hidden');
        console.log('[é€€å‡ºå¤šè´¦å·] æ¡Œé¢ç«¯ï¼šéšè— multi-account-appï¼Œæ˜¾ç¤º login-container');
      }
      
      document.body.classList.remove('modal-visible');

      $('multi-account-list').innerHTML = '<p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>';
      if (multiAccountMap) {
        // å…ˆæ‰§è¡Œæ¸…ç†
        if (window.multiMapCleanup) {
          window.multiMapCleanup();
          window.multiMapCleanup = null;
        }
        try { multiAccountMap.remove(Object.values(multiAccountMarkers)); } catch (_) { }
        try { if (typeof multiAccountMap.destroy === 'function') multiAccountMap.destroy(); } catch (e) { logMessage_Warning('destroy multiAccountMap warning:', e); }
      }
      multiAccountMarkers = {};
      multiAccountMap = null;

      resetUI();
      if (refreshUserListInterval) {
        clearInterval(refreshUserListInterval);
        refreshUserListInterval = null;
        logMessage_Info('refreshUserList interval cleared on exiting multi mode.');
      }

      // ç­‰å¾… 0.5 ç§’ä»¥ä¾¿å®Œæˆæ¸…ç†ï¼Œå†åŠ è½½ç®¡ç†ä¼šè¯
      await new Promise(resolve => setTimeout(resolve, 500));
      loadAdminSessions_inline();

    }


    async function multi_loadAllFromConfig() {
      const result = await callPythonAPI('multi_load_accounts_from_config');
      if (result && result.accounts) {
        renderMultiAccountList(result.accounts);
      }

      // ä¿®æ­£ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è´¦å·ç¼ºå°‘å¯†ç 
      if (result && result.accounts_missing_password && result.accounts_missing_password.length > 0) {
        const missingAccount = result.accounts_missing_password[0];
        // å¼¹çª—æç¤ºç”¨æˆ·ä¸ºç¬¬ä¸€ä¸ªç¼ºå¯†ç çš„è´¦å·è¡¥å…¨
        showModalAlert(`æ£€æµ‹åˆ° ${result.accounts_missing_password.length} ä¸ªè´¦å·ç¼ºå°‘å¯†ç ã€‚\nè¯·å…ˆä¸ºä»¥ä¸‹è´¦å·è¡¥å…¨å¯†ç ï¼š ${missingAccount.username}`, 'æç¤º');
        openMultiAddUserModalForPassword(missingAccount.username, missingAccount.tag);
      }
    }

    function openNewUserModal() {
      // é—®é¢˜3ä¿®å¤ï¼šæ¸…ç©ºæ‰€æœ‰è¡¨å•å­—æ®µ
      $('newUsername').value = "";
      $('newPassword').value = "";
      $('newPasswordConfirm').value = "";
      $('newUserPhone').value = "";
      $('newUserNickname').value = "";
      $('newUserSmsCode').value = "";
      $('newUserSmsGroup').style.display = "none";
      $('newUserModal').style.display = "flex"; /* å°† 'block' æ”¹ä¸º 'flex' ä»¥å¯ç”¨å±…ä¸­ */

      // é—®é¢˜3ä¿®å¤ï¼šç›‘å¬æ‰‹æœºå·è¾“å…¥ï¼Œæ˜¾ç¤º/éšè—éªŒè¯ç å­—æ®µ
      const phoneInput = $('newUserPhone');
      phoneInput.oninput = () => {
        const phone = phoneInput.value.trim();
        if (phone) {
          $('newUserSmsGroup').style.display = "block";
        } else {
          $('newUserSmsGroup').style.display = "none";
        }
      };
    }

    function closeNewUserModal() {
      $('newUserModal').style.display = "none";
    }
    $('newUserClose').onclick = closeNewUserModal;
    $('newUserCancel').onclick = closeNewUserModal;


    // æ‰“å¼€å¤šè´¦å·æ·»åŠ æ¨¡æ€æ¡†
    function openMultiAddUserModal() {
      // æ¸…ç©ºè¾“å…¥
      $('multi-add-username').value = "";
      $('multi-add-password').value = "";
      $('multi-add-tag').value = "";
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      $('multi-add-user-modal').style.display = 'flex';
    }

    // å…³é—­å¤šè´¦å·æ·»åŠ æ¨¡æ€æ¡†
    function closeMultiAddUserModal() {
      // 1. [æ–°å¢] æ¸…ç†å¯èƒ½å­˜åœ¨çš„åªè¯»çŠ¶æ€
      const usernameInput = $('multi-add-username');
      const passwordInput = $('multi-add-password');
      if (usernameInput) {
        usernameInput.readOnly = false;
        usernameInput.classList.remove('bg-slate-100', 'cursor-not-allowed');
      }
      if (passwordInput) {
        passwordInput.placeholder = 'è¯·è¾“å…¥å¯†ç  (è‡³å°‘6å­—ç¬¦)';
      }

      // 2. éšè—æ¨¡æ€æ¡†
      $('multi-add-user-modal').style.display = 'none';
    }

    /**
     * ä¿®æ­£ï¼šæ‰“å¼€å¤šè´¦å·æ¨¡æ€æ¡†ï¼Œç”¨äºä¸ºç¼ºå°‘å¯†ç çš„è´¦å·è¡¥å…¨å¯†ç 
     * @param {string} username - ç¼ºå°‘å¯†ç çš„ç”¨æˆ·å
     * @param {string} tag - è¯¥è´¦å·å·²æœ‰çš„æ ‡è®° (å¯é€‰)
     */
    function openMultiAddUserModalForPassword(username, tag) {
      // 1. é¢„å¡«å……å­—æ®µ
      const usernameInput = $('multi-add-username');
      const tagInput = $('multi-add-tag');
      const passwordInput = $('multi-add-password');

      if (usernameInput) {
        usernameInput.value = username;
        usernameInput.readOnly = true; // ç”¨æˆ·åä¸å¯ä¿®æ”¹
        usernameInput.classList.add('bg-slate-100', 'cursor-not-allowed');
      }
      if (tagInput) {
        tagInput.value = tag || '';
      }
      if (passwordInput) {
        passwordInput.value = ''; // æ¸…ç©ºå¯†ç 
        passwordInput.placeholder = 'è¯¥è´¦å·ç¼ºå°‘å¯†ç ï¼Œè¯·è¡¥å…¨';
      }

      // 2. ç¡®ä¿æŒ‰é’®ç»‘å®šçš„æ˜¯åŸå§‹çš„å…³é—­å’Œæäº¤å‡½æ•°
      // (åœ¨ DOMContentLoaded ä¸­å·²ç»ç»‘å®šäº†ï¼Œæ— éœ€é‡ç»‘)

      // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†
      $('multi-add-user-modal').style.display = 'flex';

      // 4. èšç„¦åˆ°å¯†ç æ¡†
      if (passwordInput) {
        passwordInput.focus();
      }
    }


    // é—®é¢˜3ä¿®å¤ï¼šä¸ºnewUserModalæ·»åŠ å‘é€éªŒè¯ç åŠŸèƒ½
    $('newUserSendCode').onclick = async function () {
      const phone = $('newUserPhone').value.trim();
      if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
      }

      const sendCodeBtn = $('newUserSendCode');
      sendCodeBtn.disabled = true;
      const originalText = sendCodeBtn.textContent;

      try {
        // ä¿®æ­£ï¼šä½¿ç”¨ fetch è°ƒç”¨ç‹¬ç«‹çš„ /api/sms/send_code æ¥å£
        const response = await fetch('/api/sms/send_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: phone,
            scene: 'register' // åœºæ™¯ï¼šç®¡ç†å‘˜æ·»åŠ æ–°ç”¨æˆ·
          })
        });
        const result = await response.json();

        if (result && result.success) {
          const expireMin = result.expire_minutes || 5;
          const retryAfter = result.retry_after || 180;
          showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

          // å€’è®¡æ—¶
          let countdown = retryAfter;
          const timer = setInterval(() => {
            countdown--;
            sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            if (countdown <= 0) {
              clearInterval(timer);
              sendCodeBtn.disabled = false;
              sendCodeBtn.textContent = originalText;
            }
          }, 1000);
        } else {
          // å¤„ç†é¢‘ç¹å‘é€é”™è¯¯
          if (result?.retry_after) {
            let countdown = result.retry_after;
            sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            const timer = setInterval(() => {
              countdown--;
              sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
              if (countdown <= 0) {
                clearInterval(timer);
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = originalText;
              }
            }, 1000);
          } else {
            sendCodeBtn.disabled = false;
          }
          showModalAlert(result?.message || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        sendCodeBtn.disabled = false;
        showModalAlert('å‘é€å¤±è´¥: ' + error.message);
      }
    };


    async function multi_addFromConfig() {
      const user = $('multi-config-user-select').value;
      if (!user) {
        // (æ–°) ä¿®æ­£ï¼šæ‰“å¼€ä¸“ç”¨çš„å¤šè´¦å·æ·»åŠ æ¨¡æ€æ¡†
        openMultiAddUserModal();
        // (æ³¨æ„ï¼šç¡®è®¤æŒ‰é’®çš„é€»è¾‘å·²ç§»è‡³ submitMultiAddUser å¹¶å…¨å±€ç»‘å®š)
        return;
      }
      // å·²æœ‰é…ç½®ç”¨æˆ· (æ­¤é€»è¾‘ä¸å˜)
      const result = await callPythonAPI('multi_add_account', user, "");

      // ä¿®æ­£ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å…¨å¯†ç 
      if (result && result.success === false && result.action === 'request_password') {
        showModalAlert(`è´¦å· ${result.username} ç¼ºå°‘å¯†ç ï¼Œè¯·åœ¨å¼¹çª—ä¸­è¡¥å…¨ã€‚`, 'ç¼ºå°‘å¯†ç ');
        openMultiAddUserModalForPassword(result.username, result.tag);
      }
      else if (result && result.accounts) {
        renderMultiAccountList(result.accounts);
      }
    }

    // (æ–°) å¤„ç†å¤šè´¦å·æ¨¡æ€æ¡†çš„ç¡®è®¤æŒ‰é’®ç‚¹å‡»
    async function submitMultiAddUser() {
      // ä¿®æ­£ï¼šåœ¨å‡½æ•°å¼€å§‹æ—¶è·å–è¾“å…¥æ¡† DOM å¼•ç”¨
      const inputUsername = $('multi-add-username');
      const inputPassword = $('multi-add-password');
      const inputTag = $('multi-add-tag');

      const usernameVal = inputUsername.value.trim();
      const passwordVal = inputPassword.value;
      const tagVal = inputTag.value.trim();

      // éªŒè¯
      if (!usernameVal || !passwordVal) {
        showModalAlert("è´¦å·å’Œå¯†ç å‡ä¸èƒ½ä¸ºç©º");
        return;
      }
      if (passwordVal.length < 6) {
        showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      setButtonLoading('multi-add-user-confirm', true, 'æ·»åŠ ä¸­...');

      try {
        // (æ–°) å¤šè´¦å·æ¨¡å¼ä¸‹ï¼Œè°ƒç”¨ 'multi_add_account'
        // å®ƒä¼šå¤„ç†åˆ›å»º/ä¿å­˜/åˆ·æ–°
        const result = await callPythonAPI(
          'multi_add_account',
          usernameVal, // ä½¿ç”¨å€¼
          passwordVal, // ä½¿ç”¨å€¼
          tagVal // ä½¿ç”¨å€¼
        );

        if (result && result.accounts) {
          showModalAlert('è´¦å·æ·»åŠ æˆåŠŸ', 'æˆåŠŸ');
          closeMultiAddUserModal(); // æˆåŠŸåå…³é—­ (è¿™ä¸ªå‡½æ•°ç°åœ¨ä¼šè‡ªåŠ¨æ¸…ç†åªè¯»çŠ¶æ€)
          renderMultiAccountList(result.accounts); // åˆ·æ–°åˆ—è¡¨
        } else {
          // æ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯
          showModalAlert(result?.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (e) {
        // æ•è· callPythonAPI å¯èƒ½æŠ›å‡ºçš„ç½‘ç»œé”™è¯¯
        showModalAlert(`æ·»åŠ æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`);
        logMessage_Error("æ·»åŠ æ–°è´¦å·æ—¶å‘ç”Ÿé”™è¯¯:", e);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        setButtonLoading('multi-add-user-confirm', false, 'ç¡®è®¤æ·»åŠ ');

        // ä¿®æ­£ï¼šå¦‚æœæäº¤å¤±è´¥ï¼Œæ¨¡æ€æ¡†æœªå…³é—­ï¼Œä¹Ÿéœ€è¦æ¸…ç†åªè¯»çŠ¶æ€
        // (å¦‚æœæˆåŠŸï¼ŒcloseMultiAddUserModal å·²ç»æ¸…ç†äº†)
        if (inputUsername && inputUsername.readOnly) {
          inputUsername.readOnly = false;
          inputUsername.classList.remove('bg-slate-100', 'cursor-not-allowed');
          $('multi-add-password').placeholder = 'è¯·è¾“å…¥å¯†ç  (è‡³å°‘6å­—ç¬¦)';
        }
      }
    }

    async function multi_importFromExcel() {
      // [BUG ä¿®å¤] åç«¯ open_file_dialog åœ¨ Web æ¨¡å¼ä¸‹æ— æ•ˆ (main.py L3605)ã€‚
      // å¿…é¡»ç”±å‰ç«¯åˆ›å»ºæ–‡ä»¶è¾“å…¥æ¡†æ¥è¯»å–æ–‡ä»¶ã€‚

      const input = document.createElement('input');
      input.type = 'file';
      // é™åˆ¶æ–‡ä»¶ç±»å‹ä¸º Excel å’Œ CSV
      input.accept = '.xlsx, .xls, .csv';

      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) {
          logMessage_Info("æœªé€‰æ‹©æ–‡ä»¶ã€‚");
          return;
        }

        // éªŒè¯æ–‡ä»¶æ‰©å±•å
        const fileName = file.name;
        const fileExt = fileName.split('.').pop().toLowerCase();
        if (!['xlsx', 'xls', 'csv'].includes(fileExt)) {
          showModalAlert("æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œè¯·é€‰æ‹© .xlsx, .xls, æˆ– .csv æ–‡ä»¶ã€‚");
          return;
        }

        logMessage_Info(`æ­£åœ¨è¯»å–æ–‡ä»¶: ${fileName}`);

        // æˆ‘ä»¬å°†æ–‡ä»¶å†…å®¹ä½œä¸º Base64 å­—ç¬¦ä¸²å‘é€åˆ°åç«¯
        // è¿™æ˜¯å¤„ç†äºŒè¿›åˆ¶ (xls/xlsx) å’Œæ–‡æœ¬ (csv) æ–‡ä»¶çš„æœ€å¯é æ–¹æ³•
        const reader = new FileReader();
        reader.readAsDataURL(file); // è¯»å–ä¸º Data URL (åŒ…å«äº† Base64)

        reader.onload = async () => {
          try {
            // reader.result æ ¼å¼ä¸º "data:application/vnd.ms-excel;base64,UEsD..."
            // æˆ‘ä»¬éœ€è¦å»æ‰ "data:..."
            const base64Content = reader.result.split(',')[1];

            // è°ƒç”¨ä¸€ä¸ª[æ–°]çš„APIï¼Œå°†æ–‡ä»¶åå’ŒBase64å†…å®¹å‘é€åˆ°åç«¯
            const result = await callPythonAPI('multi_import_accounts', fileName, base64Content);

            if (result && result.success) {
              logMessage_Info(`æˆåŠŸå¯¼å…¥ ${result.imported_count || 0} ä¸ªè´¦å·ã€‚`);
              if (result.skipped_count > 0) {
                // å¦‚æœæœ‰è·³è¿‡çš„ï¼ˆä¾‹å¦‚ç¼ºå¯†ç ï¼‰ï¼Œæ˜¾ç¤ºåç«¯è¿”å›çš„æç¤ºä¿¡æ¯
                showModalAlert(`å¯¼å…¥å®Œæˆï¼š\næˆåŠŸ ${result.imported_count} ä¸ªã€‚\nè·³è¿‡ ${result.skipped_count} ä¸ªï¼ˆç¼ºå°‘å¯†ç ï¼‰ã€‚\n\nè¯¦æƒ…ï¼š${result.message}`, "å¯¼å…¥æç¤º");
              }
              // åˆ·æ–°è´¦å·åˆ—è¡¨
              if (result.accounts) {
                renderMultiAccountList(result.accounts);
              }
            } else {
              showModalAlert(`å¯¼å…¥å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
          } catch (err) {
            logMessage_Error("å¯¼å…¥æ–‡ä»¶æ—¶å‡ºé”™:", err);
            showModalAlert(`å¯¼å…¥å¤±è´¥: ${err.message}`);
          }
        };

        reader.onerror = () => {
          logMessage_Error("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
          showModalAlert("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
        };
      };

      // è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
      input.click();
    }

    async function multi_exportToExcel() {
      const result = await callPythonAPI('multi_export_accounts_summary');
      if (!result || !result.success) {
        showModalAlert(result?.message || 'å¯¼å‡ºå¤±è´¥');
        return;
      }

      // Webæ¨¡å¼ï¼šä»è¿”å›çš„base64å†…å®¹åˆ›å»ºä¸‹è½½
      if (result.content && result.filename) {
        const binaryString = atob(result.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: result.mimetype || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage_Info(`æ±‡æ€»å·²å¯¼å‡ºï¼š${result.filename}`);
      }
    }

    async function multi_startAll() {


      // è‹¥å½“å‰åˆ—è¡¨ä¸ºç©º
      const count = parseInt($('multi-account-count').textContent || '0', 10);
      if (!count || count <= 0) {
        showModalAlert('è´¦å·åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹ã€‚è¯·å…ˆæ·»åŠ è´¦å·ã€‚');

        return;
      }


      const use_delay = $('multi-use-delay-check').checked;
      const min_delay = parseInt($('multi-min-delay-input').value) || 0;
      const max_delay = parseInt($('multi-max-delay-input').value) || 300;
      const run_only_incomplete = $('multi-run-only-incomplete-check').checked;

      const result = await callPythonAPI('multi_start_all_accounts', min_delay, max_delay, use_delay, run_only_incomplete);
      // å¤±è´¥æ—¶å›æ»šæŒ‰é’®çŠ¶æ€å¹¶æç¤º
      if (!result || !result.success) {
        showModalAlert(result?.message || 'æ— æ³•å¼€å§‹å…¨éƒ¨è´¦å·ä»»åŠ¡ã€‚');

        return;
      }
    }


    async function multi_stopAll() {
      await callPythonAPI('multi_stop_all_accounts');

    }

    // åç«¯ä¸»åŠ¨æ¨é€æ—¶ä½¿ç”¨çš„åˆ·æ–°å…¥å£
    function onAccountsUpdated(accounts) {
      try {
        renderMultiAccountList(accounts);
      } catch (e) {
        logMessage_Error("onAccountsUpdated render failed:", e);
      }
    }

    /**
     * ä»»åŠ¡17ä¿®å¤ï¼šè®¡ç®—è´¦æˆ·çš„çŠ¶æ€æ–‡æœ¬ï¼ˆstatus_textï¼‰
     * æ ¹æ®only_incompleteå’Œignore_task_timeå‚æ•°ï¼Œè®¡ç®—å¯æ‰§è¡Œä»»åŠ¡æ•°é‡
     * @param {Object} account - è´¦æˆ·å¯¹è±¡ï¼ŒåŒ…å«tasksæ•°ç»„
     * @param {boolean} onlyIncomplete - æ˜¯å¦åªç»Ÿè®¡æœªå®Œæˆä»»åŠ¡
     * @param {boolean} ignoreTaskTime - æ˜¯å¦å¿½ç•¥ä»»åŠ¡æ—¶é—´é™åˆ¶ï¼ˆåªæ¯”å¯¹æ—¥æœŸï¼‰
     * @returns {string} çŠ¶æ€æ–‡æœ¬ï¼Œå¦‚"æœ‰3ä¸ªä»»åŠ¡å¯æ‰§è¡Œ"æˆ–"æ— ä»»åŠ¡å¯æ‰§è¡Œ"
     */
    function calculateStatusText(account, onlyIncomplete = false, ignoreTaskTime = false) {
      if (!account || !account.tasks || !Array.isArray(account.tasks)) {
        return 'æ— ä»»åŠ¡æ•°æ®';
      }

      let executableCount = 0;
      const now = new Date();

      account.tasks.forEach(task => {
        // é—®é¢˜17ä¿®å¤ï¼šå¦‚æœonly_incomplete=trueï¼Œè·³è¿‡å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆstatus=1ï¼‰
        if (onlyIncomplete && task.status === 1) {
          return;
        }

        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²è¿‡æœŸ
        const isExpired = task.info_text === 'å·²è¿‡æœŸ';
        if (isExpired) {
          return; // è¿‡æœŸä»»åŠ¡ä¸å¯æ‰§è¡Œ
        }

        // é—®é¢˜17ä¿®å¤ï¼šæ ¹æ®ignore_task_timeå‚æ•°å†³å®šå¦‚ä½•æ£€æŸ¥æ—¶é—´
        if (task.start_time && task.end_time) {
          const startTime = new Date(task.start_time);
          const endTime = new Date(task.end_time);

          if (ignoreTaskTime) {
            // å¦‚æœignoreTaskTime=trueï¼Œåªæ¯”å¯¹æ—¥æœŸï¼Œå¿½ç•¥å…·ä½“æ—¶é—´
            const nowDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startDate = new Date(startTime.getFullYear(), startTime.getMonth(), startTime.getDate());
            const endDate = new Date(endTime.getFullYear(), endTime.getMonth(), endTime.getDate());

            if (nowDate < startDate || nowDate > endDate) {
              return; // ä¸åœ¨æ—¥æœŸèŒƒå›´å†…
            }
          } else {
            // å¦‚æœignoreTaskTime=falseï¼Œæ¯”å¯¹å®Œæ•´çš„æ—¥æœŸå’Œæ—¶é—´
            if (now < startTime || now > endTime) {
              return; // ä¸åœ¨æ—¶é—´çª—å£å†…
            }
          }
        }

        // æ»¡è¶³æ¡ä»¶ï¼Œè®¡å…¥å¯æ‰§è¡Œä»»åŠ¡
        executableCount++;
      });

      // è¿”å›çŠ¶æ€æ–‡æœ¬
      if (executableCount === 0) {
        return 'æ— ä»»åŠ¡å¯æ‰§è¡Œ';
      } else {
        return `æœ‰${executableCount}ä¸ªä»»åŠ¡å¯æ‰§è¡Œ`;
      }
    }

    function renderMultiAccountList(accounts) {
      const listDiv = $('multi-account-list');
      listDiv.innerHTML = '';
      $('multi-account-count').textContent = accounts.length;
      if (accounts.length === 0) {
        listDiv.innerHTML = '<p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>';
        return;
      }

      accounts.forEach(acc => {
        const s = acc.summary;
        const item = document.createElement('div');
        item.id = `multi-acc-${acc.username}`;
        item.dataset.username = acc.username;
        item.className = 'p-3 rounded-xl border border-slate-200 bg-white/80 mb-2 text-sm';
        item.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="font-bold text-slate-800 flex items-start gap-2 truncate min-w-0">
                    <input type="checkbox" class="account-checkbox w-4 h-4 accent-sky-600 rounded flex-shrink-0 mt-1">
                    <div class="truncate">
                        <span class="account-name truncate">${acc.name}</span>
                        <span class="text-xs text-slate-500 font-normal block">(${acc.username})</span>
                        ${acc.tag ? `<span class="text-xs text-purple-600 font-medium block">ğŸ·ï¸ ${acc.tag}</span>` : ''}
                    </div>
                </div>
                <span class="status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap" id="MultiAccount_status_text">${acc.status_text}</span>
            </div>


            <div class="grid grid-cols-5 gap-2 text-center text-xs mt-2 pt-2 border-t text-slate-600">
                <div>æ€»æ•°: <span class="summary-total font-bold">${s.total}</span></div>
                <div>å®Œæˆ: <span class="summary-completed font-bold text-emerald-600">${s.completed}</span></div>
                <div>æœªå¼€å§‹: <span class="summary-notstarted font-bold text-slate-600">${s.not_started}</span></div>
                <div>å¯è·‘: <span class="summary-executable font-bold text-amber-600">${s.executable}</span></div>
                <div>è¿‡æœŸ: <span class="summary-expired font-bold text-red-600">${s.expired}</span></div>
            </div>

            <div class="grid grid-cols-3 gap-2 text-center text-xs mt-2 pt-2 border-t border-slate-100 text-slate-600">
                <div title="å¾…ç­¾åˆ°ä»»åŠ¡">å¾…ç­¾: <span class="summary-att-pending font-bold text-sky-600">${s.att_pending || 0}</span></div>
                <div title="å·²ç­¾åˆ°ä»»åŠ¡">å·²ç­¾: <span class="summary-att-completed font-bold text-emerald-600">${s.att_completed || 0}</span></div>
                <div title="å·²è¿‡æœŸç­¾åˆ°">è¿‡æœŸ: <span class="summary-att-expired font-bold text-red-600">${s.att_expired || 0}</span></div>
            </div>

            <div class="flex justify-end items-center gap-2 mt-2 pt-2 border-t">
                <button class="btn-account-refresh btn btn-ghost !py-1 !px-3 !text-xs" data-username="${acc.username}">åˆ·æ–°</button>
                <button class="btn-account-start btn btn-success !py-1 !px-3 !text-xs" data-username="${acc.username}">å¼€å§‹</button>
                <button class="btn-account-stop btn btn-warning !py-1 !px-3 !text-xs" data-username="${acc.username}">åœæ­¢</button>
                <button class="btn-account-params btn btn-ghost !py-1 !px-3 !text-xs" data-username="${acc.username}">è®¾ç½®</button>
            </div>
            <!-- è¿›åº¦æ¡å— -->
            <div class="mt-2">
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div class="progress-fill h-2 bg-sky-500" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span class="progress-text text-slate-600">æœªå¼€å§‹</span>
                    <span class="progress-extra text-slate-400"></span>
                </div>
            </div>
            `;
        listDiv.appendChild(item);
      });
      // ä¸ºæ–°åˆ›å»ºçš„DOMå…ƒç´ é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨

      document.querySelectorAll('.btn-account-start').forEach(b => b.onclick = (e) => {
        const runOnly = document.getElementById('multi-run-only-incomplete-check')?.checked ?? true;
        callPythonAPI('multi_start_single_account', e.target.dataset.username, runOnly);
      });
      document.getElementById('multi-run-only-incomplete-check').addEventListener('change', async (e) => {
        // å…ˆå‘Šè¯‰åç«¯å½“å‰çš„å¼€å…³çŠ¶æ€
        await callPythonAPI('set_multi_run_only_incomplete', e.target.checked);
        // å†è§¦å‘ä¸€æ¬¡â€œåˆ·æ–°å…¨éƒ¨â€ï¼Œè®©æ‘˜è¦ä¸æŒ‰é’®ç«‹åˆ»ä¸€è‡´
        await callPythonAPI('multi_refresh_all_statuses');
      });



      document.querySelectorAll('.btn-account-stop').forEach(b => b.onclick = (e) => callPythonAPI('multi_stop_single_account', e.target.dataset.username));
      document.querySelectorAll('.btn-account-params').forEach(b => b.onclick = (e) => openAccountParamsModal(e.target.dataset.username));
      updateSelectAllCheckboxState();
      // const startAllBtn = $('multi-start-all-btn');
      // const stopAllBtn = $('multi-stop-all-btn');
      // if (startAllBtn) startAllBtn.disabled = false;
      // if (stopAllBtn) stopAllBtn.disabled = true;
      document.querySelectorAll('.btn-account-refresh').forEach(b => {
        b.onclick = async (e) => {
          const u = e.currentTarget.dataset.username;
          // ç«‹åˆ»åšè½»é‡UIåé¦ˆï¼ˆå¯é€‰ï¼‰
          const item = document.getElementById(`multi-acc-${u}`);
          if (item) {
            const statusEl = item.querySelector('.status-text');
            if (statusEl) statusEl.textContent = 'åˆ·æ–°ä¸­...';
          }
          const result = await callPythonAPI('multi_refresh_single_status', u);
          if (!result || !result.success) {
            showModalAlert(result?.message || 'åˆ·æ–°å¤±è´¥');
          }
        };
      });

    }

    // --- æ–°çš„JSå‡½æ•° ---
    function multi_toggleSelectAll(event) {
      const isChecked = event.target.checked;
      document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = isChecked);
    }

    function updateSelectAllCheckboxState() {
      const allCheckboxes = document.querySelectorAll('.account-checkbox');
      const checkedCount = document.querySelectorAll('.account-checkbox:checked').length;
      const selectAllCheckbox = $('multi-select-all-check');
      if (allCheckboxes.length > 0) {
        selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    $('multi-account-list').addEventListener('change', (event) => { if (event.target.classList.contains('account-checkbox')) { updateSelectAllCheckboxState(); } });

    async function multi_removeAll() {
      const confirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', 'ç¡®å®šè¦ç§»é™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
      if (confirmed) {
        const result = await callPythonAPI('multi_remove_all_accounts');
        if (result && result.accounts) renderMultiAccountList(result.accounts);
      }
    }

    async function multi_removeSelected() {
      const selectedUsernames = Array.from(document.querySelectorAll('.account-checkbox:checked')).map(cb => cb.closest('[data-username]').dataset.username);
      if (selectedUsernames.length === 0) { showModalAlert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ç§»é™¤çš„è´¦å·ã€‚"); return; }
      const confirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', `ç¡®å®šè¦ç§»é™¤é€‰ä¸­çš„ ${selectedUsernames.length} ä¸ªè´¦å·å—ï¼Ÿ`);
      if (confirmed) {
        const result = await callPythonAPI('multi_remove_selected_accounts', selectedUsernames);
        if (result && result.accounts) renderMultiAccountList(result.accounts);
      }
    }

    function multi_getSelectedUsernames() {
      return Array.from(document.querySelectorAll('.account-checkbox:checked'))
        .map(cb => cb.closest('[data-username]')?.dataset?.username)
        .filter(Boolean);
    }

    async function multi_startSelected() {
      const usernames = multi_getSelectedUsernames();
      if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œå¼€å§‹é€‰ä¸­â€ã€‚');
        return;
      }
      // ä»å·¥å…·æ å‹¾é€‰é¡¹è¯»å–è¿è¡Œç­–ç•¥ï¼ˆä¸â€œå…¨éƒ¨å¼€å§‹â€ä¸€è‡´ï¼‰
      const use_delay = $('multi-use-delay-check')?.checked ?? true;
      const min_delay = parseInt($('multi-min-delay-input')?.value) || 0;
      const max_delay = parseInt($('multi-max-delay-input')?.value) || 300;
      const run_only_incomplete = $('multi-run-only-incomplete-check')?.checked ?? true;

      // é€ä¸ªè°ƒç”¨åç«¯â€œå•è´¦å·å¼€å§‹â€
      for (const u of usernames) {
        try {
          // å¯é€‰ï¼šè¿™é‡Œå¯ä»¥å®ç°ç®€å•çš„éšæœºå»¶è¿Ÿï¼Œé¿å…ç¬å‘å…¨éƒ¨
          if (use_delay && max_delay >= min_delay) {
            const d = Math.random() * (max_delay - min_delay) + min_delay;
            // è½»é‡å»¶è¿Ÿï¼Œä¸é˜»å¡ UI
            await new Promise(res => setTimeout(res, d * 10)); // ç¼©çŸ­ä¸€ä¸ªæ•°é‡çº§ï¼Œé¿å…è¿‡é•¿ç­‰å¾…
          }
          await callPythonAPI('multi_start_single_account', u, run_only_incomplete);
        } catch (e) {
          logMessage_Error(`å¼€å§‹è´¦å· ${u} å¤±è´¥`, e);
        }
      }
    }

    async function multi_stopSelected() {
      const usernames = multi_getSelectedUsernames();
      if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œåœæ­¢é€‰ä¸­â€ã€‚');
        return;
      }
      for (const u of usernames) {
        try {
          await callPythonAPI('multi_stop_single_account', u);
        } catch (e) {
          logMessage_Error(`åœæ­¢è´¦å· ${u} å¤±è´¥`, e);
        }
      }
    }

    async function multi_refreshSelected() {
      const usernames = multi_getSelectedUsernames();
      if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œåˆ·æ–°é€‰ä¸­â€ã€‚');
        return;
      }
      for (const u of usernames) {
        try {
          // è½»é‡ UI æç¤ºï¼ˆéå¿…éœ€ï¼‰
          const item = document.getElementById(`multi-acc-${u}`);
          if (item) {
            const statusEl = item.querySelector('.status-text');
            if (statusEl) statusEl.textContent = 'åˆ·æ–°ä¸­...';
          }
          await callPythonAPI('multi_refresh_single_status', u);
        } catch (e) {
          logMessage_Error(`åˆ·æ–°è´¦å· ${u} å¤±è´¥`, e);
        }
      }
    }


    async function multi_refreshAll() { await callPythonAPI('multi_refresh_all_statuses'); }

    async function process_path_queue() {
      if (is_planning_path || path_planning_queue.length === 0) return;
      is_planning_path = true;
      const { username, waypoints } = path_planning_queue.shift();
      try {
        logMessage_Info(`[JS-Queue] å¼€å§‹å¤„ç† ${username} çš„è·¯å¾„è§„åˆ’...`);
        const path = await getWalkingPath(waypoints);
        logMessage_Info(`[JS-Queue] è·¯å¾„è§„åˆ’æˆåŠŸ for ${username}, è¿”å› ${path.length} ç‚¹ç»™Pythonã€‚`);
        callPythonAPI('multi_path_generation_callback', username, true, path);
      } catch (error) {
        logMessage_Info(`[JS-Queue] è·¯å¾„è§„åˆ’å¤±è´¥ for ${username}: ${error}`);
        callPythonAPI('multi_path_generation_callback', username, false, String(error));
      } finally {
        is_planning_path = false;
        setTimeout(process_path_queue, 100);
      }
    }
    function triggerPathGenerationForPy(username, waypoints) {
      logMessage_Info(`æ”¶åˆ° ${username} çš„è·¯å¾„è§„åˆ’è¯·æ±‚ï¼Œå·²åŠ å…¥é˜Ÿåˆ—ã€‚`);
      path_planning_queue.push({ username, waypoints });
      process_path_queue();
    }


    function multi_updateAccountStatus(username, data) {
      const item = $(`multi-acc-${username}`);
      if (!item) return;

      // 1. æ–‡æ¡ˆä¸æ‘˜è¦çš„å¸¸è§„æ›´æ–°
      if (data.status_text) {
        item.querySelector('.status-text').textContent = data.status_text;
      }
      if (data.name) {
        item.querySelector('.account-name').textContent = data.name;
      }


      if (data.summary) {
        const s = data.summary;
        item.querySelector('.summary-total').textContent = s.total;
        item.querySelector('.summary-completed').textContent = s.completed;
        const ns = item.querySelector('.summary-notstarted');
        if (ns) ns.textContent = (s.not_started ?? 0);
        item.querySelector('.summary-executable').textContent = s.executable;
        item.querySelector('.summary-expired').textContent = s.expired;

        // æ›´æ–°ç­¾åˆ°ç»Ÿè®¡
        const att_pending = item.querySelector('.summary-att-pending');
        const att_completed = item.querySelector('.summary-att-completed');
        const att_expired = item.querySelector('.summary-att-expired');
        if (att_pending) att_pending.textContent = s.att_pending || 0;
        if (att_completed) att_completed.textContent = s.att_completed || 0;
        if (att_expired) att_expired.textContent = s.att_expired || 0;


      }






      // 2. è¿›åº¦æ¡ä¸é™„åŠ æ–‡æœ¬çš„æ›´æ–°
      if (typeof data.progress_pct === 'number') {
        const fill = item.querySelector('.progress-fill');
        if (fill) fill.style.width = `${Math.max(0, Math.min(100, data.progress_pct))}%`;
      }
      if (typeof data.progress_text === 'string') {
        const label = item.querySelector('.progress-text');
        if (label) label.textContent = data.progress_text;
      }
      if (typeof data.progress_extra === 'string') {
        const extra = item.querySelector('.progress-extra');
        if (extra) extra.textContent = data.progress_extra;
      }

      // 3. çŠ¶æ€é©±åŠ¨çš„æ ‡è®°æ¸…ç†é€»è¾‘ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
      // å–æœ€æ–°çŠ¶æ€æ–‡æœ¬ï¼ˆdata.status_text è‹¥æœªæä¾›åˆ™è¯»å–å½“å‰DOMï¼‰
      const currentStatus =
        (typeof data.status_text === 'string' && data.status_text.trim())
          ? data.status_text.trim()
          : (item.querySelector('.status-text')?.textContent?.trim() || '');

      // å®šä¹‰â€œéè¿è¡Œæ€â€é›†åˆï¼šåˆ°è¾¾è¿™äº›çŠ¶æ€åä¸å†åº”ä¿ç•™åœ°å›¾æ ‡è®°
      const NON_RUNNING_STATUSES = new Set([
        'ä»»åŠ¡å·²å®Œæˆ',
        'å…¨éƒ¨å®Œæˆ',
        'æ— ä»»åŠ¡å¯æ‰§è¡Œ',
        'æ— å¯æ‰§è¡Œä»»åŠ¡',  // ä»»åŠ¡25: no_tasks_runçŠ¶æ€ï¼ˆæ‰€æœ‰ä»»åŠ¡å› æ— æ‰“å¡ç‚¹è·³è¿‡ï¼‰
        'å·²åœæ­¢',
        'å·²ä¸­æ­¢',
        'å¾…å‘½'
      ]);

      // è‹¥è¿›å…¥éè¿è¡ŒçŠ¶æ€ï¼Œåˆ™ç§»é™¤è¯¥è´¦å·çš„åœ°å›¾æ ‡è®°
      if (NON_RUNNING_STATUSES.has(currentStatus)) {
        multi_removeRunnerMarker(username);
        return; // å·²æ¸…ç†ï¼Œæ— éœ€è¿›ä¸€æ­¥åˆ¤æ–­
      }

      // æ‘˜è¦ä¹Ÿå¯è¾…åŠ©åˆ¤æ–­ï¼šå½“ s.executable == 0 ä¸”çŠ¶æ€æ–‡æœ¬ä¸æ˜¯æ˜æ˜¾è¿è¡Œæ€ï¼Œä¹Ÿæ¸…ç†ä¸€æ¬¡ï¼ˆä¿é™©ï¼‰
      const s = data.summary;
      if (s && typeof s.executable === 'number' && s.executable <= 0) {
        // å¦‚æœæ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡ä¸”ä¸æ˜¯â€œç™»å½•ä¸­/åˆ†æä»»åŠ¡/è¿è¡Œä¸­/ç­‰å¾…ä¸­â€ï¼Œåˆ™ç§»é™¤
        const maybeRunning = ['ç™»å½•ä¸­...', 'åˆ†æä»»åŠ¡', 'è¿è¡Œ', 'ç­‰å¾…', 'æ’é˜Ÿç™»å½•...', 'å»¶è¿Ÿ'];
        const isLikelyRunning = maybeRunning.some(k => currentStatus.includes(k));
        if (!isLikelyRunning) {
          multi_removeRunnerMarker(username);
        }
      }
    }


    function multi_updateRunnerPosition(username, lon, lat, name) {
      if (!multiAccountMap) return;
      const pos = new AMapInstance.LngLat(lon, lat);
      if (multiAccountMarkers[username]) {
        multiAccountMarkers[username].setPosition(pos);
      } else {
        const color = userColors[colorIndex++ % userColors.length];
        const markerContent = `<div style="background-color: ${color};" class="text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg text-white">${name}</div>`;
        multiAccountMarkers[username] = new AMapInstance.Marker({
          position: pos, content: markerContent, anchor: 'bottom-center',
          zIndex: 110, title: `${name} (${username})`
        });
        multiAccountMap.add(multiAccountMarkers[username]);
      }
      multi_resetMapView();
    }

    function multi_removeRunnerMarker(username) {
      const marker = multiAccountMarkers[username];
      if (marker && multiAccountMap) {
        multiAccountMap.remove(marker);
      }
      delete multiAccountMarkers[username];
      // ç§»é™¤åæ ¹æ®å½“å‰å‰©ä½™æ ‡è®°ç»Ÿä¸€è§†è§’
      multi_resetMapView();
    }


    function multi_resetMapView() {
      if (!multiAccountMap) return;
      const overlays = Object.values(multiAccountMarkers).filter(m => m.getMap());
      if (overlays.length > 0) {
        multiAccountMap.setFitView(overlays, false, [80, 80, 80, 80]);
      } else {
        multiAccountMap.setZoomAndCenter(17, [113.390342, 22.527403]);
      }
    }


    function selectTaskFromBackend(index) { if (selectedTaskIndex !== index) selectTask(index); }

    function updateDashboard() {
      if (!currentRunData || Object.keys(currentRunData).length === 0) {
        $('run-stats-label').textContent = `-- km / --:--`;
        $('live-dist-label').textContent = '0.00 km';
        $('total-dist-label').textContent = '0.00 km';
        $('live-time-label').textContent = '00:00';
        $('total-time-label').textContent = '00:00';
        $('target-points-text').innerHTML = '<p class="text-slate-400 text-center text-xs pt-4">è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡</p>';
        $('current-location-label').textContent = 'å½“å‰ä½ç½®GPSåæ ‡: --, --';
        return;
      }
      const isDrawingNow = isDrawing && !currentRunData.run_coords?.length;
      if (isDrawingNow && draftTotalDist > 0) {
        const drawKm = (draftTotalDist / 1000).toFixed(2);
        const avgSpeed = pythonParams.speed_mps || 1.5;
        const estMin = avgSpeed > 0 ? (draftTotalDist / avgSpeed) / 60 : 0;
        $('run-stats-block').innerHTML = `<p class="text-sm text-slate-500">å½“å‰ç»˜åˆ¶</p><p class="font-bold text-2xl text-emerald-600">${drawKm} km / ~${estMin.toFixed(1)} min</p>`;
      } else {
        const dist = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
        const timeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
        const timeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
        $('run-stats-block').innerHTML = `<p class="text-sm text-slate-500">å·²é€‰ä»»åŠ¡æ€»è§ˆ</p><p id="run-stats-label" class="font-bold text-2xl text-sky-600">${dist} km / ${String(timeMin).padStart(2, '0')}:${String(timeSec).padStart(2, '0')}</p>`;
      }
      const liveKm = ((currentRunData.distance_covered_m || 0) / 1000).toFixed(2);
      const liveMs = runAccumulatedMs || 0;
      const mm = String(Math.floor(liveMs / 60000)).padStart(2, '0');
      const ss = String(Math.floor((liveMs % 60000) / 1000)).padStart(2, '0');
      $('live-dist-label').textContent = `${liveKm} km`;
      $('live-time-label').textContent = `${mm}:${ss}`;

      const totalDistKm = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
      $('total-dist-label').textContent = `${totalDistKm} km`;
      const totalTimeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
      const totalTimeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
      $('total-time-label').textContent = `${String(totalTimeMin).padStart(2, '0')}:${String(totalTimeSec).padStart(2, '0')}`;

      const targetDiv = $('target-points-text');
      targetDiv.innerHTML = "";
      const names = (currentRunData.target_point_names || "").split('|');
      const sequence = currentRunData.target_sequence || 0;
      if (names.length === 0 || (names.length === 1 && names[0] === '')) {
        targetDiv.innerHTML = '<p class="text-slate-400 text-center text-xs pt-4">æ­¤ä»»åŠ¡æ— æ‰“å¡ç‚¹</p>';
      } else {
        names.forEach((name, i) => {
          if (!name) return;
          const p = document.createElement('p');
          let textClass = 'text-slate-500';
          if (sequence > 0) {
            if (i + 1 < sequence) textClass = 'text-slate-400 line-through';
            else if (i + 1 === sequence) textClass = 'font-bold text-sky-600';
          }
          p.className = `transition-colors p-1 rounded ${textClass}`;
          p.innerHTML = `<span class="font-mono w-6 inline-block">${i + 1}.</span>${name}`;
          targetDiv.appendChild(p);
        });
        centerTargetList(sequence);
      }
    }
    function centerTargetList(sequence) {
      const targetDiv = $('target-points-text');
      if (!targetDiv || !targetDiv.children || targetDiv.children.length === 0) return;
      const idx = Math.max(0, Math.min(targetDiv.children.length - 1, (sequence || 1) - 1));
      const child = targetDiv.children[idx];
      if (child && typeof child.scrollIntoView === 'function') {
        try { child.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) { }
      }
    }
    function resetMapView() {
      if (!map) return;
      const overlays = [...polylines.recommended, ...markers];
      if (polylines.draft) overlays.push(polylines.draft);
      if (polylines.run) overlays.push(polylines.run);
      if (polylines.history) overlays.push(polylines.history);

      if (overlays.length > 0) {
        map.setFitView(overlays, false, [60, 60, 60, 60]);
      } else if (currentRunData && currentRunData.target_points?.length > 0) {
        const targetLngLats = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        map.setFitView(targetLngLats, false, [60, 60, 60, 60]);
      } else {
        map.setZoomAndCenter(17, [113.390342, 22.527403]);
      }
    }

    // åœ¨æ ‡è®°ç»˜åˆ¶ååšä¸€æ¬¡â€œç¡¬åˆ·æ–°â€ï¼Œæ¨¡æ‹Ÿå½•åˆ¶æŒ‰é’®å¸¦æ¥çš„ç¨³å®šæŠ•å½±é‡å»º
    function forceProjectionRefresh() {
      if (!map) return;
      try {
        // 1) å…ˆä¸´æ—¶å…³é—­æ‹–æ‹½ä»¥è§¦å‘å†…éƒ¨äº¤äº’å±‚çŠ¶æ€å˜æ›´ï¼ˆè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼‰
        map.setStatus({ dragEnable: false });

        // 2) åšä¸€æ¬¡å°ºå¯¸åˆ·æ–°
        map.resize();

        // 3) ä¸‹ä¸€å¸§è¿›è¡Œè§†è§’æ‹Ÿåˆï¼ˆè¦†ç›–ç‰©æˆ–æ‰“å¡ç‚¹ä¼˜å…ˆï¼‰
        requestAnimationFrame(() => {
          const overlays = [...polylines.recommended];
          if (polylines.draft) overlays.push(polylines.draft);
          if (polylines.run) overlays.push(polylines.run);
          if (polylines.history) overlays.push(polylines.history);

          // ä¼˜å…ˆç”¨è¦†ç›–ç‰© fitï¼›æ²¡æœ‰è¦†ç›–ç‰©æ—¶ï¼Œç”¨æ‰“å¡ç‚¹ï¼›éƒ½æ²¡æœ‰æ—¶å›åˆ°é»˜è®¤è§†è§’
          if (overlays.length > 0) {
            map.setFitView(overlays, false, [60, 60, 60, 60]);
          } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
            const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
            map.setFitView(pts, false, [60, 60, 60, 60]);
          } else {
            map.setZoomAndCenter(17, [113.390342, 22.527403]);
          }

          // 4) æ¢å¤æ‹–æ‹½ï¼ˆå½•åˆ¶æŒ‰é’®çš„è¡Œä¸ºä¹Ÿæ˜¯è¿™ä¸€å¥—ï¼‰
          map.setStatus({ dragEnable: true });
        });
      } catch (e) {
        logMessage_Warning('forceProjectionRefresh warning:', e);
      }
    }


    // åœ¨æ ‡è®°ç»˜åˆ¶ååšä¸€æ¬¡â€œç¡¬åˆ·æ–°â€ï¼Œæ¨¡æ‹Ÿå½•åˆ¶æŒ‰é’®å¸¦æ¥çš„ç¨³å®šæŠ•å½±é‡å»º
    function forceProjectionRefresh() {
      if (!map) return;
      try {
        // 1) å…ˆä¸´æ—¶å…³é—­æ‹–æ‹½ä»¥è§¦å‘å†…éƒ¨äº¤äº’å±‚çŠ¶æ€å˜æ›´ï¼ˆè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼‰
        map.setStatus({ dragEnable: false });

        // 2) åšä¸€æ¬¡å°ºå¯¸åˆ·æ–°
        map.resize();

        // 3) ä¸‹ä¸€å¸§è¿›è¡Œè§†è§’æ‹Ÿåˆï¼ˆè¦†ç›–ç‰©æˆ–æ‰“å¡ç‚¹ä¼˜å…ˆï¼‰
        requestAnimationFrame(() => {
          const overlays = [...polylines.recommended];
          if (polylines.draft) overlays.push(polylines.draft);
          if (polylines.run) overlays.push(polylines.run);
          if (polylines.history) overlays.push(polylines.history);

          // ä¼˜å…ˆç”¨è¦†ç›–ç‰© fitï¼›æ²¡æœ‰è¦†ç›–ç‰©æ—¶ï¼Œç”¨æ‰“å¡ç‚¹ï¼›éƒ½æ²¡æœ‰æ—¶å›åˆ°é»˜è®¤è§†è§’
          if (overlays.length > 0) {
            map.setFitView(overlays, false, [60, 60, 60, 60]);
          } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
            const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
            map.setFitView(pts, false, [60, 60, 60, 60]);
          } else {
            map.setZoomAndCenter(17, [113.390342, 22.527403]);
          }

          // 4) æ¢å¤æ‹–æ‹½ï¼ˆå½•åˆ¶æŒ‰é’®çš„è¡Œä¸ºä¹Ÿæ˜¯è¿™ä¸€å¥—ï¼‰
          map.setStatus({ dragEnable: true });
        });
      } catch (e) {
        logMessage_Warning('forceProjectionRefresh warning:', e);
      }
    }




    // åœ°å›¾ç»˜åˆ¶ç›¸å…³
    function drawOnMap_signature() {
      if (!map) return;
      clearMapOverlays();
      const data = currentRunData;
      if (!data) return;

      if (data.recommended_coords?.length > 0) {
        let segment = [];
        data.recommended_coords.forEach(p => {
          if (p[0] === 0 && p[1] === 0) {
            if (segment.length > 1) polylines.recommended.push(new AMapInstance.Polyline({ path: segment, strokeColor: "#10b981", strokeWeight: 5, lineCap: 'round', strokeOpacity: 0.6, zIndex: 40 }));
            segment = [];
          } else { segment.push(new AMapInstance.LngLat(p[0], p[1])); }
        });
        if (segment.length > 1) polylines.recommended.push(new AMapInstance.Polyline({ path: segment, strokeColor: "#10b981", strokeWeight: 5, lineCap: 'round', strokeOpacity: 0.6, zIndex: 40 }));
        map.add(polylines.recommended);
      }
      if (data.draft_coords?.length > 0) {
        polylines.draft = new AMapInstance.Polyline({ path: data.draft_coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#1f2937", strokeWeight: 6, zIndex: 45 });
        map.add(polylines.draft);
      }
      if (data.run_coords?.length > 0) {
        polylines.run = new AMapInstance.Polyline({ path: data.run_coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#ef4444", strokeWeight: 5, strokeStyle: 'dashed', zIndex: 50 });
        map.add(polylines.run);
      }
      drawMarkers();
      resetMapView();
    }

    function drawOnMap() {
      drawOnMap_signature();
      setTimeout(() => {
        // if (selectedTaskIndex === index) {
        logMessage_Info("æ‰§è¡ŒäºŒæ¬¡æ¸²æŸ“ä»¥ä¿®æ­£åˆå§‹ä½ç§»...", 'DEBUG');
        drawOnMap_signature();
        // }
      }, 100); // ç¨å¾®å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿æ¸²æŸ“ç¨³å®š
    }

    function drawMarkers() {
      if (!map) return;
      map.remove(markers); markers = [];
      const data = currentRunData; if (!data?.target_points?.length) return;
      const sequence = data.target_sequence || (data.status == 1 ? data.target_points.length + 1 : 0);
      const names = (data.target_point_names || "").split('|');
      data.target_points.forEach((p, i) => {
        let bgColor = 'bg-emerald-600', textColor = 'text-white', zIndex = 100, pulseClass = '';
        if (i + 1 < sequence) { bgColor = 'bg-slate-400'; } else if (i + 1 === sequence) { bgColor = 'bg-sky-600'; zIndex = 110; pulseClass = 'pulsing-marker'; }
        const pointName = names[i] || `ç‚¹ ${i + 1}`;
        const markerContent = `<div class="relative flex flex-col items-center pointer-events-none"><div class="${pulseClass} text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg ${bgColor} ${textColor}">${pointName}</div><div class="w-0 h-0 border-x-4 border-x-transparent border-t-4 ${bgColor.replace('bg-', 'border-t-')}"></div></div>`;
        const marker = new AMapInstance.Marker({ position: new AMapInstance.LngLat(p[0], p[1]), content: markerContent, anchor: 'bottom-center', zIndex: zIndex });
        markers.push(marker);
      });
      map.add(markers);
    }

    // --- è·¯å¾„ç»˜åˆ¶ç›¸å…³å‡½æ•° ---
    let draftPath = [], draftPathLngLat = [], pendingPoints = [], isUpdating = false, lastMouseMoveTime = 0;
    const MOUSE_MOVE_THROTTLE_MS = 70;
    const MIN_DRAW_DISTANCE_M = 12;

    function fastDistanceMeters(lon1, lat1, lon2, lat2) { return Math.sqrt(Math.pow((lon1 - lon2) * 102834.74, 2) + Math.pow((lat1 - lat2) * 111712.69, 2)); }

    function scheduleUpdate() {
      if (isUpdating) return; isUpdating = true;
      requestAnimationFrame(() => {
        if (pendingPoints.length > 0) {
          const batch = pendingPoints.splice(0, pendingPoints.length);
          batch.forEach(pt => {
            const lngLat = new AMapInstance.LngLat(pt.lng, pt.lat);
            draftPath.push(pt);
            draftPathLngLat.push(lngLat);
            if (draftPathLngLat.length > 1) { const prev = draftPathLngLat[draftPathLngLat.length - 2]; draftTotalDist += fastDistanceMeters(prev.lng, prev.lat, pt.lng, pt.lat); }
            checkTargetReachedOnDraw(lngLat, pt.isKey === 1);
          });
          if (!polylines.draft) { polylines.draft = new AMapInstance.Polyline({ path: draftPathLngLat, strokeColor: "#1f2937", strokeWeight: 6, zIndex: 45 }); map.add(polylines.draft); }
          else { polylines.draft.setPath(draftPathLngLat); }
          updateDrawingInfo(draftPathLngLat[draftPathLngLat.length - 1]);
          updateDashboard();
        }
        isUpdating = false;
        if (pendingPoints.length > 0) scheduleUpdate();
      });
    }

    function onMapMouseDown(e) { if (e.originEvent.button !== 0) return; leftMouseDown = true; if (isDrawing) { isPathDrawing = true; pendingPoints.push({ lng: e.lnglat.lng, lat: e.lnglat.lat, isKey: 0 }); scheduleUpdate(); } }
    function onMapMouseMove(e) {
      const now = performance.now(); if (now - lastMouseMoveTime < MOUSE_MOVE_THROTTLE_MS) return; lastMouseMoveTime = now;
      if (isDrawing && isPathDrawing && leftMouseDown) {
        const lastPos = draftPath[draftPath.length - 1];
        if (!lastPos || fastDistanceMeters(lastPos.lng, lastPos.lat, e.lnglat.lng, e.lnglat.lat) > MIN_DRAW_DISTANCE_M) { pendingPoints.push({ lng: e.lnglat.lng, lat: e.lnglat.lat, isKey: 0 }); scheduleUpdate(); }
        else { updateDrawingInfo(e.lnglat); }
      }
    }
    function onMapMouseUp(e) { leftMouseDown = false; if (isDrawing && isPathDrawing) { isPathDrawing = false; scheduleUpdate(); } if (pendingUnlockMap) { map.setStatus({ dragEnable: true }); pendingUnlockMap = false; } }
    function checkTargetReachedOnDraw(currentLngLat, isForcedKeyPoint = false) {
      if (!currentRunData?.target_points || currentRunData.target_points.length === 0) return;
      let seq = currentRunData.target_sequence || 1;
      if (seq > currentRunData.target_points.length) return;
      const [tarLon, tarLat] = currentRunData.target_points[seq - 1];
      const dist = fastDistanceMeters(currentLngLat.lng, currentLngLat.lat, tarLon, tarLat);
      const range = currentRunData.target_range_m || 0.0;
      if (dist <= range && !currentRunData.isInTargetZone) {
        currentRunData.isInTargetZone = true;
        const targetName = (currentRunData.target_point_names || "").split('|')[seq - 1] || `æ‰“å¡ç‚¹${seq}`;
        logMessage_Info(`åˆ°è¾¾æ‰“å¡ç‚¹ ${seq}: ${targetName}`);
        if (isForcedKeyPoint) { pendingPoints.push({ lng: tarLon, lat: tarLat, isKey: 1 }); scheduleUpdate(); }
        if (seq < currentRunData.target_points.length) {
          currentRunData.target_sequence = seq + 1;
          updateDashboard();
          drawMarkers();
        } else {
          logMessage_Info("å·²åˆ°è¾¾æ‰€æœ‰æ‰“å¡ç‚¹ï¼");
          if (isDrawing) {
            toggleRecordMode(true);
          }
        }
      } else if (dist > range && currentRunData.isInTargetZone) {
        currentRunData.isInTargetZone = false;
      }
    }
    function updateDrawingInfo(lnglat) {
      if (!isDrawing) { if (drawingInfoMarker) drawingInfoMarker.hide(); return; }
      const avgSpeed = pythonParams.speed_mps || 1.5; const estTime = avgSpeed > 0 ? draftTotalDist / avgSpeed : 0;
      const timeStr = `${Math.floor(estTime / 60).toString().padStart(2, '0')}:${Math.floor(estTime % 60).toString().padStart(2, '0')}`;
      if (!drawingInfoMarker) { drawingInfoMarker = new AMapInstance.Text({ anchor: 'bottom-left', offset: new AMapInstance.Pixel(10, -10), style: { 'background-color': 'rgba(255, 255, 255, 0.9)', 'border': '1px solid #94a3b8', 'padding': '4px 8px', 'border-radius': '10px', 'font-size': '12px', 'color': '#1e293b' } }); map.add(drawingInfoMarker); }
      drawingInfoMarker.setText(`è·ç¦»: ${draftTotalDist.toFixed(0)} m | é¢„ä¼°: ~${timeStr}`);
      drawingInfoMarker.setPosition(lnglat);
      drawingInfoMarker.show();
    }

    let pendingUnlockMap = false;

    function toggleRecordMode() {
      const btn = $('record-button'); isDrawing = !isDrawing;
      if (isDrawing) {
        if (selectedTaskIndex === -1) { showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡ï¼"); isDrawing = false; return; }
        btn.innerHTML = 'ç»“æŸç»˜åˆ¶'; btn.classList.remove('btn-success'); btn.classList.add('btn-danger');
        $('map-container').classList.add('drawing');
        clearCurrentPath(false);
        currentRunData.target_sequence = 1; currentRunData.isInTargetZone = false; draftTotalDist = 0;
        updateDashboard(); drawMarkers(); map.setStatus({ dragEnable: false }); resetMapView();
        logMessage_Info("è¿›å…¥å½•åˆ¶æ¨¡å¼ã€‚è¯·åœ¨åœ°å›¾ä¸ŠæŒ‰ä¸‹å·¦é”®å¹¶æ‹–åŠ¨æ¥ç»˜åˆ¶è·¯å¾„ã€‚");
      } else {
        btn.innerHTML = 'å½•åˆ¶è·¯å¾„'; btn.classList.remove('btn-danger'); btn.classList.add('btn-success');
        $('map-container').classList.remove('drawing');
        pendingUnlockMap = true; isPathDrawing = false; if (drawingInfoMarker) drawingInfoMarker.hide();

        // ========== ä»»åŠ¡26ï¼šè·¯å¾„è·ç¦»æ ¡éªŒ ==========
        // æ£€æŸ¥è·¯å¾„æ€»è·ç¦»æ˜¯å¦è¶…è¿‡50kmï¼ˆ50000ç±³ï¼‰
        if (draftTotalDist > 50000) {
          showModalAlert('è·¯å¾„è¿‡é•¿ï¼ˆ>' + (draftTotalDist / 1000).toFixed(2) + 'km > 50kmï¼‰ï¼Œè¯·é‡æ–°å½•åˆ¶');
          discardBlackDraftPolyline(); // æ‹’ç»ä¿å­˜å¹¶æ¸…é™¤è·¯å¾„
          logMessage_Warn(`è·¯å¾„å½•åˆ¶å¤±è´¥ï¼šè·ç¦»${(draftTotalDist / 1000).toFixed(2)}kmè¶…è¿‡50kmé™åˆ¶`);
          currentRunData.target_sequence = 0; draftTotalDist = 0;
          updateDashboard(); drawMarkers(); resetMapView();
          return; // æ‹’ç»ä¿å­˜
        }
        // ==========================================

        const totalTargets = (currentRunData.target_points?.length || 0);
        const inLastZone = totalTargets > 0 && currentRunData.target_sequence >= totalTargets && currentRunData.isInTargetZone === true;
        if (inLastZone) { if (draftPath.length > 0) callPythonAPI('set_draft_path', draftPath).then(() => processCurrentPath()); }
        else { discardBlackDraftPolyline(); logMessage_Info("æœªè¾¾åˆ°æœ€åæ‰“å¡ç‚¹ï¼Œå·²èˆå¼ƒè·¯å¾„ã€‚"); }
        currentRunData.target_sequence = 0; draftTotalDist = 0;
        updateDashboard(); drawMarkers(); resetMapView();
      }
    }
    async function clearCurrentPath(confirm = true) {
      if (confirm) {

        const userConfirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', 'ç¡®è®¤æ¸…é™¤å½“å‰ä»»åŠ¡å·²ç”Ÿæˆçš„è·¯å¾„å—ï¼Ÿ');
        if (!userConfirmed) return;
      }
      await callPythonAPI('clear_current_task_draft')
      if (polylines.draft) { map.remove(polylines.draft); polylines.draft = null; }
      if (polylines.history) { map.remove(polylines.history); polylines.history = null; }
      if (polylines.run) { map.remove(polylines.run); polylines.run = null; }
      if (drawingInfoMarker) drawingInfoMarker.hide();
      draftPath = []; draftPathLngLat = []; draftTotalDist = 0;
      if (currentRunData) { currentRunData.draft_coords = []; currentRunData.run_coords = []; currentRunData.total_run_distance_m = 0; currentRunData.total_run_time_s = 0; }
      if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) { currentTasks[selectedTaskIndex].draft_coords = []; currentTasks[selectedTaskIndex].run_coords = []; }
      updateDashboard(); renderTaskList();
    }
    async function discardBlackDraftPolyline() {
      try {
        if (polylines.draft) { map.remove(polylines.draft); polylines.draft = null; }
        draftPath = []; draftPathLngLat = []; pendingPoints = []; isUpdating = false; isPathDrawing = false; leftMouseDown = false; draftTotalDist = 0;
        if (drawingInfoMarker) drawingInfoMarker.hide();
        await callPythonAPI('set_draft_path', []);
        if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) { currentTasks[selectedTaskIndex].draft_coords = []; renderTaskList(); }
        if (currentRunData) currentRunData.draft_coords = [];
      } catch (e) { logMessage_Error("discardBlackDraftPolyline() error:", e); }
    }
    async function processCurrentPath() {
      if (draftPath.length > 0) await callPythonAPI('set_draft_path', draftPath);
      const result = await callPythonAPI('process_path');
      if (result.success) {
        currentRunData.run_coords = result.run_coords;
        currentRunData.total_run_distance_m = result.total_dist;
        currentRunData.total_run_time_s = result.total_time;
        drawOnMap(); updateDashboard(); renderTaskList(); discardBlackDraftPolyline();
        // å¤„ç†è·¯å¾„ååŒæ­¥æ€»ç‚¹æ•°å¹¶å¤ä½è¿›åº¦
        singleProcessedPoints = 0;
        singleTotalPoints = (currentRunData.run_coords?.length || 0);
        updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

      } else showModalAlert(result.message);
    }
    async function toggleRun() {
      const btn = $('start-run-button'); runAccumulatedMs = 0;
      if (btn.textContent === 'å¼€å§‹æ‰§è¡Œ') {
        const autoGen = $('auto-gen-all-check').checked;
        // ä½¿ç”¨åå°ä»»åŠ¡æ‰§è¡Œæ¨¡å¼è¿è¡Œå•ä¸ªä»»åŠ¡
        if (selectedTaskIndex < 0) {
          showModalAlert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡');
          return;
        }

        if (currentRunData) {
          currentRunData.target_sequence = 1; // é‡ç½®ä¸ºç¬¬ä¸€ä¸ªæ‰“å¡ç‚¹ (JS UI ä½¿ç”¨ 1-based ç´¢å¼•)
          currentRunData.isInTargetZone = false;
          updateDashboard(); // ç«‹å³æ›´æ–°ä»ªè¡¨ç›˜
          drawMarkers();     // ç«‹å³é‡ç»˜åœ°å›¾æ ‡è®°ï¼ˆé«˜äº®ç¬¬ä¸€ä¸ªç‚¹ï¼‰
        }

        const result = await callPythonAPI_raw('/api/background_task/start', 'POST', {
          task_indices: [selectedTaskIndex],
          auto_generate: autoGen
        });

        if (result.success) {
          btn.textContent = 'åœæ­¢';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-danger');

          // åˆå§‹åŒ–å•ä»»åŠ¡è¿›åº¦æ˜¾ç¤ºç•Œé¢
          updateSingleProgress(0, '0 / 0 ç‚¹');


          // 500msåå¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
          setTimeout(() => startBackgroundTaskPolling(), 500);
        } else {
          showModalAlert(result.message);
        }
      } else {
        // åœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
        await callPythonAPI_raw('/api/background_task/stop', 'POST', {});
        btn.textContent = 'å¼€å§‹æ‰§è¡Œ';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
        stopBackgroundTaskPolling();
      }
    }

    async function toggleAllRuns() {
      const btn = $('start-all-button'); runAccumulatedMs = 0;
      if (btn.textContent === 'æ‰§è¡Œæ‰€æœ‰') {
        const ignoreCompleted = $('run-completed-check').checked;
        const autoGen = $('auto-gen-all-check').checked;

        // ç­›é€‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡
        const taskIndices = [];
        for (let i = 0; i < currentTasks.length; i++) {
          const task = currentTasks[i];
          if (task.status == 1 && !ignoreCompleted) continue;

          // æ£€æŸ¥ä»»åŠ¡çš„æ—¶é—´èŒƒå›´æ˜¯å¦æœ‰æ•ˆ (JS)
          // ä¿®å¤ï¼šä½¿ç”¨ task.info_text...
          const infoText = task.info_text || "";



          if (infoText === 'å·²è¿‡æœŸ') {
            continue; // ä»»åŠ¡å·²è¿‡æœŸ
          }
          if (infoText.startsWith('å¼€å§‹äº')) {
            continue; // ä»»åŠ¡æœªå¼€å§‹
          }



          taskIndices.push(i);
        }

        if (taskIndices.length === 0) {
          showModalAlert('æ²¡æœ‰å¯æ‰§è¡Œçš„ä»»åŠ¡');
          return;
        }

        // ï¼ˆå› ä¸ºUIä¼šæ˜¾ç¤ºç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼‰
        if (currentRunData) {
          currentRunData.target_sequence = 1; // é‡ç½®ä¸ºç¬¬ä¸€ä¸ªæ‰“å¡ç‚¹ (JS UI ä½¿ç”¨ 1-based ç´¢å¼•)
          currentRunData.isInTargetZone = false;
          updateDashboard(); // ç«‹å³æ›´æ–°ä»ªè¡¨ç›˜
          drawMarkers();     // ç«‹å³é‡ç»˜åœ°å›¾æ ‡è®°
        }

        // ä½¿ç”¨åå°ä»»åŠ¡æ‰§è¡Œæ¨¡å¼è¿è¡Œå¤šä¸ªä»»åŠ¡
        const result = await callPythonAPI_raw('/api/background_task/start', 'POST', {
          task_indices: taskIndices,
          auto_generate: autoGen
        });

        if (result.success) {
          btn.textContent = 'å…¨éƒ¨åœæ­¢';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-danger');

          // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤ºç•Œé¢
          updateSingleProgress(0, `0 / ${taskIndices.length} ä»»åŠ¡`);

          // Start polling (with a small delay to let backend initialize)
          setTimeout(() => startBackgroundTaskPolling(), 500);
        } else {
          showModalAlert(result.message);
        }
      } else {
        // åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
        await callPythonAPI_raw('/api/background_task/stop', 'POST', {});
        btn.textContent = 'æ‰§è¡Œæ‰€æœ‰';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-secondary');
        stopBackgroundTaskPolling();
      }
    }

    // ========== åå°ä»»åŠ¡ç®¡ç†å‡½æ•° ==========
    let backgroundTaskPollInterval = null;
    let backgroundTaskStartTime = 0; // è®°å½•ä»»åŠ¡å¯åŠ¨æ—¶é—´ï¼Œç”¨äºé¿å…æ˜¾ç¤ºæ—§æ•°æ®çš„æç¤º

    function startBackgroundTaskPolling() {
      if (backgroundTaskPollInterval) {
        clearInterval(backgroundTaskPollInterval);
      }

      // æ ‡è®°ä»»åŠ¡å¼€å§‹æ—¶é—´æˆ³
      backgroundTaskStartTime = Date.now();

      // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡
      pollBackgroundTaskStatus();

      // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
      backgroundTaskPollInterval = setInterval(pollBackgroundTaskStatus, 3000);
    }

    function stopBackgroundTaskPolling() {
      if (backgroundTaskPollInterval) {
        clearInterval(backgroundTaskPollInterval);
        backgroundTaskPollInterval = null;
      }

      backgroundTaskStartTime = 0;
    }

    async function pollBackgroundTaskStatus() {
      try {
        const result = await callPythonAPI_raw('/api/background_task/status', 'GET', null);

        if (result.success && result.task_status) {
          const status = result.task_status;

          // ---------- [BUG ä¿®å¤ START] ----------
          // æ£€æŸ¥åç«¯æ˜¯å¦åœ¨ auto-gen åå‘æ¥äº†å®Œæ•´çš„è·¯å¾„æ•°æ®
          // (è¿™ä¸ªæ•°æ®åœ¨ currentRunData ä¸­å¯èƒ½ä¸å­˜åœ¨ï¼Œå› ä¸º auto-gen æ˜¯åœ¨åç«¯å‘ç”Ÿçš„)
          if (status.run_coords && status.run_coords.length > 0) {
            // æ£€æŸ¥å‰ç«¯çš„ currentRunData æ˜¯å¦ç¼ºå°‘æ­¤è·¯å¾„æ•°æ®
            if (!currentRunData || !currentRunData.run_coords || currentRunData.run_coords.length === 0) {
              logMessage_Info("æ£€æµ‹åˆ°åç«¯å·²è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ï¼Œæ­£åœ¨æ›´æ–°å‰ç«¯åœ°å›¾...");

              // å°†åç«¯å‘æ¥çš„è·¯å¾„å’Œæ‰“å¡ç‚¹æ•°æ®åŒæ­¥åˆ°å‰ç«¯çš„ currentRunData
              currentRunData.run_coords = status.run_coords || [];
              currentRunData.target_points = status.target_points || [];
              currentRunData.target_point_names = status.target_point_names || '';
              currentRunData.recommended_coords = status.recommended_coords || [];

              // (é‡è¦) åŒæ­¥æ€»è§ˆæ•°æ®
              currentRunData.total_run_time_s = status.estimated_total_time_s || 0;
              currentRunData.total_run_distance_m = status.estimated_total_distance_m || 0;

              // ç«‹å³é‡ç»˜åœ°å›¾ï¼ˆæ˜¾ç¤ºè·¯å¾„å’Œæ‰“å¡ç‚¹ï¼‰
              drawOnMap();

              // ç«‹å³æ›´æ–°ä»ªè¡¨ç›˜ï¼ˆæ˜¾ç¤ºæ€»è§ˆï¼‰
              updateDashboard();
            }
          }
          // ---------- [BUG ä¿®å¤ END] ----------

          // æ›´æ–°ç°æœ‰çš„è¿›åº¦æ˜¾ç¤ºç•Œé¢
          const completedTasks = status.completed_tasks || 0;
          const totalTasks = status.total_tasks || 0;
          const progressPercent = status.progress_percent || 0;
          const currentTaskProgress = status.current_task_progress || 0;

          // ä»åç«¯APIè·å–ç²¾ç¡®çš„ç‚¹æ•°è¿›åº¦
          let pct = 0;
          let displayText = '';

          // ä¼˜å…ˆä½¿ç”¨åç«¯æä¾›çš„ç‚¹æ•°æ•°æ®ï¼ˆæ›´å‡†ç¡®ï¼‰
          if (status.singleTotalPoints !== undefined && status.singleProcessedPoints !== undefined) {
            singleTotalPoints = status.singleTotalPoints;
            singleProcessedPoints = status.singleProcessedPoints;
            pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
            displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
          } else if (currentRunData && Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
            // é™çº§æ–¹æ¡ˆï¼šä»å‰ç«¯è®¡ç®—ï¼ˆå½“åç«¯æ•°æ®ä¸å¯ç”¨æ—¶ï¼‰
            singleTotalPoints = currentRunData.run_coords.length;

            if (status.current_position) {
              // ä½¿ç”¨ç²¾ç¡®çš„ç‚¹ç´¢å¼•
              const currentPointIndex = status.current_position.point_index || 0;
              singleProcessedPoints = Math.min(currentPointIndex, singleTotalPoints);
            } else {
              // ä»ç™¾åˆ†æ¯”ä¼°ç®—ç‚¹æ•°ï¼ˆå½“ä½ç½®æ•°æ®ä¸å¯ç”¨æ—¶ï¼‰
              singleProcessedPoints = Math.floor((currentTaskProgress / 100) * singleTotalPoints);
            }

            pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
            displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
          } else {
            // åæ ‡æ•°æ®ä¸å¯ç”¨æ—¶ï¼Œä»ç„¶ä½¿ç”¨ç‚¹æ•°æ ¼å¼ï¼ˆæ˜¾ç¤º 0 / 0ï¼‰
            singleTotalPoints = 0;
            singleProcessedPoints = 0;
            pct = 0;
            displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
          }

          updateSingleProgress(pct, displayText);

          // æ›´æ–°å½“å‰ä»»åŠ¡ç´¢å¼•ï¼ˆä»åç«¯APIåŒæ­¥ï¼‰
          if (status.task_indices && status.current_task_index !== undefined) {
            const task_list = status.task_indices;
            const current_list_index = status.current_task_index;
            if (task_list.length > current_list_index) {
              const global_task_index = task_list[current_list_index];

              if (global_task_index !== selectedTaskIndex || (currentRunData && currentRunData.task_index !== global_task_index)) {
                logMessage_Info(`[Polling] æ£€æµ‹åˆ°ä»»åŠ¡åˆ‡æ¢: ${selectedTaskIndex} -> ${global_task_index}`);
                selectedTaskIndex = global_task_index;

                // 1. é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥é«˜äº®æ˜¾ç¤ºæ–°ä»»åŠ¡ (ä½ æåˆ°çš„ renderTaskList)
                renderTaskList();

                // 2. å¼ºåˆ¶åŠ è½½æ–°ä»»åŠ¡çš„åœ°å›¾æ•°æ®
                // (æˆ‘ä»¬è°ƒç”¨æ–°åˆ›å»ºçš„è¾…åŠ©å‡½æ•°)
                await forceLoadTaskDataForPolling(global_task_index);
              }

            }
          }

          // æ›´æ–°å®æ—¶æ—¶é—´å’Œè·ç¦»ï¼ˆä»åç«¯APIè·å–ï¼‰
          if (status.elapsed_time_s !== undefined) {
            runAccumulatedMs = status.elapsed_time_s * 1000;  // è½¬æ¢ä¸ºæ¯«ç§’
          }
          if (status.current_distance_m !== undefined && currentRunData) {
            currentRunData.distance_covered_m = status.current_distance_m;
          }
          if (status.checked_targets_count !== undefined && currentRunData) {
            currentRunData.target_sequence = status.checked_targets_count;
          }

          // æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤º
          updateDashboard();

          drawMarkers();

          // // å¦‚æœæœ‰å®æ—¶ä½ç½®æ•°æ®ï¼Œåˆ™åœ¨åœ°å›¾ä¸Šæ›´æ–°æ˜¾ç¤º
          // if (status.current_position) {
          //   const pos = status.current_position;
          //   updateRunnerPosition(
          //     pos.lon,
          //     pos.lat,
          //     pos.distance || 0,
          //     pos.target_sequence || 0,
          //     0, // duration not needed for display
          //     false // don't auto-center
          //   );
          // }

          // æ£€æŸ¥è¿™æ˜¯å¦æ˜¯æ—§æ•°æ®ï¼ˆä»»åŠ¡åœ¨æˆ‘ä»¬å¼€å§‹è½®è¯¢å‰å°±å·²å¯åŠ¨ï¼‰
          const taskStartTime = (status.start_time || 0) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
          const isOldTask = backgroundTaskStartTime > 0 && taskStartTime < backgroundTaskStartTime - 2000; // 2ç§’ç¼“å†²

          // æ£€æŸ¥æ˜¯å¦å®Œæˆ - ä»…åœ¨ä¸æ˜¯æ—§æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
          if (status.status === 'completed') {
            if (!isOldTask) {
              logMessage_Info('åå°ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼');
              showModalAlert('åå°ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼');
            }
            stopBackgroundTaskPolling();

            // Reset button states
            $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
            $('start-run-button').classList.remove('btn-danger');
            $('start-run-button').classList.add('btn-primary');
            $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
            $('start-all-button').classList.remove('btn-danger');
            $('start-all-button').classList.add('btn-secondary');

            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            if (!isOldTask) {
              refreshTasks();
            }
          } else if (status.status === 'error') {
            const errorMsg = status.error || 'æœªçŸ¥é”™è¯¯';
            logMessage_Error('åå°ä»»åŠ¡æ‰§è¡Œå‡ºé”™: ' + errorMsg);
            if (!isOldTask) {
              showModalAlert('åå°ä»»åŠ¡æ‰§è¡Œå‡ºé”™: ' + errorMsg);
            }
            stopBackgroundTaskPolling();

            // Reset button states
            $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
            $('start-run-button').classList.remove('btn-danger');
            $('start-run-button').classList.add('btn-primary');
            $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
            $('start-all-button').classList.remove('btn-danger');
            $('start-all-button').classList.add('btn-secondary');
          }
        }
      } catch (e) {
        // é™é»˜å¤±è´¥ï¼Œé¿å…è½®è¯¢é”™è¯¯å½±å“ä¸»æµç¨‹
        logMessage_Debug('è½®è¯¢åå°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰åå°ä»»åŠ¡åœ¨è¿è¡Œ
    async function checkBackgroundTaskOnLoad() {
      try {
        const result = await callPythonAPI_raw('/api/background_task/status', 'GET', null);

        if (result.success && result.task_status) {
          const status = result.task_status;

          // å¦‚æœæœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºçŠ¶æ€å¹¶å¼€å§‹è½®è¯¢
          if (status.status === 'running') {
            logMessage_Info('æ£€æµ‹åˆ°åå°ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œå·²æ¢å¤çŠ¶æ€æ˜¾ç¤º');

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ä»¥åæ˜ è¿è¡ŒçŠ¶æ€
            const totalTasks = status.total_tasks || 0;
            if (totalTasks === 1) {
              // å•ä¸ªä»»åŠ¡æ­£åœ¨è¿è¡Œ
              $('start-run-button').textContent = 'åœæ­¢';
              $('start-run-button').classList.remove('btn-primary');
              $('start-run-button').classList.add('btn-danger');
            } else if (totalTasks > 1) {
              // å¤šä¸ªä»»åŠ¡æ­£åœ¨è¿è¡Œ
              $('start-all-button').textContent = 'å…¨éƒ¨åœæ­¢';
              $('start-all-button').classList.remove('btn-secondary');
              $('start-all-button').classList.add('btn-danger');
            }

            // --- å‡çº§ï¼šæ¢å¤åœ°å›¾è·¯å¾„å’Œæ‰“å¡ç‚¹ ---
            const task_list = status.task_indices || [];
            const current_list_index = status.current_task_index || 0;

            if (task_list.length > current_list_index) {
              const global_task_index = task_list[current_list_index];

              // ä½¿ç”¨åç«¯æä¾›çš„å®Œæ•´ä»»åŠ¡æ•°æ®æ¢å¤ï¼ˆé¿å…è°ƒç”¨selectTaskå¯¼è‡´ä»»åŠ¡åˆ‡æ¢æ£€æŸ¥å¤±è´¥ï¼‰
              logMessage_Info(`æ­£åœ¨æ¢å¤è¿è¡Œä¸­çš„ä»»åŠ¡ (ç´¢å¼•: ${global_task_index}) çš„åœ°å›¾æ•°æ®...`);

              if (status.run_coords && status.run_coords.length > 0) {
                // ç›´æ¥ä»APIå“åº”æ„å»ºcurrentRunData
                currentRunData = {
                  run_coords: status.run_coords || [],
                  target_points: status.target_points || [],
                  target_point_names: status.target_point_names || '',
                  recommended_coords: status.recommended_coords || [],
                  target_sequence: status.checked_targets_count || 0,
                  distance_covered_m: status.current_distance_m || 0,
                  total_run_time_s: status.estimated_total_time_s || 0,
                  total_run_distance_m: status.estimated_total_distance_m || 0
                };

                selectedTaskIndex = global_task_index;

                // æ›´æ–°ä»»åŠ¡åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
                const taskListDiv = $('task-list');
                Array.from(taskListDiv.children).forEach((child, idx) => {
                  if (idx === global_task_index) {
                    child.classList.add('selected');
                  } else {
                    child.classList.remove('selected');
                  }
                });
                loadHistory(global_task_index);

                // ç»˜åˆ¶åœ°å›¾
                updateDashboard();
                drawOnMap();

                logMessage_Info(`ä»»åŠ¡æ•°æ®å·²ä»APIå“åº”æ¢å¤ï¼Œæ€»ç‚¹æ•°: ${currentRunData.run_coords.length}`, 'INFO');
              } else {
                // é™çº§æ–¹æ¡ˆï¼šè°ƒç”¨selectTask
                await selectTask(global_task_index);
              }
            } else {
              logMessage_Warning("åå°ä»»åŠ¡çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ— æ³•æ¢å¤åœ°å›¾è·¯å¾„ã€‚");
            }
            // --- ç»“æŸå‡çº§ ---

            // æ¢å¤è¿›åº¦æ˜¾ç¤º
            const completedTasks = status.completed_tasks || 0;
            const progressPercent = status.progress_percent || 0;
            const currentTaskProgress = status.current_task_progress || 0;

            // ä»åç«¯APIè·å–ç²¾ç¡®çš„ç‚¹æ•°è¿›åº¦
            let pct = 0;
            let displayText = '';

            // ä¼˜å…ˆä½¿ç”¨åç«¯æä¾›çš„ç‚¹æ•°æ•°æ®ï¼ˆæ›´å‡†ç¡®ï¼‰
            if (status.singleTotalPoints !== undefined && status.singleProcessedPoints !== undefined) {
              singleTotalPoints = status.singleTotalPoints;
              singleProcessedPoints = status.singleProcessedPoints;
              pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
            } else if (currentRunData && Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
              // é™çº§æ–¹æ¡ˆï¼šä»å‰ç«¯è®¡ç®—ï¼ˆå½“åç«¯æ•°æ®ä¸å¯ç”¨æ—¶ï¼‰
              singleTotalPoints = currentRunData.run_coords.length;

              if (status.current_position) {
                // ä½¿ç”¨ç²¾ç¡®çš„ç‚¹ç´¢å¼•
                const currentPointIndex = status.current_position.point_index || 0;
                singleProcessedPoints = Math.min(currentPointIndex, singleTotalPoints);
              } else {
                // ä»ç™¾åˆ†æ¯”ä¼°ç®—ç‚¹æ•°ï¼ˆå½“ä½ç½®æ•°æ®ä¸å¯ç”¨æ—¶ï¼‰
                singleProcessedPoints = Math.floor((currentTaskProgress / 100) * singleTotalPoints);
              }

              pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
            } else {
              // åæ ‡æ•°æ®ä¸å¯ç”¨æ—¶ï¼Œä»ç„¶ä½¿ç”¨ç‚¹æ•°æ ¼å¼ï¼ˆæ˜¾ç¤º 0 / 0ï¼‰
              singleTotalPoints = 0;
              singleProcessedPoints = 0;
              pct = 0;
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
            }

            updateSingleProgress(pct, displayText);

            // æ›´æ–°å®æ—¶æ—¶é—´å’Œè·ç¦»ï¼ˆä»åç«¯APIè·å–ï¼‰
            if (status.elapsed_time_s !== undefined) {
              runAccumulatedMs = status.elapsed_time_s * 1000;  // è½¬æ¢ä¸ºæ¯«ç§’
            }
            if (status.current_distance_m !== undefined && currentRunData) {
              currentRunData.distance_covered_m = status.current_distance_m;
            }
            if (status.checked_targets_count !== undefined && currentRunData) {
              currentRunData.target_sequence = status.checked_targets_count;
            }

            // æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤º
            updateDashboard();

            // å¦‚æœæœ‰å®æ—¶ä½ç½®æ•°æ®ï¼Œåœ¨åœ°å›¾ä¸Šæ¢å¤è·‘æ­¥è€…ä½ç½®æ˜¾ç¤º
            if (status.current_position) {
              const pos = status.current_position;
              // æ­¤æ—¶ selectTask å·²ç»åŠ è½½äº† currentRunDataï¼ŒupdateRunnerPosition å¯ä»¥æ­£ç¡®æ›´æ–°æ‰“å¡ç‚¹çŠ¶æ€
              updateRunnerPosition(
                pos.lon,
                pos.lat,
                pos.distance || 0,
                pos.target_sequence || 0,
                0,
                true // center on first restore
              );
            }

            startBackgroundTaskPolling();
            return true;
          }


        }
      } catch (e) {
        // é™é»˜å¤±è´¥
        logMessage_Debug('æ£€æŸ¥åå°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
        return false;
      }
    }

    function ensureRunnerMarker() {
      if (runnerMarker) return;
      const content = '<div class="w-5 h-5 rounded-full border-2 border-white shadow-lg" style="background:linear-gradient(135deg,var(--base-color-300),var(--base-color-600));"></div>';
      runnerMarker = new AMapInstance.Marker({ position: map.getCenter(), content, anchor: 'center', zIndex: 200 });
      map.add(runnerMarker);
    }
    function updateRunnerPosition(lon, lat, distance, targetSequence, duration, centerNow = false) {
      ensureRunnerMarker();
      const pos = new AMapInstance.LngLat(lon, lat);
      runnerMarker.setPosition(pos);
      if (map && centerNow) map.setCenter(pos);
      runAccumulatedMs += (duration || 0);
      currentRunData.distance_covered_m = distance || 0;
      $('current-location-label').textContent = `å½“å‰ä½ç½®GPSåæ ‡: ${(+lon).toFixed(4)}, ${(+lat).toFixed(4)}`;

      // Pythonåç«¯ä½¿ç”¨0-basedç´¢å¼• (targetSequence)ï¼Œè€ŒJS UIä½¿ç”¨1-basedç´¢å¼•ã€‚
      // åœ¨è¿™é‡Œè¿›è¡Œè½¬æ¢ï¼š(0-based index) + 1 = (1-based index)
      const jsTargetSequence = targetSequence + 1;

      // ä½¿ç”¨è½¬æ¢åçš„ jsTargetSequence (1-based) æ¥æ›´æ–°JSçš„ currentRunData.target_sequence
      if (currentRunData.target_sequence !== jsTargetSequence) {
        currentRunData.target_sequence = jsTargetSequence;
        drawMarkers();
      }
      updateDashboard();
      // æ¯ä¸ªGPSç‚¹åˆ°è¾¾åæ¨è¿›è¿›åº¦
      if (Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
        // é˜²é‡å¤ï¼šé™åˆ¶ä¸è¶…è¿‡æ€»ç‚¹æ•°
        singleTotalPoints = currentRunData.run_coords.length;
        singleProcessedPoints = Math.min(singleProcessedPoints + 1, singleTotalPoints);
        const pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
        updateSingleProgress(pct, `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`);
      }

    }
    function onTaskCompleted(taskIndex) { if (currentTasks[taskIndex]) { currentTasks[taskIndex].status = 1; renderTaskList(); } }

    /**
     * å½“åç«¯ï¼ˆé€šè¿‡WebSocketï¼‰é€šçŸ¥ä»»åŠ¡å·²åœæ­¢æ—¶è°ƒç”¨
     * (æ— è®ºæ˜¯å®Œæˆã€å¤±è´¥è¿˜æ˜¯æ‰‹åŠ¨ä¸­æ­¢)
     */
    function onRunStopped() {
      logMessage_Info("åå°ä»»åŠ¡å·²åœæ­¢ï¼ˆæ¥è‡ªæœåŠ¡å™¨æ¨é€ï¼‰ã€‚");

      // 1. åœæ­¢å‰ç«¯çš„è½®è¯¢
      stopBackgroundTaskPolling();

      // 2. é‡ç½®"å¼€å§‹æ‰§è¡Œ"æŒ‰é’®
      const startBtn = $('start-run-button');
      if (startBtn) {
        startBtn.textContent = 'å¼€å§‹æ‰§è¡Œ';
        startBtn.classList.remove('btn-danger');
        startBtn.classList.add('btn-primary');
        startBtn.disabled = false; // ç¡®ä¿æŒ‰é’®å¯ç”¨
      }

      // 3. é‡ç½®"æ‰§è¡Œæ‰€æœ‰"æŒ‰é’®
      const startAllBtn = $('start-all-button');
      if (startAllBtn) {
        startAllBtn.textContent = 'æ‰§è¡Œæ‰€æœ‰';
        startAllBtn.classList.remove('btn-danger');
        startAllBtn.classList.add('btn-secondary');
        startAllBtn.disabled = false; // ç¡®ä¿æŒ‰é’®å¯ç”¨
      }
    }

    async function exportTask() {
      if (selectedTaskIndex === -1) {
        showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„ä»»åŠ¡ï¼");
        return;
      }
      const result = await callPythonAPI('export_task_data');
      if (result && result.success && result.data) {
        // Webæ¨¡å¼ï¼šåˆ›å»ºæ–‡ä»¶ä¸‹è½½é“¾æ¥å¹¶è§¦å‘æµè§ˆå™¨ä¸‹è½½
        const jsonStr = JSON.stringify(result.data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename || 'task_export.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage_Info('å¯¼å‡ºæˆåŠŸ');
      } else if (result && !result.success) {
        showModalAlert(`å¯¼å‡ºå¤±è´¥: ${result.message}`);
      }
    }

    async function importTask() {
      // Webæ¨¡å¼ï¼šåˆ›å»ºæ–‡ä»¶é€‰æ‹©è¾“å…¥æ¡†ç”¨äºå¯¼å…¥
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const result = await callPythonAPI('import_task_data', text);

          if (result.success) {
            IS_OFFLINE = true;
            currentSessionUA = "NULL";
            const uaLabel = $('ua-label');
            if (uaLabel) uaLabel.textContent = 'NULL';
            const uaBtn = $('random-ua-btn');
            if (uaBtn) uaBtn.disabled = true;
            if (result.userInfo) {
              currentUserData = result.userInfo;
              const name = currentUserData.name || 'ç¦»çº¿è°ƒè¯•';
              const sid = currentUserData.student_id || 'NULL';
              $('user-name-label').textContent = `å§“å: ${name}`;
              $('user-id-label').textContent = `å­¦å·: ${sid}`;
            }
            showMainApp();
            await mapReadyPromise;
            currentTasks = result.tasks;
            renderTaskList();
            selectTask(0);
            requestAnimationFrame(() => drawOnMap());
            logMessage_Info('å¯¼å…¥æˆåŠŸ');
          } else {
            showModalAlert(result.message || 'å¯¼å…¥å¤±è´¥');
          }
        } catch (error) {
          showModalAlert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
        }
      };
      input.click();
    }





    // --- é«˜å¾·åœ°å›¾JS APIè·¯å¾„è§„åˆ’ ---
    async function getWalkingPath(waypoints) {
      if (!AMapInstance || waypoints.length < 2) throw new Error("åœ°å›¾å®ä¾‹æœªåŠ è½½æˆ–è·¯å¾„ç‚¹å°‘äº2");
      const useFallback = pythonParams.api_fallback_line ?? false, maxRetries = pythonParams.api_retries ?? 2, retryDelayMs = (pythonParams.api_retry_delay_s ?? 0.5) * 1000;
      callPythonAPI('js_log', 'INFO', `å¼€å§‹è·¯å¾„è§„åˆ’: é‡è¯•=${maxRetries}æ¬¡, å»¶è¿Ÿ=${retryDelayMs}ms, å¤‡ç”¨ç›´çº¿=${useFallback}`);
      const all_path = [];
      const areCoordsEqual = (c1, c2) => Math.abs(c1.lng - c2.lng) < 1e-6 && Math.abs(c1.lat - c2.lat) < 1e-6;
      const searchSegment = (start, end) => new Promise((resolve) => {
        callPythonAPI('js_log', 'DEBUG', `AMap APIè¯·æ±‚ --> æ­¥è¡Œè·¯å¾„: ${start.toString()} è‡³ ${end.toString()}`);
        new AMap.Walking({ map: null, panel: "", hideMarkers: true }).search(start, end, (status, result) => {
          if (status === 'complete' && result.routes?.length > 0) {
            const p = []; result.routes[0].steps.forEach(s => s.path.forEach(pt => p.push({ lng: pt.lng, lat: pt.lat })));
            callPythonAPI('js_log', 'DEBUG', `AMap APIå“åº” <-- æˆåŠŸï¼Œç‚¹æ•°: ${p.length}`); resolve(p);
          } else { let info = result ? (result.info || JSON.stringify(result)) : 'NULL'; callPythonAPI('js_log', 'ERROR', `AMap APIå“åº” <-- å¤±è´¥. çŠ¶æ€: ${status}, ç»“æœ: ${info}`); resolve([]); }
        });
      });
      // await new Promise(resolve => AMap.plugin('AMap.Walking', resolve));
      for (let i = 0; i < waypoints.length - 1; i++) {
        logMessage_Info(`æ­£åœ¨è§„åˆ’ç¬¬ ${i + 1}/${waypoints.length - 1} æ®µè·¯å¾„...`);
        const realStart = waypoints[i], realEnd = waypoints[i + 1]; let attempts = 0, segmentPath = [];
        while (attempts <= maxRetries) {
          if (attempts > 0) { logMessage_Info(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’å¤±è´¥ï¼Œ${retryDelayMs / 1000}ç§’åé‡è¯•...`); await new Promise(res => setTimeout(res, retryDelayMs)); }
          segmentPath = await searchSegment(realStart, realEnd); if (segmentPath.length > 0) break; attempts++;
        }
        if (segmentPath.length === 0) {
          if (useFallback) { logMessage_Info(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’æœ€ç»ˆå¤±è´¥ï¼Œå¯ç”¨ç›´çº¿è¿æ¥ã€‚`); segmentPath = [{ lng: realStart.lng, lat: realStart.lat }, { lng: realEnd.lng, lat: realEnd.lat }]; }
          else throw new Error(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’å¤±è´¥ (é‡è¯• ${maxRetries} æ¬¡å)`);
        }
        if (!areCoordsEqual(segmentPath[0], { lng: realStart.lng, lat: realStart.lat })) segmentPath.unshift({ lng: realStart.lng, lat: realStart.lat });
        if (!areCoordsEqual(segmentPath[segmentPath.length - 1], { lng: realEnd.lng, lat: realEnd.lat })) segmentPath.push({ lng: realEnd.lng, lat: realEnd.lat });
        all_path.push(...(i > 0 ? segmentPath.slice(1) : segmentPath));
      }
      return all_path;
    }

    async function onConfirmAutoGenerate() {
      const minTime = parseInt($('min-time-input').value), maxTime = parseInt($('max-time-input').value), minDist = parseInt($('min-dist-input').value);
      if (minTime > maxTime) { showModalAlert("æœ€çŸ­æ—¶é—´ä¸èƒ½å¤§äºæœ€é•¿æ—¶é—´"); return; }
      // $('auto-gen-modal').classList.add('hidden'); // <-- æ—§ä»£ç 
      // ä¿®å¤ï¼šä½¿ç”¨ä¸â€œå–æ¶ˆâ€æŒ‰é’®ç›¸åŒçš„é€»è¾‘å…³é—­æ¨¡æ€æ¡†
      $('auto-gen-modal').classList.add('hidden');
      $('auto-gen-modal').classList.remove('flex'); // ç§»é™¤å±…ä¸­
      document.body.classList.remove('modal-visible'); // æ¢å¤Logo

      if (selectedTaskIndex === -1 || !currentRunData.target_points || currentRunData.target_points.length === 0) { showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰æ‰“å¡ç‚¹çš„ä»»åŠ¡"); return; }
      logMessage_Info("æ­£åœ¨è°ƒç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œè·¯å¾„è§„åˆ’...");
      try {
        const waypoints = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        const apiPath = await getWalkingPath(waypoints);
        logMessage_Info(`è·¯å¾„è§„åˆ’æˆåŠŸï¼Œå…± ${apiPath.length} ä¸ªåæ ‡ç‚¹ã€‚æ­£åœ¨ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®...`);
        const result = await callPythonAPI('auto_generate_path_with_api', apiPath, minTime, maxTime, minDist);
        if (result.success) {
          currentRunData.run_coords = result.run_coords;
          currentRunData.total_run_distance_m = result.total_dist;
          currentRunData.total_run_time_s = result.total_time;
          drawOnMap(); updateDashboard(); renderTaskList();

          // è‡ªåŠ¨ç”ŸæˆååŒæ­¥æ€»ç‚¹æ•°å¹¶å¤ä½è¿›åº¦
          singleProcessedPoints = 0;
          singleTotalPoints = (currentRunData.run_coords?.length || 0);
          updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

        } else {
          logMessage_Info(`ç”Ÿæˆå¤±è´¥: ${result.message}`);
          showModalAlert(`ç”Ÿæˆå¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        logMessage_Info(`è·¯å¾„è§„åˆ’æˆ–ç”Ÿæˆå¤±è´¥: ${error}`);
        showModalAlert(`è·¯å¾„è§„åˆ’æˆ–ç”Ÿæˆå¤±è´¥: ${error}`);
      }
    }
    async function loadHistory(index) {

      $('history-placeholder').textContent = "æ­£åœ¨åŠ è½½..."; $('history-list').innerHTML = "";
      const result = await callPythonAPI('get_task_history', index);
      if (result.success && result.history.length > 0) {
        $('history-placeholder').classList.add('hidden');
        result.history.forEach(rec => {
          const item = document.createElement('div');
          item.className = 'grid grid-cols-3 gap-2 text-xs p-2 border-b border-slate-100 cursor-pointer hover:bg-white/70 rounded';
          item.innerHTML = `<span class="text-slate-600">${rec.time}</span><span class="font-semibold text-emerald-700">${rec.len}</span><span class="font-semibold text-sky-700">${rec.used_time}</span>`;
          item.addEventListener('click', () => showHistoricalTrack(rec.trid)); $('history-list').appendChild(item);
        });
      } else { $('history-placeholder').textContent = "æ— å†å²è®°å½•æˆ–åŠ è½½å¤±è´¥"; $('history-placeholder').classList.remove('hidden'); }
    }

    async function showHistoricalTrack(trid) {
      if (backgroundTaskPollInterval) {
        logMessage_Warning("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•æŸ¥çœ‹å†å²è®°å½•ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        showModalAlert("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•æŸ¥çœ‹å†å²è®°å½•ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        return;
      }
      const result = await callPythonAPI('get_historical_track', trid);
      if (result.success) {
        if (polylines.history) map.remove(polylines.history);
        polylines.history = new AMapInstance.Polyline({ path: result.coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#8b5cf6", strokeWeight: 6, strokeOpacity: 0.8, zIndex: 55 });
        map.add(polylines.history); map.setFitView([polylines.history]);
      } else showModalAlert("æ— æ³•åŠ è½½å†å²è½¨è¿¹");
    }

    // --- å…¶ä»–è¾…åŠ©å‡½æ•° ---


    // å•è´¦å·è¿›åº¦æ¡æ›´æ–°
    function updateSingleProgress(pct, text, extra) {
      const fill = $('single-progress-fill');
      const label = $('single-progress-text');
      const extraEl = $('single-progress-extra');
      if (fill) fill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
      if (label) label.textContent = `è¿›åº¦ Â· ${pct}%`;
      if (extraEl) extraEl.textContent = extra || text || '';
    }


    // --- å°è¯•è·å–è°ƒç”¨è€…ä¿¡æ¯çš„è¾…åŠ©å‡½æ•° ---
    function getCallerInfo(linesToSkip = null) {
      try {
        const err = new Error();
        const stack = err.stack;
        if (!stack) return { source: 'unknown (no stack)' };

        // å°†å †æ ˆä¿¡æ¯æŒ‰è¡Œåˆ†å‰²
        const lines = stack.split('\n');

        let callerLine; // <-- ä¿®å¤ #1: åœ¨å¤–éƒ¨ä½œç”¨åŸŸå£°æ˜å˜é‡

        if (linesToSkip !== null) {
          try {
            callerLine = lines[linesToSkip + 1] || ''; // <-- ä¿®å¤ #2: ç§»é™¤ 'let'ï¼Œç›´æ¥èµ‹å€¼
          } catch (error) {
            logMessage_Error("Error accessing stack line:", error);
            callerLine = lines[4] || lines[3] || lines[2] || lines[1] || ''; // <-- ä¿®å¤ #3: ç§»é™¤ 'let'
          }
        } else {

          // ä¸åŒæµè§ˆå™¨å †æ ˆæ ¼å¼ä¸åŒï¼Œå°è¯•å‡ ç§å¸¸è§æ¨¡å¼
          callerLine = lines[4] || lines[3] || lines[2] || lines[1] || ''; // <-- ä¿®å¤ #4: ç§»é™¤ 'let'
        }

        // ä¿®å¤ #5: å¢åŠ å¥å£®æ€§æ£€æŸ¥ï¼Œé˜²æ­¢ callerLine ä¸º undefined æ—¶è°ƒç”¨ .trim() å‡ºé”™
        if (typeof callerLine !== 'string') {
          callerLine = ''; // å¦‚æœå †æ ˆè¡Œä¸å­˜åœ¨ï¼ˆä¾‹å¦‚å †æ ˆå¤ªçŸ­ï¼‰ï¼Œæä¾›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²
        }

        callerLine = callerLine.trim();

        // å°è¯•åŒ¹é… Chrome/V8 æ ¼å¼: "at functionName (file:line:col)" æˆ– "at file:line:col"
        let match = callerLine.match(/at\s+(?:(.+)\s+\()?(?:.+\/)?([^:]+:\d+:\d+)\)?/);
        if (match) {
          const functionName = match[1] || 'anonymous';
          const fileInfo = match[2] || '';
          // --- è¿™é‡Œæ˜¯åŸå§‹çš„ source æ„é€  ---
          return { source: `${functionName} (${fileInfo})`, functionName: functionName, fileInfo: fileInfo };
        }

        // å°è¯•åŒ¹é… Firefox æ ¼å¼: "functionName@file:line:col" æˆ– "@file:line:col"
        match = callerLine.match(/^(?:([^@]+)@)?(?:.+\/)?([^:]+:\d+:\d+)$/);
        if (match) {
          const functionName = match[1] || 'anonymous';
          const fileInfo = match[2] || '';
          // --- è¿™é‡Œæ˜¯åŸå§‹çš„ source æ„é€  ---
          return { source: `${functionName}@${fileInfo}`, functionName: functionName, fileInfo: fileInfo };
        }

        // å¦‚æœéƒ½åŒ¹é…ä¸ä¸Šï¼Œè¿”å›åŸå§‹è¡Œï¼ˆå¯èƒ½åŒ…å«ä¸€äº›ä¿¡æ¯ï¼‰æˆ–æœªçŸ¥
        return { source: callerLine || 'unknown (parse failed)' };

      } catch (e) {
        // å¦‚æœè§£æå‡ºé”™ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        return { source: 'unknown (error parsing stack)' };
      }
    }


    // ä» getCallerInfo æå–å¹²å‡€çš„æ¥æºä¿¡æ¯ï¼Œåœ¨ (uuid= å‰åœæ­¢
    function extractCleanSource(sourceString) {
      if (typeof sourceString !== 'string') {
        return 'unknown';
      }

      let result = '';
      const marker = '(uuid=';
      let markerIndex = sourceString.indexOf(marker);

      // å¦‚æœæ‰¾ä¸åˆ°æ ‡è®°ï¼Œç›´æ¥è¿”å›å»é™¤é¦–å°¾ç©ºæ ¼çš„åŸå­—ç¬¦ä¸²
      if (markerIndex === -1) {
        return sourceString.trim();
      }

      // è·å–æ ‡è®°ä¹‹å‰çš„éƒ¨åˆ†
      let relevantPart = sourceString.substring(0, markerIndex);

      // å»é™¤æœ«å°¾çš„ç©ºç™½å­—ç¬¦
      result = relevantPart.trimEnd();

      // å¦‚æœå¤„ç†åç»“æœä¸ºç©ºï¼ˆä¾‹å¦‚æºå­—ç¬¦ä¸²æ˜¯ " (uuid=...")ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤å€¼
      return result || 'æœªçŸ¥';
    }

    // æ—¥å¿—è®°å½•å‡½æ•°ï¼Œæ”¯æŒä¸åŒçº§åˆ«æ—¥å¿—
    // level å¯é€‰å€¼ï¼š'DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'
    function logMessage(msg, level = 'INFO', source = null) {
      // ä¿ç•™åŸæœ‰çš„æ—¶é—´æˆ³æ·»åŠ é€»è¾‘ï¼Œå› ä¸ºåç«¯ Api.log æœªæ·»åŠ æ—¶é—´æˆ³
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      const timestamp = `[${h}:${m}:${s}]`;
      const timestamp2 = `${h}:${m}:${s}`;
      const line = typeof msg === 'string' ? msg : JSON.stringify(msg);


      let level_new = 'INFO';

      // è·å–è°ƒç”¨è€…ä¿¡æ¯
      // æ£€æŸ¥æ˜¯å¦å·²ä¼ å…¥æ¥æº (ä¾‹å¦‚ 'Backend')
      let callerInfo;
      if (source) {
        callerInfo = source; // ä½¿ç”¨ä¼ å…¥çš„æ¥æº
      } else {
        // å¦åˆ™ï¼Œæ‰å°è¯•è·å– JS è°ƒç”¨è€…
        let orange_callerInfo = getCallerInfo();
        callerInfo = extractCleanSource(orange_callerInfo.source);
      }

      let new_message = `${timestamp}[å‰ç«¯æ—¥å¿—][${callerInfo}] ${line}`
      const fullMessage = `${timestamp}[${callerInfo}] ${line}`; // ç»„åˆæ—¶é—´æˆ³å’Œæ¶ˆæ¯

      if (level === 'DEBUG') {
        level_new = 'DEBUG';
        console.debug(new_message);
      } else if (level === 'INFO') {
        level_new = 'INFO';
        console.info(new_message);
      } else if (level === 'ERROR') {
        level_new = 'ERROR';
        console.error(new_message);
      } else if (level === 'WARNING') {
        level_new = 'WARNING';
        console.warn(new_message);
      } else if (level === 'CRITICAL') {
        level_new = 'CRITICAL';
        console.error(new_message);
      } else {
        console.log(new_message);
      }



      // å‘é€åˆ°åç«¯æ—¥å¿—ç³»ç»Ÿï¼ˆä»…åœ¨éç½‘ç»œé”™è¯¯çŠ¶æ€æ—¶å‘é€ï¼‰
      if (!isInNetworkErrorState && source !== 'Backend') {
        try {
          fetch('/api/log_frontend', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Session-ID': sessionUUID || null
            },
            credentials: 'include',
            body: JSON.stringify({
              level: level_new,
              message: line,
              timestamp: timestamp2,
              source: callerInfo
            })
          }).catch(err => {
            // é™é»˜å¤±è´¥ï¼Œé¿å…æ—¥å¿—å‘é€å¤±è´¥å½±å“ä¸»åŠŸèƒ½
            console.error('[æ—¥å¿—å‘é€å¤±è´¥]', err);
          });
        } catch (e) {
          console.error('[æ—¥å¿—å‘é€å¼‚å¸¸]', e);
        }
      }

      // åˆ¤æ–­æ˜¯å¦ä¸ºæ ¸å¿ƒæ—¥å¿—ï¼ˆè·¯å¾„è§„åˆ’ã€æ•°æ®æäº¤ã€ä»»åŠ¡æ‰§è¡Œç­‰æ ¸å¿ƒæ“ä½œï¼‰
      const isCoreLog = (message, logLevel) => {
        // é”™è¯¯å’Œè­¦å‘Šå§‹ç»ˆæ˜¾ç¤º
        if (logLevel === 'ERROR' || logLevel === 'WARNING' || logLevel === 'CRITICAL') {
          return true;
        }

        // æ ¸å¿ƒæ“ä½œå…³é”®è¯
        const coreKeywords = [
          // è·¯å¾„ç›¸å…³
          'è·¯å¾„è§„åˆ’', 'è·¯å¾„ç”Ÿæˆ', 'è‡ªåŠ¨ç”Ÿæˆ', 'å¤„ç†è·¯å¾„', 'æ¸…é™¤è·¯å¾„', 'å½•åˆ¶è·¯å¾„', 'å¯¼å‡ºè·¯å¾„',
          // ä»»åŠ¡æ‰§è¡Œç›¸å…³
          'å¼€å§‹æ‰§è¡Œ', 'æ‰§è¡Œå®Œæˆ', 'æ‰§è¡Œæ‰€æœ‰', 'åœæ­¢æ‰§è¡Œ', 'ä»»åŠ¡å®Œæˆ', 'ä»»åŠ¡å¤±è´¥',
          // æ•°æ®æäº¤ç›¸å…³
          'æäº¤æˆåŠŸ', 'æäº¤å¤±è´¥', 'ä¸Šä¼ æˆåŠŸ', 'ä¸Šä¼ å¤±è´¥', 'æ•°æ®æäº¤',
          // ç™»å½•ç›¸å…³æ ¸å¿ƒæ“ä½œ
          'ç™»å½•æˆåŠŸ', 'ç™»å½•å¤±è´¥', 'ç™»å‡º',
          // å¤šè´¦å·æ¨¡å¼æ ¸å¿ƒæ“ä½œ
          'è¿›å…¥å¤šè´¦å·æ¨¡å¼', 'é€€å‡ºå¤šè´¦å·æ¨¡å¼', 'è´¦å·åˆ—è¡¨',
          // ç­¾åˆ°ç›¸å…³
          'ç­¾åˆ°æˆåŠŸ', 'ç­¾åˆ°å¤±è´¥', 'è¡¥ç­¾',
          // ä»»åŠ¡çŠ¶æ€
          'åŠ è½½ä»»åŠ¡', 'åˆ·æ–°ä»»åŠ¡', 'é€‰æ‹©ä»»åŠ¡',
          // JavaScriptè·¯å¾„è§„åˆ’é˜Ÿåˆ—ç›¸å…³
          '[JS-Queue]'
        ];

        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«æ ¸å¿ƒå…³é”®è¯
        return coreKeywords.some(keyword => message.includes(keyword));
      };

      // åªå°†æ ¸å¿ƒæ—¥å¿—æ˜¾ç¤ºåœ¨ log-tab ä¸­
      // æ‰€æœ‰æ—¥å¿—ä»ç„¶å‘é€åˆ°æ§åˆ¶å°å’Œåç«¯ï¼Œä½†åªæœ‰æ ¸å¿ƒæ—¥å¿—æ˜¾ç¤ºåœ¨ç•Œé¢
      const shouldShowInUI = isCoreLog(line, level);

      if (shouldShowInUI) {
        const single = $('log-text');
        const multi = $('multi-log-text');
        if (single) {
          single.value += fullMessage + '\n'; // ä½¿ç”¨ç»„åˆåçš„æ¶ˆæ¯
          single.scrollTop = single.scrollHeight;
        }
        if (multi) {
          multi.value += fullMessage + '\n'; // ä½¿ç”¨ç»„åˆåçš„æ¶ˆæ¯
          multi.scrollTop = multi.scrollHeight;
        }
      }
    }

    function logMessage_Debug(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'DEBUG');
    }

    function logMessage_Info(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'INFO');
    }

    function logMessage_Warning(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'WARNING');
    }

    function logMessage_Error(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'ERROR');
    }

    function logMessage_Critical(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'CRITICAL');
    }

    function showTab(tabName, element) {
      // ========== ä»»åŠ¡27ï¼šåˆ‡æ¢tabæ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–° ==========
      // å¦‚æœåˆ‡æ¢åˆ°éattendance tabï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
      if (tabName !== 'attendance' && notificationAutoRefreshTimer) {
        clearTimeout(notificationAutoRefreshTimer);
        notificationAutoRefreshTimer = null;
        logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] å·²åœæ­¢ï¼ˆåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾ï¼‰');
      }
      // ==========================================

      ['run-control', 'path-tools', 'history', 'params', 'log', 'checkpoints', 'attendance'].forEach(name => {
        $(`${name}-tab`).classList.add('hidden');
        const b = document.querySelector(`button[onclick="showTab('${name}', this)"]`);
        if (b) b.classList.remove('active');
      });
      $(`${tabName}-tab`).classList.remove('hidden');
      if (element) element.classList.add('active');
      if (tabName === 'attendance') {
        // refreshNotificationsUI() ä¼šè·å–æœ€æ–°é€šçŸ¥
        // onNotificationsUpdated() (ç”±åå°è°ƒç”¨æˆ– refreshNotificationsUI é—´æ¥è°ƒç”¨) ä¼šå¡«å…… attendance-list
        // refreshNotificationsUI() è‡ªå¸¦é˜²æŠ–ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨æ˜¯å®‰å…¨çš„
        logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] åˆ‡æ¢åˆ°ç­¾åˆ°æ ‡ç­¾ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
        refreshNotificationsUI(true, false); // åˆ‡æ¢tabè§†ä¸ºè‡ªåŠ¨åˆ·æ–°ï¼Œå°†å¼€å¯å®šæ—¶åˆ·æ–°
      }
    }



    function autoLogin(user, pass) {
      if (!user || !pass) return;
      const userCombo = $('user-combo');
      userCombo.addEventListener('focus', refreshUserList);
      userCombo.addEventListener('click', refreshUserList);
      if ([...userCombo.options].some(o => o.value === user)) userCombo.value = user;
      else { const opt = document.createElement('option'); opt.value = opt.textContent = user; userCombo.appendChild(opt); userCombo.value = user; }
      $('username-entry').value = user; $('password-entry').value = pass;
      onUserChange().then(() => $('login-button').click());
    }


    function createParamInputs(container, prefix, changeHandler, excludeGroups = []) {
      container.innerHTML = '';

      // é»˜è®¤æ’é™¤â€œè‡ªåŠ¨ç­¾åˆ°â€ç»„ï¼Œå› ä¸ºå®ƒåœ¨ä¸“å±Tabé‡Œ
      let finalExclude = [...excludeGroups];
      if (prefix !== 'multi-param') {
        finalExclude.push("è‡ªåŠ¨ç­¾åˆ°");
      }

      paramGroups.forEach((group, index) => {
        // å¦‚æœå½“å‰åˆ†ç»„çš„æ ‡é¢˜åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œåˆ™è·³è¿‡
        if (finalExclude.includes(group.title)) {
          return;
        }
        // å¦‚æœå½“å‰åˆ†ç»„çš„æ ‡é¢˜åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œåˆ™è·³è¿‡
        if (excludeGroups.includes(group.title)) {
          return;
        }

        const header = document.createElement('h3');
        const marginTopClass = index === 0 ? '' : 'mt-4';
        header.className = `text-base font-bold text-sky-700 ${marginTopClass} mb-2 border-b border-slate-200 pb-1`;
        header.textContent = group.title;
        container.appendChild(header);

        for (const key of group.keys) {
          const def = paramDefs[key];
          if (!def) continue;

          const div = document.createElement('div');
          div.className = 'text-sm mb-3';

          const step = (key.endsWith('_s') || key.endsWith('_mps')) ? '0.1' : '1';
          const unitHtml = def.unit ? `<span class="ml-2 text-xs text-slate-500 select-none">${def.unit}</span>` : '';

          // æ ¹æ®è‡ªå®šä¹‰ type å†³å®šæ¸²æŸ“å“ªä¸ª UI
          if (def.type === 'theme_selector') {
            div.innerHTML = `
          <label class="block text-slate-700 font-semibold">${def.label}</label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
          <div class="grid grid-cols-3 gap-2 mt-2">
              <button onclick="setThemeStyle('default')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">é»˜è®¤</button>
              <button onclick="setThemeStyle('theme-anime')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">äºŒæ¬¡å…ƒ</button>
              <button onclick="setThemeStyle('theme-minimalist')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">ç®€çº¦</button>
          </div>
        `;
          } else if (def.type === 'color_picker') {
            div.innerHTML = `
          <label for="${prefix}-${key}" class="block text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center gap-3 mt-1">
            <input type="color" id="${prefix}-${key}-picker" data-key="${key}" class="w-10 h-10 rounded-full cursor-pointer border-2 border-white shadow-md" title="ç‚¹å‡»é€‰æ‹©é¢œè‰²">
            <input type="text" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" placeholder="#7dd3fc" title="${def.help}">
            <button onclick="resetBaseColorToDefault('${prefix}')" class="btn btn-ghost !py-1 !px-3 !text-xs flex-shrink-0">æ¢å¤é»˜è®¤</button>
          </div>
           <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
          } else if (def.type === 'checkbox' || key === 'api_fallback_line' || key === 'ignore_task_time') {
            div.innerHTML = `
          <label class="flex items-center gap-2 cursor-pointer" title="${def.help}">
            <input type="checkbox" id="${prefix}-${key}" data-key="${key}" class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0">
            <span class="text-slate-700 font-semibold">${def.label}</span>
          </label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
          } else {
            div.innerHTML = `
          <label for="${prefix}-${key}" class="block mb-1 text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center">
            <input type="number" step="${step}" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" title="${def.help}">
            ${unitHtml}
          </div>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
          }

          container.appendChild(div);

          // ä¸ºæ‰€æœ‰ input ç»‘å®š change äº‹ä»¶
          const inputs = div.querySelectorAll('input');
          inputs.forEach(input => {
            if (input.type === 'color') {
              // é¢œè‰²é€‰æ‹©å™¨ä½¿ç”¨ input äº‹ä»¶å®ç°å®æ—¶é¢„è§ˆ
              input.addEventListener('input', (e) => {
                const hexColor = e.target.value;
                const textInput = document.getElementById(`${prefix}-${key}`);
                if (textInput) textInput.value = hexColor;
                setBaseColor(hexColor, hexColor); // å®æ—¶æ›´æ–°
              });
              // change äº‹ä»¶ç”¨äºæœ€ç»ˆç¡®è®¤å¹¶ä¿å­˜
              input.addEventListener('change', changeHandler);
            } else if (input.type === 'text' && key === 'theme_base_color') {
              // æ–‡æœ¬æ¡†ä¹Ÿè”åŠ¨é¢œè‰²é€‰æ‹©å™¨å’Œä¸»é¢˜è‰²
              input.addEventListener('change', (e) => {
                const hexColor = e.target.value;
                const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
                if (colorPicker) colorPicker.value = hexColor;
                setBaseColor(hexColor, hexColor);
                changeHandler(e); // è§¦å‘ä¿å­˜
              });
            } else {
              input.addEventListener('change', changeHandler);
            }
          });
        }
      });
    }


    function updateParamInputs(container, prefix, params) {
      for (const key of Object.keys(paramDefs)) {
        const input = document.getElementById(`${prefix}-${key}`);
        if (!input || !params) continue;
        if (!(key in params)) continue;
        if (input.type === 'checkbox') {
          input.checked = Boolean(params[key]);
        } else {
          input.value = params[key];
          // å¦‚æœæ˜¯é¢œè‰²å‚æ•°ï¼Œé¢å¤–æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
          if (key === 'theme_base_color') {
            const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
            if (colorPicker) {
              colorPicker.value = params[key];
            }
          }
        }
      }
    }



    function onParamChange(event) {
      const key = event.target.dataset.key;
      let value;
      if (event.target.type === 'checkbox') value = event.target.checked;
      else value = event.target.value;
      pythonParams[key] = value;
      callPythonAPI('update_param', key, value);

      // ä¿®å¤ï¼šå¦‚æœâ€œå¿½ç•¥æ—¶é—´â€å‚æ•°è¢«æ›´æ”¹ï¼Œç«‹å³åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ›´æ–° info_text
      if (key === 'ignore_task_time') {
        logMessage_Info("å‚æ•° 'ignore_task_time' å·²æ›´æ”¹ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...");
        refreshTasks();
      }
    }

    function onGlobalParamChange(event) {
      const key = event.target.dataset.key;
      let value = event.target.type === 'checkbox' ? event.target.checked : event.target.value;
      pythonParams[key] = value;
      callPythonAPI('update_param', key, value);
    }

    async function openAccountParamsModal(username) {
      const result = await callPythonAPI('multi_get_account_params', username);
      if (!result.success) { showModalAlert(result.message); return; }

      $('account-params-title').textContent = `[${username}] å‚æ•°è®¾ç½®`;
      const container = $('account-params-container');
      // è°ƒç”¨ createParamInputs æ—¶ï¼Œä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ’é™¤â€œä¸»é¢˜ä¸å¤–è§‚â€åˆ†ç»„
      createParamInputs(container, 'acc-param', () => { }, ['ä¸»é¢˜ä¸å¤–è§‚']);
      updateParamInputs(container, 'acc-param', result.params);

      $('save-account-params-btn').onclick = async () => {
        const inputs = container.querySelectorAll('input');
        for (const input of inputs) {
          const key = input.dataset.key;
          const value = input.type === 'checkbox' ? input.checked : input.value;
          await callPythonAPI('multi_update_account_param', username, key, value);
        }
        // å…³é—­æ—¶ç§»é™¤æ ·å¼ä¸ body æ ‡è®°
        const modal = $('account-params-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-visible');
      };

      // æ˜¾ç¤ºå¹¶å±…ä¸­
      const modal = $('account-params-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');             // ç¡®ä¿å±…ä¸­
      document.body.classList.add('modal-visible');  // éšè—åœ°å›¾ç‰ˆæƒ
    }



    function toggleUserDetails(show) {
      const modal = $('user-details-modal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);
      const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;
      if (show) {
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        document.body.classList.add('modal-visible');
      } else {
        // å…³é—­æ¨¡æ€æ—¶æ¢å¤åŒå‡»ç¼©æ”¾
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
        document.body.classList.remove('modal-visible');
      }
    }


    function toggleTaskDetails(show) {
      const modal = $('task-details-modal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);

      const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;

      if (show) {
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        // æ‰“å¼€ä»»åŠ¡è¯¦æƒ…æ—¶ä¹Ÿæ ‡è®° bodyï¼Œä»¥è§¦å‘ç‰ˆæƒéšè—æ ·å¼
        document.body.classList.add('modal-visible');
      } else {
        // å…³é—­æ¨¡æ€æ—¶æ¢å¤åŒå‡»ç¼©æ”¾
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
        // å…³é”®ï¼šå…³é—­æ—¶å»é™¤æ ‡è®°ï¼Œæ¢å¤ç‰ˆæƒæ˜¾ç¤º
        document.body.classList.remove('modal-visible');
      }
    }

    function showUserDetails() {
      if (!currentUserData || !currentUserData.student_id) { showModalAlert('è¯·å…ˆæˆåŠŸç™»å½•'); return; }
      const info = currentUserData;
      const content = $('user-details-content'); content.innerHTML = '';
      const kv = { 'å§“å': info.name, 'å­¦å·': info.student_id, 'ç”¨æˆ·å': info.username, 'æ€§åˆ«': info.gender, 'å­¦æ ¡': info.school_name, 'å±æ€§': info.attribute_type, 'æ‰‹æœºå·': info.phone, 'ç”¨æˆ·ID': info.id, 'èº«ä»½è¯å·': info.id_card, 'æ³¨å†Œæ—¶é—´': info.registration_time, 'é¦–æ¬¡ç™»å½•': info.first_login_time, 'ä¸Šæ¬¡ç™»å½•': info.last_login_time, 'å½“å‰ç™»å½•': info.current_login_time };
      Object.entries(kv).forEach(([k, v]) => { const p = document.createElement('p'); p.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">${k}:</span><span class="break-all">${v || 'NULL'}</span>`; content.appendChild(p); });

      // ç¦»çº¿æ¨¡å¼ä¸‹å›ºå®šæ˜¾ç¤ºæ—  UAï¼›å¦åˆ™ä»ç™»å½•æ—¶ä¿å­˜çš„ currentSessionUA å˜é‡ä¸­è¯»å–
      const uaText = IS_OFFLINE ? 'NULL' : (currentSessionUA || 'NULL');
      const p_ua = document.createElement('p');
      // ä¸å…¶ä»–è¡Œä¸€è‡´ï¼šæ ‡ç­¾å·¦å¯¹é½ï¼Œç§»é™¤ align-top å’Œä¸å¿…è¦çš„å®½åº¦è°ƒæ•´
      p_ua.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">UA:</span><span class="break-all">${uaText}</span>`;
      content.appendChild(p_ua);


      toggleUserDetails(true);
    }

    function showTaskDetails() {
      if (!currentRunData || !currentRunData.run_name) { showModalAlert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡'); return; }
      const content = $('task-details-content'); content.innerHTML = '';
      const kv = { 'ä»»åŠ¡åç§°': currentRunData.run_name, 'ä»»åŠ¡çŠ¶æ€': currentRunData.status == 1 ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ', 'ä»»åŠ¡ID': currentRunData.errand_id, 'è®¡åˆ’ID': currentRunData.errand_schedule, 'å¼€å§‹æ—¶é—´': currentRunData.start_time, 'ç»“æŸæ—¶é—´': currentRunData.end_time, 'ä¸Šä¼ æ—¶é—´': currentRunData.upload_time };
      Object.entries(kv).forEach(([k, v]) => { const p = document.createElement('p'); p.innerHTML = `<span class="font-bold w-28 inline-block text-left pr-2 text-slate-500">${k}:</span><span>${v || 'NULL'}</span>`; content.appendChild(p); });
      const tpTitle = document.createElement('p'); tpTitle.className = 'font-bold text-slate-500 mt-2'; tpTitle.textContent = 'æ‰“å¡ç‚¹åˆ—è¡¨:'; content.appendChild(tpTitle);
      (currentRunData.target_points || []).forEach((p, i) => {
        const name = (currentRunData.target_point_names || "").split('|')[i] || `æ‰“å¡ç‚¹${i + 1}`;
        const div = document.createElement('div'); div.className = 'flex items-center gap-2 text-slate-600 ml-4';
        const numSpan = document.createElement('span'); numSpan.className = 'font-mono w-6 inline-block'; numSpan.textContent = `${i + 1}.`;
        const nameSpan = document.createElement('span'); nameSpan.textContent = name;
        const coordsSpan = document.createElement('span'); coordsSpan.className = 'text-xs text-slate-400'; coordsSpan.textContent = `(${p[0].toFixed(5)}, ${p[1].toFixed(5)})`;
        div.append(numSpan, nameSpan, coordsSpan);
        content.appendChild(div);
      });
      toggleTaskDetails(true);
    }


    function toggleNotifications(show, forceDisableMap = false) {
      const modal = $('notifications-modal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);

      const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;

      if (show) {
        // æ‰“å¼€æ¨¡æ€æ¡†ï¼šæ€»æ˜¯ç¦ç”¨åœ°å›¾
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        document.body.classList.add('modal-visible');
      } else {
        // å…³é—­æ¨¡æ€æ¡†ï¼š
        if (forceDisableMap) {
          // å¦‚æœæ˜¯â€œæ‰‹åŠ¨é€‰ç‚¹â€è°ƒç”¨çš„ï¼Œä¿æŒåœ°å›¾ç¦ç”¨çŠ¶æ€
          if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        } else {
          // å¦åˆ™ï¼ˆä¾‹å¦‚ç‚¹å‡»èƒŒæ™¯ã€å…³é—­æŒ‰é’®ï¼‰ï¼Œæ¢å¤åœ°å›¾
          if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
        }
        document.body.classList.remove('modal-visible');
      }
    }

    async function fetchNotifications(limit = null, offset = 0) {
      logMessage_Debug("å¼€å§‹åˆ·æ–°é€šçŸ¥", { limit, offset });
      const badge = $('notification-badge');
      let result = null; // <-- 1. å¿…é¡»åœ¨å‡½æ•°é¡¶éƒ¨å£°æ˜
      try {
        // æ„å»ºAPIå‚æ•°
        const params = {};
        if (limit !== null) {
          params.request_limit = limit;
          params.request_offset = offset;
        }

        result = await callPythonAPI('get_notifications', params); // <-- 2. åœ¨ try å—ä¸­èµ‹å€¼ (ä¸ä½¿ç”¨ const/let)

        // 3. æ£€æŸ¥ result æ˜¯å¦ä¸º null (é˜²æ­¢ç½‘ç»œé”™è¯¯)
        if (result && result.success) {

          if (offset === 0) {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ‰¹ (offset=0)ï¼Œåˆ™*æ›¿æ¢*å…¨å±€ç¼“å­˜
            window.currentNotifications = result.notices || [];
          } else {
            // å¦‚æœæ˜¯åç»­æ‰¹æ¬¡ï¼Œåˆ™*è¿½åŠ *åˆ°å…¨å±€ç¼“å­˜
            window.currentNotifications = (window.currentNotifications || []).concat(result.notices || []);
          }

          // æ›´æ–°å¾½ç« 
          if (result.unreadCount > 0) {
            badge.textContent = result.unreadCount > 9 ? '9+' : result.unreadCount;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
          // å¦‚æœæ²¡æœ‰æŒ‡å®šlimitï¼Œæˆ–è€…è¿™æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œç¼“å­˜é€šçŸ¥æ•°æ®
          if (limit === null || offset === 0) {
            window.currentNotifications = result.notices || [];
          } else {
            // å¦åˆ™è¿½åŠ åˆ°ç°æœ‰æ•°æ®
            window.currentNotifications = (window.currentNotifications || []).concat(result.notices || []);
          }
        } else {
          badge.classList.add('hidden');
        }
      } catch (e) {
        logMessage_Error("Fetch notifications failed", e);
        badge.classList.add('hidden');
      }
      return result; // <-- 4. ç°åœ¨å¯ä»¥å®‰å…¨è¿”å›
    }
    // ========== ä»»åŠ¡27ï¼šé€šçŸ¥åˆ·æ–°ä¿®å¤ ==========
    // æ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨å˜é‡
    let notificationAutoRefreshTimer = null;

    /**
     * åˆ·æ–°é€šçŸ¥åˆ—è¡¨
     * @param {boolean} useCache - æ˜¯å¦ä½¿ç”¨ç¼“å­˜
     * @param {boolean} isManual - æ˜¯å¦ä¸ºæ‰‹åŠ¨åˆ·æ–°ï¼ˆtrue=æ‰‹åŠ¨ç‚¹å‡»ï¼Œfalse=è‡ªåŠ¨åˆ·æ–°ï¼‰
     */
    async function refreshNotificationsUI(useCache = true, isManual = false) {
      // --- é˜²æ­¢é‡å¤ç‚¹å‡» ---
      if (isRefreshingNotifications) {
        logMessage_Info("Notification refresh already in progress. Skipping.");
        return; // å¦‚æœå·²åœ¨åˆ·æ–°ï¼Œåˆ™ç›´æ¥é€€å‡º
      }
      isRefreshingNotifications = true; // è®¾ç½® "in-flight" æ ‡å¿—
      // --- ç»“æŸä¿®å¤ ---

      const content = $('notifications-content');
      const refreshBtn = $('refresh-notifications-btn');
      const markReadBtn = $('mark-all-read-btn');

      // 1. è®¾ç½®åŠ è½½çŠ¶æ€
      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
      }
      if (markReadBtn) markReadBtn.disabled = true;

      try {
        // å¦‚æœå¯ç”¨ç¼“å­˜ï¼Œå…ˆå°è¯•æ˜¾ç¤ºç¼“å­˜çš„é€šçŸ¥
        let cachedDisplayed = false;
        if (useCache && content) { // <--- ä¿®æ­£ #1: æ£€æŸ¥ content æ˜¯å¦å­˜åœ¨
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½ç¼“å­˜é€šçŸ¥...</p>';

          try {
            const cachedResult = await callPythonAPI('get_cached_notifications');
            if (cachedResult && cachedResult.success && cachedResult.cached && cachedResult.notices.length > 0) {
              logMessage_Info(`æ˜¾ç¤ºç¼“å­˜çš„ ${cachedResult.notices.length} æ¡é€šçŸ¥`);
              content.innerHTML = '';
              renderNotificationBatch(cachedResult.notices, content);
              cachedDisplayed = true;

              // æ›´æ–°å¾½ç« 
              const badge = $('notification-badge');
              if (cachedResult.unreadCount > 0) {
                badge.textContent = cachedResult.unreadCount > 9 ? '9+' : cachedResult.unreadCount;
                badge.classList.remove('hidden');
              } else {
                badge.classList.add('hidden');
              }

              // æ›´æ–°æŒ‰é’®çŠ¶æ€
              const hasUnread = cachedResult.notices.some(n => n.isRead == 0 || n.isRead === false);
              if (markReadBtn) markReadBtn.disabled = !hasUnread;

              // æ˜¾ç¤º"æ­£åœ¨åˆ·æ–°"æç¤º
              const refreshingIndicator = document.createElement('div');
              refreshingIndicator.id = 'refreshing-indicator';
              refreshingIndicator.className = 'p-3 text-center text-slate-400 text-sm';
              refreshingIndicator.innerHTML = 'æ­£åœ¨åˆ·æ–°æœ€æ–°é€šçŸ¥...';
              if (content) content.appendChild(refreshingIndicator);
            }
          } catch (e) {
            logMessage_Warning("è·å–ç¼“å­˜é€šçŸ¥å¤±è´¥ï¼Œå°†ç›´æ¥åŠ è½½æœ€æ–°é€šçŸ¥", e);
          }
        }

        if (!cachedDisplayed && content) {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½å‰5æ¡é€šçŸ¥...</p>';
        }

        // ã€ä¼˜åŒ–ã€‘æ­¥éª¤2ï¼šæ¸è¿›å¼åˆ†æ®µåŠ è½½æœ€æ–°é€šçŸ¥
        let currentOffset = 0;
        const batchSize = 5;
        let hasMore = true;
        let firstLoad = true;
        let finalResult = null; // ä¿®æ­£ï¼šç”¨äºå­˜å‚¨ç¬¬ä¸€ä¸ªæ‰¹æ¬¡çš„ç»“æœï¼ˆåŒ…å«æ­£ç¡®çš„è§’æ ‡æ•°ï¼‰

        // ========== ä»»åŠ¡27ï¼šè‡ªåŠ¨åˆ·æ–°é€»è¾‘ï¼ˆé‡æ„ä¸ºå‡½æ•°ï¼‰ ==========
        function startAutoRefreshTimer() {
          // å¦‚æœä¸æ˜¯æ‰‹åŠ¨åˆ·æ–°ï¼Œè®¾ç½®ä¸‹ä¸€æ¬¡è‡ªåŠ¨åˆ·æ–°
          if (!isManual) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            if (notificationAutoRefreshTimer) {
              clearTimeout(notificationAutoRefreshTimer);
              notificationAutoRefreshTimer = null;
            }

            // è·å–åˆ·æ–°é—´éš”å‚æ•°ï¼ˆä¸¥æ ¼ä½¿ç”¨param-auto_attendance_refresh_sï¼‰
            const refreshIntervalInput = $('param-auto_attendance_refresh_s');
            const refreshInterval = refreshIntervalInput ? parseInt(refreshIntervalInput.value) : 300; // é»˜è®¤300ç§’

            // è®¾ç½®ä¸‹ä¸€æ¬¡è‡ªåŠ¨åˆ·æ–°ï¼ˆä½¿ç”¨é…ç½®çš„é—´éš”ï¼Œå•ä½ï¼šç§’ï¼‰
            if (refreshInterval > 0) {
              // ä¼˜åŒ–ï¼šåœ¨æ—¥å¿—ä¸­æ˜ç¡®æŒ‡å‡ºæ˜¯â€œåŠ è½½å®Œæˆâ€åå¼€å§‹è®¡æ—¶
              logMessage_Info(`[è‡ªåŠ¨åˆ·æ–°] (åŠ è½½å®Œæˆ) å°†åœ¨ ${refreshInterval} ç§’åè‡ªåŠ¨åˆ·æ–°é€šçŸ¥`);
              notificationAutoRefreshTimer = setTimeout(() => {
                logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] æ­£åœ¨è‡ªåŠ¨åˆ·æ–°é€šçŸ¥...');
                refreshNotificationsUI(true, false); // useCache=true, isManual=false
              }, refreshInterval * 1000); // è½¬æ¢ä¸ºæ¯«ç§’
            }
          }
        }
        // ==========================================

        // å®šä¹‰é€’å½’åŠ è½½å‡½æ•°
        const loadNextBatch = async () => {
          if (!hasMore) {
            // --- ä¿®æ­£ï¼šæ‰€æœ‰æ‰¹æ¬¡åŠ è½½å®Œæˆ ---
            // åœ¨è¿™é‡Œï¼ˆè€Œä¸æ˜¯å¾ªç¯ä¸­ï¼‰è°ƒç”¨ onNotificationsUpdated
            // ä¼ é€’ finalResultï¼Œå› ä¸ºå®ƒåŒ…å«äº†æ­£ç¡®çš„ unreadCount
            if (finalResult) {
              onNotificationsUpdated(finalResult);
            }
            logMessage_Info("æ‰€æœ‰é€šçŸ¥åŠ è½½å®Œæˆï¼ˆæ¨¡æ€æ¡†ï¼‰");
            // --- ä¿®æ­£ç»“æŸ ---


            startAutoRefreshTimer(); // <--- ä¼˜åŒ–ï¼šåœ¨æ­¤å¤„ï¼ˆåŠ è½½å®Œæˆæ—¶ï¼‰å¯åŠ¨è®¡æ—¶å™¨

            return;
          }

          logMessage_Info(`æ­£åœ¨åŠ è½½é€šçŸ¥ï¼šoffset=${currentOffset}, limit=${batchSize}`);
          const result = await fetchNotifications(batchSize, currentOffset);

          // ä¿®æ­£ï¼šä¿å­˜ç¬¬ä¸€ä¸ªæ‰¹æ¬¡çš„ç»“æœ
          if (firstLoad) {
            finalResult = result;
          }


          if (!result || !result.success) {
            if (firstLoad && !cachedDisplayed) {
              content.innerHTML = '<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
            return;
          }

          const notices = result.notices || [];

          if (firstLoad && content) { // <--- ä¿®æ­£ #5: æ£€æŸ¥ content æ˜¯å¦å­˜åœ¨
            // é¦–æ¬¡åŠ è½½æ–°æ•°æ®ï¼Œæ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼ˆåŒ…æ‹¬ç¼“å­˜æˆ–"æ­£åœ¨åŠ è½½"æç¤ºï¼‰
            content.innerHTML = '';
            firstLoad = false;
            logMessage_Info(`é¦–æ‰¹æ–°é€šçŸ¥åŠ è½½å®Œæˆï¼Œ${cachedDisplayed ? 'å·²æ›¿æ¢' : 'æ­£åœ¨æ˜¾ç¤º'}ç¼“å­˜æ•°æ®`);
          }

          if (notices.length === 0 && currentOffset === 0 && content) { // <--- ä¿®æ­£ #6: æ£€æŸ¥ content æ˜¯å¦å­˜åœ¨
            content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— é€šçŸ¥</p>';
            if (markReadBtn) markReadBtn.disabled = true;
            return;
          }

          // ç§»é™¤ä¹‹å‰çš„"æ­£åœ¨åŠ è½½æ›´å¤š"æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const oldIndicator = $('loading-more-indicator');
          if (oldIndicator) {
            oldIndicator.remove();
          }

          // æ¸²æŸ“è¿™ä¸€æ‰¹é€šçŸ¥
          if (notices.length > 0 && content) { // <--- ä¿®æ­£ #7: æ£€æŸ¥ content æ˜¯å¦å­˜åœ¨
            logMessage_Info(`ç¬¬${Math.floor(currentOffset / batchSize) + 1}æ‰¹åŠ è½½å®Œæˆï¼šæ˜¾ç¤º ${notices.length} æ¡é€šçŸ¥`);
            renderNotificationBatch(notices, content);

            // æ›´æ–°æœªè¯»æŒ‰é’®çŠ¶æ€
            const allNotices = window.currentNotifications || [];
            const hasUnread = allNotices.some(n => n.isRead == 0 || n.isRead === false);
            if (markReadBtn) markReadBtn.disabled = !hasUnread;
          }

          // æ›´æ–°åç§»é‡å’Œæ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
          currentOffset += batchSize;
          hasMore = result.hasMore || false;

          // å¦‚æœè¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œæ˜¾ç¤º"æ­£åœ¨åŠ è½½æ›´å¤š"æç¤ºï¼Œå¹¶ç»§ç»­åŠ è½½
          if (hasMore && content) { // <--- ä¿®æ­£ #8: æ£€æŸ¥ content æ˜¯å¦å­˜åœ¨
            const loadingMore = document.createElement('div');
            loadingMore.id = 'loading-more-indicator';
            loadingMore.className = 'p-3 text-center text-slate-400 text-sm';
            loadingMore.innerHTML = 'æ­£åœ¨åŠ è½½æ›´å¤šé€šçŸ¥...';
            content.appendChild(loadingMore);

            // çŸ­æš‚å»¶è¿ŸååŠ è½½ä¸‹ä¸€æ‰¹ï¼ˆè®©ç”¨æˆ·çœ‹åˆ°å‰ä¸€æ‰¹çš„å†…å®¹ï¼‰
            setTimeout(loadNextBatch, 100);
          } else {
            // --- æ‰€æœ‰æ‰¹æ¬¡åŠ è½½å®Œæˆ ---
            if (finalResult) {
              onNotificationsUpdated(finalResult);
            }
            logMessage_Info("æ‰€æœ‰é€šçŸ¥åŠ è½½å®Œæˆï¼ˆæ¨¡æ€æ¡†ï¼‰");
            // --- ä¿®æ­£ç»“æŸ ---

            startAutoRefreshTimer(); // <--- ä¼˜åŒ–ï¼šåœ¨æ­¤å¤„ï¼ˆåŠ è½½å®Œæˆæ—¶ï¼‰å¯åŠ¨è®¡æ—¶å™¨
          }

          // [å·²åˆ é™¤] ç§»é™¤åœ¨ç¬¬ä¸€æ‰¹åŠ è½½åå°±è°ƒç”¨ onNotificationsUpdated çš„é”™è¯¯é€»è¾‘
          // if (currentOffset === batchSize && result.success) {
          //   onNotificationsUpdated(result);
          // }
        };

        // å¼€å§‹åŠ è½½ç¬¬ä¸€æ‰¹
        await loadNextBatch();


      } catch (e) {
        logMessage_Error("Failed to refresh notifications UI", e);
        content.innerHTML = '<p class="text-red-500 text-center py-10">åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
      } finally {
        // 4. æ¢å¤æŒ‰é’®çŠ¶æ€
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'åˆ·æ–°';
        }
        isRefreshingNotifications = false;

        // ========== ä»»åŠ¡27ï¼šè‡ªåŠ¨åˆ·æ–°é€»è¾‘ä¿®å¤ ==========
        // // å¦‚æœä¸æ˜¯æ‰‹åŠ¨åˆ·æ–°ï¼Œè®¾ç½®ä¸‹ä¸€æ¬¡è‡ªåŠ¨åˆ·æ–°
        // if (!isManual) {
        //   // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
        //   if (notificationAutoRefreshTimer) {
        //     clearTimeout(notificationAutoRefreshTimer);
        //     notificationAutoRefreshTimer = null;
        //   }

        //   // è·å–åˆ·æ–°é—´éš”å‚æ•°ï¼ˆä¸¥æ ¼ä½¿ç”¨param-auto_attendance_refresh_sï¼‰
        //   const refreshIntervalInput = $('param-auto_attendance_refresh_s');
        //   const refreshInterval = refreshIntervalInput ? parseInt(refreshIntervalInput.value) : 300; // é»˜è®¤300ç§’

        //   // è®¾ç½®ä¸‹ä¸€æ¬¡è‡ªåŠ¨åˆ·æ–°ï¼ˆä½¿ç”¨é…ç½®çš„é—´éš”ï¼Œå•ä½ï¼šç§’ï¼‰
        //   if (refreshInterval > 0) {
        //     logMessage_Info(`[è‡ªåŠ¨åˆ·æ–°] å°†åœ¨ ${refreshInterval} ç§’åè‡ªåŠ¨åˆ·æ–°é€šçŸ¥`);
        //     notificationAutoRefreshTimer = setTimeout(() => {
        //       logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] æ­£åœ¨è‡ªåŠ¨åˆ·æ–°é€šçŸ¥...');
        //       refreshNotificationsUI(true, false); // useCache=true, isManual=false
        //     }, refreshInterval * 1000); // è½¬æ¢ä¸ºæ¯«ç§’
        //   }
        // }
        // ==========================================
      }
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“ä¸€æ‰¹é€šçŸ¥
    function renderNotificationBatch(notices, container) {
      if (!notices || notices.length === 0) return;

      for (const n of notices) {
        const item = document.createElement('div');
        item.className = 'p-3 border-b border-slate-200';
        item.id = `notice-${n.id}`;

        const isEffectivelyRead = (n.isRead == 1 || n.isRead === true);
        const isReadClass = isEffectivelyRead ? 'opacity-60' : 'font-bold';

        // 1. "è®¾ä¸ºå·²è¯»"æŒ‰é’®
        let readButtonHtml = '';
        if (!isEffectivelyRead) {
          readButtonHtml = `<button class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600" onclick="markAsRead(event, '${n.id}')">è®¾ä¸ºå·²è¯»</button>`;
        }

        // 2. ç­¾åˆ°çŠ¶æ€/æŒ‰é’® (ä½¿ç”¨åç«¯æ–°é€»è¾‘)
        let attendanceHtml = '';
        const isAttendanceTask = (n.image === 'attendance') || (n.title && n.title.includes('ç­¾åˆ°'));

        if (isAttendanceTask && n.id) {
          switch (n.attendance_code) {
            case -1:
              try {
                const coordsStr = (n.updateBy || "").trim();
                const [lat, lon] = coordsStr.split(',').map(Number);

                // ä¿®æ­£ï¼šä½¿ç”¨ if æ£€æŸ¥æ›¿æ¢ throw new Error
                if (isNaN(lon) || isNaN(lat)) {
                  attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span> <span class="text-xs text-slate-400">(åæ ‡æ— æ•ˆ)</span>`;
                } else {
                  const targetCoords = `[${lon}, ${lat}]`;
                  attendanceHtml = `
                      <span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span>
                      <div class="relative inline-block group">
                        <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="è¡¥ç­¾æ­¤ä»»åŠ¡">
                          <span>è¡¥ç­¾</span>
                          <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                        </button>
                        <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                          <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">éšæœºè¡¥ç­¾</button>
                          <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾</button>
                        </div>
                      </div>
                    `;
                }
              } catch (e) {
                attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span> <span class="text-xs text-slate-400">(åæ ‡è§£æå¤±è´¥)</span>`;
              }
              break;
            case 1:
              attendanceHtml = `<span class="text-xs font-semibold text-emerald-600 px-2 py-0.5 rounded-full bg-emerald-100">å·²ç­¾åˆ°</span>`;
              break;
            case 0:
              try {
                const coordsStr = (n.updateBy || "").trim();
                const [lat, lon] = coordsStr.split(',').map(Number);

                if (!isNaN(lon) && !isNaN(lat)) {
                  const rollCallId = n.id;
                  const targetCoords = `[${lon}, ${lat}]`;

                  attendanceHtml = `
                    <div class="relative inline-block group">
                      <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                        <span>ç­¾åˆ°</span>
                        <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                      </button>
                      <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                        <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${rollCallId}', ${targetCoords})">éšæœºç­¾åˆ°</button>
                        <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${rollCallId}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹</button>
                      </div>
                    </div>
                    <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${rollCallId}', ${targetCoords})">
                      è¡¥ç­¾
                    </button>
                  `;
                } else {
                  attendanceHtml = `<span class="text-xs text-slate-400">åæ ‡æ— æ•ˆ</span>`;
                }
              } catch (e) {
                logMessage_Error("è§£æç­¾åˆ°åæ ‡å¤±è´¥:", e, n.updateBy);
                attendanceHtml = `<span class="text-xs text-red-500">æ•°æ®é”™è¯¯</span>`;
              }
              break;
            default:
              attendanceHtml = `<span class="text-xs text-slate-400">çŠ¶æ€æœªçŸ¥</span>`;
          }
        }

        // 3. ç»„è£…
        item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-base text-slate-800 ${isReadClass}">${n.title}</span>
            <div class="flex items-center gap-2">
              ${readButtonHtml}
              ${attendanceHtml}
              <span class="text-xs text-slate-500 flex-shrink-0">${n.createtime}</span>
            </div>
          </div>
          <p class="text-sm text-slate-600 mt-1 ${isReadClass}">${n.content}</p>
        `;
        container.appendChild(item);
      }
    }

    function showNotifications() {
      // 1. æ‰“å¼€æ¨¡æ€æ¡†
      toggleNotifications(true);

      // 2. è§¦å‘UIåˆ·æ–°
      // ä¿®æ­£ï¼šå°† isManual è®¾ç½®ä¸º trueã€‚
      // æ‰“å¼€æ¨¡æ€æ¡†æ˜¯ä¸€ä¸ªç”¨æˆ·æ‰‹åŠ¨æ“ä½œï¼Œå®ƒä¸åº”è¯¥å¯åŠ¨ä¸€ä¸ªæ–°çš„è‡ªåŠ¨åˆ·æ–°å¾ªç¯ã€‚
      // è‡ªåŠ¨åˆ·æ–°å¾ªç¯ç”± main.py ä¸­çš„ _auto_refresh_worker ç»Ÿä¸€ç®¡ç†ã€‚
      refreshNotificationsUI(true, true);
    }

    /**
     * ç”±åç«¯è‡ªåŠ¨åˆ·æ–°çº¿ç¨‹è°ƒç”¨
     * @param {object} result - åç«¯ get_notifications è¿”å›çš„ç»“æœ
     */
    function onNotificationsUpdated(result) {
      if (!result || !result.success) {
        logMessage_Info("[åå°åˆ·æ–°] è·å–é€šçŸ¥å¤±è´¥");
        return;
      }

      logMessage_Info(`[åå°åˆ·æ–°] æ”¶åˆ° ${result.unreadCount} æœªè¯», ${result.notices.length} æ€»æ•°`);

      // 1. æ›´æ–°è§’æ ‡
      const badge = $('notification-badge');
      if (result.unreadCount > 0) {
        badge.textContent = result.unreadCount > 9 ? '9+' : result.unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // 2. æ™ºèƒ½æ›´æ–°ç¼“å­˜æ•°æ®
      // window.currentNotifications = result.notices || [];

      // 3. æ¸²æŸ“â€œç­¾åˆ°â€Tab (å¦‚æœè¯¥Tabå­˜åœ¨)
      const attList = $('attendance-list');
      if (attList) {
        attList.innerHTML = '';
        const attendanceNotices = (window.currentNotifications || []).filter(n =>
          n.image === 'attendance' || (n.title && n.title.includes('ç­¾åˆ°'))
        );

        if (attendanceNotices.length === 0) {
          attList.innerHTML = '<p class="text-slate-400 text-center py-10 text-xs">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>';
        } else {
          attendanceNotices.forEach(n => {
            const item = document.createElement('div');
            item.className = 'p-2 border-b border-slate-100';

            let statusText = 'æœªçŸ¥';
            let statusClass = 'text-slate-500';
            let buttonHtml = ''; // --- æ–°å¢ï¼šç”¨äºå­˜æ”¾æŒ‰é’® ---

            // --- æå–åæ ‡è§£æé€»è¾‘ï¼Œä¾›æŒ‰é’®ä½¿ç”¨ ---
            let targetCoords = 'null';
            let canSign = false;
            try {
              const coordsStr = (n.updateBy || "").trim();
              const [lat, lon] = coordsStr.split(',').map(Number);
              if (!isNaN(lon) && !isNaN(lat)) {
                targetCoords = `[${lon}, ${lat}]`;
                canSign = true;
              }
            } catch (e) { }

            // ä½¿ç”¨åç«¯é™„åŠ çš„ attendance_code
            switch (n.attendance_code) {
              case -1:
                statusText = 'å·²è¿‡æœŸ'; statusClass = 'text-red-600 font-semibold';
                // --- æ–°å¢ï¼šæ·»åŠ è¡¥ç­¾æŒ‰é’® ---
                if (canSign) {
                  buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="è¡¥ç­¾æ­¤ä»»åŠ¡">
                    <span>è¡¥ç­¾</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">éšæœºè¡¥ç­¾</button>
                    <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾</button>
                  </div>
                </div>
              `;
                }
                break;
              case 1:
                statusText = 'å·²ç­¾åˆ°'; statusClass = 'text-emerald-600 font-semibold';
                // (å·²ç­¾åˆ°ï¼Œæ— éœ€æŒ‰é’®)
                break;
              case 0:
                statusText = 'å¾…ç­¾åˆ°'; statusClass = 'text-sky-600 font-bold';
                // æ–°å¢ï¼šæ·»åŠ ç­¾åˆ°å’Œè¡¥ç­¾æŒ‰é’®
                if (canSign) {
                  // (ä¸ºç®€æ´ï¼Œç­¾åˆ°Tabåªæ”¾éšæœºç­¾åˆ°å’Œè¡¥ç­¾)
                  // ä¸é€šçŸ¥æ¨¡æ€æ¡†ä¿æŒä¸€è‡´ï¼Œä¸ºâ€œç­¾åˆ°â€æŒ‰é’®æ·»åŠ ä¸‹æ‹‰èœå•
                  buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                    <span>ç­¾åˆ°</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/></svg>
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${n.id}', ${targetCoords})">éšæœºç­¾åˆ°</button>
                    <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹</button>
                  </div>
                </div>
                <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                  è¡¥ç­¾
                </button>
              `;
                }
                break;
              default:
                statusText = 'çŠ¶æ€æœªçŸ¥'; statusClass = 'text-slate-400';
            }

            // å¦‚æœæ˜¯è‡ªåŠ¨ç­¾åˆ°å¤±è´¥
            if (n.attendance_status_text && n.attendance_status_text.includes('å¤±è´¥')) {
              statusText = n.attendance_status_text;
              statusClass = 'text-red-700 font-bold';
            }

            // --- æ–°ä»£ç  (innerHTML) ---
            item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-sm font-semibold text-slate-700">${n.title}</span>
            <span class="text-xs ${statusClass} flex-shrink-0">${statusText}</span>
          </div>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-slate-500">${n.content}</span>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-slate-400">${n.createtime}</span>
              ${buttonHtml}
            </div>
          </div>
        `;
            attList.appendChild(item);
          });
        }
      }

      // 4. å¦‚æœé€šçŸ¥æ¨¡æ€æ¡†å½“å‰æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°å®ƒ
      const modal = $('notifications-modal');
      // ç§»é™¤é€’å½’è°ƒç”¨ã€‚

      // if (modal && !modal.classList.contains('hidden')) {
      //   refreshNotificationsUI();
      // }
    }

    // --- å¤„ç†ç­¾åˆ°ç‚¹å‡»çš„å‡½æ•° ---
    async function handleAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      logMessage_Info(`æ­£åœ¨ä¸ºæ‚¨è‡ªåŠ¨ç­¾åˆ°... æ´»åŠ¨ID: ${rollCallId}`);
      // è°ƒç”¨åç«¯éšæœºç­¾åˆ° (location_choice='random', specific_coords=null, is_makeup=false)
      const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'random', null, false);
      if (result.success) {
        logMessage_Info(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
        showModalAlert(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
      } else {
        logMessage_Info(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
        showModalAlert(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
      }
      // ç­¾åˆ°ååˆ·æ–°é€šçŸ¥åˆ—è¡¨çŠ¶æ€
      await fetchNotifications();
      showNotifications();
    }

    const svgIconNormal = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path fill="#22d3ee" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

    const svgIconMakeup = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path fill="#f59e0b" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

    async function handleManualAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      // å…³é”®ä¿®å¤ï¼šä¼ å…¥ 'true'ï¼Œå‘Šè¯‰ toggleNotifications åœ¨å…³é—­åä¿æŒåœ°å›¾ç¦ç”¨
      toggleNotifications(false, true);

      // ä¿®å¤Issue 4: æ¸…ç©ºå½“å‰ä»»åŠ¡é€‰æ‹©ä»¥æ¸…é™¤åœ°å›¾é®æŒ¡ç‰©
      selectedTaskIndex = -1;
      renderTaskList();
      drawOnMap();

      logMessage_Info("è¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰æ‹©ç­¾åˆ°ç‚¹...");

      // --- 1. æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§æ ‡è®° ---
      if (tempAttendanceMarker && map) {
        map.remove(tempAttendanceMarker);
        tempAttendanceMarker = null;
      }
      if (tempAttendanceCircle && map) {
        map.remove(tempAttendanceCircle);
        tempAttendanceCircle = null;
      }

      // --- 2. è·å–åæ ‡å’ŒåŠå¾„ ---
      const radius = (currentUserData && currentUserData.server_attendance_radius_m) ? currentUserData.server_attendance_radius_m : 0.0;
      const position = new AMapInstance.LngLat(targetCoords[0], targetCoords[1]);


      // --- 3. ç»˜åˆ¶ç³»ç»Ÿç­¾åˆ°ç‚¹æ ‡è®° (è€å¸ˆçš„ä½ç½®) ---
      tempAttendanceMarker = new AMapInstance.Marker({
        position: position,
        content: svgIconNormal,
        clickable: false,
        anchor: 'bottom-center',
        zIndex: 200
      });

      // --- 4. ç»˜åˆ¶ç­¾åˆ°èŒƒå›´åœ†åœˆ ---
      tempAttendanceCircle = new AMapInstance.Circle({
        center: position,
        radius: radius,
        strokeColor: "#00BFFF",
        strokeOpacity: 1,
        strokeWeight: 2,
        fillColor: "#00BFFF",
        fillOpacity: 0.2,
        zIndex: 199,
        bubble: true,
        clickable: false
      });

      map.add(tempAttendanceMarker);
      map.add(tempAttendanceCircle);

      // --- 5. ç¼©æ”¾å¹¶å±…ä¸­åˆ°è¯¥åŒºåŸŸ ---
      map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);

      // --- 6. æç¤ºç”¨æˆ·ç‚¹å‡»åœ°å›¾ ---
      const infoMarker = new AMapInstance.Text({
        text: 'å·²æ˜¾ç¤ºç­¾åˆ°åŒºåŸŸï¼Œè¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹',
        position: position,
        anchor: 'bottom-center',
        offset: new AMapInstance.Pixel(0, -40),
        clickable: false,
        style: {
          'background-color': '#fff',
          'padding': '5px 10px',
          'border-radius': '5px',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
          'pointer-events': 'none'
        }
      });
      map.add(infoMarker);

      // --- 7. ç›‘å¬ä¸€æ¬¡åœ°å›¾å•å‡»äº‹ä»¶ (åŒ…å«è·ç¦»æ ¡éªŒå’ŒçŠ¶æ€æ¢å¤) ---
      const onMapClick = async (e) => {
        map.off('click', onMapClick);
        map.remove(infoMarker);

        const clickedLngLat = e.lnglat;
        const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];

        // --- è·ç¦»åˆ¤æ–­ (ä¸Šæ¬¡çš„ä¿®å¤) ---
        const distance = fastDistanceMeters(clickedLngLat.lng, clickedLngLat.lat, targetCoords[0], targetCoords[1]);

        if (distance > radius) {
          logMessage_Info(`é€‰ç‚¹å¤±è´¥ï¼šè·ç¦» ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`);
          showModalAlert('æ‚¨é€‰æ‹©çš„ç‚¹ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼Œè¯·é‡æ–°åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ã€‚', 'é€‰ç‚¹æ— æ•ˆ');

          // é‡æ–°æ˜¾ç¤ºæç¤ºå¹¶é‡æ–°ç»‘å®šç›‘å¬ (åœ°å›¾ä»å¤„äºâ€œé€‰ç‚¹æ¨¡å¼â€)
          map.add(infoMarker);
          map.on('click', onMapClick);
          return;
        }
        // --- è·ç¦»åˆ¤æ–­ç»“æŸ ---

        logMessage_Info(`å·²é€‰æ‹©ç­¾åˆ°ç‚¹: ${specificCoords.join(', ')} (è·ç¦» ${distance.toFixed(1)}m)`);

        try {
          const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'specific', specificCoords, false);
          if (result.success) {
            logMessage_Info(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
            showModalAlert(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
          } else {
            logMessage_Info(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
            showModalAlert(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
          }
        } catch (err) {
          logMessage_Info(`ç­¾åˆ°æ—¶å‘ç”ŸJSé”™è¯¯: ${err}`);
        } finally {
          // --- 8. æ¸…ç†è¦†ç›–ç‰© ---
          if (tempAttendanceMarker && map) {
            map.remove(tempAttendanceMarker);
            tempAttendanceMarker = null;
          }
          if (tempAttendanceCircle && map) {
            map.remove(tempAttendanceCircle);
            tempAttendanceCircle = null;
          }

          // --- å…³é”®ä¿®å¤ï¼šæ¢å¤åœ°å›¾äº¤äº’çŠ¶æ€ ---
          if (map) {
            map.setStatus({
              dragEnable: true,
              scrollWheel: true,
              doubleClickZoom: true
            });
          }

          await fetchNotifications();
        }
      };

      map.on('click', onMapClick);
    }


    async function handleMakeupAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      logMessage_Info(`æ­£åœ¨ä¸ºæ‚¨ [è¡¥ç­¾]... æ´»åŠ¨ID: ${rollCallId}`);

      // è°ƒç”¨åç«¯éšæœºç­¾åˆ°ï¼Œå¹¶æ˜ç¡®ä¼ é€’ is_makeup=True
      // ç­¾å: trigger_attendance(rollCallId, targetCoords, location_choice, specific_coords, is_makeup)
      const result = await callPythonAPI('trigger_attendance',
        rollCallId,
        targetCoords,
        'random',   // location_choice
        null,       // specific_coords
        true        // is_makeup
      );

      if (result.success) {
        logMessage_Info(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
        showModalAlert(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
      } else {
        logMessage_Info(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
        showModalAlert(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
      }
      // è¡¥ç­¾ååˆ·æ–°é€šçŸ¥åˆ—è¡¨çŠ¶æ€
      await fetchNotifications();
      // é‡æ–°æ‰“å¼€é€šçŸ¥æ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
      // showNotifications();
    }

    // --- æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾å‡½æ•° ---
    async function handleManualMakeupAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      // å…³é”®ä¿®å¤ï¼šä¼ å…¥ 'true'ï¼Œå‘Šè¯‰ toggleNotifications åœ¨å…³é—­åä¿æŒåœ°å›¾ç¦ç”¨
      toggleNotifications(false, true);

      // ä¿®å¤Issue 4: æ¸…ç©ºå½“å‰ä»»åŠ¡é€‰æ‹©ä»¥æ¸…é™¤åœ°å›¾é®æŒ¡ç‰©
      selectedTaskIndex = -1;
      renderTaskList();
      drawOnMap();

      logMessage_Info("è¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰æ‹© [è¡¥ç­¾] ç‚¹...");

      // --- 1. æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§æ ‡è®° ---
      if (tempAttendanceMarker && map) {
        map.remove(tempAttendanceMarker);
        tempAttendanceMarker = null;
      }
      if (tempAttendanceCircle && map) {
        map.remove(tempAttendanceCircle);
        tempAttendanceCircle = null;
      }

      // --- 2. è·å–åæ ‡å’ŒåŠå¾„ ---
      const radius = (currentUserData && currentUserData.server_attendance_radius_m) ? currentUserData.server_attendance_radius_m : 0.0;
      const position = new AMapInstance.LngLat(targetCoords[0], targetCoords[1]);
      logMessage_Info(`ç³»ç»Ÿç­¾åˆ°ç‚¹: ${targetCoords[0]}, ${targetCoords[1]} (åŠå¾„: ${radius}ç±³)`);

      // --- 3. ç»˜åˆ¶ç³»ç»Ÿç­¾åˆ°ç‚¹æ ‡è®° (è€å¸ˆçš„ä½ç½®) ---
      tempAttendanceMarker = new AMapInstance.Marker({
        position: position,
        content: svgIconMakeup, // ä½¿ç”¨æ©™è‰²SVG
        clickable: false,
        anchor: 'bottom-center',
        zIndex: 200
      });

      // --- 4. ç»˜åˆ¶ç­¾åˆ°èŒƒå›´åœ†åœˆ (ä½¿ç”¨è¡¥ç­¾çš„) ---
      tempAttendanceCircle = new AMapInstance.Circle({
        center: position,
        radius: radius,
        strokeColor: "#F7B731",
        strokeOpacity: 1,
        strokeWeight: 2,
        fillColor: "#F7B731",
        fillOpacity: 0.2,
        zIndex: 199,
        bubble: true,
        clickable: false
      });

      map.add(tempAttendanceMarker);
      map.add(tempAttendanceCircle);

      // --- 5. ç¼©æ”¾å¹¶å±…ä¸­åˆ°è¯¥åŒºåŸŸ ---
      map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);

      // --- 6. æç¤ºç”¨æˆ·ç‚¹å‡»åœ°å›¾ ---
      const infoMarker = new AMapInstance.Text({
        text: 'å·²æ˜¾ç¤ºç­¾åˆ°åŒºåŸŸï¼Œè¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ [è¡¥ç­¾]',
        position: position,
        anchor: 'bottom-center',
        offset: new AMapInstance.Pixel(0, -40),
        clickable: false,
        style: {
          'background-color': '#fff',
          'padding': '5px 10px',
          'border-radius': '5px',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
          'pointer-events': 'none'
        }
      });
      map.add(infoMarker);

      // --- 7. ç›‘å¬ä¸€æ¬¡åœ°å›¾å•å‡»äº‹ä»¶ (åŒ…å«è·ç¦»æ ¡éªŒå’ŒçŠ¶æ€æ¢å¤) ---
      const onMapClick = async (e) => {
        map.off('click', onMapClick);
        map.remove(infoMarker);

        const clickedLngLat = e.lnglat;
        const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];

        // --- è·ç¦»åˆ¤æ–­ (ä¸Šæ¬¡çš„ä¿®å¤) ---
        const distance = fastDistanceMeters(clickedLngLat.lng, clickedLngLat.lat, targetCoords[0], targetCoords[1]);

        if (distance > radius) {
          logMessage_Info(`[è¡¥ç­¾] é€‰ç‚¹å¤±è´¥ï¼šè·ç¦» ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`);
          showModalAlert('æ‚¨é€‰æ‹©çš„ç‚¹ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼Œè¯·é‡æ–°åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ã€‚', 'é€‰ç‚¹æ— æ•ˆ');

          // é‡æ–°æ˜¾ç¤ºæç¤ºå¹¶é‡æ–°ç»‘å®šç›‘å¬ (åœ°å›¾ä»å¤„äºâ€œé€‰ç‚¹æ¨¡å¼â€)
          map.add(infoMarker);
          map.on('click', onMapClick);
          return;
        }
        // --- è·ç¦»åˆ¤æ–­ç»“æŸ ---

        logMessage_Info(`å·²é€‰æ‹© [è¡¥ç­¾] ç‚¹: ${specificCoords.join(', ')} (è·ç¦» ${distance.toFixed(1)}m)`);

        try {
          const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'specific', specificCoords, true);
          if (result.success) {
            logMessage_Info(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
            showModalAlert(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
          } else {
            logMessage_Info(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
            showModalAlert(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
          }
        } catch (err) {
          logMessage_Info(`è¡¥ç­¾æ—¶å‘ç”ŸJSé”™è¯¯: ${err}`);
        } finally {
          // --- 8. æ¸…ç†è¦†ç›–ç‰© ---
          if (tempAttendanceMarker && map) {
            map.remove(tempAttendanceMarker);
            tempAttendanceMarker = null;
          }
          if (tempAttendanceCircle && map) {
            map.remove(tempAttendanceCircle);
            tempAttendanceCircle = null;
          }

          // --- å…³é”®ä¿®å¤ï¼šæ¢å¤åœ°å›¾äº¤äº’çŠ¶æ€ ---
          if (map) {
            map.setStatus({
              dragEnable: true,
              scrollWheel: true,
              doubleClickZoom: true
            });
          }

          await fetchNotifications();
        }
      };

      map.on('click', onMapClick);
    }


    async function markAsRead(event, noticeId) {
      event.stopPropagation(); // é˜²æ­¢ç‚¹å‡»ç©¿é€

      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '...';

      try {
        const result = await callPythonAPI('mark_notification_read', noticeId);
        if (result.success) {
          // æˆåŠŸåï¼Œé‡æ–°ä»æœåŠ¡å™¨è·å–æœ€æ–°åˆ—è¡¨
          // è¿™æ˜¯æœ€å¯é çš„æ–¹å¼ï¼Œèƒ½è‡ªåŠ¨æ›´æ–°è§’æ ‡å’Œåˆ—è¡¨çŠ¶æ€
          await fetchNotifications();
          // é‡æ–°æ¸²æŸ“æ¨¡æ€æ¡†å†…éƒ¨
          showNotifications();
        } else {
          showModalAlert(result.message || 'æ ‡è®°å·²è¯»å¤±è´¥');
          btn.disabled = false;
          btn.textContent = 'è®¾ä¸ºå·²è¯»';
        }
      } catch (e) {
        logMessage_Error("markAsRead failed:", e);
        btn.disabled = false;
        btn.textContent = 'è®¾ä¸ºå·²è¯»';
      }
    }

    /**
     * æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
     */
    async function markAllAsRead() {
      const btn = $('mark-all-read-btn');
      btn.disabled = true;
      btn.textContent = 'å¤„ç†ä¸­...';

      // æ‰¾å‡ºæ‰€æœ‰æœªè¯»é€šçŸ¥
      const unreadNotices = (window.currentNotifications || []).filter(n => !n.isRead);
      if (unreadNotices.length === 0) {
        btn.textContent = 'ä¸€é”®å·²è¯»';
        return;
      }

      try {
        // å¹¶è¡Œå‘é€æ‰€æœ‰â€œè®¾ä¸ºå·²è¯»â€è¯·æ±‚
        const promises = unreadNotices.map(n =>
          callPythonAPI('mark_notification_read', n.id)
        );
        await Promise.all(promises);

        // å…¨éƒ¨å®Œæˆåï¼ˆæ— è®ºæ˜¯å¦å…¨éƒ¨æˆåŠŸï¼‰ï¼Œéƒ½ç»Ÿä¸€åˆ·æ–°ä¸€æ¬¡
        logMessage_Info(`â€œä¸€é”®å·²è¯»â€æ“ä½œå®Œæˆï¼Œå…±å¤„ç† ${unreadNotices.length} æ¡ã€‚`);

      } catch (e) {
        logMessage_Error("markAllAsRead failed:", e);
        logMessage_Info(`â€œä¸€é”®å·²è¯»â€æ—¶å‘ç”Ÿé”™è¯¯: ${e}`);
      } finally {
        // æœ€ç»ˆï¼Œä»æœåŠ¡å™¨æ‹‰å–æœ€æ–°çŠ¶æ€
        await fetchNotifications();
        // é‡æ–°æ¸²æŸ“æ¨¡æ€æ¡†
        showNotifications();
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = (window.currentNotifications || []).filter(n => !n.isRead).length === 0;
        btn.textContent = 'ä¸€é”®å·²è¯»';
      }
    }

    $('multi-remove-all-btn').addEventListener('click', multi_removeAll);
    $('multi-remove-selected-btn').addEventListener('click', multi_removeSelected);
    $('multi-refresh-all-btn').addEventListener('click', multi_refreshAll);
    $('multi-select-all-check').addEventListener('change', multi_toggleSelectAll);
    $('multi-start-selected-btn').addEventListener('click', multi_startSelected);
    $('multi-stop-selected-btn').addEventListener('click', multi_stopSelected);
    $('multi-refresh-selected-btn').addEventListener('click', multi_refreshSelected);

  </script>

  <!-- ä¿®æ”¹æ‰‹æœºå·Modal -->
  <div id="modify-phone-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-slate-800">ä¿®æ”¹ç»‘å®šæ‰‹æœºå·</h3>
        <button onclick="closeModifyPhoneModal()" class="text-slate-400 hover:text-slate-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">å½“å‰æ‰‹æœºå·</label>
          <!-- phone-input-wrapper: ä¸ºå½“å‰æ‰‹æœºå·æ·»åŠ +86å‰ç¼€å®¹å™¨ -->
          <div class="phone-input-wrapper">
            <!-- phone-prefix: ä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç å‰ç¼€ (+86åé¢æœ‰ç©ºæ ¼) -->
            <span class="phone-prefix">+86 </span>
            <!-- è¾“å…¥æ¡†ï¼šåªè¯»çŠ¶æ€ï¼Œç”¨äºæ˜¾ç¤ºç”¨æˆ·å½“å‰ç»‘å®šçš„æ‰‹æœºå· -->
            <input type="tel" id="modify-phone-current" class="input-field" readonly>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æ–°æ‰‹æœºå·</label>
          <!-- phone-input-wrapper: ä¸ºæ–°æ‰‹æœºå·æ·»åŠ +86å‰ç¼€å®¹å™¨ -->
          <div class="phone-input-wrapper">
            <!-- phone-prefix: ä¸å¯ç¼–è¾‘çš„å›½å®¶ä»£ç å‰ç¼€ (+86åé¢æœ‰ç©ºæ ¼) -->
            <span class="phone-prefix">+86 </span>
            <!-- è¾“å…¥æ¡†ï¼šç”¨æˆ·è¾“å…¥æ–°æ‰‹æœºå· -->
            <input type="tel" id="modify-phone-new" class="input-field" placeholder="è¯·è¾“å…¥æ–°æ‰‹æœºå·" inputmode="numeric"
              pattern="[0-9]*" style="min-height: 44px;">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">çŸ­ä¿¡éªŒè¯ç </label>
          <div class="flex gap-2">
            <input type="text" id="modify-phone-code" class="input-field flex-1" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}" style="min-height: 44px;">
            <button onclick="sendModifyPhoneCode()" id="modify-phone-send-btn" class="btn btn-primary whitespace-nowrap"
              style="min-height: 44px;">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>

        <div class="flex gap-3 pt-4">
          <button onclick="confirmModifyPhone()" class="btn btn-success flex-1" style="min-height: 44px;">
            ç¡®è®¤ä¿®æ”¹
          </button>
          <button onclick="closeModifyPhoneModal()" class="btn btn-ghost flex-1" style="min-height: 44px;">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ==================== ç§»åŠ¨ç«¯UIäº¤äº’å‡½æ•° ====================
    // æœ¬èŠ‚åŒ…å«æ‰€æœ‰ç§»åŠ¨ç«¯ä¸“ç”¨UIç»„ä»¶çš„JavaScriptäº¤äº’é€»è¾‘
    // åŒ…æ‹¬ï¼šé€šçŸ¥é¢æ¿ã€ä»»åŠ¡é¢æ¿ã€åœ°å›¾é¢æ¿ã€æ§åˆ¶é¢æ¿ã€å¤šè´¦å·ç®¡ç†ç­‰

    /**
     * åˆ‡æ¢ç§»åŠ¨ç«¯é€šçŸ¥æ ‡ç­¾é¡µï¼ˆå…¨éƒ¨/ç­¾åˆ°ï¼‰
     * @param {string} tabName - æ ‡ç­¾åç§°ï¼š'all'ï¼ˆå…¨éƒ¨é€šçŸ¥ï¼‰æˆ–'attendance'ï¼ˆç­¾åˆ°ä»»åŠ¡ï¼‰
     */
    function switchMobileNotifTab(tabName) {
      // è·å–ä¸¤ä¸ªæ ‡ç­¾æŒ‰é’®å…ƒç´ 
      const allTab = document.getElementById('mobile-notif-tab-all');
      const attTab = document.getElementById('mobile-notif-tab-attendance');
      // è·å–ä¸¤ä¸ªå†…å®¹åˆ—è¡¨å…ƒç´ 
      const allList = document.getElementById('mobile-all-notifications-list');
      const attList = document.getElementById('mobile-attendance-notifications-list');

      // æ ¹æ®é€‰æ‹©çš„æ ‡ç­¾ï¼Œåˆ‡æ¢æ¿€æ´»çŠ¶æ€å’Œå†…å®¹æ˜¾ç¤º
      if (tabName === 'all') {
        // æ¿€æ´»"å…¨éƒ¨é€šçŸ¥"æ ‡ç­¾
        allTab.className = 'flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition';
        attTab.className = 'flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition';
        // æ˜¾ç¤ºå…¨éƒ¨é€šçŸ¥åˆ—è¡¨ï¼Œéšè—ç­¾åˆ°åˆ—è¡¨
        allList.classList.remove('hidden');
        attList.classList.add('hidden');
      } else {
        // æ¿€æ´»"ç­¾åˆ°ä»»åŠ¡"æ ‡ç­¾
        attTab.className = 'flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition';
        allTab.className = 'flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition';
        // æ˜¾ç¤ºç­¾åˆ°åˆ—è¡¨ï¼Œéšè—å…¨éƒ¨é€šçŸ¥
        attList.classList.remove('hidden');
        allList.classList.add('hidden');
      }
    }

    /**
     * åˆ·æ–°ç§»åŠ¨ç«¯é€šçŸ¥åˆ—è¡¨
     * ä»æœåŠ¡å™¨è·å–æœ€æ–°çš„é€šçŸ¥æ•°æ®å¹¶æ›´æ–°UI
     */
    async function mobileRefreshNotifications() {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const btn = document.getElementById('mobile-refresh-notifications-btn');
      if (btn) {
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        btn.disabled = true;
        // ä¿å­˜åŸå§‹æŒ‰é’®å†…å®¹
        const originalHTML = btn.innerHTML;
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆæ—‹è½¬çš„åˆ·æ–°å›¾æ ‡ï¼‰
        btn.innerHTML = '<svg class="w-5 h-5 text-sky-600 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      }

      try {
        // è°ƒç”¨fetchNotificationsè·å–æœ€æ–°é€šçŸ¥æ•°æ®
        // æ³¨æ„ï¼šfetchNotificationsæ˜¯å·²å­˜åœ¨çš„å…¨å±€å‡½æ•°ï¼Œåœ¨ä¸»ä»£ç ä¸­å®šä¹‰
        await fetchNotifications();
        // åˆ·æ–°æˆåŠŸåï¼Œæ›´æ–°ç§»åŠ¨ç«¯UIæ˜¾ç¤º
        updateMobileNotificationUI();
      } catch (error) {
        // é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
        console.error('åˆ·æ–°é€šçŸ¥å¤±è´¥:', error);
        showTempMessage('åˆ·æ–°é€šçŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }
    }

    /**
     * æ›´æ–°ç§»åŠ¨ç«¯é€šçŸ¥UIæ˜¾ç¤º
     * æ ¹æ®window.currentNotificationsä¸­çš„æ•°æ®æ¸²æŸ“é€šçŸ¥åˆ—è¡¨
     */
    function updateMobileNotificationUI() {
      // è·å–å½“å‰é€šçŸ¥æ•°æ®ï¼ˆç”±fetchNotificationså¡«å……çš„å…¨å±€å˜é‡ï¼‰
      const notifications = window.currentNotifications || [];

      // æ›´æ–°æœªè¯»è§’æ ‡
      const badge = document.getElementById('mobile-notification-badge');
      const unreadCount = notifications.filter(n => !n.isRead).length;
      if (badge) {
        if (unreadCount > 0) {
          // æ˜¾ç¤ºè§’æ ‡ï¼Œæ˜¾ç¤ºæœªè¯»æ•°é‡ï¼ˆæœ€å¤šæ˜¾ç¤º9+ï¼‰
          badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
          badge.classList.remove('hidden');
        } else {
          // æ²¡æœ‰æœªè¯»æ¶ˆæ¯æ—¶éšè—è§’æ ‡
          badge.classList.add('hidden');
        }
      }

      // åˆ†ç¦»ç­¾åˆ°é€šçŸ¥å’Œæ™®é€šé€šçŸ¥
      const attendanceNotices = notifications.filter(n =>
        n.image === 'attendance' || (n.title && n.title.includes('ç­¾åˆ°'))
      );
      const regularNotices = notifications;

      // æ¸²æŸ“å…¨éƒ¨é€šçŸ¥åˆ—è¡¨
      const allList = document.getElementById('mobile-all-notifications-list');
      if (allList) {
        if (regularNotices.length === 0) {
          // æ²¡æœ‰é€šçŸ¥æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
          allList.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">æš‚æ— é€šçŸ¥</p>';
        } else {
          // æ¸…ç©ºç°æœ‰å†…å®¹
          allList.innerHTML = '';
          // éå†é€šçŸ¥æ•°æ®ï¼Œç”Ÿæˆé€šçŸ¥é¡¹
          regularNotices.forEach(notice => {
            const item = document.createElement('div');
            // æ ¹æ®æ˜¯å¦å·²è¯»è®¾ç½®ä¸åŒçš„æ ·å¼
            item.className = 'mobile-list-item ' + (notice.isRead ? 'opacity-60' : '');
            item.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${escapeHtml(notice.title)}</span>
                  <span class="text-xs text-slate-400">${escapeHtml(notice.createtime)}</span>
                </div>
                <p class="text-xs text-slate-600">${escapeHtml(notice.content)}</p>
              </div>
              ${!notice.isRead ? '<span class="ml-2 w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></span>' : ''}
            `;
            // ç‚¹å‡»é€šçŸ¥é¡¹æ ‡è®°ä¸ºå·²è¯»
            item.addEventListener('click', () => markMobileNotificationRead(notice.id));
            allList.appendChild(item);
          });
        }
      }

      // æ¸²æŸ“ç­¾åˆ°ä»»åŠ¡åˆ—è¡¨
      const attList = document.getElementById('mobile-attendance-notifications-list');
      if (attList) {
        if (attendanceNotices.length === 0) {
          attList.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>';
        } else {
          attList.innerHTML = '';
          attendanceNotices.forEach(notice => {
            const item = document.createElement('div');
            item.className = 'mobile-list-item';

            // æ ¹æ®attendance_codeç¡®å®šç­¾åˆ°çŠ¶æ€
            let statusBadge = '';
            let actionButtons = '';

            if (notice.attendance_code === -1) {
              // å·²è¿‡æœŸ
              statusBadge = '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-600">å·²è¿‡æœŸ</span>';
            } else if (notice.attendance_code === 1) {
              // å·²ç­¾åˆ°
              statusBadge = '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-600">å·²ç­¾åˆ°</span>';
            } else if (notice.attendance_code === 0) {
              // å¾…ç­¾åˆ°
              statusBadge = '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-600">å¾…ç­¾åˆ°</span>';
              // æ·»åŠ ç­¾åˆ°æŒ‰é’®
              actionButtons = `
                <button class="py-1 px-3 bg-sky-500 text-white rounded-lg text-xs font-medium hover:bg-sky-600 transition" onclick="event.stopPropagation(); mobileHandleAttendance('${notice.id}')">
                  ç­¾åˆ°
                </button>
              `;
            }

            item.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${escapeHtml(notice.title)}</span>
                  ${statusBadge}
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">${escapeHtml(notice.content)}</span>
                  <span class="text-xs text-slate-400 ml-2">${escapeHtml(notice.createtime)}</span>
                </div>
              </div>
              ${actionButtons}
            `;
            attList.appendChild(item);
          });
        }
      }
    }

    /**
     * æ ‡è®°ç§»åŠ¨ç«¯é€šçŸ¥ä¸ºå·²è¯»
     * @param {string} noticeId - é€šçŸ¥ID
     */
    async function markMobileNotificationRead(noticeId) {
      try {
        // è°ƒç”¨åç«¯APIæ ‡è®°å·²è¯»
        const result = await callPythonAPI('mark_notification_read', noticeId);
        if (result.success) {
          // æˆåŠŸåé‡æ–°åˆ·æ–°åˆ—è¡¨
          await mobileRefreshNotifications();
        }
      } catch (error) {
        console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
      }
    }

    /**
     * ç§»åŠ¨ç«¯ä¸€é”®å·²è¯»æ‰€æœ‰é€šçŸ¥
     */
    async function mobileMarkAllAsRead() {
      const notifications = window.currentNotifications || [];
      const unreadNotices = notifications.filter(n => !n.isRead);

      if (unreadNotices.length === 0) {
        showTempMessage('æ²¡æœ‰æœªè¯»é€šçŸ¥', 'info');
        return;
      }

      try {
        // å¹¶è¡Œæ ‡è®°æ‰€æœ‰æœªè¯»é€šçŸ¥ä¸ºå·²è¯»
        const promises = unreadNotices.map(n =>
          callPythonAPI('mark_notification_read', n.id)
        );
        await Promise.all(promises);

        // åˆ·æ–°UI
        await mobileRefreshNotifications();
        showTempMessage('å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»', 'success');
      } catch (error) {
        console.error('ä¸€é”®å·²è¯»å¤±è´¥:', error);
        showTempMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    /**
     * å±•å¼€ç§»åŠ¨ç«¯é€šçŸ¥æ¨¡æ€æ¡†ï¼ˆæŸ¥çœ‹æ›´å¤šï¼‰
     */
    function expandMobileNotifications() {
      // å¤ç”¨æ¡Œé¢ç«¯çš„é€šçŸ¥æ¨¡æ€æ¡†åŠŸèƒ½
      showNotifications();
    }

    /**
     * ç§»åŠ¨ç«¯å¤„ç†ç­¾åˆ°
     * @param {string} rollCallId - ç­¾åˆ°æ´»åŠ¨ID
     */
    async function mobileHandleAttendance(rollCallId) {
      // è·å–å½“å‰é€šçŸ¥æ•°æ®ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç­¾åˆ°æ´»åŠ¨
      const notifications = window.currentNotifications || [];
      const notice = notifications.find(n => n.id === rollCallId);

      if (!notice) {
        showTempMessage('æœªæ‰¾åˆ°ç­¾åˆ°æ´»åŠ¨ä¿¡æ¯', 'error');
        return;
      }

      // è§£æåæ ‡
      try {
        const coordsStr = (notice.updateBy || "").trim();
        const [lat, lon] = coordsStr.split(',').map(Number);

        if (isNaN(lon) || isNaN(lat)) {
          showTempMessage('ç­¾åˆ°åæ ‡æ— æ•ˆ', 'error');
          return;
        }

        const targetCoords = [lon, lat];

        // è°ƒç”¨åç«¯éšæœºç­¾åˆ°API
        const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'random', null, false);

        if (result.success) {
          showTempMessage('ç­¾åˆ°æˆåŠŸï¼', 'success');
          // åˆ·æ–°é€šçŸ¥åˆ—è¡¨
          await mobileRefreshNotifications();
        } else {
          showTempMessage('ç­¾åˆ°å¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('ç­¾åˆ°å¤±è´¥:', error);
        showTempMessage('ç­¾åˆ°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    /**
     * åˆ·æ–°ç§»åŠ¨ç«¯ä»»åŠ¡åˆ—è¡¨
     */
    async function mobileRefreshTasks() {
      // TODO: å®ç°ä»»åŠ¡åˆ·æ–°é€»è¾‘
      // è°ƒç”¨ç°æœ‰çš„refreshTaskså‡½æ•°å¹¶æ›´æ–°ç§»åŠ¨ç«¯UI
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯æ·»åŠ æ–°ä»»åŠ¡
     */
    function mobileAddTask() {
      // TODO: æ‰“å¼€æ·»åŠ ä»»åŠ¡å¯¹è¯æ¡†
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }



    /**
     * ç§»åŠ¨ç«¯å¯åŠ¨ä»»åŠ¡
     */
    async function mobileStartTask() {
      // TODO: è°ƒç”¨ç°æœ‰çš„startTaskå‡½æ•°
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯åœæ­¢ä»»åŠ¡
     */
    async function mobileStopTask() {
      // TODO: è°ƒç”¨ç°æœ‰çš„stopTaskå‡½æ•°
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯æš‚åœä»»åŠ¡
     */
    async function mobilePauseTask() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯ç»§ç»­ä»»åŠ¡
     */
    async function mobileResumeTask() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯é‡ç½®ä»»åŠ¡
     */
    async function mobileResetTask() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * é€€å‡ºç§»åŠ¨ç«¯å¤šè´¦å·æ¨¡å¼ï¼Œè¿”å›é¦–é¡µ
     */
    function exitMobileMultiAccount() {
      // éšè—å¤šè´¦å·ç•Œé¢
      document.getElementById('mobile-multi-account-app').classList.add('hidden');
      // æ˜¾ç¤ºç™»å½•å®¹å™¨
      document.getElementById('mobile-login-container').classList.remove('hidden');
      // éšè—åº•éƒ¨å¯¼èˆªå’Œèœå•æŒ‰é’®ï¼ˆè¿”å›åˆ°æœªç™»å½•å­¦æ ¡è´¦å·çŠ¶æ€ï¼‰
      updateMobileNavVisibility(false);
    }

    /**
     * ç§»åŠ¨ç«¯å…¨é€‰/å–æ¶ˆå…¨é€‰è´¦å·
     */
    function mobileToggleSelectAllAccounts() {
      const checkbox = document.getElementById('mobile-select-all-accounts');
      const accountCheckboxes = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]');

      // æ ¹æ®å…¨é€‰æ¡†çŠ¶æ€ï¼Œæ‰¹é‡è®¾ç½®è´¦å·å¤é€‰æ¡†
      accountCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
    }

    /**
     * ç§»åŠ¨ç«¯å¯åŠ¨é€‰ä¸­çš„è´¦å·
     */
    async function mobileStartSelectedAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯åœæ­¢é€‰ä¸­çš„è´¦å·
     */
    async function mobileStopSelectedAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯æ·»åŠ å¤šè´¦å·
     */
    function mobileAddMultiAccount() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯åˆ·æ–°å¤šè´¦å·åˆ—è¡¨
     */
    async function mobileRefreshMultiAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯å…¨éƒ¨å¯åŠ¨ï¼ˆå¤šè´¦å·ï¼‰
     */
    async function mobileStartAllAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯å…¨éƒ¨åœæ­¢ï¼ˆå¤šè´¦å·ï¼‰
     */
    async function mobileStopAllAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯å…¨éƒ¨åˆ·æ–°ï¼ˆå¤šè´¦å·ï¼‰
     */
    async function mobileRefreshAllAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * ç§»åŠ¨ç«¯åˆ é™¤é€‰ä¸­çš„è´¦å·
     */
    async function mobileRemoveSelectedAccounts() {
      showTempMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // ==================== ç§»åŠ¨ç«¯UIæ§åˆ¶å‡½æ•° ====================

    /**
     * æ˜¾ç¤ºæˆ–éšè—ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿æ¨¡æ€æ¡†
     * @param {boolean} show - trueè¡¨ç¤ºæ˜¾ç¤ºï¼Œfalseè¡¨ç¤ºéšè—
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - æ§åˆ¶ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿æ¨¡æ€æ¡†çš„æ˜¾ç¤º/éšè—
     * - å½“showä¸ºtrueæ—¶ï¼Œç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
     * - å½“showä¸ºfalseæ—¶ï¼Œæ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
     * - è¯¥æ¨¡æ€æ¡†ç”¨äºå•è´¦å·å’Œå¤šè´¦å·æ¨¡å¼çš„ç®¡ç†åŠŸèƒ½
     */
    function toggleMobileAdminPanel(show) {
      // è·å–ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿æ¨¡æ€æ¡†å…ƒç´ 
      const modal = document.getElementById('mobile-admin-panel-modal');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
      if (modal) {
        // æ ¹æ®showå‚æ•°å†³å®šæ˜¾ç¤ºæˆ–éšè—
        if (show) {
          // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
          modal.classList.remove('hidden');
        } else {
          // æ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
          modal.classList.add('hidden');
        }
      }
    }

    /**
     * æ˜¾ç¤ºæˆ–éšè—ç§»åŠ¨ç«¯ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
     * @param {boolean} show - trueè¡¨ç¤ºæ˜¾ç¤ºï¼Œfalseè¡¨ç¤ºéšè—
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - æ§åˆ¶ç§»åŠ¨ç«¯ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†çš„æ˜¾ç¤º/éšè—
     * - å½“showä¸ºtrueæ—¶ï¼Œç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
     * - å½“showä¸ºfalseæ—¶ï¼Œæ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
     * - è¯¥æ¨¡æ€æ¡†ç”¨äºæ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
     */
    function toggleMobileUserDetails(show) {
      // è·å–ç§»åŠ¨ç«¯ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†å…ƒç´ 
      const modal = document.getElementById('mobile-user-details-modal');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
      if (modal) {
        // æ ¹æ®showå‚æ•°å†³å®šæ˜¾ç¤ºæˆ–éšè—
        if (show) {
          // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
          modal.classList.remove('hidden');
          // å¦‚æœéœ€è¦åŠ è½½ç”¨æˆ·è¯¦æƒ…ï¼Œå¯ä»¥åœ¨æ­¤è°ƒç”¨åŠ è½½å‡½æ•°
          // loadMobileUserDetails();
        } else {
          // æ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
          modal.classList.add('hidden');
        }
      }
    }

    /**
     * æ˜¾ç¤ºæˆ–éšè—ç§»åŠ¨ç«¯ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†
     * @param {boolean} show - trueè¡¨ç¤ºæ˜¾ç¤ºï¼Œfalseè¡¨ç¤ºéšè—
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - æ§åˆ¶ç§»åŠ¨ç«¯ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†çš„æ˜¾ç¤º/éšè—
     * - å½“showä¸ºtrueæ—¶ï¼Œç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
     * - å½“showä¸ºfalseæ—¶ï¼Œæ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
     * - è¯¥æ¨¡æ€æ¡†ç”¨äºæ˜¾ç¤ºç‰¹å®šä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
     */
    function toggleMobileTaskDetails(show) {
      // è·å–ç§»åŠ¨ç«¯ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†å…ƒç´ 
      const modal = document.getElementById('mobile-task-details-modal');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
      if (modal) {
        // æ ¹æ®showå‚æ•°å†³å®šæ˜¾ç¤ºæˆ–éšè—
        if (show) {
          // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
          modal.classList.remove('hidden');
        } else {
          // æ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
          modal.classList.add('hidden');
        }
      }
    }

    /**
     * æ˜¾ç¤ºæˆ–éšè—ç§»åŠ¨ç«¯é€šçŸ¥ä¸­å¿ƒæ¨¡æ€æ¡†
     * @param {boolean} show - trueè¡¨ç¤ºæ˜¾ç¤ºï¼Œfalseè¡¨ç¤ºéšè—
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - æ§åˆ¶ç§»åŠ¨ç«¯é€šçŸ¥ä¸­å¿ƒæ¨¡æ€æ¡†çš„æ˜¾ç¤º/éšè—
     * - å½“showä¸ºtrueæ—¶ï¼Œç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶åŠ è½½é€šçŸ¥å†…å®¹
     * - å½“showä¸ºfalseæ—¶ï¼Œæ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
     * - è¯¥æ¨¡æ€æ¡†ç”¨äºæ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥å’Œæ¶ˆæ¯
     */
    function toggleMobileNotifications(show) {
      // è·å–ç§»åŠ¨ç«¯é€šçŸ¥ä¸­å¿ƒæ¨¡æ€æ¡†å…ƒç´ 
      const modal = document.getElementById('mobile-notifications-modal');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
      if (modal) {
        // æ ¹æ®showå‚æ•°å†³å®šæ˜¾ç¤ºæˆ–éšè—
        if (show) {
          // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
          modal.classList.remove('hidden');
          // åŠ è½½é€šçŸ¥å†…å®¹ï¼ˆè°ƒç”¨å·²å­˜åœ¨çš„å‡½æ•°ï¼‰
          // updateMobileNotificationUI();
        } else {
          // æ·»åŠ hiddenç±»ï¼Œéšè—æ¨¡æ€æ¡†
          modal.classList.add('hidden');
        }
      }
    }

    /**
     * ç§»åŠ¨ç«¯é€€å‡ºç™»å½•å‡½æ•°
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - å¤„ç†ç§»åŠ¨ç«¯ç”¨æˆ·é€€å‡ºç™»å½•çš„æ“ä½œ
     * - éšè—å•è´¦å·ä¸»åº”ç”¨ç•Œé¢
     * - æ˜¾ç¤ºç™»å½•å®¹å™¨
     * - éšè—åº•éƒ¨å¯¼èˆªæ 
     * - æ¸…é™¤ç”¨æˆ·ä¼šè¯æ•°æ®
     */
    function mobileLogout() {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        // éšè—ç§»åŠ¨ç«¯ä¸»åº”ç”¨ç•Œé¢
        const mobileMainApp = document.getElementById('mobile-main-app');
        if (mobileMainApp) {
          mobileMainApp.classList.add('hidden');
        }

        // æ˜¾ç¤ºç™»å½•å®¹å™¨
        const loginContainer = document.getElementById('mobile-login-container');
        if (loginContainer) {
          loginContainer.classList.remove('hidden');
        }

        // éšè—åº•éƒ¨å¯¼èˆªæ å’Œèœå•æŒ‰é’®
        updateMobileNavVisibility(false);

        // å¯é€‰ï¼šæ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·æ•°æ®
        // localStorage.removeItem('userToken');
        // sessionStorage.clear();

        // æ˜¾ç¤ºé€€å‡ºæˆåŠŸæç¤º
        showTempMessage('å·²é€€å‡ºç™»å½•', 'success');
      }
    }

    /**
     * åˆ‡æ¢ç§»åŠ¨ç«¯é¢æ¿æ˜¾ç¤ºï¼ˆç±»ä¼¼Tabåˆ‡æ¢ï¼‰
     * @param {string} panelId - è¦æ˜¾ç¤ºçš„é¢æ¿ID
     * @param {string} mode - 'single' æˆ– 'multi'ï¼ŒæŒ‡å®šæ˜¯å•è´¦å·æ¨¡å¼è¿˜æ˜¯å¤šè´¦å·æ¨¡å¼
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - éšè—æ‰€æœ‰é¢æ¿ï¼Œåªæ˜¾ç¤ºæŒ‡å®šçš„é¢æ¿
     * - ç±»ä¼¼Tabé¡µåˆ‡æ¢ï¼Œè€Œä¸æ˜¯æ»šåŠ¨å®šä½
     * - æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„æ¿€æ´»çŠ¶æ€
     */
    function switchMobilePanel(panelId, mode = 'single') {
      // æ ¹æ®æ¨¡å¼å®šä¹‰é¢æ¿åˆ—è¡¨
      const singleModePanels = [
        'mobile-control-panel',
        'mobile-map-panel',
        'mobile-task-panel',
        'mobile-notification-panel'
      ];

      const multiModePanels = [
        'mobile-multi-account-panel',
        'mobile-multi-map-panel',
        'mobile-multi-control-panel'
      ];

      // é€‰æ‹©è¦æ“ä½œçš„é¢æ¿åˆ—è¡¨
      const panelList = mode === 'single' ? singleModePanels : multiModePanels;

      // éšè—æ‰€æœ‰é¢æ¿
      panelList.forEach(id => {
        const panel = document.getElementById(id);
        if (panel) {
          panel.classList.add('hidden');
        }
      });

      // æ˜¾ç¤ºç›®æ ‡é¢æ¿
      const targetPanel = document.getElementById(panelId);
      if (targetPanel) {
        targetPanel.classList.remove('hidden');
        // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨ï¼Œç¡®ä¿é¢æ¿ä»é¡¶éƒ¨æ˜¾ç¤º
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        console.warn(`æ‰¾ä¸åˆ°IDä¸º ${panelId} çš„é¢æ¿`);
      }

      // æ›´æ–°å¯¼èˆªæ æ¿€æ´»çŠ¶æ€
      updateMobileNavActiveState(panelId);
    }

    /**
     * æ»šåŠ¨åˆ°æŒ‡å®šçš„ç§»åŠ¨ç«¯é¢æ¿
     * @param {string} sectionId - ç›®æ ‡é¢æ¿çš„DOMå…ƒç´ ID
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - å¹³æ»‘æ»šåŠ¨åˆ°æŒ‡å®šçš„ç§»åŠ¨ç«¯é¢æ¿
     * - æ”¯æŒsmoothï¼ˆå¹³æ»‘ï¼‰æ»šåŠ¨åŠ¨ç”»
     * - æ»šåŠ¨åå°†ç›®æ ‡é¢æ¿ç½®äºè§†å£é¡¶éƒ¨
     * - ç”¨äºåº•éƒ¨å¯¼èˆªæ çš„å¯¼èˆªåŠŸèƒ½
     * 
     * @deprecated å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ switchMobilePanel() å®ç°é¢æ¿åˆ‡æ¢
     */
    function scrollToMobileSection(sectionId) {
      // è·å–ç›®æ ‡é¢æ¿å…ƒç´ 
      const section = document.getElementById(sectionId);

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (section) {
        // ä½¿ç”¨scrollIntoViewæ–¹æ³•è¿›è¡Œå¹³æ»‘æ»šåŠ¨
        // behavior: 'smooth' - å¹³æ»‘æ»šåŠ¨åŠ¨ç”»
        // block: 'start' - å°†å…ƒç´ é¡¶éƒ¨å¯¹é½åˆ°è§†å£é¡¶éƒ¨
        section.scrollIntoView({
          behavior: 'smooth',  // å¹³æ»‘æ»šåŠ¨æ•ˆæœ
          block: 'start'       // é¢æ¿é¡¶éƒ¨å¯¹é½åˆ°è§†å£é¡¶éƒ¨
        });

        // æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„æ¿€æ´»çŠ¶æ€
        updateMobileNavActiveState(sectionId);
      } else {
        // å¦‚æœç›®æ ‡é¢æ¿ä¸å­˜åœ¨ï¼Œè¾“å‡ºè­¦å‘Šä¿¡æ¯
        console.warn(`æ‰¾ä¸åˆ°IDä¸º ${sectionId} çš„é¢æ¿`);
      }
    }

    /**
     * æ›´æ–°ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ çš„æ¿€æ´»çŠ¶æ€
     * @param {string} activeSectionId - å½“å‰æ¿€æ´»çš„é¢æ¿ID
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - æ ¹æ®å½“å‰æ˜¾ç¤ºçš„é¢æ¿ï¼Œæ›´æ–°åº•éƒ¨å¯¼èˆªæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
     * - ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
     * - ä¸ºå¯¹åº”çš„æŒ‰é’®æ·»åŠ activeç±»
     */
    function updateMobileNavActiveState(activeSectionId) {
      // è·å–æ‰€æœ‰åº•éƒ¨å¯¼èˆªæŒ‰é’®
      const navButtons = document.querySelectorAll('.mobile-nav-btn');

      // å®šä¹‰é¢æ¿IDå’Œå¯¼èˆªæŒ‰é’®data-navå€¼çš„æ˜ å°„å…³ç³»
      const sectionNavMap = {
        'mobile-control-panel': 'control',
        'mobile-map-panel': 'map',
        'mobile-task-panel': 'home',
        'mobile-notification-panel': 'notifications',
        'mobile-multi-account-panel': 'accounts',
        'mobile-multi-control-panel': 'control',
        'mobile-multi-map-panel': 'map'  // æ·»åŠ å¤šè´¦å·åœ°å›¾é¢æ¿æ˜ å°„
      };

      // è·å–å¯¹åº”çš„å¯¼èˆªæŒ‰é’®æ ‡è¯†
      const targetNav = sectionNavMap[activeSectionId];

      // éå†æ‰€æœ‰å¯¼èˆªæŒ‰é’®ï¼Œæ›´æ–°æ¿€æ´»çŠ¶æ€
      navButtons.forEach(btn => {
        // è·å–æŒ‰é’®çš„data-navå±æ€§å€¼
        const navType = btn.getAttribute('data-nav');

        // å¦‚æœæ˜¯ç›®æ ‡æŒ‰é’®ï¼Œæ·»åŠ activeç±»ï¼›å¦åˆ™ç§»é™¤activeç±»
        if (navType === targetNav) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    /**
     * æ‰“å¼€ç§»åŠ¨ç«¯è´¦å·å‚æ•°è®¾ç½®æ¨¡æ€æ¡†
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨å¤šè´¦å·æ¨¡å¼ä¸‹ï¼Œæ‰“å¼€è´¦å·å‚æ•°è®¾ç½®æ¨¡æ€æ¡†
     * - ç”¨äºé…ç½®æ‰¹é‡è´¦å·çš„è¿è¡Œå‚æ•°
     * - æ˜¾ç¤ºè´¦å·å‚æ•°è®¾ç½®æ¨¡æ€æ¡†
     */
    function openMobileAccountParams() {
      // è·å–è´¦å·å‚æ•°è®¾ç½®æ¨¡æ€æ¡†å…ƒç´ 
      const modal = document.getElementById('mobile-account-params-modal');

      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (modal) {
        // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.classList.remove('hidden');
      } else {
        // å¦‚æœæ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        showTempMessage('å‚æ•°è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
      }
    }

    // ==================== ç§»åŠ¨ç«¯åœ°å›¾æ§åˆ¶å‡½æ•° ====================

    /**
     * å•è´¦å·æ¨¡å¼ï¼šæ”¾å¤§åœ°å›¾
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨mobile-main-appçš„åœ°å›¾é¢æ¿ä¸­æ”¾å¤§åœ°å›¾
     * - è°ƒç”¨åœ°å›¾APIçš„æ”¾å¤§æ–¹æ³•
     * - æ­¤å‡½æ•°ä¸ºå ä½å‡½æ•°ï¼Œå®é™…åŠŸèƒ½éœ€è¦é›†æˆåœ°å›¾åº“ï¼ˆå¦‚é«˜å¾·åœ°å›¾ã€ç™¾åº¦åœ°å›¾ç­‰ï¼‰
     */
    function mobileZoomIn() {
      // TODO: å®ç°åœ°å›¾æ”¾å¤§åŠŸèƒ½
      // ç¤ºä¾‹ï¼šmap.zoomIn();
      showTempMessage('åœ°å›¾æ”¾å¤§åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * å•è´¦å·æ¨¡å¼ï¼šç¼©å°åœ°å›¾
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨mobile-main-appçš„åœ°å›¾é¢æ¿ä¸­ç¼©å°åœ°å›¾
     * - è°ƒç”¨åœ°å›¾APIçš„ç¼©å°æ–¹æ³•
     */
    function mobileZoomOut() {
      // TODO: å®ç°åœ°å›¾ç¼©å°åŠŸèƒ½
      // ç¤ºä¾‹ï¼šmap.zoomOut();
      showTempMessage('åœ°å›¾ç¼©å°åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * å•è´¦å·æ¨¡å¼ï¼šè‡ªé€‚åº”åœ°å›¾è§†å›¾
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨mobile-main-appçš„åœ°å›¾é¢æ¿ä¸­è°ƒæ•´åœ°å›¾è§†å›¾ä»¥é€‚åº”æ‰€æœ‰æ ‡è®°ç‚¹
     * - è‡ªåŠ¨è®¡ç®—æœ€ä½³ç¼©æ”¾çº§åˆ«å’Œä¸­å¿ƒç‚¹
     */
    function mobileFitView() {
      // TODO: å®ç°åœ°å›¾è‡ªé€‚åº”è§†å›¾åŠŸèƒ½
      // ç¤ºä¾‹ï¼šmap.setFitView();
      showTempMessage('åœ°å›¾è‡ªé€‚åº”åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * å¤šè´¦å·æ¨¡å¼ï¼šæ”¾å¤§åœ°å›¾
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨mobile-multi-account-appçš„åœ°å›¾é¢æ¿ä¸­æ”¾å¤§åœ°å›¾
     * - ç”¨äºæ˜¾ç¤ºå¤šä¸ªè´¦å·çš„è·‘æ­¥è·¯çº¿
     */
    function mobileMultiZoomIn() {
      // TODO: å®ç°å¤šè´¦å·åœ°å›¾æ”¾å¤§åŠŸèƒ½
      // ç¤ºä¾‹ï¼šmultiAccountMap.zoomIn();
      showTempMessage('å¤šè´¦å·åœ°å›¾æ”¾å¤§åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * å¤šè´¦å·æ¨¡å¼ï¼šç¼©å°åœ°å›¾
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨mobile-multi-account-appçš„åœ°å›¾é¢æ¿ä¸­ç¼©å°åœ°å›¾
     * - ç”¨äºæ˜¾ç¤ºå¤šä¸ªè´¦å·çš„è·‘æ­¥è·¯çº¿
     */
    function mobileMultiZoomOut() {
      // TODO: å®ç°å¤šè´¦å·åœ°å›¾ç¼©å°åŠŸèƒ½
      // ç¤ºä¾‹ï¼šmultiAccountMap.zoomOut();
      showTempMessage('å¤šè´¦å·åœ°å›¾ç¼©å°åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * å¤šè´¦å·æ¨¡å¼ï¼šè‡ªé€‚åº”åœ°å›¾è§†å›¾
     * 
     * åŠŸèƒ½è¯´æ˜ï¼š
     * - åœ¨mobile-multi-account-appçš„åœ°å›¾é¢æ¿ä¸­è°ƒæ•´åœ°å›¾è§†å›¾
     * - è‡ªåŠ¨é€‚åº”æ‰€æœ‰è´¦å·çš„è·¯çº¿æ ‡è®°ç‚¹
     */
    function mobileMultiFitView() {
      // TODO: å®ç°å¤šè´¦å·åœ°å›¾è‡ªé€‚åº”è§†å›¾åŠŸèƒ½
      // ç¤ºä¾‹ï¼šmultiAccountMap.setFitView();
      showTempMessage('å¤šè´¦å·åœ°å›¾è‡ªé€‚åº”åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    /**
     * HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
     * @param {string} text - éœ€è¦è½¬ä¹‰çš„æ–‡æœ¬
     * @returns {string} è½¬ä¹‰åçš„å®‰å…¨æ–‡æœ¬
     */
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== ä»»åŠ¡8-10: æ³¨å†Œç™»å½•å’Œä¸ªäººèµ„æ–™åŠŸèƒ½ ====================

    // ä»»åŠ¡9: æ‰‹æœºå·/ç”¨æˆ·åç™»å½•åˆ‡æ¢
    // isPhoneLogin: æ ‡è®°å½“å‰æ˜¯å¦ä¸ºæ‰‹æœºå·ç™»å½•æ¨¡å¼ï¼ˆtrue=æ‰‹æœºå·ï¼Œfalse=ç”¨æˆ·åï¼‰
    let isPhoneLogin = false;

    document.addEventListener('DOMContentLoaded', function () {
      // è·å–DOMå…ƒç´ ï¼šç”¨æˆ·å/æ‰‹æœºå·åˆ‡æ¢æŒ‰é’®
      const usernameBtn = document.getElementById('auth-login-username-btn');
      const phoneBtn = document.getElementById('auth-login-phone-btn');
      // authInput: è¾“å…¥æ¡†å…ƒç´ ï¼ˆid=auth-usernameï¼‰
      const authInput = document.getElementById('auth-username');
      // authLabel: è¾“å…¥æ¡†ä¸Šæ–¹çš„labelæ ‡ç­¾
      const authLabel = document.getElementById('auth-login-label');
      // authUsernameContainer: è¾“å…¥æ¡†çš„çˆ¶å®¹å™¨ï¼Œç”¨äºåŠ¨æ€æ·»åŠ /ç§»é™¤+86å‰ç¼€wrapper
      const authUsernameContainer = document.getElementById('auth-username-container');

      if (usernameBtn && phoneBtn) {
        // ===== ç”¨æˆ·åç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶ =====
        usernameBtn.addEventListener('click', function () {
          // è®¾ç½®ä¸ºç”¨æˆ·åç™»å½•æ¨¡å¼
          isPhoneLogin = false;
          // æ›´æ–°æŒ‰é’®æ ·å¼ï¼šç”¨æˆ·åæŒ‰é’®é«˜äº®ï¼ˆactiveï¼‰ï¼Œæ‰‹æœºå·æŒ‰é’®å˜ç°
          usernameBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          phoneBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          // æ›´æ–°è¾“å…¥æ¡†å±æ€§ï¼šåˆ‡æ¢ä¸ºæ–‡æœ¬è¾“å…¥æ¨¡å¼
          authInput.type = 'text';
          authInput.placeholder = 'è¯·è¾“å…¥ç”¨æˆ·å';
          authInput.removeAttribute('inputmode'); // ç§»é™¤æ•°å­—é”®ç›˜å±æ€§
          authInput.removeAttribute('maxlength'); // ç§»é™¤é•¿åº¦é™åˆ¶
          // æ›´æ–°labelæ–‡æœ¬ä¸º"ç”¨æˆ·å"
          if (authLabel) authLabel.textContent = 'ç”¨æˆ·å';

          // ===== ç§»é™¤+86å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ =====
          // ç­–ç•¥ï¼šå°†å®¹å™¨å†…çš„HTMLæ›¿æ¢ä¸ºä¸å¸¦å‰ç¼€çš„çº¯è¾“å…¥æ¡†
          if (authUsernameContainer) {
            // ä¿å­˜å½“å‰è¾“å…¥æ¡†çš„å€¼ï¼ˆé˜²æ­¢åˆ‡æ¢æ—¶ä¸¢å¤±ç”¨æˆ·è¾“å…¥ï¼‰
            const currentValue = authInput.value;
            // é‡æ–°æ¸²æŸ“å®¹å™¨å†…å®¹ï¼šä¸å¸¦phone-input-wrapperï¼Œç›´æ¥æ˜¯inputå…ƒç´ 
            authUsernameContainer.innerHTML = `
              <input type="text" id="auth-username" class="input-field mt-1" 
                     placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
            `;
            // æ¢å¤ä¹‹å‰ä¿å­˜çš„è¾“å…¥å€¼
            const newAuthInput = document.getElementById('auth-username');
            newAuthInput.value = currentValue;
            newAuthInput.removeAttribute('maxlength'); // ç¡®ä¿æ–°è¾“å…¥æ¡†ä¹Ÿç§»é™¤é™åˆ¶
          }

          // éšè—"ä½¿ç”¨éªŒè¯ç ç™»å½•"æŒ‰é’®ï¼ˆç”¨æˆ·åç™»å½•åªèƒ½ç”¨å¯†ç ï¼‰
          const switchToSms = document.getElementById('auth-switch-to-sms');
          if (switchToSms) switchToSms.classList.add('hidden');

          // ç¡®ä¿æ˜¾ç¤ºå¯†ç è¾“å…¥åŒºåŸŸï¼Œéšè—éªŒè¯ç è¾“å…¥åŒºåŸŸ
          const passwordSection = document.getElementById('auth-password-section');
          const smsSection = document.getElementById('auth-sms-section');
          if (passwordSection) passwordSection.classList.remove('hidden');
          if (smsSection) smsSection.classList.add('hidden');
        });

        // ===== æ‰‹æœºå·ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶ =====
        phoneBtn.addEventListener('click', function () {
          // è®¾ç½®ä¸ºæ‰‹æœºå·ç™»å½•æ¨¡å¼
          isPhoneLogin = true;
          // æ›´æ–°æŒ‰é’®æ ·å¼ï¼šæ‰‹æœºå·æŒ‰é’®é«˜äº®ï¼ˆactiveï¼‰ï¼Œç”¨æˆ·åæŒ‰é’®å˜ç°
          phoneBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          usernameBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          /// æ›´æ–°è¾“å…¥æ¡†å±æ€§ï¼šåˆ‡æ¢ä¸ºæ‰‹æœºå·è¾“å…¥æ¨¡å¼
          authInput.type = 'tel';
          authInput.placeholder = 'è¯·è¾“å…¥æ‰‹æœºå·';
          authInput.setAttribute('inputmode', 'numeric'); // è§¦å‘æ•°å­—é”®ç›˜
          authInput.setAttribute('maxlength', '11'); // é™åˆ¶11ä½
          // æ›´æ–°labelæ–‡æœ¬ä¸º"æ‰‹æœºå·"
          if (authLabel) authLabel.textContent = 'æ‰‹æœºå·';

          // ===== æ·»åŠ +86å‰ç¼€ =====
          // ç­–ç•¥ï¼šå°†å®¹å™¨å†…çš„HTMLæ›¿æ¢ä¸ºå¸¦phone-input-wrapperçš„ç»“æ„
          if (authUsernameContainer) {
            // ä¿å­˜å½“å‰è¾“å…¥æ¡†çš„å€¼ï¼ˆé˜²æ­¢åˆ‡æ¢æ—¶ä¸¢å¤±ç”¨æˆ·è¾“å…¥ï¼‰
            const currentValue = authInput.value;
            // é‡æ–°æ¸²æŸ“å®¹å™¨å†…å®¹ï¼šä½¿ç”¨phone-input-wrapperåŒ…è£¹ï¼Œæ·»åŠ +86å‰ç¼€
            authUsernameContainer.innerHTML = `
              <div class="phone-input-wrapper mt-1">
                <span class="phone-prefix">+86 </span>
                <input type="tel" id="auth-username" class="input-field" 
                       placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel" inputmode="numeric" maxlength="11">
              </div>
            `; // <-- å·²åœ¨inputä¸­åŠ å…¥ maxlength="11"
            // æ¢å¤ä¹‹å‰ä¿å­˜çš„è¾“å…¥å€¼
            document.getElementById('auth-username').value = currentValue;
          }

          // æ˜¾ç¤º"ä½¿ç”¨éªŒè¯ç ç™»å½•"æŒ‰é’®ï¼ˆæ‰‹æœºå·ç™»å½•æ”¯æŒå¯†ç æˆ–éªŒè¯ç ï¼‰
          const switchToSms = document.getElementById('auth-switch-to-sms');
          if (switchToSms) switchToSms.classList.remove('hidden');
        });
      }

      // éªŒè¯ç /å¯†ç ç™»å½•åˆ‡æ¢
      const switchToSms = document.getElementById('auth-switch-to-sms');
      const switchToPassword = document.getElementById('auth-switch-to-password');
      const passwordSection = document.getElementById('auth-password-section');
      const smsSection = document.getElementById('auth-sms-section');

      if (switchToSms) {
        switchToSms.addEventListener('click', function () {
          passwordSection.classList.add('hidden');
          smsSection.classList.remove('hidden');
        });
      }

      if (switchToPassword) {
        switchToPassword.addEventListener('click', function () {
          smsSection.classList.add('hidden');
          passwordSection.classList.remove('hidden');
        });
      }

      // å‘é€ç™»å½•éªŒè¯ç 
      const sendLoginCodeBtn = document.getElementById('auth-send-login-code');
      if (sendLoginCodeBtn) {
        sendLoginCodeBtn.addEventListener('click', async function () {
          const phone = document.getElementById('auth-username').value;
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
            return;
          }

          sendLoginCodeBtn.disabled = true;
          const originalText = sendLoginCodeBtn.textContent;

          try {
            // ä¿®æ­£ï¼šä½¿ç”¨ fetch è°ƒç”¨ç‹¬ç«‹çš„ /api/sms/send_code æ¥å£
            const response = await fetch('/api/sms/send_code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                phone: phone,
                scene: 'login' // åœºæ™¯ï¼šç™»å½•
              })
            });
            const result = await response.json();

            if (result && result.success) {
              const expireMin = result.expire_minutes || 5;
              const retryAfter = result.retry_after || 180;
              showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

              let countdown = retryAfter;
              const timer = setInterval(() => {
                countdown--;
                sendLoginCodeBtn.textContent = countdown + 'ç§’';
                if (countdown <= 0) {
                  clearInterval(timer);
                  sendLoginCodeBtn.disabled = false;
                  sendLoginCodeBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              if (result?.retry_after) {
                const retrySeconds = result.retry_after;
                let countdown = retrySeconds;
                sendLoginCodeBtn.textContent = countdown + 'ç§’';
                const timer = setInterval(() => {
                  countdown--;
                  sendLoginCodeBtn.textContent = countdown + 'ç§’';
                  if (countdown <= 0) {
                    clearInterval(timer);
                    sendLoginCodeBtn.disabled = false;
                    sendLoginCodeBtn.textContent = originalText;
                  }
                }, 1000);
              } else {
                sendLoginCodeBtn.disabled = false;
              }
              showModalAlert(result?.message || 'å‘é€å¤±è´¥');
            }
          } catch (error) {
            sendLoginCodeBtn.disabled = false;
            showModalAlert('å‘é€å¤±è´¥: ' + error.message);
          }
        });
      }

      // ä»»åŠ¡8: æ³¨å†Œè¡¨å•éªŒè¯
      const regUsernameInput = document.getElementById('auth-reg-username');
      if (regUsernameInput) {
        regUsernameInput.addEventListener('input', function (e) {
          // ç¦æ­¢è¾“å…¥ä¸­æ–‡
          const value = e.target.value;
          const noChinese = value.replace(/[ä¸€-é¾¥]/g, '');
          if (value !== noChinese) {
            e.target.value = noChinese;
            showTempMessage('ç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦', 'warning');
          }
        });
      }

      // å¤´åƒé¢„è§ˆ
      const avatarInput = document.getElementById('auth-reg-avatar');
      if (avatarInput) {
        // è°ƒç”¨ previewAvatarForRegistration æ¥æ‰“å¼€è£å‰ªæ¨¡æ€æ¡†
        avatarInput.addEventListener('change', previewAvatarForRegistration);
      }

      // å‘é€æ³¨å†ŒéªŒè¯ç 
      const sendCodeBtn = document.getElementById('auth-reg-send-code-btn');
      if (sendCodeBtn) {
        sendCodeBtn.addEventListener('click', async function () {
          const phone = document.getElementById('auth-reg-phone').value;
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
            return;
          }

          sendCodeBtn.disabled = true;
          const originalText = sendCodeBtn.textContent;

          try {
            // ä¿®æ­£ï¼šä½¿ç”¨ fetch è°ƒç”¨ç‹¬ç«‹çš„ /api/sms/send_code æ¥å£
            const response = await fetch('/api/sms/send_code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                phone: phone,
                scene: 'register' // åœºæ™¯ï¼šæ³¨å†Œ
              })
            });
            const result = await response.json();

            if (result && result.success) {
              const expireMin = result.expire_minutes || 5;
              const retryAfter = result.retry_after || 180;  // è·å–å‘é€é—´éš”
              showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

              // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„é—´éš”æ—¶é—´è¿›è¡Œå€’è®¡æ—¶
              let countdown = retryAfter;
              const timer = setInterval(() => {
                countdown--;
                sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
                if (countdown <= 0) {
                  clearInterval(timer);
                  sendCodeBtn.disabled = false;
                  sendCodeBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              // å¤„ç†é¢‘ç¹å‘é€é”™è¯¯ï¼Œæ˜¾ç¤ºå‰©ä½™ç­‰å¾…æ—¶é—´
              if (result?.retry_after) {
                const retrySeconds = result.retry_after;
                let countdown = retrySeconds;
                sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
                const timer = setInterval(() => {
                  countdown--;
                  sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
                  if (countdown <= 0) {
                    clearInterval(timer);
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = originalText;
                  }
                }, 1000);
              } else {
                sendCodeBtn.disabled = false;
              }
              showModalAlert(result?.message || 'å‘é€å¤±è´¥');
            }
          } catch (error) {
            sendCodeBtn.disabled = false;
            showModalAlert('å‘é€å¤±è´¥: ' + error.message);
          }
        });
      }
    });

    // ä»»åŠ¡10: ä¿®æ”¹æ‰‹æœºå·åŠŸèƒ½
    function modifyPhone() {
      const currentPhone = document.getElementById('profile-phone').value;
      document.getElementById('modify-phone-current').value = currentPhone;
      document.getElementById('modify-phone-new').value = '';
      document.getElementById('modify-phone-code').value = '';
      document.getElementById('modify-phone-modal').style.display = 'flex';
      document.body.classList.add('modal-visible'); // éšè—åœ°å›¾ç‰ˆæƒ


      const currentPhoneInput = document.getElementById('modify-phone-current');
      const currentPhoneWrapper = currentPhoneInput ? currentPhoneInput.closest('.phone-input-wrapper') : null;
      if (currentPhoneWrapper) {
        const prefix = currentPhoneWrapper.querySelector('.phone-prefix');
        // ç¼“å­˜åˆ¤æ–­ç»“æœ
        const isUnbound = (!currentPhoneInput.value || currentPhoneInput.value === 'æœªç»‘å®š');

        if (prefix) {
          prefix.style.display = isUnbound ? 'none' : 'inline';
        }
        // [æ–°ä¿®å¤] æ ¹æ®å‰ç¼€æ˜¯å¦éšè—ï¼Œåˆ‡æ¢ wrapper ä¸Šçš„ class
        currentPhoneWrapper.classList.toggle('prefix-hidden', isUnbound);
      }

    }

    function closeModifyPhoneModal() {
      document.getElementById('modify-phone-modal').style.display = 'none';
      // document.body.classList.remove('modal-visible'); // æ¢å¤åœ°å›¾ç‰ˆæƒ
    }

    async function sendModifyPhoneCode() {
      const newPhone = document.getElementById('modify-phone-new').value;
      if (!newPhone || !/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ–°æ‰‹æœºå·');
        return;
      }

      const btn = document.getElementById('modify-phone-send-btn');
      btn.disabled = true;
      const originalText = btn.textContent;

      try {
        // ä¿®æ­£ï¼šä½¿ç”¨ fetch è°ƒç”¨ç‹¬ç«‹çš„ /api/sms/send_code æ¥å£
        const response = await fetch('/api/sms/send_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: newPhone,
            scene: 'modify' // åœºæ™¯ï¼šç”¨æˆ·ä¿®æ”¹
          })
        });
        const result = await response.json();

        if (result && result.success) {
          const expireMin = result.expire_minutes || 5;
          const retryAfter = result.retry_after || 180;
          showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

          let countdown = retryAfter;
          const timer = setInterval(() => {
            countdown--;
            btn.textContent = `${countdown}ç§’`;
            if (countdown <= 0) {
              clearInterval(timer);
              btn.disabled = false;
              btn.textContent = originalText;
            }
          }, 1000);
        } else {
          if (result?.retry_after) {
            const retrySeconds = result.retry_after;
            let countdown = retrySeconds;
            btn.textContent = `${countdown}ç§’`;
            const timer = setInterval(() => {
              countdown--;
              btn.textContent = `${countdown}ç§’`;
              if (countdown <= 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = originalText;
              }
            }, 1000);
          } else {
            btn.disabled = false;
          }
          showModalAlert(result?.message || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        btn.disabled = false;
        showModalAlert('å‘é€å¤±è´¥: ' + error.message);
      }
    }




    async function confirmModifyPhone() {
      const newPhone = document.getElementById('modify-phone-new').value;
      const code = document.getElementById('modify-phone-code').value;



      // éªŒè¯æ‰‹æœºå·æ ¼å¼
      if (!/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ–°æ‰‹æœºå·æ ¼å¼');
        return;
      }

      // æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²è¢«ç»‘å®š
      try {
        // å¿…é¡»ä½¿ç”¨ callPythonAPI_raw (æˆ– fetch) æ¥è°ƒç”¨ /api/auth/check_phone
        const bindResult = await callPythonAPI_raw('/api/auth/check_phone', 'POST', { phone: newPhone });

        // currentAuthUsername æ˜¯åœ¨ç™»å½•æ—¶è®¾ç½®çš„å…¨å±€JSå˜é‡
        if (bindResult && bindResult.is_bound && bindResult.bound_to_user !== currentAuthUsername) {
          // æ‰‹æœºå·è¢«å…¶ä»–äººå ç”¨äº†ï¼Œå¼¹çª—ç¡®è®¤
          const confirmed = await jsShowConfirm(
            'æ‰‹æœºå·å·²è¢«ç»‘å®š',
            `æ‚¨è¾“å…¥çš„æ–°æ‰‹æœºå· ${newPhone} å·²è¢«ç”¨æˆ· ${bindResult.bound_to_user} ç»‘å®šã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ\n\nå¦‚æœç»§ç»­ï¼Œè¯¥æ‰‹æœºå·å°†ä»åŸè´¦å·ä¸Šå¼ºåˆ¶è§£ç»‘å¹¶ç»‘å®šåˆ°æ‚¨çš„è´¦å·ä¸Šã€‚`
          );

          if (!confirmed) {
            logMessage_Info("[ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œå› ä¸ºæ‰‹æœºå·å·²è¢«ç»‘å®šã€‚");
            return; // ç”¨æˆ·å–æ¶ˆ
          }
          logMessage_Info("[ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å·²ç¡®è®¤å¼ºåˆ¶è§£ç»‘ï¼Œç»§ç»­æ“ä½œ...");
        } else if (bindResult && bindResult.is_bound && bindResult.bound_to_user === currentAuthUsername) {
          // æ‰‹æœºå·å·²ç»ç»‘å®šåœ¨è‡ªå·±èº«ä¸Š
          showModalAlert('æ­¤æ‰‹æœºå·å·²ç»‘å®šåˆ°æ‚¨çš„è´¦å·ã€‚', 'æç¤º');
          closeModifyPhoneModal();
          return;
        }
        // æœªç»‘å®šæˆ–æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œï¼ˆåç«¯ä¼šéªŒè¯éªŒè¯ç ï¼‰

        if (!newPhone || !code) {
          showModalAlert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
          return;
        }

      } catch (e) {
        logMessage_Error('æ£€æŸ¥æ‰‹æœºå·ç»‘å®šå¤±è´¥:', e);
        showModalAlert(`æ£€æŸ¥æ‰‹æœºå·å¤±è´¥: ${e.message}ï¼Œè¯·ç¨åé‡è¯•`, 'ç½‘ç»œé”™è¯¯');
        return; // æ£€æŸ¥å¤±è´¥æ—¶åœæ­¢
      }


      try {
        // ä¿®æ­£ï¼šå¿…é¡»ä½¿ç”¨ callPythonAPI_raw (æˆ– fetch) æ¥è°ƒç”¨ /api/user/update_phone
        const result = await callPythonAPI_raw('/api/user/update_phone', 'POST', {
          new_phone: newPhone,
          sms_code: code
        });

        if (result && result.success) {
          showModalAlert('æ‰‹æœºå·ä¿®æ”¹æˆåŠŸ');
          document.getElementById('profile-phone').value = newPhone;
          closeModifyPhoneModal();
        } else {
          showModalAlert(result?.message || 'ä¿®æ”¹å¤±è´¥');
        }
      } catch (error) {
        showModalAlert('ä¿®æ”¹å¤±è´¥: ' + error.message);
      }
    }

    async function loadSystemConfig() {
      const formContainer = $('admin-config-form');
      formContainer.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        const response = await fetch('/api/admin/config/load', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (!result.success) {
          formContainer.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½é…ç½®å¤±è´¥: ${result.message}</p>`;
          return;
        }

        const config = result.config;
        formContainer.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºè¡¨å•é¡¹
        const createInput = (section, key, label, type = 'text', help = '') => {
          const value = config[section]?.[key];
          let inputHtml = '';
          if (type === 'boolean') {
            inputHtml = `
              <select id="config-${section}-${key}" class="select-field">
                <option value="true" ${value === true ? 'selected' : ''}>å¯ç”¨</option>
                <option value="false" ${value === false ? 'selected' : ''}>ç¦ç”¨</option>
              </select>
            `;
          } else if (type === 'number') {
            inputHtml = `<input type="number" id="config-${section}-${key}" value="${value}" class="input-field">`;
          } else if (type === 'password_storage') {
            inputHtml = `
              <select id="config-${section}-${key}" class="select-field">
                <option value="plaintext" ${value === 'plaintext' ? 'selected' : ''}>æ˜æ–‡</option>
                <option value="sha256" ${value === 'sha256' ? 'selected' : ''}>sha256</option>
                <option value="bcrypt" ${value === 'bcrypt' ? 'selected' : ''}>bcrypt(è‡ªåŠ¨åŠ ç›)</option>
              </select>
            `;
          } else {
            inputHtml = `<input type="text" id="config-${section}-${key}" value="${value}" class="input-field">`;
          }

          return `
            <div class="mb-3">
              <label for="config-${section}-${key}" class="block text-sm font-semibold text-slate-700">${label} <!-- <span class="text-xs font-mono text-slate-400">[${section}] ${key}</span> --></label>
              ${inputHtml}
              ${help ? `<p class="text-xs text-slate-500 mt-1">${help}</p>` : ''}
            </div>
          `;
        };

        let html = '';

        // [Guest]
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mb-2">æ¸¸å®¢é…ç½®</h5>';
        html += createInput('Guest', 'allow_guest_login', 'å…è®¸æ¸¸å®¢ç™»å½•', 'boolean', 'æ˜¯å¦å…è®¸æœªæ³¨å†Œç”¨æˆ·ä»¥æ¸¸å®¢èº«ä»½ä½¿ç”¨ç³»ç»Ÿã€‚');

        // [System]
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">ç³»ç»Ÿé…ç½®</h5>';
        html += createInput('System', 'session_expiry_days', 'ä¼šè¯è¿‡æœŸæ—¶é—´ (å¤©)', 'number', 'è¶…è¿‡æ­¤æ—¶é—´æœªè®¿é—®çš„ä¼šè¯å°†è¢«è‡ªåŠ¨æ¸…ç†ã€‚');
        html += createInput('System', 'school_accounts_dir', 'å­¦æ ¡è´¦å·ç›®å½•', 'text', 'å­˜å‚¨ school_accounts/*.ini æ–‡ä»¶çš„ç›®å½•ã€‚');
        html += createInput('System', 'system_accounts_dir', 'ç³»ç»Ÿè´¦å·ç›®å½•', 'text', 'å­˜å‚¨ system_accounts/*.json æ–‡ä»¶çš„ç›®å½•ã€‚');
        html += createInput('System', 'permissions_file', 'æƒé™æ–‡ä»¶å', 'text', 'å­˜å‚¨æƒé™é…ç½®çš„JSONæ–‡ä»¶åã€‚');
        html += createInput('System', 'session_monitor_check_interval', 'ä¼šè¯ç›‘æ§é—´éš” (ç§’)', 'number', 'ç³»ç»Ÿæ£€æŸ¥ä¼šè¯æ´»è·ƒçŠ¶æ€çš„é—´éš”ã€‚');
        html += createInput('System', 'session_inactivity_timeout', 'ä¼šè¯ä¸æ´»è·ƒè¶…æ—¶ (ç§’)', 'number', 'ä¼šè¯æ— æ´»åŠ¨è¶…è¿‡æ­¤æ—¶é—´å°†è¢«æ¸…ç†ã€‚');

        // [Logging]
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">æ—¥å¿—é…ç½®</h5>';
        html += createInput('Logging', 'log_rotation_size_mb', 'æ—¥å¿—è½®è½¬å¤§å° (MB)', 'number', 'å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ã€‚');
        html += createInput('Logging', 'archive_max_size_mb', 'å½’æ¡£ç›®å½•æœ€å¤§ (MB)', 'number', 'å½’æ¡£ç›®å½•æ€»å¤§å°é™åˆ¶ï¼Œ0ä¸ºä¸é™åˆ¶ã€‚');
        html += createInput('Logging', 'log_dir', 'æ—¥å¿—ç›®å½•', 'text', 'å­˜å‚¨ zx-slm-tool.log æ–‡ä»¶çš„ç›®å½•ã€‚');
        html += createInput('Logging', 'archive_dir', 'å½’æ¡£ç›®å½•', 'text', 'å­˜å‚¨å‹ç¼©æ—¥å¿— (logs/archive) çš„ç›®å½•ã€‚');

        // [Security]
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">å®‰å…¨é…ç½®</h5>';
        html += createInput('Security', 'password_storage', 'å¯†ç å­˜å‚¨æ–¹å¼', 'password_storage', 'ä¿®æ”¹æ­¤é¡¹å¯èƒ½å¯¼è‡´æ—§å¯†ç å¤±æ•ˆã€‚');
        html += createInput('Security', 'brute_force_protection', 'å¯ç”¨æš´åŠ›ç ´è§£é˜²æŠ¤', 'boolean', 'é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°ã€‚');
        html += createInput('Security', 'login_log_retention_days', 'ç™»å½•æ—¥å¿—ä¿ç•™ (å¤©)', 'number', 'ç™»å½•å®¡è®¡æ—¥å¿—çš„ä¿ç•™å¤©æ•°ã€‚');

        // [Map]
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">åœ°å›¾é…ç½®</h5>';
        html += createInput('Map', 'amap_js_key', 'é«˜å¾·åœ°å›¾ API Key', 'text', 'ç”¨äºå‰ç«¯åœ°å›¾æ˜¾ç¤ºçš„JS API Keyã€‚');

        formContainer.innerHTML = html;

      } catch (e) {
        formContainer.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}</p>`;
      }
    }

    /**
     * ä¿å­˜ config.ini é…ç½®é¡¹
     */
    async function saveSystemConfig() {
      const btn = $('admin-save-config_modal');
      setButtonLoading(btn, true, 'ä¿å­˜ä¸­...');

      try {
        // æ”¶é›†æ‰€æœ‰æ•°æ®
        const configData = {
          'Guest': {
            'allow_guest_login': $('config-Guest-allow_guest_login').value === 'true'
          },
          'System': {
            'session_expiry_days': parseInt($('config-System-session_expiry_days').value, 10),
            'school_accounts_dir': $('config-System-school_accounts_dir').value,
            'system_accounts_dir': $('config-System-system_accounts_dir').value,
            'permissions_file': $('config-System-permissions_file').value,
            'session_monitor_check_interval': parseInt($('config-System-session_monitor_check_interval').value, 10),
            'session_inactivity_timeout': parseInt($('config-System-session_inactivity_timeout').value, 10)
          },
          'Logging': {
            'log_rotation_size_mb': parseInt($('config-Logging-log_rotation_size_mb').value, 10),
            'archive_max_size_mb': parseInt($('config-Logging-archive_max_size_mb').value, 10),
            'log_dir': $('config-Logging-log_dir').value,
            'archive_dir': $('config-Logging-archive_dir').value
          },
          'Security': {
            'password_storage': $('config-Security-password_storage').value,
            'brute_force_protection': $('config-Security-brute_force_protection').value === 'true',
            'login_log_retention_days': parseInt($('config-Security-login_log_retention_days').value, 10)
          },
          'Map': {
            'amap_js_key': $('config-Map-amap_js_key').value
          }
        };

        // å‘é€åˆ°åç«¯
        const response = await fetch('/api/admin/config/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(configData)
        });

        const result = await response.json();

        if (result.success) {
          showModalAlert('é…ç½®å·²ä¿å­˜ã€‚è¯·æ³¨æ„ï¼Œéƒ¨åˆ†é…ç½®ï¼ˆå¦‚è·¯å¾„ï¼‰éœ€è¦é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆã€‚', 'ä¿å­˜æˆåŠŸ');
          showButtonSuccess(btn, 'ä¿å­˜æˆåŠŸ', 2000);
        } else {
          showModalAlert(`ä¿å­˜å¤±è´¥: ${result.message}`, 'ä¿å­˜å¤±è´¥');
          showButtonError(btn, 'ä¿å­˜å¤±è´¥', 2000);
        }
      } catch (e) {
        showModalAlert(`ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`, 'ä¿å­˜å¤±è´¥');
        showButtonError(btn, 'ä¿å­˜å¤±è´¥', 2000);
      } finally {
        setButtonLoading(btn, false, 'ä¿å­˜é…ç½®');
      }
    }



    function showTempMessage(msg, type = 'info') {
      // ä¸´æ—¶æ¶ˆæ¯æç¤ºï¼ˆ3ç§’è‡ªåŠ¨æ¶ˆå¤±ï¼‰
      const colors = {
        success: 'bg-green-100 text-green-700 border-green-300',
        warning: 'bg-amber-100 text-amber-700 border-amber-300',
        error: 'bg-red-100 text-red-700 border-red-300',
        info: 'bg-blue-100 text-blue-700 border-blue-300'
      };

      const div = document.createElement('div');
      div.className = `fixed top-4 right-4 px-4 py-2 rounded-lg border-2 ${colors[type]} z-50 shadow-lg`;
      div.textContent = msg;
      document.body.appendChild(div);

      setTimeout(() => {
        div.remove();
      }, 3000);
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ç¡®ä¿ APP_CONFIG å·²è¢«æ³¨å…¥
      if (typeof window.APP_CONFIG === 'undefined') {
        console.error('APP_CONFIG æœªå®šä¹‰, UIåŠ¨æ€é…ç½®è„šæœ¬è·³è¿‡ã€‚');
        // ä½œä¸ºä¸€ä¸ªå®‰å…¨çš„Bè®¡åˆ’ï¼Œéšè—æ‰€æœ‰ä¾èµ–é¡¹
        window.APP_CONFIG = { sms_enabled: false, reg_verify_enabled: false };
      }

      const config = window.APP_CONFIG;

      // 1. æ ¹æ® sms_enabled (çŸ­ä¿¡æ€»å¼€å…³) æ§åˆ¶
      if (!config.sms_enabled) {
        console.log('çŸ­ä¿¡æœåŠ¡å·²ç¦ç”¨ï¼Œæ­£åœ¨éšè—ç›¸å…³UIå…ƒç´ ...');

        // ç™»å½•è¡¨å•: éšè—â€œä½¿ç”¨éªŒè¯ç ç™»å½•â€æŒ‰é’®
        const switchToSmsBtn = document.getElementById('auth-switch-to-sms');
        if (switchToSmsBtn) switchToSmsBtn.style.display = 'none';

        // ç™»å½•è¡¨å•: éšè—â€œçŸ­ä¿¡éªŒè¯ç â€æ•´ä¸ªåŒºåŸŸ (åŒ…å«å‘é€æŒ‰é’®)
        const smsSection = document.getElementById('auth-sms-section');
        if (smsSection) smsSection.style.display = 'none';

        // ç®¡ç†å‘˜ä¿®æ”¹æ‰‹æœºå·æ¨¡æ€æ¡†: éšè—éªŒè¯ç éƒ¨åˆ†
        const adminModifySmsGroup = document.getElementById('admin-modify-phone-sms-group');
        if (adminModifySmsGroup) adminModifySmsGroup.style.display = 'none';

        // æ–°ç”¨æˆ·æ¨¡æ€æ¡†: éšè—éªŒè¯ç éƒ¨åˆ†
        const newUserSmsGroup = document.getElementById('newUserSmsGroup');
        if (newUserSmsGroup) newUserSmsGroup.style.display = 'none';
      }

      // 2. æ ¹æ® enable_phone_registration_verify (æ‰‹æœºæ³¨å†Œ/éªŒè¯å¼€å…³) æ§åˆ¶
      if (!config.reg_verify_enabled) {
        console.log('æ‰‹æœºæ³¨å†Œ/éªŒè¯å·²ç¦ç”¨ï¼Œæ­£åœ¨éšè—ç›¸å…³UIå…ƒç´ ...');

        // æ³¨å†Œè¡¨å•: éšè—æ‰‹æœºå·è¾“å…¥æ¡†
        const regPhoneDiv = document.getElementById('auth-reg-phone-wrapper');
        if (regPhoneDiv) regPhoneDiv.style.display = 'none';

        // æ³¨å†Œè¡¨å•: éšè—éªŒè¯ç è¾“å…¥æ¡†
        const regSmsDiv = document.getElementById('auth-reg-sms-wrapper');
        if (regSmsDiv) regSmsDiv.style.display = 'none';

        // ä¸ªäººèµ„æ–™: éšè—â€œä¿®æ”¹æ‰‹æœºå·â€æŒ‰é’®
        const profileModifyBtn = document.getElementById('profile-modify-phone-btn');
        if (profileModifyBtn) profileModifyBtn.style.display = 'none';
        const profilePhoneHint = document.getElementById('profile-phone-hint');
        if (profilePhoneHint) profilePhoneHint.style.display = 'none';
      }
    });
  </script>



</body>

</html>