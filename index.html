<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <script>
    
    
    

    function handleCdnError(resourceName) {
      resourceName = resourceName || 'æœªæŒ‡å®š';
      cdnErrorCount++;
      console.warn('CDNèµ„æº[' + resourceName + ']åŠ è½½å¤±è´¥ (' + cdnErrorCount + '/3)');

      if (cdnErrorTimer) {
        clearTimeout(cdnErrorTimer);
      }

      cdnErrorTimer = setTimeout(function () {
        if (!appInitialized && cdnErrorCount > 0) {
          var errorOverlay = document.getElementById('cdn-error-overlay');
          if (errorOverlay) {
            
            errorOverlay.style.display = 'flex';
            errorOverlay.classList.remove('hidden');
            console.error('åº”ç”¨åˆå§‹åŒ–è¶…æ—¶ï¼ŒCDNèµ„æºåŠ è½½å¤±è´¥ï¼Œå·²æ˜¾ç¤ºé”™è¯¯æç¤ºã€‚');
          }
        }
      }, 3000);
    }
  </script>

  <script src="https:
  <meta charset="UTF-8">
  <title>è·‘æ­¥åŠ©æ‰‹</title>
  
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https:
  <link rel="preconnect" href="https:
  <link rel="preconnect" href="https:
  <link
    href="https:
    rel="stylesheet" onerror="handleCdnError()">

  <script src="https:
  <script src="https:
  <script src="https:
  <link rel="stylesheet" href="https:
  <script src="https:
  <script>
    
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { 'sans': ['Noto Sans SC', 'system-ui', 'sans-serif'], 'display': ['Zilla Slab', 'serif'] },
            colors: { 'base': '#7dd3fc' }
          }
        }
      }
    } else {
      console.error("Tailwind CSS æœªåŠ è½½ï¼Œè·³è¿‡é…ç½®ã€‚");
      
      if (typeof handleCdnError === 'function') handleCdnError('TailwindCSS');
    }
  </script>
  <style>
    



    
    body {
      background: linear-gradient(180deg, rgba(245, 250, 255, 1) 0%, rgba(235, 245, 255, 1) 40%, rgba(250, 240, 255, 1) 100%);
      background-attachment: fixed;

    }

    .panel {
      backdrop-filter: blur(16px);
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.45);
      box-shadow: 0 10px 24px rgba(16, 24, 40, 0.12);
    }

    
    body.theme-anime {
      
      background-image: url('https:
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    body.theme-anime .panel {
      
      background-color: rgba(255, 255, 255, 0.65);
      
      backdrop-filter: blur(20px) saturate(150%);
      
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }

    
    body.theme-minimalist {
      background: #f8f9fa;
      
    }

    body.theme-minimalist .panel {
      background-color: #ffffff;
      backdrop-filter: none;
      
      border: 1px solid #e9ecef;
      
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      
      border-radius: 12px;
      
    }

    
    
    body.dark-mode {
      
      background: linear-gradient(180deg, rgba(17, 24, 39, 1) 0%, rgba(31, 41, 55, 1) 40%, rgba(55, 48, 68, 1) 100%);
      background-attachment: fixed;
      
      color: #e5e7eb;
    }

    
    body.dark-mode .panel {
      background-color: rgba(31, 41, 55, 0.8);
      
      backdrop-filter: blur(16px);
      border: 1px solid rgba(75, 85, 99, 0.5);
      
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      
    }

    
    body.dark-mode .input-field,
    body.dark-mode .select-field,
    body.dark-mode input[type="text"],
    body.dark-mode input[type="password"],
    body.dark-mode input[type="email"],
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode textarea,
    body.dark-mode select {
      background-color: rgba(55, 65, 81, 0.8);
      
      border-color: rgba(107, 114, 128, 0.5);
      
      color: #e5e7eb;
      
    }

    
    body.dark-mode .input-field:focus,
    body.dark-mode .select-field:focus,
    body.dark-mode input:focus,
    body.dark-mode textarea:focus,
    body.dark-mode select:focus {
      border-color: rgba(96, 165, 250, 0.8);
      
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
    }

    
    body.dark-mode .btn {
      background-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
      border-color: rgba(107, 114, 128, 0.5);
    }

    body.dark-mode .btn:hover {
      background-color: rgba(75, 85, 99, 1);
    }

    
    body.dark-mode .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
    }

    body.dark-mode .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }

    
    body.dark-mode .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    body.dark-mode .btn-success:hover {
      background: linear-gradient(135deg, #059669, #047857);
    }

    
    body.dark-mode .btn-warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    
    body.dark-mode .modal-content {
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.95), rgba(55, 65, 81, 0.95));
      border: 1px solid rgba(107, 114, 128, 0.5);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .modal-content h3 {
      color: #e5e7eb;
    }

    
    body.dark-mode table {
      background-color: rgba(31, 41, 55, 0.5);
      color: #e5e7eb;
    }

    body.dark-mode table th {
      background-color: rgba(55, 65, 81, 0.8);
      color: #f3f4f6;
      border-bottom: 2px solid rgba(107, 114, 128, 0.5);
    }

    body.dark-mode table td {
      border-bottom: 1px solid rgba(75, 85, 99, 0.3);
    }

    body.dark-mode table tr:hover {
      background-color: rgba(55, 65, 81, 0.6);
    }

    
    body.dark-mode .bg-slate-50 {
      background-color: rgba(55, 65, 81, 0.5) !important;
    }

    body.dark-mode .border-slate-200 {
      border-color: rgba(107, 114, 128, 0.5) !important;
    }

    body.dark-mode .text-slate-700 {
      color: #d1d5db !important;
    }

    body.dark-mode .text-slate-600 {
      color: #e5e7eb !important;
    }

    body.dark-mode .text-slate-400 {
      color: #9ca3af !important;
    }

    
    body.dark-mode a {
      color: #60a5fa;
    }

    body.dark-mode a:hover {
      color: #93c5fd;
    }

    
    body.dark-mode ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    body.dark-mode ::-webkit-scrollbar-track {
      background: rgba(31, 41, 55, 0.5);
    }

    body.dark-mode ::-webkit-scrollbar-thumb {
      background: rgba(107, 114, 128, 0.8);
      border-radius: 5px;
    }

    body.dark-mode ::-webkit-scrollbar-thumb:hover {
      background: rgba(156, 163, 175, 0.9);
    }

    
    body.dark-mode #login-container .bg-gradient-to-br {
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(55, 65, 81, 0.8)) !important;
    }

    
    body.dark-mode .bg-red-50 {
      background-color: rgba(127, 29, 29, 0.3) !important;
    }

    body.dark-mode .bg-green-50 {
      background-color: rgba(6, 78, 59, 0.3) !important;
    }

    body.dark-mode .bg-blue-50 {
      background-color: rgba(30, 58, 138, 0.3) !important;
    }

    body.dark-mode .bg-yellow-50 {
      background-color: rgba(120, 53, 15, 0.3) !important;
    }

    
    body.dark-mode .border-red-200 {
      border-color: rgba(220, 38, 38, 0.5) !important;
    }

    body.dark-mode .border-green-200 {
      border-color: rgba(34, 197, 94, 0.5) !important;
    }

    body.dark-mode .border-blue-200 {
      border-color: rgba(59, 130, 246, 0.5) !important;
    }

    body.dark-mode .border-yellow-200 {
      border-color: rgba(234, 179, 8, 0.5) !important;
    }

    
    body.dark-mode .modal-content.neumorphic,
    body.dark-mode .neumorphic-modal .modal-content {
      background: #2d3748;
      box-shadow:
        12px 12px 24px rgba(0, 0, 0, 0.6),
        -12px -12px 24px rgba(74, 85, 104, 0.4);
    }

    body.dark-mode .modal-content.neumorphic input,
    body.dark-mode .neumorphic-modal .modal-content input,
    body.dark-mode .modal-content.neumorphic select,
    body.dark-mode .neumorphic-modal .modal-content select,
    body.dark-mode .modal-content.neumorphic textarea,
    body.dark-mode .neumorphic-modal .modal-content textarea {
      background: #2d3748;
      color: #e5e7eb;
      box-shadow:
        inset 4px 4px 8px rgba(0, 0, 0, 0.5),
        inset -4px -4px 8px rgba(74, 85, 104, 0.3);
    }

    body.dark-mode .modal-content.neumorphic button,
    body.dark-mode .neumorphic-modal .modal-content button {
      background: #2d3748;
      color: #e5e7eb;
      box-shadow:
        6px 6px 12px rgba(0, 0, 0, 0.6),
        -6px -6px 12px rgba(74, 85, 104, 0.4);
    }

    
    body.dark-mode.theme-anime {
      
      background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https:
    }

    
    body.dark-mode.theme-minimalist {
      background: #1a202c;
    }

    body.dark-mode.theme-minimalist .panel {
      background-color: #2d3748;
      border: 1px solid #4a5568;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    
    #multi-config-user-select {
      white-space: nowrap;
      
      overflow-x: auto;
      max-width: 100%;
      
    }


    select.select-field {
      padding: 0.45rem 0.6rem;
    }

    #multi-config-user-select option {
      text-overflow: ellipsis;
      overflow: hidden;
    }

    
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      
      background-color: rgba(0, 0, 0, 0.4);
      
      
      align-items: center;
      justify-content: center;
    }

    
    
    .modal-content.neumorphic,
    .neumorphic-modal .modal-content {
      
      background: #e8ecf4;
      
      box-shadow:
        12px 12px 24px rgba(163, 177, 198, 0.6),
        
        -12px -12px 24px rgba(255, 255, 255, 0.8);
      
      border: none;
      
      border-radius: 20px;
      
    }

    
    .modal-content.neumorphic input,
    .neumorphic-modal .modal-content input,
    .modal-content.neumorphic select,
    .neumorphic-modal .modal-content select,
    .modal-content.neumorphic textarea,
    .neumorphic-modal .modal-content textarea {
      
      background: #e8ecf4;
      border: none;
      
      box-shadow:
        inset 4px 4px 8px rgba(163, 177, 198, 0.5),
        
        inset -4px -4px 8px rgba(255, 255, 255, 0.7);
      
      border-radius: 10px;
      padding: 10px 14px;
      transition: all 0.3s ease;
    }

    
    .modal-content.neumorphic input:focus,
    .neumorphic-modal .modal-content input:focus,
    .modal-content.neumorphic select:focus,
    .neumorphic-modal .modal-content select:focus,
    .modal-content.neumorphic textarea:focus,
    .neumorphic-modal .modal-content textarea:focus {
      outline: none;
      
      box-shadow:
        inset 6px 6px 12px rgba(163, 177, 198, 0.7),
        inset -6px -6px 12px rgba(255, 255, 255, 0.5);
    }

    
    .modal-content.neumorphic button,
    .neumorphic-modal .modal-content button {
      background: #e8ecf4;
      border: none;
      
      box-shadow:
        6px 6px 12px rgba(163, 177, 198, 0.6),
        -6px -6px 12px rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 10px 20px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    
    .modal-content.neumorphic button:hover,
    .neumorphic-modal .modal-content button:hover {
      transform: translateY(-2px);
      
      box-shadow:
        8px 8px 16px rgba(163, 177, 198, 0.7),
        -8px -8px 16px rgba(255, 255, 255, 0.9);
    }

    
    .modal-content.neumorphic button:active,
    .neumorphic-modal .modal-content button:active {
      transform: translateY(0);
      
      box-shadow:
        inset 4px 4px 8px rgba(163, 177, 198, 0.6),
        inset -4px -4px 8px rgba(255, 255, 255, 0.7);
    }

    
    .modal-content.neumorphic button.btn-primary,
    .neumorphic-modal .modal-content button.btn-primary {
      background: linear-gradient(145deg, #7aa3ff, #6b8ee6);
      color: white;
      font-weight: 600;
    }

    
    .modal-content.neumorphic button.btn-primary:hover,
    .neumorphic-modal .modal-content button.btn-primary:hover {
      background: linear-gradient(145deg, #8ab3ff, #7b9ef6);
    }


    
    .modal-content {
      background: linear-gradient(135deg, #ffffff, #f7f9ff);
      
      padding: 24px 28px;
      border-radius: 16px;
      width: 360px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25),
        0 0 12px rgba(120, 160, 255, 0.4);
      animation: fadeIn 0.35s ease, scaleIn 0.35s ease;
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
      position: relative;
      pointer-events: auto;
      
    }

    
    .modal-content h3 {
      margin-top: 0;
      text-align: center;
      font-size: 20px;
      color: #3a4a7a;
      letter-spacing: 1px;
    }

    
    .close {
      position: absolute;
      right: 14px;
      top: 10px;
      font-size: 22px;
      cursor: pointer;
      color: #888;
      transition: color 0.2s;
    }

    .close:hover {
      color: #ff5c8a;
    }

    
    .form-group {
      margin: 14px 0;
    }

    .form-group label {
      display: inline-block;
      width: 70px;
      font-weight: bold;
      color: #4a4a6a;
    }

    .form-group input {
      width: 230px;
      padding: 8px 10px;
      border: 1px solid #ccd2f0;
      border-radius: 8px;
      outline: none;
      transition: all 0.25s;
      background: #fff;
    }

    .form-group input:focus {
      border-color: #7a9dff;
      box-shadow: 0 0 6px rgba(122, 157, 255, 0.6);
    }

    
    .modal-actions {
      text-align: right;
      margin-top: 18px;
    }

    .modal-actions button {
      margin-left: 10px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s;
    }

    #newUserCancel {
      background: #e0e4f7;
      color: #444;
    }

    #newUserCancel:hover {
      background: #d0d6f0;
    }

    #newUserConfirm {
      background: linear-gradient(135deg, #7a9dff, #5c7cff);
      color: #fff;
      box-shadow: 0 3px 8px rgba(92, 124, 255, 0.4);
    }

    #newUserConfirm:hover {
      background: linear-gradient(135deg, #5c7cff, #4a68e0);
      box-shadow: 0 4px 10px rgba(92, 124, 255, 0.55);
    }

    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.9);
      }

      to {
        transform: scale(1);
      }
    }



    :root {
      --base-color: #7dd3fc;
      --base-color-600: #0891b2;
      --base-color-500: #22d3ee;
      --base-color-300: #a5f3fc;
      --card-bg: rgba(255, 255, 255, 0.85);
      --glass: rgba(255, 255, 255, 0.65);
      --ink: #0f172a;
    }

    html,
    body {
      height: 100%;
    }

    body {
      background: linear-gradient(180deg, rgba(245, 250, 255, 1) 0%, rgba(235, 245, 255, 1) 40%, rgba(250, 240, 255, 1) 100%);
      background-attachment: fixed;
    }

    .bg-anime {
      background-image: url('');
      background-size: cover;
      background-position: center;
    }

    .panel {
      backdrop-filter: blur(16px);
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.45);
      box-shadow: 0 10px 24px rgba(16, 24, 40, 0.12);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      padding: .65rem 1rem;
      border-radius: 999px;
      font-weight: 700;
      transition: all .25s ease;
      box-shadow: 0 6px 16px rgba(2, 132, 199, .15);
    }

    .btn:hover {
      
      
      transform: none;
      box-shadow: 0 12px 28px rgba(2, 132, 199, .22);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      color: #fff;
      background: linear-gradient(135deg, var(--base-color), var(--base-color-600));
    }

    .btn-secondary {
      color: #fff;
      background: linear-gradient(135deg, #a855f7, #7c3aed);
    }

    .btn-danger {
      color: #fff;
      background: linear-gradient(135deg, #ef4444, #b91c1c);
    }

    .btn-warning {
      color: #fff;
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .btn-success {
      color: #fff;
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .btn-ghost {
      color: #334155;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .input-field,
    .select-field {
      width: 100%;
      border-radius: 14px;
      padding: .7rem .9rem;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 8px 14px rgba(16, 24, 40, 0.06);
      color: #0f172a;
      transition: box-shadow .2s ease, border-color .2s ease;
    }

    .input-field:focus,
    .select-field:focus {
      outline: none;
      border-color: var(--base-color-600);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, .25);
    }

    
    .phone-input-wrapper {
      
      display: flex;
      align-items: center;
      
      width: 100%;
      
      border-radius: 14px;
      
      
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
      border: 1px solid rgba(148, 163, 184, 0.35);
      
      
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 8px 14px rgba(16, 24, 40, 0.06);
      transition: box-shadow .2s ease, border-color .2s ease;
      
      overflow: hidden;
      
    }

    
    .phone-input-wrapper:focus-within {
      border-color: var(--base-color-600);
      
      box-shadow: 0 0 0 3px rgba(34, 211, 238, .25);
      
    }

    
    .phone-prefix {
      
      padding: .7rem 0 .7rem .9rem;
      color: #64748b;
      
      font-weight: 500;
      
      user-select: none;
      
      white-space: nowrap;
      
      flex-shrink: 0;
      
    }

    
    .phone-input-wrapper .input-field {
      
      border: none;
      background: transparent;
      box-shadow: none;
      
      padding-left: 0;
      padding-right: .9rem;
      
      flex: 1;
      
      min-width: 0;
      
    }

    
    .phone-input-wrapper .input-field:focus {
      outline: none;
      
      border: none;
      
      box-shadow: none;
      
    }

    
    .phone-input-wrapper.prefix-hidden .input-field {
      padding-left: .9rem;
    }

    .badge {
      display: inline-block;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-weight: 700;
      background: rgba(34, 211, 238, .18);
      color: var(--base-color-600);
    }

    .card-title {
      font-family: 'Zilla Slab', serif;
      letter-spacing: .5px;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(226, 232, 240, 0.6);
    }

    ::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 6px;
      border: 2px solid rgba(226, 232, 240, 0.6);
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: rgba(100, 116, 139, 0.9);
    }

    .tab-button {
      padding: .5rem .75rem;
      font-weight: 700;
      color: #64748b;
      border-bottom: 3px solid transparent;
      transition: all .2s ease;
    }

    .tab-button.active {
      color: var(--base-color-600);
      border-bottom-color: var(--base-color-600);
    }

    #task-list>div.selected {
      background: rgba(34, 211, 238, .14);
      border-left: 4px solid var(--base-color-600);
    }

    #map-container.drawing .amap-marker,
    #map-container.drawing .amap-text,
    #map-container.drawing .amap-overlay-text,
    #map-container.drawing .amap-overlay {
      pointer-events: none !important;
    }

    .pulsing-marker {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.98);
        box-shadow: 0 0 0 0 rgba(2, 132, 199, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 12px rgba(2, 132, 199, 0);
      }

      100% {
        transform: scale(0.98);
        box-shadow: 0 0 0 0 rgba(2, 132, 199, 0);
      }
    }

    .hero-overlay {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.85) 60%);
    }

    .theme-dot {
      width: 20px;
      height: 20px;
      border-radius: 100%;
      border: 2px solid #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .15);
      cursor: pointer;
      transition: transform .2s ease;
    }

    .theme-dot:hover {
      transform: scale(1.05);
    }

    
    #amap-key-modal:not(.hidden)~#map-container .amap-logo,
    #amap-key-modal:not(.hidden)~#map-container .amap-copyright,
    #amap-key-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #amap-key-modal:not(.hidden)~main>#multi-map-container .amap-copyright,

    #user-details-modal:not(.hidden)~#map-container .amap-logo,
    #user-details-modal:not(.hidden)~#map-container .amap-copyright,
    #task-details-modal:not(.hidden)~#map-container .amap-logo,
    #task-details-modal:not(.hidden)~#map-container .amap-copyright,
    #user-details-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #user-details-modal:not(.hidden)~main>#multi-map-container .amap-copyright,
    #task-details-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #task-details-modal:not(.hidden)~main>#multi-map-container .amap-copyright,
    #account-params-modal:not(.hidden)~main>#multi-map-container .amap-logo,
    #account-params-modal:not(.hidden)~main>#multi-map-container .amap-copyright {
      display: none !important;
    }

    
    body.modal-visible .amap-logo,
    body.modal-visible .amap-copyright {
      display: none !important;
    }

    #admin-modal-close-btn:hover {
      transform: translateY(-50%);
      
    }

    
    html.swal2-shown,
    body.swal2-shown:not(.swal2-toast-shown) {
      padding-right: 0;
      
    }

    
    
    
    

    
    @media (max-width: 768px) {

      
      .modal-content,
      .panel.rounded-2xl {
        width: 90% !important;
        
        max-width: 90% !important;
        
        margin: 0 auto;
        
      }

      
      button,
      input[type="submit"],
      input[type="button"],
      .btn {
        min-height: 44px;
        
        padding: 12px 16px;
        
        font-size: 16px;
        
      }

      
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="tel"],
      input[type="number"],
      textarea,
      select {
        min-height: 44px;
        
        font-size: 16px;
        
        padding: 10px 12px;
        
      }

      
      input[type="tel"] {
        font-size: 16px !important;
        
      }

      
      .flex.gap-3,
      .flex.gap-4 {
        flex-direction: column;
        
        gap: 12px;
        
      }

      
      [class*="admin-tab"] {
        padding: 14px 20px;
        
        font-size: 15px;
        
      }

      
      .border.rounded-lg {
        padding: 16px;
        
      }

      
      .overflow-y-auto {
        -webkit-overflow-scrolling: touch;
        
      }

      
      [id^="avatar-"] {
        width: 48px;
        
        height: 48px;
      }

      
      .grid.grid-cols-2,
      .grid.grid-cols-3,
      .grid.grid-cols-4 {
        grid-template-columns: 1fr;
        
      }
    }

    
    @media (max-width: 480px) {

      
      .modal-content,
      .panel.rounded-2xl {
        width: 95% !important;
        max-width: 95% !important;
        padding: 16px;
        
      }

      
      h1,
      .text-xl {
        font-size: 20px;
      }

      h2,
      .text-lg {
        font-size: 18px;
      }

      h3,
      .text-base {
        font-size: 16px;
      }

      
      .flex.gap-1,
      .flex.gap-2 {
        flex-direction: column;
        width: 100%;
      }

      .flex.gap-1>button,
      .flex.gap-2>button {
        width: 100%;
        
      }
    }

    
    
    
    

    
    #mobile-container {
      display: none;
      
      position: fixed;
      
      top: 0;
      
      left: 0;
      
      width: 100%;
      
      height: 100vh;
      
      overflow-y: auto;
      
      overflow-x: hidden;
      
      background: linear-gradient(180deg, rgba(245, 250, 255, 1) 0%, rgba(235, 245, 255, 1) 40%, rgba(250, 240, 255, 1) 100%);
      
      background-attachment: fixed;
      
      padding: 0;
      
      margin: 0;
      
      z-index: 10000;
      
    }

    
    #desktop-container {
      display: block;
      
      width: 100%;
      
      height: 100%;
      
    }

    
    body.mobile-mode {
      font-size: 16px;
      
      -webkit-text-size-adjust: 100%;
      
      -moz-text-size-adjust: 100%;
      
      -ms-text-size-adjust: 100%;
      
      text-size-adjust: 100%;
      
      overflow-x: hidden;
      
      user-select: none;
      
      -webkit-user-select: none;
      
      -webkit-tap-highlight-color: transparent;
      
      touch-action: pan-y;
      
    }



    
    .mobile-mode .phone-input-wrapper {
      display: flex;
      align-items: center;
      width: 100%;
      border-radius: 10px;
      
      border: 2px solid rgba(148, 163, 184, 0.3);
      background-color: rgba(255, 255, 255, 0.9);
      overflow: hidden;
      min-height: 44px;
      transition: all 0.2s ease;
    }

    
    .mobile-mode .phone-input-wrapper:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: scale(1.02);
    }

    
    .mobile-mode .phone-prefix {
      
      padding: 12px 0 12px 16px;
      font-size: 16px;
      color: #64748b;
      font-weight: 500;
      user-select: none;
      white-space: nowrap;
      flex-shrink: 0;
    }

    
    .mobile-mode .phone-input-wrapper .input-field {
      border: none;
      background: transparent;
      box-shadow: none;
      padding-left: 0;
      padding-right: 16px;
      
      font-size: 16px;
      
      flex: 1;
      min-width: 0;
      
      min-height: 44px;
      padding-top: 12px;
      padding-bottom: 12px;
    }

    
    .mobile-mode .phone-input-wrapper .input-field:focus {
      outline: none;
      border: none;
      box-shadow: none;
      transform: none;
      
    }

    
    .mobile-mode .phone-input-wrapper.prefix-hidden .input-field {
      padding-left: 16px;
    }


    
    body.mobile-mode #desktop-container,
    body.mobile-mode #auth-login-container,
    body.mobile-mode #login-container,
    body.mobile-mode #main-app,
    body.mobile-mode #multi-account-app {
      display: none !important;
      visibility: hidden !important;
      pointer-events: none !important;
      z-index: -1 !important;
    }

    
    body.mobile-mode .modal,
    body.mobile-mode #admin-panel-modal,
    body.mobile-mode #session-picker-modal {
      z-index: 9999 !important;
      
    }

    
    .mobile-mode .btn,
    .mobile-mode button {
      min-height: 44px;
      
      min-width: 44px;
      
      font-size: 16px;
      
      padding: 12px 20px;
      
      border-radius: 12px;
      
      font-weight: 600;
      
      letter-spacing: 0.5px;
      
      transition: all 0.2s ease;
      
      touch-action: manipulation;
      
      cursor: pointer;
      
    }

    
    .mobile-mode .btn:active,
    .mobile-mode button:active {
      transform: scale(0.95);
      
      opacity: 0.8;
      
    }

    
    .mobile-mode input,
    .mobile-mode select,
    .mobile-mode textarea {
      min-height: 44px;
      
      font-size: 16px;
      
      padding: 12px 16px;
      
      border-radius: 10px;
      
      border: 2px solid rgba(148, 163, 184, 0.3);
      
      background-color: rgba(255, 255, 255, 0.9);
      
      transition: all 0.2s ease;
      
      touch-action: manipulation;
      
    }

    
    .mobile-mode input:focus,
    .mobile-mode select:focus,
    .mobile-mode textarea:focus {
      border-color: #3b82f6;
      
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      
      outline: none;
      
      transform: scale(1.02);
      
    }

    
    .mobile-mode .mobile-header {
      position: fixed;
      
      top: 0;
      
      left: 0;
      
      right: 0;
      
      z-index: 1000;
      
      height: 56px;
      
      background: rgba(255, 255, 255, 0.95);
      
      backdrop-filter: blur(10px);
      
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      
      display: flex;
      
      align-items: center;
      
      justify-content: space-between;
      
      padding: 0 16px;
      
    }

    
    .mobile-mode .mobile-content {
      padding-top: 56px;
      
      padding-bottom: 80px;
      
      min-height: 100vh;
      
    }

    
    .mobile-mode .mobile-bottom-nav {
      position: fixed;
      
      bottom: 0;
      
      left: 0;
      
      right: 0;
      
      z-index: 1000;
      
      height: 64px;
      
      background: rgba(255, 255, 255, 0.95);
      
      backdrop-filter: blur(10px);
      
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
      
      display: flex;
      
      align-items: center;
      
      justify-content: space-around;
      
      padding: 0 8px;
      
      padding-bottom: env(safe-area-inset-bottom, 0);
      
    }

    
    .mobile-mode .mobile-nav-btn {
      flex: 1;
      
      display: flex;
      
      flex-direction: column;
      
      align-items: center;
      
      justify-content: center;
      
      padding: 8px;
      
      min-height: 44px;
      
      color: #64748b;
      
      text-decoration: none;
      
      font-size: 12px;
      
      font-weight: 500;
      
      transition: all 0.2s ease;
      
      cursor: pointer;
      
      touch-action: manipulation;
      
    }

    
    .mobile-mode .mobile-nav-btn.active {
      color: #3b82f6;
      
      font-weight: 600;
      
    }

    
    .mobile-mode .mobile-nav-btn svg {
      width: 24px;
      
      height: 24px;
      
      margin-bottom: 4px;
      
    }

    
    .mobile-mode .mobile-card {
      background: rgba(255, 255, 255, 0.85);
      
      backdrop-filter: blur(10px);
      
      border-radius: 16px;
      
      padding: 20px;
      
      margin: 16px;
      
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      
      border: 1px solid rgba(255, 255, 255, 0.5);
      
    }

    
    .mobile-mode .mobile-form-group {
      margin-bottom: 20px;
      
    }

    
    .mobile-mode .mobile-form-label {
      display: block;
      
      font-size: 14px;
      
      font-weight: 600;
      
      color: #334155;
      
      margin-bottom: 8px;
      
    }

    
    .mobile-mode .mobile-primary-btn {
      width: 100%;
      
      height: 50px;
      
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      
      color: white;
      
      border: none;
      
      border-radius: 12px;
      
      font-size: 17px;
      
      font-weight: 700;
      
      text-align: center;
      
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      
      transition: all 0.2s ease;
      
      touch-action: manipulation;
      
      cursor: pointer;
      
    }

    
    .mobile-mode .mobile-primary-btn:active {
      transform: scale(0.97);
      
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
      
    }

    
    .mobile-mode .mobile-secondary-btn {
      width: 100%;
      
      height: 50px;
      
      background: white;
      
      color: #3b82f6;
      
      border: 2px solid #3b82f6;
      
      border-radius: 12px;
      
      font-size: 17px;
      
      font-weight: 600;
      
      text-align: center;
      
      transition: all 0.2s ease;
      
      touch-action: manipulation;
      
      cursor: pointer;
      
    }

    
    .mobile-mode .mobile-secondary-btn:active {
      transform: scale(0.97);
      
      background: rgba(59, 130, 246, 0.1);
      
    }

    
    .mobile-mode .mobile-list-item {
      display: flex;
      
      align-items: center;
      
      padding: 16px;
      
      background: white;
      
      border-radius: 12px;
      
      margin-bottom: 12px;
      
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      
      min-height: 60px;
      
      transition: all 0.2s ease;
      
      cursor: pointer;
      
      touch-action: manipulation;
      
    }

    
    .mobile-mode .mobile-list-item:active {
      transform: scale(0.98);
      
      background: rgba(59, 130, 246, 0.05);
      
    }

    
    .mobile-mode .mobile-divider {
      height: 1px;
      
      background: rgba(148, 163, 184, 0.2);
      
      margin: 20px 0;
      
    }

    
    .mobile-mode .mobile-title {
      font-size: 24px;
      
      font-weight: 700;
      
      color: #0f172a;
      
      margin-bottom: 8px;
      
    }

    
    .mobile-mode .mobile-subtitle {
      font-size: 16px;
      
      font-weight: 400;
      
      color: #64748b;
      
      margin-bottom: 24px;
      
    }

    
    .mobile-mode .mobile-empty-state {
      text-align: center;
      
      padding: 40px 20px;
      
      color: #94a3b8;
      
      font-size: 15px;
      
    }

    
    .mobile-mode .mobile-loading {
      display: flex;
      
      flex-direction: column;
      
      align-items: center;
      
      justify-content: center;
      
      padding: 40px;
      
      color: #64748b;
      
    }

    
    .mobile-mode .mobile-switch {
      position: relative;
      
      width: 50px;
      
      height: 28px;
      
      background: #e2e8f0;
      
      border-radius: 14px;
      
      transition: all 0.3s ease;
      
      cursor: pointer;
      
      touch-action: manipulation;
      
    }

    
    .mobile-mode .mobile-switch.active {
      background: #3b82f6;
      
    }

    
    .mobile-mode .mobile-switch::after {
      content: '';
      
      position: absolute;
      
      top: 2px;
      
      left: 2px;
      
      width: 24px;
      
      height: 24px;
      
      background: white;
      
      border-radius: 12px;
      
      transition: all 0.3s ease;
      
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      
    }

    
    .mobile-mode .mobile-switch.active::after {
      left: 24px;
      
    }

    
    .mobile-mode .mobile-modal {
      position: fixed;
      
      top: 0;
      
      left: 0;
      
      right: 0;
      
      bottom: 0;
      
      z-index: 20000;
      
      background: rgba(0, 0, 0, 0.5);
      
      display: flex;
      
      align-items: flex-end;
      
      justify-content: center;
      
      opacity: 0;
      
      visibility: hidden;
      
      transition: all 0.3s ease;
      
    }

    
    .mobile-mode .mobile-modal.show {
      opacity: 1;
      
      visibility: visible;
      
    }

    
    .mobile-mode .mobile-modal-content {
      background: white;
      
      border-radius: 20px 20px 0 0;
      
      width: 100%;
      
      max-height: 85vh;
      
      overflow-y: auto;
      
      padding: 24px;
      
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0));
      
      transform: translateY(100%);
      
      transition: transform 0.3s ease;
      
    }

    
    .mobile-mode .mobile-modal.show .mobile-modal-content {
      transform: translateY(0);
      
    }

    
    
    
    

    
    .mobile-mode #mobile-notification-panel {
      position: relative;
      
    }

    
    .mobile-mode #mobile-all-notifications-list .mobile-list-item,
    .mobile-mode #mobile-attendance-notifications-list .mobile-list-item {
      cursor: pointer;
      
      border-left: 3px solid transparent;
      
      transition: all 0.2s ease;
      
    }

    
    .mobile-mode #mobile-all-notifications-list .mobile-list-item:not(.opacity-60) {
      border-left-color: #3b82f6;
      
      background: rgba(59, 130, 246, 0.05);
      
    }

    
    .mobile-mode #mobile-all-notifications-list .mobile-list-item:active,
    .mobile-mode #mobile-attendance-notifications-list .mobile-list-item:active {
      background: rgba(59, 130, 246, 0.1);
      
      transform: scale(0.98);
      
    }

    
    .mobile-mode #mobile-task-panel .mobile-list-item {
      border-left: 3px solid #10b981;
      
      background: rgba(16, 185, 129, 0.03);
      
    }

    
    .mobile-mode #mobile-map-container {
      touch-action: pan-x pan-y;
      
      -webkit-overflow-scrolling: touch;
      
    }

    
    .mobile-mode #mobile-map-container .text-slate-400 svg {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      
    }

    
    .mobile-mode #mobile-control-panel button:disabled {
      opacity: 0.5;
      
      cursor: not-allowed;
      
      background: #cbd5e1 !important;
      
      color: #64748b !important;
      
    }

    
    .mobile-mode #mobile-status-indicator {
      animation: fadeIn 0.3s ease;
      
    }

    
    .mobile-mode #mobile-status-indicator.status-idle {
      background: #e2e8f0;
      color: #64748b;
    }

    .mobile-mode #mobile-status-indicator.status-running {
      background: #dcfce7;
      color: #16a34a;
      
    }

    .mobile-mode #mobile-status-indicator.status-paused {
      background: #fef3c7;
      color: #d97706;
      
    }

    .mobile-mode #mobile-status-indicator.status-error {
      background: #fee2e2;
      color: #dc2626;
      
    }

    
    .mobile-mode #mobile-progress-bar {
      transition: width 0.5s ease-out;
      
    }

    
    .mobile-mode #mobile-multi-account-list .mobile-list-item {
      position: relative;
      
      padding-left: 48px;
      
    }

    
    .mobile-mode #mobile-multi-account-list input[type="checkbox"] {
      position: absolute;
      
      left: 16px;
      
      top: 50%;
      
      transform: translateY(-50%);
      
    }

    
    .mobile-mode .account-status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      
      letter-spacing: 0.5px;
    }

    .mobile-mode .account-status-running {
      background: #dcfce7;
      color: #16a34a;
    }

    .mobile-mode .account-status-stopped {
      background: #f1f5f9;
      color: #64748b;
    }

    .mobile-mode .account-status-error {
      background: #fee2e2;
      color: #dc2626;
    }

    
    @media (orientation: landscape) and (max-height: 500px) {

      
      .mobile-mode .mobile-header {
        height: 48px;
        
      }

      .mobile-mode .mobile-content {
        padding-top: 48px;
        
        padding-bottom: 60px;
        
      }

      .mobile-mode .mobile-bottom-nav {
        height: 56px;
        
      }

      .mobile-mode .mobile-card {
        padding: 16px;
        
        margin: 12px;
        
      }

      
      .mobile-mode #mobile-map-container {
        height: 200px !important;
        
      }

      
      .mobile-mode #mobile-all-notifications-list,
      .mobile-mode #mobile-attendance-notifications-list,
      .mobile-mode #mobile-task-list,
      .mobile-mode #mobile-multi-account-list {
        max-height: 30vh !important;
        
      }
    }

    
    @media (prefers-color-scheme: dark) {
      .mobile-mode #mobile-container {
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        
      }


      
      .mobile-mode-auth #mobile-container .mobile-header,
      .mobile-mode-auth #mobile-container .mobile-bottom-nav {
        display: none !important;
      }

      
      .mobile-mode-auth #mobile-container .mobile-content {
        padding-top: 0;
        
        padding-bottom: 0;
        
      }

      .mobile-mode .mobile-card {
        background: rgba(30, 41, 59, 0.85);
        
        border: 1px solid rgba(255, 255, 255, 0.1);
        
        color: #e2e8f0;
        
      }

      .mobile-mode .mobile-header,
      .mobile-mode .mobile-bottom-nav {
        background: rgba(15, 23, 42, 0.95);
        
        border-color: rgba(255, 255, 255, 0.1);
        
      }

      .mobile-mode .mobile-title {
        color: #f1f5f9;
        
      }

      .mobile-mode .mobile-subtitle {
        color: #94a3b8;
        
      }

      .mobile-mode input,
      .mobile-mode select,
      .mobile-mode textarea {
        background: rgba(30, 41, 59, 0.8);
        
        color: #e2e8f0;
        
        border-color: rgba(148, 163, 184, 0.3);
        
      }
    }

    
    
    
    

    
    .mobile-sidebar-backdrop {
      position: fixed;
      
      top: 0;
      
      left: 0;
      
      right: 0;
      
      bottom: 0;
      
      background: rgba(0, 0, 0, 0.5);
      
      z-index: 9998;
      
      opacity: 0;
      
      visibility: hidden;
      
      transition: opacity 0.3s ease, visibility 0.3s ease;
      
    }

    
    .mobile-sidebar-backdrop.show {
      opacity: 1;
      
      visibility: visible;
      
    }

    
    .mobile-sidebar {
      position: fixed;
      
      top: 0;
      
      left: 0;
      
      bottom: 0;
      
      width: 280px;
      
      background: rgba(255, 255, 255, 0.98);
      
      backdrop-filter: blur(10px);
      
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
      
      z-index: 9999;
      
      transform: translateX(-100%);
      
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      
      overflow-y: auto;
      
      overflow-x: hidden;
      
      display: flex;
      
      flex-direction: column;
      
      padding-bottom: env(safe-area-inset-bottom, 0);
      
    }

    
    .mobile-sidebar.show {
      transform: translateX(0);
      
    }

    
    .mobile-sidebar-header {
      padding: 24px 20px;
      
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      
      color: white;
      
      display: flex;
      
      align-items: center;
      
      gap: 12px;
      
    }

    
    .mobile-sidebar-header svg {
      width: 32px;
      
      height: 32px;
      
      flex-shrink: 0;
      
    }

    
    .mobile-sidebar-header .sidebar-title {
      font-size: 20px;
      
      font-weight: 700;
      
      letter-spacing: 0.5px;
      
    }

    
    .mobile-sidebar-menu {
      flex: 1;
      
      padding: 8px 0;
      
      overflow-y: auto;
      
    }

    
    .mobile-sidebar-item {
      display: flex;
      
      align-items: center;
      
      padding: 16px 20px;
      
      color: #334155;
      
      text-decoration: none;
      
      font-size: 16px;
      
      font-weight: 500;
      
      transition: all 0.2s ease;
      
      cursor: pointer;
      
      touch-action: manipulation;
      
      border-left: 3px solid transparent;
      
      gap: 12px;
      
    }

    
    .mobile-sidebar-item:hover {
      background: rgba(59, 130, 246, 0.08);
      
      border-left-color: #3b82f6;
      
    }

    
    .mobile-sidebar-item:active {
      background: rgba(59, 130, 246, 0.15);
      
      transform: scale(0.98);
      
    }

    
    .mobile-sidebar-item svg {
      width: 24px;
      
      height: 24px;
      
      flex-shrink: 0;
      
      stroke-width: 2;
      
    }

    
    .mobile-sidebar-item span {
      flex: 1;
      
    }

    
    .mobile-sidebar-item.danger {
      color: #dc2626;
      
    }

    
    .mobile-sidebar-item.danger:hover {
      background: rgba(220, 38, 38, 0.08);
      
      border-left-color: #dc2626;
      
    }

    
    .mobile-sidebar-item.danger:active {
      background: rgba(220, 38, 38, 0.15);
      
    }

    
    .mobile-bottom-nav {
      display: none !important;
      
    }

    
    .mobile-mode .mobile-content {
      padding-bottom: 80px !important;
      
    }

    
    @media (prefers-color-scheme: dark) {

      
      .mobile-sidebar {
        background: rgba(15, 23, 42, 0.98);
        
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5);
        
      }

      
      .mobile-sidebar-item {
        color: #e2e8f0;
        
      }

      
      .mobile-sidebar-item:hover {
        background: rgba(59, 130, 246, 0.15);
        
      }

      
      .mobile-sidebar-item:active {
        background: rgba(59, 130, 246, 0.25);
        
      }

      
      .mobile-sidebar-backdrop.show {
        background: rgba(0, 0, 0, 0.7);
        
      }
    }

    
    @media (orientation: landscape) and (max-height: 500px) {

      
      .mobile-sidebar-header {
        padding: 16px 20px;
        
      }

      
      .mobile-sidebar-item {
        padding: 12px 20px;
        
      }
    }

    
    
    .mobile-mode .mobile-card-fullscreen {
      
      height: calc(100vh - 60px);
      
      margin: 0;
      
      border-radius: 0;
      
      border: none;
      
      box-shadow: none;
      
      padding: 16px;
      
      display: flex;
      
      flex-direction: column;
      
      overflow-y: auto;
    }
  </style>

</head>

<body class="text-slate-800 font-sans h-screen overflow-hidden antialiased">

  <div id="cdn-error-overlay"
    class="fixed inset-0 z-9999 hidden flex-col items-center justify-center bg-[#f8fafc] p-8 text-center text-[#475569]"
    style="font-family: sans-serif;">
    <div style="max-width: 500px;">
      <h1 style="font-size: 1.875rem; font-weight: bold; color: #be123c; margin-bottom: 1rem;">ç•Œé¢èµ„æºåŠ è½½å¤±è´¥</h1>
      <p style="font-size: 1.125rem; margin-bottom: 1.5rem;">åº”ç”¨ç¨‹åºæ— æ³•è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œæœåŠ¡å™¨ï¼ˆCDNï¼‰æ¥ä¸‹è½½å¿…è¦çš„ç•Œé¢æ–‡ä»¶ï¼ˆå¦‚æ ·å¼å’Œåœ°å›¾åº“ï¼‰ã€‚</p>
      <div
        style="background-color: #f1f5f9; border-radius: 0.5rem; padding: 1rem; text-align: left; font-size: 0.875rem; line-height: 1.5;">
        <h2 style="font-weight: 600; color: #1e293b; margin-top: 0; margin-bottom: 0.75rem;">å¯èƒ½çš„åŸå› åŠè§£å†³æ–¹æ³•ï¼š</h2>
        <ul style="list-style-type: disc; padding-left: 1.25rem; margin: 0;">
          <li style="margin-bottom: 0.5rem;"><strong>æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥</strong>ï¼šè¯·ç¡®ä¿æ‚¨çš„è®¾å¤‡å·²è¿æ¥åˆ°äº’è”ç½‘ã€‚</li>
          <li style="margin-bottom: 0.5rem;"><strong>æ£€æŸ¥é˜²ç«å¢™æˆ–ä»£ç†</strong>ï¼šç³»ç»Ÿé˜²ç«å¢™ã€æ€æ¯’è½¯ä»¶æˆ–ç½‘ç»œä»£ç†å¯èƒ½é˜»æ­¢äº†ç¨‹åºè®¿é—®ç½‘ç»œã€‚</li>
          <li><strong>ç½‘ç»œç¯å¢ƒé—®é¢˜</strong>ï¼šæ‚¨å½“å‰çš„ç½‘ç»œç¯å¢ƒå¯èƒ½æ— æ³•ç¨³å®šè®¿é—®æ‰€éœ€çš„å¤–éƒ¨èµ„æºã€‚</li>
        </ul>
      </div>
      <p style="margin-top: 1.5rem; font-size: 0.875rem; color: #64748b;">è¯·æ£€æŸ¥ç½‘ç»œåï¼Œå®Œå…¨å…³é—­å¹¶é‡å¯æœ¬ç¨‹åºã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œæ‚¨å¯èƒ½éœ€è¦æ›´æ¢ç½‘ç»œç¯å¢ƒã€‚</p>
    </div>
  </div>

  
  <div id="guest_warning_overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden"></div>

  
  <div id="guest-warning-toast"
    class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl p-5 z-[1001] rounded-2xl hidden shadow-2xl transition-all duration-300 ease-out border-4 border-red-500"
    style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
    <div class="flex items-start gap-4" id="guest_warning">
      <div class="flex-shrink-0 w-10 h-10 text-red-600 mt-1 animate-pulse">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http:
          <path fill-rule="evenodd"
            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="flex-1">
        <h3 class="text-xl font-bold text-red-700 mb-2">âš ï¸ æ¸¸å®¢æ¨¡å¼é‡è¦æç¤º</h3>
        <div class="text-base text-slate-800 space-y-2 font-medium">
          <p class="bg-white/60 px-3 py-2 rounded-lg">
            <strong class="text-red-600">âš ï¸ è¯·ç«‹å³ä¿å­˜å½“å‰ç½‘å€ï¼</strong> ä¸¢å¤±URLå°†æ— æ³•æ¢å¤æ‚¨çš„æ•°æ®ï¼
          </p>
          <p class="bg-white/60 px-3 py-2 rounded-lg">
            <strong>åŠŸèƒ½é™åˆ¶ï¼š</strong>æ— æ³•æ ‡è®°é€šçŸ¥å·²è¯»ã€æ— æ³•ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½ã€æ— æ³•æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡
          </p>
          <p class="bg-white/60 px-3 py-2 rounded-lg">
            <strong class="text-amber-700">â° è‡ªåŠ¨æ¸…ç†ï¼š</strong>5åˆ†é’Ÿä¸æ´»è·ƒä¼šè¯å°†è¢«è‡ªåŠ¨æ¸…ç†
          </p>
          <p class="mt-3 text-sm text-slate-600">
            ğŸ’¡ å»ºè®®ï¼š<span class="text-blue-600 font-semibold">è¯·æ³¨å†Œè´¦å·ä»¥è·å¾—å®Œæ•´åŠŸèƒ½å’Œæ°¸ä¹…æ•°æ®ä¿å­˜</span>
          </p>
        </div>
      </div>
      <button id="guest-warning-close-btn"
        class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-slate-600 hover:text-red-600 hover:bg-white/80 rounded-full transition-colors duration-200 -mt-2 -mr-2 font-bold text-xl">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http:
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
  
  
  <div id="newUserModal" class="modal">
    <div class="panel rounded-2xl w-full max-w-md p-6 space-y-4 relative bg-white/95 shadow-xl">

      <button id="newUserClose"
        class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http:
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>

      <h3 class="text-xl font-bold text-sky-700 text-center card-title">æ·»åŠ æ–°ç”¨æˆ·</h3>

      <div>
        <label for="newUsername" class="block text-sm font-semibold leading-6 text-slate-700">è´¦å·</label>
        <input type="text" id="newUsername" placeholder="è¯·è¾“å…¥è´¦å·ï¼ˆ3-20å­—ç¬¦ï¼Œä¸å«ä¸­æ–‡ï¼‰" class="input-field mt-1">
      </div>

      <div>
        <label for="newUserPhone" class="block text-sm font-semibold leading-6 text-slate-700">æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰</label>
        <input type="tel" id="newUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" inputmode="numeric" pattern="[0-9]*"
          class="input-field mt-1">
      </div>

      <div id="newUserSmsGroup" style="display:none;">
        <label for="newUserSmsCode" class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç ï¼ˆå¯é€‰ï¼‰</label>
        <div class="flex gap-2 mt-1">
          <input type="text" id="newUserSmsCode" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6" inputmode="numeric"
            pattern="[0-9]{6}" class="input-field flex-1">
          <button type="button" id="newUserSendCode" class="btn btn-primary whitespace-nowrap"
            style="min-height: 44px;">å‘é€éªŒè¯ç </button>
        </div>
      </div>

      <div>
        <label for="newUserNickname" class="block text-sm font-semibold leading-6 text-slate-700">æ˜µç§°</label>
        <input type="text" id="newUserNickname" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆå¯å«ä¸­æ–‡ï¼‰" class="input-field mt-1">
      </div>

      <div>
        <label for="newPassword" class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6å­—ç¬¦ï¼‰" class="input-field mt-1">
      </div>

      <div>
        <label for="newPasswordConfirm" class="block text-sm font-semibold leading-6 text-slate-700">ç¡®è®¤å¯†ç </label>
        <input type="password" id="newPasswordConfirm" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " class="input-field mt-1">
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
        <button id="newUserCancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button id="newUserConfirm" class="btn btn-primary">ç¡®è®¤</button>
      </div>
    </div>
  </div>


  <div id="multi-add-user-modal" class="modal">
    <div class="panel rounded-2xl w-full max-w-md p-6 space-y-4 relative bg-white/95 shadow-xl">
      <button id="multi-add-user-close"
        class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http:
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
      <h3 class="text-xl font-bold text-sky-700 text-center card-title">æ·»åŠ æ–°è´¦å·</h3>
      

      <div>
        <label for="multi-add-username" class="block text-sm font-semibold leading-6 text-slate-700">è´¦å· (å¿…å¡«)</label>
        <input type="text" id="multi-add-username" placeholder="è¯·è¾“å…¥è´¦å·ï¼ˆä¾‹å¦‚å­¦å·ï¼‰" class="input-field mt-1">
      </div>
      <div>
        <label for="multi-add-password" class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç  (å¿…å¡«)</label>
        <input type="password" id="multi-add-password" placeholder="è¯·è¾“å…¥å¯†ç  (è‡³å°‘6å­—ç¬¦)" class="input-field mt-1">
      </div>
      <div>
        <label for="multi-add-tag" class="block text-sm font-semibold leading-6 text-slate-700">æ ‡è®° (å¯é€‰)</label>
        <input type="text" id="multi-add-tag" placeholder="å¯é€‰ï¼Œç”¨äºåˆ†ç»„ (ä¾‹å¦‚: 'Aç»„')" class="input-field mt-1">
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
        <button id="multi-add-user-cancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button id="multi-add-user-confirm" class="btn btn-primary">ç¡®è®¤æ·»åŠ </button>
      </div>
    </div>
  </div>

  
  <div id="school-accounts-modal" class="modal">
    <div class="panel rounded-2xl w-full max-w-4xl p-6 space-y-4 relative bg-white/95 shadow-xl">
      <button id="school-accounts-close"
        class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-slate-100 rounded-full transition-all">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http:
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
      <h3 class="text-xl font-bold text-sky-700 text-center card-title">School Accounts ç®¡ç†</h3>
      <p class="text-sm text-slate-500 text-center -mt-2">æŸ¥çœ‹æ‰€æœ‰è®¤è¯ç”¨æˆ·çš„å­¦æ ¡è´¦æˆ·å¯†ç </p>

      <div id="school-accounts-content" class="space-y-4 max-h-[60vh] overflow-y-auto">
        <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
        <button id="school-accounts-refresh" class="btn btn-ghost">åˆ·æ–°</button>
        <button id="school-accounts-ok" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </div>
  </div>

  
  
  <div id="edit-school-account-modal" class="fixed inset-0 hidden z-[1055] flex items-center justify-center p-4"
    style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
    
    <div
      class="bg-gradient-to-br from-slate-50 to-white rounded-3xl shadow-2xl max-w-[560px] w-full transform transition-all"
      style="box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.1), -12px -12px 24px rgba(255, 255, 255, 0.9);"
      onclick="event.stopPropagation()">

      
      <div class="p-6 pb-4 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            
            <div
              class="w-12 h-12 rounded-full bg-gradient-to-br from-sky-400 to-blue-500 flex items-center justify-center flex-shrink-0"
              style="box-shadow: 4px 4px 8px rgba(56, 189, 248, 0.3), -2px -2px 8px rgba(255, 255, 255, 0.8);">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800" id="edit-school-account-modal-title">ç¼–è¾‘ School Account</h3>
          </div>
          
          <button onclick="closeEditSchoolAccountModal()" class="text-slate-400 hover:text-slate-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      
      <div class="p-6 space-y-4">
        
        <form id="edit-school-account-form" class="space-y-4">

          
          <div class="space-y-2">
            <label for="edit-school-account-auth-username" class="block text-sm font-medium text-slate-700">
              è®¤è¯ç”¨æˆ· (Auth Username)
            </label>
            <input type="text" id="edit-school-account-auth-username" name="auth_username"
              class="w-full px-4 py-2.5 text-slate-700 bg-slate-100 border border-slate-300 rounded-lg cursor-not-allowed"
              readonly placeholder="è®¤è¯ç”¨æˆ·å" style="box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.1);">
          </div>

          
          <div class="space-y-2">
            <label for="edit-school-account-school-username" class="block text-sm font-medium text-slate-700">
              å­¦æ ¡è´¦å·ç”¨æˆ·å (School Username) <span class="text-red-500">*</span>
            </label>
            <input type="text" id="edit-school-account-school-username" name="school_username"
              class="w-full px-4 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition"
              placeholder="è¯·è¾“å…¥å­¦æ ¡è´¦å·ç”¨æˆ·å" required style="box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05);">
          </div>

          
          <div class="space-y-2">
            <label for="edit-school-account-password" class="block text-sm font-medium text-slate-700">
              å¯†ç  (Password) <span class="text-red-500">*</span>
            </label>
            <input type="text" id="edit-school-account-password" name="password"
              class="w-full px-4 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition font-mono"
              placeholder="è¯·è¾“å…¥å¯†ç " required style="box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05);">
          </div>

          
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <label for="edit-school-account-ua" class="block text-sm font-medium text-slate-700">
                User Agent (UA)
              </label>
              
              <button type="button" onclick="generateRandomUAForSchoolAccount()"
                class="px-3 py-1 text-xs font-medium text-sky-600 bg-sky-50 border border-sky-200 rounded-lg hover:bg-sky-100 transition-all flex items-center gap-1"
                title="ç‚¹å‡»ç”ŸæˆéšæœºUser-Agent">
                <svg xmlns="http:
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                éšæœºUA
              </button>
            </div>
            <textarea id="edit-school-account-ua" name="ua" rows="3"
              class="w-full px-4 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition font-mono text-sm resize-none"
              placeholder="ï¼ˆå¯é€‰ï¼‰è¯·è¾“å…¥ User Agent" style="box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05);"></textarea>
            <p class="text-xs text-slate-500">å¦‚æœä¸å¡«å†™ï¼Œå°†ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ User Agentã€‚ç‚¹å‡»"éšæœºUA"æŒ‰é’®å¯è‡ªåŠ¨ç”Ÿæˆã€‚</p>
          </div>

          
          <input type="hidden" id="edit-school-account-original-username" name="original_username">

        </form>
      </div>

      
      <div class="px-6 pb-6 flex gap-3 justify-end">
        
        <button type="button" onclick="closeEditSchoolAccountModal()"
          class="px-6 py-2.5 rounded-lg font-medium text-slate-600 bg-white border border-slate-300 hover:bg-slate-50 transition-all"
          style="box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1), -1px -1px 2px rgba(255, 255, 255, 0.8);">
          å–æ¶ˆ
        </button>
        
        <button type="button" onclick="submitSchoolAccount()"
          class="px-6 py-2.5 rounded-lg font-medium text-white bg-gradient-to-br from-sky-400 to-blue-500 hover:from-sky-500 hover:to-blue-600 transition-all"
          style="box-shadow: 2px 2px 4px rgba(56, 189, 248, 0.4), -1px -1px 2px rgba(255, 255, 255, 0.6);">
          ä¿å­˜
        </button>
      </div>

    </div>
  </div>

  
  <div id="loading-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center gap-6 bg-white/80">
    <div class="loader"></div>
    <p class="text-base font-bold text-sky-600">æ­£åœ¨åŠ è½½èµ„æºä¸­...</p>
  </div>

  
  <div id="captcha-verification-modal" class="fixed inset-0 hidden z-[10001] flex items-center justify-center p-4"
    style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
    
    <div
      class="bg-gradient-to-br from-slate-50 to-white rounded-3xl shadow-2xl max-w-[560px] w-full transform transition-all"
      style="box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.1), -12px -12px 24px rgba(255, 255, 255, 0.9);"
      onclick="event.stopPropagation()">

      
      <div class="p-6 pb-4 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            
            <div
              class="w-12 h-12 rounded-full bg-gradient-to-br from-sky-400 to-blue-500 flex items-center justify-center flex-shrink-0"
              style="box-shadow: 4px 4px 8px rgba(56, 189, 248, 0.3), -2px -2px 8px rgba(255, 255, 255, 0.8);">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800">å®‰å…¨éªŒè¯</h3>
          </div>
          
          <button onclick="closeCaptchaModal()" class="text-slate-400 hover:text-slate-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      
      <div class="p-6 space-y-4">
        <p class="text-slate-600 text-sm">
          ä¸ºä¿æŠ¤æ‚¨çš„è´¦å·å®‰å…¨ï¼Œè¯·å®Œæˆä»¥ä¸‹éªŒè¯
        </p>

        
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-slate-700">å›¾å½¢éªŒè¯ç </label>
          <div class="relative w-full">
            <div id="captcha-modal-display"
              class="w-auto h-auto flex items-center justify-center border-2 border-slate-300 rounded-lg bg-white cursor-pointer hover:border-sky-400 transition-colors"
              onclick="refreshCaptchaModal()" title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç " style="min-height: 64px;">
              <span class="text-slate-400 text-xs">åŠ è½½ä¸­...</span>
            </div>
            <button onclick="refreshCaptchaModal()"
              class="absolute top-2 right-2 btn btn-ghost !p-2 text-slate-500 hover:text-sky-600 transition-colors"
              title="åˆ·æ–°éªŒè¯ç ">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>
        </div>

        
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-slate-700">è¯·è¾“å…¥éªŒè¯ç </label>
          <input type="text" id="captcha-modal-input"
            class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-sky-400 focus:outline-none transition-colors"
            placeholder="è¯·è¾“å…¥å›¾å½¢éªŒè¯ç " maxlength="6" autocomplete="off">
        </div>
      </div>

      
      <div class="p-6 pt-0 flex gap-3">
        <button onclick="closeCaptchaModal()"
          class="flex-1 py-3 px-4 rounded-xl font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all"
          style="box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.08), -2px -2px 8px rgba(255, 255, 255, 0.9);">
          å–æ¶ˆ
        </button>
        <button id="captcha-modal-confirm-btn" onclick="confirmCaptchaAndSendSMS()"
          class="flex-1 py-3 px-4 rounded-xl font-semibold text-white bg-gradient-to-br from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 transition-all"
          style="box-shadow: 4px 4px 12px rgba(56, 189, 248, 0.3), -2px -2px 8px rgba(255, 255, 255, 0.1);">
          ç¡®è®¤å‘é€
        </button>
      </div>
    </div>
  </div>


  
  <div id="auth-login-container" class="hidden w-full h-full flex items-center justify-center">
    <div class="panel rounded-2xl w-full max-w-[600px] p-6 space-y-6">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-sky-700 card-title mb-2">è·‘æ­¥åŠ©æ‰‹</h2>
        <p class="text-sm text-slate-500">è¯·ç™»å½•æˆ–æ³¨å†Œä»¥ç»§ç»­ä½¿ç”¨</p>
      </div>

      
      <div class="flex border-b border-slate-200">
        <button id="auth-tab-login"
          class="flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition">ç™»å½•</button>
        <button id="auth-tab-register"
          class="flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition hover:text-slate-600">æ³¨å†Œ</button>
      </div>

      
      <div id="auth-login-form" class="space-y-4 overflow-y-auto max-h-[60vh] p-1">
        
        <div id="auth-login-type-toggle" class="flex justify-center gap-2 pb-2">
          <button id="auth-login-username-btn"
            class="px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm">
            ç”¨æˆ·åç™»å½•
          </button>
          <button id="auth-login-phone-btn" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm">
            æ‰‹æœºå·ç™»å½•
          </button>
        </div>

        
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700" id="auth-login-label">ç”¨æˆ·å</label>
          
          <div id="auth-username-container">
            
            <input type="text" id="auth-username" class="input-field mt-1" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
          </div>
        </div>

        
        <div id="auth-password-section">
          <div class="flex justify-between items-center">
            <label class="block text-sm font-semibold leading-6 text-slate-700">å¯†ç </label>
            <button type="button" id="auth-switch-to-sms" class="text-xs text-sky-600 hover:text-sky-700 hidden">
              ä½¿ç”¨éªŒè¯ç ç™»å½•
            </button>
          </div>
          <input type="password" id="auth-password" class="input-field mt-1" placeholder="è¯·è¾“å…¥å¯†ç "
            autocomplete="current-password">
        </div>

        
        <div id="auth-sms-section" class="hidden">
          <div class="flex justify-between items-center">
            <label class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç </label>
            <button type="button" id="auth-switch-to-password" class="text-xs text-sky-600 hover:text-sky-700">
              ä½¿ç”¨å¯†ç ç™»å½•
            </button>
          </div>
          <div class="flex gap-2 mt-1">
            <input type="text" id="auth-sms-code" class="input-field flex-1" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}">
            <button type="button" id="auth-send-login-code" class="btn btn-primary whitespace-nowrap"
              style="min-height: 44px;">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>

        
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç </label>
          
          <div class="flex gap-2 mt-1 items-center">
            <div id="auth-login-captcha-display"
              class="flex-shrink-0 w-auto h-auto flex items-center justify-center border border-slate-300 rounded bg-white cursor-pointer hover:border-sky-400 transition-colors"
              title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç " style="min-height: 64px;">
              <span class="text-slate-400 text-xs">åŠ è½½ä¸­...</span>
            </div>
            
            <button type="button" id="auth-login-captcha-refresh" class="btn btn-ghost !p-2" title="åˆ·æ–°éªŒè¯ç ">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>
          
          <div class="mt-2">
            <input type="text" id="auth-login-captcha" class="input-field w-full" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              autocomplete="off">
          </div>
        </div>

        <button id="auth-login-btn" class="btn btn-primary w-full py-3" style="min-height: 44px;">ç™»å½•</button>
        <div id="guest-login-section" class="text-center hidden">
          <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-slate-200"></div>
            <span class="flex-shrink mx-4 text-slate-400 text-xs">æˆ–</span>
            <div class="flex-grow border-t border-slate-200"></div>
          </div>
          <button id="auth-guest-btn" class="btn btn-ghost w-full">ä»¥æ¸¸å®¢èº«ä»½ç»§ç»­</button>
          
          <div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-left">
            <div class="flex items-start gap-2">
              <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" />
              </svg>
              <div class="text-xs text-amber-800">
                <p class="font-semibold mb-1">âš ï¸ æ¸¸å®¢æ¨¡å¼æç¤º</p>
                <ul class="space-y-1">
                  <li>â€¢ æ¸¸å®¢ä½¿ç”¨UUIDæ¢å¤çŠ¶æ€ï¼Œè¯·åŠ¡å¿…ä¿å­˜åœ°å€</li>
                  <li>â€¢ ä¸¢å¤±URLå°†æ— æ³•æ¢å¤æ‚¨çš„æ•°æ®å’Œè¿›åº¦</li>
                  <li>â€¢ 5åˆ†é’Ÿä¸æ´»è·ƒä¼šè¯å°†è¢«è‡ªåŠ¨æ¸…ç†</li>
                  <li>â€¢ å»ºè®®æ³¨å†Œè´¦å·ä»¥è·å¾—æ›´å¥½çš„ä½“éªŒ</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      
      <div id="auth-register-form" class="hidden space-y-4 overflow-y-auto max-h-[60vh] p-1">
        
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">ç”¨æˆ·å</label>
          <input type="text" id="auth-reg-username" class="input-field mt-1" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20å­—ç¬¦ï¼Œä¸å«ä¸­æ–‡ï¼‰"
            autocomplete="username">
        </div>

        
        
        <div id="auth-reg-phone-wrapper">
          <label class="block text-sm font-semibold leading-6 text-slate-700">æ‰‹æœºå·</label>
          
          <div class="phone-input-wrapper mt-1">
            
            <span class="phone-prefix">+86 </span>
            
            <input type="tel" id="auth-reg-phone" class="input-field" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel"
              inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

        
        <div id="auth-reg-sms-wrapper">
          <label class="block text-sm font-semibold leading-6 text-slate-700">éªŒè¯ç </label>
          <div class="flex gap-2">
            <input type="text" id="auth-reg-sms-code" class="input-field mt-1 flex-1" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}">
            <button id="auth-reg-send-code-btn" class="btn btn-primary mt-1 whitespace-nowrap"
              style="min-height: 44px;">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>

        
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">æ˜µç§°</label>
          <input type="text" id="auth-reg-nickname" class="input-field mt-1" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆå¯å«ä¸­æ–‡ï¼‰">
        </div>

        
        <div>
          <label class="block text-sm font-semibold leading-6 text-slate-700">å¤´åƒ</label>
          <div class="flex items-center gap-3 mt-1">
            <img id="auth-reg-avatar-preview" src="/static/default_avatar.png"
              class="w-16 h-16 rounded-full object-cover border-2 border-slate-200">
            <input type="file" id="auth-reg-avatar" accept="image
    async function loadMobileSessionPickerList() {
      const listEl = $('mobile-session-picker-list'); 
      if (!listEl) {
        logMessage_Error("loadMobileSessionPickerList: æ— æ³•æ‰¾åˆ° 'mobile-session-picker-list' å®¹å™¨ã€‚");
        return;
      }

      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        const headers = { 'X-Session-ID': sessionUUID || null };
        const response = await fetch('/auth/user/sessions', { headers: headers });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          
          return;
        }

        const sessions = result.sessions || [];

        
        currentSessionInfo.maxSessions = result.max_sessions || 1;
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');
        currentSessionInfo.currentCount = validSessions.length;

        
        const countEl = $('mobile-session-picker-count-display'); 
        if (countEl) {
          const { currentCount, maxSessions } = currentSessionInfo;
          if (maxSessions === -1) {
            countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
          } else {
            const colorClass = currentCount >= maxSessions ? 'text-red-600' : 'text-slate-600';
            countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
          }
        }

        if (validSessions.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯ï¼Œè¯·åˆ›å»ºæ–°ä¼šè¯</p>';
          return;
        }

        
        listEl.innerHTML = validSessions.map(session => {
          const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
          const isCurrent = session.is_current || session.session_id === sessionUUID;
          const sessionHash = session.session_hash || session.session_id.substring(0, 16);

          
          const is_multi_mode = session.is_multi_account_mode;
          const session_login_success = session.login_success;

          let statusStyles = '';
          let statusText = '';

          if (is_multi_mode) {
            statusStyles = session_login_success ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700';
            statusText = session_login_success ? 'âœ“ å·²ç™»å½•' : 'â—‹ æœªç™»å½•';
          } else {
            statusStyles = session_login_success ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700';
            statusText = session_login_success ? 'âœ“ å·²ç™»å½•' : 'â—‹ æœªç™»å½•';
          }

          
          return `
            <div class="mobile-list-item justify-between ${isCurrent ? 'border-2 border-sky-500 bg-sky-50' : 'bg-white'}" 
                 ${!isCurrent ? `onclick="selectSessionFromPicker('${session.session_id}')" style="cursor: pointer;"` : 'style="cursor: default;"'}
                 title="${!isCurrent ? 'ç‚¹å‡»è¿›å…¥æ­¤ä¼šè¯' : 'è¿™æ˜¯å½“å‰ä¼šè¯'}">
              
              <div class="flex-1 min-w-0 pr-3">
                <div class="flex items-center">
                  <p class="font-semibold text-slate-800 truncate" title="${session.session_id}">ä¼šè¯ ${sessionHash}...</p>
                  ${isCurrent ? '<span class="text-xs text-sky-600 ml-2 px-2 py-0.5 bg-sky-100 rounded-full flex-shrink-0">(å½“å‰)</span>' : ''}
                </div>
                <p class="text-xs text-slate-500 mt-1">${createdDate}</p>
                <p class="text-xs mt-2">
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${statusStyles}">
                    ${statusText}
                  </span>
                </p>
              </div>
              
              <div class="flex-shrink-0 flex items-center justify-center pl-2">
                ${!isCurrent ? `
                  <button class="btn btn-ghost !text-red-500 !py-3 !px-4 !rounded-lg" 
                          onclick="event.stopPropagation(); deleteSessionFromPicker('${session.session_id}');"
                          title="åˆ é™¤æ­¤ä¼šè¯">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http:
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                ` : `
                  <div class="px-4" title="è¿™æ˜¯å½“å‰ä¼šè¯">
                    <svg class="w-6 h-6 text-sky-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http:
                  </div>
                `}
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        logMessage_Error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:", e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    
    function showMobileSessionPicker() {
      const modal = $('mobile-session-picker-modal');
      if (!modal) {
        console.error("Mobile session picker modal DOM not found!");
        return;
      }

      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      
      modal.classList.add('show');
      document.body.classList.add('modal-visible');

      
      loadMobileSessionPickerList();
    }

    
    function closeMobileSessionPicker() {
      const modal = $('mobile-session-picker-modal');
      if (!modal) return;

      
      
      modal.classList.remove('show');

      
      
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }, 300); 

      document.body.classList.remove('modal-visible');
    }

    
    function refreshMobileSessionPicker() {
      loadMobileSessionPickerList();
    }
  </script>




  
  <div id="session-picker-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1052]">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="panel rounded-2xl p-6 w-[40rem] max-h-[70vh] space-y-4 relative">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-sky-600">ä¼šè¯ç®¡ç†</h3>
        <div id="session-count-display" class="text-sm text-slate-600">
          
        </div>
      </div>

      <div class="bg-sky-50 border border-sky-200 rounded-lg p-3">
        <p class="text-sm text-slate-700 mb-2">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
        <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          åˆ›å»ºæ–°ä¼šè¯
        </button>
      </div>

      <div class="space-y-2">
        <div class="flex justify-between items-center">
          <h4 class="font-semibold text-slate-700">ç°æœ‰ä¼šè¯</h4>
          <button class="btn btn-ghost !py-1 !px-2" onclick="refreshSessionPicker()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            åˆ·æ–°
          </button>
        </div>
        <div id="session-picker-list" class="max-h-[40vh] overflow-y-auto space-y-2">
          <p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>
        </div>
      </div>

      <div class="border-t pt-3 text-xs text-slate-500 relative">
        <p>ğŸ’¡ æç¤ºï¼šæ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€ã€‚æ‚¨å¯ä»¥åˆ›å»ºå¤šä¸ªä¼šè¯æ¥ç®¡ç†ä¸åŒçš„è´¦å·ã€‚</p>
      </div>
    </div>
  </div>

  
  <div id="sms-test-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeSMSTestModal()"></div>
    <div class="panel rounded-2xl p-6 w-[35rem] space-y-4 relative">
      
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-green-600">ğŸ§ª çŸ­ä¿¡æµ‹è¯•å‘é€</h3>
        <button onclick="closeSMSTestModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-sm text-blue-800">
          <strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
          â€¢ æ­¤åŠŸèƒ½ç”¨äºæµ‹è¯•çŸ­ä¿¡é…ç½®æ˜¯å¦æ­£ç¡®<br>
          â€¢ å¯ä»¥å‘é€éšæœºéªŒè¯ç ï¼Œæˆ–æŒ‡å®šç‰¹å®šçš„éªŒè¯ç è¿›è¡Œæµ‹è¯•<br>
          â€¢ éªŒè¯ç å°†åŒæ—¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼Œä¾¿äºæ‚¨éªŒè¯çŸ­ä¿¡æ˜¯å¦æ”¶åˆ°<br>
          â€¢ æµ‹è¯•è®°å½•ä¼šä¿å­˜åœ¨çŸ­ä¿¡å‘é€å†å²ä¸­
        </p>
      </div>

      
      <div class="space-y-2">
        <label class="block text-sm font-semibold text-slate-700">
          <span class="inline-flex items-center gap-1">
            ğŸ“± ç›®æ ‡æ‰‹æœºå·
          </span>
        </label>
        <input type="tel" id="sms-test-phone"
          class="w-full border-2 border-green-200 rounded-lg px-4 py-3 focus:border-green-400 focus:ring-2 focus:ring-green-200 transition-all text-lg"
          placeholder="è¯·è¾“å…¥è¦æµ‹è¯•çš„æ‰‹æœºå·ï¼ˆ11ä½ï¼‰" maxlength="11" inputmode="numeric">
        <p class="text-xs text-slate-500">âš ï¸ è¯·è¾“å…¥çœŸå®æœ‰æ•ˆçš„æ‰‹æœºå·ï¼Œç¡®ä¿èƒ½æ”¶åˆ°çŸ­ä¿¡</p>
      </div>

      
      <div class="space-y-2">
        <label class="block text-sm font-semibold text-slate-700">
          <span class="inline-flex items-center gap-1">
            ğŸ”¢ éªŒè¯ç ï¼ˆå¯é€‰ï¼‰
          </span>
        </label>
        <input type="text" id="sms-test-code-input"
          class="w-full border-2 border-blue-200 rounded-lg px-4 py-3 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all text-lg font-mono"
          placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”ŸæˆéšæœºéªŒè¯ç " maxlength="8" inputmode="numeric">
        <p class="text-xs text-slate-500">ğŸ’¡ å¯è¾“å…¥4-8ä½æ•°å­—ä½œä¸ºæµ‹è¯•éªŒè¯ç ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ6ä½éšæœºéªŒè¯ç </p>
      </div>

      
      <div id="sms-test-result" class="hidden">
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <div class="text-3xl">âœ…</div>
            <div class="flex-1">
              <div class="font-semibold text-green-800 mb-2">æµ‹è¯•çŸ­ä¿¡å‘é€æˆåŠŸï¼</div>
              <div class="space-y-1 text-sm text-slate-700">
                <div class="flex items-center gap-2">
                  <span class="font-medium">éªŒè¯ç ï¼š</span>
                  <span id="sms-test-code" class="font-mono text-2xl font-bold text-green-600">------</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="font-medium">æ‰‹æœºå·ï¼š</span>
                  <span id="sms-test-phone-display" class="font-mono">-----------</span>
                </div>
              </div>
              <div class="mt-3 text-xs text-slate-600 bg-white/50 p-2 rounded">
                ğŸ’¡ è¯·æ£€æŸ¥æ‰‹æœºæ˜¯å¦æ”¶åˆ°åŒ…å«ä¸Šè¿°éªŒè¯ç çš„çŸ­ä¿¡ã€‚å¦‚æœæ”¶åˆ°ï¼Œè¯´æ˜çŸ­ä¿¡é…ç½®æ­£ç¡®ã€‚
              </div>
            </div>
          </div>
        </div>
      </div>

      
      <div class="flex gap-3 pt-3 border-t">
        <button onclick="closeSMSTestModal()" class="flex-1 btn btn-ghost min-h-[44px]">
          å–æ¶ˆ
        </button>
        <button id="btn-send-test-sms" onclick="sendTestSMS()" class="flex-1 btn btn-success min-h-[44px]">
          <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8">
            </path>
          </svg>
          å‘é€æµ‹è¯•çŸ­ä¿¡
        </button>
      </div>

      
      <div class="text-xs text-slate-500 text-center pt-2 border-t">
        æµ‹è¯•è®°å½•ä¼šè‡ªåŠ¨ä¿å­˜åˆ°"çŸ­ä¿¡å‘é€å†å²"ä¸­ï¼Œåœºæ™¯æ ‡è®°ä¸º"admin_test"
      </div>
    </div>
  </div>

  
  <div id="captcha-detail-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeCaptchaDetailModal()"></div>
    <div class="panel rounded-2xl p-6 w-[40rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
      
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-blue-600">ğŸ” éªŒè¯ç è¯¦ç»†ä¿¡æ¯</h3>
        <button onclick="closeCaptchaDetailModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      
      <div id="captcha-detail-content" class="space-y-4">
        
        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg p-4">
          <h4 class="font-semibold text-blue-900 mb-3 flex items-center gap-2">
            <span class="text-xl">ğŸ“‹</span>
            åŸºæœ¬ä¿¡æ¯
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex">
              <span class="text-slate-600 w-24">éªŒè¯ç ID:</span>
              <span id="detail-captcha-id" class="font-mono text-slate-800 flex-1 break-all">-</span>
            </div>
            <div class="flex">
              <span class="text-slate-600 w-24">éªŒè¯ç :</span>
              <span id="detail-code" class="font-mono text-2xl font-bold text-blue-600">-</span>
            </div>
            <div class="flex">
              <span class="text-slate-600 w-24">çŠ¶æ€:</span>
              <span id="detail-status" class="px-2 py-1 text-xs rounded">-</span>
            </div>
          </div>
        </div>

        
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4">
          <h4 class="font-semibold text-green-900 mb-3 flex items-center gap-2">
            <span class="text-xl">â°</span>
            æ—¶é—´ä¿¡æ¯
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex">
              <span class="text-slate-600 w-24">åˆ›å»ºæ—¶é—´:</span>
              <span id="detail-created-time" class="text-slate-800">-</span>
            </div>
            <div id="detail-verified-time-container" class="flex hidden">
              <span class="text-slate-600 w-24">éªŒè¯æ—¶é—´:</span>
              <span id="detail-verified-time" class="text-slate-800">-</span>
            </div>
            <div id="detail-expired-time-container" class="flex hidden">
              <span class="text-slate-600 w-24">è¿‡æœŸæ—¶é—´:</span>
              <span id="detail-expired-time" class="text-slate-800">-</span>
            </div>
          </div>
        </div>

        
        <div id="detail-verification-card"
          class="hidden bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4">
          <h4 class="font-semibold text-purple-900 mb-3 flex items-center gap-2">
            <span class="text-xl">âœ…</span>
            éªŒè¯ä¿¡æ¯
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex">
              <span class="text-slate-600 w-24">ç”¨æˆ·è¾“å…¥:</span>
              <span id="detail-user-input" class="font-mono font-bold">-</span>
            </div>
            <div class="flex">
              <span class="text-slate-600 w-24">éªŒè¯ç»“æœ:</span>
              <span id="detail-verification-result">-</span>
            </div>
          </div>
        </div>

        
        <div class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 rounded-lg p-4">
          <h4 class="font-semibold text-orange-900 mb-3 flex items-center gap-2">
            <span class="text-xl">ğŸŒ</span>
            å®¢æˆ·ç«¯ä¿¡æ¯
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex">
              <span class="text-slate-600 w-24">IPåœ°å€:</span>
              <span id="detail-client-ip" class="font-mono text-slate-800">-</span>
            </div>
            <div class="flex flex-col">
              <span class="text-slate-600 mb-1">User Agent:</span>
              <span id="detail-user-agent"
                class="text-xs text-slate-600 font-mono bg-white p-2 rounded break-all">-</span>
            </div>
          </div>
        </div>

        
        <div id="detail-captcha-image-card"
          class="hidden bg-gradient-to-br from-slate-50 to-gray-50 border-2 border-slate-200 rounded-lg p-4">
          <h4 class="font-semibold text-slate-900 mb-3 flex items-center gap-2">
            <span class="text-xl">ğŸ–¼ï¸</span>
            éªŒè¯ç å›¾ç‰‡
          </h4>
          <div id="detail-captcha-html"
            class="flex items-center justify-center bg-white p-4 rounded-lg border border-slate-200">
            
          </div>
        </div>
      </div>

      
      <div class="pt-4 border-t">
        <button onclick="closeCaptchaDetailModal()" class="w-full btn btn-ghost min-h-[44px]">
          å…³é—­
        </button>
      </div>
    </div>
  </div>

  
  <div id="create-group-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeCreateGroupModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] space-y-4 relative">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">åˆ›å»ºæƒé™ç»„</h3>
        <button onclick="closeCreateGroupModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">æƒé™ç»„é”®å</label>
          <input type="text" id="new-group-key" class="input-field w-full" placeholder="ä¾‹å¦‚: custom_group">
          <p class="text-xs text-slate-500 mt-1">è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œç”¨äºå†…éƒ¨æ ‡è¯†</p>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">æƒé™ç»„åç§°</label>
          <input type="text" id="new-group-name" class="input-field w-full" placeholder="ä¾‹å¦‚: è‡ªå®šä¹‰æƒé™ç»„">
          <p class="text-xs text-slate-500 mt-1">æ˜¾ç¤ºåç§°ï¼Œç”¨äºç•Œé¢å±•ç¤º</p>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æƒé™è®¾ç½®</label>
          <div id="create-group-permissions"
            class="grid grid-cols-2 gap-2 max-h-[40vh] overflow-y-auto border border-slate-200 rounded-lg p-3">
            
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeCreateGroupModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitCreateGroup()" class="btn btn-primary">åˆ›å»º</button>
      </div>
    </div>
  </div>

  
  <div id="edit-group-permissions-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeEditGroupPermissionsModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">ç¼–è¾‘æƒé™ç»„: <span id="edit-group-name"></span></h3>
        <button onclick="closeEditGroupPermissionsModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æƒé™è®¾ç½®</label>
          <div id="edit-group-permissions-list"
            class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto border border-slate-200 rounded-lg p-3">
            
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeEditGroupPermissionsModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitEditGroupPermissions()" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  
  <div id="manage-user-permissions-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="closeManageUserPermissionsModal()"></div>
    <div class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">ç®¡ç†ç”¨æˆ·æƒé™: <span id="manage-user-name"></span></h3>
        <button onclick="closeManageUserPermissionsModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <p class="text-sm text-blue-700">
          <strong>æƒé™ç»„:</strong> <span id="user-base-group" class="font-mono"></span>
        </p>
        <p class="text-xs text-slate-600 mt-1">
          ğŸ’¡ ä»¥ä¸‹ä¸ºç”¨æˆ·ç›¸å¯¹äºæƒé™ç»„çš„å·®åˆ†åŒ–æƒé™ã€‚ç»¿è‰²è¡¨ç¤ºé¢å¤–æ·»åŠ çš„æƒé™ï¼Œçº¢è‰²è¡¨ç¤ºç§»é™¤çš„æƒé™ã€‚
        </p>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æƒé™è°ƒæ•´</label>
          <div id="manage-user-permissions-list"
            class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto border border-slate-200 rounded-lg p-3">
            
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeManageUserPermissionsModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitManageUserPermissions()" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  
  <div id="manage-school-accounts-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    
    <div class="absolute inset-0 bg-black/60" onclick="closeManageSchoolAccountsModal()"></div>

    
    <div class="panel rounded-2xl p-6 w-[50rem] max-h-[80vh] overflow-y-auto space-y-4 relative">
      
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-sky-600">
          ç®¡ç†å­¦æ ¡è´¦æˆ·: <span id="school-accounts-username" class="text-slate-700"></span>
        </h3>
        <button onclick="closeManageSchoolAccountsModal()" class="btn btn-ghost !py-1 !px-3">å…³é—­</button>
      </div>

      
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-blue-700">
              <strong>è´¦æˆ·æ€»æ•°:</strong> <span id="school-accounts-count" class="font-mono">0</span>
            </p>
            <p class="text-xs text-slate-600 mt-1">
              ğŸ’¡ æ‚¨å¯ä»¥æŸ¥çœ‹ã€ç¼–è¾‘æˆ–åˆ é™¤æ­¤ç”¨æˆ·çš„å­¦æ ¡è´¦æˆ·ä¿¡æ¯
            </p>
          </div>
          
          <button onclick="addNewSchoolAccount()" class="btn btn-primary !py-2 !px-4 !text-sm flex items-center gap-2">
            <svg xmlns="http:
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            æ–°å¢è´¦æˆ·
          </button>
        </div>
      </div>

      
      <div id="school-accounts-list" class="space-y-3 max-h-[50vh] overflow-y-auto">
        
      </div>

      
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeManageSchoolAccountsModal()" class="btn btn-ghost border border-slate-300">å…³é—­</button>
      </div>
    </div>
  </div>

  
  <div id="edit-school-account-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1055]">
    
    <div class="absolute inset-0 bg-black/60" onclick="closeEditSchoolAccountModal()"></div>

    
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <h3 class="text-xl font-bold text-amber-600">ç¼–è¾‘å­¦æ ¡è´¦æˆ·</h3>

      
      <div class="space-y-2">
        <p class="text-sm text-slate-600">
          è®¤è¯ç”¨æˆ·: <span id="edit-auth-username" class="font-semibold text-slate-800"></span>
        </p>
        <p class="text-sm text-slate-600">
          å­¦æ ¡è´¦æˆ·: <span id="edit-school-username" class="font-semibold text-slate-800"></span>
        </p>
      </div>

      
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">å¯†ç </label>
          <input type="text" id="edit-school-password" class="input-field" placeholder="è¾“å…¥æ–°å¯†ç ">
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">User-Agentï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="edit-school-ua" class="input-field" rows="3" placeholder="è¾“å…¥User-Agentï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
      </div>

      
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="closeEditSchoolAccountModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitEditSchoolAccount()" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  
  <div id="set-max-sessions-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="hideModal('set-max-sessions-modal')"></div>
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <h3 class="text-xl font-bold text-sky-600">è®¾ç½®ä¼šè¯é™åˆ¶</h3>

      <div class="space-y-2">
        <p class="text-sm text-slate-600">ç”¨æˆ·: <span id="sessions-username" class="font-semibold text-slate-800"></span>
        </p>
        <p class="text-sm text-slate-600">å½“å‰é™åˆ¶: <span id="sessions-current-max"
            class="font-semibold text-slate-800"></span></p>
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">æ–°ä¼šè¯é™åˆ¶</label>
        <input type="number" id="new-max-sessions" min="0" class="input-field" placeholder="è¾“å…¥ä¼šè¯æ•°é‡">
        <p class="text-xs text-slate-500 mt-1">0 = æ— é™åˆ¶</p>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="hideModal('set-max-sessions-modal')" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitSetMaxSessions()" class="btn btn-primary">ç¡®è®¤</button>
      </div>
    </div>
  </div>

  
  <div id="reset-user-password-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1054]">
    <div class="absolute inset-0 bg-black/60" onclick="hideModal('reset-user-password-modal')"></div>
    <div class="panel rounded-2xl p-6 w-96 space-y-4 relative">
      <h3 class="text-xl font-bold text-amber-600">é‡ç½®ç”¨æˆ·å¯†ç </h3>

      <div>
        <p class="text-sm text-slate-600">ç›®æ ‡ç”¨æˆ·: <span id="reset-password-username"
            class="font-semibold text-slate-800"></span></p>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">æ–°å¯†ç </label>
          <input type="password" id="reset-new-password" class="input-field" placeholder="è¾“å…¥æ–°å¯†ç ">
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">ç¡®è®¤å¯†ç </label>
          <input type="password" id="reset-confirm-password" class="input-field" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button onclick="hideModal('reset-user-password-modal')"
          class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="submitResetUserPassword()" class="btn btn-primary">é‡ç½®å¯†ç </button>
      </div>
    </div>
  </div>

  
  <div id="avatar-crop-modal" class="fixed inset-0 flex items-center justify-center hidden z-[1055]">
    <div class="absolute inset-0 bg-black/80" onclick="closeCropModal()"></div>
    <div class="panel rounded-2xl p-6 max-w-2xl w-full mx-4 space-y-4 relative">
      <h3 class="text-xl font-bold text-sky-600">è£å‰ªå¤´åƒ</h3>

      <div class="max-h-96 overflow-hidden bg-slate-100 rounded-lg">
        <img id="crop-image" src="" alt="å¾…è£å‰ªå›¾ç‰‡" style="max-width: 100%;">
      </div>

      <div class="flex gap-2 justify-end">
        <button onclick="closeCropModal()" class="btn btn-ghost border border-slate-300">å–æ¶ˆ</button>
        <button onclick="confirmCropAndUpload()" class="btn btn-primary">ç¡®è®¤å¹¶ä¸Šä¼ </button>
      </div>
    </div>
  </div>

  <script>
    
    
    

    

    let refreshUserListInterval = null;
    let isInNetworkErrorState = false; 
    let cdnErrorCount = 0;
    let cdnErrorTimer = null;
    let appInitialized = false;

    let currentUserIsGuest = false;
    let currentAuthUsername = null; 
    let healthAutoRefreshInterval = null; 
    let multiAccountAutoRefreshInterval = null; 
    let avatarCropper = null; 
    let isRegistrationCrop = false; 
    let registrationCroppedAvatarBlob = null; 
    let currentLogPage = 1; 
    let croppedAvatarFile = null; 

    
    let currentSessionInfo = {
      maxSessions: 1,
      currentCount: 0
    };

    
    
    
    

    
    let isMobileMode = false;

    
    function detectMobileDevice() {
      
      
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i;
      const isMobile = mobileRegex.test(userAgent);

      
      console.log('[ç§»åŠ¨ç«¯æ£€æµ‹] User-Agent:', userAgent);
      console.log('[ç§»åŠ¨ç«¯æ£€æµ‹] æœ€ç»ˆåˆ¤å®š:', isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'æ¡Œé¢è®¾å¤‡');

      return isMobile;
    }

    
    function switchUIContainer() {
      
      const mobileContainer = document.getElementById('mobile-container');
      
      const desktopContainer = document.getElementById('desktop-container');

      
      if (!mobileContainer || !desktopContainer) {
        console.warn('[UIåˆ‡æ¢] è­¦å‘Šï¼šç§»åŠ¨ç«¯æˆ–æ¡Œé¢ç«¯å®¹å™¨æœªæ‰¾åˆ°');
        return;
      }

      
      const isMobile = detectMobileDevice();
      
      isMobileMode = isMobile;

      if (isMobile) {
        
        console.log('[UIåˆ‡æ¢] åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯æ¨¡å¼');

        
        
        const desktopLoginVisible = !$('login-container').classList.contains('hidden');
        const desktopAuthVisible = !$('auth-login-container').classList.contains('hidden');
        const desktopMainAppVisible = !$('main-app').classList.contains('hidden');
        const desktopMultiAccountVisible = !$('multi-account-app').classList.contains('hidden');

        
        mobileContainer.style.display = 'block';
        
        desktopContainer.style.setProperty('display', 'none', 'important');

        
        const desktopElements = [
          'auth-login-container',
          'login-container',
          'main-app',
          'multi-account-app'
        ];
        desktopElements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.style.setProperty('display', 'none', 'important');
            el.style.setProperty('visibility', 'hidden', 'important');
            el.style.setProperty('pointer-events', 'none', 'important');
          }
        });

        
        $('mobile-login-container').classList.add('hidden');
        $('mobile-auth-login-container').classList.add('hidden');
        $('mobile-main-app').classList.add('hidden');
        $('mobile-multi-account-app').classList.add('hidden');

        
        if (desktopMainAppVisible) {
          
          
          if (typeof destroyMobileMultiMap === 'function') {
            destroyMobileMultiMap();
            console.log('[UIåˆ‡æ¢] å·²é”€æ¯å¤šè´¦å·åœ°å›¾ï¼ˆåˆ‡æ¢åˆ°å•è´¦å·æ¨¡å¼ï¼‰');
          }
          
          
          const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
          if (mobileLoadingOverlay) {
            mobileLoadingOverlay.classList.remove('hidden');
          }

          $('mobile-main-app').classList.remove('hidden');
          updateMobileNavVisibility(true, 'single');
          console.log('[UIåˆ‡æ¢] PCç«¯main-appå¯è§ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯mobile-main-app');
          
          switchMobileSinglePanel('mobile-control-panel');
          console.log('[UIåˆ‡æ¢] å·²é»˜è®¤æ¿€æ´»mobile-control-panel');

          
          setTimeout(() => {
            if (mobileLoadingOverlay) {
              mobileLoadingOverlay.classList.add('hidden');
            }
          }, 500);
        } else if (desktopMultiAccountVisible) {
          
          
          if (typeof destroyMobileSingleMap === 'function') {
            destroyMobileSingleMap();
            console.log('[UIåˆ‡æ¢] å·²é”€æ¯å•è´¦å·åœ°å›¾ï¼ˆåˆ‡æ¢åˆ°å¤šè´¦å·æ¨¡å¼ï¼‰');
          }
          
          $('mobile-multi-account-app').classList.remove('hidden');
          updateMobileNavVisibility(true, 'multi');
          console.log('[UIåˆ‡æ¢] PCç«¯multi-account-appå¯è§ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯mobile-multi-account-app');
          
          switchMobilePanel('mobile-multi-control-panel', 'multi');
          console.log('[UIåˆ‡æ¢] å·²é»˜è®¤æ¿€æ´»mobile-multi-control-panel');
        } else if (desktopLoginVisible) {
          
          $('mobile-login-container').classList.remove('hidden');
          updateMobileNavVisibility(false);
          console.log('[UIåˆ‡æ¢] PCç«¯login-containerå¯è§ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯mobile-login-container');
        } else if (desktopAuthVisible) {
          
          $('mobile-auth-login-container').classList.remove('hidden');
          updateMobileNavVisibility(false);
          console.log('[UIåˆ‡æ¢] PCç«¯auth-login-containerå¯è§ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯mobile-auth-login-container');
        }

        
        const modalElements = [
          'admin-panel-modal',
          'session-picker-modal'
        ];
        modalElements.forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.classList.contains('hidden')) {
            el.classList.add('hidden');
          }
        });

        
        document.body.classList.add('mobile-mode');

        
        initializeMobileUI();
      } else {
        
        console.log('[UIåˆ‡æ¢] åˆ‡æ¢åˆ°æ¡Œé¢ç«¯æ¨¡å¼');

        
        
        const mobileLoginVisible = !$('mobile-login-container').classList.contains('hidden');
        const mobileAuthVisible = !$('mobile-auth-login-container').classList.contains('hidden');
        const mobileMainAppVisible = !$('mobile-main-app').classList.contains('hidden');
        const mobileMultiAccountVisible = !$('mobile-multi-account-app').classList.contains('hidden');

        
        mobileContainer.style.display = 'none';
        
        desktopContainer.style.display = 'block';

        
        document.body.classList.remove('mobile-mode');

        const desktopElements = [
          'auth-login-container',
          'login-container',
          'main-app',
          'multi-account-app'
        ];
        desktopElements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            
            
            el.style.removeProperty('display');
            el.style.removeProperty('visibility');
            el.style.removeProperty('pointer-events');
          }
        });

        
        $('login-container').classList.add('hidden');
        $('auth-login-container').classList.add('hidden');
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.add('hidden');

        
        if (mobileMainAppVisible) {
          
          $('main-app').classList.remove('hidden');
          $('main-app').classList.add('grid');
          console.log('[UIåˆ‡æ¢] ç§»åŠ¨ç«¯mobile-main-appå¯è§ï¼Œæ˜¾ç¤ºPCç«¯main-app');
        } else if (mobileMultiAccountVisible) {
          
          $('multi-account-app').classList.remove('hidden');
          $('multi-account-app').classList.add('grid');
          console.log('[UIåˆ‡æ¢] ç§»åŠ¨ç«¯mobile-multi-account-appå¯è§ï¼Œæ˜¾ç¤ºPCç«¯multi-account-app');
        } else if (mobileLoginVisible) {
          
          $('login-container').classList.remove('hidden');
          console.log('[UIåˆ‡æ¢] ç§»åŠ¨ç«¯mobile-login-containerå¯è§ï¼Œæ˜¾ç¤ºPCç«¯login-container');
        } else if (mobileAuthVisible) {
          
          $('auth-login-container').classList.remove('hidden');
          console.log('[UIåˆ‡æ¢] ç§»åŠ¨ç«¯mobile-auth-login-containerå¯è§ï¼Œæ˜¾ç¤ºPCç«¯auth-login-container');
        }


      }
    }



    
    async function saveMobileAttendanceParams() {
      const enabledInput = document.getElementById('mobile-param-auto_attendance_enabled');
      const refreshInput = document.getElementById('mobile-param-auto_attendance_refresh_s');
      const radiusInput = document.getElementById('mobile-param-attendance_user_radius_m');

      if (!enabledInput || !refreshInput || !radiusInput) {
        showTempMessage('æ— æ³•è·å–å‚æ•°è¾“å…¥æ¡†', 'error');
        return;
      }

      const enabled = enabledInput.checked;
      const refresh = parseInt(refreshInput.value);
      const radius = parseInt(radiusInput.value);

      if (isNaN(refresh) || refresh < 15) {
        showTempMessage('åˆ·æ–°é—´éš”ä¸èƒ½å°äº15ç§’', 'error');
        return;
      }

      try {
        
        
        await callPythonAPI('update_param', 'auto_attendance_enabled', enabled);
        await callPythonAPI('update_param', 'auto_attendance_refresh_s', refresh);
        await callPythonAPI('update_param', 'attendance_user_radius_m', radius);

        
        if (typeof pythonParams !== 'undefined') {
          pythonParams['auto_attendance_enabled'] = enabled;
          pythonParams['auto_attendance_refresh_s'] = refresh;
          pythonParams['attendance_user_radius_m'] = radius;
        }

        showTempMessage('è‡ªåŠ¨ç­¾åˆ°é…ç½®å·²ä¿å­˜', 'success');

        
        if (enabled) {
          
        }

      } catch (e) {
        console.error('ä¿å­˜ç­¾åˆ°é…ç½®å¤±è´¥:', e);
        showTempMessage('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
      }
    }


    
    function isSessionUUIDInvalid(uuid) {
      
      return !uuid || uuid.trim() === '' || uuid === 'null';
    }

    
    function run_code_need_sessionuuid(codeToRun) {

      
      let isInvalid = isSessionUUIDInvalid(sessionUUID);

      if (isInvalid) {
        
        logMessage_Warning('sessionUUID ä¸ºç©ºï¼Œå°è¯•ä» URL ä¸­æå–');
        sessionUUID = getUUIDFromURL(); 

        
        isInvalid = isSessionUUIDInvalid(sessionUUID);

        if (!isInvalid) {
          logMessage_Info('æˆåŠŸä» URL ä¸­æå– sessionUUID: ' + sessionUUID);
        }
      }

      
      if (isInvalid) {
        
        logMessage_Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ sessionUUIDï¼Œæ‰€éœ€æ“ä½œæ— æ³•æ‰§è¡Œ');
      } else {
        
        codeToRun();
      }
    }

    function run_code_not_need_sessionuuid(codeToRun) {

      
      let isInvalid = isSessionUUIDInvalid(sessionUUID);

      if (isInvalid) {
        
        logMessage_Warning('sessionUUID ä¸ºç©ºï¼Œå°è¯•ä» URL ä¸­æå–');
        sessionUUID = getUUIDFromURL(); 

        
        isInvalid = isSessionUUIDInvalid(sessionUUID);

        if (!isInvalid) {
          logMessage_Success('æˆåŠŸä» URL ä¸­æå– sessionUUID: ' + sessionUUID);
        }
      }

      
      if (isInvalid) {
        
        logMessage_Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ sessionUUIDï¼Œæ‰€éœ€æ“ä½œæ— æ³•æ‰§è¡Œ');
        codeToRun();
      }

    }


    
    function initializeMobileUI() {
      console.log('[ç§»åŠ¨ç«¯UI] åˆå§‹åŒ–ç§»åŠ¨ç«¯UIåŠŸèƒ½ (é‡æ„ç‰ˆ)');
      
      const loadingOverlayEl = document.getElementById('loading-overlay');
      if (loadingOverlayEl) loadingOverlayEl.classList.remove('hidden');


      function showMobileAuthForm(formToShow) {
        
        
        const loginTab = document.getElementById('mobile-auth-tab-login');
        const registerTab = document.getElementById('mobile-auth-tab-register');
        
        const loginForm = document.getElementById('mobile-login-form');
        const registerForm = document.getElementById('mobile-register-form');
        const tfaForm = document.getElementById('mobile-auth-2fa-form');

        
        if (loginForm) loginForm.classList.add('hidden');
        if (registerForm) registerForm.classList.add('hidden');
        if (tfaForm) tfaForm.classList.add('hidden');

        
        if (formToShow === 'register') {
          
          if (registerForm) registerForm.classList.remove('hidden');
          
          if (loginTab) loginTab.className = 'flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition';
          if (registerTab) registerTab.className = 'flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition';

          
          
          loadCaptcha('register');
        } else { 
          
          if (loginForm) loginForm.classList.remove('hidden');
          
          if (loginTab) loginTab.className = 'flex-1 py-3 font-semibold text-sky-600 border-b-2 border-sky-600 transition';
          if (registerTab) registerTab.className = 'flex-1 py-3 font-semibold text-slate-400 border-b-2 border-transparent transition';

          
          
          loadCaptcha('login');
        }

        
        showMobileMessage('', 'clear');
      }

      
      const loginTabBtn = document.getElementById('mobile-auth-tab-login');
      const registerTabBtn = document.getElementById('mobile-auth-tab-register');
      if (loginTabBtn) loginTabBtn.addEventListener('click', () => showMobileAuthForm('login'));
      if (registerTabBtn) registerTabBtn.addEventListener('click', () => showMobileAuthForm('register'));

      
      const mobileUsernameBtn = document.getElementById('mobile-login-username-btn');
      const mobilePhoneBtn = document.getElementById('mobile-login-phone-btn');
      const mobileAuthInputContainer = document.getElementById('mobile-username-container');
      const mobileAuthLabel = document.getElementById('mobile-login-label');
      const mobileSwitchToSms = document.getElementById('mobile-switch-to-sms');

      if (mobileUsernameBtn && mobilePhoneBtn && mobileAuthInputContainer && mobileAuthLabel && mobileSwitchToSms) {
        mobileUsernameBtn.addEventListener('click', function () {
          mobileUsernameBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          mobilePhoneBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          const currentValue = mobileAuthInputContainer.querySelector('input').value;
          mobileAuthLabel.textContent = 'ç”¨æˆ·å';
          
          mobileAuthInputContainer.innerHTML = `
            <input type="text" id="mobile-auth-username" class="w-full" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username" value="${currentValue || ''}">
          `;
          mobileSwitchToSms.classList.add('hidden');
          
          document.getElementById('mobile-password-section').classList.remove('hidden');
          document.getElementById('mobile-sms-section').classList.add('hidden');
        });

        mobilePhoneBtn.addEventListener('click', function () {
          mobilePhoneBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          mobileUsernameBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          const currentValue = mobileAuthInputContainer.querySelector('input').value;
          mobileAuthLabel.textContent = 'æ‰‹æœºå·';
          
          mobileAuthInputContainer.innerHTML = `
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+86 </span>
              <input type="tel" id="mobile-auth-username" class="input-field" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel" inputmode="numeric" maxlength="11" value="${currentValue || ''}">
            </div>
          `;
          mobileSwitchToSms.classList.remove('hidden');
        });
      }

      
      const mobileSwitchToSmsBtn = document.getElementById('mobile-switch-to-sms');
      const mobileSwitchToPassBtn = document.getElementById('mobile-switch-to-password');
      const mobilePassSection = document.getElementById('mobile-password-section');
      const mobileSmsSection = document.getElementById('mobile-sms-section');

      if (mobileSwitchToSmsBtn) mobileSwitchToSmsBtn.addEventListener('click', () => {
        if (mobilePassSection) mobilePassSection.classList.add('hidden');
        if (mobileSmsSection) mobileSmsSection.classList.remove('hidden');
      });
      if (mobileSwitchToPassBtn) mobileSwitchToPassBtn.addEventListener('click', () => {
        if (mobileSmsSection) mobileSmsSection.classList.add('hidden');
        if (mobilePassSection) mobilePassSection.classList.remove('hidden');
      });

      
      
      

      
      const mobileSendLoginCodeBtn = document.getElementById('mobile-auth-send-login-code');
      if (mobileSendLoginCodeBtn) {
        
        mobileSendLoginCodeBtn.addEventListener('click', async function () {
          
          const phone = document.getElementById('mobile-auth-username').value;
          
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'é”™è¯¯');
            return;
          }

          
          
          
          openCaptchaModal({
            phone: phone,
            button: mobileSendLoginCodeBtn,
            originalText: mobileSendLoginCodeBtn.textContent
          });
        });
      }

      
      const mobileSendRegCodeBtn = document.getElementById('mobile-reg-send-code-btn');
      if (mobileSendRegCodeBtn) {
        
        mobileSendRegCodeBtn.addEventListener('click', async function () {
          
          const phone = document.getElementById('mobile-reg-phone').value;
          
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'é”™è¯¯');
            return;
          }

          
          
          
          openCaptchaModal({
            phone: phone,
            button: mobileSendRegCodeBtn,
            originalText: mobileSendRegCodeBtn.textContent
          });
        });
      }



      
      refreshCaptcha('mobile-login');
      refreshCaptcha('mobile-register');


      
      

      
      const mobileLoginBtn = document.getElementById('mobile-login-btn');
      if (mobileLoginBtn) mobileLoginBtn.addEventListener('click', async () => {
        
        setButtonLoading('mobile-login-btn', true, 'ç™»å½•ä¸­...');

        try {
          
          
          document.getElementById('auth-username').value = document.getElementById('mobile-auth-username').value;
          
          document.getElementById('auth-password').value = document.getElementById('mobile-auth-password').value;
          
          document.getElementById('auth-sms-code').value = document.getElementById('mobile-auth-sms-code').value;
          
          document.getElementById('auth-login-captcha').value = document.getElementById('mobile-login-captcha').value;

          
          if (!document.getElementById('mobile-password-section').classList.contains('hidden')) {
            
            document.getElementById('auth-password-section').classList.remove('hidden');
            document.getElementById('auth-sms-section').classList.add('hidden');
          } else {
            
            document.getElementById('auth-password-section').classList.add('hidden');
            document.getElementById('auth-sms-section').classList.remove('hidden');
          }

          if (!document.getElementById('mobile-login-phone-btn').classList.contains('text-slate-600')) {
            
            
            document.getElementById('auth-login-phone-btn').classList.add('font-semibold');
          } else {
            
            document.getElementById('auth-login-phone-btn').classList.remove('font-semibold');
          }

          
          await handleAuthLogin();

          
          
          const tfaForm = document.getElementById('auth-2fa-form');
          if (tfaForm && !tfaForm.classList.contains('hidden')) {
            
            
            document.getElementById('mobile-login-form').classList.add('hidden');
            document.getElementById('mobile-auth-2fa-form').classList.remove('hidden');
            document.getElementById('mobile-2fa-code').value = '';
            document.getElementById('mobile-2fa-code').focus();
            showMobileMessage('å¯†ç éªŒè¯æˆåŠŸï¼Œè¯·è¾“å…¥éªŒè¯ç ', 'success');

            
            setButtonLoading('mobile-login-btn', false);

          } else {
            
            
            showButtonSuccess('mobile-login-btn', 'ç™»å½•æˆåŠŸ', 800);
            
          }

        } catch (e) {
          
          console.error("ä»£ç†[ç™»å½•]å¤±è´¥:", e);
          
          showMobileMessage(e.message || 'ç™»å½•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
          
          showButtonError('mobile-login-btn', 'ç™»å½•å¤±è´¥');

        } finally {
          
          
          const tfaForm = document.getElementById('auth-2fa-form');
          if (!tfaForm || tfaForm.classList.contains('hidden')) {
            
            setButtonLoading('auth-login-btn', false);
            setButtonLoading('mobile-login-btn', false);
          }
        }
      });

      
      const mobileRegisterBtn = document.getElementById('mobile-register-btn');
      if (mobileRegisterBtn) mobileRegisterBtn.addEventListener('click', async () => {
        try {
          
          
          document.getElementById('auth-reg-username').value = document.getElementById('mobile-reg-username').value;
          
          document.getElementById('auth-reg-phone').value = document.getElementById('mobile-reg-phone').value;
          
          document.getElementById('auth-reg-sms-code').value = document.getElementById('mobile-reg-sms-code').value;
          
          document.getElementById('auth-reg-nickname').value = document.getElementById('mobile-reg-nickname').value;
          
          document.getElementById('auth-reg-password').value = document.getElementById('mobile-reg-password').value;
          
          document.getElementById('auth-reg-password-confirm').value = document.getElementById('mobile-reg-password-confirm').value;
          
          document.getElementById('auth-register-captcha').value = document.getElementById('mobile-register-captcha').value;

          

          
          await handleAuthRegister();
        } catch (e) {
          console.error("ä»£ç†[æ³¨å†Œ]å¤±è´¥:", e);
          showMobileMessage('æ³¨å†Œæ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
        }
      });

      
      const mobileGuestBtn = document.getElementById('mobile-guest-btn');
      if (mobileGuestBtn) mobileGuestBtn.addEventListener('click', async () => {
        try {
          await handleGuestLogin();
        } catch (e) {
          console.error("ä»£ç†[æ¸¸å®¢ç™»å½•]å¤±è´¥:", e);
          showMobileMessage('æ¸¸å®¢ç™»å½•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
        }
      });

      
      const mobile2faBtn = document.getElementById('mobile-2fa-submit-btn');
      if (mobile2faBtn) mobile2faBtn.addEventListener('click', async () => {
        try {
          document.getElementById('auth-2fa-code').value = document.getElementById('mobile-2fa-code').value;
          await handle2FAVerify();
        } catch (e) {
          console.error("ä»£ç†[2FAéªŒè¯]å¤±è´¥:", e);
          showMobileMessage('2FAéªŒè¯æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
        }
      });

      
      const mobile2faBackBtn = document.getElementById('mobile-2fa-back-btn');
      if (mobile2faBackBtn) mobile2faBackBtn.addEventListener('click', () => {
        showMobileAuthForm('login');
        
        try {
          document.getElementById('auth-2fa-back-btn').click();
        } catch (e) { }
      });

      
      const mobileAvatarInput = document.getElementById('mobile-reg-avatar');
      if (mobileAvatarInput) {
        
        
        
        
        mobileAvatarInput.addEventListener('change', previewAvatarForRegistration);
      }

      
      
      const mobileGuestSection = document.getElementById('mobile-guest-login-section');
      if (mobileGuestSection) {
        
        
        const desktopGuestSection = document.getElementById('guest-login-section');
        if (desktopGuestSection && !desktopGuestSection.classList.contains('hidden')) {
          mobileGuestSection.classList.remove('hidden');
          console.log('[ç§»åŠ¨ç«¯UI] æ¸¸å®¢ç™»å½•å·²å¯ç”¨');
        } else {
          mobileGuestSection.classList.add('hidden');
          console.log('[ç§»åŠ¨ç«¯UI] æ¸¸å®¢ç™»å½•å·²ç¦ç”¨');
        }
      }

      
      const mobileSingleLoginBtn = document.getElementById('mobile-single-login-btn');
      if (mobileSingleLoginBtn) {
        mobileSingleLoginBtn.addEventListener('click', async function () {
          
          try {
            const username = document.getElementById('mobile-username-entry').value.trim();
            const password = document.getElementById('mobile-password-entry').value;

            if (!username || !password) {
              showMobileMessage('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
              return;
            }

            
            mobileSingleLoginBtn.disabled = true;

            const originalText = mobileSingleLoginBtn.textContent;
            mobileSingleLoginBtn.textContent = 'ç™»å½•ä¸­...';

            
            const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
            if (mobileLoadingOverlay) {
              mobileLoadingOverlay.classList.remove('hidden');
            }

            document.getElementById('username-entry').value = username;
            document.getElementById('password-entry').value = password;

            logMessage_Info('[ç§»åŠ¨ç«¯UI] è§¦å‘å•è´¦å·ï¼ˆå­¦æ ¡ï¼‰ç™»å½•...');

            let result_mobile_login = false;
            
            await result_mobile_login == onLogin();

            
            if (result_mobile_login) {
              
              const desktopMainApp = document.getElementById('main-app');
              if (desktopMainApp && !desktopMainApp.classList.contains('hidden')) {
                desktopMainApp.classList.add('hidden');
                desktopMainApp.classList.remove('grid');
              }

              
              document.getElementById('mobile-login-container').classList.add('hidden');

              
              const mobileMainApp = document.getElementById('mobile-main-app');
              if (mobileMainApp) {
                mobileMainApp.classList.remove('hidden');
                logMessage_Info('[ç§»åŠ¨ç«¯UI] å·²æ˜¾ç¤º mobile-main-app');
                
                switchMobileSinglePanel('mobile-control-panel');

                
                setTimeout(() => {
                  const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
                  if (mobileLoadingOverlay) {
                    mobileLoadingOverlay.classList.add('hidden');
                  }
                }, 500);
              }

              
              updateMobileNavVisibility(true, 'single');

              
              if (typeof mobileRefreshNotifications === 'function') {
                await mobileRefreshNotifications();
              }
            } else {
              
              
              
              mobileSingleLoginBtn.disabled = false;
              mobileSingleLoginBtn.textContent = originalText;
              const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
              if (mobileLoadingOverlay) {
                mobileLoadingOverlay.classList.add('hidden');
              }
            }
          } catch (e) {
            logMessage_Error("ä»£ç†[å­¦æ ¡ç™»å½•]å¤±è´¥:", e);
            showMobileMessage('å­¦æ ¡ç™»å½•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯', 'error');
            
            mobileSingleLoginBtn.disabled = false;
            mobileSingleLoginBtn.textContent = "ç™»å½•";
            const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
            if (mobileLoadingOverlay) {
              mobileLoadingOverlay.classList.add('hidden');
            }
          }
        });
      }

      
      const mobileUserCombo = document.getElementById('mobile-user-combo');
      if (mobileUserCombo) {
        mobileUserCombo.addEventListener('change', onMobileUserChange);
      }

      
      
      const mobileUsernameEntry = document.getElementById('mobile-username-entry');
      if (mobileUsernameEntry && mobileUserCombo) {
        mobileUsernameEntry.addEventListener('input', async function () {
          const username = this.value.trim();
          
          const exists = [...mobileUserCombo.options].some(o => o.value === username);
          mobileUserCombo.value = exists ? username : "";

          
          const mobilePasswordEntry = document.getElementById('mobile-password-entry');
          if (mobilePasswordEntry) mobilePasswordEntry.value = '';

          
          if (exists && username) {
            try {
              const data = await callPythonAPI('on_user_selected', username);
              if (data) {
                
                if (data.password && mobilePasswordEntry) {
                  mobilePasswordEntry.value = data.password;
                }
                
                if (data.ua) {
                  syncUAToMobile(data.ua);
                } else {
                  syncUAToMobile('(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)');
                }
              }
            } catch (error) {
              console.error('[Mobile] è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
          } else {
            
            syncUAToMobile('(æœªåŠ è½½)');
          }
        });
      }

      
      const navButtons = document.querySelectorAll('.mobile-nav-btn');
      navButtons.forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          navButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const navTarget = this.getAttribute('data-nav');
          console.log('[ç§»åŠ¨ç«¯UI] åˆ‡æ¢å¯¼èˆªåˆ°:', navTarget);
          
        });
      });

      
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function () {
          console.log('[ç§»åŠ¨ç«¯UI] èœå•æŒ‰é’®ç‚¹å‡»');
          
          toggleMobileAdminPanel(true);
        });
      }

      
      
      const mobileMultiAccountBtn = document.getElementById('mobile-multi-account-btn');
      if (mobileMultiAccountBtn) {
        mobileMultiAccountBtn.addEventListener('click', async function () {
          console.log('[ç§»åŠ¨ç«¯UI] å¤šè´¦å·æ¨¡å¼æŒ‰é’®ç‚¹å‡»');

          
          const result = await callPythonAPI('enter_multi_account_mode');
          if (!result.success) {
            showModalAlert('è¿›å…¥å¤šè´¦å·æ¨¡å¼å¤±è´¥', 'é”™è¯¯');
            return;
          }

          console.log('[ç§»åŠ¨ç«¯UI] è¿›å…¥å¤šè´¦å·æ¨¡å¼æˆåŠŸ');

          
          const mobileLoginContainer = document.getElementById('mobile-login-container');
          const mobileMultiApp = document.getElementById('mobile-multi-account-app');
          if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
          if (mobileMultiApp) {
            mobileMultiApp.classList.remove('hidden');
            
            switchMobilePanel('mobile-multi-control-panel', 'multi');
          }
          
          updateMobileNavVisibility(true, 'multi');

          
          
          
          startMultiAccountAutoRefresh(10000);
        });
      }

      
      const mobileRefreshSessionsBtn = document.getElementById('mobile-refresh-sessions-btn');
      if (mobileRefreshSessionsBtn) {
        mobileRefreshSessionsBtn.addEventListener('click', async function () {
          console.log('[ç§»åŠ¨ç«¯UI] åˆ·æ–°ä¼šè¯åˆ—è¡¨');
          await loadMobileSessionsList();
        });
      }

      run_code_need_sessionuuid(() => {
        
        loadMobileUserCombo().catch(e => {
          console.error('[Mobile UI] ç§»åŠ¨ç«¯ç”¨æˆ·ä¸‹æ‹‰æ¡†åå°åŠ è½½å¤±è´¥:', e);
        });
      });



      if (loadingOverlayEl) loadingOverlayEl.classList.add('hidden');

      console.log('[ç§»åŠ¨ç«¯UI] ç§»åŠ¨ç«¯UIåˆå§‹åŒ–å®Œæˆ');
    }

    
    async function loadMobileSessionsList() {
      const listEl = document.getElementById('mobile-sessions-list');
      const countEl = document.getElementById('mobile-session-count-display');

      if (!listEl) {
        console.error('[Mobile] æ‰¾ä¸åˆ° mobile-sessions-list å…ƒç´ ');
        return;
      }

      listEl.innerHTML = '<p class="text-slate-400 text-center py-8">åŠ è½½ä¸­...</p>';

      try {
        const headers = { 'X-Session-ID': sessionUUID || null };
        const response = await fetch('/auth/user/sessions', { headers: headers });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-8">${result.message}</p>`;
          return;
        }

        const sessions = result.sessions || [];
        const validSessions = sessions.filter(session =>
          session.session_id && session.session_id !== 'null' && session.session_id.trim() !== ''
        );

        
        if (countEl) {
          const maxSessions = result.max_sessions || 1;
          const currentCount = validSessions.length;
          if (maxSessions === -1) {
            countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
          } else {
            const colorClass = currentCount >= maxSessions ? 'text-red-600' : 'text-slate-600';
            countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
          }
        }

        if (validSessions.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-8">æš‚æ— ä¼šè¯</p>';
          return;
        }

        
        listEl.innerHTML = validSessions.map(session => {
          const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
          const isCurrent = session.is_current || session.session_id === sessionUUID;
          const sessionHash = session.session_hash || session.session_id.substring(0, 16);

          return `
            <div class="mobile-list-item ${isCurrent ? 'border-l-4 border-sky-500 bg-sky-50' : ''}" 
                 onclick="switchToSession('${session.session_id}')">
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${session.session_id}</span>
                  ${isCurrent ? '<span class="text-xs px-2 py-1 rounded-full bg-sky-500 text-white">å½“å‰</span>' : ''}
                </div>
                <p class="text-xs text-slate-600">åˆ›å»ºäº‹ä»¶: ${createdDate}</p>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('[Mobile] åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
        listEl.innerHTML = '<p class="text-red-500 text-center py-8">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
      }
    }
    
    function getUUIDFromURL() {
      const urlPath = window.location.pathname;

      
      
      
      
      
      
      
      
      const match = urlPath.match(/\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i);

      if (match && match[1]) {
        
        
        return match[1];
      } else {
        
        return null;
      }
    }

    
    async function loadMobileUserCombo() {
      if (
        run_code_not_need_sessionuuid(() => {
          
          console.warn('[Mobile UI] sessionUUID æ— æ•ˆï¼Œè·³è¿‡åŠ è½½ç”¨æˆ·ä¸‹æ‹‰æ¡†');
          return false
        }) === false) {
        return;
      }
      const mobileUserCombo = document.getElementById('mobile-user-combo');
      if (!mobileUserCombo) {
        
        logMessage_Error('[Mobile] æ‰¾ä¸åˆ° mobile-user-combo å…ƒç´ ');
        return;
      }

      try {
        const initialData = await callPythonAPI('get_initial_data');

        
        mobileUserCombo.innerHTML = '<option value="">(æ–°ç”¨æˆ·)</option>';

        if (initialData.users && initialData.users.length > 0) {
          initialData.users.forEach(user => {
            const option = document.createElement('option');
            option.value = option.textContent = user;
            mobileUserCombo.appendChild(option);
          });
        }

        
        if (initialData.lastUser) {
          mobileUserCombo.value = initialData.lastUser;
          
          await onMobileUserChange();
        }

        console.log('[Mobile] ç”¨æˆ·ä¸‹æ‹‰æ¡†å·²åŠ è½½');
      } catch (error) {
        console.error('[Mobile] åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
      }

    }

    
    
    async function onMobileUserChange() {
      const mobileUserCombo = document.getElementById('mobile-user-combo');
      const mobileUsernameEntry = document.getElementById('mobile-username-entry');
      const mobilePasswordEntry = document.getElementById('mobile-password-entry');

      if (!mobileUserCombo) return;

      const username = mobileUserCombo.value;

      
      if (mobileUsernameEntry) {
        mobileUsernameEntry.value = username;
      }

      
      if (mobilePasswordEntry) {
        mobilePasswordEntry.value = '';
      }

      if (username) {
        try {
          const data = await callPythonAPI('on_user_selected', username);
          if (data) {
            
            if (data.password && mobilePasswordEntry) {
              mobilePasswordEntry.value = data.password;
            }
            
            if (data.ua) {
              syncUAToMobile(data.ua);
            } else {
              syncUAToMobile('(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)');
            }
          }
        } catch (error) {
          console.error('[Mobile] è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        }
      } else {
        
        syncUAToMobile('(æœªåŠ è½½)');
      }
    }

    

    
    function toggleMobileSidebar() {
      
      const backdrop = document.getElementById('mobile-sidebar-backdrop');
      
      const sidebarSingle = document.getElementById('mobile-sidebar-single-account');
      
      const sidebarMulti = document.getElementById('mobile-sidebar-multi-account');

      
      
      const multiAccountApp = document.getElementById('mobile-multi-account-app');
      const isMultiMode = multiAccountApp && !multiAccountApp.classList.contains('hidden');

      
      const activeSidebar = isMultiMode ? sidebarMulti : sidebarSingle;

      
      if (activeSidebar && activeSidebar.classList.contains('show')) {
        
        closeMobileSidebar();
      } else {
        
        
        if (sidebarSingle) {
          sidebarSingle.classList.remove('show');
          sidebarSingle.classList.add('hidden');
        }
        if (sidebarMulti) {
          sidebarMulti.classList.remove('show');
          sidebarMulti.classList.add('hidden');
        }

        
        if (backdrop) {
          backdrop.classList.add('show');
        }

        
        if (activeSidebar) {
          activeSidebar.classList.remove('hidden'); 
          
          
          setTimeout(() => {
            activeSidebar.classList.add('show'); 
          }, 10); 
        }
      }
    }

    
    function closeMobileSidebar() {
      
      const backdrop = document.getElementById('mobile-sidebar-backdrop');
      
      const sidebarSingle = document.getElementById('mobile-sidebar-single-account');
      
      const sidebarMulti = document.getElementById('mobile-sidebar-multi-account');

      
      if (backdrop) {
        backdrop.classList.remove('show'); 
      }

      
      if (sidebarSingle) {
        sidebarSingle.classList.remove('show'); 
        
        setTimeout(() => {
          sidebarSingle.classList.add('hidden'); 
        }, 300); 
      }

      
      if (sidebarMulti) {
        sidebarMulti.classList.remove('show'); 
        
        setTimeout(() => {
          sidebarMulti.classList.add('hidden'); 
        }, 300); 
      }
    }

    
    function updateMobileNavVisibility(show, mode = 'single') {
      

      
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      
      const mobileHeader = document.getElementById('mobile-header');
      
      const sidebarSingle = document.getElementById('mobile-sidebar-single-account');
      
      const sidebarMulti = document.getElementById('mobile-sidebar-multi-account');

      if (show) {
        

        
        if (mobileMenuBtn) {
          mobileMenuBtn.style.display = ''; 
        }

        
        if (mobileHeader) {
          mobileHeader.classList.remove('hidden');
          mobileHeader.style.display = '';
        }

        
        
        if (mode === 'single' && sidebarSingle) {
          sidebarSingle.classList.remove('hidden'); 
          
        }
        if (mode === 'multi' && sidebarMulti) {
          sidebarMulti.classList.remove('hidden'); 
          
        }

      } else {
        

        
        if (mobileMenuBtn) {
          mobileMenuBtn.style.display = 'none'; 
        }

        
        if (sidebarSingle) {
          sidebarSingle.classList.add('hidden'); 
          sidebarSingle.classList.remove('show'); 
        }
        if (sidebarMulti) {
          sidebarMulti.classList.add('hidden'); 
          sidebarMulti.classList.remove('show'); 
        }

        
        
      }

      
      
      const mobileBottomNavSingle = document.getElementById('mobile-bottom-nav-single-account');
      const mobileBottomNavMulti = document.getElementById('mobile-bottom-nav-multi-account');

      if (show) {
        
        if (mode === 'single' && mobileBottomNavSingle) {
          mobileBottomNavSingle.classList.remove('hidden');
          mobileBottomNavSingle.style.display = '';
        }
        if (mode === 'multi' && mobileBottomNavMulti) {
          mobileBottomNavMulti.classList.remove('hidden');
          mobileBottomNavMulti.style.display = '';
        }
      } else {
        
        if (mobileBottomNavSingle) {
          mobileBottomNavSingle.classList.add('hidden');
          mobileBottomNavSingle.style.display = 'none';
        }
        if (mobileBottomNavMulti) {
          mobileBottomNavMulti.classList.add('hidden');
          mobileBottomNavMulti.style.display = 'none';
        }
      }
    }

    
    function showMobileMessage(message, type = 'info') {
      
      const errorDiv = document.getElementById('mobile-auth-error');
      
      const successDiv = document.getElementById('mobile-auth-success');

      
      if (type === 'clear') {
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        return;
      }

      
      if (errorDiv) errorDiv.classList.add('hidden');
      if (successDiv) successDiv.classList.add('hidden');

      
      if (type === 'error') {
        if (errorDiv) {
          errorDiv.textContent = message; 
          errorDiv.classList.remove('hidden'); 
        }
      } else if (type === 'success') {
        if (successDiv) {
          successDiv.textContent = message; 
          successDiv.classList.remove('hidden'); 
        }
      } else {
        
        
        showModalAlert(message, 'æç¤º');
      }

      
    }
    
    



    
    
    

    
    document.addEventListener('DOMContentLoaded', function () {
      console.log('[é¡µé¢åŠ è½½] DOMå†…å®¹å·²åŠ è½½ï¼Œå¼€å§‹æ‰§è¡Œè®¾å¤‡æ£€æµ‹å’ŒUIåˆ‡æ¢');

      
      switchUIContainer();

      console.log('[é¡µé¢åŠ è½½] ç§»åŠ¨ç«¯æ£€æµ‹å’ŒUIåˆ‡æ¢å®Œæˆï¼ˆåŸºäºUser-Agentï¼Œä¸ç›‘å¬çª—å£å˜åŒ–ï¼‰');
    });

    
    
    


    function handleCdnError(resourceName = 'æœªæŒ‡å®š') { 
      cdnErrorCount++;
      
      logMessage_Warning(`CDNèµ„æº[${resourceName}]åŠ è½½å¤±è´¥ (${cdnErrorCount}/3)ï¼Œç­‰å¾…åº”ç”¨åˆå§‹åŒ–...`);

      
      
      if (cdnErrorTimer) {
        clearTimeout(cdnErrorTimer);
      }

      cdnErrorTimer = setTimeout(() => {
        
        if (!appInitialized && cdnErrorCount > 0) {
          const errorOverlay = document.getElementById('cdn-error-overlay');
          if (errorOverlay) {
            
            
            try {
              errorOverlay.style.setProperty('display', 'flex', 'important');
            } catch (e) {
              
              errorOverlay.style.display = 'flex';
            }
            
            errorOverlay.classList.remove('hidden');
            logMessage_Error(`åº”ç”¨åˆå§‹åŒ–è¶…æ—¶ï¼ŒCDNèµ„æºåŠ è½½å¤±è´¥ (${cdnErrorCount}ä¸ªèµ„æº)`);
          }
        }
      }, 3000); 
    }


    function showModalAlert(message, title = 'æç¤º', onCloseCallback = null) {
      const modal = $('alert-modal');
      const titleEl = $('alert-modal-title');
      const msgEl = $('alert-modal-message');
      const closeBtn = $('alert-modal-close-btn');

      if (!modal || !titleEl || !msgEl || !closeBtn) {
        
        logMessage_Warning('Alert modal DOM not found, falling back to native alert.');
        alert(`${title}:\n${message}`);
        
        if (onCloseCallback && typeof onCloseCallback === 'function') onCloseCallback();
        return;
      }

      titleEl.textContent = title;
      
      msgEl.innerHTML = String(message).replace(/\n/g, '<br>');

      
      if (title.includes('å¤±è´¥') || title.includes('é”™è¯¯')) {
        titleEl.classList.remove('text-sky-600');
        titleEl.classList.add('text-red-600');
      } else {
        titleEl.classList.remove('text-red-600');
        titleEl.classList.add('text-sky-600');
      }

      closeBtn.onclick = () => {
        closeModalAlert();
        
        if (onCloseCallback && typeof onCloseCallback === 'function') onCloseCallback();
      };

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-visible'); 
    }

    function closeModalAlert() {
      const modal = $('alert-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      
      const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
      let stillVisible = false;
      otherModals.forEach(m => {
        if (m.id !== 'alert-modal' && !m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
          stillVisible = true;
        }
      });
      if (!stillVisible) {
        document.body.classList.remove('modal-visible');
      }
    }

    function showModal(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('modal-visible');
      }
    }

    function hideModal(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      
      const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
      let stillVisible = false;
      otherModals.forEach(m => {
        if (!m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
          stillVisible = true;
        }
      });
      if (!stillVisible) {
        document.body.classList.remove('modal-visible');
      }
    }

    
    let resolveConfirmPromise = null;

    function jsShowConfirm(title, message) {
      
      return new Promise((resolve) => {
        const modal = $('confirm-modal');
        const titleEl = $('confirm-modal-title');
        const msgEl = $('confirm-modal-message');
        const okBtn = $('confirm-modal-ok-btn');
        const cancelBtn = $('confirm-modal-cancel-btn');

        if (!modal || !titleEl || !msgEl || !okBtn || !cancelBtn) {
          logMessage_Error('Confirm modal DOM not found. Falling back to native confirm.');
          
          resolve(confirm(`${title}:\n${message}`));
          return;
        }

        
        resolveConfirmPromise = resolve;

        titleEl.textContent = title || 'è¯·ç¡®è®¤';
        msgEl.innerHTML = String(message).replace(/\n/g, '<br>');

        
        okBtn.onclick = null;
        cancelBtn.onclick = null;

        
        okBtn.onclick = () => handleConfirm(true);
        cancelBtn.onclick = () => handleConfirm(false);

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('modal-visible');
      });
    }

    function handleConfirm(result) {
      const modal = $('confirm-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      
      const otherModals = document.querySelectorAll('.modal, [id$="-modal"]');
      let stillVisible = false;
      otherModals.forEach(m => {
        if (m.id !== 'confirm-modal' && !m.classList.contains('hidden') && (m.classList.contains('flex') || m.style.display === 'flex')) {
          stillVisible = true;
        }
      });
      if (!stillVisible) {
        document.body.classList.remove('modal-visible');
      }

      
      if (resolveConfirmPromise) {
        resolveConfirmPromise(result);
        resolveConfirmPromise = null; 
      }
    }




    let AMAP_API_KEY = ""; 
    let isRefreshingNotifications = false; 

    let isRefreshingTasks = false;


    
    let IS_OFFLINE = false;
    let sessionUUID = null;  

    function getUUIDFromURL() {
      const urlPath = window.location.pathname;

      
      
      
      
      
      
      
      
      const match = urlPath.match(/\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i);

      if (match && match[1]) {
        
        
        return match[1];
      } else {
        
        return null;
      }
    }

    
    async function callPythonAPI(method, ...args) {
      
      if (isInNetworkErrorState) {
        logMessage_Warning(`[APIè°ƒç”¨] âœ— å·²è·³è¿‡ (${method}): ç½‘ç»œé”™è¯¯çŠ¶æ€å·²æ¿€æ´»`);
        
        throw new Error('ç½‘ç»œè¿æ¥å·²æ–­å¼€ã€‚');
      }

      logMessage_Info(`[APIè°ƒç”¨] æ–¹æ³•: ${method}, å‚æ•°æ•°é‡: ${args.length}`);
      
      const headers = {
        'Content-Type': 'application/json',
      };

      
      if (sessionUUID) {
        headers['X-Session-ID'] = sessionUUID;
        logMessage_Info(`[APIè°ƒç”¨] ä¼šè¯ID: ${sessionUUID}`);
      } else {
        
        logMessage_Warning(`[APIè°ƒç”¨] è­¦å‘Š: sessionUUIDä¸ºç©ºï¼Œå¯èƒ½å¯¼è‡´ä¼šè¯æ— æ•ˆé”™è¯¯ï¼Œå°è¯•ä»URLæå–...`);
        sessionUUID = getUUIDFromURL();
        if (sessionUUID || sessionUUID !== null || sessionUUID !== undefined || sessionUUID !== 'null') {
          logMessage_Info(`[APIè°ƒç”¨] ä»URLæå–åˆ°ä¼šè¯ID: ${sessionUUID}`);
          headers['X-Session-ID'] = sessionUUID;
        } else {
          logMessage_Warning(`[APIè°ƒç”¨] æ— æ³•ä»URLæå–ä¼šè¯ID`);
        }
      }

      logMessage_Info(`[APIè°ƒç”¨] å‘é€è¯·æ±‚åˆ° /api/${method}`);
      let response; 
      try { 
        response = await fetch(`/api/${method}`, {
          method: 'POST',
          headers: headers,
          credentials: 'include',  
          body: JSON.stringify(args.length === 1 && typeof args[0] === 'object' && args[0] !== null && !Array.isArray(args[0]) ? args[0] : args)
        });
      } catch (networkError) {
        
        logMessage_Error(`[APIè°ƒç”¨] âœ— ç½‘ç»œè¯·æ±‚å¤±è´¥ (${method}):`, networkError);

        
        if (!isInNetworkErrorState) {
          isInNetworkErrorState = true; 
          logMessage_Info('[APIè°ƒç”¨] è¿›å…¥ç½‘ç»œé”™è¯¯çŠ¶æ€ï¼Œåœæ­¢åç«¯æ—¥å¿—å‘é€å’ŒWebSocket');

          
          if (refreshUserListInterval) {
            logMessage_Info('[APIè°ƒç”¨] åœæ­¢ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨ (å› ç½‘ç»œé”™è¯¯)');
            clearInterval(refreshUserListInterval);
            refreshUserListInterval = null;
          }

          
          if (socket) {
            if (socket.io) {
              socket.io.opts.reconnection = false;  
            }
            if (socket.connected) {
              socket.disconnect();
            }
            logMessage_Info('[APIè°ƒç”¨] å·²æ–­å¼€WebSocketè¿æ¥å¹¶ç¦ç”¨è‡ªåŠ¨é‡è¿ (å› ç½‘ç»œé”™è¯¯)');
          }
        }

        
        showModalAlert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚', 'ç½‘ç»œé”™è¯¯', () => {
          
          if (isInNetworkErrorState) {
            logMessage_Info('[APIè°ƒç”¨] ç”¨æˆ·å…³é—­ç½‘ç»œé”™è¯¯å¼¹çª—ï¼Œå‡†å¤‡æ¢å¤è¿æ¥');
            isInNetworkErrorState = false;

            
            setTimeout(() => {
              
              if (!refreshUserListInterval) {
                refreshUserListInterval = setInterval(refreshUserList, 5000);
                logMessage_Info('[APIè°ƒç”¨] ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨å·²æ¢å¤');
              }

              
              if (socket && !socket.connected && sessionUUID) {
                
                if (socket.io) {
                  socket.io.opts.reconnection = true;
                }
                socket.connect();
                logMessage_Info('[APIè°ƒç”¨] æ­£åœ¨é‡æ–°è¿æ¥WebSocketï¼ˆå·²é‡æ–°å¯ç”¨è‡ªåŠ¨é‡è¿ï¼‰');
              }
            }, 1000);
          }
        });

        throw networkError; 
      }

      
      if (!response.ok) {
        logMessage_Info(`[APIè°ƒç”¨] âœ— å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
        let errorData = null;
        try {
          errorData = await response.json(); 
        } catch (parseError) {
          logMessage_Warning('[APIè°ƒç”¨] âœ— æ— æ³•è§£æé”™è¯¯å“åº”ä½“ä¸º JSON:', parseError);
          
        }

        
        
        if (response.status === 401 && errorData && errorData.message && errorData.message.includes('ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆ')) {
          logMessage_Error('[APIè°ƒç”¨] âœ— ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼');
          logMessage_Info('[ç³»ç»Ÿ] æ‚¨çš„ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚'); 

          
          if (refreshUserListInterval) {
            logMessage_Info('[APIè°ƒç”¨] åœæ­¢ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨ (å› ä¼šè¯è¿‡æœŸ)');
            clearInterval(refreshUserListInterval);
            refreshUserListInterval = null; 
          }

          
          if (isMobileMode) {
            
            showMobileMessage('æ‚¨çš„ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'error');

            
            const mobileMainApp = document.getElementById('mobile-main-app');
            const mobileMultiApp = document.getElementById('mobile-multi-account-app');
            const mobileLoginContainer = document.getElementById('mobile-login-container');

            if (mobileMainApp) mobileMainApp.classList.add('hidden');
            if (mobileMultiApp) mobileMultiApp.classList.add('hidden');
            if (mobileLoginContainer) mobileLoginContainer.classList.remove('hidden');

            logMessage_Info('[ç§»åŠ¨ç«¯] å·²åˆ‡æ¢åˆ°ç™»å½•é¡µé¢');
          } else {
            
            showModalAlert('æ‚¨çš„ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚', 'ä¼šè¯å¤±æ•ˆ');

            
            setTimeout(() => {
              window.location.href = '/'; 
            }, 2500); 
          }

          
          throw new Error('ä¼šè¯å·²è¿‡æœŸæˆ–æ— æ•ˆ');
        }
        

        
        if (errorData && errorData.need_login) {
          let errorMsg = errorData.message || 'APIè°ƒç”¨å¤±è´¥';
          logMessage_Info(`[APIè°ƒç”¨] âœ— éœ€è¦é‡æ–°ç™»å½•: ${errorMsg}`);

          
          if (errorData.logged_out_elsewhere) {

            logMessage_Info('[å®‰å…¨æç¤º] æ£€æµ‹åˆ°è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå·²è‡ªåŠ¨ç™»å‡º');
            logMessage_Info('[APIè°ƒç”¨] âœ— å¤šè®¾å¤‡ç™»å½•æ£€æµ‹');

            
            const logoutOverlay = document.createElement('div');
            logoutOverlay.id = 'logout-elsewhere-overlay';
            logoutOverlay.style.cssText = `
                          position: fixed;
                          top: 0;
                          left: 0;
                          width: 100%;
                          height: 100%;
                          background: rgba(0, 0, 0, 0.85);
                          z-index: 9999;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        `;

            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                          padding: 40px;
                          border-radius: 20px;
                          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                          max-width: 500px;
                          width: 90%;
                          text-align: center;
                          color: white;
                        `;

            
            const icon = document.createElement('div');
            icon.innerHTML = `
                          <svg style="width: 80px; height: 80px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                          </svg>
                        `;

            
            const title = document.createElement('h2');
            title.textContent = 'å¤šè®¾å¤‡ç™»å½•æ£€æµ‹';
            title.style.cssText = `
                          font-size: 24px;
                          font-weight: bold;
                          margin: 0 0 20px 0;
                        `;

            
            const text = document.createElement('p');
            text.textContent = 'æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œæœ¬è®¾å¤‡å·²è‡ªåŠ¨ç™»å‡ºã€‚2åˆ†é’Ÿåå°†è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚';
            text.style.cssText = `
                          font-size: 16px;
                          line-height: 1.6;
                          margin: 0 0 30px 0;
                          opacity: 0.95;
                        `;

            
            const countdown = document.createElement('div');
            countdown.style.cssText = `
                          font-size: 32px;
                          font-weight: bold;
                          margin: 0 0 30px 0;
                        `;

            
            const button = document.createElement('button');
            button.textContent = 'ç«‹å³è¿”å›ç™»å½•';
            button.style.cssText = `
                          background: white;
                          color: #667eea;
                          border: none;
                          padding: 12px 30px;
                          border-radius: 25px;
                          font-size: 16px;
                          font-weight: bold;
                          cursor: pointer;
                          transition: all 0.3s;
                        `;
            button.onmouseover = () => {
              button.style.transform = 'scale(1.05)';
              button.style.boxShadow = '0 5px 15px rgba(255, 255, 255, 0.3)';
            };
            button.onmouseout = () => {
              button.style.transform = 'scale(1)';
              button.style.boxShadow = 'none';
            };

            
            modalContent.appendChild(icon);
            modalContent.appendChild(title);
            modalContent.appendChild(text);
            modalContent.appendChild(countdown);
            modalContent.appendChild(button);
            logoutOverlay.appendChild(modalContent);
            document.body.appendChild(logoutOverlay);

            
            let remainingSeconds = 120;
            const updateCountdown = () => {
              const minutes = Math.floor(remainingSeconds / 60);
              const seconds = remainingSeconds % 60;
              countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            };
            updateCountdown();

            
            const countdownInterval = setInterval(() => {
              remainingSeconds--;
              updateCountdown();

              if (remainingSeconds <= 0) {
                clearInterval(countdownInterval);
                window.location.href = '/';
              }
            }, 1000);

            
            button.onclick = () => {
              clearInterval(countdownInterval);
              window.location.href = '/';
            };

            
            
            const userActivityEvents = ['mousedown', 'keydown', 'touchstart'];
            const resetCountdown = () => {
              
              remainingSeconds = 120;
              updateCountdown();
              logMessage_Info('[å®‰å…¨æç¤º] æ£€æµ‹åˆ°ç”¨æˆ·æ´»åŠ¨ï¼Œå€’è®¡æ—¶å·²é‡ç½®');
            };

            userActivityEvents.forEach(eventType => {
              document.addEventListener(eventType, resetCountdown, { once: false });
            });

            
            const cleanupListeners = () => {
              userActivityEvents.forEach(eventType => {
                document.removeEventListener(eventType, resetCountdown);
              });
            };

            
            button.onclick = () => {
              clearInterval(countdownInterval);
              cleanupListeners();
              window.location.href = '/';
            };

          } else {
            
            logMessage_Info(`[å®‰å…¨æç¤º] ${errorMsg}`);

            
            if (isMobileMode) {
              
              showMobileMessage(errorMsg || 'éœ€è¦é‡æ–°ç™»å½•', 'error');

              
              const mobileMainApp = document.getElementById('mobile-main-app');
              const mobileMultiApp = document.getElementById('mobile-multi-account-app');
              const mobileLoginContainer = document.getElementById('mobile-login-container');

              if (mobileMainApp) mobileMainApp.classList.add('hidden');
              if (mobileMultiApp) mobileMultiApp.classList.add('hidden');
              if (mobileLoginContainer) mobileLoginContainer.classList.remove('hidden');

              logMessage_Info('[ç§»åŠ¨ç«¯] å·²åˆ‡æ¢åˆ°ç™»å½•é¡µé¢ï¼ˆå› need_loginï¼‰');
            } else {
              
              Swal.fire({
                icon: 'warning',
                title: 'éœ€è¦é‡æ–°ç™»å½•',
                text: errorMsg,
                confirmButtonText: 'è¿”å›ç™»å½•',
                allowOutsideClick: false
              }).then(() => {
                window.location.href = '/';
              });
            }
          }

          
          if (refreshUserListInterval) {
            logMessage_Info('[APIè°ƒç”¨] åœæ­¢ç”¨æˆ·åˆ—è¡¨åˆ·æ–°å®šæ—¶å™¨ (å› éœ€é‡æ–°ç™»å½•)');
            clearInterval(refreshUserListInterval);
            refreshUserListInterval = null;
          }



          throw new Error(errorMsg);
        }

        
        if (response.status === 403 && errorData && errorData.message) {
          logMessage_Error(`[APIè°ƒç”¨] âœ— æƒé™ä¸è¶³ (${method}): ${errorData.message}`);
          showModalAlert(`æ“ä½œå¤±è´¥: ${errorData.message}`, 'æƒé™ä¸è¶³');
          throw new Error(`æƒé™ä¸è¶³: ${errorData.message}`);
        }

        
        const genericErrorMessage = (errorData && errorData.message) ? errorData.message : response.statusText;
        logMessage_Error(`[APIè°ƒç”¨] âœ— æœªå¤„ç†çš„é”™è¯¯ (${method}): ${genericErrorMessage}`);
        
        
        throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${genericErrorMessage}`);
      }

      
      logMessage_Info(`[APIè°ƒç”¨] âœ“ è¯·æ±‚æˆåŠŸ (${method})`);
      const result = await response.json();
      logMessage_Info(`[APIè°ƒç”¨] âœ“ è¿”å›ç»“æœ (${method}):`, result.success ? 'æˆåŠŸ' : 'å¤±è´¥');
      return result;
    }

    
    async function callPythonAPI_raw(path, method = 'POST', data = null) {
      const headers = {
        'Content-Type': 'application/json',
      };

      
      if (sessionUUID) {
        headers['X-Session-ID'] = sessionUUID;
      }

      const options = {
        method: method,
        headers: headers,
        credentials: 'include',
      };

      if (data && method !== 'GET') {
        options.body = JSON.stringify(data);
      }

      try {
        const response = await fetch(path, options);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      } catch (error) {
        logMessage_Error(`APIè°ƒç”¨å¤±è´¥ (${path}):`, error);
        throw error;
      }
    }

    
    async function executeServerJS(script, ...args) {
      
      const headers = {
        'Content-Type': 'application/json',
      };

      
      if (sessionUUID) {
        headers['X-Session-ID'] = sessionUUID;
      }

      const response = await fetch('/execute_js', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          script: script,
          args: args
        })
      });

      if (!response.ok) {
        throw new Error(`æœåŠ¡å™¨ç«¯JSæ‰§è¡Œå¤±è´¥: ${response.statusText}`);
      }

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.message || 'JSæ‰§è¡Œå¤±è´¥');
      }

      return data.result;
    }

    
    let singleProcessedPoints = 0;       
    let singleTotalPoints = 0;           


    
    let AMapInstance, map;
    let amapLoadingPromise = null;   
    let AMapReady = false;           

    let currentTasks = [];
    let selectedTaskIndex = -1;
    let currentUserData = {};
    let currentRunData = {};
    let polylines = { recommended: [], draft: null, run: null, history: null };
    let markers = [];
    let runnerMarker = null;
    let drawingInfoMarker = null;
    let tempAttendanceMarker = null;
    let tempAttendanceCircle = null;
    let isDrawing = false;
    let isPathDrawing = false;
    let leftMouseDown = false;
    const $ = (id) => document.getElementById(id);

    let multiAccountMap;
    let multiAccountMarkers = {}; 
    const userColors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
    let colorIndex = 0;
    let path_planning_queue = [];
    let is_planning_path = false;

    let currentSessionUA = ""

    let pendingMultiPositions = []; 

    
    let mapReadyPromise = null;
    let resolveMapReady = null;

    
    const paramDefs = {
      
      "interval_ms": {
        label: "é‡‡æ ·é—´éš”",
        unit: "ms",
        help: "ç›¸é‚» GPS ç‚¹ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œç”¨äºæ¨¡æ‹Ÿä¸ŠæŠ¥èŠ‚å¥ã€‚"
      },
      "interval_random_ms": {
        label: "é—´éš”éšæœºèŒƒå›´",
        unit: "ms",
        help: "åœ¨é‡‡æ ·é—´éš”çš„åŸºç¡€ä¸Šä¸Šä¸‹æµ®åŠ¨çš„éšæœºæŠ–åŠ¨å¹…åº¦ã€‚"
      },
      "speed_mps": {
        label: "å¹³å‡é€Ÿåº¦",
        unit: "m/s",
        help: "ç”Ÿæˆ/å¤„ç†è·¯å¾„æ—¶çš„ç›®æ ‡å¹³å‡é€Ÿåº¦ã€‚"
      },
      "speed_random_mps": {
        label: "é€Ÿåº¦éšæœºèŒƒå›´",
        unit: "m/s",
        help: "é€Ÿåº¦çš„ä¸Šä¸‹æµ®åŠ¨èŒƒå›´ï¼Œç”¨äºæ¨¡æ‹Ÿè‡ªç„¶æ³¢åŠ¨ã€‚"
      },
      "location_random_m": {
        label: "å®šä½éšæœºåç§»åŠå¾„",

        unit: "m",
        help: "å¯¹æ¯ä¸ª GPS ç‚¹æ–½åŠ çš„éšæœºåç§»çš„åŠå¾„ï¼Œæ¨¡æ‹Ÿå®šä½å™ªå£°ã€‚"
      },

      
      "task_gap_min_s": {
        label: "ä»»åŠ¡é—´éš™ä¸‹é™",
        unit: "s",
        help: "è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„æœ€çŸ­ç­‰å¾…æ—¶é—´ã€‚"
      },
      "task_gap_max_s": {
        label: "ä»»åŠ¡é—´éš™ä¸Šé™",
        unit: "s",
        help: "è¿ç»­æ‰§è¡Œä»»åŠ¡ä¹‹é—´çš„æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚"
      },

      
      "api_fallback_line": {
        label: "è§„åˆ’å¤±è´¥æ—¶ä½¿ç”¨ç›´çº¿è¿æ¥",
        unit: "",
        help: "å¯ç”¨åï¼Œå½“æŸæ®µæ­¥è¡Œè·¯å¾„è§„åˆ’å¤±è´¥æ—¶ï¼Œä½¿ç”¨èµ·ç»ˆç‚¹ç›´çº¿ä»£æ›¿ã€‚"
      },
      "api_retries": {
        label: "APIé‡è¯•æ¬¡æ•°",
        unit: "æ¬¡",
        help: "æ­¥è¡Œè·¯å¾„æ¯ä¸€æ®µå¤±è´¥åçš„é‡è¯•æ¬¡æ•°ã€‚"
      },

      "api_retry_delay_s": {
        label: "APIé‡è¯•é—´éš”",
        unit: "s",
        help: "æ­¥è¡Œè·¯å¾„å¤±è´¥åå‘èµ·ä¸‹ä¸€æ¬¡é‡è¯•å‰çš„ç­‰å¾…æ—¶é—´ã€‚"
      },
      "ignore_task_time": {
        label: "å¿½ç•¥ä»»åŠ¡æ—¶é—´ä»…å¯¹æ¯”æ—¥æœŸ",
        unit: "",
        help: "å‹¾é€‰åï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦â€œæœªå¼€å§‹â€æˆ–â€œå·²è¿‡æœŸâ€æ—¶ï¼Œåªå¯¹æ¯”å¹´æœˆæ—¥ï¼Œå¿½ç•¥å…·ä½“æ—¶åˆ†ç§’ã€‚"
      },

      
      "min_time_m": {
        label: "ç›®æ ‡æ—¶é•¿ä¸‹é™",
        unit: "åˆ†é’Ÿ",
        help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»æ—¶é•¿æœ€å°å€¼ã€‚"
      },
      "max_time_m": {
        label: "ç›®æ ‡æ—¶é•¿ä¸Šé™",
        unit: "åˆ†é’Ÿ",
        help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»æ—¶é•¿æœ€å¤§å€¼ã€‚"
      },
      "min_dist_m": {
        label: "ç›®æ ‡è·ç¦»ä¸‹é™",
        unit: "m",
        help: "è‡ªåŠ¨ç”Ÿæˆè·¯å¾„çš„æ€»è·ç¦»ä¸‹é™ã€‚ä¸Šé™æŒ‰ 1.0â€“1.15 å€éšæœºæµ®åŠ¨ã€‚"
      },

      
      "theme_style": {
        label: "ç•Œé¢ä¸»é¢˜é£æ ¼",
        unit: "",
        help: "åˆ‡æ¢åº”ç”¨ç•Œé¢çš„å¤–è§‚ã€‚ä¸»é¢˜åˆ‡æ¢åå°†è‡ªåŠ¨ä¿å­˜ã€‚",
        type: "theme_selector" 
      },
      "theme_base_color": {
        label: "ä¸»é¢˜åŸºç¡€é¢œè‰²",
        unit: "",
        help: "ç•Œé¢ä¸»è‰²è°ƒï¼ˆç‚¹å‡»é¢œè‰²å—è¿›è¡Œé€‰æ‹©ï¼‰ã€‚",
        type: "color_picker" 
      },
      "auto_attendance_enabled": {
        label: "å¼€å¯è‡ªåŠ¨ç­¾åˆ°",
        unit: "",
        help: "å¼€å¯åï¼Œå°†åœ¨åå°è‡ªåŠ¨åˆ·æ–°é€šçŸ¥å¹¶å°è¯•ç­¾åˆ°",
        type: "checkbox"
      },
      "auto_attendance_refresh_s": {
        label: "åˆ·æ–°é—´éš”",
        unit: "ç§’",
        help: "è‡ªåŠ¨åˆ·æ–°é€šçŸ¥çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå»ºè®®ä¸ä½äº60"
      },
      "attendance_user_radius_m": {
        label: "éšæœºåŠå¾„",
        unit: "ç±³",
        help: "è‡ªåŠ¨ç­¾åˆ°æ—¶ï¼Œåœ¨æœåŠ¡å™¨å…è®¸èŒƒå›´å†…çš„æœ€å¤§éšæœºåç§»åŠå¾„ã€‚è®¾ä¸º0ä¸ºç²¾ç¡®ç­¾åˆ°ã€‚"
      }
    };

    
    
    const paramGroups = [
      {
        title: "é‡‡æ ·ä¸é€Ÿåº¦",
        keys: ["interval_ms", "interval_random_ms", "speed_mps", "speed_random_mps", "location_random_m"]
      },
      {
        title: "ä»»åŠ¡é—´éš”",
        keys: ["task_gap_min_s", "task_gap_max_s", "ignore_task_time"]
      },
      {
        title: "è·¯å¾„è§„åˆ’é‡è¯•ç­–ç•¥",
        keys: ["api_fallback_line", "api_retries", "api_retry_delay_s"]
      },
      {
        title: "è‡ªåŠ¨ç”Ÿæˆç›®æ ‡",
        keys: ["min_time_m", "max_time_m", "min_dist_m"]
      },
      
      {
        title: "è‡ªåŠ¨ç­¾åˆ°",
        keys: ["auto_attendance_enabled", "auto_attendance_refresh_s", "attendance_user_radius_m"]
      }
    ];

    let pythonParams = {};

    
    
    
    let cachedMultiAccounts = [];

    let runAccumulatedMs = 0;
    let draftTotalDist = 0;


    
    function destroySingleMap() {
      try {
        
        if (window.mapCleanup) {
          window.mapCleanup();
          window.mapCleanup = null;
        }
        if (map && typeof map.destroy === 'function') {
          map.destroy();
        }
      } catch (e) {
        logMessage_Warning('destroySingleMap warning:', e);
      } finally {
        map = null;
        polylines.recommended = [];
        polylines.draft = null;
        polylines.run = null;
        polylines.history = null;
        markers = [];
        runnerMarker = null;
        drawingInfoMarker = null;

        try { const container = document.getElementById('map-container'); if (container) container.classList.remove('drawing'); } catch (_) { }
        isDrawing = false; isPathDrawing = false; leftMouseDown = false; pendingUnlockMap = false;
        draftPath = []; draftPathLngLat = []; pendingPoints = []; isUpdating = false; lastMouseMoveTime = 0;
        try { document.body.classList.remove('modal-visible'); } catch (_) { }
      }
    }





    function updateMultiGlobalButtons(startDisabled, stopDisabled) {
      const startBtn = document.getElementById('multi-start-all-btn');
      const stopBtn = document.getElementById('multi-stop-all-btn');
      if (!startBtn || !stopBtn) return;
      
      startBtn.disabled = !!startDisabled;
      stopBtn.disabled = !!stopDisabled;
    }


    
    function safeResizeAndFitView() {
      try {
        map.resize();
        requestAnimationFrame(() => {
          resetMapView();
          
          if (markers.length > 0) {
            map.setFitView(markers, false, [50, 50, 50, 50]);
          }
        });
      } catch (e) {
        logMessage_Warning('safeResizeAndFitView error:', e);
      }
    }





    
    
    function setThemeStyle(styleName) {
      
      document.body.classList.remove('theme-anime', 'theme-minimalist');

      
      if (styleName !== 'default') {
        document.body.classList.add(styleName);
      }

      
      const themeButtons = document.querySelectorAll('#admin-profile-panel_modal button[onclick^="setThemeStyle"]');
      themeButtons.forEach(btn => {
        const onclickValue = btn.getAttribute('onclick');
        if (onclickValue && onclickValue.includes(`'${styleName}'`)) {
          btn.classList.add('border-2', 'border-sky-500'); 
        } else {
          btn.classList.remove('border-2', 'border-sky-500');
        }
      });

      
      callPythonAPI('update_param', 'theme_style', styleName);
      logMessage_Info(`ä¸»é¢˜æ ·å¼å·²åˆ‡æ¢ä¸º: ${styleName}`);
    }

    
    
    function applyAndSaveTheme(theme) {
      
      if (theme === 'dark') {
        
        document.body.classList.add('dark-mode');
        logMessage_Info('[ä¸»é¢˜] å·²åº”ç”¨æ·±è‰²æ¨¡å¼');
      } else {
        
        document.body.classList.remove('dark-mode');
        logMessage_Info('[ä¸»é¢˜] å·²åº”ç”¨æµ…è‰²æ¨¡å¼');
      }

      
      
      
      try {
        fetch('/auth/user/update_theme', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ theme: theme })
        }).then(response => response.json())
          .then(result => {
            if (result.success) {
              logMessage_Info(`[ä¸»é¢˜] ä¸»é¢˜è®¾ç½®å·²ä¿å­˜: ${theme}`);
            } else {
              logMessage_Warning(`[ä¸»é¢˜] ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥: ${result.message}`);
            }
          });
      } catch (e) {
        logMessage_Error('[ä¸»é¢˜] ä¿å­˜ä¸»é¢˜è®¾ç½®æ—¶å‡ºé”™:', e);
      }
    }


    
    function resetBaseColorToDefault(prefix) {
      const defaultColor = '#7dd3fc';
      const key = 'theme_base_color';

      
      const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
      const textInput = document.getElementById(`${prefix}-${key}`);
      if (colorPicker) colorPicker.value = defaultColor;
      if (textInput) textInput.value = defaultColor;

      
      
      setBaseColor(defaultColor, defaultColor);

      
      if (pythonParams) {
        pythonParams[key] = defaultColor;
      }

      logMessage_Info("ä¸»é¢˜é¢œè‰²å·²æ¢å¤ä¸ºé»˜è®¤ã€‚");
    }

    
    function setBaseColor(c, deep) {
      document.documentElement.style.setProperty('--base-color', c);
      document.documentElement.style.setProperty('--base-color-600', deep);
      document.documentElement.style.setProperty('--base-color-300', c);
      callPythonAPI('update_param', 'theme_base_color', c);
      if ($('base-color-input')) $('base-color-input').value = c;
    }
    function onColorPicked(val) { setBaseColor(val, val); }

    
    
    

    
    async function checkAuthStatus() {
      
      try {
        const result = await callPythonAPI('get_initial_data');
        if (result && result.is_authenticated) {
          return true;
        }
      } catch (e) {
        logMessage_Info('æœªè®¤è¯æˆ–ä¼šè¯è¿‡æœŸ');
      }

      return false;
    }

    
    function showAuthLogin() {
      $('loading-overlay').classList.add('hidden');
      $('auth-login-container').classList.remove('hidden');
      $('login-container').classList.add('hidden');
      $('main-app').classList.add('hidden');

      
      checkGuestLoginEnabled();
    }

    
    async function checkGuestLoginEnabled() {
      try {
        const result = await fetch('/auth/get_config');
        const data = await result.json();
        if (data.success && data.allow_guest_login) {
          $('guest-login-section').classList.remove('hidden');
        } else {
          $('guest-login-section').classList.add('hidden');
        }
      } catch (e) {
        logMessage_Error('è·å–é…ç½®å¤±è´¥:', e);
      }
    }

    
    function switchAuthTab(tab) {
      const loginTab = $('auth-tab-login');
      const registerTab = $('auth-tab-register');
      const loginForm = $('auth-login-form');
      const registerForm = $('auth-register-form');

      if (tab === 'login') {
        loginTab.classList.add('text-sky-600', 'border-sky-600');
        loginTab.classList.remove('text-slate-400', 'border-transparent');
        registerTab.classList.remove('text-sky-600', 'border-sky-600');
        registerTab.classList.add('text-slate-400', 'border-transparent');
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
      } else {
        registerTab.classList.add('text-sky-600', 'border-sky-600');
        registerTab.classList.remove('text-slate-400', 'border-transparent');
        loginTab.classList.remove('text-sky-600', 'border-sky-600');
        loginTab.classList.add('text-slate-400', 'border-transparent');
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      }

      
      $('auth-error-msg').classList.add('hidden');
      $('auth-success-msg').classList.add('hidden');
    }

    
    function showAuthError(message) {
      const errorMsg = $('auth-error-msg');
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      $('auth-success-msg').classList.add('hidden');
    }

    
    function showAuthSuccess(message) {
      const successMsg = $('auth-success-msg');
      successMsg.textContent = message;
      successMsg.classList.remove('hidden');
      $('auth-error-msg').classList.add('hidden');
    }

    
    function setButtonLoading(buttonId, loading, originalText = '') {
      const btn = $(buttonId);
      if (!btn) return;

      if (loading) {
        btn.dataset.originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = `<span class="inline-block animate-spin mr-2">â³</span>${originalText || 'å¤„ç†ä¸­...'}`;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || originalText;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        delete btn.dataset.originalText;
      }
    }

    function showButtonSuccess(buttonId, message = 'æˆåŠŸ', duration = 1500) {
      const btn = $(buttonId);
      if (!btn) return;

      
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');

      const originalText = btn.dataset.originalText || btn.textContent;
      delete btn.dataset.originalText;

      btn.innerHTML = `<span class="mr-1">âœ“</span>${message}`;
      btn.classList.add('!bg-green-600');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('!bg-green-600');
        btn.disabled = false; 
      }, duration);
    }

    function showButtonError(buttonId, message = 'å¤±è´¥', duration = 2000) {
      const btn = $(buttonId);
      if (!btn) return;

      
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');

      const originalText = btn.dataset.originalText || btn.textContent;
      delete btn.dataset.originalText;

      btn.innerHTML = `<span class="mr-1">âœ—</span>${message}`;
      btn.classList.add('!bg-red-600');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('!bg-red-600');
        btn.disabled = false; 
      }, duration);
    }

    
    
    

    
    

    
    const captchaIds = {
      login: null,
      register: null,
      modal: null
    };

    
    const captchaDimensions = {
      login: { width: 343, height: 119 },  
      register: { width: 343, height: 119 },
      modal: { width: 343, height: 119 }
    };

    async function loadCaptcha(formType) {
      
      
      
      const displayId = formType === 'login' ? 'auth-login-captcha-display' : 'auth-register-captcha-display';
      const displayElement = document.getElementById(displayId);

      
      
      if (!displayElement) {
        console.error(`[éªŒè¯ç ] æœªæ‰¾åˆ°éªŒè¯ç æ˜¾ç¤ºå…ƒç´ : ${displayId}`);
        return;
      }

      
      displayElement.innerHTML = '<span class="text-slate-400 text-xs">åŠ è½½ä¸­...</span>';

      try {
        
        
        
        
        
        
        const response = await fetch('/api/captcha/get', {
          method: 'GET',
          headers: {
            'X-Session-ID': sessionUUID  
          }
        });

        const result = await response.json();

        
        
        
        
        
        if (result.success && result.captcha_id) {
          
          
          
          const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          if (!uuidRegex.test(result.captcha_id)) {
            console.error('[éªŒè¯ç ] æ— æ•ˆçš„captcha_idæ ¼å¼ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©');
            displayElement.innerHTML = '<span class="text-red-500 text-xs">éªŒè¯ç IDæ ¼å¼é”™è¯¯</span>';
            return;
          }

          
          
          captchaIds[formType] = result.captcha_id;

          
          
          captchaDimensions[formType] = {
            width: result.width || 343,
            height: result.height || 119
          };

          const timestamp = Date.now();  

          
          const captchaWidth = captchaDimensions[formType].width;
          const captchaHeight = captchaDimensions[formType].height;

          const iframeHtml = `
            <iframe 
              src="/api/captcha/html/${result.captcha_id}?t=${timestamp}"
              style="max-width: ${captchaWidth}px; max-height: ${captchaHeight}px; width: ${captchaWidth}px; height: ${captchaHeight}px; border: none; overflow: hidden; display: block; margin: 0 auto;"
              scrolling="no"
              frameborder="0"
              title="éªŒè¯ç ">
            </iframe>
          `;

          
          displayElement.innerHTML = iframeHtml;

          console.log(`[éªŒè¯ç ] å·²åŠ è½½éªŒè¯ç iframe: ${result.captcha_id} (æ—¶é—´æˆ³: ${timestamp})`);


          loadMobileCaptcha(formType);
        } else {
          
          displayElement.innerHTML = '<span class="text-red-500 text-xs">åŠ è½½å¤±è´¥</span>';
          console.error(`[éªŒè¯ç ] åŠ è½½å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
        }
      } catch (error) {
        
        displayElement.innerHTML = '<span class="text-red-500 text-xs">ç½‘ç»œé”™è¯¯</span>';
        console.error(`[éªŒè¯ç ] åŠ è½½å¼‚å¸¸:`, error);
      }
    }

    
    function refreshCaptcha(formType) {
      
      
      const actualFormType = formType.replace('mobile-', '');
      console.log(`[éªŒè¯ç ] åˆ·æ–°${actualFormType}è¡¨å•éªŒè¯ç `);
      
      loadCaptcha(actualFormType);
    }

    

    
    let pendingSMSContext = null;

    
    async function loadCaptchaModal() {
      const displayElement = document.getElementById('captcha-modal-display');

      
      if (!displayElement) {
        console.error('[éªŒè¯ç æ¨¡æ€çª—] æœªæ‰¾åˆ°éªŒè¯ç æ˜¾ç¤ºå…ƒç´ ');
        return;
      }

      
      displayElement.innerHTML = '<span class="text-slate-400 text-xs">åŠ è½½ä¸­...</span>';

      try {
        
        
        
        
        
        const response = await fetch('/api/captcha/get', {
          method: 'GET',
          headers: {
            'X-Session-ID': sessionUUID  
          }
        });

        const result = await response.json();

        
        
        
        if (result.success && result.captcha_id) {
          
          const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          if (!uuidRegex.test(result.captcha_id)) {
            console.error('[éªŒè¯ç æ¨¡æ€çª—] æ— æ•ˆçš„captcha_idæ ¼å¼ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©');
            displayElement.innerHTML = '<span class="text-red-500 text-xs">éªŒè¯ç IDæ ¼å¼é”™è¯¯</span>';
            return;
          }

          
          
          captchaIds.modal = result.captcha_id;

          
          captchaDimensions.modal = {
            width: result.width || 343,
            height: result.height || 119
          };

          
          
          
          
          
          
          
          
          const timestamp = Date.now();  

          
          const captchaWidth = captchaDimensions.modal.width;
          const captchaHeight = captchaDimensions.modal.height;

          const iframeHtml = `
            <iframe 
              src="/api/captcha/html/${result.captcha_id}?t=${timestamp}"
              style="max-width: ${captchaWidth}px; max-height: ${captchaHeight}px; width: ${captchaWidth}px; height: ${captchaHeight}px; border: none; overflow: hidden; display: block; margin: 0 auto;"
              scrolling="no"
              frameborder="0"
              title="éªŒè¯ç ">
            </iframe>
          `;

          
          displayElement.innerHTML = iframeHtml;

          console.log(`[éªŒè¯ç æ¨¡æ€çª—] ã€CDNç¼“å­˜ä¿®å¤ã€‘éªŒè¯ç åŠ è½½æˆåŠŸï¼ŒID: ${result.captcha_id.substring(0, 8)}... (æ—¶é—´æˆ³: ${timestamp})`);
        } else {
          
          displayElement.innerHTML = '<span class="text-red-500 text-xs">åŠ è½½å¤±è´¥</span>';
          console.error('[éªŒè¯ç æ¨¡æ€çª—] åŠ è½½å¤±è´¥:', result.message || 'æœªçŸ¥é”™è¯¯');
        }
      } catch (error) {
        
        displayElement.innerHTML = '<span class="text-red-500 text-xs">ç½‘ç»œé”™è¯¯</span>';
        console.error('[éªŒè¯ç æ¨¡æ€çª—] åŠ è½½å¼‚å¸¸:', error);
      }
    }

    
    function refreshCaptchaModal() {
      console.log('[éªŒè¯ç æ¨¡æ€çª—] åˆ·æ–°éªŒè¯ç ');
      loadCaptchaModal();
    }

    
    function openCaptchaModal(context) {
      
      pendingSMSContext = context;

      
      const modal = document.getElementById('captcha-verification-modal');
      const input = document.getElementById('captcha-modal-input');

      
      if (!modal) {
        logMessage_Error('[éªŒè¯ç æ¨¡æ€çª—] æ‰¾ä¸åˆ°captcha-verification-modalå…ƒç´ ');
        
        showTempMessage('éªŒè¯ç æ¨¡æ€æ¡†åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }

      
      if (!input) {
        logMessage_Error('[éªŒè¯ç æ¨¡æ€çª—] æ‰¾ä¸åˆ°captcha-modal-inputè¾“å…¥æ¡†');
        showTempMessage('éªŒè¯ç è¾“å…¥æ¡†åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }

      try {
        
        modal.classList.remove('hidden');

        
        
        modal.style.display = 'flex';

        
        modal.style.zIndex = '70';

        
        input.value = '';

        
        
        loadCaptchaModal();

        
        
        setTimeout(() => {
          if (input && modal.style.display !== 'none') {
            input.focus();
            logMessage_Info('[éªŒè¯ç æ¨¡æ€çª—] æ¨¡æ€æ¡†å·²æ‰“å¼€å¹¶èšç„¦åˆ°è¾“å…¥æ¡†');
          }
        }, 300);

      } catch (error) {
        
        logMessage_Error('[éªŒè¯ç æ¨¡æ€çª—] æ‰“å¼€æ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
        showTempMessage('æ‰“å¼€éªŒè¯ç çª—å£æ—¶å‡ºé”™', 'error');
      }
    }

    
    function closeCaptchaModal() {
      const modal = document.getElementById('captcha-verification-modal');
      const input = document.getElementById('captcha-modal-input');

      if (modal) {
        modal.classList.add('hidden');
        input.value = '';  
        pendingSMSContext = null;  
      }
    }

    
    async function confirmCaptchaAndSendSMS() {
      const captchaInput = document.getElementById('captcha-modal-input');
      const captcha = captchaInput.value.trim();

      if (!captcha) {
        showModalAlert('è¯·è¾“å…¥éªŒè¯ç ');
        return;
      }

      if (!pendingSMSContext) {
        console.error('[éªŒè¯ç æ¨¡æ€çª—] æ²¡æœ‰å¾…å‘é€çš„SMSä¸Šä¸‹æ–‡');
        closeCaptchaModal();
        return;
      }

      
      const confirmBtn = document.getElementById('captcha-modal-confirm-btn');
      confirmBtn.disabled = true;
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = 'å‘é€ä¸­...';

      try {
        
        await sendSMSWithCaptcha(
          pendingSMSContext.phone,
          captcha,
          pendingSMSContext.button,
          pendingSMSContext.originalText,
          pendingSMSContext.scene 
        );

        
        closeCaptchaModal();
      } catch (error) {
        console.error('[éªŒè¯ç æ¨¡æ€çª—] å‘é€SMSå¤±è´¥:', error);
        
        refreshCaptchaModal();
      } finally {
        
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    }

    
    async function sendSMSWithCaptcha(phone, captcha, button, originalText, scene = null) {
      try {
        
        const requestBody = {
          phone: phone,
          captcha: captcha,
          captcha_id: captchaIds.modal  
        };

        
        if (scene) {
          requestBody.scene = scene;
        }

        
        const response = await fetch('/api/sms/send_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(requestBody)
        });

        const result = await response.json();

        if (result.success) {
          showModalAlert('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶çŸ­ä¿¡');

          
          let countdown = 60;
          button.disabled = true;

          const timer = setInterval(() => {
            if (countdown > 0) {
              button.textContent = `${countdown}ç§’åé‡è¯•`;
              countdown--;
            } else {
              clearInterval(timer);
              button.disabled = false;
              button.textContent = originalText;
            }
          }, 1000);
        } else {
          showModalAlert(result.message || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
          throw new Error(result.message || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        console.error('[SMS] å‘é€å¼‚å¸¸:', error);
        showModalAlert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
        throw error;
      }
    }

    
    async function handleAuthLogin() {
      const loginBtn = $('auth-login-btn');
      
      const login_id = $('auth-username').value.trim();
      const password = $('auth-password').value.trim();
      const sms_code = $('auth-sms-code').value.trim();
      const captcha = $('auth-login-captcha').value.trim();  

      let login_mode = 'username'; 
      let login_verification_method = 'password'; 

      
      if ($('auth-login-phone-btn').classList.contains('font-semibold')) {
        login_mode = 'phone';
      }

      
      
      if (!$('auth-sms-section').classList.contains('hidden')) {
        login_verification_method = 'sms';
      }

      
      if (!captcha) {
        showModalAlert('è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ', 'ç™»å½•å¤±è´¥');
        return;
      }

      
      if (!login_id) {
        showModalAlert('è¯·è¾“å…¥ç”¨æˆ·åæˆ–æ‰‹æœºå·', 'ç™»å½•å¤±è´¥');
        return;
      }

      if (login_mode === 'username') {
        
        if (!password) {
          showModalAlert('è¯·è¾“å…¥å¯†ç ', 'ç™»å½•å¤±è´¥');
          return;
        }
        if (password.length < 6 && login_id !== 'admin') {
          showModalAlert('å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦', 'ç™»å½•å¤±è´¥');
          return;
        }
      }
      else if (login_mode === 'phone') {
        
        if (!validateInput(login_id, 'phone').valid) {
          showModalAlert('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®', 'ç™»å½•å¤±è´¥');
          return;
        }

        if (login_verification_method === 'password') {
          
          if (!password) {
            showModalAlert('è¯·è¾“å…¥å¯†ç ', 'ç™»å½•å¤±è´¥');
            return;
          }
          if (password.length < 6) {
            showModalAlert('å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦', 'ç™»å½•å¤±è´¥');
            return;
          }
        }
        else if (login_verification_method === 'sms') {
          
          if (!sms_code) {
            showModalAlert('è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ', 'ç™»å½•å¤±è´¥');
            return;
          }
          if (sms_code.length !== 6 || !/^\d{6}$/.test(sms_code)) {
            showModalAlert('çŸ­ä¿¡éªŒè¯ç æ ¼å¼ä¸æ­£ç¡®', 'ç™»å½•å¤±è´¥');
            return;
          }
        }
      }

      
      const request_body = {}

      if (login_mode === 'username') {
        request_body.auth_username = login_id; 
      } else if (login_mode === 'phone') {
        request_body.auth_phone = login_id; 
      }

      
      if (login_verification_method === 'password') {
        request_body.auth_password = password;
      } else if (login_verification_method === 'sms') {
        request_body.auth_sms_code = sms_code;
      }

      
      request_body.captcha = captcha;
      request_body.captcha_id = captchaIds.login;  

      

      
      setButtonLoading('auth-login-btn', true, 'ç™»å½•ä¸­...');

      try {
        
        const headers = {
          'Content-Type': 'application/json',
          'X-Session-ID': sessionUUID || null
        };

        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: headers,
          credentials: 'include',  
          body: JSON.stringify(request_body) 
        });

        const result = await response.json();

        if (result.success) {
          
          if (result.requires_2fa) {
            
            window.temp2FAUsername = result.auth_username || login_id;

            
            setButtonLoading('auth-login-btn', false);

            
            const loginForm = $('auth-login-form');
            const tfaForm = $('auth-2fa-form');
            if (loginForm) loginForm.classList.add('hidden');
            if (tfaForm) tfaForm.classList.remove('hidden');

            
            const tfaCodeInput = $('auth-2fa-code');
            if (tfaCodeInput) {
              tfaCodeInput.value = '';
              tfaCodeInput.focus();
            }

            showAuthSuccess('å¯†ç éªŒè¯æˆåŠŸï¼Œè¯·è¾“å…¥éªŒè¯ç ');
            return;
          }

          
          if (result.session_id) {
            sessionUUID = result.session_id;
            logMessage_Info('[ç™»å½•æˆåŠŸ] ä¼šè¯IDå·²è®¾ç½®:', sessionUUID.substring(0, 16) + '...');
          }

          
          let successMessage = 'ç™»å½•æˆåŠŸï¼';

          
          if (result.multi_device_warning) {
            successMessage += '\n' + result.multi_device_warning;
          }

          
          if (result.cleanup_message) {
            successMessage += '\n' + result.cleanup_message;
          }

          showAuthSuccess(successMessage);

          
          if (result.token) {
            logMessage_Info('Received auth token (stored in cookie)');
            logMessage_Info('[å®‰å…¨] ç™»å½•ä»¤ç‰Œå·²ç”Ÿæˆï¼Œæœ‰æ•ˆæœŸ1å°æ—¶');
          }

          
          if (!result.is_guest) {
            
            
            currentUserData.group = result.group || 'user';
            currentAuthUsername = result.auth_username;
            currentUserIsGuest = false;
            logMessage_Info(`[ç³»ç»Ÿç™»å½•] æƒé™ç»„å·²è®¾ç½®ä¸º: ${currentUserData.group}`);

            
            showButtonSuccess('auth-login-btn', 'ç™»å½•æˆåŠŸ', 800);

            setTimeout(() => {
              
              setButtonLoading('auth-login-btn', false);

              
              $('auth-login-container').classList.add('hidden');
              
              if (isMobileMode) {
                
                $('mobile-auth-login-container').classList.add('hidden');
                
                showMobileSessionPicker();

              } else {
                
                showSessionPicker();
              }

              
              logMessage_Info('[ä¼šè¯é€‰æ‹©] è¯·é€‰æ‹©è¦è¿›å…¥çš„ä¼šè¯ï¼Œæˆ–åˆ›å»ºæ–°ä¼šè¯');
              logMessage_Info('[æç¤º] æ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€');

              
              if (result.kicked_sessions_count > 0) {
                logMessage_Info(`[å¤šè®¾å¤‡æ£€æµ‹] å·²è‡ªåŠ¨ç™»å‡ºè¯¥è´¦å·åœ¨å…¶ä»– ${result.kicked_sessions_count} ä¸ªè®¾å¤‡ä¸Šçš„ä¼šè¯`);
              }
            }, 1000);
            return;
          }

          
          setTimeout(async () => {
            
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.remove('hidden');

            
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–ç®¡ç†é¢æ¿å¤±è´¥:', e);
            }

            
            const adminBtnLogin = $('show-admin-panel-login');
            if (adminBtnLogin) adminBtnLogin.classList.remove('hidden');
            const adminBtnMulti = $('show-admin-panel-multi');
            if (adminBtnMulti) adminBtnMulti.classList.remove('hidden');
            const sessionsBtnMain = $('show-admin-panel');
            if (sessionsBtnMain) sessionsBtnMain.classList.remove('hidden');

            
            if (result.is_guest) {
              logMessage_Info('[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼šæ— æ³•æ ‡è®°é€šçŸ¥å·²è¯»ã€æ— æ³•ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½ã€æ— æ³•æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡');
              logMessage_Info('[æ¸¸å®¢æç¤º] è¯·ä¿å­˜å½“å‰åœ°å€ï¼Œä¸¢å¤±åæ— æ³•æ¢å¤æ‚¨çš„æ•°æ®ï¼5åˆ†é’Ÿä¸æ´»è·ƒä¼šè¯å°†è¢«æ¸…ç†ã€‚');
            } else {
              logMessage_Info('[æ³¨å†Œç”¨æˆ·] æ‚¨çš„çŠ¶æ€å·²å…³è”åˆ°è´¦å·ï¼Œå¯åœ¨ä»»ä½•è®¾å¤‡ç™»å½•æ¢å¤ã€‚');
            }
          }, 1000);
        } else {
          
          

          setButtonLoading('auth-login-btn', false);
          showButtonError('auth-login-btn', 'ç™»å½•å¤±è´¥');
          showModalAlert(result.message || 'ç™»å½•å¤±è´¥', 'ç™»å½•å¤±è´¥');

          
          refreshCaptcha('login');
          
          $('auth-login-captcha').value = '';
        }
      } catch (e) {
        logMessage_Error('ç™»å½•è¯·æ±‚å¤±è´¥:', e);
        setButtonLoading('auth-login-btn', false);
        showButtonError('auth-login-btn', 'ç½‘ç»œé”™è¯¯');
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'ç™»å½•å¤±è´¥');

        
        refreshCaptcha('login');
        $('auth-login-captcha').value = '';
      }
    }

    
    async function handle2FAVerify() {
      const codeInput = $('auth-2fa-code');
      const code = codeInput ? codeInput.value.trim() : '';

      
      if (!code || code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
        
        showModalAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æ•°å­—éªŒè¯ç ', '2FAéªŒè¯å¤±è´¥');
        return;
      }

      if (!window.temp2FAUsername) {
        
        showModalAlert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', '2FAéªŒè¯å¤±è´¥');
        
        const loginForm = $('auth-login-form');
        const tfaForm = $('auth-2fa-form');
        if (loginForm) loginForm.classList.remove('hidden');
        if (tfaForm) tfaForm.classList.add('hidden');
        return;
      }

      setButtonLoading('auth-2fa-verify-btn', true, 'éªŒè¯ä¸­...');

      try {
        const response = await fetch('/auth/2fa/verify_login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID || null
          },
          credentials: 'include',
          body: JSON.stringify({
            auth_username: window.temp2FAUsername,
            code: code
          })
        });

        const result = await response.json();

        if (result.success) {
          
          delete window.temp2FAUsername;

          
          if (result.session_id) {
            sessionUUID = result.session_id;
            logMessage_Info('[2FAéªŒè¯æˆåŠŸ] ä¼šè¯IDå·²è®¾ç½®:', sessionUUID.substring(0, 16) + '...');
          }

          showButtonSuccess('auth-2fa-verify-btn', 'éªŒè¯æˆåŠŸ', 800);
          showAuthSuccess('2FAéªŒè¯æˆåŠŸï¼');

          
          if (!result.is_guest) {
            setTimeout(() => {
              setButtonLoading('auth-2fa-verify-btn', false);

              
              $('auth-login-container').classList.add('hidden');
              showSessionPicker();

              logMessage_Info('[ä¼šè¯é€‰æ‹©] è¯·é€‰æ‹©è¦è¿›å…¥çš„ä¼šè¯ï¼Œæˆ–åˆ›å»ºæ–°ä¼šè¯');
              logMessage_Info('[æç¤º] æ¯ä¸ªä¼šè¯éƒ½æ˜¯ç‹¬ç«‹çš„å­¦æ ¡è´¦å·ç™»å½•çŠ¶æ€');

              
              const loginForm = $('auth-login-form');
              const tfaForm = $('auth-2fa-form');
              if (loginForm) loginForm.classList.remove('hidden');
              if (tfaForm) tfaForm.classList.add('hidden');
              if (codeInput) codeInput.value = '';
            }, 1000);
          }
        } else {
          setButtonLoading('auth-2fa-verify-btn', false);
          showButtonError('auth-2fa-verify-btn', 'éªŒè¯å¤±è´¥');
          
          showModalAlert(result.message || 'éªŒè¯ç é”™è¯¯', '2FAéªŒè¯å¤±è´¥');
          
          if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
          }
        }
      } catch (e) {
        logMessage_Error('2FAéªŒè¯è¯·æ±‚å¤±è´¥:', e);
        setButtonLoading('auth-2fa-verify-btn', false);
        showButtonError('auth-2fa-verify-btn', 'ç½‘ç»œé”™è¯¯');
        
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', '2FAéªŒè¯å¤±è´¥');
      }
    }

    
    async function handleAuthRegister() {
      
      const username = $('auth-reg-username').value.trim();
      const phone = $('auth-reg-phone').value.trim();
      const smsCode = $('auth-reg-sms-code').value.trim();
      const nickname_Raw = $('auth-reg-nickname').value.trim();
      const captcha = $('auth-register-captcha').value.trim();  


      let nickname;
      if (nickname_Raw === '' || nickname_Raw === null) {
        
        nickname = username; 
      } else {
        nickname = nickname_Raw; 
      }


      const avatarFile = registrationCroppedAvatarBlob; 
      const password = $('auth-reg-password').value.trim();
      const passwordConfirm = $('auth-reg-password-confirm').value.trim();

      
      
      if (!captcha) {
        showModalAlert('è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      
      if (!username || !password || !passwordConfirm) {
        
        showModalAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆç”¨æˆ·åã€å¯†ç ï¼‰', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      
      const usernameValidation = validateInput(username, 'username');
      if (!usernameValidation.valid) {
        
        showModalAlert(usernameValidation.message, 'æ³¨å†Œå¤±è´¥');
        return;
      }
      
      if (/[ä¸€-é¾¥]/.test(username)) {
        
        showModalAlert('ç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      
      const passwordValidation = validateInput(password, 'password');
      if (!passwordValidation.valid) {
        
        showModalAlert(passwordValidation.message, 'æ³¨å†Œå¤±è´¥');
        return;
      }

      if (password !== passwordConfirm) {
        
        showModalAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      
      if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
        
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼', 'æ³¨å†Œå¤±è´¥');
        return;
      }

      if (phone) {
        try {
          const bindResult = await callPythonAPI_raw('/api/auth/check_phone', 'POST', { phone: phone });

          if (bindResult && bindResult.is_bound) {
            
            const confirmed = await jsShowConfirm(
              'æ‰‹æœºå·å·²è¢«ç»‘å®š',
              `æ‚¨è¾“å…¥çš„æ‰‹æœºå· ${phone} å·²è¢«ç”¨æˆ· ${bindResult.bound_to_user} ç»‘å®šã€‚\n\næ˜¯å¦ç»§ç»­æ³¨å†Œï¼Ÿ\n\nå¦‚æœç»§ç»­ï¼Œè¯¥æ‰‹æœºå·å°†ä»åŸè´¦å·ä¸Šå¼ºåˆ¶è§£ç»‘ã€‚`
            );

            if (!confirmed) {
              logMessage_Info("[æ³¨å†Œ] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œå› ä¸ºæ‰‹æœºå·å·²è¢«ç»‘å®šã€‚");
              return; 
            }
            
            logMessage_Info("[æ³¨å†Œ] ç”¨æˆ·å·²ç¡®è®¤å¼ºåˆ¶è§£ç»‘æ‰‹æœºå·ï¼Œç»§ç»­æ³¨å†Œ...");
          }
        } catch (e) {
          logMessage_Error('æ£€æŸ¥æ‰‹æœºå·ç»‘å®šå¤±è´¥:', e);
          showModalAlert(`æ£€æŸ¥æ‰‹æœºå·å¤±è´¥: ${e.message}ï¼Œè¯·ç¨åé‡è¯•`, 'ç½‘ç»œé”™è¯¯');
          return;
        }
      }
      

      
      

      
      setButtonLoading('auth-register-btn', true, 'æ³¨å†Œä¸­...');

      
      const formData = new FormData();
      formData.append('auth_username', username);
      formData.append('auth_password', password);
      formData.append('phone', phone);
      formData.append('nickname', nickname);
      formData.append('sms_code', smsCode);
      formData.append('captcha', captcha);  
      formData.append('captcha_id', captchaIds.register);  

      
      if (avatarFile) {
        
        
        formData.append('avatar', avatarFile, avatarFile.name || 'avatar.jpg');
      }

      try {
        
        const response = await fetch('/auth/register', {
          method: 'POST',
          
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showButtonSuccess('auth-register-btn', 'æ³¨å†ŒæˆåŠŸ');
          showAuthSuccess('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');

          
          
          
          
          
          
          
          
          
          
        } else {
          setButtonLoading('auth-register-btn', false);
          showButtonError('auth-register-btn', 'æ³¨å†Œå¤±è´¥');
          
          showModalAlert(result.message || 'æ³¨å†Œå¤±è´¥', 'æ³¨å†Œå¤±è´¥');

          
          refreshCaptcha('register');
          
          $('auth-register-captcha').value = '';
        }
      } catch (e) {
        logMessage_Error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', e);
        setButtonLoading('auth-register-btn', false);
        showButtonError('auth-register-btn', 'ç½‘ç»œé”™è¯¯');
        
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'æ³¨å†Œå¤±è´¥');

        
        refreshCaptcha('register');
        $('auth-register-captcha').value = '';
      } finally {
        
        registrationCroppedAvatarBlob = null;
        
        setButtonLoading('auth-register-btn', false);
      }
    }

    
    async function handleGuestLogin() {
      try {
        
        const newUUID = generateUUID();

        const response = await fetch('/auth/guest_login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': newUUID
          }
        });

        const result = await response.json();

        if (result.success) {
          showAuthSuccess('ä»¥æ¸¸å®¢èº«ä»½ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...');
          setTimeout(() => {
            
            window.location.href = `/uuid=${newUUID}`;
          }, 1000);
        } else {
          
          showModalAlert(result.message || 'æ¸¸å®¢ç™»å½•å¤±è´¥', 'ç™»å½•å¤±è´¥');
        }
      } catch (e) {
        
        showModalAlert('æ¸¸å®¢ç™»å½•è¯·æ±‚å¤±è´¥ï¼š' + e.message, 'ç™»å½•å¤±è´¥');
      }
    }

    
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    
    
    

    
    if (typeof window !== 'undefined') {
      window.addEventListener('load', () => {
        
        const loginTab = $('auth-tab-login');
        const registerTab = $('auth-tab-register');
        if (loginTab) loginTab.addEventListener('click', () => switchAuthTab('login'));
        if (registerTab) registerTab.addEventListener('click', () => switchAuthTab('register'));

        
        const loginBtn = $('auth-login-btn');
        if (loginBtn) loginBtn.addEventListener('click', handleAuthLogin);

        
        const registerBtn = $('auth-register-btn');
        if (registerBtn) registerBtn.addEventListener('click', handleAuthRegister);

        
        const guestBtn = $('auth-guest-btn');
        if (guestBtn) guestBtn.addEventListener('click', handleGuestLogin);

        
        const tfa2VerifyBtn = $('auth-2fa-verify-btn');
        if (tfa2VerifyBtn) tfa2VerifyBtn.addEventListener('click', handle2FAVerify);

        
        const tfa2BackBtn = $('auth-2fa-back-btn');
        if (tfa2BackBtn) tfa2BackBtn.addEventListener('click', () => {
          const loginForm = $('auth-login-form');
          const tfaForm = $('auth-2fa-form');
          if (loginForm) loginForm.classList.remove('hidden');
          if (tfaForm) tfaForm.classList.add('hidden');
          
          delete window.temp2FAUsername;
          const tfaCodeInput = $('auth-2fa-code');
          if (tfaCodeInput) tfaCodeInput.value = '';
        });

        
        const authUsername = $('auth-username');
        const authPassword = $('auth-password');
        if (authUsername) authUsername.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAuthLogin();
        });
        if (authPassword) authPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAuthLogin();
        });

        
        const auth2FACode = $('auth-2fa-code');
        if (auth2FACode) auth2FACode.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handle2FAVerify();
        });

        
        const authRegPassword = $('auth-reg-password-confirm');
        if (authRegPassword) authRegPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAuthRegister();
        });

        
        

        
        const authLoginCaptcha = $('auth-login-captcha');
        if (authLoginCaptcha) {
          authLoginCaptcha.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              
              handleAuthLogin();
            }
          });
        }

        
        const authRegisterCaptcha = $('auth-register-captcha');
        if (authRegisterCaptcha) {
          authRegisterCaptcha.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              
              handleAuthRegister();
            }
          });
        }

        
        const profileConfirmPassword = $('profile-confirm-password');
        if (profileConfirmPassword) {
          profileConfirmPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              
              updatePassword();
            }
          });
        }

        
        const modifyPhoneCode = $('modify-phone-code');
        if (modifyPhoneCode) {
          modifyPhoneCode.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              
              confirmModifyPhone();
            }
          });
        }

        
        const adminPanelBtn = $('show-admin-panel');
        if (adminPanelBtn) adminPanelBtn.addEventListener('click', () => toggleAdminPanel(true));

        const adminPanelBtnLogin = $('show-admin-panel-login');
        if (adminPanelBtnLogin) adminPanelBtnLogin.addEventListener('click', () => toggleAdminPanel(true));

        const adminPanelBtnMulti = $('show-admin-panel-multi');
        if (adminPanelBtnMulti) adminPanelBtnMulti.addEventListener('click', () => toggleAdminPanel(true));

        
        
        const exitAppBtn = $('exit-app-btn');
        if (exitAppBtn) {
          exitAppBtn.addEventListener('click', async () => {
            
            const confirmed = await jsShowConfirm('é€€å‡ºåº”ç”¨', 'æ‚¨ç¡®å®šè¦é€€å‡ºè·‘æ­¥åŠ©æ‰‹åº”ç”¨å—ï¼Ÿ');
            
            if (!confirmed) return;

            try {
              
              await callPythonAPI_raw('/api/shutdown', 'POST');
              
              jsShowAlert('åº”ç”¨å³å°†å…³é—­...', 'success');
              
              setTimeout(() => {
                window.close(); 
              }, 1000);
            } catch (error) {
              
              console.error('[é€€å‡ºåº”ç”¨] è°ƒç”¨shutdown APIå¤±è´¥:', error);
              jsShowAlert('é€€å‡ºåº”ç”¨å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
          });
        }

        
        

        const modalAdminPanel = $('admin-panel-modal');
        if (modalAdminPanel) {
          const modalUsersTab = $('admin-tab-users_modal');
          const modalGroupsTab = $('admin-tab-groups_modal');
          const modalLogsTab = $('admin-tab-logs_modal');
          const modalHealthTab = $('admin-tab-health_modal');
          const modalProfileTab = $('admin-tab-profile_modal');
          const modalSessionsTab = $('admin-tab-sessions_modal');
          
          const modalMessagesTab = $('admin-tab-messages_modal');
          const modalIpbanTab = $('admin-tab-ipban_modal');
          const modalSmsTab = $('admin-tab-sms_modal');
          const modalConfigTab = $('admin-tab-config_modal');
          const modalCaptchaTab = $('admin-tab-captcha_modal');
          const modalRemindersTab = $('admin-tab-reminders_modal');

          if (modalUsersTab) modalUsersTab.addEventListener('click', () => switchAdminTab('users'));
          if (modalGroupsTab) modalGroupsTab.addEventListener('click', () => switchAdminTab('groups'));
          if (modalLogsTab) modalLogsTab.addEventListener('click', () => switchAdminTab('logs'));
          if (modalHealthTab) modalHealthTab.addEventListener('click', () => switchAdminTab('health'));
          if (modalProfileTab) modalProfileTab.addEventListener('click', () => switchAdminTab('profile'));
          if (modalSessionsTab) modalSessionsTab.addEventListener('click', () => switchAdminTab('sessions'));
          
          if (modalMessagesTab) modalMessagesTab.addEventListener('click', () => switchAdminTab('messages'));
          if (modalIpbanTab) modalIpbanTab.addEventListener('click', () => switchAdminTab('ipban'));
          if (modalSmsTab) modalSmsTab.addEventListener('click', () => switchAdminTab('sms'));
          if (modalConfigTab) modalConfigTab.addEventListener('click', () => switchAdminTab('config'));
          if (modalCaptchaTab) modalCaptchaTab.addEventListener('click', () => switchAdminTab('captcha'));
          if (modalRemindersTab) modalRemindersTab.addEventListener('click', () => switchAdminTab('reminders'));
          
          const modalSslTab = $('admin-tab-ssl_modal');
          if (modalSslTab) modalSslTab.addEventListener('click', () => switchAdminTab('ssl'));

          
          
          
          
          const tabsContainer = modalAdminPanel.querySelector('.flex.border-b-2.border-slate-200');
          if (tabsContainer) {
            
            tabsContainer.addEventListener('wheel', (event) => {
              
              event.preventDefault();
              
              
              
              tabsContainer.scrollLeft += event.deltaY;
            }, { passive: false }); 

            logMessage_Info('[æ ‡ç­¾é¡µå¯¼èˆª] å·²æ·»åŠ æ»šè½®æ°´å¹³æ»šåŠ¨æ”¯æŒ');
          }

          
          const viewHistoryBtn = $('view-captcha-history-btn');
          const backToSettingsBtn = $('back-to-captcha-settings-btn');

          if (viewHistoryBtn) {
            viewHistoryBtn.addEventListener('click', () => {
              const captchaPanel = $('admin-captcha-panel_modal');
              const captchaHistoryPanel = $('admin-captcha-history-panel_modal');
              
              if (captchaPanel) captchaPanel.classList.add('hidden');
              if (captchaHistoryPanel) captchaHistoryPanel.classList.remove('hidden');

              
              loadCaptchaHistory();
              logMessage_Info('[éªŒè¯ç ç®¡ç†] åˆ‡æ¢åˆ°å†å²è®°å½•è§†å›¾');
            });
          }

          if (backToSettingsBtn) {
            backToSettingsBtn.addEventListener('click', () => {
              const captchaPanel = $('admin-captcha-panel_modal');
              const captchaHistoryPanel = $('admin-captcha-history-panel_modal');
              
              if (captchaHistoryPanel) captchaHistoryPanel.classList.add('hidden');
              if (captchaPanel) captchaPanel.classList.remove('hidden');

              logMessage_Info('[éªŒè¯ç ç®¡ç†] è¿”å›è®¾ç½®è§†å›¾');
            });
          }

          logMessage_Info("Admin Panel Modal Tabs event listeners bound (using _modal IDs).");
        } else {
          logMessage_Error("Could not find admin panel modal element to bind tab events.");
        }

        
        const refreshUsersBtnModal = $('admin-refresh-users_modal'); 
        const refreshGroupsBtnModal = $('admin-refresh-groups_modal');
        const refreshLogsBtnModal = $('admin-refresh-logs_modal');
        const refreshHealthBtnModal = $('admin-refresh-health_modal');
        const refreshProfileBtnModal = $('admin-refresh-profile_modal');
        const refreshSessionsBtnModal = $('admin-refresh-sessions_modal');

        
        if (refreshUsersBtnModal) refreshUsersBtnModal.addEventListener('click', loadAdminUsers);
        if (refreshGroupsBtnModal) refreshGroupsBtnModal.addEventListener('click', loadAdminGroups);
        
        if (refreshLogsBtnModal) {
          refreshLogsBtnModal.addEventListener('click', () => {
            loadAdminLogs(1); 
          });
        }
        const logPrevPageBtn = $('log-prev-page');
        const logNextPageBtn = $('log-next-page');
        const logLimitSelect = $('log-limit-select_modal');

        if (logPrevPageBtn) {
          logPrevPageBtn.addEventListener('click', () => {
            if (currentLogPage > 1) {
              loadAdminLogs(currentLogPage - 1);
            }
          });
        }
        if (logNextPageBtn) {
          logNextPageBtn.addEventListener('click', () => {
            
            loadAdminLogs(currentLogPage + 1);
          });
        }
        if (logLimitSelect) {
          
          logLimitSelect.addEventListener('change', () => {
            loadAdminLogs(1);
          });
        }

        const logPageSelect = $('log-page-select');
        if (logPageSelect) {
          logPageSelect.addEventListener('change', () => {
            const newPage = parseInt(logPageSelect.value, 10);
            if (newPage && newPage !== currentLogPage) {
              loadAdminLogs(newPage);
            }
          });
        }

        if (refreshHealthBtnModal) refreshHealthBtnModal.addEventListener('click', loadHealthStatus);
        if (refreshProfileBtnModal) refreshProfileBtnModal.addEventListener('click', loadPersonalInfo);
        if (refreshSessionsBtnModal) refreshSessionsBtnModal.addEventListener('click', loadAdminSessions);
        logMessage_Info("Admin Panel Modal Refresh Buttons event listeners bound (using _modal IDs).");


        
        
        
        const banTypeSelect = $('ban-type');
        const banTargetInput = $('ban-target');
        const banTargetHint = $('ban-target-hint');
        const banTargetError = $('ban-target-error');



        
        if (banTargetInput) {
          banTargetInput.addEventListener('input', validateIPBanTarget);
        }


        
        
        
        
        
        
        

        
        if (banTypeSelect) {
          banTypeSelect.addEventListener('change', () => {
            const type = banTypeSelect.value;
            if (type === 'ip') {
              if (banTargetInput) banTargetInput.placeholder = 'è¯·è¾“å…¥IPåœ°å€ (ä¾‹å¦‚: 1.2.3.4)';
              if (banTargetHint) banTargetHint.textContent = 'ç¤ºä¾‹: 1.2.3.4';
            } else if (type === 'range') {
              if (banTargetInput) banTargetInput.placeholder = 'è¯·è¾“å…¥IPèŒƒå›´ (ä¾‹å¦‚: 192.168.1.1-192.168.1.100)';
              if (banTargetHint) banTargetHint.textContent = 'ç¤ºä¾‹: 192.168.1.1-192.168.1.100';
            }
            
            validateIPBanTarget();
          });
        }
        
        if (banTargetInput) {
          banTargetInput.addEventListener('input', validateIPBanTarget);
        }

        
        const showSessionsLogin = $('show-sessions-login');
        const showSessionsMain = $('show-admin-panel');
        const showSessionsMulti = $('show-admin-panel-multi');
        if (showSessionsLogin) showSessionsLogin.addEventListener('click', () => {
          toggleAdminPanel(true);
          switchAdminTab('sessions');
        });
        if (showSessionsMain) showSessionsMain.addEventListener('click', () => {
          toggleAdminPanel(true);
          switchAdminTab('sessions');
        });
        if (showSessionsMulti) showSessionsMulti.addEventListener('click', () => {
          toggleAdminPanel(true);
          switchAdminTab('sessions');
        });

        
        const refreshSessionsInlineBtn = $('admin-refresh-sessions-inline');
        if (refreshSessionsInlineBtn) refreshSessionsInlineBtn.addEventListener('click', loadAdminSessions_inline);

        
        const createUserModalBtn = $('admin-create-user_modal');
        const createGroupModalBtn = $('admin-create-group_modal');
        if (createUserModalBtn) createUserModalBtn.addEventListener('click', showCreateUserModal);
        if (createGroupModalBtn) createGroupModalBtn.addEventListener('click', showCreateGroupModal);

        
        const viewSchoolAccountsBtn = $('admin-view-school-accounts_modal');
        if (viewSchoolAccountsBtn) viewSchoolAccountsBtn.addEventListener('click', showSchoolAccountsModal);

        const schoolAccountsClose = $('school-accounts-close');
        const schoolAccountsOk = $('school-accounts-ok');
        const schoolAccountsRefresh = $('school-accounts-refresh');
        if (schoolAccountsClose) schoolAccountsClose.addEventListener('click', closeSchoolAccountsModal);
        if (schoolAccountsOk) schoolAccountsOk.addEventListener('click', closeSchoolAccountsModal);
        if (schoolAccountsRefresh) schoolAccountsRefresh.addEventListener('click', loadSchoolAccounts);

        
        const godModeCheckbox = $('god-mode-checkbox');
        const godModeCheckboxModal = $('god-mode-checkbox_modal');
        if (godModeCheckbox) godModeCheckbox.addEventListener('change', () => loadAdminSessions_inline());
        if (godModeCheckboxModal) godModeCheckboxModal.addEventListener('change', () => loadAdminSessions());

        
        const healthAutoRefreshToggle = $('health-auto-refresh-toggle');
        if (healthAutoRefreshToggle) {
          healthAutoRefreshToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
              startHealthAutoRefresh();
            } else {
              stopHealthAutoRefresh();
            }
          });
        }



        const multiAddClose = $('multi-add-user-close');
        const multiAddCancel = $('multi-add-user-cancel');
        const multiAddConfirm = $('multi-add-user-confirm');

        if (multiAddClose) multiAddClose.addEventListener('click', closeMultiAddUserModal);
        if (multiAddCancel) multiAddCancel.addEventListener('click', closeMultiAddUserModal);
        if (multiAddConfirm) multiAddConfirm.addEventListener('click', submitMultiAddUser);
      });
    }

    
    
    

    
    
    
    const permissionTranslations = {
      
      'view_dashboard': 'æŸ¥çœ‹ä»ªè¡¨æ¿',
      'view_tasks': 'æŸ¥çœ‹ä»»åŠ¡',
      'create_tasks': 'åˆ›å»ºä»»åŠ¡',
      'delete_tasks': 'åˆ é™¤ä»»åŠ¡',
      'start_tasks': 'å¯åŠ¨ä»»åŠ¡',
      'stop_tasks': 'åœæ­¢ä»»åŠ¡',
      'execute_tasks': 'æ‰§è¡Œä»»åŠ¡',
      'modify_tasks': 'ä¿®æ”¹ä»»åŠ¡',
      'schedule_tasks': 'å®šæ—¶ä»»åŠ¡',
      'view_history': 'æŸ¥çœ‹å†å²è®°å½•',

      
      'view_map': 'æŸ¥çœ‹åœ°å›¾',
      'record_path': 'è®°å½•è·¯å¾„',
      'auto_generate_path': 'è‡ªåŠ¨ç”Ÿæˆè·¯å¾„',

      
      'view_notifications': 'æŸ¥çœ‹é€šçŸ¥',
      'mark_notifications_read': 'æ ‡è®°é€šçŸ¥å·²è¯»',
      'send_notifications': 'å‘é€é€šçŸ¥',
      'manage_notifications': 'ç®¡ç†é€šçŸ¥',

      
      'view_user_details': 'æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…',
      'modify_user_settings': 'ä¿®æ”¹ç”¨æˆ·è®¾ç½®',
      'view_users': 'æŸ¥çœ‹ç”¨æˆ·',
      'ban_users': 'å°ç¦ç”¨æˆ·',

      
      'execute_multi_account': 'æ‰§è¡Œå¤šè´¦å·ä»»åŠ¡',
      'use_attendance': 'ä½¿ç”¨ç­¾åˆ°åŠŸèƒ½',

      
      'view_logs': 'æŸ¥çœ‹æ—¥å¿—',
      'clear_logs': 'æ¸…ç©ºæ—¥å¿—',

      
      'manage_users': 'ç®¡ç†ç”¨æˆ·',
      'create_users': 'åˆ›å»ºç”¨æˆ·',
      'delete_users': 'åˆ é™¤ç”¨æˆ·',
      'manage_permissions': 'ç®¡ç†æƒé™',
      'manage_groups': 'ç®¡ç†æƒé™ç»„',
      'assign_permissions': 'åˆ†é…æƒé™',
      'reset_user_password': 'é‡ç½®ç”¨æˆ·å¯†ç ',
      'view_audit_logs': 'æŸ¥çœ‹å®¡è®¡æ—¥å¿—',
      'view_all_sessions': 'æŸ¥çœ‹æ‰€æœ‰ä¼šè¯',
      'force_logout_users': 'å¼ºåˆ¶ç”¨æˆ·ç™»å‡º',
      'manage_system': 'ç³»ç»Ÿç®¡ç†',
      'create_permission_groups': 'åˆ›å»ºæƒé™ç»„',
      'delete_permission_groups': 'åˆ é™¤æƒé™ç»„',
      'modify_permission_groups': 'ä¿®æ”¹æƒé™ç»„',

      
      'auto_fill_password': 'è‡ªåŠ¨å¡«å……å¯†ç ',
      'import_offline': 'å¯¼å…¥ç¦»çº¿æ–‡ä»¶',
      'export_data': 'å¯¼å‡ºæ•°æ®',
      'import_data': 'å¯¼å…¥æ•°æ®',
      'backup_data': 'å¤‡ä»½æ•°æ®',
      'modify_params': 'ä¿®æ”¹å‚æ•°',
      'manage_own_sessions': 'ç®¡ç†è‡ªå·±çš„ä¼šè¯',
      'manage_user_sessions': 'ç®¡ç†ç”¨æˆ·ä¼šè¯',
      'view_session_details': 'æŸ¥çœ‹ä¼šè¯è¯¦æƒ…',
      'view_captcha_history': 'æŸ¥çœ‹éªŒè¯ç å†å²',
      'god_mode': 'ä¸Šå¸æ¨¡å¼',

      
      'use_login_button': 'ä½¿ç”¨ç™»å½•æŒ‰é’®',
      'use_multi_account_button': 'ä½¿ç”¨å¤šè´¦å·æ§åˆ¶å°',
      'use_import_button': 'å¯¼å…¥ç¦»çº¿æ–‡ä»¶',

      
      'view_messages': 'æŸ¥çœ‹ç•™è¨€æ¿',
      'post_messages': 'å‘è¡¨ç•™è¨€',
      'delete_own_messages': 'åˆ é™¤è‡ªå·±çš„ç•™è¨€',
      'delete_any_messages': 'åˆ é™¤ä»»ä½•ç•™è¨€',
      'view_all_messages': 'æŸ¥çœ‹æ‰€æœ‰ç•™è¨€',

      
      'manage_sessions': 'ç®¡ç†ä¼šè¯',
      'delete_sessions': 'åˆ é™¤ä¼šè¯',

      
      'system_settings': 'ç³»ç»Ÿè®¾ç½®',
      'manage_api': 'ç®¡ç†API',

      
      'admin_panel': 'ç®¡ç†é¢æ¿',
      'debug_mode': 'è°ƒè¯•æ¨¡å¼'
    };

    
    
    
    
    function translatePermission(permissionKey) {
      
      
      if (permissionTranslations[permissionKey]) {
        return permissionTranslations[permissionKey];
      }

      
      
      
      const verbMap = {
        'view': 'æŸ¥çœ‹',           
        'create': 'åˆ›å»º',         
        'delete': 'åˆ é™¤',         
        'edit': 'ç¼–è¾‘',           
        'modify': 'ä¿®æ”¹',         
        'update': 'æ›´æ–°',         
        'manage': 'ç®¡ç†',         
        'start': 'å¯åŠ¨',          
        'stop': 'åœæ­¢',           
        'execute': 'æ‰§è¡Œ',        
        'run': 'è¿è¡Œ',            
        'use': 'ä½¿ç”¨',            
        'access': 'è®¿é—®',         
        'add': 'æ·»åŠ ',            
        'remove': 'ç§»é™¤',         
        'export': 'å¯¼å‡º',         
        'import': 'å¯¼å…¥',         
        'backup': 'å¤‡ä»½',         
        'restore': 'æ¢å¤',        
        'assign': 'åˆ†é…',         
        'revoke': 'æ’¤é”€',         
        'grant': 'æˆäºˆ',          
        'clear': 'æ¸…ç©º',          
        'reset': 'é‡ç½®',          
        'force': 'å¼ºåˆ¶',          
        'post': 'å‘è¡¨',           
        'send': 'å‘é€',           
        'receive': 'æ¥æ”¶',        
        'download': 'ä¸‹è½½',       
        'upload': 'ä¸Šä¼ ',         
        'approve': 'å®¡æ‰¹',        
        'reject': 'æ‹’ç»',         
        'enable': 'å¯ç”¨',         
        'disable': 'ç¦ç”¨',        
        'configure': 'é…ç½®',      
        'monitor': 'ç›‘æ§'         
      };

      
      
      const nounMap = {
        'users': 'ç”¨æˆ·',          
        'user': 'ç”¨æˆ·',           
        'tasks': 'ä»»åŠ¡',          
        'task': 'ä»»åŠ¡',           
        'logs': 'æ—¥å¿—',           
        'log': 'æ—¥å¿—',            
        'sessions': 'ä¼šè¯',       
        'session': 'ä¼šè¯',        
        'notifications': 'é€šçŸ¥',  
        'notification': 'é€šçŸ¥',   
        'messages': 'ç•™è¨€',       
        'message': 'ç•™è¨€',        
        'permissions': 'æƒé™',    
        'permission': 'æƒé™',     
        'groups': 'æƒé™ç»„',       
        'group': 'æƒé™ç»„',        
        'settings': 'è®¾ç½®',       
        'setting': 'è®¾ç½®',        
        'system': 'ç³»ç»Ÿ',         
        'api': 'API',             
        'data': 'æ•°æ®',           
        'files': 'æ–‡ä»¶',          
        'file': 'æ–‡ä»¶',           
        'accounts': 'è´¦å·',       
        'account': 'è´¦å·',        
        'password': 'å¯†ç ',       
        'passwords': 'å¯†ç ',      
        'panel': 'é¢æ¿',          
        'mode': 'æ¨¡å¼',           
        'button': 'æŒ‰é’®',         
        'buttons': 'æŒ‰é’®',        
        'audit': 'å®¡è®¡',          
        'details': 'è¯¦æƒ…',        
        'detail': 'è¯¦æƒ…',         
        'params': 'å‚æ•°',         
        'param': 'å‚æ•°',          
        'offline': 'ç¦»çº¿æ–‡ä»¶',    
        'multi': 'å¤š',            
        'own': 'è‡ªå·±çš„',          
        'all': 'æ‰€æœ‰',            
        'any': 'ä»»ä½•',            
        'attendance': 'ç­¾åˆ°',     
        'console': 'æ§åˆ¶å°',      
        'logout': 'ç™»å‡º',         
        'login': 'ç™»å½•',          
        'admin': 'ç®¡ç†',          
        'god': 'ä¸Šå¸',            
        'debug': 'è°ƒè¯•'           
      };

      
      
      
      const words = permissionKey.toLowerCase().split('_');

      
      
      const translatedWords = [];

      
      for (let i = 0; i < words.length; i++) {
        const word = words[i]; 

        
        
        if (i === 0 && verbMap[word]) {
          translatedWords.push(verbMap[word]);
        }
        
        
        else if (nounMap[word]) {
          translatedWords.push(nounMap[word]);
        }
        
        
        else {
          
          
          translatedWords.push(word.charAt(0).toUpperCase() + word.slice(1));
        }
      }

      
      
      
      const result = translatedWords.join('');

      
      
      
      return result || permissionKey;
    }

    
    async function checkAdminPermission(permissionName) {
      try {
        
        const response = await fetch('/auth/check_permission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ permission: permissionName })
        });
        const result = await response.json();
        return result.success && result.has_permission;
      } catch (e) {
        logMessage_Error(`æ£€æŸ¥æƒé™ ${permissionName} å¤±è´¥:`, e);
        return false;
      }
    }

    async function toggleAdminPanel(show, skipAuthCheck = false) {
      const modal = $('admin-panel-modal');
      const usersTab = $('admin-tab-users_modal');
      const groupsTab = $('admin-tab-groups_modal');
      const logsTab = $('admin-tab-logs_modal');
      const healthTab = $('admin-tab-health_modal');
      const profileTab = $('admin-tab-profile_modal');
      const sessionsTab = $('admin-tab-sessions_modal'); 
      const messagesTab = $('admin-tab-messages_modal'); 
      const ipbanTab = $('admin-tab-ipban_modal'); 
      const smsTab = $('admin-tab-sms_modal'); 
      const configTab = $('admin-tab-config_modal'); 
      const godModeToggle = $('god-mode-toggle_modal');
      const modalCaptchaTab = $('admin-tab-captcha_modal');

      if (show) {
        
        
        
        
        
        let canViewMessages = false;
        let canManageSystem = false;
        let hasGodMode = false; 
        let isAuthenticated = skipAuthCheck;
        let canManageUsers = false; 
        let canViewLogs = false; 
        let canViewCaptchaHistory = false; 

        if (!skipAuthCheck) {
          
          try {
            const permissionChecks = await Promise.all([
              checkAdminPermission('manage_users'),
              checkAdminPermission('view_messages'),
              checkAdminPermission('manage_system'),
              checkAdminPermission('god_mode'), 
              checkAuthStatus(),
              checkAdminPermission('view_logs'),
              checkAdminPermission('view_captcha_history')
            ]);

            canManageUsers = permissionChecks[0];
            canViewMessages = permissionChecks[1];
            canManageSystem = permissionChecks[2];
            hasGodMode = permissionChecks[3]; 
            isAuthenticated = permissionChecks[4];
            canViewLogs = permissionChecks[5];
            canViewCaptchaHistory = permissionChecks[6];

          } catch (e) {
            logMessage_Error('å¹¶è¡Œæ£€æŸ¥æƒé™æ—¶å‡ºé”™:', e);
            
            canManageUsers = false;
            canViewMessages = false;
            canManageSystem = false;
            hasGodMode = false;
            isAuthenticated = false; 
            canViewLogs = false;
            canViewCaptchaHistory = false;
          }
        }

        const isGuest = currentUserIsGuest;

        
        if (usersTab) usersTab.style.display = canManageUsers ? 'block' : 'none';
        if (groupsTab) groupsTab.style.display = canManageUsers ? 'block' : 'none';
        
        
        
        
        
        
        if (logsTab) logsTab.style.display = canViewLogs ? 'block' : 'none';
        
        if (healthTab) healthTab.style.display = 'block';


        
        if (ipbanTab) ipbanTab.style.display = canManageUsers ? 'block' : 'none';
        if (smsTab) smsTab.style.display = canManageUsers ? 'block' : 'none';


        if (configTab) configTab.style.display = canManageSystem ? 'block' : 'none';

        if (modalCaptchaTab) modalCaptchaTab.style.display = canViewCaptchaHistory ? 'block' : 'none';

        const remindersTab = $('admin-tab-reminders_modal');
        if (remindersTab) remindersTab.style.display = canViewLogs ? 'block' : 'none';

        
        const sslTab = $('admin-tab-ssl_modal');
        if (sslTab) sslTab.style.display = canManageUsers ? 'block' : 'none';

        
        
        if (isGuest) {
          if (profileTab) profileTab.style.display = 'none';  
          if (sessionsTab) sessionsTab.style.display = 'block';
          if (messagesTab) messagesTab.style.display = 'block';
          
        } else {
          
          if (profileTab) profileTab.style.display = 'block';
          if (sessionsTab) sessionsTab.style.display = 'block';
          if (groupsTab) groupsTab.style.display = 'block';
        }

        
        if (godModeToggle) godModeToggle.style.display = hasGodMode ? 'flex' : 'none'; 

        
        switchAdminTab('sessions'); 

        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('modal-visible');
        

      } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-visible'); 

        
        const captchaHistoryPanel = $('admin-captcha-history-panel_modal');
        if (captchaHistoryPanel) captchaHistoryPanel.classList.add('hidden');

        
        stopHealthAutoRefresh();
      }
    }

    
    async function initializeInlineAdminPanel() {
      
      const sessionsPanel = $('admin-sessions-panel');

      
      if (sessionsPanel) {
        loadAdminSessions_inline();
      }
    }

    
    function switchAdminTab(tab) {
      
      
      
      

      
      
      const userGroup = currentUserData?.group || 'user'; 

      
      const usersTab = $('admin-tab-users_modal');
      const groupsTab = $('admin-tab-groups_modal');
      const logsTab = $('admin-tab-logs_modal');
      const healthTab = $('admin-tab-health_modal');
      const profileTab = $('admin-tab-profile_modal');
      const sessionsTab = $('admin-tab-sessions_modal');
      const messagesTab = $('admin-tab-messages_modal');
      const ipbanTab = $('admin-tab-ipban_modal');
      const smsTab = $('admin-tab-sms_modal');
      const configTab = $('admin-tab-config_modal');
      const captchaTab = $('admin-tab-captcha_modal');
      const remindersTab = $('admin-tab-reminders_modal');
      const sslTab = $('admin-tab-ssl_modal'); 
      const usersPanel = $('admin-users-panel_modal');
      const groupsPanel = $('admin-groups-panel_modal');
      const logsPanel = $('admin-logs-panel_modal');
      const healthPanel = $('admin-health-panel_modal');
      const profilePanel = $('admin-profile-panel_modal');
      const sessionsPanel = $('admin-sessions-panel_modal');
      const messagesPanel = $('admin-messages-panel_modal');
      const ipbanPanel = $('admin-ip-ban-modal');
      const smsPanel = $('admin-sms-config-modal');
      const configPanel = $('admin-config-panel_modal');
      const captchaPanel = $('admin-captcha-panel_modal');
      const remindersPanel = $('admin-reminders-panel_modal');
      const sslPanel = $('admin-ssl-panel_modal'); 

      
      


      
      if (!sessionsTab || !sessionsPanel) {
        logMessage_Error("switchAdminTab: æ— æ³•æ‰¾åˆ°å¿…è¦çš„ç®¡ç†é¢æ¿å…ƒç´ ");
        return;
      }

      
      [usersTab, groupsTab, logsTab, healthTab, profileTab, sessionsTab, messagesTab, ipbanTab, smsTab, configTab, captchaTab, remindersTab, sslTab].filter(t => t).forEach(t => {
        t.classList.remove('text-sky-600', 'border-sky-600');
        t.classList.add('text-slate-400', 'border-transparent');
      });

      
      [usersPanel, groupsPanel, logsPanel, healthPanel, profilePanel, sessionsPanel, messagesPanel, ipbanPanel, smsPanel, configPanel, captchaPanel, remindersPanel, sslPanel].filter(p => p).forEach(p => {
        p.classList.add('hidden');
      });

      
      
      const captchaHistoryPanel = $('admin-captcha-history-panel_modal');
      if (captchaHistoryPanel) captchaHistoryPanel.classList.add('hidden');

      
      if (tab === 'users') {
        usersTab.classList.add('text-sky-600', 'border-sky-600');
        usersTab.classList.remove('text-slate-400', 'border-transparent');
        usersPanel.classList.remove('hidden');
        loadAdminUsers();
        
        stopHealthAutoRefresh();
      } else if (tab === 'groups') {
        groupsTab.classList.add('text-sky-600', 'border-sky-600');
        groupsTab.classList.remove('text-slate-400', 'border-transparent');
        groupsPanel.classList.remove('hidden');
        loadAdminGroups();
        
        stopHealthAutoRefresh();
      } else if (tab === 'logs') {
        logsTab.classList.add('text-sky-600', 'border-sky-600');
        logsTab.classList.remove('text-slate-400', 'border-transparent');
        logsPanel.classList.remove('hidden');
        loadAdminLogs(1); 
        
        stopHealthAutoRefresh();
      } else if (tab === 'health') {
        healthTab.classList.add('text-sky-600', 'border-sky-600');
        healthTab.classList.remove('text-slate-400', 'border-transparent');
        healthPanel.classList.remove('hidden');
        loadHealthStatus();
        
        startHealthAutoRefresh();
      } else if (tab === 'profile') {
        profileTab.classList.add('text-sky-600', 'border-sky-600');
        profileTab.classList.remove('text-slate-400', 'border-transparent');
        profilePanel.classList.remove('hidden');
        loadPersonalInfo();
        
        stopHealthAutoRefresh();
      } else if (tab === 'sessions') {
        sessionsTab.classList.add('text-sky-600', 'border-sky-600');
        sessionsTab.classList.remove('text-slate-400', 'border-transparent');
        sessionsPanel.classList.remove('hidden');
        loadAdminSessions();
        
        stopHealthAutoRefresh();
      } else if (tab === 'messages') {
        
        
        
        
        if (messagesTab && messagesPanel) {
          
          checkIPBanAndProceed('messages_only').then(isBanned => {
            if (isBanned) {
              
              showModalAlert('æ‚¨çš„IPå·²è¢«é™åˆ¶è®¿é—®ç•™è¨€åŠŸèƒ½', 'è®¿é—®è¢«æ‹’ç»');
              
              return;
            }

            
            messagesTab.classList.add('text-sky-600', 'border-sky-600');
            messagesTab.classList.remove('text-slate-400', 'border-transparent');
            messagesPanel.classList.remove('hidden');
            loadMessages();
            
            stopHealthAutoRefresh();
          }).catch(err => {
            
            logMessage_Error('[IPå°ç¦æ£€æŸ¥] æ£€æŸ¥å¤±è´¥:', err);
            showModalAlert('æ— æ³•éªŒè¯è®¿é—®æƒé™ï¼Œè¯·ç¨åé‡è¯•', 'é”™è¯¯');
          });
        }
      } else if (tab === 'ipban') {
        if (ipbanTab && ipbanPanel) {
          ipbanTab.classList.add('text-sky-600', 'border-sky-600');
          ipbanTab.classList.remove('text-slate-400', 'border-transparent');
          ipbanPanel.classList.remove('hidden');
          loadIPBans();
          
          stopHealthAutoRefresh();
        }
      } else if (tab === 'sms') {
        if (smsTab && smsPanel) {
          smsTab.classList.add('text-sky-600', 'border-sky-600');
          smsTab.classList.remove('text-slate-400', 'border-transparent');
          smsPanel.classList.remove('hidden');
          loadSMSConfig();
          
          stopHealthAutoRefresh();
        }
      } else if (tab === 'config') { 
        if (configTab && configPanel) {
          configTab.classList.add('text-sky-600', 'border-sky-600');
          configTab.classList.remove('text-slate-400', 'border-transparent');
          configPanel.classList.remove('hidden');
          loadSystemConfig();
          
          stopHealthAutoRefresh();
        }
      } else if (tab === 'captcha') {
        if (captchaTab && captchaPanel) {
          captchaTab.classList.add('text-sky-600', 'border-sky-600');
          captchaTab.classList.remove('text-slate-400', 'border-transparent');
          captchaPanel.classList.remove('hidden');

          
          const dateInput = $('captcha-history-date');
          if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
          }

          
          loadCaptchaSettings();

          
          loadCaptchaHistory();

          
          stopHealthAutoRefresh();
        }
      } else if (tab === 'reminders') {
        
        const remindersTab = $('admin-tab-reminders_modal');
        const remindersPanel = $('admin-reminders-panel_modal');
        if (remindersTab && remindersPanel) {
          remindersTab.classList.add('text-sky-600', 'border-sky-600');
          remindersTab.classList.remove('text-slate-400', 'border-transparent');
          remindersPanel.classList.remove('hidden');
          
          loadReminders();
          
          stopHealthAutoRefresh();
        }
      } else if (tab === 'ssl') {
        
        const sslTab = $('admin-tab-ssl_modal');
        const sslPanel = $('admin-ssl-panel_modal');
        if (sslTab && sslPanel) {
          sslTab.classList.add('text-sky-600', 'border-sky-600');
          sslTab.classList.remove('text-slate-400', 'border-transparent');
          sslPanel.classList.remove('hidden');
          
          loadSSLInfo();
          
          stopHealthAutoRefresh();
        }
      } else {
        
        if (profileTab && profilePanel) {
          profileTab.classList.add('text-sky-600', 'border-sky-600');
          profileTab.classList.remove('text-slate-400', 'border-transparent');
          profilePanel.classList.remove('hidden');
          loadPersonalInfo();
        }
        
        stopHealthAutoRefresh();
      }
    }
    
    async function loadAdminSessions_inline() {
      const listEl = $('admin-sessions-list-inline');

      if (!listEl) {
        logMessage_Error("loadAdminSessions_inline: æ— æ³•æ‰¾åˆ°ä¼šè¯åˆ—è¡¨å®¹å™¨ 'admin-sessions-list-inline'ã€‚");
        return;
      }

      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const godModeCheckbox = $('god-mode-checkbox');
        const isGodMode = godModeCheckbox && godModeCheckbox.checked;

        let response;
        if (isGodMode) {
          
          response = await fetch('/auth/admin/all_sessions', {
            headers: {
              'X-Session-ID': sessionUUID
            }
          });
        } else {
          
          response = await fetch('/auth/user/sessions', {
            headers: {
              'X-Session-ID': sessionUUID 
            }
          });
        }

        if (!response.ok) {
          
          let errorMsg = `HTTP error ${response.status}`;
          try {
            const errorData = await response.json();
            errorMsg = errorData.message || errorMsg;
          } catch (parseError) {  }
          throw new Error(errorMsg); 
        }

        const result = await response.json()

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const sessions = result.sessions || [];

        
        const maxSessions = result.max_sessions !== undefined && result.max_sessions !== null ? result.max_sessions : -1;

        
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');

        
        if (isGodMode) {
          updateAdminSessionCountDisplayInline(validSessions.length, -1); 
        } else {
          updateAdminSessionCountDisplayInline(validSessions.length, maxSessions);
        }

        let html = '';
        if (!currentUserIsGuest) { 
          
          html += `
                  <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-lg">
                    <p class="text-sm text-slate-700 mb-2">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
                    <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">åˆ›å»ºæ–°ä¼šè¯</button>
                  </div>
                `;
        } else {
          
          html += `
                  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700">æ¸¸å®¢æ¨¡å¼ï¼šå½“å‰ä¼šè¯å¦‚ä¸‹ã€‚å¦‚éœ€ä½¿ç”¨å¤šä¸ªä¼šè¯ï¼Œè¯·æ³¨å†Œè´¦å·ã€‚</p>
                  </div>
                `;
        }

        if (validSessions.length === 0) {
          html += '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯</p>';
        } else {
          html += validSessions.map(session => {
            const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
            const isCurrent = session.is_current || session.session_id === sessionUUID;
            const sessionHash = session.session_hash || session.session_id.substring(0, 16); 

            
            let ownerInfo = '';
            if (isGodMode) {
              if (session.username) {
                ownerInfo = `<p class="text-xs text-slate-500">åˆ›å»ºè€…: ${session.username}</p>`;
              } else {
                
                ownerInfo = `<p class="text-xs text-amber-600">åˆ›å»ºè€…: æ¸¸å®¢æ¨¡å¼</p>`;
              }
            }

            return `
                      <div class="border ${isCurrent ? 'border-sky-500 bg-sky-50' : 'border-slate-200'} rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <p class="font-semibold text-slate-800 break-all"> ä¼šè¯ ${session.session_id} </p>
                             ${isCurrent ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2">(å½“å‰ä¼šè¯)</span></p>' : ''}
                            <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                            <p class="text-xs text-slate-500">çŠ¶æ€: ${session.is_multi_account_mode
                ? (session.login_success ? '<span class="font-semibold text-green-600">å·²ç™»å½•</span>' : '<span class="font-semibold ">æœªç™»å½•</span>')
                : (session.login_success ? '<span class="font-semibold text-green-600">å·²ç™»å½•</span>' : 'æœªç™»å½•')
              }</p>
                            ${ownerInfo}
                          </div>
                          <div class="flex gap-2">
                            ${!isCurrent ? `
                              <button class="btn btn-ghost !py-1 !px-2 text-xs" onclick="selectSession('${session.session_id}')">é€‰æ‹©</button>
                              <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" onclick="deleteSession('${session.session_id}')">åˆ é™¤</button>
                            ` : ''}
                            ${isGodMode ? `<button class="btn btn-danger !py-1 !px-2 text-xs" onclick="destroySession('${session.session_id}')">é”€æ¯</button>` : ''}
                          </div>
                        </div>
                      </div>
                    `;
          }).join('');
        }

        listEl.innerHTML = html;
      } catch (e) {
        logMessage_Error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:", e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    function updateAdminSessionCountDisplayInline(currentCount, maxSessions) {
      const countEl = $('admin-session-count-display-inline');
      if (!countEl) return;

      if (currentUserIsGuest) {
        countEl.innerHTML = `<span class="text-blue-600">ä¼šè¯æ•°: 1 / æ¸¸å®¢ä»…é™å•ä¼šè¯</span>`;
      } else {
        if (maxSessions === -1) {
          countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
        } else {
          const isNearLimit = currentCount >= maxSessions * 0.8;
          const isAtLimit = currentCount >= maxSessions;
          const colorClass = isAtLimit ? 'text-red-600' : (isNearLimit ? 'text-amber-600' : 'text-slate-600');
          countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
        }
      }
    }

    
    
    
    async function loadAdminLogs(newPage = 1) {
      currentLogPage = newPage; 

      const contentEl = $('admin-logs-content_modal');
      const limitSelect = $('log-limit-select_modal');
      
      const pageSelect = $('log-page-select');
      const pageTotal = $('log-page-total');
      const prevBtn = $('log-prev-page');
      const nextBtn = $('log-next-page');

      
      if (!contentEl || !limitSelect || !pageSelect || !pageTotal || !prevBtn || !nextBtn) {
        logMessage_Error("loadAdminLogs: æ— æ³•æ‰¾åˆ°æ—¥å¿—é¢æ¿çš„å¿…è¦DOMå…ƒç´ ");
        return;
      }

      contentEl.textContent = 'åŠ è½½ä¸­...';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      pageSelect.disabled = true; 

      try {
        const limit = limitSelect ? limitSelect.value : 100;
        const response = await fetch(`/logs/view?page=${currentLogPage}&limit=${limit}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          contentEl.textContent = `åŠ è½½å¤±è´¥: ${result.message}`;
          
          pageSelect.innerHTML = '<option value="1">1</option>';
          pageTotal.textContent = '(åŠ è½½å¤±è´¥)';
          return;
        }

        if (result.logs.length === 0) {
          contentEl.textContent = 'æš‚æ— æ—¥å¿—';
          
          pageSelect.innerHTML = '<option value="1">ç¬¬ 1 / 1 é¡µ</option>';
          pageTotal.textContent = '(å…± 0 è¡Œ)';
          return;
        }

        contentEl.textContent = result.logs.join('');

        
        const pagination = result.pagination;
        pageTotal.textContent = `(å…± ${pagination.total_lines} è¡Œ)`;

        
        pageSelect.innerHTML = '';
        for (let i = 1; i <= pagination.total_pages; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `ç¬¬ ${i} / ${pagination.total_pages} é¡µ`;
          if (i === pagination.current_page) {
            option.selected = true;
          }
          pageSelect.appendChild(option);
        }

        
        prevBtn.disabled = pagination.current_page <= 1;
        nextBtn.disabled = pagination.current_page >= pagination.total_pages;
        pageSelect.disabled = false; 

      } catch (e) {
        logMessage_Error("åŠ è½½æ—¥å¿—å¤±è´¥:", e);
        contentEl.textContent = `åŠ è½½å¤±è´¥: ${e.message}`;
        
        pageSelect.innerHTML = '<option value="1">1</option>';
        pageTotal.textContent = '(åŠ è½½å¤±è´¥)';
      }
    }

    
    
    
    async function loadHealthStatus() {
      const contentEl = $('admin-health-content_modal');

      if (!contentEl) {
        logMessage_Error("loadHealthStatus: æ— æ³•æ‰¾åˆ°å¥åº·çŠ¶æ€å®¹å™¨");
        return;
      }

      contentEl.innerHTML = '<p class="text-slate-400 text-center py-10">æ£€æµ‹ä¸­...</p>';

      try {
        const startTime = Date.now();
        const response = await fetch('/health');
        const responseTime = Date.now() - startTime;
        const result = await response.json();

        const statusColor = result.status === 'ok' ? 'green' : 'red';
        const statusText = result.status === 'ok' ? 'è¿è¡Œæ­£å¸¸' : 'å‡ºç°é”™è¯¯';

        contentEl.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-4">
              <h5 class="font-semibold text-${statusColor}-800 mb-2">æœåŠ¡å™¨çŠ¶æ€</h5>
              <p class="text-2xl font-bold text-${statusColor}-600">${statusText}</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h5 class="font-semibold text-blue-800 mb-2">å“åº”æ—¶é—´</h5>
              <p class="text-2xl font-bold text-blue-600">${responseTime}ms</p>
            </div>
          </div>
          <div class="mt-4 bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h5 class="font-semibold text-slate-800 mb-2">ç³»ç»Ÿä¿¡æ¯</h5>
            <pre class="text-xs text-slate-600 whitespace-pre-wrap">${JSON.stringify(result, null, 2)}</pre>
          </div>
        `;
      } catch (e) {
        logMessage_Error("åŠ è½½å¥åº·çŠ¶æ€å¤±è´¥:", e);
        contentEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    
    
    
    

    
    let healthCountdownInterval = null;
    
    let healthCountdownSeconds = 5;

    
    function startHealthAutoRefresh() {
      
      stopHealthAutoRefresh();

      
      const autoRefreshToggle = $('health-auto-refresh-toggle');
      if (!autoRefreshToggle || !autoRefreshToggle.checked) {
        return;
      }

      
      healthCountdownSeconds = 5;
      updateHealthCountdown();

      
      healthCountdownInterval = setInterval(() => {
        healthCountdownSeconds--;
        updateHealthCountdown();

        
        if (healthCountdownSeconds <= 0) {
          healthCountdownSeconds = 5;
        }
      }, 1000);

      
      healthAutoRefreshInterval = setInterval(() => {
        
        const toggle = $('health-auto-refresh-toggle');
        if (toggle && toggle.checked) {
          loadHealthStatus();
          
          healthCountdownSeconds = 5;
        } else {
          stopHealthAutoRefresh();
        }
      }, 5000);
    }

    
    function updateHealthCountdown() {
      const countdownDisplay = $('health-countdown-display');
      if (countdownDisplay) {
        
        if (healthCountdownSeconds > 0) {
          countdownDisplay.textContent = ` - ${healthCountdownSeconds}ç§’ååˆ·æ–°`;
        } else {
          countdownDisplay.textContent = ' - åˆ·æ–°ä¸­...';
        }
      }
    }

    
    function stopHealthAutoRefresh() {
      
      if (healthAutoRefreshInterval) {
        clearInterval(healthAutoRefreshInterval);
        healthAutoRefreshInterval = null;
      }
      
      if (healthCountdownInterval) {
        clearInterval(healthCountdownInterval);
        healthCountdownInterval = null;
      }
      
      const countdownDisplay = $('health-countdown-display');
      if (countdownDisplay) {
        countdownDisplay.textContent = '';
      }
    }

    
    
    
    async function loadPersonalInfo() {
      try {
        const response = await fetch('/auth/user/details', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          showModalAlert(`åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥: ${result.message}`, 'é”™è¯¯');
          return;
        }

        const user = result.user;

        
        
        

        
        if (user.auth_username) {
          currentAuthUsername = user.auth_username;
        }

        
        
        

        
        const nicknameInput = $('profile-nickname');
        const phoneInput = $('profile-phone');
        if (nicknameInput) nicknameInput.value = user.nickname || '';
        if (phoneInput) phoneInput.value = user.phone || 'æœªç»‘å®š';

        const phoneWrapper = phoneInput ? phoneInput.closest('.phone-input-wrapper') : null;
        if (phoneWrapper) {
          const prefix = phoneWrapper.querySelector('.phone-prefix');
          
          const isUnbound = (!phoneInput.value || phoneInput.value === 'æœªç»‘å®š');

          if (prefix) {
            
            prefix.style.display = isUnbound ? 'none' : 'inline';
          }
          
          phoneWrapper.classList.toggle('prefix-hidden', isUnbound);
        }

        
        const modifyPhoneBtn = $('profile-modify-phone-btn');
        const phoneHint = $('profile-phone-hint');

        
        const config = window.APP_CONFIG || { enable_phone_modification: false };

        if (config.enable_phone_modification) {
          if (modifyPhoneBtn) modifyPhoneBtn.style.display = 'block';
          if (phoneHint) phoneHint.style.display = 'block';
        } else {
          if (modifyPhoneBtn) modifyPhoneBtn.style.display = 'none';
          if (phoneHint) phoneHint.style.display = 'none';
          
          if (phoneInput) phoneInput.readOnly = true;
        }
        

        
        const avatarDisplay = $('profile-avatar-display');
        const avatarInput = $('profile-avatar-input');
        if (avatarDisplay) {
          const avatarUrl = user.avatar_url || user.avatar || '';
          logMessage_Info('[loadPersonalInfo] Processing avatar URL:', avatarUrl);
          if (avatarUrl) {
            
            if (avatarUrl.startsWith('/api/avatar/')) {
              loadAvatarWithAuth(avatarUrl, avatarDisplay);
            } else {
              
              const timestamp = new Date().getTime();
              const urlWithTimestamp = avatarUrl.includes('?')
                ? `${avatarUrl}&t=${timestamp}`
                : `${avatarUrl}?t=${timestamp}`;
              logMessage_Info('[loadPersonalInfo] Setting avatar display src to:', urlWithTimestamp);
              avatarDisplay.src = urlWithTimestamp;
            }
          } else {
            logMessage_Info('[loadPersonalInfo] No avatar URL, using default icon');
            
            avatarDisplay.src = 'data:image/svg+xml,%3Csvg xmlns=%22http:
          }
        }
        if (avatarInput) {
          avatarInput.value = user.avatar_url || user.avatar || '';
        }

        
        const tfaStatus = $('profile-2fa-enabled');
        const tfaActions = $('profile-2fa-actions');
        const tfaEnabledActions = $('profile-2fa-enabled-actions');
        const tfaSetup = $('profile-2fa-setup');

        
        const tfaEnabled = user['2fa_enabled'] || user.tfa_enabled || false;

        if (tfaStatus) {
          tfaStatus.textContent = tfaEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
          tfaStatus.className = tfaEnabled ? 'text-green-600 font-semibold' : 'text-slate-600';
        }

        
        if (tfaEnabled) {
          if (tfaActions) tfaActions.classList.add('hidden');
          if (tfaSetup) tfaSetup.classList.add('hidden');
          if (tfaEnabledActions) tfaEnabledActions.classList.remove('hidden');
        } else {
          if (tfaActions) tfaActions.classList.remove('hidden');
          if (tfaEnabledActions) tfaEnabledActions.classList.add('hidden');
          if (tfaSetup) tfaSetup.classList.add('hidden');
        }

        
        const themeSelect = $('profile-theme-select');
        if (themeSelect && user.theme) {
          themeSelect.value = user.theme;
        }

        
        
        try {
          const paramsResult = await callPythonAPI('get_params');
          if (paramsResult && paramsResult.theme_base_color) {
            const themeColor = paramsResult.theme_base_color;

            
            const colorPicker = $('profile-theme_base_color-picker');
            const colorInput = $('profile-theme_base_color');
            if (colorPicker) colorPicker.value = themeColor;
            if (colorInput) colorInput.value = themeColor;

            
            onColorPicked(themeColor);
          }

          
          if (paramsResult && paramsResult.theme_style) {
            setThemeStyle(paramsResult.theme_style);
          }

          
          if (user.theme) {
            applyAndSaveTheme(user.theme);
          }
        } catch (e) {
          logMessage_Warning('[loadPersonalInfo] åŠ è½½ä¸»é¢˜è®¾ç½®å¤±è´¥:', e);
        }
      } catch (e) {
        logMessage_Error("åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥:", e);
        showModalAlert(`åŠ è½½å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function updateAvatar() {
      const avatarInput = $('profile-avatar-input');
      if (!avatarInput || !avatarInput.value.trim()) {
        showModalAlert('è¯·è¾“å…¥å¤´åƒURL', 'æç¤º');
        return;
      }

      try {
        const response = await fetch('/auth/user/update_avatar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            avatar_url: avatarInput.value.trim()
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('å¤´åƒæ›´æ–°æˆåŠŸï¼', 'æˆåŠŸ');
          loadPersonalInfo(); 
        } else {
          showModalAlert(`æ›´æ–°å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("æ›´æ–°å¤´åƒå¤±è´¥:", e);
        showModalAlert(`æ›´æ–°å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    
    async function loadAvatarWithAuth(avatarUrl, imgElement) {
      try {
        logMessage_Info('[loadAvatarWithAuth] Fetching avatar:', avatarUrl);
        const response = await fetch(avatarUrl, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        if (!response.ok) {
          logMessage_Error('[loadAvatarWithAuth] Failed to fetch avatar:', response.status);
          
          imgElement.src = 'data:image/svg+xml,%3Csvg xmlns=%22http:
          return;
        }

        
        const blob = await response.blob();

        
        const reader = new FileReader();
        reader.onloadend = function () {
          logMessage_Info('[loadAvatarWithAuth] Avatar loaded successfully');
          imgElement.src = reader.result;
        };
        reader.readAsDataURL(blob);
      } catch (e) {
        logMessage_Error('[loadAvatarWithAuth] Error loading avatar:', e);
        
        imgElement.src = 'data:image/svg+xml,%3Csvg xmlns=%22http:
      }
    }

    function previewAvatar(event) {
      isRegistrationCrop = false; 
      const file = event.target.files[0];
      if (!file) return;

      
      if (!file.type.startsWith('image/')) {
        showModalAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'é”™è¯¯');
        event.target.value = ''; 
        return;
      }

      
      const reader = new FileReader();
      reader.onload = function (e) {
        const cropImage = $('crop-image');
        if (cropImage) {
          cropImage.src = e.target.result;

          
          if (avatarCropper) {
            avatarCropper.destroy();
          }

          
          avatarCropper = new Cropper(cropImage, {
            aspectRatio: 1, 
            viewMode: 1,
            minContainerWidth: 300,
            minContainerHeight: 300,
            autoCropArea: 0.8,
            responsive: true,
            guides: true,
            center: true,
            highlight: true,
            cropBoxResizable: true,
            cropBoxMovable: true,
            toggleDragModeOnDblclick: false
          });

          
          showModal('avatar-crop-modal');
        }
      };
      reader.readAsDataURL(file);
    }

    
    function previewAvatarForRegistration(event) {
      isRegistrationCrop = true; 
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showModalAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'é”™è¯¯');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const cropImage = $('crop-image');
        if (cropImage) {
          cropImage.src = e.target.result;
          if (avatarCropper) avatarCropper.destroy();
          avatarCropper = new Cropper(cropImage, {
            aspectRatio: 1, viewMode: 1, minContainerWidth: 300, minContainerHeight: 300,
            autoCropArea: 0.8, responsive: true, guides: true, center: true,
            highlight: true, cropBoxResizable: true, cropBoxMovable: true,
            toggleDragModeOnDblclick: false
          });
          showModal('avatar-crop-modal');
        }
      };
      reader.readAsDataURL(file);
    }

    
    
    function closeCropModal() {
      
      if (avatarCropper) {
        avatarCropper.destroy();
        avatarCropper = null;
      }

      
      const fileInput = $('profile-avatar-file');
      if (fileInput) fileInput.value = '';
      const regFileInput = $('auth-reg-avatar');
      if (regFileInput) regFileInput.value = '';
      
      const mobileRegFileInput = $('mobile-reg-avatar');
      if (mobileRegFileInput) mobileRegFileInput.value = '';

      
      isRegistrationCrop = false;

      
      hideModal('avatar-crop-modal');
    }

    
    
    async function confirmCropForRegistration() {
      
      if (!avatarCropper) {
        showModalAlert('è£å‰ªå™¨æœªåˆå§‹åŒ–', 'é”™è¯¯');
        return;
      }

      
      
      const canvas = avatarCropper.getCroppedCanvas({
        width: 200, height: 200, imageSmoothingQuality: 'high'
      });

      
      if (!canvas) {
        showModalAlert('è£å‰ªå¤±è´¥', 'é”™è¯¯');
        return;
      }

      
      canvas.toBlob(function (blob) {
        
        
        registrationCroppedAvatarBlob = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });

        
        const previewImg = $('auth-reg-avatar-preview');
        if (previewImg) {
          
          previewImg.src = URL.createObjectURL(registrationCroppedAvatarBlob);
        }

        
        
        const mobilePreviewImg = $('mobile-reg-avatar-preview');
        if (mobilePreviewImg) {
          
          mobilePreviewImg.src = URL.createObjectURL(registrationCroppedAvatarBlob);
        }

        
        closeCropModal();
      }, 'image/jpeg', 0.9); 
    }

    async function confirmCropAndUpload() {
      
      if (isRegistrationCrop) {
        
        await confirmCropForRegistration();
      } else {
        
        if (!avatarCropper) {
          showModalAlert('è£å‰ªå™¨æœªåˆå§‹åŒ–', 'é”™è¯¯');
          return;
        }

        
        const canvas = avatarCropper.getCroppedCanvas({
          width: 200,
          height: 200,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high'
        });

        if (!canvas) {
          showModalAlert('è£å‰ªå¤±è´¥', 'é”™è¯¯');
          return;
        }

        
        canvas.toBlob(async function (blob) {
          
          const avatarFile = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });

          
          closeCropModal();

          
          const formData = new FormData();
          formData.append('avatar', avatarFile);

          try {
            const response = await fetch('/auth/user/upload_avatar', {
              method: 'POST',
              headers: {
                'X-Session-ID': sessionUUID
              },
              body: formData
            });
            const result = await response.json();

            if (result.success) {
              showModalAlert('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'æˆåŠŸ');

              
              croppedAvatarFile = null;

              
              const fileInput = $('profile-avatar-file');
              if (fileInput) {
                fileInput.value = '';
              }

              
              await loadPersonalInfo();
            } else {
              showModalAlert(`ä¸Šä¼ å¤±è´¥: ${result.message}`, 'é”™è¯¯');
            }
          } catch (e) {
            logMessage_Error("ä¸Šä¼ å¤´åƒå¤±è´¥:", e);
            showModalAlert(`ä¸Šä¼ å¤±è´¥: ${e.message}\n\nâš ï¸ æ­¤åŠŸèƒ½éœ€è¦åç«¯API /auth/user/upload_avatar æ”¯æŒ`, 'é”™è¯¯');
          }
        }, 'image/jpeg', 0.9);
      }
    }

    async function uploadAvatar() {
      
      let fileToUpload = croppedAvatarFile;

      
      if (!fileToUpload) {
        const fileInput = $('profile-avatar-file');
        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
          showModalAlert('è¯·å…ˆé€‰æ‹©å¹¶è£å‰ªå›¾ç‰‡æ–‡ä»¶', 'æç¤º');
          return;
        }
        fileToUpload = fileInput.files[0];
      }

      const formData = new FormData();
      formData.append('avatar', fileToUpload);

      try {
        const response = await fetch('/auth/user/upload_avatar', {
          method: 'POST',
          headers: {
            'X-Session-ID': sessionUUID
          },
          body: formData
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'æˆåŠŸ');

          
          croppedAvatarFile = null;

          
          const fileInput = $('profile-avatar-file');
          if (fileInput) {
            fileInput.value = '';
          }

          
          await loadPersonalInfo();
        } else {
          showModalAlert(`ä¸Šä¼ å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("ä¸Šä¼ å¤´åƒå¤±è´¥:", e);
        showModalAlert(`ä¸Šä¼ å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    
    async function updateBasicInfo() {
      const nickname = $('profile-nickname');
      const phone = $('profile-phone');

      if (!nickname || !phone) return;

      if (!nickname.value.trim()) {
        showModalAlert('æ˜µç§°ä¸èƒ½ä¸ºç©º', 'æç¤º');
        return;
      }

      if (!currentAuthUsername) {
        showModalAlert('æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°åŠ è½½', 'é”™è¯¯');
        return;
      }

      try {
        const response = await fetch('/api/admin/users/' + encodeURIComponent(currentAuthUsername) + '/basic_info', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            nickname: nickname.value.trim()
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert('åŸºæœ¬ä¿¡æ¯æ›´æ–°æˆåŠŸ', 'æˆåŠŸ');
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (error) {
        logMessage_Error('æ›´æ–°åŸºæœ¬ä¿¡æ¯å¤±è´¥', error);
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'é”™è¯¯');
      }
    }

    
    async function modifyPhone() {
      showModalAlert('ä¿®æ”¹æ‰‹æœºå·åŠŸèƒ½éœ€è¦çŸ­ä¿¡éªŒè¯ï¼Œå½“å‰ç‰ˆæœ¬æš‚æœªå¼€æ”¾', 'æç¤º');
      
      
      
      
    }

    
    async function updatePassword() {
      
      
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤ä¿®æ”¹å¯†ç ',
        'æ‚¨ç¡®å®šè¦ä¿®æ”¹æ‚¨çš„ç™»å½•å¯†ç å—ï¼Ÿ\n\nä¿®æ”¹åéœ€è¦ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚'
      );

      
      if (!confirmed) {
        logMessage_Info('[ä¿®æ”¹å¯†ç ] ç”¨æˆ·å–æ¶ˆäº†å¯†ç ä¿®æ”¹æ“ä½œ');
        return;
      }

      
      const currentPassword = $('profile-current-password');
      const newPassword = $('profile-new-password');
      const confirmPassword = $('profile-confirm-password');

      if (!currentPassword || !newPassword || !confirmPassword) return;

      if (!currentPassword.value || !newPassword.value || !confirmPassword.value) {
        showModalAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'æç¤º');
        return;
      }

      if (newPassword.value !== confirmPassword.value) {
        showModalAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'é”™è¯¯');
        return;
      }

      if (newPassword.value.length < 6) {
        showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      if (!currentAuthUsername) {
        showModalAlert('æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯', 'é”™è¯¯');
        return;
      }

      try {
        const response = await fetch('/auth/admin/reset_password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: currentAuthUsername,
            old_password: currentPassword.value,
            new_password: newPassword.value
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'æˆåŠŸ');
          currentPassword.value = '';
          newPassword.value = '';
          confirmPassword.value = '';
        } else {
          showModalAlert(`ä¿®æ”¹å¤±è´¥: ${result.message || 'è¯·æ£€æŸ¥å½“å‰å¯†ç æ˜¯å¦æ­£ç¡®'}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("ä¿®æ”¹å¯†ç å¤±è´¥:", e);
        showModalAlert(`ä¿®æ”¹å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function generate2FA() {
      try {
        const response = await fetch('/auth/2fa/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          showModalAlert(`ç”Ÿæˆ2FAå¤±è´¥: ${result.message}`, 'é”™è¯¯');
          return;
        }

        
        const setupDiv = $('profile-2fa-setup');
        const actionsDiv = $('profile-2fa-actions');
        if (setupDiv) setupDiv.classList.remove('hidden');
        if (actionsDiv) actionsDiv.classList.add('hidden');

        
        const secretSpan = $('profile-2fa-secret');
        if (secretSpan && result.secret) {
          secretSpan.textContent = result.secret;
        }

        
        const qrCanvas = $('profile-2fa-qr');
        if (qrCanvas && result.qr_uri) {
          if (typeof QRCode !== 'undefined') {
            
            qrCanvas.width = 200;
            qrCanvas.height = 200;

            QRCode.toCanvas(qrCanvas, result.qr_uri, { width: 200 }, function (error) {
              if (error) {
                logMessage_Error('QR Code generation error:', error);
                showModalAlert('äºŒç»´ç ç”Ÿæˆå¤±è´¥', 'é”™è¯¯');
              } else {
                logMessage_Info('QR Code generated successfully');
              }
            });
          } else {
            logMessage_Error('QRCodeåº“æœªåŠ è½½');
            showModalAlert('QRCodeåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'é”™è¯¯');
          }
        }
      } catch (e) {
        logMessage_Error("ç”Ÿæˆ2FAå¤±è´¥:", e);
        showModalAlert(`ç”Ÿæˆå¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function enable2FA() {
      const codeInput = $('profile-2fa-code');
      if (!codeInput || !codeInput.value) {
        showModalAlert('è¯·è¾“å…¥éªŒè¯ç ', 'æç¤º');
        return;
      }

      try {
        const response = await fetch('/auth/2fa/enable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            code: codeInput.value
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('2FAå¯ç”¨æˆåŠŸï¼', 'æˆåŠŸ');
          
          const setupDiv = $('profile-2fa-setup');
          const actionsDiv = $('profile-2fa-actions');
          if (setupDiv) setupDiv.classList.add('hidden');
          if (actionsDiv) actionsDiv.classList.remove('hidden');
          
          loadPersonalInfo();
        } else {
          showModalAlert(`å¯ç”¨å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("å¯ç”¨2FAå¤±è´¥:", e);
        showModalAlert(`å¯ç”¨å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function disable2FA() {
      const confirmed = await jsShowConfirm('ç¡®è®¤å…³é—­2FA', 'å…³é—­åŒå› ç´ è®¤è¯åï¼Œè´¦å·å®‰å…¨æ€§å°†é™ä½ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/2fa/disable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('2FAå·²å…³é—­', 'æˆåŠŸ');
          
          loadPersonalInfo();
        } else {
          showModalAlert(`å…³é—­å¤±è´¥: ${result.message}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("å…³é—­2FAå¤±è´¥:", e);
        showModalAlert(`å…³é—­å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    async function test2FA() {
      
      const testCode = await new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">æµ‹è¯•2FA</h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 mb-2">è¯·è¾“å…¥éªŒè¯å™¨ä¸­çš„6ä½éªŒè¯ç </label>
              <input type="text" id="test-2fa-code-input" class="input-field w-full" placeholder="è¾“å…¥6ä½éªŒè¯ç " maxlength="6" inputmode="numeric">
            </div>
            <div class="flex gap-2 justify-end">
              <button class="btn btn-ghost" onclick="this.closest('.fixed').remove()">å–æ¶ˆ</button>
              <button class="btn btn-primary" id="confirm-test-2fa">éªŒè¯</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const confirmBtn = modal.querySelector('#confirm-test-2fa');
        const codeInput = modal.querySelector('#test-2fa-code-input');

        confirmBtn.onclick = () => {
          const code = codeInput.value;
          if (!code || code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
            showModalAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æ•°å­—éªŒè¯ç ', 'é”™è¯¯');
            return;
          }
          modal.remove();
          resolve(code);
        };
      });

      if (!testCode) return;

      try {
        const response = await fetch('/auth/2fa/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            code: testCode
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('2FAéªŒè¯æˆåŠŸï¼æ‚¨çš„åŒå› ç´ è®¤è¯å·¥ä½œæ­£å¸¸ã€‚', 'æˆåŠŸ');
        } else {
          showModalAlert(`éªŒè¯å¤±è´¥: ${result.message || 'éªŒè¯ç é”™è¯¯'}`, 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error("æµ‹è¯•2FAå¤±è´¥:", e);
        showModalAlert(`æµ‹è¯•å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    
    async function updateTheme() {
      const themeSelect = $('profile-theme-select');
      if (!themeSelect) return;

      const selectedTheme = themeSelect.value;

      
      applyAndSaveTheme(selectedTheme);

      try {
        const response = await fetch('/auth/user/update_theme', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            theme: selectedTheme
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('ä¸»é¢˜æ›´æ–°æˆåŠŸï¼', 'æˆåŠŸ');
        } else {
          showModalAlert(`æ›´æ–°å¤±è´¥: ${result.message}`, 'é”™è¯¯');
          
          applyAndSaveTheme(selectedTheme === 'dark' ? 'light' : 'dark');
        }
      } catch (e) {
        logMessage_Error("æ›´æ–°ä¸»é¢˜å¤±è´¥:", e);
        showModalAlert(`æ›´æ–°å¤±è´¥: ${e.message}`, 'é”™è¯¯');
      }
    }

    
    
    
    function showCreateUserModal() {
      const modal = $('newUserModal');
      if (modal) {
        
        $('newUsername').value = "";
        $('newPassword').value = "";

        
        modal.style.display = 'flex';


        const confirmBtn = $('newUserConfirm'); 
        confirmBtn.onclick = async () => {
          const inputUsername = $('newUsername').value.trim();
          const inputPassword = $('newPassword').value;

          if (!inputUsername || !inputPassword) {
            showModalAlert("è´¦å·å’Œå¯†ç å‡ä¸èƒ½ä¸ºç©º");
            return;
          }
          if (!inputPassword || inputPassword.length < 6) {
            showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
            return;
          }

          
          const group = 'user';

          
          setButtonLoading('newUserConfirm', true, 'åˆ›å»ºä¸­...');

          try {
            
            const response = await fetch('/auth/admin/create_user', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                username: inputUsername,
                password: inputPassword,
                group: group
              })
            });

            const result = await response.json();

            if (result.success) {
              showModalAlert("ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼");
              closeNewUserModal();
              
              if (typeof loadAdminUsers === 'function') {
                loadAdminUsers();
              }
            } else {
              showModalAlert(`åˆ›å»ºå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
          } catch (e) {
            showModalAlert(`åˆ›å»ºæ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`);
            logMessage_Error("åˆ›å»ºç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯:", e);
          } finally {
            
            setButtonLoading('newUserConfirm', false, 'ç¡®è®¤');
          }
        };
      }
    }

    
    
    
    let currentEditGroupKey = null;
    let currentManageUsername = null;

    async function showCreateGroupModal() {
      const modal = $('create-group-modal');
      if (!modal) return;

      
      const keyInput = $('new-group-key');
      const nameInput = $('new-group-name');
      if (keyInput) keyInput.value = '';
      if (nameInput) nameInput.value = '';

      
      try {
        const response = await fetch('/auth/admin/list_groups', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (result.success && result.groups) {
          
          const firstGroup = Object.values(result.groups)[0];
          if (firstGroup && firstGroup.permissions) {
            const permissionsContainer = $('create-group-permissions');
            if (permissionsContainer) {
              permissionsContainer.innerHTML = Object.keys(firstGroup.permissions).map(perm => `
                <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}">
                  <span class="text-sm text-slate-700">${translatePermission(perm)}</span>
                </label>
              `).join('');
            }
          }
        }
      } catch (e) {
        logMessage_Error('åŠ è½½æƒé™åˆ—è¡¨å¤±è´¥:', e);
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    
    function showSchoolAccountsModal() {
      const modal = $('school-accounts-modal');
      if (modal) {
        modal.style.display = 'flex';
        loadSchoolAccounts();
      }
    }

    function closeSchoolAccountsModal() {
      const modal = $('school-accounts-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    
    async function loadSchoolAccounts() {
      
      const content = $('school-accounts-content');
      if (!content) return; 

      
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const response = await fetch('/auth/admin/get_all_users_school_accounts', {
          headers: {
            'X-Session-ID': sessionUUID 
          }
        });

        
        const data = await response.json();

        
        if (!data.success) {
          
          content.innerHTML = `<p class="text-red-500 text-center py-10">${data.message || 'åŠ è½½å¤±è´¥'}</p>`;
          return;
        }

        
        const allAccounts = data.all_accounts;

        
        if (Object.keys(allAccounts).length === 0) {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— æ•°æ®</p>';
          return;
        }

        
        let html = '';

        
        for (const [authUsername, accounts] of Object.entries(allAccounts)) {
          
          const accountCount = Object.keys(accounts).length;

          
          html += `
            <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
              
              <div class="flex justify-between items-center mb-3">
                <h4 class="font-semibold text-slate-800">
                  è®¤è¯ç”¨æˆ·: ${escapeHtml(authUsername)} 
                  <span class="text-sm text-slate-500">(${accountCount} ä¸ªå­¦æ ¡è´¦æˆ·)</span>
                </h4>
                
                <button 
                  onclick="openSchoolAccountModal('${escapeHtml(authUsername)}')"
                  class="px-4 py-2 rounded-lg text-sm font-medium text-sky-600 bg-white border border-sky-300 hover:bg-sky-50 hover:border-sky-400 transition-all flex items-center gap-2"
                  style="box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1), -1px -1px 2px rgba(255, 255, 255, 0.8);"
                  title="ä¸ºæ­¤ç”¨æˆ·æ·»åŠ æ–°çš„å­¦æ ¡è´¦å·">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  æ·»åŠ è´¦æˆ·
                </button>
              </div>
              
              
              <div class="space-y-2">
          `;

          
          if (accountCount === 0) {
            
            html += '<p class="text-slate-400 text-sm">æš‚æ— å­¦æ ¡è´¦æˆ·ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ è´¦æˆ·"æŒ‰é’®å¼€å§‹æ·»åŠ </p>';
          } else {
            
            for (const [schoolUsername, accountData] of Object.entries(accounts)) {
              
              let password = '';
              let ua = '';

              
              if (typeof accountData === 'string') {
                
                password = accountData;
              } else if (typeof accountData === 'object' && accountData !== null) {
                
                password = accountData.password || '';
                ua = accountData.ua || '';
              }

              
              html += `
                <div class="bg-white p-3 rounded border border-slate-200 space-y-2">
                  
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-slate-700">${escapeHtml(schoolUsername)}</span>
                    
                    
                    <div class="flex gap-2">
                      
                      <button 
                        onclick="openSchoolAccountModal('${escapeHtml(authUsername)}', '${escapeHtml(schoolUsername)}', '${escapeHtml(password)}', '${escapeHtml(ua)}')"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium text-blue-600 bg-white border border-blue-300 hover:bg-blue-50 hover:border-blue-400 transition-all flex items-center gap-1"
                        style="box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.08), -0.5px -0.5px 1px rgba(255, 255, 255, 0.8);"
                        title="ç¼–è¾‘æ­¤å­¦æ ¡è´¦å·">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        ç¼–è¾‘
                      </button>
                      
                      
                      <button 
                        onclick="deleteSchoolAccount('${escapeHtml(authUsername)}', '${escapeHtml(schoolUsername)}')"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium text-red-600 bg-white border border-red-300 hover:bg-red-50 hover:border-red-400 transition-all flex items-center gap-1"
                        style="box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.08), -0.5px -0.5px 1px rgba(255, 255, 255, 0.8);"
                        title="åˆ é™¤æ­¤å­¦æ ¡è´¦å·">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        åˆ é™¤
                      </button>
                    </div>
                  </div>
                  
                  
                  <div class="text-sm">
                    <span class="text-slate-500">å¯†ç :</span>
                    <span class="font-mono text-slate-600 ml-2">${escapeHtml(password)}</span>
                  </div>
                  
                  
                  ${ua ? `
                  <div class="text-sm">
                    <span class="text-slate-500">UA:</span>
                    <span class="font-mono text-xs text-slate-600 ml-2 break-all">${escapeHtml(ua)}</span>
                  </div>
                  ` : ''}
                </div>
              `;
            }
          }

          
          html += `
              </div>
            </div>
          `;
        }

        
        content.innerHTML = html;

      } catch (error) {
        
        console.error('åŠ è½½ school accounts å¤±è´¥:', error);
        content.innerHTML = '<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
      }
    }

    
    function openSchoolAccountModal(authUsername, schoolUsername = '', password = '', ua = '') {
      
      const modal = $('edit-school-account-modal');
      if (!modal) {
        logMessage_Error('School Account ç¼–è¾‘æ¨¡æ€æ¡†ä¸å­˜åœ¨');
        return;
      }

      
      const authUsernameInput = $('edit-school-account-auth-username');
      const schoolUsernameInput = $('edit-school-account-school-username');
      const passwordInput = $('edit-school-account-password');
      const uaInput = $('edit-school-account-ua');
      const originalUsernameInput = $('edit-school-account-original-username');
      const modalTitle = $('edit-school-account-modal-title');

      
      if (!authUsernameInput || !schoolUsernameInput || !passwordInput || !uaInput || !originalUsernameInput) {
        logMessage_Error('School Account ç¼–è¾‘è¡¨å•å…ƒç´ ä¸å®Œæ•´');
        return;
      }

      
      authUsernameInput.value = authUsername; 
      schoolUsernameInput.value = schoolUsername; 
      passwordInput.value = password; 
      uaInput.value = ua; 
      originalUsernameInput.value = schoolUsername; 

      
      if (schoolUsername) {
        
        if (modalTitle) modalTitle.textContent = 'ç¼–è¾‘ School Account';
        schoolUsernameInput.readOnly = true; 
        schoolUsernameInput.classList.add('bg-slate-100', 'cursor-not-allowed'); 
      } else {
        
        if (modalTitle) modalTitle.textContent = 'æ·»åŠ  School Account';
        schoolUsernameInput.readOnly = false; 
        schoolUsernameInput.classList.remove('bg-slate-100', 'cursor-not-allowed'); 
      }

      
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      
      
      setTimeout(() => {
        if (schoolUsername) {
          passwordInput.focus(); 
        } else {
          schoolUsernameInput.focus(); 
        }
      }, 300); 
    }

    
    function closeEditSchoolAccountModal() {
      
      const modal = $('edit-school-account-modal');
      if (!modal) return; 

      
      modal.classList.add('hidden');
      modal.classList.remove('flex');

      
      const authUsernameInput = $('edit-school-account-auth-username');
      const schoolUsernameInput = $('edit-school-account-school-username');
      const passwordInput = $('edit-school-account-password');
      const uaInput = $('edit-school-account-ua');
      const originalUsernameInput = $('edit-school-account-original-username');

      if (authUsernameInput) authUsernameInput.value = '';
      if (schoolUsernameInput) {
        schoolUsernameInput.value = '';
        schoolUsernameInput.readOnly = false; 
        schoolUsernameInput.classList.remove('bg-slate-100', 'cursor-not-allowed'); 
      }
      if (passwordInput) passwordInput.value = '';
      if (uaInput) uaInput.value = '';
      if (originalUsernameInput) originalUsernameInput.value = '';
    }

    
    async function submitSchoolAccount() {
      
      const authUsernameInput = $('edit-school-account-auth-username');
      const schoolUsernameInput = $('edit-school-account-school-username');
      const passwordInput = $('edit-school-account-password');
      const uaInput = $('edit-school-account-ua');
      const originalUsernameInput = $('edit-school-account-original-username');

      
      if (!authUsernameInput || !schoolUsernameInput || !passwordInput || !uaInput || !originalUsernameInput) {
        showModalAlert('è¡¨å•å…ƒç´ ä¸å®Œæ•´ï¼Œæ— æ³•æäº¤', 'é”™è¯¯');
        return;
      }

      
      const authUsername = authUsernameInput.value.trim(); 
      const schoolUsername = schoolUsernameInput.value.trim(); 
      const password = passwordInput.value.trim(); 
      const ua = uaInput.value.trim(); 
      const originalUsername = originalUsernameInput.value.trim(); 

      
      if (!authUsername) {
        showModalAlert('è®¤è¯ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'éªŒè¯å¤±è´¥');
        return;
      }

      if (!schoolUsername) {
        showModalAlert('å­¦æ ¡è´¦å·ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'éªŒè¯å¤±è´¥');
        schoolUsernameInput.focus(); 
        return;
      }

      if (!password) {
        showModalAlert('å¯†ç ä¸èƒ½ä¸ºç©º', 'éªŒè¯å¤±è´¥');
        passwordInput.focus(); 
        return;
      }

      
      const data = {
        auth_username: authUsername, 
        school_username: schoolUsername, 
        password: password, 
        ua: ua || null 
      };

      
      if (originalUsername) {
        data.original_username = originalUsername;
      }

      try {
        
        
        const result = await callPythonAPI_raw('/api/admin/school_account/save', 'POST', data);

        
        if (result.success) {
          
          showModalAlert(
            originalUsername ? 'å­¦æ ¡è´¦å·æ›´æ–°æˆåŠŸ' : 'å­¦æ ¡è´¦å·æ·»åŠ æˆåŠŸ',
            'æˆåŠŸ'
          );

          
          closeEditSchoolAccountModal();

          
          loadSchoolAccounts();
        } else {
          
          showModalAlert(result.message || 'ä¿å­˜å¤±è´¥', 'é”™è¯¯');
        }
      } catch (error) {
        
        logMessage_Error('ä¿å­˜ School Account å¤±è´¥:', error);
        showModalAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥: ' + error.message, 'é”™è¯¯');
      }
    }

    
    async function deleteSchoolAccount(authUsername, schoolUsername) {
      
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤åˆ é™¤',
        `æ‚¨ç¡®å®šè¦åˆ é™¤å­¦æ ¡è´¦å· "${schoolUsername}" å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`
      );

      
      if (!confirmed) {
        return;
      }

      try {
        
        const result = await callPythonAPI_raw('/api/admin/school_account/delete', 'POST', {
          auth_username: authUsername, 
          school_username: schoolUsername 
        });

        
        if (result.success) {
          
          showModalAlert('å­¦æ ¡è´¦å·åˆ é™¤æˆåŠŸ', 'æˆåŠŸ');

          
          loadSchoolAccounts();
        } else {
          
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (error) {
        
        logMessage_Error('åˆ é™¤ School Account å¤±è´¥:', error);
        showModalAlert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥: ' + error.message, 'é”™è¯¯');
      }
    }


    function closeCreateGroupModal() {
      const modal = $('create-group-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    async function submitCreateGroup() {
      const keyInput = $('new-group-key');
      const nameInput = $('new-group-name');

      if (!keyInput || !nameInput) return;

      const groupKey = keyInput.value.trim();
      const groupName = nameInput.value.trim();

      if (!groupKey || !nameInput) {
        showModalAlert('è¯·å¡«å†™æƒé™ç»„é”®åå’Œåç§°', 'é”™è¯¯');
        return;
      }

      
      const permissionsContainer = $('create-group-permissions');
      if (!permissionsContainer) return;

      const permissions = {};
      const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const perm = cb.getAttribute('data-permission');
        permissions[perm] = cb.checked;
      });

      try {
        const response = await fetch('/auth/admin/create_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            group_key: groupKey,
            group_name: groupName,
            permissions: permissions
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`æƒé™ç»„ ${groupName} åˆ›å»ºæˆåŠŸ`, 'æˆåŠŸ');
          closeCreateGroupModal();
          loadAdminGroups();
        } else {
          showModalAlert(result.message || 'åˆ›å»ºå¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function loadAdminUsers() {
      try {
        const response = await fetch('/auth/admin/list_users', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          $('admin-users-list').innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const listEl = $('admin-users-list_modal');
        if (result.users.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç”¨æˆ·</p>';
          return;
        }

        
        const groupsResp = await fetch('/auth/admin/list_groups', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const groupsData = await groupsResp.json();
        const groups = groupsData.success ? Object.keys(groupsData.groups) : ['guest', 'user', 'admin'];

        listEl.innerHTML = result.users.map(user => {
          const createdDate = new Date(user.created_at * 1000).toLocaleString();
          const lastLoginDate = user.last_login ? new Date(user.last_login * 1000).toLocaleString() : 'ä»æœªç™»å½•';
          const isBanned = user.banned || false;
          const bannedBadge = isBanned ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2">å·²å°ç¦</span>' : '';

          const groupSelect = `
        <select class="text-sm border border-slate-300 rounded px-2 py-1" onchange="updateUserGroup('${user.auth_username}', this.value)">
          ${groups.map(g => `<option value="${g}" ${g === user.group ? 'selected' : ''}>${g}</option>`).join('')}
        </select>
      `;

          return `
        <div class="border border-slate-200 rounded-lg p-3 mb-2">
          <div class="flex justify-between items-start gap-3">
            <div class="flex items-start gap-3 flex-1">
              <div id="avatar-${user.auth_username}" class="flex-shrink-0 w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden border-2 border-slate-300">
                <span class="text-2xl text-slate-400">ğŸ‘¤</span>
              </div>
              <div class="flex-1">
                <p class="font-semibold text-slate-800">${user.auth_username}${bannedBadge}</p>
                <p class="text-xs text-slate-500">æ˜µç§°: ${user.nickname || 'æœªè®¾ç½®'}</p>
                <p class="text-xs text-slate-500">æ‰‹æœºå·: ${user.phone || 'æœªç»‘å®š'}</p>
                <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                <p class="text-xs text-slate-500">æœ€åç™»å½•: ${lastLoginDate}</p>
                <p class="text-xs text-slate-500">ç™»å½•IP: ${user.last_login_ip || 'æ— è®°å½•'} (${user.last_login_city || 'æœªçŸ¥'})</p>
                <p class="text-xs text-slate-500">ä¼šè¯é™åˆ¶: ${user.max_sessions === -1 ? 'æ— é™åˆ¶' : user.max_sessions + 'ä¸ª'}</p>
                <p class="text-xs ${(user['2fa_enabled'] || user.tfa_enabled) ? 'text-green-600' : 'text-slate-400'}">2FA: ${(user['2fa_enabled'] || user.tfa_enabled) ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</p>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="text-xs text-slate-600">æƒé™ç»„:</span>
              ${groupSelect}
              <div class="flex flex-col gap-1.5 mt-2" id="user-actions-${user.auth_username}">
                <div class="flex gap-1 flex-wrap justify-end">
                  <button class="btn btn-secondary !py-0.5 !px-2 !text-xs" onclick="showUserSchoolAccounts('${user.auth_username}')">è´¦æˆ·å¯†ç </button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="showUserLogs('${user.auth_username}')">æŸ¥çœ‹æ—¥å¿—</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="manageUserPermissions('${user.auth_username}')">æƒé™</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="setUserMaxSessions('${user.auth_username}', ${user.max_sessions || 1})">ä¼šè¯</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="modifyUserNickname('${user.auth_username}', '${escapeHtml(user.nickname || '')}')">ä¿®æ”¹æ˜µç§°</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="modifyUserPhone('${user.auth_username}', '${user.phone || ''}')">ä¿®æ”¹æ‰‹æœº</button>
                  <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="resetUserPassword('${user.auth_username}')">é‡ç½®å¯†ç </button>
                </div>
                <div class="flex gap-1 flex-wrap justify-end">
                  ${(user['2fa_enabled'] || user.tfa_enabled) ? `<button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="forceDisable2FA('${user.auth_username}')">å…³é—­2FA</button>` : ''}
                  ${isBanned ?
              `<button class="btn btn-success !py-0.5 !px-2 !text-xs" onclick="unbanUser('${user.auth_username}')">è§£å°</button>` :
              `<button class="btn btn-warning !py-0.5 !px-2 !text-xs" onclick="banUser('${user.auth_username}')">å°ç¦</button>`
            }
                  <button class="btn btn-warning !py-0.5 !px-2 !text-xs" onclick="clearUserAvatar('${user.auth_username}')">æ¸…é™¤å¤´åƒ</button>
                  <button class="btn btn-danger !py-0.5 !px-2 !text-xs" onclick="deleteUser('${user.auth_username}')">åˆ é™¤</button>
                </div>
              </div>
          </div>
        </div>
      </div>
      `;
        }).join('');

        
        result.users.forEach(user => {
          loadUserAvatar(user.auth_username);
        });
      } catch (e) {
        $('admin-users-list').innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    async function updateUserGroup(username, newGroup) {
      try {
        const response = await fetch('/auth/admin/update_user_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            target_username: username,
            new_group: newGroup
          })
        });

        const result = await response.json();
        if (result.success) {
          logMessage_Info(`ç”¨æˆ· ${username} çš„æƒé™ç»„å·²æ›´æ–°ä¸º ${newGroup}`);
        } else {
          
          showModalAlert(`æ›´æ–°å¤±è´¥: ${result.message}`, 'æ“ä½œå¤±è´¥');
          loadAdminUsers(); 
        }
      } catch (e) {
        
        showModalAlert(`æ›´æ–°å¤±è´¥: ${e.message}`, 'ç½‘ç»œé”™è¯¯');
        loadAdminUsers();
      }
    }

    
    
    
    async function banUser(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤å°ç¦', `ç¡®å®šè¦å°ç¦ç”¨æˆ· ${username} å—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/ban_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} å·²è¢«å°ç¦`, 'æˆåŠŸ');
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'å°ç¦å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function unbanUser(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤è§£å°', `ç¡®å®šè¦è§£å°ç”¨æˆ· ${username} å—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/unban_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} å·²è§£å°`, 'æˆåŠŸ');
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'è§£å°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function forceDisable2FA(username) {
      const confirmed = await jsShowConfirm('å¼ºåˆ¶å…³é—­2FA', `ç¡®å®šè¦ä¸ºç”¨æˆ· ${username} å…³é—­åŒå› ç´ è®¤è¯å—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/force_disable_2fa', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            target_username: username
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„2FAå·²å…³é—­`, 'æˆåŠŸ');
          loadAdminUsers(); 
        } else {
          showModalAlert(result.message || 'æ“ä½œå¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function resetUserPassword(username) {
      
      const newPassword = await new Promise((resolve) => {
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">é‡ç½®å¯†ç  - ${username}</h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 mb-2">æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</label>
              <input type="password" id="reset-password-input" class="input-field w-full" placeholder="è¾“å…¥æ–°å¯†ç ">
            </div>
            <div class="flex gap-2 justify-end">
              <button class="btn btn-ghost" onclick="this.closest('.fixed').remove()">å–æ¶ˆ</button>
              <button class="btn btn-primary" id="confirm-reset-password">ç¡®è®¤é‡ç½®</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const confirmBtn = modal.querySelector('#confirm-reset-password');
        const passwordInput = modal.querySelector('#reset-password-input');

        confirmBtn.onclick = () => {
          const password = passwordInput.value;
          if (!password || password.length < 6) {
            showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
            return;
          }
          modal.remove();
          resolve(password);
        };
      });

      if (!newPassword) return;

      try {
        const response = await fetch('/auth/admin/force_reset_password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            target_username: username,
            new_password: newPassword
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„å¯†ç å·²é‡ç½®`, 'æˆåŠŸ');
        } else {
          showModalAlert(result.message || 'é‡ç½®å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function deleteUser(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/delete_user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} å·²åˆ é™¤`, 'æˆåŠŸ');
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function loadUserAvatar(username) {
      try {
        const response = await fetch(`/auth/user/avatar?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const result = await response.json();
        const avatarDiv = document.getElementById(`avatar-${username}`);

        if (!avatarDiv) return;

        if (result.success && result.avatar_url) {
          
          const avatarUrlWithSession = `${result.avatar_url}?session_id=${sessionUUID}`;
          avatarDiv.innerHTML = `<img src="${avatarUrlWithSession}" alt="${username}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="text-2xl text-slate-400" style="display:none;">ğŸ‘¤</span>`;
        } else {
          avatarDiv.innerHTML = `<span class="text-2xl text-slate-400">ğŸ‘¤</span>`;
        }
      } catch (e) {
        logMessage_Error(`åŠ è½½ç”¨æˆ·å¤´åƒå¤±è´¥ ${username}:`, e);
      }
    }

    async function clearUserAvatar(username) {
      const confirmed = await jsShowConfirm('ç¡®è®¤æ¸…é™¤å¤´åƒ', `ç¡®å®šè¦æ¸…é™¤ç”¨æˆ· ${username} çš„å¤´åƒå—ï¼Ÿ`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/clear_user_avatar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`å·²æ¸…é™¤ç”¨æˆ· ${username} çš„å¤´åƒ`, 'æˆåŠŸ');
          
          loadUserAvatar(username);
        } else {
          showModalAlert(result.message || 'æ¸…é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function setUserMaxSessions(username, currentMax) {
      
      $('sessions-username').textContent = username;
      $('sessions-current-max').textContent = currentMax === -1 ? 'æ— é™åˆ¶' : currentMax;
      $('new-max-sessions').value = currentMax === -1 ? 0 : currentMax;

      
      showModal('set-max-sessions-modal');
    }

    async function submitSetMaxSessions() {
      const username = $('sessions-username').textContent;
      const newMaxInput = $('new-max-sessions');
      const newMax = parseInt(newMaxInput.value);

      if (isNaN(newMax) || newMax < 0) {
        showModalAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆ0æˆ–æ›´å¤§ï¼‰', 'é”™è¯¯');
        return;
      }

      
      const maxSessions = newMax === 0 ? -1 : newMax;

      try {
        const response = await fetch('/auth/admin/update_max_sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username, max_sessions: maxSessions })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`å·²æ›´æ–°ç”¨æˆ· ${username} çš„æœ€å¤§ä¼šè¯æ•°ä¸º: ${maxSessions === -1 ? 'æ— é™åˆ¶' : maxSessions}`, 'æˆåŠŸ');
          hideModal('set-max-sessions-modal');
          loadAdminUsers();
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function showUserSchoolAccounts(username) {
      
      
      
      

      try {
        
        
        
        const response = await fetch(`/auth/admin/get_user_school_accounts?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID  
          }
        });

        
        const result = await response.json();

        
        if (!result.success) {
          
          showModalAlert(result.message || 'åŠ è½½å¤±è´¥', 'é”™è¯¯');
          return;
        }

        
        
        const accounts = result.accounts || {};
        
        const accountCount = Object.keys(accounts).length;

        
        
        $('school-accounts-username').textContent = username;
        
        $('school-accounts-count').textContent = accountCount;

        
        const listContainer = $('school-accounts-list');

        
        if (accountCount === 0) {
          
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">è¯¥ç”¨æˆ·æš‚æ— å­¦æ ¡è´¦æˆ·</p>';
        } else {
          
          let html = '';

          
          for (const [schoolUsername, accountData] of Object.entries(accounts)) {
            
            
            
            let password = '';  
            let ua = '';  

            if (typeof accountData === 'string') {
              
              password = accountData;
            } else if (typeof accountData === 'object' && accountData !== null) {
              
              password = accountData.password || '';
              ua = accountData.ua || '';
            }

            
            
            
            
            const accountDataJson = JSON.stringify({
              authUsername: username,
              schoolUsername: schoolUsername,
              password: password,
              ua: ua
            });

            
            
            html += `
              <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-slate-800 text-lg">${escapeHtml(schoolUsername)}</div>
                  
                  <div class="flex gap-2">
                    
                    
                    <button 
                      class="btn btn-sm btn-primary !py-1 !px-3 !text-xs" 
                      data-account='${escapeHtml(accountDataJson)}'
                      onclick="(function(btn) { const data = JSON.parse(btn.getAttribute('data-account')); editSchoolAccount(data.authUsername, data.schoolUsername, data.password, data.ua); })(this)"
                      title="ç¼–è¾‘æ­¤è´¦æˆ·">
                      ç¼–è¾‘
                    </button>
                    
                    
                    <button 
                      class="btn btn-sm btn-danger !py-1 !px-3 !text-xs" 
                      data-auth-username='${escapeHtml(username)}'
                      data-school-username='${escapeHtml(schoolUsername)}'
                      onclick="(function(btn) { deleteSchoolAccount(btn.getAttribute('data-auth-username'), btn.getAttribute('data-school-username')); })(this)"
                      title="åˆ é™¤æ­¤è´¦æˆ·">
                      åˆ é™¤
                    </button>
                  </div>
                </div>
                
                
                <div class="text-sm">
                  <span class="text-slate-500">å¯†ç :</span>
                  <span class="font-mono text-slate-700 ml-2 select-all">${escapeHtml(password)}</span>
                </div>
                
                
                ${ua ? `
                <div class="text-sm">
                  <span class="text-slate-500">User-Agent:</span>
                  <div class="font-mono text-xs text-slate-600 mt-1 p-2 bg-white rounded break-all select-all">${escapeHtml(ua)}</div>
                </div>
                ` : ''}
              </div>
            `;
          }

          
          listContainer.innerHTML = html;
        }

        
        
        showModal('manage-school-accounts-modal');

      } catch (error) {
        
        
        console.error('showUserSchoolAccounts error:', error);
        showModalAlert('åŠ è½½å¤±è´¥: ' + error.message, 'é”™è¯¯');
      }
    }

    
    function closeManageSchoolAccountsModal() {
      
      hideModal('manage-school-accounts-modal');
    }

    
    function editSchoolAccount(authUsername, schoolUsername, password, ua) {
      
      
      

      
      
      
      
      

      
      
      const authUsernameField = $('edit-school-account-auth-username');
      const schoolUsernameField = $('edit-school-account-school-username');

      if (authUsernameField) {
        authUsernameField.value = authUsername;  
      }

      if (schoolUsernameField) {
        schoolUsernameField.value = schoolUsername;  
      }

      
      
      const passwordField = $('edit-school-account-password');
      const uaField = $('edit-school-account-ua');

      if (passwordField) {
        passwordField.value = password;  
      }

      if (uaField) {
        uaField.value = ua || '';  
      }

      
      
      const authUsernameSpan = $('edit-auth-username');
      const schoolUsernameSpan = $('edit-school-username');
      const passwordInput = $('edit-school-password');
      const uaTextarea = $('edit-school-ua');

      if (authUsernameSpan) {
        authUsernameSpan.textContent = authUsername;
      }

      if (schoolUsernameSpan) {
        schoolUsernameSpan.textContent = schoolUsername;
      }

      if (passwordInput) {
        passwordInput.value = password;
      }

      if (uaTextarea) {
        uaTextarea.value = ua || '';
      }

      
      
      showModal('edit-school-account-modal');
    }

    
    function addNewSchoolAccount() {
      
      
      
      

      
      
      const currentAuthUsername = $('school-accounts-username')?.textContent || '';

      
      
      const authUsernameField = $('edit-school-account-auth-username');
      const schoolUsernameField = $('edit-school-account-school-username');
      const passwordField = $('edit-school-account-password');
      const uaField = $('edit-school-account-ua');

      if (authUsernameField) {
        authUsernameField.value = currentAuthUsername;  
      }

      if (schoolUsernameField) {
        schoolUsernameField.value = '';  
        schoolUsernameField.readOnly = false;  
      }

      if (passwordField) {
        passwordField.value = '';  
      }

      if (uaField) {
        uaField.value = '';  
      }

      
      const authUsernameSpan = $('edit-auth-username');
      const schoolUsernameSpan = $('edit-school-username');
      const passwordInput = $('edit-school-password');
      const uaTextarea = $('edit-school-ua');

      if (authUsernameSpan) {
        authUsernameSpan.textContent = currentAuthUsername;
      }

      if (schoolUsernameSpan) {
        schoolUsernameSpan.textContent = '';
      }

      if (passwordInput) {
        passwordInput.value = '';
      }

      if (uaTextarea) {
        uaTextarea.value = '';
      }

      
      const modalTitle = $('edit-school-account-modal-title');
      if (modalTitle) {
        modalTitle.textContent = 'æ–°å¢å­¦æ ¡è´¦æˆ·';
      }

      
      
      showModal('edit-school-account-modal');

      console.log('[å­¦æ ¡è´¦æˆ·ç®¡ç†] å·²æ‰“å¼€æ–°å¢å­¦æ ¡è´¦æˆ·æ¨¡æ€æ¡†');
    }

    
    async function generateRandomUAForSchoolAccount() {
      
      
      
      
      

      try {
        
        
        console.log('[å­¦æ ¡è´¦æˆ·ç®¡ç†] å¼€å§‹ç”ŸæˆéšæœºUser-Agent...');

        
        
        const result = await callPythonAPI('generate_new_ua');

        
        if (!result) {
          console.error('[å­¦æ ¡è´¦æˆ·ç®¡ç†] ç”ŸæˆUAå¤±è´¥ï¼šAPIè¿”å›ç©ºç»“æœ');
          showTempMessage('ç”Ÿæˆå¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
          return;
        }

        
        
        const newUA = typeof result === 'string' ? result : result.ua;

        if (!newUA) {
          console.error('[å­¦æ ¡è´¦æˆ·ç®¡ç†] ç”ŸæˆUAå¤±è´¥ï¼šè¿”å›çš„UAä¸ºç©º');
          showTempMessage('ç”Ÿæˆå¤±è´¥ï¼šè¿”å›çš„User-Agentä¸ºç©º', 'error');
          return;
        }

        
        const uaField = $('edit-school-account-ua');
        if (uaField) {
          uaField.value = newUA;
          console.log('[å­¦æ ¡è´¦æˆ·ç®¡ç†] å·²ç”Ÿæˆå¹¶å¡«å……éšæœºUA:', newUA.substring(0, 50) + '...');
        }

        
        const uaTextarea = $('edit-school-ua');
        if (uaTextarea) {
          uaTextarea.value = newUA;
        }

        
        showTempMessage('å·²ç”ŸæˆéšæœºUser-Agent', 'success');

      } catch (error) {
        
        
        console.error('[å­¦æ ¡è´¦æˆ·ç®¡ç†] ç”ŸæˆUAæ—¶å‘ç”Ÿé”™è¯¯:', error);
        showTempMessage('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
      }
    }

    
    function closeEditSchoolAccountModal() {
      
      hideModal('edit-school-account-modal');
    }

    
    async function submitEditSchoolAccount() {
      
      
      
      

      
      
      const authUsername = $('edit-auth-username').textContent;  
      const schoolUsername = $('edit-school-username').textContent;  
      const password = $('edit-school-password').value.trim();  
      const ua = $('edit-school-ua').value.trim();  

      
      if (!password) {
        
        showModalAlert('å¯†ç ä¸èƒ½ä¸ºç©º', 'é”™è¯¯');
        return;  
      }

      try {
        
        const response = await fetch('/api/admin/school_account/update', {
          method: 'POST',  
          headers: {
            'Content-Type': 'application/json',  
            'X-Session-ID': sessionUUID  
          },
          body: JSON.stringify({
            
            auth_username: authUsername,
            school_username: schoolUsername,
            password: password,
            ua: ua
          })
        });

        
        const result = await response.json();

        
        if (result.success) {
          
          showModalAlert(result.message || 'æ›´æ–°æˆåŠŸ', 'æˆåŠŸ');

          
          closeEditSchoolAccountModal();

          
          
          await showUserSchoolAccounts(authUsername);
        } else {
          
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }

      } catch (error) {
        
        
        console.error('submitEditSchoolAccount error:', error);
        showModalAlert('æ›´æ–°å¤±è´¥: ' + error.message, 'é”™è¯¯');
      }
    }

    
    async function deleteSchoolAccount(authUsername, schoolUsername) {
      
      
      
      

      
      
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤å­¦æ ¡è´¦æˆ· <strong>${escapeHtml(schoolUsername)}</strong> å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`
      );

      
      if (!confirmed) return;

      try {
        
        const response = await fetch('/api/admin/school_account/delete', {
          method: 'POST',  
          headers: {
            'Content-Type': 'application/json',  
            'X-Session-ID': sessionUUID  
          },
          body: JSON.stringify({
            
            auth_username: authUsername,
            school_username: schoolUsername
          })
        });

        
        const result = await response.json();

        
        if (result.success) {
          
          showModalAlert(result.message || 'åˆ é™¤æˆåŠŸ', 'æˆåŠŸ');

          
          
          await showUserSchoolAccounts(authUsername);
        } else {
          
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }

      } catch (error) {
        
        
        console.error('deleteSchoolAccount error:', error);
        showModalAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'é”™è¯¯');
      }
    }

    async function manageUserPermissions(username) {
      currentManageUsername = username;
      const modal = $('manage-user-permissions-modal');
      if (!modal) return;

      try {
        
        const response = await fetch('/auth/admin/get_user_permissions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ username: username })
        });
        const result = await response.json();

        if (!result.success) {
          showModalAlert('æ— æ³•åŠ è½½ç”¨æˆ·æƒé™ä¿¡æ¯', 'é”™è¯¯');
          return;
        }

        
        const nameEl = $('manage-user-name');
        const groupEl = $('user-base-group');
        if (nameEl) nameEl.textContent = username;
        if (groupEl) groupEl.textContent = result.group || 'guest';

        if (groupEl === 'super_admin') {
          showModalAlert('æ— æ³•ä¿®æ”¹è¶…çº§ç®¡ç†å‘˜çš„æƒé™', 'é”™è¯¯');
        }
        
        const permissionsContainer = $('manage-user-permissions-list');
        if (permissionsContainer && result.all_permissions) {
          const groupPerms = result.group_permissions || {};
          const addedPerms = result.added_permissions || {};
          const removedPerms = result.removed_permissions || {};

          permissionsContainer.innerHTML = Object.keys(result.all_permissions).map(perm => {
            const groupHas = groupPerms[perm] || false;
            const isAdded = addedPerms[perm] === true;
            const isRemoved = removedPerms[perm] === true;
            const currentValue = result.all_permissions[perm];

            let statusClass = '';
            let statusText = '';
            if (isAdded) {
              statusClass = 'bg-green-50 border-green-200';
              statusText = '(æ–°å¢)';
            } else if (isRemoved) {
              statusClass = 'bg-red-50 border-red-200';
              statusText = '(ç§»é™¤)';
            }

            return `
              <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer border ${statusClass}">
                <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}" data-group-value="${groupHas}" ${currentValue ? 'checked' : ''}>
                <span class="text-sm text-slate-700 flex-1">${translatePermission(perm)}</span>
                ${statusText ? `<span class="text-xs ${isAdded ? 'text-green-600' : 'text-red-600'}">${statusText}</span>` : ''}
              </label>
            `;
          }).join('');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } catch (e) {
        showModalAlert('åŠ è½½å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function closeManageUserPermissionsModal() {
      const modal = $('manage-user-permissions-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      currentManageUsername = null;
    }

    async function submitManageUserPermissions() {
      if (!currentManageUsername) return;

      const permissionsContainer = $('manage-user-permissions-list');
      if (!permissionsContainer) return;

      
      const addedPermissions = {};
      const removedPermissions = {};

      const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const perm = cb.getAttribute('data-permission');
        const groupValue = cb.getAttribute('data-group-value') === 'true';
        const currentValue = cb.checked;

        
        if (currentValue !== groupValue) {
          if (currentValue) {
            addedPermissions[perm] = true;
          } else {
            removedPermissions[perm] = true;
          }
        }
      });

      try {
        const response = await fetch('/auth/admin/set_user_permission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: currentManageUsername,
            added_permissions: addedPermissions,
            removed_permissions: removedPermissions
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${currentManageUsername} çš„æƒé™å·²æ›´æ–°`, 'æˆåŠŸ');
          closeManageUserPermissionsModal();
          loadAdminUsers();

        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function showResetPasswordModal(username) {
      
      $('reset-password-username').textContent = username;
      
      $('reset-new-password').value = '';
      $('reset-confirm-password').value = '';
      
      showModal('reset-user-password-modal');
    }

    async function submitResetUserPassword() {
      const username = $('reset-password-username').textContent;
      const newPassword = $('reset-new-password').value;
      const confirmPassword = $('reset-confirm-password').value;

      if (!newPassword || !confirmPassword) {
        showModalAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'æç¤º');
        return;
      }

      if (newPassword.length < 6) {
        showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      if (newPassword !== confirmPassword) {
        showModalAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'é”™è¯¯');
        return;
      }

      try {
        const response = await fetch('/auth/admin/reset_password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username,
            new_password: newPassword
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„å¯†ç å·²é‡ç½®`, 'æˆåŠŸ');
          hideModal('reset-user-password-modal');
        } else {
          showModalAlert(result.message || 'å¯†ç é‡ç½®å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    
    
    
    function modifyUserPhone(username, currentPhone) {
      
      $('admin-modify-phone-username').value = username;
      $('admin-modify-phone-current').value = currentPhone || 'æœªç»‘å®š';
      $('admin-modify-phone-new').value = '';
      $('admin-modify-phone-code').value = '';
      $('admin-modify-phone-modal').classList.remove('hidden');

      const adminCurrentPhoneInput = $('admin-modify-phone-current');
      const adminCurrentPhoneWrapper = adminCurrentPhoneInput ? adminCurrentPhoneInput.closest('.phone-input-wrapper') : null;
      if (adminCurrentPhoneWrapper) {
        const prefix = adminCurrentPhoneWrapper.querySelector('.phone-prefix');
        
        const isUnbound = (!adminCurrentPhoneInput.value || adminCurrentPhoneInput.value === 'æœªç»‘å®š');

        if (prefix) {
          prefix.style.display = isUnbound ? 'none' : 'inline';
        }
        
        adminCurrentPhoneWrapper.classList.toggle('prefix-hidden', isUnbound);
      }

    }

    function closeAdminModifyPhoneModal() {
      $('admin-modify-phone-modal').classList.add('hidden');
    }

    async function sendAdminModifyPhoneCode() {
      const newPhone = $('admin-modify-phone-new').value.trim();
      if (!newPhone || !/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
      }

      const sendBtn = $('admin-modify-phone-send-btn');
      sendBtn.disabled = true;
      const originalText = sendBtn.textContent;

      try {
        
        const response = await fetch('/api/sms/send_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: newPhone,
            scene: 'modify' 
          })
        });
        const result = await response.json();

        if (result && result.success) {
          const expireMin = result.expire_minutes || 5;
          const retryAfter = result.retry_after || 180;
          showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

          
          let countdown = retryAfter;
          const timer = setInterval(() => {
            countdown--;
            sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            if (countdown <= 0) {
              clearInterval(timer);
              sendBtn.disabled = false;
              sendBtn.textContent = originalText;
            }
          }, 1000);
        } else {
          if (result?.retry_after) {
            let countdown = result.retry_after;
            sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            const timer = setInterval(() => {
              countdown--;
              sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
              if (countdown <= 0) {
                clearInterval(timer);
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
              }
            }, 1000);
          } else {
            sendBtn.disabled = false;
          }
          showModalAlert(result?.message || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        sendBtn.disabled = false;
        showModalAlert('å‘é€å¤±è´¥: ' + error.message);
      }
    }

    async function submitAdminModifyPhone() {
      const username = $('admin-modify-phone-username').value;
      const newPhone = $('admin-modify-phone-new').value.trim();
      const code = $('admin-modify-phone-code').value.trim();

      if (!newPhone) {
        showModalAlert('è¯·è¾“å…¥æ–°æ‰‹æœºå·');
        return;
      }

      if (!/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼');
        return;
      }

      
      try {
        const bindResult = await callPythonAPI_raw('/api/auth/check_phone', 'POST', { phone: newPhone });

        
        if (bindResult && bindResult.is_bound && bindResult.bound_to_user !== username) {
          
          const confirmed = await jsShowConfirm(
            'æ‰‹æœºå·å·²è¢«ç»‘å®š',
            `æ‚¨è¾“å…¥çš„æ–°æ‰‹æœºå· ${newPhone} å·²è¢«ç”¨æˆ· ${bindResult.bound_to_user} ç»‘å®šã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ\n\nå¦‚æœç»§ç»­ï¼Œè¯¥æ‰‹æœºå·å°†ä»åŸè´¦å·ä¸Šå¼ºåˆ¶è§£ç»‘å¹¶ç»‘å®šåˆ° ${username} è´¦å·ä¸Šã€‚`
          );

          if (!confirmed) {
            logMessage_Info("[ç®¡ç†å‘˜ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œå› ä¸ºæ‰‹æœºå·å·²è¢«ç»‘å®šã€‚");
            return; 
          }
          logMessage_Info("[ç®¡ç†å‘˜ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å·²ç¡®è®¤å¼ºåˆ¶è§£ç»‘ï¼Œç»§ç»­æ“ä½œ...");
        } else if (bindResult && bindResult.is_bound && bindResult.bound_to_user === username) {
          
          showModalAlert('æ­¤æ‰‹æœºå·å·²ç»‘å®šåˆ°è¯¥ç”¨æˆ·ã€‚', 'æç¤º');
          closeAdminModifyPhoneModal();
          return;
        }
        
        

      } catch (e) {
        logMessage_Error('æ£€æŸ¥æ‰‹æœºå·ç»‘å®šå¤±è´¥:', e);
        showModalAlert(`æ£€æŸ¥æ‰‹æœºå·å¤±è´¥: ${e.message}ï¼Œè¯·ç¨åé‡è¯•`, 'ç½‘ç»œé”™è¯¯');
        return; 
      }


      try {
        const response = await fetch('/auth/admin/update_user_phone', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: username,
            new_phone: newPhone,
            sms_code: code || ''
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„æ‰‹æœºå·å·²æ›´æ–°`, 'æˆåŠŸ');
          closeAdminModifyPhoneModal();
          loadAdminUsers();
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }


    
    function modifyUserNickname(username, currentNickname) {
      
      $('admin-modify-nickname-username').value = username;
      $('admin-modify-nickname-new').value = currentNickname || ''; 
      $('admin-modify-nickname-modal').classList.remove('hidden');
    }

    function closeAdminModifyNicknameModal() {
      $('admin-modify-nickname-modal').classList.add('hidden');
    }

    async function submitAdminModifyNickname() {
      const username = $('admin-modify-nickname-username').value;
      const newNickname = $('admin-modify-nickname-new').value.trim();

      if (!newNickname) {
        showModalAlert('è¯·è¾“å…¥æ–°æ˜µç§°');
        return;
      }

      try {
        
        const response = await fetch('/auth/admin/update_user_nickname', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            username: username,
            nickname: newNickname
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ç”¨æˆ· ${username} çš„æ˜µç§°å·²æ›´æ–°`, 'æˆåŠŸ');
          closeAdminModifyNicknameModal();
          loadAdminUsers(); 
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }


    
    
    
    
    
    async function deleteGroup(groupKey) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤æƒé™ç»„ ${groupKey} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/delete_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ group_key: groupKey })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`æƒé™ç»„ ${groupKey} å·²åˆ é™¤`, 'æˆåŠŸ');
          loadAdminGroups();
        } else {
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function editGroupPermissions(groupKey) {
      currentEditGroupKey = groupKey;
      if (groupKey === null || groupKey === undefined) return;
      if (groupKey === 'super_admin') {
        showModalAlert('æ— æ³•ç¼–è¾‘è¶…çº§ç®¡ç†å‘˜æƒé™ç»„', 'é”™è¯¯');
        return;
      }
      const modal = $('edit-group-permissions-modal');
      if (!modal) return;

      try {
        
        const response = await fetch('/auth/admin/list_groups', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (!result.success || !result.groups || !result.groups[groupKey]) {
          showModalAlert('æ— æ³•åŠ è½½æƒé™ç»„ä¿¡æ¯', 'é”™è¯¯');
          return;
        }

        const group = result.groups[groupKey];
        const nameEl = $('edit-group-name');
        if (nameEl) {
          nameEl.textContent = `${group.name} (${groupKey})`;
        }

        
        const permissionsContainer = $('edit-group-permissions-list');
        if (permissionsContainer && group.permissions) {
          permissionsContainer.innerHTML = Object.keys(group.permissions).map(perm => `
            <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer">
              <input type="checkbox" class="w-4 h-4 rounded" data-permission="${perm}" ${group.permissions[perm] ? 'checked' : ''}>
              <span class="text-sm text-slate-700">${translatePermission(perm)}</span>
            </label>
          `).join('');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } catch (e) {
        showModalAlert('åŠ è½½å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    function closeEditGroupPermissionsModal() {
      const modal = $('edit-group-permissions-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      currentEditGroupKey = null;
    }

    async function submitEditGroupPermissions() {
      if (!currentEditGroupKey) return;

      const permissionsContainer = $('edit-group-permissions-list');
      if (!permissionsContainer) return;

      
      const permissions = {};
      const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const perm = cb.getAttribute('data-permission');
        permissions[perm] = cb.checked;
      });

      try {
        const response = await fetch('/auth/admin/update_group', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            group_key: currentEditGroupKey,
            permissions: permissions
          })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`æƒé™ç»„ ${currentEditGroupKey} å·²æ›´æ–°`, 'æˆåŠŸ');
          closeEditGroupPermissionsModal();
          loadAdminGroups();
        } else {
          showModalAlert(result.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    async function loadAdminGroups() {
      try {
        const response = await fetch('/auth/admin/list_groups', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          $('admin-groups-list').innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const listEl = $('admin-groups-list_modal');
        const groups = result.groups;

        listEl.innerHTML = Object.keys(groups).map(groupKey => {
          const group = groups[groupKey];
          const perms = group.permissions;
          const isSystemGroup = group.system || ['guest', 'user', 'admin', 'super_admin'].includes(groupKey);
          const systemBadge = isSystemGroup ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-2">ç³»ç»Ÿé¢„è®¾</span>' : '';

          
          
          
          
          
          const escapedGroupKey = groupKey.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
          
          const displayGroupKey = groupKey.replace(/</g, '&lt;').replace(/>/g, '&gt;');

          return `
        <div class="border border-slate-200 rounded-lg p-4 mb-2">
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-semibold text-slate-800">${group.name} (${displayGroupKey})${systemBadge}</h5>
            <div class="flex gap-2">
              <button class="btn btn-ghost !py-0.5 !px-2 !text-xs" onclick="editGroupPermissions('${escapedGroupKey}')">ç¼–è¾‘æƒé™</button>
              ${!isSystemGroup ? `<button class="btn btn-danger !py-0.5 !px-2 !text-xs" onclick="deleteGroup('${escapedGroupKey}')">åˆ é™¤</button>` : ''}
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            ${Object.keys(perms).map(perm => `
              <div class="flex items-center gap-2">
                <span class="${perms[perm] ? 'text-green-600' : 'text-slate-400'}">${perms[perm] ? 'âœ“' : 'âœ—'}</span>
                <span class="text-slate-600">${translatePermission(perm)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
        }).join('');
      } catch (e) {
        $('admin-groups-list').innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    async function loadAdminSessions() {
      const listEl = $('admin-sessions-list_modal'); 

      
      if (!listEl) {
        logMessage_Error("loadAdminSessions: æ— æ³•æ‰¾åˆ°ä¼šè¯åˆ—è¡¨å®¹å™¨ 'admin-sessions-list_modal'ã€‚");
        
        showModalAlert("æ— æ³•åŠ è½½ä¼šè¯åˆ—è¡¨ï¼šç•Œé¢å…ƒç´ ä¸¢å¤±ã€‚", "é”™è¯¯");
        return; 
      }
      

      try {
        

        listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>'; 

        
        const godModeCheckbox = $('god-mode-checkbox_modal');
        const isGodMode = godModeCheckbox && godModeCheckbox.checked;

        let response;
        if (isGodMode) {
          
          response = await fetch('/auth/admin/all_sessions', {
            headers: {
              'X-Session-ID': sessionUUID
            }
          });
        } else {
          
          response = await fetch('/auth/user/sessions', {
            headers: {
              'X-Session-ID': sessionUUID
            }
          });
        }
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`; 
          return;
        }

        
        const sessions = result.sessions || [];

        
        const maxSessions = result.max_sessions !== undefined && result.max_sessions !== null ? result.max_sessions : -1;

        
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');

        
        if (isGodMode) {
          updateAdminSessionCountDisplay(validSessions.length, -1); 
        } else {
          updateAdminSessionCountDisplay(validSessions.length, maxSessions);
        }

        
        let html = '';
        const isGuest = currentUserIsGuest;
        if (!isGodMode) {
          if (!isGuest) {
            
            html = `
      <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-lg">
        <p class="text-sm text-slate-700 mb-2">é€‰æ‹©ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯</p>
        <button class="btn btn-primary w-full" onclick="createNewSessionFromPicker()">åˆ›å»ºæ–°ä¼šè¯</button>
      </div>
    `;
          } else {
            
            html = `
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-700">æ¸¸å®¢æ¨¡å¼ï¼šå½“å‰ä¼šè¯å¦‚ä¸‹ã€‚å¦‚éœ€ä½¿ç”¨å¤šä¸ªä¼šè¯ï¼Œè¯·æ³¨å†Œè´¦å·ã€‚</p>
      </div>
    `;
          }
        }

        if (validSessions.length === 0) {
          html += '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯</p>';
        } else {
          html += validSessions.map(session => {
            const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
            const isCurrent = session.is_current || session.session_id === sessionUUID;
            const sessionHash = session.session_hash || session.session_id.substring(0, 16);

            
            let ownerInfo = '';
            if (isGodMode) {
              if (session.username) {
                ownerInfo = `<p class="text-xs text-slate-500">åˆ›å»ºè€…: ${session.username}</p>`;
              } else {
                
                ownerInfo = `<p class="text-xs text-amber-600">åˆ›å»ºè€…: æ¸¸å®¢æ¨¡å¼</p>`;
              }
            }

            return `
          <div class="border ${isCurrent ? 'border-sky-500 bg-sky-50' : 'border-slate-200'} rounded-lg p-3 mb-2">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold text-slate-800 break-all">ä¼šè¯ ${session.session_id}</p>
                ${isCurrent ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2">(å½“å‰ä¼šè¯)</span></p>' : ''}
                <p class="text-xs text-slate-500">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                <p class="text-xs text-slate-500">çŠ¶æ€: ${session.is_multi_account_mode
                ? (session.login_success ? '<span class="font-semibold text-green-600">å·²ç™»å½•</span>' : '<span class="font-semibold ">æœªç™»å½•</span>')
                : (session.login_success ? '<span class="font-semibold text-green-600">å·²ç™»å½•</span>' : 'æœªç™»å½•')
              }</p>
                ${ownerInfo}
              </div>
              <div class="flex gap-2">
                ${!isCurrent ? `
                  <button class="btn btn-ghost !py-1 !px-2 text-xs" onclick="selectSession('${session.session_id}')">é€‰æ‹©</button>
                  <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" onclick="deleteSession('${session.session_id}')">åˆ é™¤</button>
                ` : ''}
                ${isGodMode ? `<button class="btn btn-danger !py-1 !px-2 text-xs" onclick="destroySession('${session.session_id}')">é”€æ¯</button>` : ''}
              </div>
            </div>
          </div>
        `;
          }).join('');
        } 

        listEl.innerHTML = html; 

      } catch (e) {
        
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    

    
    async function checkIPBanAndProceed(scope = 'all') {
      try {
        
        
        const response = await fetch('/api/admin/check_ip_ban', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ scope: scope })
        });

        const result = await response.json();

        
        return result.is_banned === true;
      } catch (err) {
        
        
        logMessage_Error('[IPå°ç¦æ£€æŸ¥] æ£€æŸ¥å¤±è´¥:', err);
        return false;
      }
    }

    async function loadMessages() {
      const listEl = $('admin-messages-list_modal');
      const guestFields = $('message-guest-fields');

      if (!listEl) {
        logMessage_Error("loadMessages: æ— æ³•æ‰¾åˆ°ç•™è¨€åˆ—è¡¨å®¹å™¨");
        return;
      }

      
      const isGuest = currentUserIsGuest;
      if (guestFields) {
        guestFields.style.display = isGuest ? 'block' : 'none';
      }

      
      const contentInput = $('message-content');
      const charCount = $('message-char-count');
      if (contentInput && charCount) {
        contentInput.addEventListener('input', () => {
          charCount.textContent = contentInput.value.length;
        });
      }

      try {
        listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

        const response = await fetch('/api/messages/list', {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const messages = result.messages || [];

        if (messages.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç•™è¨€</p>';
          return;
        }

        
        const canDeleteAny = await checkAdminPermission('delete_any_messages');
        const canDeleteOwn = await checkAdminPermission('delete_own_messages');
        
        const currentUsername = currentAuthUsername;

        const html = messages.map(msg => {
          
          const isOwnMessage = !msg.is_guest && msg.auth_username === currentUsername;
          
          const canDelete = canDeleteAny || (canDeleteOwn && isOwnMessage);
          
          const displayName = msg.nickname || msg.username || msg.auth_username || 'åŒ¿å';
          
          const date = new Date(msg.timestamp * 1000);
          const dateStr = date.toLocaleString('zh-CN');
          
          const rawAvatarUrl = msg.avatar_url || 'default_avatar.png';
          
          const ipCity = msg.ip_city || '';



          let finalAvatarSrc;
          if (rawAvatarUrl.startsWith('/api/avatar/')) {
            
            finalAvatarSrc = rawAvatarUrl;
          } else {
            
            finalAvatarSrc = `/api/avatar/${rawAvatarUrl}`;
          }

          
          
          if (typeof sessionUUID !== 'undefined' && sessionUUID) {
            
            if (finalAvatarSrc.includes('?')) {
              finalAvatarSrc += `&session_id=${sessionUUID}`;
            } else {
              finalAvatarSrc += `?session_id=${sessionUUID}`;
            }
          }

          return `
            <div class="bg-white border border-slate-200 rounded-lg p-4 space-y-2">
              <div class="flex justify-between items-start gap-3">
                
                <div class="flex gap-3 flex-1">
                  
                  <div class="flex-shrink-0 w-12 h-12 rounded-full bg-slate-200 overflow-hidden border-2 border-slate-300">
                    <img src="${finalAvatarSrc}" alt="å¤´åƒ" class="w-full h-full object-cover"
                      onerror="const p = this.parentElement; p.innerHTML='<span class=\\'text-2xl text-slate-400\\'>ğŸ‘¤</span>'; p.classList.add('flex', 'items-center', 'justify-center');">
                  </div>
                  
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-semibold text-slate-700">${escapeHtml(displayName)}</span>
                      ${msg.is_guest ? '<span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded">æ¸¸å®¢</span>' : ''}
                      ${ipCity ? `<span class="text-xs text-slate-500">æ¥è‡ª ${escapeHtml(ipCity)}</span>` : ''}
                    </div>
                    ${msg.email ? `<p class="text-xs text-slate-500">${escapeHtml(msg.email)}</p>` : ''}
                    <p class="text-xs text-slate-400">${dateStr}</p>
                  </div>
                </div>
                
                ${canDelete ? `
                  <button class="btn btn-ghost !py-1 !px-2 !text-red-600 text-xs" 
                    onclick="deleteMessage('${msg.id}')">åˆ é™¤</button>
                ` : ''}
              </div>
              
              <p class="text-slate-700 whitespace-pre-wrap break-words pl-15">${escapeHtml(msg.content)}</p>
            </div>
          `;
        }).join('');

        listEl.innerHTML = html;

      } catch (e) {
        logMessage_Error('åŠ è½½ç•™è¨€å¤±è´¥:', e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    async function postMessage() {
      
      
      
      
      const isBanned = await checkIPBanAndProceed('messages_only');
      if (isBanned) {
        
        showModalAlert('æ‚¨çš„IPå·²è¢«é™åˆ¶è®¿é—®ç•™è¨€åŠŸèƒ½', 'è®¿é—®è¢«æ‹’ç»');
        return;
      }

      const contentInput = $('message-content');
      const nicknameInput = $('message-nickname');
      const emailInput = $('message-email');
      const postBtn = $('post-message-btn');

      if (!contentInput || !postBtn) return;

      const content = contentInput.value.trim();
      const nickname = nicknameInput ? nicknameInput.value.trim() : '';
      const email = emailInput ? emailInput.value.trim() : '';

      if (!content) {
        showModalAlert('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'æç¤º');
        return;
      }

      const isGuest = currentUserData?.is_guest;

      if (isGuest) {
        if (!nickname) {
          showModalAlert('æ¸¸å®¢å¿…é¡»å¡«å†™æ˜µç§°', 'æç¤º');
          return;
        }
        if (!email) {
          showModalAlert('æ¸¸å®¢å¿…é¡»å¡«å†™é‚®ç®±', 'æç¤º');
          return;
        }
      }

      try {
        postBtn.disabled = true;
        postBtn.textContent = 'å‘è¡¨ä¸­...';

        const response = await fetch('/api/messages/post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            content: content,
            nickname: nickname,
            email: email
          })
        });

        const result = await response.json();

        if (result.success) {
          contentInput.value = '';
          if (nicknameInput) nicknameInput.value = '';
          if (emailInput) emailInput.value = '';
          const charCount = $('message-char-count');
          if (charCount) charCount.textContent = '0';

          showModalAlert('ç•™è¨€å‘è¡¨æˆåŠŸ', 'æˆåŠŸ');
          await loadMessages();
        } else {
          showModalAlert(result.message || 'å‘è¡¨ç•™è¨€å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error('å‘è¡¨ç•™è¨€å¤±è´¥:', e);
        showModalAlert('å‘è¡¨ç•™è¨€å¤±è´¥: ' + e.message, 'é”™è¯¯');
      } finally {
        postBtn.disabled = false;
        postBtn.textContent = 'å‘è¡¨ç•™è¨€';
      }
    }

    async function deleteMessage(messageId) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ');
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch('/api/messages/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            message_id: messageId
          })
        });

        const result = await response.json();

        if (result.success) {
          showModalAlert('ç•™è¨€å·²åˆ é™¤', 'æˆåŠŸ');
          await loadMessages();
        } else {
          showModalAlert(result.message || 'åˆ é™¤ç•™è¨€å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        logMessage_Error('åˆ é™¤ç•™è¨€å¤±è´¥:', e);
        showModalAlert('åˆ é™¤ç•™è¨€å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    
    
    
    

    
    
    function showUserLogs(username) {
      
      $('user-logs-secondary-modal').classList.remove('hidden');

      
      const usernameDisplay = $('current-log-username-secondary');
      if (usernameDisplay) usernameDisplay.textContent = username;

      
      const loginTab = $('log-tab-login-secondary');
      const auditTab = $('log-tab-audit-secondary');
      const loginContent = $('log-login-content-secondary');
      const auditContent = $('log-audit-content-secondary');

      if (loginTab) {
        loginTab.classList.add('text-sky-600', 'border-sky-600');
        loginTab.classList.remove('text-slate-400', 'border-transparent');
      }
      if (auditTab) {
        auditTab.classList.add('text-slate-400', 'border-transparent');
        auditTab.classList.remove('text-sky-600', 'border-sky-600');
      }
      if (loginContent) loginContent.classList.remove('hidden');
      if (auditContent) auditContent.classList.add('hidden');

      
      loadUserLoginLogsSecondary(username);
    }

    function closeUserLogsSecondaryModal() {
      $('user-logs-secondary-modal').classList.add('hidden');
    }

    function switchUserLogTab(tab) {
      const loginTab = $('log-tab-login-secondary');
      const auditTab = $('log-tab-audit-secondary');
      const loginContent = $('log-login-content-secondary');
      const auditContent = $('log-audit-content-secondary');
      const username = $('current-log-username-secondary').textContent;

      if (tab === 'login') {
        loginTab.classList.add('text-sky-600', 'border-sky-600');
        loginTab.classList.remove('text-slate-400', 'border-transparent');
        auditTab.classList.add('text-slate-400', 'border-transparent');
        auditTab.classList.remove('text-sky-600', 'border-sky-600');
        loginContent.classList.remove('hidden');
        auditContent.classList.add('hidden');
        loadUserLoginLogsSecondary(username);
      } else if (tab === 'audit') {
        auditTab.classList.add('text-sky-600', 'border-sky-600');
        auditTab.classList.remove('text-slate-400', 'border-transparent');
        loginTab.classList.add('text-slate-400', 'border-transparent');
        loginTab.classList.remove('text-sky-600', 'border-sky-600');
        auditContent.classList.remove('hidden');
        loginContent.classList.add('hidden');
        loadUserAuditLogsSecondary(username);
      }
    }

    
    function getLoginStatusBadge(log) {
      if (log.success) {
        if (log.reason === 'guest_login') {
          return '<span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-600">æ¸¸å®¢ç™»å½•</span>';
        }
        return '<span class="text-xs px-2 py-1 rounded bg-green-100 text-green-600">ç™»å½•æˆåŠŸ</span>';
      }

      
      let reasonText = 'ç™»å½•å¤±è´¥';
      let reasonClass = 'bg-red-100 text-red-700'; 

      switch (log.reason) {
        case 'brute_force_locked':
          reasonText = 'å°è¯•è¿‡å¤š';
          break;
        case 'user_not_found':
          reasonText = 'ç”¨æˆ·ä¸å­˜åœ¨';
          break;
        case 'user_banned':
          reasonText = 'è´¦å·å·²å°ç¦';
          break;
        case 'wrong_password':
          reasonText = 'å¯†ç é”™è¯¯';
          break;
        case '2fa_failed':
          reasonText = '2FAéªŒè¯å¤±è´¥';
          reasonClass = 'bg-orange-100 text-orange-700'; 
          break;
      }
      return `<span class="text-xs px-2 py-1 rounded ${reasonClass}">${reasonText}</span>`;
    }

    
    async function loadUserLoginLogsSecondary(username) {
      const content = $('log-login-content-secondary');
      if (!content) return;

      
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const response = await fetch(`/api/admin/logs/login_history?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ç™»å½•æ—¶é—´: ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IPåœ°å€: ${log.ip_address || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    è®¾å¤‡ä¿¡æ¯: ${log.user_agent || 'N/A'}
                  </p>
                  ${log.location ? `<p class="text-sm text-slate-600 mt-1">ä½ç½®: ${log.location}</p>` : ''}
                </div>
                <div class="flex-shrink-0">
                  ${getLoginStatusBadge(log)}
                </div>
              </div>
            </div>
          `).join('');
        } else {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç™»å½•è®°å½•</p>';
        }
      } catch (e) {
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    
    async function loadUserAuditLogsSecondary(username) {
      const content = $('log-audit-content-secondary');
      if (!content) return;

      
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const response = await fetch(`/api/admin/logs/audit?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    æ—¶é—´: ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    æ“ä½œç±»å‹: ${log.action || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    è¯¦æƒ…: ${log.details || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IPåœ°å€: ${log.ip_address || 'N/A'}
                  </p>
                </div>
              </div>
            </div>
          `).join('');
        } else {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— æ“ä½œè®°å½•</p>';
        }
      } catch (e) {
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    
    async function loadUserLoginLogs(username) {
      const content = $('log-login-content');
      if (!content) return;

      
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const response = await fetch(`/api/admin/logs/login_history?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ç™»å½•æ—¶é—´: ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    IPåœ°å€: ${log.ip_address || 'N/A'}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    è®¾å¤‡ä¿¡æ¯: ${log.user_agent || 'N/A'}
                  </p>
                  ${log.location ? `<p class="text-sm text-slate-600 mt-1">ä½ç½®: ${log.location}</p>` : ''}
                </div>
                <div class="flex-shrink-0">
                  ${getLoginStatusBadge(log)}
                </div>
              </div>
            </div>
          `).join('');
        } else {
          
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ç™»å½•è®°å½•</p>';
        }
      } catch (e) {
        logMessage_Error('åŠ è½½ç™»å½•è®°å½•å¤±è´¥:', e);
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    
    async function loadUserAuditLogs(username) {
      const content = $('log-audit-content');
      if (!content) return;

      
      content.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const response = await fetch(`/api/admin/logs/audit?username=${encodeURIComponent(username)}`, {
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        const data = await response.json();

        if (data.success && data.logs && data.logs.length > 0) {
          
          content.innerHTML = data.logs.map(log => `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-semibold text-slate-700">
                    ${(log.datetime || 'N/A').replace('T', ' ')}
                  </p>
                  <p class="text-sm text-slate-600 mt-1">
                    æ“ä½œ: ${log.action || 'N/A'}
                  </p>
                  ${log.details ? `<p class="text-sm text-slate-500 mt-1">${log.details}</p>` : ''}
                  ${log.ip_address ? `<p class="text-xs text-slate-400 mt-1">IP: ${log.ip_address}</p>` : ''}
                </div>
          `).join('');
        } else {
          
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— æ“ä½œè®°å½•</p>';
        }
      } catch (e) {
        logMessage_Error('åŠ è½½æ“ä½œè®°å½•å¤±è´¥:', e);
        content.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    
    function closeUserLogsModal() {
      
      const logsModal = $('admin-user-logs-modal');
      if (logsModal) logsModal.classList.add('hidden');

      
      const usersPanel = $('admin-users-panel_modal');
      if (usersPanel) usersPanel.classList.remove('hidden');
    }

    
    
    

    
    async function loadIPBans() {
      try {
        const response = await fetch('/api/admin/ip_bans', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        const listEl = $('ip-ban-list');
        if (result.success && result.bans && result.bans.length > 0) {
          listEl.innerHTML = result.bans.map(ban => `
            <div class="border p-2 rounded flex justify-between items-center">
              <div>
                <span class="font-semibold">${escapeHtml(ban.target)}</span>
                <span class="text-xs text-slate-500 ml-2">[${ban.type}]</span>
                <span class="text-xs text-slate-500 ml-2">${ban.scope === 'all' ? 'å…¨éƒ¨' : 'ä»…ç•™è¨€æ¿'}</span>
              </div>
              <button onclick="removeIPBan('${ban.id}')" class="btn btn-danger !py-1 !px-2 !text-xs min-h-[44px]">åˆ é™¤</button>
            </div>
          `).join('');
        } else {
          listEl.innerHTML = '<p class="text-center py-4">æš‚æ— å°ç¦è§„åˆ™</p>';
        }
      } catch (e) {
        showModalAlert('åŠ è½½å¤±è´¥: ' + e.message);
      }
    }

    
    
    

    
    const ipRegex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

    
    function ipToInt(ip) {
      try {
        
        return ip.split('.').reduce((int, octet) => (int << 8) + parseInt(octet, 10), 0) >>> 0;
      } catch (e) {
        return 0; 
      }
    }

    
    
    

    
    function validateIPBanTarget() {
      
      const banTypeSelect = $('ban-type');
      const banTargetInput = $('ban-target');
      const banTargetError = $('ban-target-error');

      if (!banTypeSelect || !banTargetInput || !banTargetError) {
        logMessage_Error("validateIPBanTarget: æ— æ³•æ‰¾åˆ°IPå°ç¦æ¨¡æ€æ¡†çš„DOMå…ƒç´ ");
        return false;
      }

      const type = banTypeSelect.value;
      const target = banTargetInput.value.trim();

      if (!target) {
        banTargetError.textContent = 'å°ç¦ç›®æ ‡ä¸èƒ½ä¸ºç©º';
        banTargetError.classList.remove('hidden');
        banTargetInput.classList.add('border-red-500');
        return false;
      }

      if (type === 'ip' && !ipRegex.test(target)) {
        banTargetError.textContent = 'æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„å•ä¸ªIPåœ°å€ (ä¾‹å¦‚: 1.2.3.4)';
        banTargetError.classList.remove('hidden');
        banTargetInput.classList.add('border-red-500');
        return false;
      }

      if (type === 'range') {
        const parts = target.split('-');
        if (parts.length !== 2 || !ipRegex.test(parts[0].trim()) || !ipRegex.test(parts[1].trim())) {
          banTargetError.textContent = 'æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„IPèŒƒå›´ (ä¾‹å¦‚: 192.168.1.1-192.168.1.100)';
          banTargetError.classList.remove('hidden');
          banTargetInput.classList.add('border-red-500');
          return false;
        }
        
        const startIpInt = ipToInt(parts[0].trim());
        const endIpInt = ipToInt(parts[1].trim());
        if (startIpInt > endIpInt) {
          banTargetError.textContent = 'æ ¼å¼é”™è¯¯ï¼šèµ·å§‹IPå¿…é¡»å°äºæˆ–ç­‰äºç»“æŸIP';
          banTargetError.classList.remove('hidden');
          banTargetInput.classList.add('border-red-500');
          return false;
        }
      }

      
      banTargetError.classList.add('hidden');
      banTargetInput.classList.remove('border-red-500');
      return true;
    }


    
    async function addIPBan() {
      
      if (!validateIPBanTarget()) {
        
        showModalAlert('è¾“å…¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥çº¢è‰²æç¤º', 'æ·»åŠ å¤±è´¥');
        return;
      }

      
      const target = $('ban-target').value.trim();
      const type = $('ban-type').value;
      const scope = $('ban-scope').value;

      
      try {
        const response = await fetch('/api/admin/ip_bans', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ target, type, scope })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert('å°ç¦è§„åˆ™å·²æ·»åŠ ');
          $('ban-target').value = ''; 

          const banTargetError = $('ban-target-error');
          const banTargetInput = $('ban-target');

          if (banTargetError) banTargetError.classList.add('hidden');


          banTargetError.classList.add('hidden'); 
          banTargetInput.classList.remove('border-red-500'); 
          loadIPBans(); 
        } else {
          showModalAlert(result.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    
    async function removeIPBan(banId) {
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤æ­¤å°ç¦è§„åˆ™å—ï¼Ÿ');
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/admin/ip_bans/${banId}`, {
          method: 'DELETE',
          headers: { 'X-Session-ID': sessionUUID }
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert('å°ç¦è§„åˆ™å·²åˆ é™¤');
          loadIPBans();
        } else {
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    
    
    

    
    
    async function loadSMSConfig() {
      try {
        
        const response = await fetch('/api/admin/sms/config', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        
        if (result.success) {
          
          $('sms-enabled').checked = result.config.enable_sms_service || false;

          
          
          $('sms-enable-phone-modification').checked = result.config.enable_phone_modification || false;
          
          $('sms-enable-phone-login').checked = result.config.enable_phone_login || false;
          
          $('sms-enable-phone-registration-verify').checked = result.config.enable_phone_registration_verify || false;

          
          $('sms-username').value = result.config.username || '';
          $('sms-apikey').value = result.config.api_key || '';
          $('sms-signature').value = result.config.signature || '';
          $('sms-template').value = result.config.template_register || '';
          $('sms-code-expire').value = result.config.code_expire_minutes || 5;

          
          $('sms-limit-account').value = result.config.rate_limit_per_account_day || 10;
          $('sms-limit-ip').value = result.config.rate_limit_per_ip_day || 20;
          $('sms-limit-phone').value = result.config.rate_limit_per_phone_day || 5;

          
          $('sms-webhook-url').value = `${window.location.origin}/sms-reply-webhook`;
        }
      } catch (e) {
        
        showModalAlert('åŠ è½½é…ç½®å¤±è´¥: ' + e.message);
      }
    }

    
    async function saveSMSConfig() {
      
      const config = {
        
        enable_sms_service: $('sms-enabled').checked,

        
        enable_phone_modification: $('sms-enable-phone-modification').checked,
        enable_phone_login: $('sms-enable-phone-login').checked,
        enable_phone_registration_verify: $('sms-enable-phone-registration-verify').checked,

        
        username: $('sms-username').value.trim(),
        api_key: $('sms-apikey').value.trim(),
        signature: $('sms-signature').value.trim(),
        template_register: $('sms-template').value.trim(),

        
        code_expire_minutes: parseInt($('sms-code-expire').value) || 5,
        rate_limit_per_account_day: parseInt($('sms-limit-account').value) || 10,
        rate_limit_per_ip_day: parseInt($('sms-limit-ip').value) || 20,
        rate_limit_per_phone_day: parseInt($('sms-limit-phone').value) || 5
      };

      try {
        
        const response = await fetch('/api/admin/sms/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(config)
        });

        
        const result = await response.json();
        if (result.success) {
          
          showModalAlert('é…ç½®å·²ä¿å­˜');
        } else {
          
          showModalAlert(result.message || 'ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    
    function handleSmsMainSwitchChange() {
      
      const mainSwitchEnabled = $('sms-enabled').checked;

      
      if (!mainSwitchEnabled) {
        
        $('sms-enable-phone-modification').checked = false;
        
        $('sms-enable-phone-login').checked = false;
        
        $('sms-enable-phone-registration-verify').checked = false;
      }
      
    }

    
    async function checkSMSBalance() {
      const btn = $('btn-check-sms-balance');
      const originalText = 'ğŸ’° æŸ¥è¯¢ä½™é¢';

      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'æŸ¥è¯¢ä¸­...';
      }

      try {
        const response = await fetch('/api/admin/sms/check_balance', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (result.success) {
          
          const valEl = $('sms-balance-modal-value');
          const sentEl = $('sms-balance-modal-sent');
          const msgEl = $('sms-balance-modal-message');

          if (valEl) valEl.textContent = result.balance;
          if (sentEl) sentEl.textContent = result.sent_today;
          if (msgEl) {
            msgEl.textContent = result.message;

            
            if (result.message && (result.message.includes('é¢‘ç¹') || result.message.includes('å¤±è´¥'))) {
              
              msgEl.classList.add('text-amber-600', 'bg-amber-50');
              msgEl.classList.remove('text-slate-500', 'bg-slate-50');
            } else {
              
              msgEl.classList.remove('text-amber-600', 'bg-amber-50');
              msgEl.classList.add('text-slate-500', 'bg-slate-50');
            }
          }

          
          openSMSBalanceModal();

        } else {
          
          showModalAlert(result.message || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (e) {
        
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      } finally {
        
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    }

    
    function openSMSBalanceModal() {
      showModal('sms-balance-modal');
    }

    
    function closeSMSBalanceModal() {
      hideModal('sms-balance-modal');
    }

    

    
    function openSMSHistoryModal() {
      $('sms-history-modal').classList.remove('hidden');
      loadSMSHistory();
    }

    
    function closeSMSHistoryModal() {
      $('sms-history-modal').classList.add('hidden');
    }

    
    async function loadSMSHistory() {
      try {
        
        const dateFilter = $('sms-history-date-filter').value;
        const phoneFilter = $('sms-history-phone-filter').value.trim();

        
        const params = new URLSearchParams();
        if (dateFilter) params.append('date', dateFilter);
        if (phoneFilter) params.append('phone', phoneFilter);

        const response = await fetch(`/api/admin/sms/history?${params.toString()}`, {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        const listContainer = $('sms-history-list');

        if (result.success && result.records && result.records.length > 0) {
          listContainer.innerHTML = result.records.map(record => `
            <div class="border-2 border-slate-200 rounded-lg p-4 hover:border-sky-300 transition-colors bg-white">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <span class="text-xs text-slate-500">ğŸ“± æ‰‹æœºå·</span>
                  <p class="font-semibold text-slate-700">+86 ${record.phone || 'N/A'}</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">ğŸ‘¤ ç”¨æˆ·å</span>
                  <p class="font-semibold text-slate-700">${record.username || 'æœªçŸ¥'}</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">ğŸ• æ—¶é—´</span>
                  <p class="text-sm text-slate-600">${record.datetime || 'N/A'}</p>
                </div>
                <div>
                  <span class="text-xs text-slate-500">ğŸŒ IPåœ°å€</span>
                  <p class="text-sm text-slate-600">${record.ip || 'N/A'}</p>
                </div>
                <div class="md:col-span-2">
                  <span class="text-xs text-slate-500">ğŸ’¬ çŸ­ä¿¡å†…å®¹</span>
                  <p class="text-sm text-slate-600 bg-slate-50 p-2 rounded mt-1">${escapeHtml(record.content || '')}</p>
                </div>
                ${record.session_id && record.session_id !== '' && record.session_id !== 'null' ? `
                <div class="md:col-span-2">
                  <span class="text-xs text-slate-500">ğŸ” ä¼šè¯ID</span>
                  <p class="text-xs text-slate-400 font-mono">${record.session_id}</p>
                </div>
                ` : ''}
              </div>
            </div>
          `).join('');
        } else {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— è®°å½•</p>';
        }
      } catch (e) {
        showModalAlert('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + e.message);
      }
    }

    

    
    function openSMSTestModal() {
      const modal = $('sms-test-modal');
      if (modal) {
        
        modal.classList.remove('hidden');
        
        document.body.classList.add('modal-visible');

        
        const phoneInput = $('sms-test-phone');
        if (phoneInput) {
          phoneInput.value = '';
        }

        
        const codeInput = $('sms-test-code-input');
        if (codeInput) {
          codeInput.value = '';
        }

        
        const resultDiv = $('sms-test-result');
        if (resultDiv) {
          resultDiv.classList.add('hidden');
        }

        
        const sendBtn = $('btn-send-test-sms');
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = `
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            å‘é€æµ‹è¯•çŸ­ä¿¡
          `;
        }
      }
    }

    
    function closeSMSTestModal() {
      const modal = $('sms-test-modal');
      if (modal) {
        modal.classList.add('hidden');
        
        
      }
    }

    
    async function sendTestSMS() {
      
      const phoneInput = $('sms-test-phone');
      const codeInput = $('sms-test-code-input');  
      const sendBtn = $('btn-send-test-sms');
      const resultDiv = $('sms-test-result');
      const codeDisplay = $('sms-test-code');
      const phoneDisplay = $('sms-test-phone-display');

      if (!phoneInput || !sendBtn) {
        showModalAlert('ç•Œé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      
      const phone = phoneInput.value.trim();
      
      const customCode = codeInput ? codeInput.value.trim() : '';

      
      if (!phone) {
        showModalAlert('è¯·è¾“å…¥æ‰‹æœºå·');
        phoneInput.focus();
        return;
      }

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        showModalAlert('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥11ä½æœ‰æ•ˆæ‰‹æœºå·');
        phoneInput.focus();
        return;
      }

      
      if (customCode && !/^\d{4,8}$/.test(customCode)) {
        showModalAlert('è‡ªå®šä¹‰éªŒè¯ç æ ¼å¼ä¸æ­£ç¡®ï¼Œä»…æ”¯æŒ4-8ä½æ•°å­—');
        if (codeInput) codeInput.focus();
        return;
      }

      
      sendBtn.disabled = true;
      sendBtn.innerHTML = `
        <svg class="w-5 h-5 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        å‘é€ä¸­...
      `;

      
      if (resultDiv) {
        resultDiv.classList.add('hidden');
      }

      try {
        
        const requestData = { phone };
        if (customCode) {
          requestData.code = customCode;  
        }

        
        const response = await fetch('/api/sms/test_send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (result.success) {
          
          if (codeDisplay) {
            codeDisplay.textContent = result.code || '------';
          }
          if (phoneDisplay) {
            phoneDisplay.textContent = result.phone || phone;
          }
          if (resultDiv) {
            resultDiv.classList.remove('hidden');
          }

          
          showTempMessage('æµ‹è¯•çŸ­ä¿¡å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥æ‰‹æœºæ˜¯å¦æ”¶åˆ°', 'success');

          
          sendBtn.innerHTML = `
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 13l4 4L19 7"></path>
            </svg>
            å·²å‘é€
          `;

          
          setTimeout(() => {
            if (sendBtn) {
              sendBtn.disabled = false;
              sendBtn.innerHTML = `
                <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                å†æ¬¡å‘é€
              `;
            }
          }, 5000);

        } else {
          
          showModalAlert(result.message || 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œä½™é¢');

          
          sendBtn.disabled = false;
          sendBtn.innerHTML = `
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            å‘é€æµ‹è¯•çŸ­ä¿¡
          `;
        }

      } catch (error) {
        
        console.error('[çŸ­ä¿¡æµ‹è¯•] å‘é€å¤±è´¥:', error);
        showModalAlert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);

        
        sendBtn.disabled = false;
        sendBtn.innerHTML = `
          <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          å‘é€æµ‹è¯•çŸ­ä¿¡
        `;
      }
    }

    

    
    let verificationCodesCountdownInterval = null;

    
    function updateVerificationCodeCountdowns() {
      const countdownElements = document.querySelectorAll('.verification-code-countdown');
      if (countdownElements.length === 0) {
        
        stopVerificationCodesCountdown();
        return;
      }

      const now = Math.floor(Date.now() / 1000); 

      countdownElements.forEach(el => {
        const expiresAt = parseInt(el.dataset.expiresAt, 10);
        if (isNaN(expiresAt)) {
          el.textContent = "å·²å¤±æ•ˆ";
          return;
        }

        const expiresIn = Math.max(0, expiresAt - now);
        const minutes = Math.floor(expiresIn / 60);
        const seconds = expiresIn % 60;

        el.textContent = `${minutes}åˆ†${seconds}ç§’`;

        if (expiresIn <= 0) {
          el.textContent = "å·²å¤±æ•ˆ";
          el.classList.add('text-red-600', 'font-semibold');
        } else if (expiresIn < 120) { 
          el.classList.add('text-red-600', 'font-semibold');
          el.classList.remove('text-slate-600');
        }
      });
    }

    
    function startVerificationCodesCountdown() {
      stopVerificationCodesCountdown(); 
      updateVerificationCodeCountdowns(); 
      verificationCodesCountdownInterval = setInterval(updateVerificationCodeCountdowns, 1000); 
    }

    
    function stopVerificationCodesCountdown() {
      if (verificationCodesCountdownInterval) {
        clearInterval(verificationCodesCountdownInterval);
        verificationCodesCountdownInterval = null;
      }
    }


    
    function openVerificationCodesModal() {
      $('verification-codes-modal').classList.remove('hidden');
      loadVerificationCodes();
      
    }

    
    function closeVerificationCodesModal() {
      $('verification-codes-modal').classList.add('hidden');
      stopVerificationCodesCountdown();
    }

    
    async function loadVerificationCodes() {
      try {
        const response = await fetch('/api/admin/sms/verification_codes', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        const listContainer = $('verification-codes-list');

        if (result.success && result.codes && result.codes.length > 0) {
          listContainer.innerHTML = result.codes.map(item => {
            const expiresIn = Math.max(0, Math.floor(item.expires_in / 60));
            const expiresSec = Math.max(0, item.expires_in % 60);
            return `
            <div class="border-2 border-slate-200 rounded-lg p-4 bg-white hover:border-sky-300 transition-colors">
              <div class="flex items-center justify-between gap-4">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <span class="text-xs text-slate-500">ğŸ“± æ‰‹æœºå·</span>
                    <p class="font-semibold text-slate-700">+86 ${item.phone}</p>
                  </div>
                  <div>
                    <span class="text-xs text-slate-500">ğŸ”¢ éªŒè¯ç </span>
                    <p class="font-mono text-lg font-bold text-sky-600">${item.code}</p>
                  </div>
                  <div>
                    <span class="text-xs text-slate-500">â° å‰©ä½™æ—¶é—´</span>
                    <p class="verification-code-countdown text-sm ${expiresIn < 2 ? 'text-red-600 font-semibold' : 'text-slate-600'}"
                       data-expires-at="${item.expires_at}">
                      ${expiresIn}åˆ†${expiresSec}ç§’
                    </p>
                  </div>
                </div>
                <button onclick="invalidateVerificationCode('${item.phone}')" 
                  class="btn btn-ghost border border-red-300 text-red-600 hover:bg-red-50 whitespace-nowrap">
                  âŒ å¤±æ•ˆ
                </button>
              </div>
            </div>
          `}).join('');
        } else {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">å½“å‰æ²¡æœ‰æœ‰æ•ˆçš„éªŒè¯ç </p>';
        }

        
        startVerificationCodesCountdown();

      } catch (e) {
        showModalAlert('åŠ è½½éªŒè¯ç åˆ—è¡¨å¤±è´¥: ' + e.message);
        
        stopVerificationCodesCountdown();
      }
    }

    
    async function invalidateVerificationCode(phone) {
      const confirmed = await jsShowConfirm('ç¡®è®¤å¤±æ•ˆ', `ç¡®å®šè¦ä½¿æ‰‹æœºå· +86 ${phone} çš„éªŒè¯ç å¤±æ•ˆå—ï¼Ÿ`);
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch('/api/admin/sms/invalidate_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ phone: phone })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('éªŒè¯ç å·²å¤±æ•ˆ', 'æˆåŠŸ');
          loadVerificationCodes(); 
        } else {
          showModalAlert(result.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    
    async function addManualVerificationCode() {
      const phone = $('manual-code-phone').value.trim();
      let code = $('manual-code-value').value.trim();

      
      if (!code) {
        
        code = Math.floor(100000 + Math.random() * 900000).toString();
        
        $('manual-code-value').value = code;
      } else if (!/^\d{6}$/.test(code)) {
        
        showModalAlert('éªŒè¯ç å¿…é¡»æ˜¯6ä½æ•°å­—');
        return;
      }

      
      if (!code || !/^\d{6}$/.test(code)) {
        showModalAlert('è¯·è¾“å…¥6ä½æ•°å­—éªŒè¯ç ');
        return;
      }

      try {
        const response = await fetch('/api/admin/sms/add_manual_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: phone,
            code: code
          })
        });
        const result = await response.json();

        if (result.success) {
          showModalAlert('éªŒè¯ç å·²æ·»åŠ ', 'æˆåŠŸ');
          $('manual-code-phone').value = '';
          $('manual-code-value').value = '';
          loadVerificationCodes(); 
        } else {
          showModalAlert(result.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    

    async function checkButtonPermission(buttonId, permissionName) {
      const hasPermission = await checkAdminPermission(permissionName);
      if (!hasPermission) {
        showModalAlert(`æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½`, 'æƒé™ä¸è¶³');
        return false;
      }
      return true;
    }

    function updateAdminSessionCountDisplay(currentCount, maxSessions) {
      const countEl = $('admin-session-count-display');
      if (!countEl) return;

      
      if (currentUserIsGuest) {
        countEl.innerHTML = `<span class="text-blue-600">ä¼šè¯æ•°: 1 / æ¸¸å®¢ä»…é™å•ä¼šè¯</span>`;
      } else if (maxSessions === -1) {
        countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
      } else {
        const isNearLimit = currentCount >= maxSessions * 0.8;
        const isAtLimit = currentCount >= maxSessions;
        const colorClass = isAtLimit ? 'text-red-600' : (isNearLimit ? 'text-amber-600' : 'text-slate-600');
        countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
      }
    }

    
    
    
    async function destroySession(sessionId) {
      const sessionHash = sessionId.substring(0, 16);
      const confirmed = await jsShowConfirm('ç¡®è®¤é”€æ¯', `ç¡®å®šè¦é”€æ¯ä¼šè¯\n${sessionHash}...\nå—ï¼Ÿ\næ­¤æ“ä½œå°†å¼ºåˆ¶ç»ˆæ­¢è¯¥ä¼šè¯ï¼`);
      if (!confirmed) return;

      try {
        const response = await fetch('/auth/admin/destroy_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ session_id: sessionId })
        });

        const result = await response.json();
        if (result.success) {
          showModalAlert(`ä¼šè¯ ${sessionId} å·²é”€æ¯`, 'æˆåŠŸ');
          loadAdminSessions();
          loadAdminSessions_inline();
        } else {
          showModalAlert(result.message || 'é”€æ¯å¤±è´¥', 'é”™è¯¯');
        }
      } catch (e) {
        showModalAlert('æ“ä½œå¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    
    async function selectSession(sessionId) {
      
      const confirmed = await jsShowConfirm('ç¡®è®¤åˆ‡æ¢', `ç¡®å®šè¦åˆ‡æ¢åˆ°ä¼šè¯\n ${sessionId} \nå—ï¼Ÿ`);

      if (!confirmed) {
        logMessage_Info("[ä¼šè¯åˆ‡æ¢] ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚");
        return; 
      }

      
      Swal.fire({
        title: 'æ­£åœ¨åˆ‡æ¢ä¼šè¯...',
        text: 'æ­£åœ¨æ›´æ–°è®¤è¯ä¿¡æ¯ï¼Œè¯·ç¨å€™',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      logMessage_Info(`[ä¼šè¯åˆ‡æ¢] å‡†å¤‡åˆ‡æ¢åˆ°ä¼šè¯ ${sessionId.substring(0, 16)}...`);

      try {
        
        
        const response = await fetch('/auth/switch_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID 
          },
          credentials: 'include', 
          body: JSON.stringify({
            target_session_id: sessionId 
          })
        });

        const result = await response.json();

        
        Swal.close();

        if (response.ok && result.success) {
          
          logMessage_Info(`[ä¼šè¯åˆ‡æ¢] âœ“ è®¤è¯ä¿¡æ¯æ›´æ–°æˆåŠŸï¼Œå‡†å¤‡è·³è½¬åˆ° ${sessionId.substring(0, 16)}...`);
          
          Swal.fire({
            icon: 'success',
            title: 'åˆ‡æ¢å‡†å¤‡å°±ç»ª',
            text: 'å³å°†è·³è½¬åˆ°ç›®æ ‡ä¼šè¯...',
            timer: 1000, 
            showConfirmButton: false
          }).then(() => {
            
            window.location.href = `/uuid=${sessionId}`;
          });
        } else {
          
          logMessage_Info(`[ä¼šè¯åˆ‡æ¢] âœ— åˆ‡æ¢å¤±è´¥: ${result.message}`);
          Swal.fire({
            icon: 'error',
            title: 'åˆ‡æ¢å¤±è´¥',
            text: result.message || 'æ— æ³•æ›´æ–°è®¤è¯ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•ã€‚'
          });
          
          if (result.need_login) {
            Swal.fire({
              icon: 'warning',
              title: 'éœ€è¦é‡æ–°ç™»å½•',
              text: result.message || 'è®¤è¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•',
              confirmButtonText: 'è¿”å›ç™»å½•',
              allowOutsideClick: false
            }).then(() => {
              window.location.href = '/';
            });
          }
        }
      } catch (e) {
        
        Swal.close(); 
        logMessage_Info(`[ä¼šè¯åˆ‡æ¢] âœ— åˆ‡æ¢æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`);
        Swal.fire({
          icon: 'error',
          title: 'åˆ‡æ¢å‡ºé”™',
          text: `ç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`
        });
      }
    }

    async function deleteSession(sessionId) {
      
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤ä¼šè¯\n ${sessionId} \nå—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`
      );

      if (!confirmed) {
        logMessage_Info("[ä¼šè¯åˆ é™¤] ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚");
        return; 
      }

      
      Swal.fire({
        title: 'æ­£åœ¨åˆ é™¤ä¼šè¯...',
        text: 'è¯·ç¨å€™',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      logMessage_Info(`[ä¼šè¯åˆ é™¤] å‡†å¤‡åˆ é™¤ä¼šè¯ ${sessionId}...`);

      try {
        
        const response = await fetch('/auth/user/delete_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID 
          },
          body: JSON.stringify({
            session_id: sessionId 
          })
        });

        const result = await response.json();

        
        Swal.close();

        if (result.success) {
          logMessage_Info(`[ä¼šè¯åˆ é™¤] âœ“ ä¼šè¯ ${sessionId} å·²åˆ é™¤ã€‚`);
          
          Swal.fire({
            icon: 'success',
            title: 'åˆ é™¤æˆåŠŸ',
            timer: 1500, 
            showConfirmButton: false
          }).then(() => {
            
            
            const adminModal = document.getElementById('admin-panel-modal');
            if (adminModal && !adminModal.classList.contains('hidden')) {
              
              loadAdminSessions();
            } else {
              
              loadAdminSessions_inline();
            }
          });
        } else {
          
          logMessage_Info(`[ä¼šè¯åˆ é™¤] âœ— åˆ é™¤å¤±è´¥: ${result.message}`);
          Swal.fire({
            icon: 'error',
            title: 'åˆ é™¤å¤±è´¥',
            text: result.message || 'æ— æ³•åˆ é™¤ä¼šè¯ï¼Œè¯·ç¨åé‡è¯•ã€‚'
          });
        }
      } catch (e) {
        
        Swal.close(); 
        logMessage_Info(`[ä¼šè¯åˆ é™¤] âœ— åˆ é™¤æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`);
        Swal.fire({
          icon: 'error',
          title: 'åˆ é™¤å‡ºé”™',
          text: `ç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`
        });
      }
    }

    
    
    

    function showSessionPicker() {
      const modal = $('session-picker-modal');
      if (!modal) return;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-visible');

      
      loadSessionPickerList();
    }

    function closeSessionPicker() {
      const modal = $('session-picker-modal');
      if (!modal) return;

      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('modal-visible');
    }

    async function loadSessionPickerList() {
      const listEl = $('session-picker-list');
      if (!listEl) return;

      listEl.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const headers = {
          'X-Session-ID': sessionUUID || null
        };

        const response = await fetch('/auth/user/sessions', {
          headers: headers
        });
        const result = await response.json();

        if (!result.success) {
          listEl.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const sessions = result.sessions || [];

        
        currentSessionInfo.maxSessions = result.max_sessions || 1;

        
        const validSessions = sessions.filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');

        currentSessionInfo.currentCount = validSessions.length;

        
        updateSessionCountDisplay();

        if (validSessions.length === 0) {
          listEl.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— ä¼šè¯ï¼Œè¯·åˆ›å»ºæ–°ä¼šè¯</p>';
          return;
        }

        listEl.innerHTML = validSessions.map(session => {
          const createdDate = session.created_at ? new Date(session.created_at * 1000).toLocaleString() : 'æœªçŸ¥';
          const isCurrent = session.is_current || session.session_id === sessionUUID;
          const sessionHash = session.session_hash || session.session_id.substring(0, 16);

          return `
            <div class="border ${isCurrent ? 'border-sky-500 bg-sky-50' : 'border-slate-200'} rounded-lg p-3 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="font-semibold text-slate-800 break-all"> ä¼šè¯ ${session.session_id}
                    
                  </p>
                  ${isCurrent ? '<p class="text-right"><span class="text-xs text-sky-600 ml-2 px-2 py-0.5 bg-sky-100 rounded-full">(å½“å‰)</span></p>' : ''}
                  <p class="text-xs text-slate-500 mt-1">åˆ›å»ºæ—¶é—´: ${createdDate}</p>
                  <p class="text-xs mt-1">
                    <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${session.is_multi_account_mode
              ? (session.login_success ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700') 
              : (session.login_success ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700') 
            }">
                      ${session.is_multi_account_mode
              ? (session.login_success ? 'âœ“ å·²ç™»å½•' : 'â—‹ æœªç™»å½•') 
              : (session.login_success ? 'âœ“ å·²ç™»å½•' : 'â—‹ æœªç™»å½•') 
            }
                    </span>
                  </p>
                </div>
                <div class="flex flex-col gap-2">
                  ${!isCurrent ? `
                    <button class="btn btn-primary !py-1 !px-3 text-xs" onclick="selectSessionFromPicker('${session.session_id}')">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                      </svg>
                      è¿›å…¥
                    </button>
                    <button class="btn btn-ghost !py-1 !px-3 !text-red-600 text-xs border border-red-200 hover:bg-red-50" onclick="deleteSessionFromPicker('${session.session_id}')">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                      åˆ é™¤
                    </button>
                  ` : '<span class="text-xs text-slate-400">å½“å‰ä¼šè¯</span>'}
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        logMessage_Error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', e);
        listEl.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    function refreshSessionPicker() {
      loadSessionPickerList();
    }

    function updateSessionCountDisplay() {
      const countEl = $('session-count-display');
      if (!countEl) return;

      const { currentCount, maxSessions } = currentSessionInfo;

      if (maxSessions === -1) {
        countEl.innerHTML = `<span class="text-green-600">ä¼šè¯æ•°: ${currentCount} / æ— é™åˆ¶</span>`;
      } else {
        const isNearLimit = currentCount >= maxSessions * 0.8;
        const isAtLimit = currentCount >= maxSessions;
        const colorClass = isAtLimit ? 'text-red-600' : (isNearLimit ? 'text-amber-600' : 'text-slate-600');
        countEl.innerHTML = `<span class="${colorClass}">ä¼šè¯æ•°: ${currentCount} / ${maxSessions}</span>`;
      }
    }

    async function selectSessionFromPicker(sessionId) {
      logMessage_Info(`å‡†å¤‡åˆ‡æ¢åˆ°ä¼šè¯ ${sessionId.substring(0, 16)}...`);
      closeSessionPicker(); 

      try {
        logMessage_Info(`æ­£åœ¨ä¸ºç›®æ ‡ä¼šè¯ ${sessionId.substring(0, 16)} åˆ·æ–°è®¤è¯ä»¤ç‰Œ...`);

        
        const response = await fetch('/auth/switch_session', { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID 
          },
          credentials: 'include', 
          body: JSON.stringify({
            target_session_id: sessionId 
          })
        });
        

        const result = await response.json();

        
        if (response.ok && result.success) {
          logMessage_Info(`ä»¤ç‰Œæ›´æ–°æˆåŠŸï¼Œæ­£åœ¨è·³è½¬åˆ°ä¼šè¯ ${sessionId.substring(0, 16)}...`);
          
          window.location.href = `/uuid=${sessionId}`;
        } else {
          
          logMessage_Info(`[é”™è¯¯] æ— æ³•åˆ‡æ¢ä¼šè¯: ${result.message}`);
          showModalAlert(`æ— æ³•åˆ‡æ¢ä¼šè¯: ${result.message}`, 'åˆ‡æ¢å¤±è´¥');
          
          if (result.need_login) {
            Swal.fire({
              icon: 'warning',
              title: 'éœ€è¦é‡æ–°ç™»å½•',
              text: result.message || 'è®¤è¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•',
              confirmButtonText: 'è¿”å›ç™»å½•',
              allowOutsideClick: false
            }).then(() => {
              window.location.href = '/';
            });
          }
        }
      } catch (e) {
        logMessage_Error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', e);
        logMessage_Info(`[é”™è¯¯] åˆ‡æ¢ä¼šè¯æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`);
        showModalAlert(`åˆ‡æ¢ä¼šè¯æ—¶å‘ç”Ÿç½‘ç»œæˆ–è„šæœ¬é”™è¯¯: ${e.message}`, 'åˆ‡æ¢å¤±è´¥');
      }
    }

    async function createNewSessionFromPicker() {
      try {
        logMessage_Info("[ä¼šè¯åˆ›å»º] æ­£åœ¨è·å–æœ€æ–°ä¼šè¯ä¿¡æ¯...");
        
        const response = await fetch('/auth/user/sessions', {
          headers: {
            'X-Session-ID': sessionUUID || null 
          }
        });
        const result = await response.json();

        if (result.success) {
          
          currentSessionInfo.maxSessions = result.max_sessions !== undefined && result.max_sessions !== null ? result.max_sessions : -1; 
          
          const validSessions = (result.sessions || []).filter(session => session.session_id && session.session_id !== 'null' && session.session_id.trim() !== '');
          currentSessionInfo.currentCount = validSessions.length;
          logMessage_Info(`[ä¼šè¯åˆ›å»º] ä¼šè¯ä¿¡æ¯å·²æ›´æ–°: å½“å‰ ${currentSessionInfo.currentCount} / æœ€å¤§ ${currentSessionInfo.maxSessions === -1 ? 'æ— é™åˆ¶' : currentSessionInfo.maxSessions}`);
          
          updateSessionCountDisplay();
          
          updateAdminSessionCountDisplay(currentSessionInfo.currentCount, currentSessionInfo.maxSessions);
          
          updateAdminSessionCountDisplayInline(currentSessionInfo.currentCount, currentSessionInfo.maxSessions);
        } else {
          
          logMessage_Info(`[ä¼šè¯åˆ›å»º] è­¦å‘Š: è·å–æœ€æ–°ä¼šè¯ä¿¡æ¯å¤±è´¥: ${result.message}`);
          showModalAlert('æ— æ³•è·å–æœ€æ–°çš„ä¼šè¯é™åˆ¶ä¿¡æ¯ï¼Œå°†ç»§ç»­å°è¯•åˆ›å»ºã€‚', 'è­¦å‘Š');
        }
      } catch (error) {
        
        logMessage_Info(`[ä¼šè¯åˆ›å»º] é”™è¯¯: è·å–æœ€æ–°ä¼šè¯ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: ${error}`);
        showModalAlert(`è·å–æœ€æ–°çš„ä¼šè¯é™åˆ¶ä¿¡æ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: ${error.message}ï¼Œå°†ç»§ç»­å°è¯•åˆ›å»ºã€‚`, 'ç½‘ç»œé”™è¯¯');
      }



      
      if (currentSessionInfo.maxSessions !== -1 && currentSessionInfo.currentCount >= currentSessionInfo.maxSessions) {
        
        const result = await Swal.fire({
          title: 'ä¼šè¯æ•°é‡å·²è¾¾ä¸Šé™',
          html: `æ‚¨å·²è¾¾åˆ°æœ€å¤§ä¼šè¯æ•°é‡é™åˆ¶ï¼ˆ${currentSessionInfo.maxSessions}ä¸ªï¼‰ã€‚<br><br>æ˜¯å¦è¦è‡ªåŠ¨åˆ é™¤æœ€æ—©çš„ä¼šè¯å¹¶åˆ›å»ºæ–°ä¼šè¯ï¼Ÿ`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'ç¡®å®šï¼Œåˆ é™¤æœ€æ—§ä¼šè¯',
          cancelButtonText: 'å–æ¶ˆ',
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33'
        });

        if (!result.isConfirmed) {
          logMessage_Info("[ä¼šè¯åˆ›å»º] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼šä¼šè¯æ•°å·²è¾¾ä¸Šé™ã€‚");
          return;
        }

        
        try {
          const response = await fetch('/auth/user/sessions', {
            headers: { 'X-Session-ID': sessionUUID || null }
          });
          const sessionsResult = await response.json();

          if (sessionsResult.success && sessionsResult.sessions && sessionsResult.sessions.length > 0) {
            
            const validSessions = sessionsResult.sessions.filter(s =>
              s.session_id &&
              s.session_id !== 'null' &&
              s.session_id.trim() !== '' &&
              s.session_id !== sessionUUID
            );

            if (validSessions.length > 0) {
              
              validSessions.sort((a, b) => (a.created_at || 0) - (b.created_at || 0));
              const oldestSession = validSessions[0];

              logMessage_Info(`[ä¼šè¯ç®¡ç†] æ­£åœ¨åˆ é™¤æœ€æ—§çš„ä¼šè¯: ${oldestSession.session_id.substring(0, 16)}...`);

              
              const deleteResponse = await fetch('/auth/user/delete_session', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Session-ID': sessionUUID
                },
                body: JSON.stringify({ session_id: oldestSession.session_id })
              });

              const deleteResult = await deleteResponse.json();
              if (deleteResult.success) {
                logMessage_Info(`[ä¼šè¯ç®¡ç†] å·²åˆ é™¤æœ€æ—§çš„ä¼šè¯`);
              } else {
                logMessage_Info(`[ä¼šè¯ç®¡ç†] åˆ é™¤ä¼šè¯å¤±è´¥: ${deleteResult.message}`);
              }
            }
          }
        } catch (e) {
          logMessage_Info(`[ä¼šè¯ç®¡ç†] åˆ é™¤æ—§ä¼šè¯æ—¶å‡ºé”™: ${e.message}`);
        }
      }

      const newUUID = generateUUID();
      logMessage_Info(`æ­£åœ¨åˆ›å»ºæ–°ä¼šè¯ ${newUUID}`);
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤æ“ä½œ',
        'æ‚¨ç¡®å®šè¦åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯å—ï¼Ÿ'
      );

      if (!confirmed) {
        logMessage_Info("[ä¼šè¯åˆ›å»º] ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚");
        return; 
      }


      
      let mobileButton = null;
      if (isMobileMode) {
        mobileButton = $('mobile-create-session-btn');
        if (mobileButton) {
          mobileButton.disabled = true;
          
          mobileButton.innerHTML = 'æ­£åœ¨åˆ›å»º...';
        }
      } else {
        
        Swal.fire({
          title: 'æ­£åœ¨åˆ›å»ºæ–°ä¼šè¯...',
          text: 'è¯·ç¨å€™',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
      }


      logMessage_Info(`[ä¼šè¯åˆ›å»º] å‡†å¤‡åˆ›å»ºæ–°ä¼šè¯...`);
      
      try {
        
        const response = await fetch('/auth/user/create_session_persistence', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            session_id: newUUID
          })
        });


        const result = await response.json();

        if (result.success) {
          logMessage_Info(`ä¼šè¯æŒä¹…åŒ–æ–‡ä»¶å·²åˆ›å»º: ${result.message}`);
          if (result.cleanup_message) {
            logMessage_Info(`æç¤º: ${result.cleanup_message}`);
          }
          if (isMobileMode) {
            closeMobileSessionPicker(); 
          } else {
            closeSessionPicker(); 
          }
          window.location.href = `/uuid=${newUUID}`;
        } else {
          logMessage_Info(`åˆ›å»ºä¼šè¯å¤±è´¥: ${result.message}`);

          
          if (isMobileMode) {
            showModalAlert(result.message, 'åˆ›å»ºå¤±è´¥');
            
            if (mobileButton) {
              mobileButton.disabled = false;
              
              mobileButton.innerHTML = `
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              åˆ›å»ºæ–°ä¼šè¯
            `;
            }
          } else {
            Swal.fire({
              icon: 'error',
              title: 'åˆ›å»ºå¤±è´¥',
              text: result.message
            });
          }
        }
      } catch (e) {
        logMessage_Info(`åˆ›å»ºä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`);



        
        if (isMobileMode) {
          
          if (mobileButton) {
            mobileButton.disabled = false;
            
            mobileButton.innerHTML = `
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              åˆ›å»ºæ–°ä¼šè¯
            `;
          }
        } else {
          Swal.close();
        }

        
        showModalAlert(`åˆ›å»ºä¼šè¯å¤±è´¥: ${e.message}`, 'åˆ›å»ºå¤±è´¥');

      }
    }

    async function deleteSessionFromPicker(sessionId) {
      const confirmed = await jsShowConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼'
      );
      if (!confirmed) return;

      
      

      
      Swal.fire({
        title: 'æ­£åœ¨åˆ é™¤ä¼šè¯...',
        text: 'è¯·ç¨å€™',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      try {
        const response = await fetch('/auth/user/delete_session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            session_id: sessionId
          })
        });

        const result = await response.json();

        
        Swal.close();


        if (result.success) {
          
          showModalAlert('ä¼šè¯å·²åˆ é™¤', 'æˆåŠŸ');
          
          const mobilePicker = $('mobile-session-picker-modal');
          const desktopPicker = $('session-picker-modal');

          if (mobilePicker && !mobilePicker.classList.contains('hidden')) {
            
            logMessage_Info("[ä¼šè¯åˆ é™¤] æ­£åœ¨åˆ·æ–°ç§»åŠ¨ç«¯ä¼šè¯åˆ—è¡¨...");
            loadMobileSessionPickerList();
          } else if (desktopPicker && !desktopPicker.classList.contains('hidden')) {
            
            logMessage_Info("[ä¼šè¯åˆ é™¤] æ­£åœ¨åˆ·æ–°æ¡Œé¢ç«¯ä¼šè¯åˆ—è¡¨...");
            loadSessionPickerList();
          } else {
            
            logMessage_Info("[ä¼šè¯åˆ é™¤] æ­£åœ¨åˆ·æ–°ï¼ˆå…œåº•ï¼‰...");
            if (isMobileMode) {
              loadMobileSessionPickerList();
            } else {
              loadSessionPickerList();
            }
          }
        } else {
          
          showModalAlert('åˆ é™¤å¤±è´¥: ' + result.message, 'é”™è¯¯');
        }
      } catch (e) {
        
        Swal.close();
        
        showModalAlert('åˆ é™¤å¤±è´¥: ' + e.message, 'é”™è¯¯');
      }
    }

    
    function validateInput(input, type) {
      if (!input || input.trim() === '') {
        return { valid: false, message: 'è¾“å…¥ä¸èƒ½ä¸ºç©º' };
      }

      switch (type) {
        case 'username':
          if (input.length < 3 || input.length > 50) {
            return { valid: false, message: 'ç”¨æˆ·åé•¿åº¦åº”åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´' };
          }
          if (!/^[a-zA-Z0-9_-]+$/.test(input)) {
            return { valid: false, message: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦' };
          }
          break;
        case 'password':
          if (input.length < 6) {
            return { valid: false, message: 'å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦' };
          }
          break;
        case 'email':
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(input)) {
            return { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' };
          }
          break;
      }

      return { valid: true };
    }

    
    let sessionValidityCheckInterval = null;

    
    async function checkSessionValidity() {
      if (!sessionUUID) {
        logMessage_Info('[ä¼šè¯æ£€æŸ¥] æ— UUIDï¼Œè·³è¿‡æ£€æŸ¥');
        return;
      }

      try {
        const response = await fetch('/auth/check_uuid_type', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ uuid: sessionUUID })
        });

        const result = await response.json();

        if (result.success && result.uuid_type === 'unknown') {
          
          logMessage_Warning('[ä¼šè¯æ£€æŸ¥] ä¼šè¯ä¸å­˜åœ¨ï¼ŒUUIDç±»å‹ä¸ºunknown');

          
          if (sessionValidityCheckInterval) {
            clearInterval(sessionValidityCheckInterval);
            sessionValidityCheckInterval = null;
          }

          
          Swal.fire({
            title: 'ä¼šè¯å·²å¤±æ•ˆ',
            text: 'UUIDä¸å­˜åœ¨ (æ–‡ä»¶æœªæ‰¾åˆ°)\næ‚¨çš„ä¼šè¯å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ç™»å½•',
            icon: 'warning',
            confirmButtonText: 'ç¡®å®š',
            allowOutsideClick: false,
            allowEscapeKey: false
          }).then(() => {
            
            logMessage_Info('[ä¼šè¯æ£€æŸ¥] ç”¨æˆ·ç¡®è®¤ä¼šè¯å¤±æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
            window.location.href = '/';
          });
        } else if (!result.success) {
          
          logMessage_Warning('[ä¼šè¯æ£€æŸ¥] æ£€æŸ¥å¤±è´¥:', result.message);
        } else {
          
          logMessage_Info('[ä¼šè¯æ£€æŸ¥] ä¼šè¯æœ‰æ•ˆï¼ŒUUIDç±»å‹:', result.uuid_type);
        }
      } catch (error) {
        
        logMessage_Error('[ä¼šè¯æ£€æŸ¥] æ£€æŸ¥è¯·æ±‚å¤±è´¥:', error);
      }
    }

    
    function startSessionValidityCheck() {
      
      if (sessionValidityCheckInterval) {
        logMessage_Info('[ä¼šè¯æ£€æŸ¥] å®šæœŸæ£€æŸ¥å·²åœ¨è¿è¡Œ');
        return;
      }

      logMessage_Info('[ä¼šè¯æ£€æŸ¥] å¯åŠ¨å®šæœŸæ£€æŸ¥ï¼Œé—´éš”5åˆ†é’Ÿ');

      
      checkSessionValidity();

      
      sessionValidityCheckInterval = setInterval(checkSessionValidity, 5 * 60 * 1000);
    }

    
    async function initializeApp() {

      function ShowMobileLoadingOverlay() {
        const isMobile = detectMobileDevice();
        if (isMobile) {
          $('mobile-loading-overlay').classList.remove('hidden');
        }
      }

      function HiddenMobileLoadingOverlay() {

        $('mobile-loading-overlay').classList.add('hidden');
      }

      function ShowLoadingOverlay() {
        const isMobile = detectMobileDevice();
        if (!isMobile) {
          $('loading-overlay').classList.remove('hidden');
        }
      }

      function HiddenLoadingOverlay() {

        $('loading-overlay').classList.add('hidden');
      }

      ShowLoadingOverlay();
      ShowMobileLoadingOverlay();

      try {
        
        function isValidUUID(uuid) {
          const uuidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}$/i;
          return uuidPattern.test(uuid);
        }

        
        function showMobileLoadingOverlay() {
          const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
          if (mobileLoadingOverlay) {
            mobileLoadingOverlay.classList.remove('hidden');
            console.log('[åŠ è½½é®ç½©] æ˜¾ç¤ºç§»åŠ¨ç«¯åŠ è½½é®ç½©');
          }
        }

        
        function hideMobileLoadingOverlay() {
          const mobileLoadingOverlay = document.getElementById('mobile-loading-overlay');
          if (mobileLoadingOverlay) {
            mobileLoadingOverlay.classList.add('hidden');
            console.log('[åŠ è½½é®ç½©] éšè—ç§»åŠ¨ç«¯åŠ è½½é®ç½©');
          }
        }

        
        
        function hideLoadingOverlays() {
          $('loading-overlay').classList.add('hidden');
          $('cdn-error-overlay').classList.add('hidden');
          
          hideMobileLoadingOverlay();
        }

        
        function showUserFriendlyError(title, message, isWarning = false) {
          const type = isWarning ? 'warning' : 'error';
          Swal.fire({
            title: title,
            text: message,
            icon: type,
            confirmButtonText: 'ç¡®å®š'
          });
        }

        
        $('loading-overlay').classList.remove('hidden');
        if (isMobileMode) {
          showMobileLoadingOverlay();
        }

        

        const urlPath = window.location.pathname;
        
        const match = urlPath.match(/\/uuid=([a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})/i);

        ShowLoadingOverlay();
        if (match) {
          
          sessionUUID = match[1];

          
          if (!isValidUUID(sessionUUID)) {

            hideLoadingOverlays();
            hideLoadingOverlays();
            logMessage_Error('æ— æ•ˆçš„UUIDæ ¼å¼:', sessionUUID);



            
            Swal.fire({
              title: 'æ— æ•ˆçš„ä¼šè¯', 
              text: 'UUIDæ ¼å¼ä¸æ­£ç¡®\nå°†è·³è½¬åˆ°ç™»å½•é¡µé¢', 
              icon: 'warning', 
              confirmButtonText: 'ç¡®å®š' 
            }).then(() => {
              
              logMessage_Info('ç”¨æˆ·ç¡®è®¤æ— æ•ˆUUIDå¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
              window.location.href = '/'; 
            });

            
            
            
            


            return;

          }
          $('loading-overlay').classList.remove('hidden');
          ShowLoadingOverlay();
          logMessage_Info('Webæ¨¡å¼: æ£€æµ‹åˆ°æœ‰æ•ˆUUID =', sessionUUID);
          let result = null;
          
          try {
            try {
              const response = await fetch('/auth/check_uuid_type', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ uuid: sessionUUID })
              });

              result = await response.json();

              if (!result.success) {
                logMessage_Error('æ£€æŸ¥UUIDå¤±è´¥:', result.message);
                hideLoadingOverlays();

                
                
                
                
                

                let message = "æ— æ³•é€šè¿‡UUIDåˆ¤æ–­ä¼šè¯åˆ—å¸­\nå°†è·³è½¬åˆ°ç™»å½•é¡µé¢"
                if (result.message !== '') {
                  message = "æ— æ³•é€šè¿‡UUIDåˆ¤æ–­ä¼šè¯åˆ—å¸­\n" + result.message + "\nå°†è·³è½¬åˆ°ç™»å½•é¡µé¢"
                }

                Swal.fire({
                  title: 'æ— æ•ˆçš„ä¼šè¯ç±»å‹', 
                  text: message, 
                  icon: 'warning', 
                  confirmButtonText: 'ç¡®å®š' 
                }).then(() => {
                  
                  logMessage_Info('ç”¨æˆ·ç¡®è®¤æ£€æŸ¥UUIDå¤±è´¥å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                  window.location.href = '/'; 
                });

                return;
              }
            } catch (e) {
              logMessage_Error('æ£€æŸ¥UUIDè¯·æ±‚å¤±è´¥:', e);
              throw e;
            }
            $('loading-overlay').classList.remove('hidden');
            try {
              if (result.uuid_type === 'guest') {
                try {
                  
                  logMessage_Info('æ£€æµ‹åˆ°æ¸¸å®¢UUIDï¼Œç›´æ¥æ¢å¤ä¼šè¯');
                  hideLoadingOverlays(); 
                  
                  if (isMobileMode) {
                    const mobileHeader = document.getElementById('mobile-header');
                    const mobileBottomNavSingle = document.getElementById('mobile-bottom-nav-single-account');
                    if (mobileHeader) {
                      mobileHeader.classList.remove('hidden');
                      mobileHeader.style.display = ''; 
                    }
                    if (mobileBottomNavSingle) {
                      mobileBottomNavSingle.classList.remove('hidden');
                      mobileBottomNavSingle.style.display = ''; 
                    }
                  }
                } catch (e) {
                  logMessage_Error('å¤„ç†æ¸¸å®¢UUIDå¤±è´¥:', e);
                  throw e;
                }
                
              } else if (result.uuid_type === 'system_account') {
                try {
                  
                  
                  logMessage_Info('æ£€æµ‹åˆ°ç³»ç»Ÿè´¦å·UUIDï¼Œå…è®¸è®¿é—®ï¼ˆåç«¯å°†éªŒè¯tokenï¼‰');
                  hideLoadingOverlays(); 
                  
                  if (isMobileMode) {
                    const mobileHeader = document.getElementById('mobile-header');
                    const mobileBottomNavSingle = document.getElementById('mobile-bottom-nav-single-account');
                    if (mobileHeader) {
                      mobileHeader.classList.remove('hidden');
                      mobileHeader.style.display = ''; 
                    }
                    if (mobileBottomNavSingle) {
                      mobileBottomNavSingle.classList.remove('hidden');
                      mobileBottomNavSingle.style.display = ''; 
                    }
                  }
                  
                } catch (e) {
                  logMessage_Error('å¤„ç†ç³»ç»Ÿè´¦å·UUIDå¤±è´¥:', e);
                  throw e;
                }
                
              } else {
                
                try {
                  logMessage_Info('æ£€æµ‹åˆ°æœªçŸ¥UUIDï¼Œå‡†å¤‡å¼¹çª—æç¤ºåè·³è½¬åˆ°ç™»å½•é¡µé¢');

                  
                  const loginContainer = document.getElementById('login-container');
                  const mainApp = document.getElementById('main-app');
                  const multiApp = document.getElementById('multi-account-app');
                  const authContainer = document.getElementById('auth-login-container');

                  
                  if (loginContainer) loginContainer.classList.add('hidden');
                  if (mainApp) mainApp.classList.add('hidden');
                  if (multiApp) multiApp.classList.add('hidden');

                  
                  if (authContainer) {
                    authContainer.classList.remove('hidden');
                    
                    authContainer.classList.remove('h-full', 'w-full');
                    
                    authContainer.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center');
                    
                    
                  }

                  
                  const mobileAuthContainer = document.getElementById('mobile-auth-container');
                  if (mobileAuthContainer) {
                    
                    mobileAuthContainer.classList.remove('hidden');
                    
                    mobileAuthContainer.classList.add('fixed', 'inset-0');
                  }

                  
                  const inputsToDisable = [
                    'auth-username',
                    'auth-password',
                    'auth-reg-username',
                    'auth-reg-password',
                    'auth-reg-password-confirm'
                  ];
                  inputsToDisable.forEach(inputId => {
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) {
                      inputElement.disabled = true;
                      
                      
                      
                    }
                  });

                  
                  const mobileInputsToDisable = [
                    'mobile-auth-username',
                    'mobile-auth-password',
                    'mobile-reg-username',
                    'mobile-reg-password',
                    'mobile-reg-password-confirm'
                  ];
                  mobileInputsToDisable.forEach(inputId => {
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) {
                      inputElement.disabled = true;
                    }
                  });

                  if (authContainer) authContainer.classList.remove('hidden');
                  
                  Swal.fire({
                    title: 'ä¼šè¯ä¸å­˜åœ¨', 
                    text: 'è¯¥ä¼šè¯å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ç™»å½•', 
                    icon: 'warning', 
                    confirmButtonText: 'ç¡®å®š', 
                    allowOutsideClick: false, 
                    allowEscapeKey: false 
                  }).then(() => {
                    
                    logMessage_Info('ç”¨æˆ·ç¡®è®¤å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                    window.location.href = '/';
                  });
                  return;
                } catch (e) {
                  logMessage_Error('å¤„ç†æœªçŸ¥UUIDå¤±è´¥:', e);
                  throw e;
                }
              }
            } catch (e) {
              logMessage_Error('å¤„ç†UUIDç±»å‹å¤±è´¥:', e);
              throw e;
            }
          } catch (e) {
            logMessage_Error('æ£€æŸ¥UUIDç±»å‹å¤±è´¥:', e);
            hideLoadingOverlays(); 
            Swal.fire({
              title: 'ç½‘ç»œé”™è¯¯', 
              text: 'æ— æ³•éªŒè¯ä¼šè¯çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 
              icon: 'warning', 
              confirmButtonText: 'ç¡®å®š' 
            }).then(() => {
              
              logMessage_Info('ç”¨æˆ·ç¡®è®¤æ£€æŸ¥UUIDç±»å‹å¤±è´¥å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
              window.location.href = '/'; 
            });
            
            
            
            
            
            return;
          }
        } else {
          
          logMessage_Info('Webæ¨¡å¼: æœªæ£€æµ‹åˆ°UUIDï¼Œæ˜¾ç¤ºè®¤è¯ç™»å½•é¡µé¢');
          
          hideLoadingOverlays();
          HiddenMobileLoadingOverlay();

          
          if (isMobileMode) {
            
            console.log("[Mobile Init] æ— UUIDï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯è®¤è¯é¡µé¢");
            $('mobile-auth-login-container').classList.remove('hidden');
            $('mobile-login-container').classList.add('hidden');
            
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');
          } else {
            
            showAuthLogin();
          }
          return; 
        }

        $('loading-overlay').classList.remove('hidden');
        ShowMobileLoadingOverlay();

        
        const isAuthenticated = await checkAuthStatus();

        
        

        if (!isAuthenticated) {
          hideLoadingOverlays(); 
          HiddenMobileLoadingOverlay();

          if (isMobileMode) {
            
            console.log("[Mobile Init] æœªè®¤è¯ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯è®¤è¯é¡µé¢");
            
            $('mobile-auth-login-container').classList.remove('hidden');
            $('mobile-login-container').classList.add('hidden');
            
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');
          } else {
            
            console.log("[Desktop Init] æœªè®¤è¯ï¼Œæ˜¾ç¤ºæ¡Œé¢ç«¯è®¤è¯é¡µé¢");
            showAuthLogin(); 
          }
          return; 
        }
        $('loading-overlay').classList.remove('hidden');
        ShowMobileLoadingOverlay();

        
        


        
        appInitialized = true;

        
        if (sessionUUID ) {
          connectWebSocket();
        }



        
        if (cdnErrorTimer) {
          clearTimeout(cdnErrorTimer);
          cdnErrorTimer = null;
        }

        
        

        logMessage_Info('åº”ç”¨åˆå§‹åŒ–æˆåŠŸï¼ŒCDNèµ„æºçŠ¶æ€æ­£å¸¸æˆ–å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ');

        const initialData = await callPythonAPI('get_initial_data');

        currentUserIsGuest = initialData.is_guest || false; 
        currentAuthUsername = initialData.auth_username || null; 
        logMessage_Info(`initializeApp: currentUserIsGuest = ${currentUserIsGuest}, auth_username = ${currentAuthUsername}`); 

        const userCombo = $('user-combo');
        userCombo.innerHTML = '<option value="">(æ–°ç”¨æˆ·)</option>';
        initialData.users.forEach(user => {
          const option = document.createElement('option');
          option.value = option.textContent = user;
          userCombo.appendChild(option);
        });

        
        const multiConfigUserSelect = $('multi-config-user-select');
        if (multiConfigUserSelect) {
          multiConfigUserSelect.innerHTML = '<option value="">(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)</option>';
          initialData.users.forEach(user => {
            const option = document.createElement('option');
            option.value = option.textContent = user;
            option.title = user; 
            multiConfigUserSelect.appendChild(option);
          });
          logMessage_Info(`[åˆå§‹åŒ–] multi-config-user-select å·²æ›´æ–°ï¼Œç”¨æˆ·æ•°: ${initialData.users.length}`);
        }

        createParamInputs($('params-container'), 'param', onParamChange);
        if (initialData.lastUser) userCombo.value = initialData.lastUser;
        await onUserChange();


        const hasSchoolLogin = initialData.isLoggedIn && initialData.userInfo;
        const hasSystemAuth = initialData.is_authenticated && !initialData.is_guest;
        const isGuestMode = initialData.is_authenticated && initialData.is_guest;
        

        

        
        let sessionModeInfo = null;
        try {
          sessionModeInfo = await callPythonAPI('get_session_mode_info');
          
        } catch (e) {
          logMessage_Error('è·å–ä¼šè¯æ¨¡å¼ä¿¡æ¯å¤±è´¥:', e);
          hideLoadingOverlays();
          Swal.fire({
            title: 'ç½‘ç»œé”™è¯¯', 
            text: 'è·å–ä¼šè¯æ¨¡å¼ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 
            icon: 'warning', 
            confirmButtonText: 'ç¡®å®š' 
          }).then(() => {
            
            logMessage_Info('ç”¨æˆ·ç¡®è®¤è·å–ä¼šè¯æ¨¡å¼ä¿¡æ¯å¤±è´¥å¼¹çª—ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
            window.location.href = '/'; 
          });
          return;
        }

        const hasLoadedTasks = sessionModeInfo && sessionModeInfo.has_tasks;

        $('loading-overlay').classList.remove('hidden');
        ShowMobileLoadingOverlay();

        resetUI();

        
        if (sessionModeInfo && sessionModeInfo.is_multi_account_mode) {
          logMessage_Info('æ£€æµ‹åˆ°ä¼šè¯ä¹‹å‰å¤„äºå¤šè´¦å·æ¨¡å¼ï¼Œæ­£åœ¨æ¢å¤...');

          
          currentUserData.group = initialData.auth_group || 'user';

          
          try {
            const result = await callPythonAPI('enter_multi_account_mode');
            if (!result.success) {
              logMessage_Error('æ— æ³•è¿›å…¥å¤šè´¦å·æ¨¡å¼ï¼Œè¿”å›ç™»å½•ç•Œé¢');
              return;
            }
            
            if (!sessionModeInfo.global_params && result.params) {
              pythonParams = result.params;
            }
          } catch (e) {
            logMessage_Error('è°ƒç”¨ enter_multi_account_mode å¤±è´¥:', e);
            return;
          }

          hideLoadingOverlays();
          HiddenMobileLoadingOverlay();
          
          AMAP_API_KEY = initialData.amap_key || "";
          if (AMAP_API_KEY) {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆå¤šè´¦å·æ¨¡å¼æ¢å¤ï¼‰', e);
            }
          }
          $('loading-overlay').classList.remove('hidden');
          ShowMobileLoadingOverlay();


          
          if (isMobileMode) {
            
            const mobileMultiApp = document.getElementById('mobile-multi-account-app');
            const mobileLoginContainer = document.getElementById('mobile-login-container');
            const mobileAuthContainer = document.getElementById('mobile-auth-login-container');
            if (mobileMultiApp) {
              mobileMultiApp.classList.remove('hidden');
              console.log('[ä¼šè¯æ¢å¤] ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º mobile-multi-account-app');
            }
            if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
            if (mobileAuthContainer) mobileAuthContainer.classList.add('hidden');

            
            updateMobileNavVisibility(true, 'multi');

            
            switchMobilePanel('mobile-multi-control-panel', 'multi');
            console.log('[ä¼šè¯æ¢å¤] ç§»åŠ¨ç«¯ï¼šå·²é»˜è®¤æ¿€æ´» mobile-multi-control-panel');

            
            $('multi-account-app').classList.add('hidden');
            $('main-app').classList.add('hidden');
          } else {
            
            $('multi-account-app').classList.remove('hidden');
            $('multi-account-app').classList.add('grid');
            $('main-app').classList.add('hidden');
            console.log('[ä¼šè¯æ¢å¤] æ¡Œé¢ç«¯ï¼šæ˜¾ç¤º multi-account-app');
          }
          

          
          if (!multiAccountMap && AMapInstance) {
            try {
              
              multiAccountMap = new AMapInstance.Map('multi-map-container', {
                viewMode: '3D',
                pitch: 55,
                rotation: 0,
                zoom: 17,
                center: [113.390342, 22.527403],
                renderOptions: {
                  willReadFrequently: true  
                }
              });

              
              const ctrlBar = new AMapInstance.ControlBar({
                position: { left: '12px', top: '12px' },
                showZoomBar: false,
                showControlButton: true
              });
              multiAccountMap.addControl(ctrlBar);

              
              try {
                const buildings = new AMapInstance.BuildingLayer();
                buildings.setMap(multiAccountMap);
              } catch (e) {
                logMessage_Warning('BuildingLayer not available (multi):', e);
              }

              multiAccountMap.on('zoomchange', () => {
                if (!multiAccountMap) return;
                const z = multiAccountMap.getZoom();
                const zoomLevelEl = $('multi-zoom-level');
                if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
              });

              
              if (window.multiMapCleanup) window.multiMapCleanup();
              window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

              multiAccountMap.setStatus({
                doubleClickZoom: true,
                dragEnable: true,
                scrollWheel: true,
                keyboardEnable: true
              });

              
              ensureMultiControls();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å¤šè´¦å·åœ°å›¾å¤±è´¥:', e);
            }
            
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');

          }

          
          try {
            const configUsers = await callPythonAPI('multi_get_all_config_users');
            const select = $('multi-config-user-select');
            select.innerHTML = '<option value="">(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)</option>';
            configUsers.users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = opt.textContent = u;
              select.appendChild(opt);
            });
          } catch (e) {
            logMessage_Error('åŠ è½½é…ç½®ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', e);
          }

          
          if (sessionModeInfo.global_params) {
            pythonParams = sessionModeInfo.global_params;
          }

          
          try {
            const container = $('multi-global-params-container');
            container.innerHTML = '';
            createParamInputs(container, 'multi-param', onGlobalParamChange);
            updateParamInputs(container, 'multi-param', pythonParams);
          } catch (e) {
            logMessage_Error('åˆå§‹åŒ–å…¨å±€å‚æ•°UIå¤±è´¥:', e);
          }

          
          try {
            bindImmediateRefreshForUserSelects();
            updateMultiGlobalButtons(true, true);

            
            await callPythonAPI('set_multi_run_only_incomplete',
              document.getElementById('multi-run-only-incomplete-check').checked
            );
          } catch (e) {
            logMessage_Error('ç»‘å®šå¤šè´¦å·UIäº‹ä»¶å¤±è´¥:', e);
          }

          
          try {
            const accountsResult = await callPythonAPI('multi_get_all_accounts_status');
            if (accountsResult && accountsResult.accounts) {
              renderMultiAccountList(accountsResult.accounts);
              logMessage(`å·²æ¢å¤å¤šè´¦å·æ¨¡å¼ï¼Œå½“å‰æœ‰ ${accountsResult.accounts.length} ä¸ªè´¦å·`);
            } else {
              logMessage(`å·²æ¢å¤å¤šè´¦å·æ¨¡å¼ï¼Œå½“å‰æœ‰ 0 ä¸ªè´¦å·`);
            }
          } catch (e) {
            logMessage_Error('æ¢å¤è´¦å·åˆ—è¡¨å¤±è´¥:', e);
            logMessage(`å·²æ¢å¤å¤šè´¦å·æ¨¡å¼ï¼Œå½“å‰æœ‰ ${sessionModeInfo.multi_account_count || 0} ä¸ªè´¦å·ï¼ˆåˆ—è¡¨åŠ è½½å¤±è´¥ï¼‰`);
          }

          
          setTimeout(async () => {
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿å¤±è´¥:', e);
            }
          }, 100);

          
          const base = pythonParams.theme_base_color || '#7dd3fc';
          setBaseColor(base, base);

          
          
          
          startMultiAccountAutoRefresh(10000);

          hideLoadingOverlays();
          HiddenMobileLoadingOverlay();
          
        }


        
        
        else if (hasSchoolLogin || hasLoadedTasks) {
          
          
          currentUserData = initialData.userInfo || (sessionModeInfo && sessionModeInfo.user_data) || {};

          
          currentUserData.group = initialData.auth_group || 'guest';

          if (initialData.device_ua) {
            currentSessionUA = initialData.device_ua;
            logMessage_Info(`[ä¼šè¯æ¢å¤] æˆåŠŸæ¢å¤ User-Agent: ${currentSessionUA.substring(0, 50)}...`);
          } else {
            logMessage_Warning("[ä¼šè¯æ¢å¤] æœªèƒ½ä» initialData ä¸­æ¢å¤ User-Agentã€‚");
            currentSessionUA = "NULL (Restored)"; 
          }

          hideLoadingOverlays();
          
          AMAP_API_KEY = initialData.amap_key || "";
          if (AMAP_API_KEY) {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆä¼šè¯æ¢å¤ï¼‰', e);
            }
          } else {
            
            hideLoadingOverlays();
            logMessage_Info("[è­¦å‘Š] æœªé…ç½®é«˜å¾·åœ°å›¾API Keyï¼Œè¯·åœ¨å¼¹çª—ä¸­è¾“å…¥ã€‚");
            $('amap-key-modal').classList.remove('hidden');
            $('amap-key-modal').classList.add('flex');
            document.body.classList.add('modal-visible');
          }
          $('loading-overlay').classList.remove('hidden');

          if (refreshUserListInterval) clearInterval(refreshUserListInterval); 
          refreshUserListInterval = setInterval(refreshUserList, 5000); 
          logMessage_Info('refreshUserList interval started.'); 

          showMainApp();
          const name = currentUserData.name || 'ç¦»çº¿æ¨¡å¼';  
          $('user-name-label').textContent = `å§“å: ${name}`;
          $('user-id-label').textContent = `å­¦å·: ${currentUserData.student_id || 'æœªç™»å½•'}`;
          updateDashboard();
          await refreshTasks();

          
          let isTaskRestored = false;
          try {
            isTaskRestored = await checkBackgroundTaskOnLoad();
          } catch (err) {
            logMessage_Warning('æ£€æŸ¥åå°ä»»åŠ¡å¤±è´¥:', err);
          }
          
          

          

          
          
          
          
          


          
          

          
          

          
          
          
          

          const base = pythonParams.theme_base_color || '#7dd3fc';
          setBaseColor(base, base);

          
          setTimeout(async () => {
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿å¤±è´¥:', e);
            }
          }, 100);

          
          const adminBtn = $('show-admin-panel');
          if (adminBtn) adminBtn.classList.remove('hidden');
          hideLoadingOverlays();
          await fetchNotifications();

        }
        
        else if (hasSystemAuth || isGuestMode) {
          
          
          
          currentUserData.group = initialData.auth_group || 'guest';
          logMessage_Info(`[Auth Restore] æ¢å¤ç³»ç»Ÿæƒé™ç»„: ${currentUserData.group}`);

          $('loading-overlay').classList.remove('hidden');
          

          if (isMobileMode) {
            
            console.log("[Mobile Init] å·²è®¤è¯ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯å­¦æ ¡è´¦å·ç™»å½•/ä¼šè¯ç®¡ç†");
            
            $('mobile-auth-login-container').classList.add('hidden');
            $('mobile-login-container').classList.remove('hidden');
            
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.add('hidden');

            
            updateMobileNavVisibility(false);

            
            setTimeout(async () => {
              try {
                await loadMobileSessionsList();
                
              } catch (e) {
                console.error('[Mobile Init] åŠ è½½ç§»åŠ¨ç«¯æ•°æ®å¤±è´¥:', e);
              }
            }, 100);
          } else {
            
            console.log("[Desktop Init] å·²è®¤è¯ï¼Œæ˜¾ç¤ºæ¡Œé¢ç«¯å­¦æ ¡è´¦å·ç™»å½•/ä¼šè¯ç®¡ç†");
            $('auth-login-container').classList.add('hidden');
            $('login-container').classList.remove('hidden');
          }

          
          await onUserChange();

          
          setTimeout(async () => {
            try {
              await initializeInlineAdminPanel();
            } catch (e) {
              logMessage_Error('åˆå§‹åŒ–å†…åµŒç®¡ç†é¢æ¿å¤±è´¥:', e);
            }
          }, 100);

          
          AMAP_API_KEY = initialData.amap_key || "";
          if (AMAP_API_KEY) {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('åœ°å›¾åŠ è½½å¤±è´¥ï¼ˆç³»ç»Ÿè´¦å·æ¢å¤ï¼‰', e);
            }
          }

          hideLoadingOverlays();
          
          if (isGuestMode) {
            logMessage_Info('[æ¸¸å®¢æ¨¡å¼] éƒ¨åˆ†åŠŸèƒ½å—é™ï¼Œè¯·ä¿å­˜å½“å‰åœ°å€ä»¥ä¾¿æ¢å¤ä¼šè¯');

            
            
            
            
            
            
            
            
            
            

            
            
            
            

            const guestToast = $('guest-warning-toast');
            const guestOverlay = $('guest_warning_overlay');
            if (guestToast) {
              
              if (guestOverlay) {
                guestOverlay.classList.remove('hidden');
              }
              guestToast.classList.remove('hidden');
            }

          }




          $('loading-overlay').classList.remove('hidden');


          
          const adminBtnLogin = $('show-admin-panel-login');
          if (adminBtnLogin) {
            adminBtnLogin.classList.remove('hidden');
          }
          const adminBtnMulti = $('show-admin-panel-multi');
          if (adminBtnMulti) adminBtnMulti.classList.remove('hidden');

          hideLoadingOverlays();

        } else {
          
          AMAP_API_KEY = initialData.amap_key || "";
          if (!AMAP_API_KEY) {
            logMessage_Info("[è­¦å‘Š] æœªé…ç½®é«˜å¾·åœ°å›¾API Keyï¼Œè¯·åœ¨å¼¹çª—ä¸­è¾“å…¥ã€‚");
            $('amap-key-modal').classList.remove('hidden');
            $('amap-key-modal').classList.add('flex');
          } else {
            try {
              await loadAMapOnce();
            } catch (e) {
              logMessage_Error('AMap SDK åŠ è½½å¤±è´¥ï¼ˆready é˜¶æ®µï¼‰', e);
            }
          }



          
          
          hideLoadingOverlays();
        }

        if (pythonParams.theme_style) {
          setThemeStyle(pythonParams.theme_style);
        }

        
        await refreshUserList();

        const loadingOverlay = $('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        bindImmediateRefreshForUserSelects();

        
        const attEnabled = $('param-auto_attendance_enabled');
        const attRefresh = $('param-auto_attendance_refresh_s');
        const attRadius = $('param-attendance_user_radius_m');
        if (attEnabled) attEnabled.addEventListener('change', onParamChange);
        if (attRefresh) attRefresh.addEventListener('change', onParamChange);
        if (attRadius) attRadius.addEventListener('change', onParamChange);

        
        $('confirm-amap-key-btn').addEventListener('click', onConfirmAmapKey);

        
        

        
        if (sessionUUID) {
          startSessionValidityCheck();
        }

        
        
        if (isMobileMode) {
          setTimeout(() => {
            restoreMobileTaskState();
            
            hideMobileLoadingOverlay();
          }, 1000);
        }
      } catch (err) {
        
        hideLoadingOverlays();
        showModalAlert('æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚', 'ç½‘ç»œé”™è¯¯');
        IS_OFFLINE = true;
      }
    }

    
    async function restoreMobileTaskState() {
      try {
        logMessage_Info('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] å¼€å§‹æ£€æŸ¥åç«¯ä»»åŠ¡çŠ¶æ€...');

        const statusRes = await callPythonAPI_raw('/api/background_task/status', 'GET', null);

        if (statusRes.success && statusRes.task_status) {
          const status = statusRes.task_status;

          
          if (status.status === 'running' || status.status === 'paused') {
            logMessage_Info('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] æ£€æµ‹åˆ°åç«¯ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œæ¢å¤çŠ¶æ€...');

            
            if (status.task_indices && status.current_task_index !== undefined) {
              const task_list = status.task_indices;
              const current_list_index = status.current_task_index;
              if (task_list.length > current_list_index) {
                const global_task_index = task_list[current_list_index];
                selectedTaskIndex = global_task_index;
                logMessage_Info(`[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] æ¢å¤ä»»åŠ¡ç´¢å¼•: ${selectedTaskIndex}`);

                
                if (currentTasks && currentTasks[selectedTaskIndex]) {
                  await selectTask(selectedTaskIndex, false);
                }
              }
            }

            
            if (status.status === 'running') {
              mobileTaskRunning = true;
              mobileTaskPaused = false;
              updateMobileTaskUI('è¿è¡Œä¸­', 'ä»»åŠ¡æ‰§è¡Œä¸­...');
              logMessage_Info('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] UIçŠ¶æ€è®¾ç½®ä¸ºè¿è¡Œä¸­');
            } else if (status.status === 'paused') {
              mobileTaskRunning = true;
              mobileTaskPaused = true;
              updateMobileTaskUI('å·²æš‚åœ', 'ä»»åŠ¡å·²æš‚åœ');
              logMessage_Info('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] UIçŠ¶æ€è®¾ç½®ä¸ºå·²æš‚åœ');
            }

            
            startBackgroundTaskPolling();
            logMessage_Info('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] å·²å¯åŠ¨åå°ä»»åŠ¡è½®è¯¢');
          } else {
            logMessage_Info('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] åç«¯æ— æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡');
          }
        }
      } catch (error) {
        logMessage_Error('[ç§»åŠ¨ç«¯çŠ¶æ€æ¢å¤] æ¢å¤çŠ¶æ€å¤±è´¥:', error);
      }
    }

    let socket = null; 

    
    function connectWebSocket() {
      if (socket && socket.connected) {
        logMessage_Info("WebSocket å·²è¿æ¥.");
        return;
      }

      if (!sessionUUID) {
        logMessage_Warning("æ— æ³•è¿æ¥ WebSocketï¼šç¼ºå°‘ sessionUUIDã€‚");
        return;
      }

      logMessage_Info("å°è¯•è¿æ¥ WebSocket...");
      
      socket = io({
        
        
        autoConexceptnect: false,  
        reconnection: true,  
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      
      socket.connect();

      socket.on('connect', () => {
        logMessage_Info('WebSocket è¿æ¥æˆåŠŸã€‚SID:', socket.id);
        
        socket.emit('join', { session_id: sessionUUID });
        
        
      });

      socket.on('disconnect', (reason) => {
        logMessage_Warning('WebSocket è¿æ¥å·²æ–­å¼€:', reason);
        logMessage_Info("[System] WebSocket è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡è¿...");
        
      });

      socket.on('connect_error', (error) => {
        
        if (!isInNetworkErrorState) {
          logMessage_Error('WebSocket è¿æ¥é”™è¯¯:', error);
          logMessage_Info("[System-Error] WebSocket è¿æ¥å¤±è´¥");
        }
      });

      
      socket.on('log_message', (data) => {
        if (data && data.msg) {
          
          logMessage(data.msg, 'INFO', 'Backend');
        }
      });

      
      
      

      
      socket.on('multi_status_update', (data) => {
        if (data && data.username && data.data) {
          logMessage_Debug(`[Socket] æ”¶åˆ° ${data.username} çŠ¶æ€æ›´æ–°`);
          multi_updateAccountStatus(data.username, data.data);
        }
      });

      
      socket.on('accounts_updated', (data) => {
        if (data && data.accounts) {
          logMessage(`[Socket] æ”¶åˆ°è´¦å·åˆ—è¡¨æ›´æ–°ï¼Œå…± ${data.accounts.length} ä¸ªè´¦å·`, 'INFO', 'Socket');
          onAccountsUpdated(data.accounts); 
        }
      });

      
      socket.on('multi_global_buttons_update', (data) => {
        if (data) {
          logMessage_Debug(`[Socket] æ”¶åˆ°å…¨å±€æŒ‰é’®çŠ¶æ€æ›´æ–°`);
          updateMultiGlobalButtons(data.start_disabled, data.stop_disabled);
          
          const exitBtn = document.getElementById("exit-multi-mode-btn");
          if (exitBtn) {
            exitBtn.disabled = !!data.exit_disabled;
          }
        }
      });

      
      socket.on('multi_position_update', (data) => {
        if (data && data.username && typeof data.lon === 'number' && typeof data.lat === 'number') {
          multi_updateRunnerPosition(data.username, data.lon, data.lat, data.name || data.username);
        }
      });

      
      socket.on('runner_position_update_new', (data) => {
        logMessage_Debug('[Socket] æ”¶åˆ° runner_position_update äº‹ä»¶');
        if (data) {
          
          if (data.task_index !== undefined && data.task_index !== selectedTaskIndex) {
            logMessage_Info(`[Socket] ä»»åŠ¡åˆ‡æ¢: æ­£åœ¨æ‰§è¡Œä»»åŠ¡ #${data.task_index}`);
            
            selectedTaskIndex = data.task_index;

            
            renderTaskList();

            
            
            
          }

          
          updateRunnerPosition(data.lon, data.lat, data.distance, data.target_sequence, data.duration, data.center_now);
          logMessage_Debug(`[Socket] æ”¶åˆ°å½“å‰ä½ç½®æ›´æ–°: lon=${data.lon}, lat=${data.lat}`);
        }
      });

      
      socket.on('task_completed', (data) => {
        if (data && typeof data.task_index !== 'undefined') {
          onTaskCompleted(data.task_index);
        }
      });

      
      socket.on('run_stopped', () => {
        onRunStopped();
      });
      
      socket.on('onNotificationsUpdated', (data) => {
        logMessage("æ”¶åˆ°åå°æ¨é€çš„é€šçŸ¥æ›´æ–°", 'INFO', 'Socket');
        
        if (data && data.success) {
          
          onNotificationsUpdated(data);
        }
      });

      
      socket.on('verification_codes_updated', () => {
        logMessage_Info("[Socket] æ”¶åˆ°éªŒè¯ç åˆ—è¡¨æ›´æ–°æ¨é€");
        
        const modal = $('verification-codes-modal');
        if (modal && !modal.classList.contains('hidden')) {
          logMessage_Info("éªŒè¯ç æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...");
          loadVerificationCodes(); 
        } else {
          logMessage_Info("éªŒè¯ç æ¨¡æ€æ¡†æœªæ‰“å¼€ï¼Œè·³è¿‡åˆ·æ–°ã€‚");
        }
      });



    }


    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeApp().catch(err => {
          logMessage_Error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', err);
          
          appInitialized = false;
          if (cdnErrorCount > 0) {
            if (cdnErrorTimer) clearTimeout(cdnErrorTimer);
            const errorOverlay = document.getElementById('cdn-error-overlay');
            if (errorOverlay) {
              errorOverlay.style.setProperty('display', 'flex', 'important');
            }
          }
        });
      });
    } else {
      
      initializeApp().catch(err => {
        logMessage_Error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', err);
        
        appInitialized = false;
        if (cdnErrorCount > 0) {
          if (cdnErrorTimer) clearTimeout(cdnErrorTimer);
          const errorOverlay = document.getElementById('cdn-error-overlay');
          if (errorOverlay) {
            errorOverlay.style.setProperty('display', 'flex', 'important');
          }
        }
      });
    }

    function enhanceMapInteraction(mapInstance) {
      if (!mapInstance) return () => { }; 
      const container = mapInstance.getContainer();
      if (!container) return () => { }; 

      const handlers = [];

      const addManagedListener = (element, type, listener, options) => {
        element.addEventListener(type, listener, options);
        handlers.push({ element, type, listener, options });
      };

      const wheelHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!mapInstance) return; 
        if (e.deltaY < 0) mapInstance.zoomIn();
        else mapInstance.zoomOut();
      };
      addManagedListener(container, 'wheel', wheelHandler, { passive: false });

      const contextMenuHandler = (e) => e.preventDefault();
      addManagedListener(container, 'contextmenu', contextMenuHandler);

      const DRAG_SAME_DIRECTION = true;
      let rmbLongPressTimer = null, mmbLongPressTimer = null, rmbDragging = false, mmbDragging = false, lastClientX = 0, lastClientY = 0;

      function doPanBy(mouseX, mouseY) {
        if (!mapInstance) return; 
        const dx = mouseX - lastClientX; const dy = mouseY - lastClientY;
        if (dx !== 0 || dy !== 0) {
          const panDx = DRAG_SAME_DIRECTION ? dx : -dx; const panDy = DRAG_SAME_DIRECTION ? dy : -dy;
          mapInstance.panBy(panDx, panDy); lastClientX = mouseX; lastClientY = mouseY;
        }
      }

      const mouseDownHandler = (e) => {
        if (e.button === 0) return; lastClientX = e.clientX; lastClientY = e.clientY;
        if (e.button === 1) { e.preventDefault(); e.stopPropagation(); mmbLongPressTimer = setTimeout(() => { mmbDragging = true; }, 0); }
        if (e.button === 2) { e.preventDefault(); e.stopPropagation(); rmbLongPressTimer = setTimeout(() => { rmbDragging = true; }, 0); }
      };
      addManagedListener(container, 'mousedown', mouseDownHandler);

      const mouseMoveHandler = (e) => { if (rmbDragging || mmbDragging) { e.preventDefault(); e.stopPropagation(); doPanBy(e.clientX, e.clientY); } };
      addManagedListener(container, 'mousemove', mouseMoveHandler);

      function endDrag(button) {
        if (button === 2) { clearTimeout(rmbLongPressTimer); rmbLongPressTimer = null; rmbDragging = false; }
        if (button === 1) { clearTimeout(mmbLongPressTimer); mmbLongPressTimer = null; mmbDragging = false; }
      }

      const mouseUpHandler = (e) => {
        endDrag(e.button);
        
        
        
        if (isDrawing && map) {
          map.setStatus({ dragEnable: false });
        }
      };
      addManagedListener(container, 'mouseup', mouseUpHandler);

      const mouseLeaveHandler = () => { endDrag(1); endDrag(2); };
      addManagedListener(container, 'mouseleave', mouseLeaveHandler);

      const windowMouseUpHandler = () => { leftMouseDown = false; isPathDrawing = false; endDrag(1); endDrag(2); };
      addManagedListener(window, 'mouseup', windowMouseUpHandler, true);

      
      return () => {
        handlers.forEach(({ element, type, listener, options }) => {
          element.removeEventListener(type, listener, options);
        });
      };
    }

    
    function loadAMapOnce() {
      if (AMapReady && AMapInstance) return Promise.resolve(AMapInstance);
      if (amapLoadingPromise) return amapLoadingPromise;

      
      if (window.AMap && window.AMap.ControlBar) { 
        AMapInstance = window.AMap;
        AMapReady = true;
        amapLoadingPromise = Promise.resolve(AMapInstance);
        return amapLoadingPromise;
      }

      
      if (!AMAP_API_KEY) {
        logMessage_Info("[é”™è¯¯] å°è¯•åŠ è½½åœ°å›¾å¤±è´¥ï¼šAPI Keyä¸ºç©ºã€‚");
        
        $('amap-key-modal').classList.remove('hidden');
        $('amap-key-modal').classList.add('flex');
        
        return Promise.reject("API Key is missing.");
      }

      
      amapLoadingPromise = AMapLoader.load({
        key: AMAP_API_KEY, 
        version: "2.0",
        plugins: ['AMap.ControlBar', 'AMap.BuildingLayer', 'AMap.Walking'] 
      })
        .then((AMap) => {
          AMapInstance = AMap;
          AMapReady = true;
          logMessage_Info("é«˜å¾·åœ°å›¾SDKåŠæ‰€æœ‰æ’ä»¶åŠ è½½æˆåŠŸã€‚");
          return AMapInstance;
        })
        .catch((err) => {
          logMessage_Error("AMap åŠ è½½å¤±è´¥", err);
          logMessage_Info("[JS-Error] é«˜å¾·åœ°å›¾SDKåŠ è½½å¤±è´¥ï¼åœ°å›¾åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚");
          AMapReady = false;
          AMapInstance = null;
          amapLoadingPromise = null;
          throw err;
        });

      return amapLoadingPromise;
    }

    
    function ensureSingleMap() {
      if (map || !AMapReady || !AMapInstance) return;
      const container = document.getElementById('map-container');
      if (!container) return;
      const isHidden = container.offsetParent === null;
      if (isHidden) return; 
      initMap(AMapInstance);
    }

    
    function forceProjectionRefresh() {
      if (!map) return;
      try {
        
        map.setStatus({ dragEnable: false });

        
        map.resize();

        
        requestAnimationFrame(() => {
          const overlays = [...polylines.recommended];
          if (polylines.draft) overlays.push(polylines.draft);
          if (polylines.run) overlays.push(polylines.run);
          if (polylines.history) overlays.push(polylines.history);

          if (overlays.length > 0) {
            map.setFitView(overlays, false, [60, 60, 60, 60]);
          } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
            const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
            map.setFitView(pts, false, [60, 60, 60, 60]);
          } else {
            map.setZoomAndCenter(17, [113.390342, 22.527403]);
          }

          
          map.setStatus({ dragEnable: true });
        });
      } catch (e) {
        logMessage_Warning('forceProjectionRefresh warning:', e);
      }
    }
    
    async function refreshMobileSettings() {
      const container = document.getElementById('mobile-params-container');
      if (!container) return;

      showTempMessage('æ­£åœ¨åˆ·æ–°å‚æ•°...', 'info');

      try {
        
        const params = await callPythonAPI('get_params');

        if (params) {
          
          pythonParams = params;

          
          if (typeof updateParamInputs === 'function') {
            updateParamInputs(container, 'mobile-param', pythonParams);
          }

          
          if (params.theme_base_color) {
            setBaseColor(params.theme_base_color, params.theme_base_color);
          }

          showTempMessage('å‚æ•°å·²åˆ·æ–°', 'success');
        } else {
          showTempMessage('åˆ·æ–°å¤±è´¥ï¼šæœªè·å–åˆ°æ•°æ®', 'error');
        }
      } catch (e) {
        console.error('[ç§»åŠ¨ç«¯] åˆ·æ–°å‚æ•°å¤±è´¥:', e);
        showTempMessage('åˆ·æ–°å¤±è´¥', 'error');
      }
    }

    
    async function saveMobileSettings() {
      const container = document.getElementById('mobile-params-container');
      if (!container) return;

      showTempMessage('æ­£åœ¨ä¿å­˜è®¾ç½®...', 'info');

      try {
        
        const inputs = container.querySelectorAll('input, select');
        let savedCount = 0;

        
        for (const input of inputs) {
          const key = input.dataset.key;
          if (!key) continue;

          let value;
          if (input.type === 'checkbox') {
            value = input.checked;
          } else if (input.type === 'number') {
            value = parseFloat(input.value) || 0;
          } else {
            value = input.value;
          }

          
          pythonParams[key] = value;

          
          await callPythonAPI('update_param', key, value);
          savedCount++;
        }

        showTempMessage('è®¾ç½®å·²ä¿å­˜', 'success');
      } catch (e) {
        console.error('[ç§»åŠ¨ç«¯] ä¿å­˜å‚æ•°å¤±è´¥:', e);
        showTempMessage('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
      }
    }

    function ensureSingleControls() {
      const container = document.getElementById('map-container');
      if (!container) return;

      
      const hasZoomIn = !!document.getElementById('zoom-in');
      const hasZoomOut = !!document.getElementById('zoom-out');
      const hasReset = !!document.getElementById('reset-view-btn');

      if (hasZoomIn && hasZoomOut && hasReset) {
        
        attachSingleControlHandlers();
        return;
      }

      
      const overlay = document.createElement('div');
      overlay.className = 'absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200';
      overlay.innerHTML = `
    <button id="zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
  `;
      container.appendChild(overlay);

      attachSingleControlHandlers();
    }

    function attachSingleControlHandlers() {
      const zi = document.getElementById('zoom-in');
      const zo = document.getElementById('zoom-out');
      const rv = document.getElementById('reset-view-btn');

      
      if (zi && !zi._bound) {
        zi.addEventListener('click', () => { if (map) map.zoomIn(); });
        zi._bound = true;
      }
      if (zo && !zo._bound) {
        zo.addEventListener('click', () => { if (map) map.zoomOut(); });
        zo._bound = true;
      }
      if (rv && !rv._bound) {
        rv.addEventListener('click', resetMapView);
        rv._bound = true;
      }
    }

    function ensureMultiControls() {
      const container = document.getElementById('multi-map-container');
      if (!container) return;

      const hasZoomIn = !!document.getElementById('multi-zoom-in');
      const hasZoomOut = !!document.getElementById('multi-zoom-out');
      const hasReset = !!document.getElementById('multi-reset-view-btn');

      if (hasZoomIn && hasZoomOut && hasReset) {
        attachMultiControlHandlers();
        return;
      }

      const overlay = document.createElement('div');
      overlay.className = 'absolute top-4 right-3 z-10 bg-white/80 backdrop-blur-sm rounded-full shadow-md flex items-center space-x-1 p-1 border border-slate-200';
      overlay.innerHTML = `
    <button id="multi-zoom-in" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">+</button>
    <span id="multi-zoom-level" class="text-xs font-mono select-none w-8 text-center">17</span>
    <button id="multi-zoom-out" class="w-9 h-9 font-bold text-xl text-center hover:bg-slate-100 rounded-full text-slate-700">-</button>
    <button id="multi-reset-view-btn" class="w-9 h-9 font-bold text-lg flex items-center justify-center hover:bg-slate-100 rounded-full text-slate-700" title="å¤ä½è§†è§’">ğŸ¯</button>
  `;
      container.appendChild(overlay);

      attachMultiControlHandlers();
    }

    function attachMultiControlHandlers() {
      const zi = document.getElementById('multi-zoom-in');
      const zo = document.getElementById('multi-zoom-out');
      const rv = document.getElementById('multi-reset-view-btn');

      if (zi && !zi._bound) {
        zi.addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomIn(); });
        zi._bound = true;
      }
      if (zo && !zo._bound) {
        zo.addEventListener('click', () => { if (multiAccountMap) multiAccountMap.zoomOut(); });
        zo._bound = true;
      }
      if (rv && !rv._bound) {
        rv.addEventListener('click', multi_resetMapView);
        rv._bound = true;
      }
    }



    
    function initMap(AMap) {
      
      if (map) {
        const container = map.getContainer();
        if (container && container.id === 'map-container') {
          return; 
        }
        
        try { map.destroy(); } catch (e) { }
        map = null;
      }

      AMapInstance = AMap;
      
      
      map = new AMapInstance.Map('map-container', {
        viewMode: '3D', pitch: 55, rotation: 0, zoom: 17,
        center: [113.390342, 22.527403],
        renderOptions: {
          willReadFrequently: true  
        }
      });

      const ctrlBar = new AMapInstance.ControlBar({
        position: { left: '12px', top: '12px' }, showZoomBar: false, showControlButton: true
      });
      map.addControl(ctrlBar);

      try { const buildings = new AMapInstance.BuildingLayer(); buildings.setMap(map); } catch (e) { logMessage_Warning('BuildingLayer not available:', e); }

      map.on('mousedown', onMapMouseDown);
      map.on('mousemove', onMapMouseMove);
      map.on('mouseup', onMapMouseUp);
      map.on('zoomchange', () => {
        if (!map) return;
        const z = map.getZoom();
        const zoomLevelEl = $('zoom-level');
        if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
      });

      if (window.mapCleanup) window.mapCleanup();
      window.mapCleanup = enhanceMapInteraction(map);
      map.setStatus({ doubleClickZoom: true, dragEnable: true, scrollWheel: true, keyboardEnable: true });

      
      map.on('complete', () => {
        logMessage_Info("åœ°å›¾å®ä¾‹å·²åŠ è½½ã€‚");
        
        if (resolveMapReady) {
          resolveMapReady(map);
        }
      });
    }


    function showMainApp() {
      
      mapReadyPromise = new Promise(resolve => {
        resolveMapReady = resolve;
      });

      
      if (isMobileMode) {
        
        const mobileMainApp = document.getElementById('mobile-main-app');
        const mobileLoginContainer = document.getElementById('mobile-login-container');
        const mobileAuthContainer = document.getElementById('mobile-auth-login-container');
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');

        if (mobileMainApp) {
          mobileMainApp.classList.remove('hidden');
          console.log('[å•è´¦å·æ¨¡å¼] ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º mobile-main-app');
        }
        if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
        if (mobileAuthContainer) mobileAuthContainer.classList.add('hidden');
        if (mobileMultiApp) mobileMultiApp.classList.add('hidden');

        
        updateMobileNavVisibility(true, 'single');

        
        switchMobileSinglePanel('mobile-control-panel');
        console.log('[å•è´¦å·æ¨¡å¼] ç§»åŠ¨ç«¯ï¼šå·²é»˜è®¤æ¿€æ´» mobile-control-panel');

        
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.add('hidden');
        $('login-container').classList.add('hidden');
        $('auth-login-container').classList.add('hidden');
      } else {
        
        $('auth-login-container').classList.add('hidden');
        $('login-container').classList.add('hidden');
        $('main-app').classList.remove('hidden');
        $('main-app').classList.add('grid');
        console.log('[å•è´¦å·æ¨¡å¼] æ¡Œé¢ç«¯ï¼šæ˜¾ç¤º main-app');
      }

      logMessage_Info("å·²è¿›å…¥å•è´¦å·æ¨¡å¼ã€‚");

      
      destroySingleMap();

      
      
      logMessage_Info("ç­‰å¾…UIæ¸²æŸ“ç¨³å®š...");
      setTimeout(() => {
        logMessage_Info("UIç¨³å®šï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...");
        loadAMapOnce().then(() => {
          initMap(AMapInstance); 
          ensureSingleControls();

          
          
        }).catch((e) => logMessage_Error('AMap åŠ è½½å¤±è´¥ï¼ˆå»¶è¿Ÿåˆ›å»ºé˜¶æ®µï¼‰', e));
      }, 100); 
    }

    function resetUI() {
      $('main-app').classList.add('hidden'); $('main-app').classList.remove('grid'); $('login-container').classList.remove('hidden');
      $('user-name-label').textContent = 'å§“å: NULL'; $('user-id-label').textContent = 'å­¦å·: NULL';
      const logoutBtn = $('logout-button'); logoutBtn.classList.remove('!text-amber-500'); logoutBtn.classList.add('!text-red-600');
      currentTasks = []; selectedTaskIndex = -1; currentUserData = {}; currentRunData = {};
      $('task-list').innerHTML = ''; $('history-list').innerHTML = ''; $('target-points-text').innerHTML = '';

      
      IS_OFFLINE = false;
      const uaLabel = $('ua-label'); if (uaLabel) uaLabel.textContent = ' (æœªåŠ è½½) ';
      const uaBtn = $('random-ua-btn'); if (uaBtn) uaBtn.disabled = false;


      
      try {
        const container = document.getElementById('map-container');
        if (container) container.classList.remove('drawing');
      } catch (_) { }
      isDrawing = false;
      isPathDrawing = false;
      leftMouseDown = false;
      pendingUnlockMap = false;
      
      draftPath = [];
      draftPathLngLat = [];
      pendingPoints = [];
      isUpdating = false;
      lastMouseMoveTime = 0;
      
      try { document.body.classList.remove('modal-visible'); } catch (_) { }

      
      $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
      $('start-run-button').classList.remove('btn-danger');
      $('start-run-button').classList.add('btn-primary');
      $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
      $('start-all-button').classList.remove('btn-danger');
      $('start-all-button').classList.add('btn-secondary');

      
      stopBackgroundTaskPolling();

      updateDashboard();

      destroySingleMap();

      onUserChange();
    }




    function clearMapOverlays() {
      if (!map) return;
      polylines.recommended.forEach(p => map.remove(p)); polylines.recommended = [];
      if (polylines.draft) map.remove(polylines.draft);
      if (polylines.run) map.remove(polylines.run);
      if (polylines.history) map.remove(polylines.history);
      polylines.draft = polylines.run = polylines.history = null;
      map.remove(markers); markers = [];
      if (runnerMarker) { map.remove(runnerMarker); runnerMarker = null; }
      if (drawingInfoMarker) { map.remove(drawingInfoMarker); drawingInfoMarker = null; }
    }

    
    function destroySingleMap() {
      try {
        if (map && typeof map.destroy === 'function') {
          map.destroy();
        }
      } catch (e) {
        logMessage_Warning('destroySingleMap warning:', e);
      } finally {
        map = null;
        
        polylines.recommended = [];
        polylines.draft = null;
        polylines.run = null;
        polylines.history = null;
        markers = [];
        runnerMarker = null;
        drawingInfoMarker = null;

        
        try {
          const container = document.getElementById('map-container');
          if (container) container.classList.remove('drawing');
        } catch (_) { }
        isDrawing = false;
        isPathDrawing = false;
        leftMouseDown = false;
        pendingUnlockMap = false;
        
        draftPath = [];
        draftPathLngLat = [];
        pendingPoints = [];
        isUpdating = false;
        lastMouseMoveTime = 0;

        
        try { document.body.classList.remove('modal-visible'); } catch (_) { }
      }
    }

    
    $('user-combo').addEventListener('change', onUserChange);
    $('username-entry').addEventListener('input', async (e) => {
      
      
      
      const loginBtn = $('login-button');
      if (loginBtn) {
        loginBtn.disabled = true;  
      }

      try {
        const username = e.target.value.trim();
        $('password-entry').value = "";
        const userCombo = $('user-combo');
        const exists = [...userCombo.options].some(o => o.value === username);
        userCombo.value = exists ? username : "";
        
        
        
        
        const data = await callPythonAPI('on_user_selected', username);
        if (data && data.password) $('password-entry').value = data.password;
        logMessage_Info('è·å–åˆ°çš„data.ua:', data ? data.ua : 'null');
        const ua_data = (data && data.ua) ? data.ua : '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
        
        $('ua-label').textContent = ua_data;
        
        
        
        syncUAToMobile(ua_data);
        logMessage_Info('User ua label set to:', ua_data);

        
        
        
        
        
        pythonParams = (data && data.params) ? data.params : pythonParams;
        updateParamInputs($('params-container'), 'param', pythonParams);
        const base = pythonParams.theme_base_color || '#7dd3fc'; setBaseColor(base, base);
      } finally {
        
        
        
        if (loginBtn) {
          loginBtn.disabled = false;  
        }
      }
    });
    $('random-ua-btn').addEventListener('click', async () => {
      const newUA = await callPythonAPI('generate_new_ua');
      $('ua-label').textContent = newUA;
      
      
      
      syncUAToMobile(newUA);
    });
    $('login-button').addEventListener('click', async (e) => {
      
      if (!await checkButtonPermission('login-button', 'use_login_button')) {
        return;
      }
      await onLogin();
    });
    $('logout-button').addEventListener('click', onLogout);
    $('refresh-button').addEventListener('click', refreshTasks);
    $('record-button').addEventListener('click', toggleRecordMode);
    $('clear-button').addEventListener('click', () => clearCurrentPath(true));
    $('process-button').addEventListener('click', processCurrentPath);
    $('start-run-button').addEventListener('click', toggleRun);
    $('start-all-button').addEventListener('click', toggleAllRuns);
    $('export-button').addEventListener('click', exportTask);
    $('import-button').addEventListener('click', async (e) => {
      
      if (!await checkButtonPermission('import-button', 'use_import_button')) {
        return;
      }
      await importTask();
    });
    
    
    
    $('show-user-details').addEventListener('click', (e) => {
      e.stopPropagation(); 
      showUserDetails();
    });
    $('show-task-details').addEventListener('click', (e) => {
      e.stopPropagation(); 
      showTaskDetails();
    });
    $('auto-gen-button').addEventListener('click', () => {
      $('auto-gen-modal').classList.remove('hidden');
      $('auto-gen-modal').classList.add('flex'); 
      document.body.classList.add('modal-visible'); 
    });
    $('cancel-gen-button').addEventListener('click', () => {
      $('auto-gen-modal').classList.add('hidden');
      $('auto-gen-modal').classList.remove('flex'); 
      document.body.classList.remove('modal-visible'); 
    });
    $('confirm-gen-button').addEventListener('click', onConfirmAutoGenerate);

    
    $('show-notifications-btn').addEventListener('click', (e) => {
      e.stopPropagation(); 
      showNotifications();
    });

    $('mark-all-read-btn').addEventListener('click', markAllAsRead);
    $('refresh-notifications-btn').addEventListener('click', () => refreshNotificationsUI(true, true)); 

    $('multi-download-template-btn').addEventListener('click', multi_downloadTemplate);


    


    
    async function onConfirmAmapKey() {
      const input = $('amap-key-input');
      const newKey = input.value.trim();
      if (!newKey) {
        showModalAlert('API Key ä¸èƒ½ä¸ºç©ºï¼');
        return;
      }

      const btn = $('confirm-amap-key-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = `<span class="inline-block animate-spin mr-2">â³</span>ä¿å­˜ä¸­...`;

      try {
        const result = await callPythonAPI('save_amap_key', newKey);
        if (result.success) {
          AMAP_API_KEY = newKey;
          const modal = $('amap-key-modal');
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.classList.remove('modal-visible');
          logMessage_Info("API Keyå·²æ›´æ–°ï¼Œæ­£åœ¨å°è¯•é‡æ–°åŠ è½½åœ°å›¾...");

          
          try {
            await loadAMapOnce();
            
            
            ensureSingleMap();
          } catch (e) {
            logMessage_Error('ä¿å­˜KeyååŠ è½½AMap SDKå¤±è´¥', e);
            logMessage_Info("[é”™è¯¯] æ–°çš„API Keyä¼¼ä¹æ— æ•ˆï¼Œåœ°å›¾åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥åé‡è¯•ã€‚");
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-visible');
          }

        } else {
          showModalAlert(`ä¿å­˜å¤±è´¥: ${result.message}`);
        }
      } catch (e) { 
        logMessage_Error("ä¿å­˜API Keyæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:", e);
        showModalAlert(`ä¿å­˜å¤±è´¥: ${e.message}`);
      } finally { 
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function bindImmediateRefreshForUserSelects() {
      const loginSelect = $('user-combo');
      const multiSelect = $('multi-config-user-select');

      if (loginSelect && !loginSelect._refreshBound) {
        loginSelect.addEventListener('focus', refreshUserList);
        loginSelect.addEventListener('click', refreshUserList);
        loginSelect._refreshBound = true;
      }

      if (multiSelect && !multiSelect._refreshBound) {
        multiSelect.addEventListener('focus', refreshUserList);
        multiSelect.addEventListener('click', refreshUserList);
        multiSelect._refreshBound = true;
      }
    }

    

    async function multi_downloadTemplate() {
      const result = await callPythonAPI('multi_download_import_template');
      if (!result || !result.success) {
        showModalAlert(result?.message || 'æ¨¡æ¿ä¸‹è½½å¤±è´¥');
        return;
      }

      
      if (result.content && result.filename) {
        const binaryString = atob(result.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: result.mimetype || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage_Info(`æ¨¡æ¿å·²ä¸‹è½½ï¼š${result.filename}`);
      }
    }






    
    async function refreshUserList() {
      
      if (isInNetworkErrorState) {
        return;
      }

      
      if (!sessionUUID || sessionUUID === 'null' || sessionUUID.trim() === '') {
        
        return; 
      }
      try {
        const initialData = await callPythonAPI('get_initial_data');
        
        const users = Array.isArray(initialData?.users) ? initialData.users : [];

        const select = document.getElementById("user-combo");                
        const multiSelect = document.getElementById("multi-config-user-select"); 

        function updateSelect(selectElem, users) {
          if (!selectElem) return;
          
          const previousValue = selectElem.value;
          const previousScrollTop = selectElem.scrollTop;

          
          selectElem.innerHTML = '';

          
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)';
          selectElem.appendChild(opt);

          users.forEach(u => {
            const o = document.createElement('option');
            o.value = u;
            o.textContent = u;
            o.title = u; 
            selectElem.appendChild(o);
          });

          
          if (users.includes(previousValue)) {
            selectElem.value = previousValue;
          } else {
            selectElem.value = '';
          }

          
          selectElem.scrollTop = previousScrollTop;
        }

        updateSelect(select, users);
        updateSelect(multiSelect, users);
      } catch (err) {
        logMessage_Error("åˆ·æ–°ç”¨æˆ·åˆ—è¡¨å¤±è´¥", err);
      }
    }

    
    setInterval(refreshUserList, 5000);


    async function onUserChange() {
      
      
      
      const loginBtn = $('login-button');
      if (loginBtn) {
        loginBtn.disabled = true;  
      }

      try {
        
        const username = $('user-combo').value;

        
        const data = await callPythonAPI('on_user_selected', username);

        
        $('username-entry').value = username;

        
        $('password-entry').value = data.password || "";

        
        const uaText = data.ua || '(æ–°ç”¨æˆ·å°†åœ¨ç™»å½•æ—¶è‡ªåŠ¨ç”Ÿæˆ)';
        $('ua-label').textContent = uaText;
        
        
        
        syncUAToMobile(uaText);

        
        pythonParams = data.params || pythonParams;
        updateParamInputs($('params-container'), 'param', pythonParams);

        
        const base = pythonParams.theme_base_color || '#7dd3fc';
        setBaseColor(base, base);

        
        const style = pythonParams.theme_style || 'default';
        setThemeStyle(style);

        
        
        
        
        
        
        if (sessionUUID && currentAuthUsername) {
          
          
          

          try {
            
            
            const response = await fetch('/auth/admin/get_user_school_accounts', {
              method: 'GET',
              headers: {
                'X-Session-ID': sessionUUID  
              }
            });

            
            if (response.ok) {
              
              const result = await response.json();

              
              if (result.success && result.accounts) {
                
                
                const accountData = result.accounts[username];

                
                let password = null;
                let ua = null;

                if (typeof accountData === 'string') {
                  
                  password = accountData;
                } else if (typeof accountData === 'object' && accountData !== null) {
                  
                  password = accountData.password;
                  ua = accountData.ua;
                }

                
                if (password) {
                  
                  
                  $('password-entry').value = password;

                  
                  logMessage_Info(`[ç”¨æˆ·é€‰æ‹©] å·²ä» school_accounts åŠ è½½ç”¨æˆ· ${username} çš„å¯†ç `);
                }

                
                if (ua) {
                  $('ua-label').textContent = ua;
                  
                  
                  
                  syncUAToMobile(ua);
                  logMessage_Info(`[ç”¨æˆ·é€‰æ‹©] å·²ä» school_accounts åŠ è½½ç”¨æˆ· ${username} çš„UA`);
                }
              }
            }
          } catch (error) {
            
            
            logMessage_Warning(`[ç”¨æˆ·é€‰æ‹©] æ— æ³•åŠ è½½ school_accounts: ${error.message}`);
          }
        }
      } finally {
        
        
        
        if (loginBtn) {
          loginBtn.disabled = false;  
        }
      }
    }

    async function onLogin() {
      logMessage_Info('[å‰ç«¯-ç™»å½•] å¼€å§‹ç™»å½•æµç¨‹...');
      const user = $('username-entry').value.trim();
      const pass = $('password-entry').value;

      logMessage_Info(`[å‰ç«¯-ç™»å½•] ç”¨æˆ·å: ${user}`);
      if (!user) {
        logMessage_Info('[å‰ç«¯-ç™»å½•] é”™è¯¯: ç”¨æˆ·åä¸ºç©º');
        showModalAlert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }

      
      IS_OFFLINE = false;
      const uaBtn = $('random-ua-btn'); if (uaBtn) uaBtn.disabled = false;

      
      const uaOnLoginScreen = $('ua-label')?.textContent || "";
      logMessage_Info(`[å‰ç«¯-ç™»å½•] å½“å‰UA: ${uaOnLoginScreen.substring(0, 50)}...`);

      
      setButtonLoading('login-button', true, 'ç™»å½•ä¸­...');

      logMessage_Info('[å‰ç«¯-ç™»å½•] è°ƒç”¨åç«¯APIè¿›è¡Œç™»å½•éªŒè¯...');
      const result = await callPythonAPI('login', user, pass);
      if (result.success) {
        logMessage_Info('[å‰ç«¯-ç™»å½•] âœ“ ç™»å½•æˆåŠŸï¼');
        showButtonSuccess('login-button', 'ç™»å½•æˆåŠŸ');
        
        if (result.amap_key) {
          logMessage_Info('[å‰ç«¯-ç™»å½•] åŠ è½½é«˜å¾·åœ°å›¾API...');
          AMAP_API_KEY = result.amap_key;
          try {
            await loadAMapOnce();
            logMessage_Info('[å‰ç«¯-ç™»å½•] âœ“ åœ°å›¾åŠ è½½æˆåŠŸ');
          } catch (e) {
            logMessage_Error('[å‰ç«¯-ç™»å½•] âœ— åœ°å›¾åŠ è½½å¤±è´¥:', e);
          }
        }

        logMessage_Info('[å‰ç«¯-ç™»å½•] æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢...');
        showMainApp();
        $('loading-overlay').classList.add('hidden');
        currentUserData = result.userInfo;
        
        currentUserData.group = result.auth_group || 'user';
        currentSessionUA = uaOnLoginScreen;
        const name = currentUserData.name || '';
        $('user-name-label').textContent = `å§“å: ${name}`;
        $('user-id-label').textContent = `å­¦å·: ${currentUserData.student_id}`;
        logMessage_Info(`[å‰ç«¯-ç™»å½•] ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°: ${name} (${currentUserData.student_id})`);

        logMessage_Info('[å‰ç«¯-ç™»å½•] æ›´æ–°ä»ªè¡¨ç›˜...');
        updateDashboard();

        logMessage_Info('[å‰ç«¯-ç™»å½•] åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...');
        await refreshTasks();

        logMessage_Info('[å‰ç«¯-ç™»å½•] è·å–é€šçŸ¥...');
        
        const notificationBadge = $('notification-badge');
        if (notificationBadge) {
          notificationBadge.classList.add('hidden');
        }

        
        if (result.cached_notifications && result.cached_notifications.notices.length > 0) {
          logMessage_Info(`ä½¿ç”¨ç™»å½•æ—¶é¢„åŠ è½½çš„ ${result.cached_notifications.notices.length} æ¡é€šçŸ¥`);
          
          if (result.cached_notifications.unreadCount > 0) {
            notificationBadge.textContent = result.cached_notifications.unreadCount > 9 ? '9+' : result.cached_notifications.unreadCount;
            notificationBadge.classList.remove('hidden');
          }
          
          window.currentNotifications = result.cached_notifications.notices;
        } else {
          
          await fetchNotifications();
        }

        const base = pythonParams.theme_base_color || '#7dd3fc';
        setBaseColor(base, base);
        
        const adminBtn = $('show-admin-panel');
        if (adminBtn) adminBtn.classList.remove('hidden');
        const adminBtnLogin = $('show-admin-panel-login');
        if (adminBtnLogin) adminBtnLogin.classList.remove('hidden');
        $('loading-overlay').classList.add('hidden');
        logMessage_Info('[å‰ç«¯-ç™»å½•] âœ“ ç™»å½•æµç¨‹å®Œæˆï¼');
        return true;
      } else {
        logMessage_Info(`[å‰ç«¯-ç™»å½•] âœ— ç™»å½•å¤±è´¥: ${result.message}`);
        setButtonLoading('login-button', false);
        showButtonError('login-button', 'ç™»å½•å¤±è´¥');
        showModalAlert(result.message, 'ç™»å½•å¤±è´¥');
        return false;
      }
    }



    async function onLogout() {
      await callPythonAPI('logout');
      currentSessionUA = "";
      resetUI();


      if (refreshUserListInterval) {
        clearInterval(refreshUserListInterval);
        refreshUserListInterval = null;
        logMessage_Info('refreshUserList interval cleared on logout.');
      }

      
      await new Promise(resolve => setTimeout(resolve, 500));
      loadAdminSessions_inline();
    }


    async function refreshTasks() {
      if (isRefreshingTasks) {
        
        return;
      }
      isRefreshingTasks = true;

      
      const btn = $('refresh-button');
      if (btn) btn.disabled = true;

      try {
        const taskResult = await callPythonAPI('load_tasks');
        if (taskResult && taskResult.success) {
          currentTasks = taskResult.tasks;
          renderTaskList();
          return;
        }

        
        await new Promise(r => setTimeout(r, 300));
        const retry = await callPythonAPI('load_tasks');
        if (retry && retry.success) {
          currentTasks = retry.tasks;
          renderTaskList();

          await fetchNotifications();

        } else {
          logMessage_Info("åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç‚¹å‡»å·¦ä¾§â€œåˆ·æ–°â€é‡è¯•ã€‚");
        }
      } finally {
        isRefreshingTasks = false;
        if (btn) btn.disabled = false;
      }
    }


    function renderTaskList() {
      const taskListDiv = $('task-list'); taskListDiv.innerHTML = "";
      if (currentTasks.length === 0) { taskListDiv.innerHTML = `<div class="text-slate-400 text-center py-10">æš‚æ— ä»»åŠ¡</div>`; return; }
      currentTasks.forEach((task, index) => {
        const item = document.createElement('div');
        const pathStatus = task.run_coords?.length > 0 ? 'å·²ç”Ÿæˆ' : (task.draft_coords?.length > 0 ? 'è‰ç¨¿' : 'æ— è·¯å¾„');
        let statusClass = 'text-amber-600', statusText = 'æœªå®Œæˆ', statusIcon = 'ğŸ•’';

        
        if (task.status == 1) { statusClass = 'text-emerald-600'; statusText = 'å·²å®Œæˆ'; statusIcon = 'âœ…'; }

        
        if (task.info_text === 'å·²è¿‡æœŸ') { statusClass = 'text-red-600'; statusText = 'å·²è¿‡æœŸ'; statusIcon = 'â›”'; }

        
        if (!(task.status == 1)) {
          if (typeof task.info_text === 'string' && task.info_text.startsWith('å¼€å§‹äº')) {
            statusClass = 'text-slate-600';
            statusText = 'æœªå¼€å§‹';
            statusIcon = 'â³';
          }
        }

        item.className = 'p-3 rounded-xl cursor-pointer border border-transparent transition-colors duration-200 hover:bg-white/70';
        item.innerHTML = `
      <div class="flex items-center gap-3">
        <p class="font-bold text-slate-700 text-sm truncate">${task.run_name}</p>
      </div>
      <div class="flex justify-between items-center mt-2 text-xs">
        <span class="font-semibold ${statusClass} flex items-center gap-1">${statusIcon} ${statusText}</span>
        <span class="text-slate-500">${task.info_text || ''}</span>
        <span class="badge">${pathStatus}</span>
      </div>
    `;
        item.dataset.index = index;
        if (task.status === 1) item.classList.add('opacity-60');
        if (index === selectedTaskIndex) item.classList.add('selected');
        item.addEventListener('click', () => selectTask(index));
        taskListDiv.appendChild(item);
      });

      
      
      renderMobileTaskList();
    }

    
    function renderMobileTaskList() {
      
      const mobileTaskListDiv = $('mobile-task-list');

      
      if (!mobileTaskListDiv) return;

      
      mobileTaskListDiv.innerHTML = "";

      
      const taskCountElem = $('mobile-task-count');
      if (taskCountElem) {
        
        taskCountElem.textContent = `${currentTasks.length} ä¸ªä»»åŠ¡`;
      }

      
      if (currentTasks.length === 0) {
        mobileTaskListDiv.innerHTML = `<p class="text-slate-400 text-center py-8 text-sm">æš‚æ— ä»»åŠ¡</p>`;
        return;
      }

      
      currentTasks.forEach((task, index) => {
        
        const item = document.createElement('div');

        
        

        
        let statusClass = 'text-amber-600'; 
        let statusText = 'æœªå®Œæˆ';
        let statusIcon = 'ğŸ•’'; 

        
        if (task.status == 1) {
          statusClass = 'text-emerald-600'; 
          statusText = 'å·²å®Œæˆ';
          statusIcon = 'âœ…'; 
        }

        
        if (task.info_text === 'å·²è¿‡æœŸ') {
          statusClass = 'text-red-600'; 
          statusText = 'å·²è¿‡æœŸ';
          statusIcon = 'â›”'; 
        }

        
        if (!(task.status == 1)) {
          
          if (typeof task.info_text === 'string' && task.info_text.startsWith('å¼€å§‹äº')) {
            statusClass = 'text-slate-600'; 
            statusText = 'æœªå¼€å§‹';
            statusIcon = 'â³'; 
          }
        }

        
        
        item.className = 'bg-white rounded-lg p-3 border border-slate-200 cursor-pointer transition-all duration-200 hover:shadow-md active:scale-98 min-w-[300px]';
        item.id = `Mobile_Task_List_Sub_project${task.errand_id}`;
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        item.innerHTML = `
          <div class="flex items-center justify-between mb-2"">
            <p class="font-semibold text-slate-800 text-sm truncate flex-1">${task.run_name}</p>
          </div>
          <div class="flex items-center justify-between text-xs">
            <span class="font-medium ${statusClass} flex items-center gap-1">
              <span>${statusIcon}</span>
              <span>${statusText}</span>
            </span>
            <span class="text-slate-500">${task.info_text || ''}</span>
          </div>
        `;


        
        item.dataset.index = index;

        
        
        if (task.status === 1) {
          item.style.opacity = '0.6';
        }

        
        if (index === selectedTaskIndex) {
          
          
          item.style.backgroundColor = '#eff6ff'; 
          
          item.style.border = '2px solid #3b82f6'; 
          
          item.style.borderLeft = '6px solid #2563eb'; 
          
          item.style.boxShadow = '0 4px 6px -1px rgba(59, 130, 246, 0.2), 0 2px 4px -1px rgba(59, 130, 246, 0.1)';
          
          item.style.transform = 'scale(1.01)';
          item.style.zIndex = '10';
          item.style.position = 'relative';
          
          item.querySelectorAll('p, span').forEach(el => {
            
            if (el.classList.contains('text-slate-800')) el.style.color = '#1e40af'; 
          });
        } else {
          
          item.style.backgroundColor = '#ffffff';
          item.style.border = '1px solid #e2e8f0';
          item.style.borderLeft = '1px solid #e2e8f0'; 
          item.style.boxShadow = 'none';
          item.style.transform = 'none';
          item.style.zIndex = 'auto';
          item.style.position = 'static';
          
          item.querySelectorAll('p, span').forEach(el => {
            if (el.classList.contains('text-slate-800')) el.style.color = '';
          });
        }

        
        
        item.addEventListener('click', async () => {
          
          if (index === selectedTaskIndex) {
            
            
            selectTask(index);
            return;
          }

          
          const statusRes = await callPythonAPI_raw('/api/background_task/status', 'GET', null);
          const isBackendRunning = statusRes.success && statusRes.task_status && statusRes.task_status.status === 'running';

          if (isBackendRunning) {
            showTempMessage('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼Œç¦æ­¢åˆ‡æ¢ä»»åŠ¡ï¼', 'error');

            
            mobileTaskRunning = true;
            updateMobileTaskUI('è¿è¡Œä¸­', 'ä»»åŠ¡æ‰§è¡Œä¸­');
            return;
          }

          
          selectTask(index);
        });

        
        mobileTaskListDiv.appendChild(item);
      });
    }

    
    function renderMobileCheckpointsList() {
      
      const checkpointsListDiv = $('mobile-checkpoints-list');
      
      const taskInfoDiv = $('mobile-checkpoints-task-info');

      
      if (!checkpointsListDiv) return;

      
      if (selectedTaskIndex === -1 || !currentRunData || !currentRunData.target_points || currentRunData.target_points.length === 0) {
        
        checkpointsListDiv.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰æ‰“å¡ç‚¹çš„ä»»åŠ¡</p>';

        
        if (taskInfoDiv) {
          if (selectedTaskIndex === -1) {
            taskInfoDiv.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡ä»¥æŸ¥çœ‹æ‰“å¡ç‚¹';
          } else {
            taskInfoDiv.textContent = 'å½“å‰ä»»åŠ¡æ²¡æœ‰æ‰“å¡ç‚¹';
          }
        }
        return;
      }

      
      if (taskInfoDiv) {
        const taskName = currentTasks[selectedTaskIndex]?.run_name || 'æœªçŸ¥ä»»åŠ¡';
        taskInfoDiv.textContent = `ä»»åŠ¡: ${taskName}`;
      }

      
      checkpointsListDiv.innerHTML = '';

      
      const targetPoints = currentRunData.target_points;  
      const targetNames = (currentRunData.target_point_names || '').split('|');  
      const currentSequence = currentRunData.target_sequence || 1;  

      
      targetPoints.forEach((point, index) => {
        
        const item = document.createElement('div');

        
        const seq = index + 1;
        
        const name = targetNames[index] || `æ‰“å¡ç‚¹${seq}`;
        
        const [lon, lat] = point;

        
        
        const isReached = currentSequence > seq;
        
        const isCurrent = currentSequence === seq;

        
        let statusClass = 'bg-white border-slate-200';  
        let statusBadge = '<span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">æœªåˆ°è¾¾</span>';

        if (isReached) {
          
          statusClass = 'bg-green-50 border-green-200';
          statusBadge = '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-600 flex items-center gap-1"><span>âœ“</span><span>å·²åˆ°è¾¾</span></span>';
        } else if (isCurrent) {
          
          statusClass = 'bg-blue-50 border-blue-400 ring-2 ring-blue-300';
          statusBadge = '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-600 flex items-center gap-1"><span>ğŸ¯</span><span>ç›®æ ‡</span></span>';
        }

        
        item.className = `${statusClass} rounded-lg p-3 border transition-all duration-200 cursor-pointer hover:shadow-md`;

        
        item.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2 flex-1">
              <span class="text-lg font-bold ${isCurrent ? 'text-blue-600' : isReached ? 'text-green-600' : 'text-slate-400'}">
                ${seq}
              </span>
              <div class="flex-1">
                <p class="font-semibold text-slate-800 text-sm">${name}</p>
                <p class="text-xs text-slate-500 mt-1">åæ ‡: ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>
              </div>
            </div>
            ${statusBadge}
          </div>
        `;

        
        item.addEventListener('click', () => {
          
          if (window.map) {
            window.map.setCenter([lon, lat]);
            window.map.setZoom(16);  

            
            showTempMessage(`å·²å®šä½åˆ° ${name}`, 'success');
          } else {
            showTempMessage('åœ°å›¾æœªåˆå§‹åŒ–', 'error');
          }
        });

        
        checkpointsListDiv.appendChild(item);
      });
    }


    async function forceLoadTaskDataForPolling(taskIndex) {
      if (taskIndex < 0 || taskIndex >= currentTasks.length) return;
      
      if (currentRunData && currentRunData.task_index === taskIndex) return;

      logMessage_Info(`[Polling] å¼ºåˆ¶åŠ è½½ä»»åŠ¡ #${taskIndex} çš„æ•°æ®...`);
      try {
        const result = await callPythonAPI('get_task_details', taskIndex);
        if (result.success) {
          currentRunData = result.details;
          currentRunData.task_index = taskIndex; 
          updateDashboard();
          drawOnMap();
          loadHistory(taskIndex);

          
          singleProcessedPoints = 0;
          singleTotalPoints = (currentRunData.run_coords?.length || 0);
          updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
        } else {
          logMessage_Error(`[Polling] å¼ºåˆ¶åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥: ${result.message}`);
        }
      } catch (e) {
        logMessage_Error(`[Polling] å¼ºåˆ¶åŠ è½½ä»»åŠ¡æ—¶å‡ºé”™: ${e}`);
      }
    }

    async function selectTask(index, Update_Dashboard = true) {
      logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] å¼€å§‹é€‰æ‹©ä»»åŠ¡ï¼Œç´¢å¼•: ${index}`, 'DEBUG');
      logMessage_Info(`[å‰ç«¯-ä»»åŠ¡é€‰æ‹©] é€‰æ‹©ä»»åŠ¡ #${index}`);

      
      if (backgroundTaskPollInterval && selectedTaskIndex !== index) {
        logMessage_Warning("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•åˆ‡æ¢ä»»åŠ¡ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        showModalAlert("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•åˆ‡æ¢ä»»åŠ¡ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        return;
      }

      if (isDrawing) {
        logMessage_Info("è¯·å…ˆç»“æŸå½“å‰è·¯å¾„ç»˜åˆ¶ï¼", 'WARN');
        return;
      }
      if (selectedTaskIndex === index) {
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] ä»»åŠ¡å·²é€‰ä¸­ï¼Œæ— éœ€é‡å¤é€‰æ‹©: ${index}`, 'DEBUG');
        return;
      }

      const taskListDiv = $('task-list');
      if (selectedTaskIndex > -1 && taskListDiv.children[selectedTaskIndex]) {
        taskListDiv.children[selectedTaskIndex].classList.remove('selected');
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] å–æ¶ˆé€‰ä¸­ä¸Šä¸€ä¸ªä»»åŠ¡: ${selectedTaskIndex}`, 'DEBUG');
      }
      selectedTaskIndex = index;
      if (taskListDiv.children[selectedTaskIndex]) {
        taskListDiv.children[selectedTaskIndex].classList.add('selected');
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] é«˜äº®æ˜¾ç¤ºå½“å‰ä»»åŠ¡: ${index}`, 'DEBUG');
      }

      
      if (isMobileMode) {
        renderMobileTaskList();
      }

      
      const selectedTask = currentTasks[index];
      
      if (selectedTask && selectedTask.info_text === "ç¦»çº¿") {
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] ç¦»çº¿æ¨¡å¼ä»»åŠ¡ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®`, 'INFO');
        
        currentRunData = selectedTask;
        if (Update_Dashboard) {
          updateDashboard();
        }
        drawOnMap();
        loadHistory(index); 
        singleProcessedPoints = 0;
        singleTotalPoints = (currentRunData.run_coords?.length || 0);
        updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ“ ç¦»çº¿ä»»åŠ¡åŠ è½½å®Œæˆï¼Œæ€»ç‚¹æ•°: ${singleTotalPoints}`, 'INFO');
      } else {
        
        logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] åœ¨çº¿æ¨¡å¼ï¼Œä»åç«¯è·å–ä»»åŠ¡è¯¦æƒ…...`, 'INFO');
        const result = await callPythonAPI('get_task_details', index);
        if (result.success) {
          logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ“ ä»»åŠ¡è¯¦æƒ…è·å–æˆåŠŸ`, 'INFO');
          currentRunData = result.details;
          updateDashboard();

          drawOnMap();
          
          
          
          
          
          

          loadHistory(index);
          singleProcessedPoints = 0;
          singleTotalPoints = (currentRunData.run_coords?.length || 0);
          updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');
          logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ“ åœ¨çº¿ä»»åŠ¡åŠ è½½å®Œæˆï¼Œæ€»ç‚¹æ•°: ${singleTotalPoints}`, 'INFO');
        } else {
          logMessage_Info(`[ä»»åŠ¡é€‰æ‹©] âœ— è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ${result.message}`, 'ERROR');
          logMessage_Info(result.message);
        }
      }
    }


    
    $('multi-account-btn').addEventListener('click', async (e) => {
      
      if (!await checkButtonPermission('multi-account-btn', 'use_multi_account_button')) {
        return;
      }
      await switchToMultiMode();
    });
    $('exit-multi-mode-btn').addEventListener('click', exitMultiMode);
    $('multi-start-all-btn').addEventListener('click', multi_startAll);
    $('multi-stop-all-btn').addEventListener('click', multi_stopAll);
    $('multi-load-all-from-config-btn').addEventListener('click', multi_loadAllFromConfig);
    $('multi-add-from-config-btn').addEventListener('click', multi_addFromConfig);
    $('multi-import-excel-btn').addEventListener('click', multi_importFromExcel);
    $('multi-export-excel-btn').addEventListener('click', multi_exportToExcel);
    
    
    

    
    $('multi-remove-all-btn').addEventListener('click', multi_removeAll);
    $('multi-remove-selected-btn').addEventListener('click', multi_removeSelected);
    $('multi-refresh-all-btn').addEventListener('click', multi_refreshAll);
    $('multi-select-all-check').addEventListener('change', multi_toggleSelectAll);
    $('multi-start-selected-btn').addEventListener('click', multi_startSelected);
    $('multi-stop-selected-btn').addEventListener('click', multi_stopSelected);
    $('multi-refresh-selected-btn').addEventListener('click', multi_refreshSelected);


    
    $('admin-tab-users_modal')?.addEventListener('click', () => switchAdminTab('users'));
    $('admin-tab-groups_modal')?.addEventListener('click', () => switchAdminTab('groups'));
    $('admin-tab-logs_modal')?.addEventListener('click', () => switchAdminTab('logs'));
    $('admin-tab-health_modal')?.addEventListener('click', () => switchAdminTab('health'));
    $('admin-tab-profile_modal')?.addEventListener('click', () => switchAdminTab('profile'));
    $('admin-tab-sessions_modal')?.addEventListener('click', () => switchAdminTab('sessions'));
    $('admin-tab-messages_modal')?.addEventListener('click', () => switchAdminTab('messages'));
    $('admin-tab-ipban_modal')?.addEventListener('click', () => switchAdminTab('ipban'));
    $('admin-tab-sms_modal')?.addEventListener('click', () => switchAdminTab('sms'));

    
    
    
    

    
    const loginTabBtn = $('log-tab-login');
    if (loginTabBtn) {
      loginTabBtn.addEventListener('click', () => {
        
        loginTabBtn.classList.add('text-sky-600', 'border-sky-600');
        loginTabBtn.classList.remove('text-slate-400', 'border-transparent');

        
        const auditTabBtn = $('log-tab-audit');
        if (auditTabBtn) {
          auditTabBtn.classList.remove('text-sky-600', 'border-sky-600');
          auditTabBtn.classList.add('text-slate-400', 'border-transparent');
        }

        
        const loginContent = $('log-login-content');
        const auditContent = $('log-audit-content');
        if (loginContent) loginContent.classList.remove('hidden');
        if (auditContent) auditContent.classList.add('hidden');

        
        const username = $('current-log-username')?.textContent;
        if (username && username !== 'N/A') {
          loadUserLoginLogs(username);
        }
      });
    }

    
    const auditTabBtn = $('log-tab-audit');
    if (auditTabBtn) {
      auditTabBtn.addEventListener('click', () => {
        
        auditTabBtn.classList.add('text-sky-600', 'border-sky-600');
        auditTabBtn.classList.remove('text-slate-400', 'border-transparent');

        
        const loginTabBtn = $('log-tab-login');
        if (loginTabBtn) {
          loginTabBtn.classList.remove('text-sky-600', 'border-sky-600');
          loginTabBtn.classList.add('text-slate-400', 'border-transparent');
        }

        
        const loginContent = $('log-login-content');
        const auditContent = $('log-audit-content');
        if (loginContent) loginContent.classList.add('hidden');
        if (auditContent) auditContent.classList.remove('hidden');

        
        const username = $('current-log-username')?.textContent;
        if (username && username !== 'N/A') {
          loadUserAuditLogs(username);
        }
      });
    }

    
    $('admin-refresh-messages_modal')?.addEventListener('click', loadMessages);
    
    const guestWarningCloseBtn = $('guest-warning-close-btn');
    const guestWarningOverlay = $('guest_warning_overlay');
    if (guestWarningCloseBtn) {
      guestWarningCloseBtn.addEventListener('click', () => {
        const guestToast = $('guest-warning-toast');
        
        if (guestToast) {
          guestToast.classList.add('hidden');
        }
        if (guestWarningOverlay) {
          guestWarningOverlay.classList.add('hidden');
        }
      });
    }
    
    if (guestWarningOverlay) {
      guestWarningOverlay.addEventListener('click', () => {
        const guestToast = $('guest-warning-toast');
        if (guestToast) {
          guestToast.classList.add('hidden');
        }
        guestWarningOverlay.classList.add('hidden');
      });
    }

    
    async function switchToMultiMode() {

      $('multi-account-count').textContent = 0;

      const result = await callPythonAPI('enter_multi_account_mode');
      if (!result.success) return;

      
      if (isMobileMode) {
        
        
        if (typeof destroyMobileSingleMap === 'function') {
          destroyMobileSingleMap();
          console.log('[åˆ‡æ¢æ¨¡å¼] ç§»åŠ¨ç«¯ï¼šå·²é”€æ¯å•è´¦å·åœ°å›¾');
        }
        
        
        const mobileLoginContainer = document.getElementById('mobile-login-container');
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');
        const mobileMainApp = document.getElementById('mobile-main-app');

        if (mobileLoginContainer) mobileLoginContainer.classList.add('hidden');
        if (mobileMainApp) mobileMainApp.classList.add('hidden');
        if (mobileMultiApp) {
          mobileMultiApp.classList.remove('hidden');
          switchMobilePanel('mobile-multi-control-panel', 'multi');
          console.log('[åˆ‡æ¢æ¨¡å¼] ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º mobile-multi-account-app');
        }

        
        updateMobileNavVisibility(true, 'multi');

        
        $('login-container').classList.add('hidden');
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.add('hidden');
      } else {
        
        $('login-container').classList.add('hidden');
        $('main-app').classList.add('hidden');
        $('multi-account-app').classList.remove('hidden');
        $('multi-account-app').classList.add('grid');
        console.log('[åˆ‡æ¢æ¨¡å¼] æ¡Œé¢ç«¯ï¼šæ˜¾ç¤º multi-account-app');
      }

      document.body.classList.remove('modal-visible');



      
      try {
        await loadAMapOnce();
      } catch (e) {
        logMessage_Error('AMap æœªå°±ç»ªï¼Œæ— æ³•è¿›å…¥å¤šè´¦å·åœ°å›¾', e);
        return;
      }


      
      if (!multiAccountMap && AMapInstance) {
        
        multiAccountMap = new AMapInstance.Map('multi-map-container', {
          viewMode: '3D',
          pitch: 55,
          rotation: 0,
          zoom: 17,
          center: [113.390342, 22.527403],
          renderOptions: {
            willReadFrequently: true  
          }
        });

        
        const ctrlBar = new AMapInstance.ControlBar({
          position: { left: '12px', top: '12px' },
          showZoomBar: false,
          showControlButton: true
        });
        multiAccountMap.addControl(ctrlBar);


        
        try {
          const buildings = new AMapInstance.BuildingLayer();
          buildings.setMap(multiAccountMap);
        } catch (e) {
          logMessage_Warning('BuildingLayer not available (multi):', e);
        }

        multiAccountMap.on('zoomchange', () => {
          const z = multiAccountMap.getZoom();
          $('multi-zoom-level').textContent = String(z.toFixed(1));
        });

        multiAccountMap.on('zoomchange', () => {
          if (!multiAccountMap) return; 
          const z = multiAccountMap.getZoom();
          const zoomLevelEl = $('multi-zoom-level');
          if (zoomLevelEl) zoomLevelEl.textContent = String(z.toFixed(1));
        });

        
        if (window.multiMapCleanup) window.multiMapCleanup();
        window.multiMapCleanup = enhanceMapInteraction(multiAccountMap);

        multiAccountMap.setStatus({
          doubleClickZoom: true,
          dragEnable: true,
          scrollWheel: true,
          keyboardEnable: true
        });

        
        ensureMultiControls();
      }





      const configUsers = await callPythonAPI('multi_get_all_config_users');
      const select = $('multi-config-user-select');
      select.innerHTML = '<option value="">(æ–°ç”¨æˆ·/æ‰‹åŠ¨è¾“å…¥)</option>';
      configUsers.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = u;
        select.appendChild(opt);
      });

      
      const container = $('multi-global-params-container');
      container.innerHTML = '';
      createParamInputs(container, 'multi-param', onGlobalParamChange);
      pythonParams = result.params;
      updateParamInputs(container, 'multi-param', pythonParams);

      await callPythonAPI('set_multi_run_only_incomplete',
        document.getElementById('multi-run-only-incomplete-check').checked
      );

      
      bindImmediateRefreshForUserSelects();

      
      updateMultiGlobalButtons(true, true); 

      
      
      
      
      
      

      
      const desktopCheckbox = document.getElementById('multi-run-only-incomplete-check');
      if (desktopCheckbox) {
        
        
        
        desktopCheckbox.removeEventListener('change', updateAllAccountsStatusText);

        
        
        
        desktopCheckbox.addEventListener('change', updateAllAccountsStatusText);

        
        console.log('[äº‹ä»¶ç›‘å¬å™¨] å·²ä¸ºæ¡Œé¢ç«¯"ä»…æ‰§è¡Œæœªå®Œæˆ"å¤é€‰æ¡†ç»‘å®šchangeäº‹ä»¶');
      } else {
        
        console.warn('[äº‹ä»¶ç›‘å¬å™¨] æœªæ‰¾åˆ°æ¡Œé¢ç«¯"ä»…æ‰§è¡Œæœªå®Œæˆ"å¤é€‰æ¡† (multi-run-only-incomplete-check)');
      }

      
      
      const mobileCheckbox = document.getElementById('mobile-multi-only-incomplete-check');
      if (mobileCheckbox) {
        
        
        mobileCheckbox.removeEventListener('change', updateAllAccountsStatusText);

        
        
        
        mobileCheckbox.addEventListener('change', updateAllAccountsStatusText);

        
        console.log('[äº‹ä»¶ç›‘å¬å™¨] å·²ä¸ºç§»åŠ¨ç«¯"ä»…æ‰§è¡Œæœªå®Œæˆ"å¤é€‰æ¡†ç»‘å®šchangeäº‹ä»¶');
      } else {
        
        
        console.warn('[äº‹ä»¶ç›‘å¬å™¨] æœªæ‰¾åˆ°ç§»åŠ¨ç«¯"ä»…æ‰§è¡Œæœªå®Œæˆ"å¤é€‰æ¡† (mobile-multi-only-incomplete-check)');
      }

      
      
      

      
      const pcCheck = document.getElementById('multi-run-only-incomplete-check');
      const mbCheck = document.getElementById('mobile-multi-only-incomplete-check');

      if (pcCheck) {
        pcCheck.removeEventListener('change', updateAllAccountsStatusText); 
        pcCheck.addEventListener('change', updateAllAccountsStatusText);
      }
      if (mbCheck) {
        mbCheck.removeEventListener('change', updateAllAccountsStatusText); 
        mbCheck.addEventListener('change', updateAllAccountsStatusText);
      }

      
      
      
      try {
        console.log('[å¤šè´¦å·æ¨¡å¼] åˆå§‹åŠ è½½è´¦å·åˆ—è¡¨...');
        const initialAccounts = await callPythonAPI('multi_get_all_accounts_status');
        if (initialAccounts && initialAccounts.accounts) {
          renderMultiAccountList(initialAccounts.accounts);
          console.log(`[å¤šè´¦å·æ¨¡å¼] åˆå§‹åŠ è½½å®Œæˆï¼Œå½“å‰æœ‰ ${initialAccounts.accounts.length} ä¸ªè´¦å·`);
        } else {
          console.log('[å¤šè´¦å·æ¨¡å¼] åˆå§‹åŠ è½½å®Œæˆï¼Œå½“å‰æœ‰ 0 ä¸ªè´¦å·');
          
          renderMultiAccountList([]);
        }
      } catch (error) {
        console.error('[å¤šè´¦å·æ¨¡å¼] åˆå§‹åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥:', error);
        
        renderMultiAccountList([]);
      }

      
      updateAllAccountsStatusText();

      startMultiAccountAutoRefresh(500);

    }

    async function exitMultiMode() {
      
      
      
      stopMultiAccountAutoRefresh();

      path_planning_queue = [];
      is_planning_path = false;
      await callPythonAPI('exit_multi_account_mode');

      
      if (isMobileMode) {
        
        
        if (typeof destroyMobileMultiMap === 'function') {
          destroyMobileMultiMap();
          console.log('[é€€å‡ºå¤šè´¦å·] ç§»åŠ¨ç«¯ï¼šå·²é”€æ¯å¤šè´¦å·åœ°å›¾');
        }
        
        
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');
        const mobileLoginContainer = document.getElementById('mobile-login-container');

        if (mobileMultiApp) mobileMultiApp.classList.add('hidden');
        if (mobileLoginContainer) mobileLoginContainer.classList.remove('hidden');

        
        updateMobileNavVisibility(false);

        console.log('[é€€å‡ºå¤šè´¦å·] ç§»åŠ¨ç«¯ï¼šéšè— mobile-multi-account-appï¼Œæ˜¾ç¤º mobile-login-container');
      } else {
        
        $('multi-account-app').classList.add('hidden');
        $('multi-account-app').classList.remove('grid');
        $('login-container').classList.remove('hidden');
        console.log('[é€€å‡ºå¤šè´¦å·] æ¡Œé¢ç«¯ï¼šéšè— multi-account-appï¼Œæ˜¾ç¤º login-container');
      }

      document.body.classList.remove('modal-visible');

      $('multi-account-list').innerHTML = '<p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>';
      if (multiAccountMap) {
        
        if (window.multiMapCleanup) {
          window.multiMapCleanup();
          window.multiMapCleanup = null;
        }
        try { multiAccountMap.remove(Object.values(multiAccountMarkers)); } catch (_) { }
        try { if (typeof multiAccountMap.destroy === 'function') multiAccountMap.destroy(); } catch (e) { logMessage_Warning('destroy multiAccountMap warning:', e); }
      }
      multiAccountMarkers = {};
      multiAccountMap = null;

      resetUI();
      if (refreshUserListInterval) {
        clearInterval(refreshUserListInterval);
        refreshUserListInterval = null;
        logMessage_Info('refreshUserList interval cleared on exiting multi mode.');
      }

      
      await new Promise(resolve => setTimeout(resolve, 500));
      loadAdminSessions_inline();

    }


    async function multi_loadAllFromConfig() {
      
      const result = await callPythonAPI('multi_load_accounts_from_config');

      if (result && result.accounts) {
        
        
        
        
        if (sessionUUID && currentAuthUsername) {
          
          try {
            
            const response = await fetch('/auth/admin/get_user_school_accounts', {
              method: 'GET',
              headers: {
                'X-Session-ID': sessionUUID  
              }
            });

            
            if (response.ok) {
              
              const schoolAccountsResult = await response.json();

              
              if (schoolAccountsResult.success && schoolAccountsResult.accounts) {
                
                
                
                const accountDataMap = schoolAccountsResult.accounts;

                
                
                let updatedCount = 0; 
                result.accounts.forEach(account => {
                  
                  if (account.username && accountDataMap[account.username]) {
                    const accountData = accountDataMap[account.username];

                    
                    if (typeof accountData === 'string') {
                      
                      account.password = accountData;
                      updatedCount++;
                    } else if (typeof accountData === 'object' && accountData !== null) {
                      
                      if (accountData.password) {
                        account.password = accountData.password;
                      }
                      if (accountData.ua) {
                        account.device_ua = accountData.ua;
                      }
                      updatedCount++;
                    }
                  }
                });

                
                if (updatedCount > 0) {
                  logMessage_Info(`[å¤šè´¦å·-åŠ è½½å…¨éƒ¨] å·²ä» school_accounts æ›´æ–° ${updatedCount} ä¸ªè´¦å·çš„å¯†ç å’ŒUA`);
                }
              }
            }
          } catch (error) {
            
            
            logMessage_Warning(`[å¤šè´¦å·-åŠ è½½å…¨éƒ¨] æ— æ³•åŠ è½½ school_accounts: ${error.message}`);
          }
        }

        
        renderMultiAccountList(result.accounts);
      }

      
      if (result && result.accounts_missing_password && result.accounts_missing_password.length > 0) {
        const missingAccount = result.accounts_missing_password[0];
        
        showModalAlert(`æ£€æµ‹åˆ° ${result.accounts_missing_password.length} ä¸ªè´¦å·ç¼ºå°‘å¯†ç ã€‚\nè¯·å…ˆä¸ºä»¥ä¸‹è´¦å·è¡¥å…¨å¯†ç ï¼š ${missingAccount.username}`, 'æç¤º');
        openMultiAddUserModalForPassword(missingAccount.username, missingAccount.tag);
      }
    }

    function openNewUserModal() {
      
      $('newUsername').value = "";
      $('newPassword').value = "";
      $('newPasswordConfirm').value = "";
      $('newUserPhone').value = "";
      $('newUserNickname').value = "";
      $('newUserSmsCode').value = "";
      $('newUserSmsGroup').style.display = "none";
      $('newUserModal').style.display = "flex"; 

      
      const phoneInput = $('newUserPhone');
      phoneInput.oninput = () => {
        const phone = phoneInput.value.trim();
        if (phone) {
          $('newUserSmsGroup').style.display = "block";
        } else {
          $('newUserSmsGroup').style.display = "none";
        }
      };
    }

    function closeNewUserModal() {
      $('newUserModal').style.display = "none";
    }
    $('newUserClose').onclick = closeNewUserModal;
    $('newUserCancel').onclick = closeNewUserModal;


    
    function openMultiAddUserModal() {
      
      $('multi-add-username').value = "";
      $('multi-add-password').value = "";
      $('multi-add-tag').value = "";
      
      $('multi-add-user-modal').style.display = 'flex';
    }

    
    function closeMultiAddUserModal() {
      
      const usernameInput = $('multi-add-username');
      const passwordInput = $('multi-add-password');
      if (usernameInput) {
        usernameInput.readOnly = false;
        usernameInput.classList.remove('bg-slate-100', 'cursor-not-allowed');
      }
      if (passwordInput) {
        passwordInput.placeholder = 'è¯·è¾“å…¥å¯†ç  (è‡³å°‘6å­—ç¬¦)';
      }

      
      $('multi-add-user-modal').style.display = 'none';
    }

    
    function openMultiAddUserModalForPassword(username, tag) {
      
      const usernameInput = $('multi-add-username');
      const tagInput = $('multi-add-tag');
      const passwordInput = $('multi-add-password');

      if (usernameInput) {
        usernameInput.value = username;
        usernameInput.readOnly = true; 
        usernameInput.classList.add('bg-slate-100', 'cursor-not-allowed');
      }
      if (tagInput) {
        tagInput.value = tag || '';
      }
      if (passwordInput) {
        passwordInput.value = ''; 
        passwordInput.placeholder = 'è¯¥è´¦å·ç¼ºå°‘å¯†ç ï¼Œè¯·è¡¥å…¨';
      }

      
      

      
      $('multi-add-user-modal').style.display = 'flex';

      
      if (passwordInput) {
        passwordInput.focus();
      }
    }


    
    $('newUserSendCode').onclick = async function () {
      const phone = $('newUserPhone').value.trim();
      if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
      }

      const sendCodeBtn = $('newUserSendCode');
      sendCodeBtn.disabled = true;
      const originalText = sendCodeBtn.textContent;

      try {
        
        const response = await fetch('/api/sms/send_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            phone: phone,
            scene: 'register' 
          })
        });
        const result = await response.json();

        if (result && result.success) {
          const expireMin = result.expire_minutes || 5;
          const retryAfter = result.retry_after || 180;
          showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

          
          let countdown = retryAfter;
          const timer = setInterval(() => {
            countdown--;
            sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            if (countdown <= 0) {
              clearInterval(timer);
              sendCodeBtn.disabled = false;
              sendCodeBtn.textContent = originalText;
            }
          }, 1000);
        } else {
          
          if (result?.retry_after) {
            let countdown = result.retry_after;
            sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
            const timer = setInterval(() => {
              countdown--;
              sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
              if (countdown <= 0) {
                clearInterval(timer);
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = originalText;
              }
            }, 1000);
          } else {
            sendCodeBtn.disabled = false;
          }
          showModalAlert(result?.message || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        sendCodeBtn.disabled = false;
        showModalAlert('å‘é€å¤±è´¥: ' + error.message);
      }
    };


    async function multi_addFromConfig() {
      
      const user = $('multi-config-user-select').value;

      if (!user) {
        
        
        openMultiAddUserModal();
        
        return;
      }

      
      
      
      let passwordToUse = ""; 
      let uaToUse = ""; 

      
      if (sessionUUID && currentAuthUsername) {
        
        try {
          
          const response = await fetch('/auth/admin/get_user_school_accounts', {
            method: 'GET',
            headers: {
              'X-Session-ID': sessionUUID  
            }
          });

          
          if (response.ok) {
            
            const result = await response.json();

            
            if (result.success && result.accounts) {
              
              
              const accountData = result.accounts[user];

              if (accountData) {
                if (typeof accountData === 'string') {
                  
                  passwordToUse = accountData;
                  logMessage_Info(`[å¤šè´¦å·-æ·»åŠ ] å·²ä» school_accounts åŠ è½½ç”¨æˆ· ${user} çš„å¯†ç ï¼ˆæ—§æ ¼å¼ï¼‰`);
                } else if (typeof accountData === 'object' && accountData !== null) {
                  
                  passwordToUse = accountData.password || "";
                  uaToUse = accountData.ua || "";
                  logMessage_Info(`[å¤šè´¦å·-æ·»åŠ ] å·²ä» school_accounts åŠ è½½ç”¨æˆ· ${user} çš„å¯†ç å’ŒUA`);
                }
              }
            }
          }
        } catch (error) {
          
          
          logMessage_Warning(`[å¤šè´¦å·-æ·»åŠ ] æ— æ³•åŠ è½½ school_accounts: ${error.message}`);
        }
      }

      
      
      const result = await callPythonAPI('multi_add_account', user, passwordToUse);

      
      
      if (result && result.success === false && result.action === 'request_password') {
        showModalAlert(`è´¦å· ${result.username} ç¼ºå°‘å¯†ç ï¼Œè¯·åœ¨å¼¹çª—ä¸­è¡¥å…¨ã€‚`, 'ç¼ºå°‘å¯†ç ');
        openMultiAddUserModalForPassword(result.username, result.tag);
      }
      else if (result && result.accounts) {
        
        renderMultiAccountList(result.accounts);
      }
    }

    
    async function submitMultiAddUser() {
      
      const inputUsername = $('multi-add-username');
      const inputPassword = $('multi-add-password');
      const inputTag = $('multi-add-tag');

      const usernameVal = inputUsername.value.trim();
      const passwordVal = inputPassword.value;
      const tagVal = inputTag.value.trim();

      
      if (!usernameVal || !passwordVal) {
        showModalAlert("è´¦å·å’Œå¯†ç å‡ä¸èƒ½ä¸ºç©º");
        return;
      }
      if (passwordVal.length < 6) {
        showModalAlert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      setButtonLoading('multi-add-user-confirm', true, 'æ·»åŠ ä¸­...');

      try {
        
        
        const result = await callPythonAPI(
          'multi_add_account',
          usernameVal, 
          passwordVal, 
          tagVal 
        );

        if (result && result.accounts) {
          showModalAlert('è´¦å·æ·»åŠ æˆåŠŸ', 'æˆåŠŸ');
          closeMultiAddUserModal(); 
          renderMultiAccountList(result.accounts); 
        } else {
          
          showModalAlert(result?.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (e) {
        
        showModalAlert(`æ·»åŠ æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`);
        logMessage_Error("æ·»åŠ æ–°è´¦å·æ—¶å‘ç”Ÿé”™è¯¯:", e);
      } finally {
        
        setButtonLoading('multi-add-user-confirm', false, 'ç¡®è®¤æ·»åŠ ');

        
        
        if (inputUsername && inputUsername.readOnly) {
          inputUsername.readOnly = false;
          inputUsername.classList.remove('bg-slate-100', 'cursor-not-allowed');
          $('multi-add-password').placeholder = 'è¯·è¾“å…¥å¯†ç  (è‡³å°‘6å­—ç¬¦)';
        }
      }
    }

    async function multi_importFromExcel() {
      
      

      const input = document.createElement('input');
      input.type = 'file';
      
      input.accept = '.xlsx, .xls, .csv';

      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) {
          logMessage_Info("æœªé€‰æ‹©æ–‡ä»¶ã€‚");
          return;
        }

        
        const fileName = file.name;
        const fileExt = fileName.split('.').pop().toLowerCase();
        if (!['xlsx', 'xls', 'csv'].includes(fileExt)) {
          showModalAlert("æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œè¯·é€‰æ‹© .xlsx, .xls, æˆ– .csv æ–‡ä»¶ã€‚");
          return;
        }

        logMessage_Info(`æ­£åœ¨è¯»å–æ–‡ä»¶: ${fileName}`);

        
        
        const reader = new FileReader();
        reader.readAsDataURL(file); 

        reader.onload = async () => {
          try {
            
            
            const base64Content = reader.result.split(',')[1];

            
            const result = await callPythonAPI('multi_import_accounts', fileName, base64Content);

            if (result && result.success) {
              logMessage_Info(`æˆåŠŸå¯¼å…¥ ${result.imported_count || 0} ä¸ªè´¦å·ã€‚`);
              if (result.skipped_count > 0) {
                
                showModalAlert(`å¯¼å…¥å®Œæˆï¼š\næˆåŠŸ ${result.imported_count} ä¸ªã€‚\nè·³è¿‡ ${result.skipped_count} ä¸ªï¼ˆç¼ºå°‘å¯†ç ï¼‰ã€‚\n\nè¯¦æƒ…ï¼š${result.message}`, "å¯¼å…¥æç¤º");
              }
              
              if (result.accounts) {
                renderMultiAccountList(result.accounts);
              }
            } else {
              showModalAlert(`å¯¼å…¥å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
          } catch (err) {
            logMessage_Error("å¯¼å…¥æ–‡ä»¶æ—¶å‡ºé”™:", err);
            showModalAlert(`å¯¼å…¥å¤±è´¥: ${err.message}`);
          }
        };

        reader.onerror = () => {
          logMessage_Error("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
          showModalAlert("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
        };
      };

      
      input.click();
    }

    async function multi_exportToExcel() {
      const result = await callPythonAPI('multi_export_accounts_summary');
      if (!result || !result.success) {
        showModalAlert(result?.message || 'å¯¼å‡ºå¤±è´¥');
        return;
      }

      
      if (result.content && result.filename) {
        const binaryString = atob(result.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: result.mimetype || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage_Info(`æ±‡æ€»å·²å¯¼å‡ºï¼š${result.filename}`);
      }
    }

    async function multi_startAll() {


      
      const count = parseInt($('multi-account-count').textContent || '0', 10);
      if (!count || count <= 0) {
        showModalAlert('è´¦å·åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹ã€‚è¯·å…ˆæ·»åŠ è´¦å·ã€‚');

        return;
      }


      const use_delay = $('multi-use-delay-check').checked;
      const min_delay = parseInt($('multi-min-delay-input').value) || 0;
      const max_delay = parseInt($('multi-max-delay-input').value) || 300;
      const run_only_incomplete = $('multi-run-only-incomplete-check').checked;

      const result = await callPythonAPI('multi_start_all_accounts', min_delay, max_delay, use_delay, run_only_incomplete);
      
      if (!result || !result.success) {
        showModalAlert(result?.message || 'æ— æ³•å¼€å§‹å…¨éƒ¨è´¦å·ä»»åŠ¡ã€‚');

        return;
      }
    }


    async function multi_stopAll() {
      await callPythonAPI('multi_stop_all_accounts');

    }

    
    function onAccountsUpdated(accounts) {
      try {
        renderMultiAccountList(accounts);
      } catch (e) {
        logMessage_Error("onAccountsUpdated render failed:", e);
      }
    }

    function calculateStatusText(account, onlyIncomplete = false, ignoreTaskTime = false) {
      if (!account || !account.tasks || !Array.isArray(account.tasks)) {
        return 'æ— ä»»åŠ¡æ•°æ®';
      }

      let executableCount = 0;
      const now = new Date();
      
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      account.tasks.forEach(task => {
        
        
        
        
        if (onlyIncomplete && task.status == 1) {
          return; 
        }

        
        let isExpired = false;
        let isNotStarted = false;

        
        const startTimeStr = task.start_time ? task.start_time.replace(/-/g, '/') : null;
        const endTimeStr = task.end_time ? task.end_time.replace(/-/g, '/') : null;

        const startTime = startTimeStr ? new Date(startTimeStr) : null;
        const endTime = endTimeStr ? new Date(endTimeStr) : null;

        if (ignoreTaskTime) {
          
          if (startTime) {
            
            const startDate = new Date(startTime.getFullYear(), startTime.getMonth(), startTime.getDate());
            
            if (today < startDate) isNotStarted = true;
          }
          if (endTime) {
            
            const endDate = new Date(endTime.getFullYear(), endTime.getMonth(), endTime.getDate());
            
            if (today > endDate) isExpired = true;
          }
        } else {
          
          if (startTime && now < startTime) isNotStarted = true;
          if (endTime && now > endTime) isExpired = true;
        }

        
        if (isNotStarted || isExpired) {
          return;
        }

        
        executableCount++;
      });

      
      if (executableCount === 0) {
        return 'æ— ä»»åŠ¡å¯æ‰§è¡Œ';
      } else {
        return `æœ‰ ${executableCount} ä¸ªä»»åŠ¡å¯æ‰§è¡Œ`;
      }
    }
    
    function updateAllAccountsStatusText() {
      try {
        
        
        if (!cachedMultiAccounts || !Array.isArray(cachedMultiAccounts) || cachedMultiAccounts.length === 0) {
          return;
        }

        
        
        let onlyIncomplete = true;
        const mbChk = document.getElementById('mobile-multi-only-incomplete-check');
        const pcChk = document.getElementById('multi-run-only-incomplete-check');

        
        if (typeof isMobileMode !== 'undefined' && isMobileMode && mbChk) {
          onlyIncomplete = mbChk.checked;
          if (pcChk) pcChk.checked = onlyIncomplete; 
        } else if (pcChk) {
          onlyIncomplete = pcChk.checked;
          if (mbChk) mbChk.checked = onlyIncomplete; 
        }

        
        
        
        
        let ignoreTaskTime = true; 
        if (typeof pythonParams !== 'undefined') {
          
          if (pythonParams.hasOwnProperty('ignore_task_time')) {
            ignoreTaskTime = !!pythonParams.ignore_task_time;
          }
        }

        
        let updatedCount = 0;
        cachedMultiAccounts.forEach(account => {
          
          const newStatusText = calculateStatusText(account, onlyIncomplete, ignoreTaskTime);

          
          account.status_text = newStatusText;

          

          
          const pcItem = document.getElementById(`multi-acc-${account.username}`);
          if (pcItem) {
            const statusEl = pcItem.querySelector('.status-text');
            if (statusEl) {
              statusEl.textContent = newStatusText;
              
              if (newStatusText.includes('æ— ä»»åŠ¡')) {
                statusEl.className = 'status-text font-semibold text-slate-500 text-xs px-2 py-0.5 rounded-full bg-slate-100 flex-shrink-0 whitespace-nowrap';
              } else if (newStatusText.includes('æœ‰')) {
                statusEl.className = 'status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap';
              }
              updatedCount++;
            }
          }

          
          const mobileItem = document.getElementById(`mobile-multi-acc-${account.username}`);
          if (mobileItem) {
            const statusEl = mobileItem.querySelector('.status-text');
            if (statusEl) {
              statusEl.textContent = newStatusText;
              
              if (newStatusText.includes('æ— ä»»åŠ¡')) {
                statusEl.className = 'status-text font-semibold text-slate-500 text-xs px-2 py-0.5 rounded-full bg-slate-100 flex-shrink-0 whitespace-nowrap';
              } else if (newStatusText.includes('æœ‰')) {
                statusEl.className = 'status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap';
              }
              updatedCount++;
            }
          }
        });

        console.log(`[çŠ¶æ€åˆ·æ–°] æ ¹æ®æœ¬åœ°ç¼“å­˜å·²æ›´æ–° ${updatedCount} ä¸ªè´¦å·çŠ¶æ€ (OnlyIncomplete: ${onlyIncomplete}, IgnoreTime: ${ignoreTaskTime})`);

      } catch (error) {
        console.error('[æ›´æ–°è´¦å·çŠ¶æ€] æ›´æ–°çŠ¶æ€æ–‡æœ¬æ—¶å‘ç”Ÿé”™è¯¯:', error);
      }
    }

    function renderMultiAccountList(accounts) {
      
      
      cachedMultiAccounts = accounts;

      
      const renderToContainer = (containerId, isMobile) => {
        const listDiv = document.getElementById(containerId);
        if (!listDiv) return;

        listDiv.innerHTML = '';

        
        const countId = isMobile ? 'mobile-multi-account-count' : 'multi-account-count';
        const countEl = document.getElementById(countId);
        if (countEl) countEl.textContent = isMobile ? `${accounts.length} ä¸ªè´¦å·` : accounts.length;

        if (accounts.length === 0) {
          listDiv.innerHTML = '<p class="text-slate-400 text-center py-10">è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥è´¦å·</p>';
          return;
        }

        accounts.forEach(acc => {
          const s = acc.summary;
          const item = document.createElement('div');
          
          const prefix = isMobile ? 'mobile-multi-acc-' : 'multi-acc-';
          item.id = `${prefix}${acc.username}`;
          item.dataset.username = acc.username;
          item.className = 'p-3 rounded-xl border border-slate-200 bg-white/80 mb-2 text-sm';

          
          item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-slate-800 flex items-start gap-2 truncate min-w-0">
                            <input type="checkbox" class="account-checkbox w-4 h-4 accent-sky-600 rounded flex-shrink-0 mt-1">
                            <div class="truncate">
                                <span class="account-name truncate">${acc.name}</span>
                                <span class="text-xs text-slate-500 font-normal block">(${acc.username})</span>
                                ${acc.tag ? `<span class="text-xs text-purple-600 font-medium block">ğŸ·ï¸ ${acc.tag}</span>` : ''}
                            </div>
                        </div>
                        <span class="status-text font-semibold text-sky-600 text-xs px-2 py-0.5 rounded-full bg-sky-100 flex-shrink-0 whitespace-nowrap">${acc.status_text}</span>
                    </div>

                    <div class="grid grid-cols-5 gap-2 text-center text-xs mt-2 pt-2 border-t text-slate-600">
                        <div>æ€»æ•°: <span class="summary-total font-bold">${s.total}</span></div>
                        <div>å®Œæˆ: <span class="summary-completed font-bold text-emerald-600">${s.completed}</span></div>
                        <div>æœªå¼€å§‹: <span class="summary-notstarted font-bold text-slate-600">${s.not_started}</span></div>
                        <div>å¯è·‘: <span class="summary-executable font-bold text-amber-600">${s.executable}</span></div>
                        <div>è¿‡æœŸ: <span class="summary-expired font-bold text-red-600">${s.expired}</span></div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center text-xs mt-2 pt-2 border-t border-slate-100 text-slate-600">
                        <div title="å¾…ç­¾åˆ°ä»»åŠ¡">å¾…ç­¾: <span class="summary-att-pending font-bold text-sky-600">${s.att_pending || 0}</span></div>
                        <div title="å·²ç­¾åˆ°ä»»åŠ¡">å·²ç­¾: <span class="summary-att-completed font-bold text-emerald-600">${s.att_completed || 0}</span></div>
                        <div title="å·²è¿‡æœŸç­¾åˆ°">è¿‡æœŸ: <span class="summary-att-expired font-bold text-red-600">${s.att_expired || 0}</span></div>
                    </div>

                    <div class="flex justify-end items-center gap-2 mt-2 pt-2 border-t">
                        <button class="btn-account-refresh btn btn-ghost !py-1 !px-3 !text-xs" data-username="${acc.username}">åˆ·æ–°</button>
                        <button class="btn-account-start btn btn-success !py-1 !px-3 !text-xs" data-username="${acc.username}">å¼€å§‹</button>
                        <button class="btn-account-stop btn btn-warning !py-1 !px-3 !text-xs" data-username="${acc.username}">åœæ­¢</button>
                        <button class="btn-account-params btn btn-ghost !py-1 !px-3 !text-xs" data-username="${acc.username}" style="display:none">è®¾ç½®</button>
                    </div>
                    <div class="mt-2">
                        <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="progress-fill h-2 bg-sky-500" style="width:0%"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="progress-text text-slate-600">æœªå¼€å§‹</span>
                            <span class="progress-extra text-slate-400"></span>
                        </div>
                    </div>
                `;
          listDiv.appendChild(item);
        });

        
        listDiv.querySelectorAll('.btn-account-start').forEach(b => b.onclick = (e) => {
          
          const checkboxId = isMobile ? 'mobile-multi-only-incomplete-check' : 'multi-run-only-incomplete-check';
          const runOnly = document.getElementById(checkboxId)?.checked ?? true;
          callPythonAPI('multi_start_single_account', e.target.dataset.username, runOnly);
        });

        listDiv.querySelectorAll('.btn-account-stop').forEach(b => b.onclick = (e) =>
          callPythonAPI('multi_stop_single_account', e.target.dataset.username)
        );

        listDiv.querySelectorAll('.btn-account-refresh').forEach(b => {
          b.onclick = async (e) => {
            const u = e.currentTarget.dataset.username;
            
            const itemPrefix = isMobile ? 'mobile-multi-acc-' : 'multi-acc-';
            const item = document.getElementById(`${itemPrefix}${u}`);
            if (item) {
              const statusEl = item.querySelector('.status-text');
              if (statusEl) statusEl.textContent = 'åˆ·æ–°ä¸­...';
            }
            const result = await callPythonAPI('multi_refresh_single_status', u);
            if (!result || !result.success) {
              showModalAlert(result?.message || 'åˆ·æ–°å¤±è´¥');
            }
          };
        });

        listDiv.querySelectorAll('.btn-account-params').forEach(b => {
          b.onclick = (e) => {
            if (isMobile) {
              openMobileAccountParams(e.target.dataset.username);
            } else {
              openAccountParamsModal(e.target.dataset.username);
            }
          }
        });
      };

      
      renderToContainer('multi-account-list', false);

      
      renderToContainer('mobile-multi-account-list', true);

      
      if (typeof updateSelectAllCheckboxState === 'function') updateSelectAllCheckboxState();
      if (typeof updateMobileSelectAllCheckboxState === 'function') updateMobileSelectAllCheckboxState();
    }

    
    function multi_toggleSelectAll(event) {
      const isChecked = event.target.checked;
      
      const container = document.getElementById('multi-account-list');
      if (container) {
        container.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = isChecked);
      }
    }

    function updateSelectAllCheckboxState() {
      
      const container = document.getElementById('multi-account-list');
      if (!container) return;
      
      const allCheckboxes = container.querySelectorAll('.account-checkbox');
      const checkedCount = container.querySelectorAll('.account-checkbox:checked').length;
      const selectAllCheckbox = $('multi-select-all-check');
      if (allCheckboxes.length > 0) {
        selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    $('multi-account-list').addEventListener('change', (event) => { if (event.target.classList.contains('account-checkbox')) { updateSelectAllCheckboxState(); } });

    async function multi_removeAll(confirm = false) {
      if (!confirm) {
        logMessage_Info('å‡†å¤‡ç§»é™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰è´¦å·');
        const confirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', 'ç¡®å®šè¦ç§»é™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
      } else {
        logMessage_Info('ç§»é™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰è´¦å·');
        const confirmed = true;
      }

      if (confirmed) {
        const result = await callPythonAPI('multi_remove_all_accounts');
        if (result && result.accounts) renderMultiAccountList(result.accounts);
      }
    }

    async function multi_removeSelected(confirm = false) {
      
      const container = document.getElementById('multi-account-list');
      if (!container) return;
      
      const selectedUsernames = Array.from(container.querySelectorAll('.account-checkbox:checked')).map(cb => cb.closest('[data-username]').dataset.username);
      if (selectedUsernames.length === 0) { showModalAlert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ç§»é™¤çš„è´¦å·ã€‚"); return; }
      if (!confirm) {
        logMessage_Info(`å‡†å¤‡ç§»é™¤é€‰ä¸­çš„è´¦å·: ${selectedUsernames.join(', ')}`);
        const confirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', `ç¡®å®šè¦ç§»é™¤é€‰ä¸­çš„ ${selectedUsernames.length} ä¸ªè´¦å·å—ï¼Ÿ`);
      } else {
        logMessage_Info(`ç§»é™¤é€‰ä¸­çš„è´¦å·: ${selectedUsernames.join(', ')}`);
        const confirmed = true;
      }
      if (confirmed) {
        const result = await callPythonAPI('multi_remove_selected_accounts', selectedUsernames);
        if (result && result.accounts) renderMultiAccountList(result.accounts);
      }
    }

    function multi_getSelectedUsernames() {
      
      const container = document.getElementById('multi-account-list');
      if (!container) return [];
      
      return Array.from(container.querySelectorAll('.account-checkbox:checked'))
        .map(cb => cb.closest('[data-username]')?.dataset?.username)
        .filter(Boolean);
    }

    async function multi_startSelected() {
      const usernames = multi_getSelectedUsernames();
      if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œå¼€å§‹é€‰ä¸­â€ã€‚');
        return;
      }
      
      const use_delay = $('multi-use-delay-check')?.checked ?? true;
      const min_delay = parseInt($('multi-min-delay-input')?.value) || 0;
      const max_delay = parseInt($('multi-max-delay-input')?.value) || 300;
      const run_only_incomplete = $('multi-run-only-incomplete-check')?.checked ?? true;

      
      for (const u of usernames) {
        try {
          
          if (use_delay && max_delay >= min_delay) {
            const d = Math.random() * (max_delay - min_delay) + min_delay;
            
            await new Promise(res => setTimeout(res, d * 10)); 
          }
          await callPythonAPI('multi_start_single_account', u, run_only_incomplete);
        } catch (e) {
          logMessage_Error(`å¼€å§‹è´¦å· ${u} å¤±è´¥`, e);
        }
      }
    }

    async function multi_stopSelected() {
      const usernames = multi_getSelectedUsernames();
      if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œåœæ­¢é€‰ä¸­â€ã€‚');
        return;
      }
      for (const u of usernames) {
        try {
          await callPythonAPI('multi_stop_single_account', u);
        } catch (e) {
          logMessage_Error(`åœæ­¢è´¦å· ${u} å¤±è´¥`, e);
        }
      }
    }

    async function multi_refreshSelected() {
      const usernames = multi_getSelectedUsernames();
      if (usernames.length === 0) {
        showModalAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·å†æ‰§è¡Œâ€œåˆ·æ–°é€‰ä¸­â€ã€‚');
        return;
      }
      for (const u of usernames) {
        try {
          
          const item = document.getElementById(`multi-acc-${u}`);
          if (item) {
            const statusEl = item.querySelector('.status-text');
            if (statusEl) statusEl.textContent = 'åˆ·æ–°ä¸­...';
          }
          await callPythonAPI('multi_refresh_single_status', u);
        } catch (e) {
          logMessage_Error(`åˆ·æ–°è´¦å· ${u} å¤±è´¥`, e);
        }
      }
    }


    async function multi_refreshAll() { await callPythonAPI('multi_refresh_all_statuses'); }


    
    let lastAccountListSignature = '';

    
    function startMultiAccountAutoRefresh(interval = 500) { 
      
      if (multiAccountAutoRefreshInterval) {
        clearInterval(multiAccountAutoRefreshInterval);
        multiAccountAutoRefreshInterval = null;
      }

      
      multiAccountAutoRefreshInterval = setInterval(async () => {
        try {
          
          const pcMultiApp = document.getElementById('multi-account-app');
          const mobileMultiApp = document.getElementById('mobile-multi-account-app');
          const isVisible = (pcMultiApp && !pcMultiApp.classList.contains('hidden')) ||
            (mobileMultiApp && !mobileMultiApp.classList.contains('hidden'));

          if (!isVisible) {
            return;
          }

          
          const response = await callPythonAPI('multi_get_all_accounts_status');

          if (response && response.success && response.accounts) {

            
            
            
            const currentSignature = response.accounts.map(a => a.username).join('|');

            
            
            if (currentSignature !== lastAccountListSignature) {
              console.log('[å¤šè´¦å·åˆ·æ–°] è´¦å·åˆ—è¡¨ç»“æ„å˜åŒ–ï¼Œé‡ç»˜ DOM');
              renderMultiAccountList(response.accounts);
              lastAccountListSignature = currentSignature;
            }

            
            
            response.accounts.forEach(acc => {
              if (!acc.username) return;

              
              const updateData = {
                status_text: acc.status_text,
                name: acc.name,
                summary: acc.summary,
                progress_pct: acc.progress_pct,
                progress_text: acc.progress_text,
                progress_extra: acc.progress_extra
              };

              
              
              multi_updateAccountStatus(acc.username, updateData);

              
              if (acc.current_position &&
                typeof acc.current_position.lon === 'number' &&
                typeof acc.current_position.lat === 'number') {

                multi_updateRunnerPosition(
                  acc.username,
                  acc.current_position.lon,
                  acc.current_position.lat,
                  acc.name || acc.username
                );
              }
            });
          }

        } catch (error) {
          
          console.error('[å¤šè´¦å·è‡ªåŠ¨åˆ·æ–°] è½®è¯¢è¯·æ±‚å¤±è´¥:', error);
        }
      }, interval);

      console.log(`[å¤šè´¦å·è‡ªåŠ¨åˆ·æ–°] å·²å¯åŠ¨é«˜é¢‘è½®è¯¢ (é—´éš”: ${interval}ms)`);
    }



    
    function stopMultiAccountAutoRefresh() {
      
      if (multiAccountAutoRefreshInterval) {
        
        
        clearInterval(multiAccountAutoRefreshInterval);

        
        
        multiAccountAutoRefreshInterval = null;

        
        console.log('[å¤šè´¦å·è‡ªåŠ¨åˆ·æ–°] å·²åœæ­¢å®šæ—¶è‡ªåŠ¨åˆ·æ–°');
      }
      
    }

    async function process_path_queue() {
      if (is_planning_path || path_planning_queue.length === 0) return;
      is_planning_path = true;
      const { username, waypoints } = path_planning_queue.shift();
      try {
        logMessage_Info(`[JS-Queue] å¼€å§‹å¤„ç† ${username} çš„è·¯å¾„è§„åˆ’...`);
        const path = await getWalkingPath(waypoints);
        logMessage_Info(`[JS-Queue] è·¯å¾„è§„åˆ’æˆåŠŸ for ${username}, è¿”å› ${path.length} ç‚¹ç»™Pythonã€‚`);
        callPythonAPI('multi_path_generation_callback', username, true, path);
      } catch (error) {
        logMessage_Info(`[JS-Queue] è·¯å¾„è§„åˆ’å¤±è´¥ for ${username}: ${error}`);
        callPythonAPI('multi_path_generation_callback', username, false, String(error));
      } finally {
        is_planning_path = false;
        setTimeout(process_path_queue, 100);
      }
    }
    function triggerPathGenerationForPy(username, waypoints) {
      logMessage_Info(`æ”¶åˆ° ${username} çš„è·¯å¾„è§„åˆ’è¯·æ±‚ï¼Œå·²åŠ å…¥é˜Ÿåˆ—ã€‚`);
      path_planning_queue.push({ username, waypoints });
      process_path_queue();
    }

    function updateMobileSelectAllCheckboxState() {
      const container = document.getElementById('mobile-multi-account-list');
      if (!container) return;

      const allCheckboxes = container.querySelectorAll('.account-checkbox');
      const checkedCount = container.querySelectorAll('.account-checkbox:checked').length;
      const selectAllCheckbox = document.getElementById('mobile-select-all-accounts');

      if (selectAllCheckbox) {
        if (allCheckboxes.length > 0) {
          selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
          selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
      }
    }

    
    const mobileListDiv = document.getElementById('mobile-multi-account-list');
    if (mobileListDiv) {
      mobileListDiv.addEventListener('change', (event) => {
        if (event.target.classList.contains('account-checkbox')) {
          updateMobileSelectAllCheckboxState();
        }
      });
    }

    function multi_updateAccountStatus(username, data) {
      
      const ids = [`multi-acc-${username}`, `mobile-multi-acc-${username}`];

      ids.forEach(id => {
        const item = document.getElementById(id);
        if (!item) return;

        
        if (data.status_text) {
          const statusEl = item.querySelector('.status-text');
          if (statusEl) statusEl.textContent = data.status_text;
        }
        if (data.name) {
          const nameEl = item.querySelector('.account-name');
          if (nameEl) nameEl.textContent = data.name;
        }

        if (data.summary) {
          const s = data.summary;
          const setVal = (sel, val) => {
            const el = item.querySelector(sel);
            if (el) el.textContent = val;
          };

          setVal('.summary-total', s.total);
          setVal('.summary-completed', s.completed);
          setVal('.summary-notstarted', s.not_started ?? 0);
          setVal('.summary-executable', s.executable);
          setVal('.summary-expired', s.expired);

          setVal('.summary-att-pending', s.att_pending || 0);
          setVal('.summary-att-completed', s.att_completed || 0);
          setVal('.summary-att-expired', s.att_expired || 0);
        }

        
        if (typeof data.progress_pct === 'number') {
          const fill = item.querySelector('.progress-fill');
          if (fill) fill.style.width = `${Math.max(0, Math.min(100, data.progress_pct))}%`;
        }
        if (typeof data.progress_text === 'string') {
          const label = item.querySelector('.progress-text');
          if (label) label.textContent = data.progress_text;
        }
        if (typeof data.progress_extra === 'string') {
          const extra = item.querySelector('.progress-extra');
          if (extra) extra.textContent = data.progress_extra;
        }
      });

      
      const currentStatus = (typeof data.status_text === 'string' && data.status_text.trim())
        ? data.status_text.trim()
        : ''; 

      const NON_RUNNING_STATUSES = new Set([
        'ä»»åŠ¡å·²å®Œæˆ', 'å…¨éƒ¨å®Œæˆ', 'æ— ä»»åŠ¡å¯æ‰§è¡Œ', 'æ— å¯æ‰§è¡Œä»»åŠ¡', 'å·²åœæ­¢', 'å·²ä¸­æ­¢', 'å¾…å‘½'
      ]);

      if (NON_RUNNING_STATUSES.has(currentStatus)) {
        if (typeof multi_removeRunnerMarker === 'function') multi_removeRunnerMarker(username);
        return;
      }

      const s = data.summary;
      if (s && typeof s.executable === 'number' && s.executable <= 0) {
        const maybeRunning = ['ç™»å½•ä¸­...', 'åˆ†æä»»åŠ¡', 'è¿è¡Œ', 'ç­‰å¾…', 'æ’é˜Ÿç™»å½•...', 'å»¶è¿Ÿ'];
        const isLikelyRunning = maybeRunning.some(k => currentStatus.includes(k));
        if (!isLikelyRunning) {
          if (typeof multi_removeRunnerMarker === 'function') multi_removeRunnerMarker(username);
        }
      }
    }

    function multi_updateRunnerPosition(username, lon, lat, name) {
      if (!multiAccountMap) return;
      const pos = new AMapInstance.LngLat(lon, lat);
      if (multiAccountMarkers[username]) {
        multiAccountMarkers[username].setPosition(pos);
      } else {
        const color = userColors[colorIndex++ % userColors.length];
        const markerContent = `<div style="background-color: ${color};" class="text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg text-white">${name}</div>`;
        multiAccountMarkers[username] = new AMapInstance.Marker({
          position: pos, content: markerContent, anchor: 'bottom-center',
          zIndex: 110, title: `${name} (${username})`
        });
        multiAccountMap.add(multiAccountMarkers[username]);
      }
      multi_resetMapView();
    }

    function multi_removeRunnerMarker(username) {
      const marker = multiAccountMarkers[username];
      if (marker && multiAccountMap) {
        multiAccountMap.remove(marker);
      }
      delete multiAccountMarkers[username];
      
      multi_resetMapView();
    }


    function multi_resetMapView() {
      if (!multiAccountMap) return;
      const overlays = Object.values(multiAccountMarkers).filter(m => m.getMap());
      if (overlays.length > 0) {
        multiAccountMap.setFitView(overlays, false, [80, 80, 80, 80]);
      } else {
        multiAccountMap.setZoomAndCenter(17, [113.390342, 22.527403]);
      }
    }


    function selectTaskFromBackend(index) { if (selectedTaskIndex !== index) selectTask(index); }

    function updateDashboard() {
      if (!currentRunData || Object.keys(currentRunData).length === 0) {
        $('run-stats-label').textContent = `-- km / --:--`;
        $('live-dist-label').textContent = '0.00 km';
        $('total-dist-label').textContent = '0.00 km';
        $('live-time-label').textContent = '00:00';
        $('total-time-label').textContent = '00:00';
        $('target-points-text').innerHTML = '<p class="text-slate-400 text-center text-xs pt-4">è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡</p>';
        $('current-location-label').textContent = 'å½“å‰ä½ç½®GPSåæ ‡: --, --';
        return;
      }
      const isDrawingNow = isDrawing && !currentRunData.run_coords?.length;
      if (isDrawingNow && draftTotalDist > 0) {
        const drawKm = (draftTotalDist / 1000).toFixed(2);
        const avgSpeed = pythonParams.speed_mps || 1.5;
        const estMin = avgSpeed > 0 ? (draftTotalDist / avgSpeed) / 60 : 0;
        $('run-stats-block').innerHTML = `<p class="text-sm text-slate-500">å½“å‰ç»˜åˆ¶</p><p class="font-bold text-2xl text-emerald-600">${drawKm} km / ~${estMin.toFixed(1)} min</p>`;
      } else {
        const dist = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
        const timeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
        const timeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
        $('run-stats-block').innerHTML = `<p class="text-sm text-slate-500">å·²é€‰ä»»åŠ¡æ€»è§ˆ</p><p id="run-stats-label" class="font-bold text-2xl text-sky-600">${dist} km / ${String(timeMin).padStart(2, '0')}:${String(timeSec).padStart(2, '0')}</p>`;
      }
      const liveKm = ((currentRunData.distance_covered_m || 0) / 1000).toFixed(2);
      const liveMs = runAccumulatedMs || 0;
      const mm = String(Math.floor(liveMs / 60000)).padStart(2, '0');
      const ss = String(Math.floor((liveMs % 60000) / 1000)).padStart(2, '0');
      $('live-dist-label').textContent = `${liveKm} km`;
      $('live-time-label').textContent = `${mm}:${ss}`;

      const totalDistKm = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
      $('total-dist-label').textContent = `${totalDistKm} km`;
      const totalTimeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
      const totalTimeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
      $('total-time-label').textContent = `${String(totalTimeMin).padStart(2, '0')}:${String(totalTimeSec).padStart(2, '0')}`;

      const targetDiv = $('target-points-text');
      targetDiv.innerHTML = "";
      const names = (currentRunData.target_point_names || "").split('|');
      const sequence = currentRunData.target_sequence || 0;
      if (names.length === 0 || (names.length === 1 && names[0] === '')) {
        targetDiv.innerHTML = '<p class="text-slate-400 text-center text-xs pt-4">æ­¤ä»»åŠ¡æ— æ‰“å¡ç‚¹</p>';
      } else {
        names.forEach((name, i) => {
          if (!name) return;
          const p = document.createElement('p');
          let textClass = 'text-slate-500';
          if (sequence > 0) {
            if (i + 1 < sequence) textClass = 'text-slate-400 line-through';
            else if (i + 1 === sequence) textClass = 'font-bold text-sky-600';
          }
          p.className = `transition-colors p-1 rounded ${textClass}`;
          p.innerHTML = `<span class="font-mono w-6 inline-block">${i + 1}.</span>${name}`;
          targetDiv.appendChild(p);
        });
        centerTargetList(sequence);
      }

      
      
      const mobileRunStatsLabel = document.getElementById('mobile-run-stats-label');
      if (mobileRunStatsLabel) {
        if (isDrawingNow && draftTotalDist > 0) {
          const drawKm = (draftTotalDist / 1000).toFixed(2);
          const avgSpeed = pythonParams.speed_mps || 1.5;
          const estMin = avgSpeed > 0 ? (draftTotalDist / avgSpeed) / 60 : 0;
          mobileRunStatsLabel.textContent = `${drawKm} km / ~${estMin.toFixed(1)} min`;
        } else {
          const dist = ((currentRunData.total_run_distance_m || 0) / 1000).toFixed(2);
          const timeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
          const timeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
          mobileRunStatsLabel.textContent = `${dist} km / ${String(timeMin).padStart(2, '0')}:${String(timeSec).padStart(2, '0')}`;
        }
      }

      
      const mobileLiveDistLabel = document.getElementById('mobile-live-dist-label');
      const mobileLiveTimeLabel = document.getElementById('mobile-live-time-label');
      const mobileTotalDistLabel = document.getElementById('mobile-total-dist-label');
      const mobileTotalTimeLabel = document.getElementById('mobile-total-time-label');
      const mobileCurrentLocationLabel = document.getElementById('mobile-current-location-label');

      if (mobileLiveDistLabel) {
        mobileLiveDistLabel.textContent = `${liveKm} km`;
      }
      if (mobileLiveTimeLabel) {
        mobileLiveTimeLabel.textContent = `${mm}:${ss}`;
      }
      if (mobileTotalDistLabel) {
        mobileTotalDistLabel.textContent = `${totalDistKm} km`;
      }
      if (mobileTotalTimeLabel) {
        const totalTimeMin = Math.floor((currentRunData.total_run_time_s || 0) / 60);
        const totalTimeSec = Math.floor((currentRunData.total_run_time_s || 0) % 60);
        mobileTotalTimeLabel.textContent = `${String(totalTimeMin).padStart(2, '0')}:${String(totalTimeSec).padStart(2, '0')}`;
      }
      if (mobileCurrentLocationLabel && currentRunData) {
        
        const currentLocationLabel = document.getElementById('current-location-label');
        if (currentLocationLabel) {
          const coordsText = currentLocationLabel.textContent.replace('å½“å‰ä½ç½®GPSåæ ‡: ', '');
          mobileCurrentLocationLabel.textContent = `å½“å‰ä½ç½®: ${coordsText}`;
        }
      }

      
      
      renderMobileCheckpointsList();
    }
    function centerTargetList(sequence) {
      const targetDiv = $('target-points-text');
      if (!targetDiv || !targetDiv.children || targetDiv.children.length === 0) return;
      const idx = Math.max(0, Math.min(targetDiv.children.length - 1, (sequence || 1) - 1));
      const child = targetDiv.children[idx];
      if (child && typeof child.scrollIntoView === 'function') {
        try { child.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) { }
      }
    }
    function resetMapView() {
      if (!map) return;
      const overlays = [...polylines.recommended, ...markers];
      if (polylines.draft) overlays.push(polylines.draft);
      if (polylines.run) overlays.push(polylines.run);
      if (polylines.history) overlays.push(polylines.history);

      if (overlays.length > 0) {
        map.setFitView(overlays, false, [60, 60, 60, 60]);
      } else if (currentRunData && currentRunData.target_points?.length > 0) {
        const targetLngLats = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        map.setFitView(targetLngLats, false, [60, 60, 60, 60]);
      } else {
        map.setZoomAndCenter(17, [113.390342, 22.527403]);
      }
    }

    
    function forceProjectionRefresh() {
      if (!map) return;
      try {
        
        map.setStatus({ dragEnable: false });

        
        map.resize();

        
        requestAnimationFrame(() => {
          const overlays = [...polylines.recommended];
          if (polylines.draft) overlays.push(polylines.draft);
          if (polylines.run) overlays.push(polylines.run);
          if (polylines.history) overlays.push(polylines.history);

          
          if (overlays.length > 0) {
            map.setFitView(overlays, false, [60, 60, 60, 60]);
          } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
            const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
            map.setFitView(pts, false, [60, 60, 60, 60]);
          } else {
            map.setZoomAndCenter(17, [113.390342, 22.527403]);
          }

          
          map.setStatus({ dragEnable: true });
        });
      } catch (e) {
        logMessage_Warning('forceProjectionRefresh warning:', e);
      }
    }


    
    function forceProjectionRefresh() {
      if (!map) return;
      try {
        
        map.setStatus({ dragEnable: false });

        
        map.resize();

        
        requestAnimationFrame(() => {
          const overlays = [...polylines.recommended];
          if (polylines.draft) overlays.push(polylines.draft);
          if (polylines.run) overlays.push(polylines.run);
          if (polylines.history) overlays.push(polylines.history);

          
          if (overlays.length > 0) {
            map.setFitView(overlays, false, [60, 60, 60, 60]);
          } else if (currentRunData && Array.isArray(currentRunData.target_points) && currentRunData.target_points.length > 0) {
            const pts = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
            map.setFitView(pts, false, [60, 60, 60, 60]);
          } else {
            map.setZoomAndCenter(17, [113.390342, 22.527403]);
          }

          
          map.setStatus({ dragEnable: true });
        });
      } catch (e) {
        logMessage_Warning('forceProjectionRefresh warning:', e);
      }
    }




    
    function drawOnMap_signature() {
      if (!map) return;
      clearMapOverlays();
      const data = currentRunData;
      if (!data) return;

      if (data.recommended_coords?.length > 0) {
        let segment = [];
        data.recommended_coords.forEach(p => {
          if (p[0] === 0 && p[1] === 0) {
            if (segment.length > 1) polylines.recommended.push(new AMapInstance.Polyline({ path: segment, strokeColor: "#10b981", strokeWeight: 5, lineCap: 'round', strokeOpacity: 0.6, zIndex: 40 }));
            segment = [];
          } else { segment.push(new AMapInstance.LngLat(p[0], p[1])); }
        });
        if (segment.length > 1) polylines.recommended.push(new AMapInstance.Polyline({ path: segment, strokeColor: "#10b981", strokeWeight: 5, lineCap: 'round', strokeOpacity: 0.6, zIndex: 40 }));
        map.add(polylines.recommended);
      }
      if (data.draft_coords?.length > 0) {
        polylines.draft = new AMapInstance.Polyline({ path: data.draft_coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#1f2937", strokeWeight: 6, zIndex: 45 });
        map.add(polylines.draft);
      }
      if (data.run_coords?.length > 0) {
        polylines.run = new AMapInstance.Polyline({ path: data.run_coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#ef4444", strokeWeight: 5, strokeStyle: 'dashed', zIndex: 50 });
        map.add(polylines.run);
      }
      drawMarkers();
      resetMapView();
    }

    function drawOnMap() {
      drawOnMap_signature();
      setTimeout(() => {
        
        logMessage_Info("æ‰§è¡ŒäºŒæ¬¡æ¸²æŸ“ä»¥ä¿®æ­£åˆå§‹ä½ç§»...", 'DEBUG');
        drawOnMap_signature();
        
      }, 100); 
    }

    function drawMarkers() {
      if (!map) return;
      map.remove(markers); markers = [];
      const data = currentRunData; if (!data?.target_points?.length) return;
      const sequence = data.target_sequence || (data.status == 1 ? data.target_points.length + 1 : 0);
      const names = (data.target_point_names || "").split('|');
      data.target_points.forEach((p, i) => {
        let bgColor = 'bg-emerald-600', textColor = 'text-white', zIndex = 100, pulseClass = '';
        if (i + 1 < sequence) { bgColor = 'bg-slate-400'; } else if (i + 1 === sequence) { bgColor = 'bg-sky-600'; zIndex = 110; pulseClass = 'pulsing-marker'; }
        const pointName = names[i] || `ç‚¹ ${i + 1}`;
        const markerContent = `<div class="relative flex flex-col items-center pointer-events-none"><div class="${pulseClass} text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg ${bgColor} ${textColor}">${pointName}</div><div class="w-0 h-0 border-x-4 border-x-transparent border-t-4 ${bgColor.replace('bg-', 'border-t-')}"></div></div>`;
        const marker = new AMapInstance.Marker({ position: new AMapInstance.LngLat(p[0], p[1]), content: markerContent, anchor: 'bottom-center', zIndex: zIndex });
        markers.push(marker);
      });
      map.add(markers);
    }

    
    let draftPath = [], draftPathLngLat = [], pendingPoints = [], isUpdating = false, lastMouseMoveTime = 0;
    const MOUSE_MOVE_THROTTLE_MS = 70;
    const MIN_DRAW_DISTANCE_M = 12;

    function fastDistanceMeters(lon1, lat1, lon2, lat2) { return Math.sqrt(Math.pow((lon1 - lon2) * 102834.74, 2) + Math.pow((lat1 - lat2) * 111712.69, 2)); }

    function scheduleUpdate() {
      if (isUpdating) return; isUpdating = true;
      requestAnimationFrame(() => {
        if (pendingPoints.length > 0) {
          const batch = pendingPoints.splice(0, pendingPoints.length);
          batch.forEach(pt => {
            const lngLat = new AMapInstance.LngLat(pt.lng, pt.lat);
            draftPath.push(pt);
            draftPathLngLat.push(lngLat);
            if (draftPathLngLat.length > 1) { const prev = draftPathLngLat[draftPathLngLat.length - 2]; draftTotalDist += fastDistanceMeters(prev.lng, prev.lat, pt.lng, pt.lat); }
            checkTargetReachedOnDraw(lngLat, pt.isKey === 1);
          });
          if (!polylines.draft) { polylines.draft = new AMapInstance.Polyline({ path: draftPathLngLat, strokeColor: "#1f2937", strokeWeight: 6, zIndex: 45 }); map.add(polylines.draft); }
          else { polylines.draft.setPath(draftPathLngLat); }
          updateDrawingInfo(draftPathLngLat[draftPathLngLat.length - 1]);
          updateDashboard();
        }
        isUpdating = false;
        if (pendingPoints.length > 0) scheduleUpdate();
      });
    }

    function onMapMouseDown(e) { if (e.originEvent.button !== 0) return; leftMouseDown = true; if (isDrawing) { isPathDrawing = true; pendingPoints.push({ lng: e.lnglat.lng, lat: e.lnglat.lat, isKey: 0 }); scheduleUpdate(); } }
    function onMapMouseMove(e) {
      const now = performance.now(); if (now - lastMouseMoveTime < MOUSE_MOVE_THROTTLE_MS) return; lastMouseMoveTime = now;
      if (isDrawing && isPathDrawing && leftMouseDown) {
        const lastPos = draftPath[draftPath.length - 1];
        if (!lastPos || fastDistanceMeters(lastPos.lng, lastPos.lat, e.lnglat.lng, e.lnglat.lat) > MIN_DRAW_DISTANCE_M) { pendingPoints.push({ lng: e.lnglat.lng, lat: e.lnglat.lat, isKey: 0 }); scheduleUpdate(); }
        else { updateDrawingInfo(e.lnglat); }
      }
    }
    function onMapMouseUp(e) { leftMouseDown = false; if (isDrawing && isPathDrawing) { isPathDrawing = false; scheduleUpdate(); } if (pendingUnlockMap) { map.setStatus({ dragEnable: true }); pendingUnlockMap = false; } }
    function checkTargetReachedOnDraw(currentLngLat, isForcedKeyPoint = false) {
      if (!currentRunData?.target_points || currentRunData.target_points.length === 0) return;
      let seq = currentRunData.target_sequence || 1;
      if (seq > currentRunData.target_points.length) return;
      const [tarLon, tarLat] = currentRunData.target_points[seq - 1];
      const dist = fastDistanceMeters(currentLngLat.lng, currentLngLat.lat, tarLon, tarLat);
      const range = currentRunData.target_range_m || 0.0;
      if (dist <= range && !currentRunData.isInTargetZone) {
        currentRunData.isInTargetZone = true;
        const targetName = (currentRunData.target_point_names || "").split('|')[seq - 1] || `æ‰“å¡ç‚¹${seq}`;
        logMessage_Info(`åˆ°è¾¾æ‰“å¡ç‚¹ ${seq}: ${targetName}`);
        if (isForcedKeyPoint) { pendingPoints.push({ lng: tarLon, lat: tarLat, isKey: 1 }); scheduleUpdate(); }
        if (seq < currentRunData.target_points.length) {
          currentRunData.target_sequence = seq + 1;
          updateDashboard();
          drawMarkers();
        } else {
          logMessage_Info("å·²åˆ°è¾¾æ‰€æœ‰æ‰“å¡ç‚¹ï¼");
          if (isDrawing) {
            toggleRecordMode(true);
          }
        }
      } else if (dist > range && currentRunData.isInTargetZone) {
        currentRunData.isInTargetZone = false;
      }
    }
    function updateDrawingInfo(lnglat) {
      if (!isDrawing) { if (drawingInfoMarker) drawingInfoMarker.hide(); return; }
      const avgSpeed = pythonParams.speed_mps || 1.5; const estTime = avgSpeed > 0 ? draftTotalDist / avgSpeed : 0;
      const timeStr = `${Math.floor(estTime / 60).toString().padStart(2, '0')}:${Math.floor(estTime % 60).toString().padStart(2, '0')}`;
      if (!drawingInfoMarker) { drawingInfoMarker = new AMapInstance.Text({ anchor: 'bottom-left', offset: new AMapInstance.Pixel(10, -10), style: { 'background-color': 'rgba(255, 255, 255, 0.9)', 'border': '1px solid #94a3b8', 'padding': '4px 8px', 'border-radius': '10px', 'font-size': '12px', 'color': '#1e293b' } }); map.add(drawingInfoMarker); }
      drawingInfoMarker.setText(`è·ç¦»: ${draftTotalDist.toFixed(0)} m | é¢„ä¼°: ~${timeStr}`);
      drawingInfoMarker.setPosition(lnglat);
      drawingInfoMarker.show();
    }

    let pendingUnlockMap = false;

    async function toggleRecordMode() {
      const btn = $('record-button'); isDrawing = !isDrawing;
      if (isDrawing) {
        if (selectedTaskIndex === -1) { showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡ï¼"); isDrawing = false; return; }
        btn.innerHTML = 'ç»“æŸç»˜åˆ¶'; btn.classList.remove('btn-success'); btn.classList.add('btn-danger');
        $('map-container').classList.add('drawing');
        clearCurrentPath(false);
        currentRunData.target_sequence = 1; currentRunData.isInTargetZone = false; draftTotalDist = 0;
        updateDashboard(); drawMarkers(); map.setStatus({ dragEnable: false }); resetMapView();
        logMessage_Info("è¿›å…¥å½•åˆ¶æ¨¡å¼ã€‚è¯·åœ¨åœ°å›¾ä¸ŠæŒ‰ä¸‹å·¦é”®å¹¶æ‹–åŠ¨æ¥ç»˜åˆ¶è·¯å¾„ã€‚");
      } else {
        btn.innerHTML = 'å½•åˆ¶è·¯å¾„'; btn.classList.remove('btn-danger'); btn.classList.add('btn-success');
        $('map-container').classList.remove('drawing');
        pendingUnlockMap = true; isPathDrawing = false; if (drawingInfoMarker) drawingInfoMarker.hide();

        
        
        if (draftTotalDist > 50000) {
          showModalAlert('è·¯å¾„è¿‡é•¿ï¼ˆ>' + (draftTotalDist / 1000).toFixed(2) + 'km > 50kmï¼‰ï¼Œè¯·é‡æ–°å½•åˆ¶');
          discardBlackDraftPolyline(); 
          logMessage_Warn(`è·¯å¾„å½•åˆ¶å¤±è´¥ï¼šè·ç¦»${(draftTotalDist / 1000).toFixed(2)}kmè¶…è¿‡50kmé™åˆ¶`);
          currentRunData.target_sequence = 0; draftTotalDist = 0;
          updateDashboard(); drawMarkers(); resetMapView();
          return; 
        }
        

        
        const totalTargets = (currentRunData.target_points?.length || 0);
        
        
        
        
        const inLastZone = totalTargets > 0 && currentRunData.target_sequence >= totalTargets && currentRunData.isInTargetZone === true;
        if (inLastZone) {
          
          
          
          if (draftPath.length > 0) {
            await callPythonAPI('set_draft_path', draftPath);
            await processCurrentPath();
          }
        }
        else {
          
          discardBlackDraftPolyline();
          logMessage_Info("æœªè¾¾åˆ°æœ€åæ‰“å¡ç‚¹ï¼Œå·²èˆå¼ƒè·¯å¾„ã€‚");
        }
        currentRunData.target_sequence = 0; draftTotalDist = 0;
        updateDashboard(); drawMarkers(); resetMapView();
      }
    }
    async function clearCurrentPath(confirm = true) {
      if (confirm) {

        const userConfirmed = await jsShowConfirm('ç¡®è®¤æ“ä½œ', 'ç¡®è®¤æ¸…é™¤å½“å‰ä»»åŠ¡å·²ç”Ÿæˆçš„è·¯å¾„å—ï¼Ÿ');
        if (!userConfirmed) return;
      }
      await callPythonAPI('clear_current_task_draft')
      if (polylines.draft) { map.remove(polylines.draft); polylines.draft = null; }
      if (polylines.history) { map.remove(polylines.history); polylines.history = null; }
      if (polylines.run) { map.remove(polylines.run); polylines.run = null; }
      if (drawingInfoMarker) drawingInfoMarker.hide();
      draftPath = []; draftPathLngLat = []; draftTotalDist = 0;
      if (currentRunData) { currentRunData.draft_coords = []; currentRunData.run_coords = []; currentRunData.total_run_distance_m = 0; currentRunData.total_run_time_s = 0; }
      if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) { currentTasks[selectedTaskIndex].draft_coords = []; currentTasks[selectedTaskIndex].run_coords = []; }
      updateDashboard(); renderTaskList();
    }
    async function discardBlackDraftPolyline() {
      try {
        if (polylines.draft) { map.remove(polylines.draft); polylines.draft = null; }
        draftPath = []; draftPathLngLat = []; pendingPoints = []; isUpdating = false; isPathDrawing = false; leftMouseDown = false; draftTotalDist = 0;
        if (drawingInfoMarker) drawingInfoMarker.hide();
        await callPythonAPI('set_draft_path', []);
        if (selectedTaskIndex !== -1 && currentTasks[selectedTaskIndex]) { currentTasks[selectedTaskIndex].draft_coords = []; renderTaskList(); }
        if (currentRunData) currentRunData.draft_coords = [];
      } catch (e) { logMessage_Error("discardBlackDraftPolyline() error:", e); }
    }
    
    async function processCurrentPath() {
      
      
      if (draftPath && draftPath.length > 0) {
        logMessage_Info("æ­£åœ¨ä¿å­˜è‰ç¨¿è·¯å¾„...");
        await callPythonAPI('set_draft_path', draftPath);
      }

      
      
      
      
      
      const result = await callPythonAPI('process_path');

      if (result.success) {
        
        currentRunData.run_coords = result.run_coords;  
        currentRunData.total_run_distance_m = result.total_dist;  
        currentRunData.total_run_time_s = result.total_time;  

        
        drawOnMap();  
        updateDashboard();  
        renderTaskList();  
        discardBlackDraftPolyline();  

        
        
        singleProcessedPoints = 0;  
        singleTotalPoints = (currentRunData.run_coords?.length || 0);  
        updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');  

      } else {
        
        showModalAlert(result.message);
      }
    }
    
    async function toggleRun() {
      const btn = $('start-run-button');
      runAccumulatedMs = 0;  

      if (btn.textContent === 'å¼€å§‹æ‰§è¡Œ') {
        

        
        
        const autoGen = $('auto-gen-all-check').checked;

        
        if (selectedTaskIndex < 0) {
          showModalAlert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡');
          return;
        }

        
        if (currentRunData) {
          currentRunData.target_sequence = 1;  
          currentRunData.isInTargetZone = false;  
          updateDashboard();  
          drawMarkers();  
        }

        
        
        
        
        const result = await callPythonAPI_raw('/api/background_task/start', 'POST', {
          task_indices: [selectedTaskIndex],
          auto_generate: autoGen  
        });

        if (result.success) {
          
          btn.textContent = 'åœæ­¢';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-danger');

          
          updateSingleProgress(0, '0 / 0 ç‚¹');


          
          setTimeout(() => startBackgroundTaskPolling(), 500);
        } else {
          showModalAlert(result.message);
        }
      } else {
        
        await callPythonAPI_raw('/api/background_task/stop', 'POST', {});
        btn.textContent = 'å¼€å§‹æ‰§è¡Œ';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
        stopBackgroundTaskPolling();
      }
    }

    
    async function toggleAllRuns() {
      const btn = $('start-all-button');
      runAccumulatedMs = 0;  

      if (btn.textContent === 'æ‰§è¡Œæ‰€æœ‰') {
        

        
        const ignoreCompleted = $('run-completed-check').checked;  
        const autoGen = $('auto-gen-all-check').checked;  

        
        const taskIndices = [];
        for (let i = 0; i < currentTasks.length; i++) {
          const task = currentTasks[i];

          
          if (task.status == 1 && !ignoreCompleted) continue;

          
          
          const infoText = task.info_text || "";



          if (infoText === 'å·²è¿‡æœŸ') {
            continue; 
          }
          if (infoText.startsWith('å¼€å§‹äº')) {
            continue; 
          }

          
          taskIndices.push(i);
        }

        
        if (taskIndices.length === 0) {
          showModalAlert('æ²¡æœ‰å¯æ‰§è¡Œçš„ä»»åŠ¡');
          return;
        }

        
        if (currentRunData) {
          currentRunData.target_sequence = 1;  
          currentRunData.isInTargetZone = false;  
          updateDashboard();  
          drawMarkers();  
        }

        
        
        
        
        
        
        
        
        
        const result = await callPythonAPI_raw('/api/background_task/start', 'POST', {
          task_indices: taskIndices,
          auto_generate: autoGen  
        });

        if (result.success) {
          
          btn.textContent = 'å…¨éƒ¨åœæ­¢';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-danger');

          
          updateSingleProgress(0, `0 / ${taskIndices.length} ä»»åŠ¡`);

          
          setTimeout(() => startBackgroundTaskPolling(), 500);
        } else {
          showModalAlert(result.message);
        }
      } else {
        
        await callPythonAPI_raw('/api/background_task/stop', 'POST', {});
        btn.textContent = 'æ‰§è¡Œæ‰€æœ‰';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-secondary');
        stopBackgroundTaskPolling();
      }
    }

    
    let backgroundTaskPollInterval = null;
    let backgroundTaskStartTime = 0; 

    function startBackgroundTaskPolling() {
      if (backgroundTaskPollInterval) {
        clearInterval(backgroundTaskPollInterval);
      }

      
      backgroundTaskStartTime = Date.now();

      
      pollBackgroundTaskStatus();

      
      backgroundTaskPollInterval = setInterval(pollBackgroundTaskStatus, 3000);
    }

    function stopBackgroundTaskPolling() {
      if (backgroundTaskPollInterval) {
        clearInterval(backgroundTaskPollInterval);
        backgroundTaskPollInterval = null;
      }

      backgroundTaskStartTime = 0;
    }

    async function pollBackgroundTaskStatus() {
      try {
        const result = await callPythonAPI_raw('/api/background_task/status', 'GET', null);

        if (result.success && result.task_status) {
          const status = result.task_status;

          
          
          
          if (status.run_coords && status.run_coords.length > 0) {
            
            if (!currentRunData || !currentRunData.run_coords || currentRunData.run_coords.length === 0) {
              logMessage_Info("æ£€æµ‹åˆ°åç«¯å·²è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ï¼Œæ­£åœ¨æ›´æ–°å‰ç«¯åœ°å›¾...");

              
              currentRunData.run_coords = status.run_coords || [];
              currentRunData.target_points = status.target_points || [];
              currentRunData.target_point_names = status.target_point_names || '';
              currentRunData.recommended_coords = status.recommended_coords || [];

              
              currentRunData.total_run_time_s = status.estimated_total_time_s || 0;
              currentRunData.total_run_distance_m = status.estimated_total_distance_m || 0;

              
              drawOnMap();

              
              updateDashboard();
            }
          }
          

          
          const completedTasks = status.completed_tasks || 0;
          const totalTasks = status.total_tasks || 0;
          const progressPercent = status.progress_percent || 0;
          const currentTaskProgress = status.current_task_progress || 0;

          
          let pct = 0;
          let displayText = '';

          
          if (status.singleTotalPoints !== undefined && status.singleProcessedPoints !== undefined) {
            singleTotalPoints = status.singleTotalPoints;
            singleProcessedPoints = status.singleProcessedPoints;
            pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
            displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
          } else if (currentRunData && Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
            
            singleTotalPoints = currentRunData.run_coords.length;

            if (status.current_position) {
              
              const currentPointIndex = status.current_position.point_index || 0;
              singleProcessedPoints = Math.min(currentPointIndex, singleTotalPoints);
            } else {
              
              singleProcessedPoints = Math.floor((currentTaskProgress / 100) * singleTotalPoints);
            }

            pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
            displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
          } else {
            
            singleTotalPoints = 0;
            singleProcessedPoints = 0;
            pct = 0;
            displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
          }

          updateSingleProgress(pct, displayText);

          
          if (status.task_indices && status.current_task_index !== undefined) {
            const task_list = status.task_indices;
            const current_list_index = status.current_task_index;
            if (task_list.length > current_list_index) {
              const global_task_index = task_list[current_list_index];

              if (global_task_index !== selectedTaskIndex || (currentRunData && currentRunData.task_index !== global_task_index)) {
                logMessage_Info(`[Polling] æ£€æµ‹åˆ°ä»»åŠ¡åˆ‡æ¢: ${selectedTaskIndex} -> ${global_task_index}`);
                selectedTaskIndex = global_task_index;

                
                renderTaskList();

                
                
                await forceLoadTaskDataForPolling(global_task_index);
              }

            }
          }

          
          if (status.elapsed_time_s !== undefined) {
            runAccumulatedMs = status.elapsed_time_s * 1000;  
          }
          if (status.current_distance_m !== undefined && currentRunData) {
            currentRunData.distance_covered_m = status.current_distance_m;
          }
          if (status.checked_targets_count !== undefined && currentRunData) {
            currentRunData.target_sequence = status.checked_targets_count;
          }

          
          updateDashboard();

          drawMarkers();

          
          
          if (status.current_position) {
            const pos = status.current_position;
            updateRunnerPosition(
              pos.lon,
              pos.lat,
              pos.distance || 0,
              pos.target_sequence || 0,
              0, 
              false 
            );
          }

          
          const taskStartTime = (status.start_time || 0) * 1000; 
          const isOldTask = backgroundTaskStartTime > 0 && taskStartTime < backgroundTaskStartTime - 2000; 

          
          if (status.status === 'completed') {
            if (!isOldTask) {
              logMessage_Info('åå°ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼');
              showModalAlert('åå°ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼');
            }
            stopBackgroundTaskPolling();

            
            $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
            $('start-run-button').classList.remove('btn-danger');
            $('start-run-button').classList.add('btn-primary');
            $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
            $('start-all-button').classList.remove('btn-danger');
            $('start-all-button').classList.add('btn-secondary');

            
            
            updateMobileTaskUI('å·²å®Œæˆ', 'æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ');

            
            if (!isOldTask) {
              refreshTasks();
            }
          } else if (status.status === 'error') {
            const errorMsg = status.error || 'æœªçŸ¥é”™è¯¯';
            logMessage_Error('åå°ä»»åŠ¡æ‰§è¡Œå‡ºé”™: ' + errorMsg);
            if (!isOldTask) {
              showModalAlert('åå°ä»»åŠ¡æ‰§è¡Œå‡ºé”™: ' + errorMsg);
            }
            stopBackgroundTaskPolling();

            
            $('start-run-button').textContent = 'å¼€å§‹æ‰§è¡Œ';
            $('start-run-button').classList.remove('btn-danger');
            $('start-run-button').classList.add('btn-primary');
            $('start-all-button').textContent = 'æ‰§è¡Œæ‰€æœ‰';
            $('start-all-button').classList.remove('btn-danger');
            $('start-all-button').classList.add('btn-secondary');

            
            
            updateMobileTaskUI('é”™è¯¯', errorMsg || 'ä»»åŠ¡æ‰§è¡Œå‡ºé”™');
          }
        }
      } catch (e) {
        
        logMessage_Debug('è½®è¯¢åå°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
      }
    }

    
    async function checkBackgroundTaskOnLoad() {
      try {
        const result = await callPythonAPI_raw('/api/background_task/status', 'GET', null);

        if (result.success && result.task_status) {
          const status = result.task_status;

          
          if (status.status === 'running') {
            logMessage_Info('æ£€æµ‹åˆ°åå°ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œå·²æ¢å¤çŠ¶æ€æ˜¾ç¤º');

            
            const totalTasks = status.total_tasks || 0;
            if (totalTasks === 1) {
              
              $('start-run-button').textContent = 'åœæ­¢';
              $('start-run-button').classList.remove('btn-primary');
              $('start-run-button').classList.add('btn-danger');
            } else if (totalTasks > 1) {
              
              $('start-all-button').textContent = 'å…¨éƒ¨åœæ­¢';
              $('start-all-button').classList.remove('btn-secondary');
              $('start-all-button').classList.add('btn-danger');
            }

            
            const task_list = status.task_indices || [];
            const current_list_index = status.current_task_index || 0;

            if (task_list.length > current_list_index) {
              const global_task_index = task_list[current_list_index];

              
              logMessage_Info(`æ­£åœ¨æ¢å¤è¿è¡Œä¸­çš„ä»»åŠ¡ (ç´¢å¼•: ${global_task_index}) çš„åœ°å›¾æ•°æ®...`);

              if (status.run_coords && status.run_coords.length > 0) {
                
                currentRunData = {
                  run_coords: status.run_coords || [],
                  target_points: status.target_points || [],
                  target_point_names: status.target_point_names || '',
                  recommended_coords: status.recommended_coords || [],
                  target_sequence: status.checked_targets_count || 0,
                  distance_covered_m: status.current_distance_m || 0,
                  total_run_time_s: status.estimated_total_time_s || 0,
                  total_run_distance_m: status.estimated_total_distance_m || 0
                };

                selectedTaskIndex = global_task_index;

                
                const taskListDiv = $('task-list');
                Array.from(taskListDiv.children).forEach((child, idx) => {
                  if (idx === global_task_index) {
                    child.classList.add('selected');
                  } else {
                    child.classList.remove('selected');
                  }
                });
                loadHistory(global_task_index);

                
                updateDashboard();
                drawOnMap();

                logMessage_Info(`ä»»åŠ¡æ•°æ®å·²ä»APIå“åº”æ¢å¤ï¼Œæ€»ç‚¹æ•°: ${currentRunData.run_coords.length}`, 'INFO');
              } else {
                
                await selectTask(global_task_index);
              }
            } else {
              logMessage_Warning("åå°ä»»åŠ¡çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ— æ³•æ¢å¤åœ°å›¾è·¯å¾„ã€‚");
            }
            

            
            const completedTasks = status.completed_tasks || 0;
            const progressPercent = status.progress_percent || 0;
            const currentTaskProgress = status.current_task_progress || 0;

            
            let pct = 0;
            let displayText = '';

            
            if (status.singleTotalPoints !== undefined && status.singleProcessedPoints !== undefined) {
              singleTotalPoints = status.singleTotalPoints;
              singleProcessedPoints = status.singleProcessedPoints;
              pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
            } else if (currentRunData && Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
              
              singleTotalPoints = currentRunData.run_coords.length;

              if (status.current_position) {
                
                const currentPointIndex = status.current_position.point_index || 0;
                singleProcessedPoints = Math.min(currentPointIndex, singleTotalPoints);
              } else {
                
                singleProcessedPoints = Math.floor((currentTaskProgress / 100) * singleTotalPoints);
              }

              pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
            } else {
              
              singleTotalPoints = 0;
              singleProcessedPoints = 0;
              pct = 0;
              displayText = `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`;
            }

            updateSingleProgress(pct, displayText);

            
            if (status.elapsed_time_s !== undefined) {
              runAccumulatedMs = status.elapsed_time_s * 1000;  
            }
            if (status.current_distance_m !== undefined && currentRunData) {
              currentRunData.distance_covered_m = status.current_distance_m;
            }
            if (status.checked_targets_count !== undefined && currentRunData) {
              currentRunData.target_sequence = status.checked_targets_count;
            }

            
            updateDashboard();

            
            if (status.current_position) {
              const pos = status.current_position;
              
              updateRunnerPosition(
                pos.lon,
                pos.lat,
                pos.distance || 0,
                pos.target_sequence || 0,
                0,
                true 
              );
            }

            startBackgroundTaskPolling();
            return true;
          }


        }
      } catch (e) {
        
        logMessage_Debug('æ£€æŸ¥åå°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
        return false;
      }
    }

    function ensureRunnerMarker() {
      if (runnerMarker) return;
      const content = '<div class="w-5 h-5 rounded-full border-2 border-white shadow-lg" style="background:linear-gradient(135deg,var(--base-color-300),var(--base-color-600));"></div>';
      runnerMarker = new AMapInstance.Marker({ position: map.getCenter(), content, anchor: 'center', zIndex: 200 });
      map.add(runnerMarker);
    }
    function updateRunnerPosition(lon, lat, distance, targetSequence, duration, centerNow = false) {
      ensureRunnerMarker();
      const pos = new AMapInstance.LngLat(lon, lat);
      runnerMarker.setPosition(pos);
      if (map && centerNow) map.setCenter(pos);
      runAccumulatedMs += (duration || 0);
      currentRunData.distance_covered_m = distance || 0;
      $('current-location-label').textContent = `å½“å‰ä½ç½®GPSåæ ‡: ${(+lon).toFixed(4)}, ${(+lat).toFixed(4)}`;

      
      const mobileCurrentLocationLabel = document.getElementById('mobile-current-location-label');
      if (mobileCurrentLocationLabel) {
        mobileCurrentLocationLabel.textContent = `å½“å‰ä½ç½®: ${(+lon).toFixed(4)}, ${(+lat).toFixed(4)}`;
      }

      
      
      const jsTargetSequence = targetSequence + 1;

      
      if (currentRunData.target_sequence !== jsTargetSequence) {
        currentRunData.target_sequence = jsTargetSequence;
        drawMarkers();
      }
      updateDashboard();
      
      if (Array.isArray(currentRunData.run_coords) && currentRunData.run_coords.length > 0) {
        
        singleTotalPoints = currentRunData.run_coords.length;
        singleProcessedPoints = Math.min(singleProcessedPoints + 1, singleTotalPoints);
        const pct = Math.floor((singleProcessedPoints * 100) / Math.max(1, singleTotalPoints));
        updateSingleProgress(pct, `${singleProcessedPoints} / ${singleTotalPoints} ç‚¹`);
      }

    }
    function onTaskCompleted(taskIndex) { if (currentTasks[taskIndex]) { currentTasks[taskIndex].status = 1; renderTaskList(); } }

    
    function onRunStopped() {
      logMessage_Info("åå°ä»»åŠ¡å·²åœæ­¢ï¼ˆæ¥è‡ªæœåŠ¡å™¨æ¨é€ï¼‰ã€‚");

      
      stopBackgroundTaskPolling();

      
      const startBtn = $('start-run-button');
      if (startBtn) {
        startBtn.textContent = 'å¼€å§‹æ‰§è¡Œ';
        startBtn.classList.remove('btn-danger');
        startBtn.classList.add('btn-primary');
        startBtn.disabled = false; 
      }

      
      const startAllBtn = $('start-all-button');
      if (startAllBtn) {
        startAllBtn.textContent = 'æ‰§è¡Œæ‰€æœ‰';
        startAllBtn.classList.remove('btn-danger');
        startAllBtn.classList.add('btn-secondary');
        startAllBtn.disabled = false; 
      }
    }

    async function exportTask() {
      if (selectedTaskIndex === -1) {
        showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„ä»»åŠ¡ï¼");
        return;
      }
      const result = await callPythonAPI('export_task_data');
      if (result && result.success && result.data) {
        
        const jsonStr = JSON.stringify(result.data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename || 'task_export.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage_Info('å¯¼å‡ºæˆåŠŸ');
      } else if (result && !result.success) {
        showModalAlert(`å¯¼å‡ºå¤±è´¥: ${result.message}`);
      }
    }

    async function importTask() {
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const result = await callPythonAPI('import_task_data', text);

          if (result.success) {
            IS_OFFLINE = true;
            currentSessionUA = "NULL";
            const uaLabel = $('ua-label');
            if (uaLabel) uaLabel.textContent = 'NULL';
            const uaBtn = $('random-ua-btn');
            if (uaBtn) uaBtn.disabled = true;
            if (result.userInfo) {
              currentUserData = result.userInfo;
              const name = currentUserData.name || 'ç¦»çº¿è°ƒè¯•';
              const sid = currentUserData.student_id || 'NULL';
              $('user-name-label').textContent = `å§“å: ${name}`;
              $('user-id-label').textContent = `å­¦å·: ${sid}`;
            }
            showMainApp();

            
            
            
            const adminBtn = $('show-admin-panel');
            if (adminBtn) {
              
              adminBtn.classList.remove('hidden');
              logMessage_Info('[ç¦»çº¿å¯¼å…¥] ç®¡ç†é¢æ¿æŒ‰é’®å·²æ˜¾ç¤º');
            }

            await mapReadyPromise;
            currentTasks = result.tasks;
            renderTaskList();
            selectTask(0);
            requestAnimationFrame(() => drawOnMap());
            logMessage_Info('å¯¼å…¥æˆåŠŸ');
          } else {
            showModalAlert(result.message || 'å¯¼å…¥å¤±è´¥');
          }
        } catch (error) {
          showModalAlert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
        }
      };
      input.click();
    }





    
    async function getWalkingPath(waypoints) {
      if (!AMapInstance || waypoints.length < 2) throw new Error("åœ°å›¾å®ä¾‹æœªåŠ è½½æˆ–è·¯å¾„ç‚¹å°‘äº2");
      const useFallback = pythonParams.api_fallback_line ?? false, maxRetries = pythonParams.api_retries ?? 2, retryDelayMs = (pythonParams.api_retry_delay_s ?? 0.5) * 1000;
      callPythonAPI('js_log', 'INFO', `å¼€å§‹è·¯å¾„è§„åˆ’: é‡è¯•=${maxRetries}æ¬¡, å»¶è¿Ÿ=${retryDelayMs}ms, å¤‡ç”¨ç›´çº¿=${useFallback}`);
      const all_path = [];
      const areCoordsEqual = (c1, c2) => Math.abs(c1.lng - c2.lng) < 1e-6 && Math.abs(c1.lat - c2.lat) < 1e-6;
      const searchSegment = (start, end) => new Promise((resolve) => {
        callPythonAPI('js_log', 'DEBUG', `AMap APIè¯·æ±‚ --> æ­¥è¡Œè·¯å¾„: ${start.toString()} è‡³ ${end.toString()}`);
        new AMap.Walking({ map: null, panel: "", hideMarkers: true }).search(start, end, (status, result) => {
          if (status === 'complete' && result.routes?.length > 0) {
            const p = []; result.routes[0].steps.forEach(s => s.path.forEach(pt => p.push({ lng: pt.lng, lat: pt.lat })));
            callPythonAPI('js_log', 'DEBUG', `AMap APIå“åº” <-- æˆåŠŸï¼Œç‚¹æ•°: ${p.length}`); resolve(p);
          } else { let info = result ? (result.info || JSON.stringify(result)) : 'NULL'; callPythonAPI('js_log', 'ERROR', `AMap APIå“åº” <-- å¤±è´¥. çŠ¶æ€: ${status}, ç»“æœ: ${info}`); resolve([]); }
        });
      });
      
      for (let i = 0; i < waypoints.length - 1; i++) {
        logMessage_Info(`æ­£åœ¨è§„åˆ’ç¬¬ ${i + 1}/${waypoints.length - 1} æ®µè·¯å¾„...`);
        const realStart = waypoints[i], realEnd = waypoints[i + 1]; let attempts = 0, segmentPath = [];
        while (attempts <= maxRetries) {
          if (attempts > 0) { logMessage_Info(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’å¤±è´¥ï¼Œ${retryDelayMs / 1000}ç§’åé‡è¯•...`); await new Promise(res => setTimeout(res, retryDelayMs)); }
          segmentPath = await searchSegment(realStart, realEnd); if (segmentPath.length > 0) break; attempts++;
        }
        if (segmentPath.length === 0) {
          if (useFallback) { logMessage_Info(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’æœ€ç»ˆå¤±è´¥ï¼Œå¯ç”¨ç›´çº¿è¿æ¥ã€‚`); segmentPath = [{ lng: realStart.lng, lat: realStart.lat }, { lng: realEnd.lng, lat: realEnd.lat }]; }
          else throw new Error(`ç¬¬ ${i + 1} æ®µè·¯å¾„è§„åˆ’å¤±è´¥ (é‡è¯• ${maxRetries} æ¬¡å)`);
        }
        if (!areCoordsEqual(segmentPath[0], { lng: realStart.lng, lat: realStart.lat })) segmentPath.unshift({ lng: realStart.lng, lat: realStart.lat });
        if (!areCoordsEqual(segmentPath[segmentPath.length - 1], { lng: realEnd.lng, lat: realEnd.lat })) segmentPath.push({ lng: realEnd.lng, lat: realEnd.lat });
        all_path.push(...(i > 0 ? segmentPath.slice(1) : segmentPath));
      }
      return all_path;
    }

    
    async function onConfirmAutoGenerate() {
      const minTime = parseInt($('min-time-input').value), maxTime = parseInt($('max-time-input').value), minDist = parseInt($('min-dist-input').value);
      if (minTime > maxTime) { showModalAlert("æœ€çŸ­æ—¶é—´ä¸èƒ½å¤§äºæœ€é•¿æ—¶é—´"); return; }
      
      
      $('auto-gen-modal').classList.add('hidden');
      $('auto-gen-modal').classList.remove('flex'); 
      document.body.classList.remove('modal-visible'); 

      if (selectedTaskIndex === -1 || !currentRunData.target_points || currentRunData.target_points.length === 0) { showModalAlert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰æ‰“å¡ç‚¹çš„ä»»åŠ¡"); return; }
      logMessage_Info("æ­£åœ¨è°ƒç”¨é«˜å¾·åœ°å›¾APIè¿›è¡Œè·¯å¾„è§„åˆ’...");
      try {
        const waypoints = currentRunData.target_points.map(p => new AMapInstance.LngLat(p[0], p[1]));
        const apiPath = await getWalkingPath(waypoints);
        logMessage_Info(`è·¯å¾„è§„åˆ’æˆåŠŸï¼Œå…± ${apiPath.length} ä¸ªåæ ‡ç‚¹ã€‚æ­£åœ¨ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®...`);
        const result = await callPythonAPI('auto_generate_path_with_api', apiPath, minTime, maxTime, minDist);
        if (result.success) {
          currentRunData.run_coords = result.run_coords;
          currentRunData.total_run_distance_m = result.total_dist;
          currentRunData.total_run_time_s = result.total_time;
          drawOnMap(); updateDashboard(); renderTaskList();

          
          singleProcessedPoints = 0;
          singleTotalPoints = (currentRunData.run_coords?.length || 0);
          updateSingleProgress(0, '0 / ' + singleTotalPoints + ' ç‚¹');

        } else {
          logMessage_Info(`ç”Ÿæˆå¤±è´¥: ${result.message}`);
          showModalAlert(`ç”Ÿæˆå¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        logMessage_Info(`è·¯å¾„è§„åˆ’æˆ–ç”Ÿæˆå¤±è´¥: ${error}`);
        showModalAlert(`è·¯å¾„è§„åˆ’æˆ–ç”Ÿæˆå¤±è´¥: ${error}`);
      }
    }
    async function loadHistory(index) {

      $('history-placeholder').textContent = "æ­£åœ¨åŠ è½½..."; $('history-list').innerHTML = "";
      const result = await callPythonAPI('get_task_history', index);
      if (result.success && result.history.length > 0) {
        $('history-placeholder').classList.add('hidden');
        result.history.forEach(rec => {
          const item = document.createElement('div');
          item.className = 'grid grid-cols-3 gap-2 text-xs p-2 border-b border-slate-100 cursor-pointer hover:bg-white/70 rounded';
          item.innerHTML = `<span class="text-slate-600">${rec.time}</span><span class="font-semibold text-emerald-700">${rec.len}</span><span class="font-semibold text-sky-700">${rec.used_time}</span>`;
          item.addEventListener('click', () => showHistoricalTrack(rec.trid)); $('history-list').appendChild(item);
        });
      } else { $('history-placeholder').textContent = "æ— å†å²è®°å½•æˆ–åŠ è½½å¤±è´¥"; $('history-placeholder').classList.remove('hidden'); }
    }

    async function showHistoricalTrack(trid) {
      if (backgroundTaskPollInterval) {
        logMessage_Warning("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•æŸ¥çœ‹å†å²è®°å½•ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        showModalAlert("ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œæ— æ³•æŸ¥çœ‹å†å²è®°å½•ï¼è¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡ã€‚");
        return;
      }
      const result = await callPythonAPI('get_historical_track', trid);
      if (result.success) {
        logMessage_Info(`[å†å²è½¨è¿¹] APIè¿”å›æ•°æ® - coordsé•¿åº¦: ${result.coords?.length || 0}, target_pointsé•¿åº¦: ${result.target_points?.length || 0}`);

        
        if (isMobileMode) {
          const modal = $('mobile-track-modal');
          if (modal) {
            
            $('mobile-track-modal').classList.add('show');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';  

            
            await initMobileTrackMap();

            
            clearMobileTrackMap();

            
            const path = result.coords.map(p => new AMapInstance.LngLat(p[0], p[1]));

            if (path.length > 0) {
              
              mobileTrackPolyline = new AMapInstance.Polyline({
                path: path,
                strokeColor: '#8b5cf6', 
                strokeWeight: 5,
                strokeOpacity: 0.8,
                zIndex: 55,
                map: mobileTrackMapInstance
              });

              
              const startMarker = new AMapInstance.Marker({
                position: path[0],
                content: '<div style="width:12px;height:12px;background:#10b981;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                anchor: 'center',
                map: mobileTrackMapInstance
              });
              mobileTrackMarkers.push(startMarker);

              
              const endMarker = new AMapInstance.Marker({
                position: path[path.length - 1],
                content: '<div style="width:12px;height:12px;background:#ef4444;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                anchor: 'center',
                map: mobileTrackMapInstance
              });
              mobileTrackMarkers.push(endMarker);

              
              
              let totalDist = 0;
              if (AMapInstance.GeometryUtil) {
                totalDist = AMapInstance.GeometryUtil.distanceOfLine(path);
              }

              
              const distance = result.distance || (totalDist / 1000);
              const duration = result.duration || result.used_time || '--:--';
              const checkpoints = result.checkpoints || result.target_points?.length || 0;

              
              const distEl = $('mobile-track-distance');
              const durEl = $('mobile-track-duration');
              const paceEl = $('mobile-track-pace');

              if (distEl) {
                distEl.textContent = `${typeof distance === 'number' ? distance.toFixed(2) : distance} km`;
              }
              if (durEl) {
                durEl.textContent = duration;
              }
              if (paceEl && typeof distance === 'number' && duration !== '--:--') {
                
                
                const durationMatch = duration.match(/(\d+):(\d+)/);
                if (durationMatch) {
                  const totalMinutes = parseInt(durationMatch[1]) + parseInt(durationMatch[2]) / 60;
                  const pace = distance > 0 ? totalMinutes / distance : 0;
                  const paceMin = Math.floor(pace);
                  const paceSec = Math.round((pace - paceMin) * 60);
                  paceEl.textContent = `${paceMin}:${paceSec.toString().padStart(2, '0')}/km`;
                } else {
                  paceEl.textContent = '--:--';
                }
              }

              logMessage_Info(`[å†å²è½¨è¿¹] æ‘˜è¦ä¿¡æ¯å·²æ›´æ–° - è·ç¦»: ${distance} km, æ—¶é•¿: ${duration}, æ‰“å¡ç‚¹: ${checkpoints}`);

              
              logMessage_Info(`[å†å²è½¨è¿¹] æ£€æŸ¥æ‰“å¡ç‚¹æ•°æ® - target_pointså­˜åœ¨: ${!!result.target_points}, é•¿åº¦: ${result.target_points?.length || 0}`);
              if (result.target_points && result.target_points.length > 0) {
                const targetNames = result.target_point_names ? result.target_point_names.split('|') : [];
                result.target_points.forEach((point, index) => {
                  const pointName = targetNames[index] || `ç‚¹ ${index + 1}`;
                  const checkpointMarker = new AMapInstance.Marker({
                    position: new AMapInstance.LngLat(point[0], point[1]),
                    content: `<div class="flex flex-col items-center">
                      <div class="text-xs font-bold whitespace-nowrap px-2 py-1 rounded-full shadow-lg bg-emerald-600 text-white">
                        ${pointName}
                      </div>
                      <div class="w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-emerald-600"></div>
                    </div>`,
                    anchor: 'bottom-center',
                    zIndex: 100,
                    map: mobileTrackMapInstance
                  });
                  mobileTrackMarkers.push(checkpointMarker);
                });
                logMessage_Info(`[å†å²è½¨è¿¹] å·²ç»˜åˆ¶ ${result.target_points.length} ä¸ªæ‰“å¡ç‚¹`);
              }

              
              mobileTrackMapInstance.setFitView();
            }
          }
          return;
        }

        
        if (polylines.history) map.remove(polylines.history);
        polylines.history = new AMapInstance.Polyline({ path: result.coords.map(p => new AMapInstance.LngLat(p[0], p[1])), strokeColor: "#8b5cf6", strokeWeight: 6, strokeOpacity: 0.8, zIndex: 55 });
        map.add(polylines.history); map.setFitView([polylines.history]);

      } else showModalAlert("æ— æ³•åŠ è½½å†å²è½¨è¿¹");
    }

    


    
    function updateSingleProgress(pct, text, extra) {
      const fill = $('single-progress-fill');
      const label = $('single-progress-text');
      const extraEl = $('single-progress-extra');
      if (fill) fill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
      if (label) label.textContent = `è¿›åº¦ Â· ${pct}%`;
      if (extraEl) extraEl.textContent = extra || text || '';

      
      const mobileFill = document.getElementById('mobile-single-progress-fill');
      const mobileLabel = document.getElementById('mobile-single-progress-text');
      const mobileExtraEl = document.getElementById('mobile-single-progress-extra');
      if (mobileFill) mobileFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
      if (mobileLabel) mobileLabel.textContent = `è¿›åº¦ Â· ${pct}%`;
      if (mobileExtraEl) mobileExtraEl.textContent = extra || text || '';
    }


    
    function getCallerInfo(linesToSkip = null) {
      try {
        const err = new Error();
        const stack = err.stack;
        if (!stack) return { source: 'unknown (no stack)' };

        
        const lines = stack.split('\n');

        let callerLine; 

        if (linesToSkip !== null) {
          try {
            callerLine = lines[linesToSkip + 1] || ''; 
          } catch (error) {
            logMessage_Error("Error accessing stack line:", error);
            callerLine = lines[4] || lines[3] || lines[2] || lines[1] || ''; 
          }
        } else {

          
          callerLine = lines[4] || lines[3] || lines[2] || lines[1] || ''; 
        }

        
        if (typeof callerLine !== 'string') {
          callerLine = ''; 
        }

        callerLine = callerLine.trim();

        
        let match = callerLine.match(/at\s+(?:(.+)\s+\()?(?:.+\/)?([^:]+:\d+:\d+)\)?/);
        if (match) {
          const functionName = match[1] || 'anonymous';
          const fileInfo = match[2] || '';
          
          return { source: `${functionName} (${fileInfo})`, functionName: functionName, fileInfo: fileInfo };
        }

        
        match = callerLine.match(/^(?:([^@]+)@)?(?:.+\/)?([^:]+:\d+:\d+)$/);
        if (match) {
          const functionName = match[1] || 'anonymous';
          const fileInfo = match[2] || '';
          
          return { source: `${functionName}@${fileInfo}`, functionName: functionName, fileInfo: fileInfo };
        }

        
        return { source: callerLine || 'unknown (parse failed)' };

      } catch (e) {
        
        return { source: 'unknown (error parsing stack)' };
      }
    }


    
    function extractCleanSource(sourceString) {
      if (typeof sourceString !== 'string') {
        return 'unknown';
      }

      let result = '';
      const marker = '(uuid=';
      let markerIndex = sourceString.indexOf(marker);

      
      if (markerIndex === -1) {
        return sourceString.trim();
      }

      
      let relevantPart = sourceString.substring(0, markerIndex);

      
      result = relevantPart.trimEnd();

      
      return result || 'æœªçŸ¥';
    }

    
    
    
    (function () {
      
      const originalConsole = {
        log: console.log.bind(console),
        info: console.info.bind(console),
        warn: console.warn.bind(console),
        error: console.error.bind(console),
        debug: console.debug.bind(console)
      };

      
      let isIntercepting = false;

      
      function interceptConsole(level, args, originalFn) {
        
        originalFn.apply(console, args);

        
        if (isIntercepting) return;

        try {
          isIntercepting = true;

          
          const message = args.map(arg => {
            if (typeof arg === 'string') return arg;
            if (arg instanceof Error) return `${arg.name}: ${arg.message}\n${arg.stack}`;
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }).join(' ');

          
          if (message.includes('[å‰ç«¯æ—¥å¿—]')) {
            return;
          }

          
          if (!isInNetworkErrorState && sessionUUID) {
            const now = new Date();
            const timestamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            fetch('/api/log_frontend', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID || null
              },
              credentials: 'include',
              body: JSON.stringify({
                level: level.toUpperCase(),
                message: message,
                timestamp: timestamp,
                source: 'ç¬¬ä¸‰æ–¹JS'
              })
            }).catch(() => {
              
            });
          }
        } finally {
          isIntercepting = false;
        }
      }

      
      console.log = function (...args) {
        interceptConsole('info', args, originalConsole.log);
      };

      console.info = function (...args) {
        interceptConsole('info', args, originalConsole.info);
      };

      console.warn = function (...args) {
        interceptConsole('warning', args, originalConsole.warn);
      };

      console.error = function (...args) {
        interceptConsole('error', args, originalConsole.error);
      };

      console.debug = function (...args) {
        interceptConsole('debug', args, originalConsole.debug);
      };

      
      console._original = originalConsole;
    })();

    
    
    function logMessage(msg, level = 'INFO', source = null) {
      
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      const timestamp = `[${h}:${m}:${s}]`;
      const timestamp2 = `${h}:${m}:${s}`;
      const line = typeof msg === 'string' ? msg : JSON.stringify(msg);


      let level_new = 'INFO';

      
      
      let callerInfo;
      if (source) {
        callerInfo = source; 
      } else {
        
        let orange_callerInfo = getCallerInfo();
        callerInfo = extractCleanSource(orange_callerInfo.source);
      }

      let new_message = `${timestamp}[å‰ç«¯æ—¥å¿—][${callerInfo}] ${line}`
      const fullMessage = `${timestamp}[${callerInfo}] ${line}`; 

      if (level === 'DEBUG') {
        level_new = 'DEBUG';
        
        if (console._original) {
          console._original.debug(new_message);
        } else {
          console.debug(new_message);
        }
      } else if (level === 'INFO') {
        level_new = 'INFO';
        if (console._original) {
          console._original.info(new_message);
        } else {
          console.info(new_message);
        }
      } else if (level === 'ERROR') {
        level_new = 'ERROR';
        if (console._original) {
          console._original.error(new_message);
        } else {
          console.error(new_message);
        }
      } else if (level === 'WARNING') {
        level_new = 'WARNING';
        if (console._original) {
          console._original.warn(new_message);
        } else {
          console.warn(new_message);
        }
      } else if (level === 'CRITICAL') {
        level_new = 'CRITICAL';
        if (console._original) {
          console._original.error(new_message);
        } else {
          console.error(new_message);
        }
      } else {
        if (console._original) {
          console._original.log(new_message);
        } else {
          console.log(new_message);
        }
      }



      
      if (!isInNetworkErrorState && source !== 'Backend') {
        try {
          fetch('/api/log_frontend', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Session-ID': sessionUUID || null
            },
            credentials: 'include',
            body: JSON.stringify({
              level: level_new,
              message: line,
              timestamp: timestamp2,
              source: callerInfo
            })
          }).catch(err => {
            
            console.error('[æ—¥å¿—å‘é€å¤±è´¥]', err);
          });
        } catch (e) {
          console.error('[æ—¥å¿—å‘é€å¼‚å¸¸]', e);
        }
      }

      
      const isCoreLog = (message, logLevel) => {
        
        if (logLevel === 'ERROR' || logLevel === 'WARNING' || logLevel === 'CRITICAL') {
          return true;
        }

        
        const coreKeywords = [
          
          'è·¯å¾„è§„åˆ’', 'è·¯å¾„ç”Ÿæˆ', 'è‡ªåŠ¨ç”Ÿæˆ', 'å¤„ç†è·¯å¾„', 'æ¸…é™¤è·¯å¾„', 'å½•åˆ¶è·¯å¾„', 'å¯¼å‡ºè·¯å¾„',
          
          'å¼€å§‹æ‰§è¡Œ', 'æ‰§è¡Œå®Œæˆ', 'æ‰§è¡Œæ‰€æœ‰', 'åœæ­¢æ‰§è¡Œ', 'ä»»åŠ¡å®Œæˆ', 'ä»»åŠ¡å¤±è´¥',
          
          'æäº¤æˆåŠŸ', 'æäº¤å¤±è´¥', 'ä¸Šä¼ æˆåŠŸ', 'ä¸Šä¼ å¤±è´¥', 'æ•°æ®æäº¤',
          
          'ç™»å½•æˆåŠŸ', 'ç™»å½•å¤±è´¥', 'ç™»å‡º',
          
          'è¿›å…¥å¤šè´¦å·æ¨¡å¼', 'é€€å‡ºå¤šè´¦å·æ¨¡å¼', 'è´¦å·åˆ—è¡¨',
          
          'ç­¾åˆ°æˆåŠŸ', 'ç­¾åˆ°å¤±è´¥', 'è¡¥ç­¾',
          
          'åŠ è½½ä»»åŠ¡', 'åˆ·æ–°ä»»åŠ¡', 'é€‰æ‹©ä»»åŠ¡',
          
          '[JS-Queue]'
        ];

        
        return coreKeywords.some(keyword => message.includes(keyword));
      };

      
      
      const shouldShowInUI = isCoreLog(line, level);

      if (shouldShowInUI) {
        
        const single = $('log-text');
        if (single) {
          single.value += fullMessage + '\n'; 
          single.scrollTop = single.scrollHeight;
        }

        
        const multi = $('multi-log-text');
        if (multi) {
          multi.value += fullMessage + '\n'; 
          multi.scrollTop = multi.scrollHeight;
        }

        
        
        
        
        
        const mobileLog = document.getElementById('mobile-log-text');
        if (mobileLog) {
          mobileLog.value += fullMessage + '\n';
          mobileLog.scrollTop = mobileLog.scrollHeight; 
        }
      }
    }

    function logMessage_Debug(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'DEBUG');
    }

    function logMessage_Info(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'INFO');
    }

    function logMessage_Warning(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'WARNING');
    }

    function logMessage_Error(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'ERROR');
    }

    function logMessage_Critical(...args) {
      const msg = args.join(' ');
      logMessage(msg, 'CRITICAL');
    }

    function showTab(tabName, element) {
      
      
      if (tabName !== 'attendance' && notificationAutoRefreshTimer) {
        clearTimeout(notificationAutoRefreshTimer);
        notificationAutoRefreshTimer = null;
        logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] å·²åœæ­¢ï¼ˆåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾ï¼‰');
      }
      

      ['run-control', 'path-tools', 'history', 'params', 'log', 'checkpoints', 'attendance'].forEach(name => {
        $(`${name}-tab`).classList.add('hidden');
        const b = document.querySelector(`button[onclick="showTab('${name}', this)"]`);
        if (b) b.classList.remove('active');
      });
      $(`${tabName}-tab`).classList.remove('hidden');
      if (element) element.classList.add('active');
      if (tabName === 'attendance') {
        
        
        
        logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] åˆ‡æ¢åˆ°ç­¾åˆ°æ ‡ç­¾ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
        refreshNotificationsUI(true, false); 
      }
    }



    function autoLogin(user, pass) {
      if (!user || !pass) return;
      const userCombo = $('user-combo');
      userCombo.addEventListener('focus', refreshUserList);
      userCombo.addEventListener('click', refreshUserList);
      if ([...userCombo.options].some(o => o.value === user)) userCombo.value = user;
      else { const opt = document.createElement('option'); opt.value = opt.textContent = user; userCombo.appendChild(opt); userCombo.value = user; }
      $('username-entry').value = user; $('password-entry').value = pass;
      onUserChange().then(() => $('login-button').click());
    }


    function createParamInputs(container, prefix, changeHandler, excludeGroups = []) {
      container.innerHTML = '';

      
      let finalExclude = [...excludeGroups];
      if (prefix !== 'multi-param') {
        finalExclude.push("è‡ªåŠ¨ç­¾åˆ°");
      }

      paramGroups.forEach((group, index) => {
        
        if (finalExclude.includes(group.title)) {
          return;
        }
        
        if (excludeGroups.includes(group.title)) {
          return;
        }

        const header = document.createElement('h3');
        const marginTopClass = index === 0 ? '' : 'mt-4';
        header.className = `text-base font-bold text-sky-700 ${marginTopClass} mb-2 border-b border-slate-200 pb-1`;
        header.textContent = group.title;
        container.appendChild(header);

        for (const key of group.keys) {
          const def = paramDefs[key];
          if (!def) continue;

          const div = document.createElement('div');
          div.className = 'text-sm mb-3';

          const step = (key.endsWith('_s') || key.endsWith('_mps')) ? '0.1' : '1';
          const unitHtml = def.unit ? `<span class="ml-2 text-xs text-slate-500 select-none">${def.unit}</span>` : '';

          
          if (def.type === 'theme_selector') {
            div.innerHTML = `
          <label class="block text-slate-700 font-semibold">${def.label}</label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
          <div class="grid grid-cols-3 gap-2 mt-2">
              <button onclick="setThemeStyle('default')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">é»˜è®¤</button>
              <button onclick="setThemeStyle('theme-anime')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">äºŒæ¬¡å…ƒ</button>
              <button onclick="setThemeStyle('theme-minimalist')" class="btn btn-ghost !rounded-lg !py-1.5 border-2 border-transparent">ç®€çº¦</button>
          </div>
        `;
          } else if (def.type === 'color_picker') {
            div.innerHTML = `
          <label for="${prefix}-${key}" class="block text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center gap-3 mt-1">
            <input type="color" id="${prefix}-${key}-picker" data-key="${key}" class="w-10 h-10 rounded-full cursor-pointer border-2 border-white shadow-md" title="ç‚¹å‡»é€‰æ‹©é¢œè‰²">
            <input type="text" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" placeholder="#7dd3fc" title="${def.help}">
            <button onclick="resetBaseColorToDefault('${prefix}')" class="btn btn-ghost !py-1 !px-3 !text-xs flex-shrink-0">æ¢å¤é»˜è®¤</button>
          </div>
           <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
          } else if (def.type === 'checkbox' || key === 'api_fallback_line' || key === 'ignore_task_time') {
            div.innerHTML = `
          <label class="flex items-center gap-2 cursor-pointer" title="${def.help}">
            <input type="checkbox" id="${prefix}-${key}" data-key="${key}" class="w-5 h-5 accent-sky-600 rounded cursor-pointer flex-shrink-0">
            <span class="text-slate-700 font-semibold">${def.label}</span>
          </label>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
          } else {
            div.innerHTML = `
          <label for="${prefix}-${key}" class="block mb-1 text-slate-700 font-semibold">${def.label}</label>
          <div class="flex items-center">
            <input type="number" step="${step}" id="${prefix}-${key}" data-key="${key}" class="input-field !py-1 w-full" title="${def.help}">
            ${unitHtml}
          </div>
          <p class="mt-1 text-xs text-slate-500">${def.help}</p>
        `;
          }

          container.appendChild(div);

          
          const inputs = div.querySelectorAll('input');
          inputs.forEach(input => {
            if (input.type === 'color') {
              
              input.addEventListener('input', (e) => {
                const hexColor = e.target.value;
                const textInput = document.getElementById(`${prefix}-${key}`);
                if (textInput) textInput.value = hexColor;
                setBaseColor(hexColor, hexColor); 
              });
              
              input.addEventListener('change', changeHandler);
            } else if (input.type === 'text' && key === 'theme_base_color') {
              
              input.addEventListener('change', (e) => {
                const hexColor = e.target.value;
                const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
                if (colorPicker) colorPicker.value = hexColor;
                setBaseColor(hexColor, hexColor);
                changeHandler(e); 
              });
            } else {
              input.addEventListener('change', changeHandler);
            }
          });
        }
      });
    }


    function updateParamInputs(container, prefix, params) {
      for (const key of Object.keys(paramDefs)) {
        const input = document.getElementById(`${prefix}-${key}`);
        if (!input || !params) continue;
        if (!(key in params)) continue;
        if (input.type === 'checkbox') {
          input.checked = Boolean(params[key]);
        } else {
          input.value = params[key];
          
          if (key === 'theme_base_color') {
            const colorPicker = document.getElementById(`${prefix}-${key}-picker`);
            if (colorPicker) {
              colorPicker.value = params[key];
            }
          }
        }
      }
    }



    function onParamChange(event) {
      const key = event.target.dataset.key;
      let value;
      if (event.target.type === 'checkbox') value = event.target.checked;
      else value = event.target.value;
      pythonParams[key] = value;
      callPythonAPI('update_param', key, value);

      
      if (key === 'ignore_task_time') {
        logMessage_Info("å‚æ•° 'ignore_task_time' å·²æ›´æ”¹ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...");
        refreshTasks();
      }
    }

    function onGlobalParamChange(event) {
      const key = event.target.dataset.key;
      let value = event.target.type === 'checkbox' ? event.target.checked : event.target.value;
      pythonParams[key] = value;
      callPythonAPI('update_param', key, value);

      
      if (key === 'ignore_task_time') {
        updateAllAccountsStatusText();
      }
    }
    async function openAccountParamsModal(username) {
      const result = await callPythonAPI('multi_get_account_params', username);
      if (!result.success) { showModalAlert(result.message); return; }

      $('account-params-title').textContent = `[${username}] å‚æ•°è®¾ç½®`;
      const container = $('account-params-container');
      
      createParamInputs(container, 'acc-param', () => { }, ['ä¸»é¢˜ä¸å¤–è§‚']);
      updateParamInputs(container, 'acc-param', result.params);

      $('save-account-params-btn').onclick = async () => {
        const inputs = container.querySelectorAll('input');
        for (const input of inputs) {
          const key = input.dataset.key;
          const value = input.type === 'checkbox' ? input.checked : input.value;
          await callPythonAPI('multi_update_account_param', username, key, value);
        }
        
        const modal = $('account-params-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-visible');
      };

      
      const modal = $('account-params-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');             
      document.body.classList.add('modal-visible');  
    }



    function toggleUserDetails(show) {
      const modal = $('user-details-modal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);
      const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;
      if (show) {
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        document.body.classList.add('modal-visible');
      } else {
        
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
        document.body.classList.remove('modal-visible');
      }
    }


    function toggleTaskDetails(show) {
      const modal = $('task-details-modal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);

      const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;

      if (show) {
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        
        document.body.classList.add('modal-visible');
      } else {
        
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
        
        document.body.classList.remove('modal-visible');
      }
    }

    function showUserDetails() {
      if (!currentUserData || !currentUserData.student_id) { showModalAlert('è¯·å…ˆæˆåŠŸç™»å½•'); return; }
      const info = currentUserData;
      const content = $('user-details-content'); content.innerHTML = '';
      const kv = { 'å§“å': info.name, 'å­¦å·': info.student_id, 'ç”¨æˆ·å': info.username, 'æ€§åˆ«': info.gender, 'å­¦æ ¡': info.school_name, 'å±æ€§': info.attribute_type, 'æ‰‹æœºå·': info.phone, 'ç”¨æˆ·ID': info.id, 'èº«ä»½è¯å·': info.id_card, 'æ³¨å†Œæ—¶é—´': info.registration_time, 'é¦–æ¬¡ç™»å½•': info.first_login_time, 'ä¸Šæ¬¡ç™»å½•': info.last_login_time, 'å½“å‰ç™»å½•': info.current_login_time };
      Object.entries(kv).forEach(([k, v]) => { const p = document.createElement('p'); p.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">${k}:</span><span class="break-all">${v || 'NULL'}</span>`; content.appendChild(p); });

      
      const uaText = IS_OFFLINE ? 'NULL' : (currentSessionUA || 'NULL');
      const p_ua = document.createElement('p');
      
      p_ua.innerHTML = `<span class="font-bold w-24 inline-block text-left pr-2 text-slate-500">UA:</span><span class="break-all">${uaText}</span>`;
      content.appendChild(p_ua);


      toggleUserDetails(true);
    }

    function showTaskDetails() {
      if (!currentRunData || !currentRunData.run_name) { showModalAlert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡'); return; }
      const content = $('task-details-content'); content.innerHTML = '';
      const kv = { 'ä»»åŠ¡åç§°': currentRunData.run_name, 'ä»»åŠ¡çŠ¶æ€': currentRunData.status == 1 ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ', 'ä»»åŠ¡ID': currentRunData.errand_id, 'è®¡åˆ’ID': currentRunData.errand_schedule, 'å¼€å§‹æ—¶é—´': currentRunData.start_time, 'ç»“æŸæ—¶é—´': currentRunData.end_time, 'ä¸Šä¼ æ—¶é—´': currentRunData.upload_time };
      Object.entries(kv).forEach(([k, v]) => { const p = document.createElement('p'); p.innerHTML = `<span class="font-bold w-28 inline-block text-left pr-2 text-slate-500">${k}:</span><span>${v || 'NULL'}</span>`; content.appendChild(p); });
      const tpTitle = document.createElement('p'); tpTitle.className = 'font-bold text-slate-500 mt-2'; tpTitle.textContent = 'æ‰“å¡ç‚¹åˆ—è¡¨:'; content.appendChild(tpTitle);
      (currentRunData.target_points || []).forEach((p, i) => {
        const name = (currentRunData.target_point_names || "").split('|')[i] || `æ‰“å¡ç‚¹${i + 1}`;
        const div = document.createElement('div'); div.className = 'flex items-center gap-2 text-slate-600 ml-4';
        const numSpan = document.createElement('span'); numSpan.className = 'font-mono w-6 inline-block'; numSpan.textContent = `${i + 1}.`;
        const nameSpan = document.createElement('span'); nameSpan.textContent = name;
        const coordsSpan = document.createElement('span'); coordsSpan.className = 'text-xs text-slate-400'; coordsSpan.textContent = `(${p[0].toFixed(5)}, ${p[1].toFixed(5)})`;
        div.append(numSpan, nameSpan, coordsSpan);
        content.appendChild(div);
      });
      toggleTaskDetails(true);
    }


    function toggleNotifications(show, forceDisableMap = false) {
      const modal = $('notifications-modal');
      modal.classList.toggle('hidden', !show);
      modal.classList.toggle('flex', show);

      const mapToToggle = !$('multi-account-app').classList.contains('hidden') ? multiAccountMap : map;

      if (show) {
        
        if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        document.body.classList.add('modal-visible');
      } else {
        
        if (forceDisableMap) {
          
          if (mapToToggle) mapToToggle.setStatus({ dragEnable: false, scrollWheel: false, doubleClickZoom: false });
        } else {
          
          if (mapToToggle) mapToToggle.setStatus({ dragEnable: true, scrollWheel: true, doubleClickZoom: true });
        }
        document.body.classList.remove('modal-visible');
      }
    }

    
    async function fetchNotifications(limit = null, offset = 0) {
      
      
      if (IS_OFFLINE) {
        logMessage_Info('[é€šçŸ¥] ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•è·å–é€šçŸ¥');
        
        return {
          success: true,
          unreadCount: 0,
          notices: []
        };
      }

      logMessage_Debug("å¼€å§‹åˆ·æ–°é€šçŸ¥", { limit, offset });
      const badge = $('notification-badge');
      let result = null; 
      try {
        
        const params = {};
        if (limit !== null) {
          params.request_limit = limit;
          params.request_offset = offset;
        }

        result = await callPythonAPI('get_notifications', params); 

        
        if (result && result.success) {

          if (offset === 0) {
            
            window.currentNotifications = result.notices || [];
          } else {
            
            window.currentNotifications = (window.currentNotifications || []).concat(result.notices || []);
          }

          
          if (result.unreadCount > 0) {
            badge.textContent = result.unreadCount > 9 ? '9+' : result.unreadCount;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
          
          if (limit === null || offset === 0) {
            window.currentNotifications = result.notices || [];
          } else {
            
            window.currentNotifications = (window.currentNotifications || []).concat(result.notices || []);
          }
        } else {
          badge.classList.add('hidden');
        }
      } catch (e) {
        logMessage_Error("Fetch notifications failed", e);
        badge.classList.add('hidden');
      }
      return result; 
    }
    
    
    let notificationAutoRefreshTimer = null;

    
    async function refreshNotificationsUI(useCache = true, isManual = false) {
      
      if (isRefreshingNotifications) {
        logMessage_Info("Notification refresh already in progress. Skipping.");
        return; 
      }
      isRefreshingNotifications = true; 
      

      const content = $('notifications-content');
      const refreshBtn = $('refresh-notifications-btn');
      const markReadBtn = $('mark-all-read-btn');

      
      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
      }
      if (markReadBtn) markReadBtn.disabled = true;

      try {
        
        let cachedDisplayed = false;
        if (useCache && content) { 
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½ç¼“å­˜é€šçŸ¥...</p>';

          try {
            const cachedResult = await callPythonAPI('get_cached_notifications');
            if (cachedResult && cachedResult.success && cachedResult.cached && cachedResult.notices.length > 0) {
              logMessage_Info(`æ˜¾ç¤ºç¼“å­˜çš„ ${cachedResult.notices.length} æ¡é€šçŸ¥`);
              content.innerHTML = '';
              renderNotificationBatch(cachedResult.notices, content);
              cachedDisplayed = true;

              
              const badge = $('notification-badge');
              if (cachedResult.unreadCount > 0) {
                badge.textContent = cachedResult.unreadCount > 9 ? '9+' : cachedResult.unreadCount;
                badge.classList.remove('hidden');
              } else {
                badge.classList.add('hidden');
              }

              
              const hasUnread = cachedResult.notices.some(n => n.isRead == 0 || n.isRead === false);
              if (markReadBtn) markReadBtn.disabled = !hasUnread;

              
              const refreshingIndicator = document.createElement('div');
              refreshingIndicator.id = 'refreshing-indicator';
              refreshingIndicator.className = 'p-3 text-center text-slate-400 text-sm';
              refreshingIndicator.innerHTML = 'æ­£åœ¨åˆ·æ–°æœ€æ–°é€šçŸ¥...';
              if (content) content.appendChild(refreshingIndicator);
            }
          } catch (e) {
            logMessage_Warning("è·å–ç¼“å­˜é€šçŸ¥å¤±è´¥ï¼Œå°†ç›´æ¥åŠ è½½æœ€æ–°é€šçŸ¥", e);
          }
        }

        if (!cachedDisplayed && content) {
          content.innerHTML = '<p class="text-slate-400 text-center py-10">æ­£åœ¨åŠ è½½é€šçŸ¥...</p>';
        }

        
        
        let currentOffset = 0;
        const batchSize = cachedDisplayed ? 5000 : 5;  
        let hasMore = true;
        let firstLoad = true;
        let finalResult = null; 

        
        function startAutoRefreshTimer() {
          
          if (!isManual) {
            
            if (notificationAutoRefreshTimer) {
              clearTimeout(notificationAutoRefreshTimer);
              notificationAutoRefreshTimer = null;
            }

            
            const refreshIntervalInput = $('param-auto_attendance_refresh_s');
            const refreshInterval = refreshIntervalInput ? parseInt(refreshIntervalInput.value) : 300; 

            
            if (refreshInterval > 0) {
              
              logMessage_Info(`[è‡ªåŠ¨åˆ·æ–°] (åŠ è½½å®Œæˆ) å°†åœ¨ ${refreshInterval} ç§’åè‡ªåŠ¨åˆ·æ–°é€šçŸ¥`);
              notificationAutoRefreshTimer = setTimeout(() => {
                logMessage_Info('[è‡ªåŠ¨åˆ·æ–°] æ­£åœ¨è‡ªåŠ¨åˆ·æ–°é€šçŸ¥...');
                refreshNotificationsUI(true, false); 
              }, refreshInterval * 1000); 
            }
          }
        }
        

        
        const loadNextBatch = async () => {
          if (!hasMore) {
            
            
            
            if (finalResult) {
              onNotificationsUpdated(finalResult);
            }
            logMessage_Info("æ‰€æœ‰é€šçŸ¥åŠ è½½å®Œæˆï¼ˆæ¨¡æ€æ¡†ï¼‰");
            


            startAutoRefreshTimer(); 

            return;
          }

          logMessage_Info(`æ­£åœ¨åŠ è½½é€šçŸ¥ï¼šoffset=${currentOffset}, limit=${batchSize}`);
          const result = await fetchNotifications(batchSize, currentOffset);

          
          if (firstLoad) {
            finalResult = result;
          }


          if (!result || !result.success) {
            if (firstLoad && !cachedDisplayed) {
              content.innerHTML = '<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
            return;
          }

          const notices = result.notices || [];

          if (firstLoad && content) { 
            
            content.innerHTML = '';
            firstLoad = false;
            logMessage_Info(`é¦–æ‰¹æ–°é€šçŸ¥åŠ è½½å®Œæˆï¼Œ${cachedDisplayed ? 'å·²æ›¿æ¢' : 'æ­£åœ¨æ˜¾ç¤º'}ç¼“å­˜æ•°æ®`);
          }

          if (notices.length === 0 && currentOffset === 0 && content) { 
            content.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— é€šçŸ¥</p>';
            if (markReadBtn) markReadBtn.disabled = true;
            return;
          }

          
          const oldIndicator = $('loading-more-indicator');
          if (oldIndicator) {
            oldIndicator.remove();
          }

          
          if (notices.length > 0 && content) { 
            logMessage_Info(`ç¬¬${Math.floor(currentOffset / batchSize) + 1}æ‰¹åŠ è½½å®Œæˆï¼šæ˜¾ç¤º ${notices.length} æ¡é€šçŸ¥`);
            renderNotificationBatch(notices, content);

            
            const allNotices = window.currentNotifications || [];
            const hasUnread = allNotices.some(n => n.isRead == 0 || n.isRead === false);
            if (markReadBtn) markReadBtn.disabled = !hasUnread;
          }

          
          currentOffset += batchSize;
          hasMore = result.hasMore || false;

          
          if (hasMore && content) { 
            const loadingMore = document.createElement('div');
            loadingMore.id = 'loading-more-indicator';
            loadingMore.className = 'p-3 text-center text-slate-400 text-sm';
            loadingMore.innerHTML = 'æ­£åœ¨åŠ è½½æ›´å¤šé€šçŸ¥...';
            content.appendChild(loadingMore);

            
            setTimeout(loadNextBatch, 100);
          } else {
            
            if (finalResult) {
              onNotificationsUpdated(finalResult);
            }
            logMessage_Info("æ‰€æœ‰é€šçŸ¥åŠ è½½å®Œæˆï¼ˆæ¨¡æ€æ¡†ï¼‰");
            

            startAutoRefreshTimer(); 
          }

          
          
          
          
        };

        
        await loadNextBatch();


      } catch (e) {
        logMessage_Error("Failed to refresh notifications UI", e);
        content.innerHTML = '<p class="text-red-500 text-center py-10">åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
      } finally {
        
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'åˆ·æ–°';
        }
        isRefreshingNotifications = false;

        
        
        
        
        
        
        
        

        
        
        

        
        
        
        
        
        
        
        
        
        
      }
    }

    
    function renderNotificationBatch(notices, container) {
      if (!notices || notices.length === 0) return;

      for (const n of notices) {
        const item = document.createElement('div');
        item.className = 'p-3 border-b border-slate-200';
        item.id = `notice-${n.id}`;

        const isEffectivelyRead = (n.isRead == 1 || n.isRead === true);
        const isReadClass = isEffectivelyRead ? 'opacity-60' : 'font-bold';

        
        let readButtonHtml = '';
        if (!isEffectivelyRead) {
          readButtonHtml = `<button class="btn btn-ghost !py-0 !px-2 !text-xs text-sky-600" onclick="markAsRead(event, '${n.id}')">è®¾ä¸ºå·²è¯»</button>`;
        }

        
        let attendanceHtml = '';
        const isAttendanceTask = (n.image === 'attendance') || (n.title && n.title.includes('ç­¾åˆ°'));

        if (isAttendanceTask && n.id) {
          switch (n.attendance_code) {
            case -1:
              try {
                const coordsStr = (n.updateBy || "").trim();
                const [lat, lon] = coordsStr.split(',').map(Number);

                
                if (isNaN(lon) || isNaN(lat)) {
                  attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span> <span class="text-xs text-slate-400">(åæ ‡æ— æ•ˆ)</span>`;
                } else {
                  const targetCoords = `[${lon}, ${lat}]`;
                  attendanceHtml = `
                      <span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span>
                      <div class="relative inline-block group">
                        <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="è¡¥ç­¾æ­¤ä»»åŠ¡">
                          <span>è¡¥ç­¾</span>
                          <svg class="w-2.5 h-2.5 ml-1" xmlns="http:
                        </button>
                        <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                          <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">éšæœºè¡¥ç­¾</button>
                          <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾</button>
                        </div>
                      </div>
                    `;
                }
              } catch (e) {
                attendanceHtml = `<span class="text-xs font-semibold text-red-500 px-2 py-0.5 rounded-full bg-red-100">å·²è¿‡æœŸ</span> <span class="text-xs text-slate-400">(åæ ‡è§£æå¤±è´¥)</span>`;
              }
              break;
            case 1:
              attendanceHtml = `<span class="text-xs font-semibold text-emerald-600 px-2 py-0.5 rounded-full bg-emerald-100">å·²ç­¾åˆ°</span>`;
              break;
            case 0:
              try {
                const coordsStr = (n.updateBy || "").trim();
                const [lat, lon] = coordsStr.split(',').map(Number);

                if (!isNaN(lon) && !isNaN(lat)) {
                  const rollCallId = n.id;
                  const targetCoords = `[${lon}, ${lat}]`;

                  attendanceHtml = `
                    <div class="relative inline-block group">
                      <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                        <span>ç­¾åˆ°</span>
                        <svg class="w-2.5 h-2.5 ml-1" xmlns="http:
                      </button>
                      <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                        <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${rollCallId}', ${targetCoords})">éšæœºç­¾åˆ°</button>
                        <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${rollCallId}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹</button>
                      </div>
                    </div>
                    <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${rollCallId}', ${targetCoords})">
                      è¡¥ç­¾
                    </button>
                  `;
                } else {
                  attendanceHtml = `<span class="text-xs text-slate-400">åæ ‡æ— æ•ˆ</span>`;
                }
              } catch (e) {
                logMessage_Error("è§£æç­¾åˆ°åæ ‡å¤±è´¥:", e, n.updateBy);
                attendanceHtml = `<span class="text-xs text-red-500">æ•°æ®é”™è¯¯</span>`;
              }
              break;
            default:
              attendanceHtml = `<span class="text-xs text-slate-400">çŠ¶æ€æœªçŸ¥</span>`;
          }
        }

        
        item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-base text-slate-800 ${isReadClass}">${n.title}</span>
            <div class="flex items-center gap-2">
              ${readButtonHtml}
              ${attendanceHtml}
              <span class="text-xs text-slate-500 flex-shrink-0">${n.createtime}</span>
            </div>
          </div>
          <p class="text-sm text-slate-600 mt-1 ${isReadClass}">${n.content}</p>
        `;
        container.appendChild(item);
      }
    }

    
    function showNotifications() {
      
      
      if (IS_OFFLINE) {
        
        const content = $('notifications-content');
        if (content) {
          
          content.innerHTML = '<p class="text-slate-400 text-center py-10">ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•è·å–é€šçŸ¥</p>';
        }

        
        toggleNotifications(true);

        logMessage_Info('[é€šçŸ¥] ç¦»çº¿æ¨¡å¼ä¸‹æ— æ³•è·å–é€šçŸ¥ï¼Œå·²æ˜¾ç¤ºæç¤ºä¿¡æ¯');
        
        return;
      }

      
      toggleNotifications(true);

      
      
      
      
      refreshNotificationsUI(true, true);
    }

    
    function onNotificationsUpdated(result) {
      if (!result || !result.success) {
        logMessage_Info("[åå°åˆ·æ–°] è·å–é€šçŸ¥å¤±è´¥");
        return;
      }

      logMessage_Info(`[åå°åˆ·æ–°] æ”¶åˆ° ${result.unreadCount} æœªè¯», ${result.notices.length} æ€»æ•°`);

      
      const badge = $('notification-badge');
      if (result.unreadCount > 0) {
        badge.textContent = result.unreadCount > 9 ? '9+' : result.unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      
      

      
      const attList = $('attendance-list');
      if (attList) {
        attList.innerHTML = '';
        const attendanceNotices = (window.currentNotifications || []).filter(n =>
          n.image === 'attendance' || (n.title && n.title.includes('ç­¾åˆ°'))
        );

        if (attendanceNotices.length === 0) {
          attList.innerHTML = '<p class="text-slate-400 text-center py-10 text-xs">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>';
        } else {
          attendanceNotices.forEach(n => {
            const item = document.createElement('div');
            item.className = 'p-2 border-b border-slate-100';

            let statusText = 'æœªçŸ¥';
            let statusClass = 'text-slate-500';
            let buttonHtml = ''; 

            
            let targetCoords = 'null';
            let canSign = false;
            try {
              const coordsStr = (n.updateBy || "").trim();
              const [lat, lon] = coordsStr.split(',').map(Number);
              if (!isNaN(lon) && !isNaN(lat)) {
                targetCoords = `[${lon}, ${lat}]`;
                canSign = true;
              }
            } catch (e) { }

            
            switch (n.attendance_code) {
              case -1:
                statusText = 'å·²è¿‡æœŸ'; statusClass = 'text-red-600 font-semibold';
                
                if (canSign) {
                  buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-warning !py-0 !px-2 !text-xs inline-flex items-center" title="è¡¥ç­¾æ­¤ä»»åŠ¡">
                    <span>è¡¥ç­¾</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http:
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-32 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-warning !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">éšæœºè¡¥ç­¾</button>
                    <button class="btn btn-warning !bg-orange-400 hover:!bg-orange-500 !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualMakeupAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹è¡¥ç­¾</button>
                  </div>
                </div>
              `;
                }
                break;
              case 1:
                statusText = 'å·²ç­¾åˆ°'; statusClass = 'text-emerald-600 font-semibold';
                
                break;
              case 0:
                statusText = 'å¾…ç­¾åˆ°'; statusClass = 'text-sky-600 font-bold';
                
                if (canSign) {
                  
                  
                  buttonHtml = `
                <div class="relative inline-block group">
                  <button class="btn btn-secondary !py-0 !px-2 !text-xs inline-flex items-center">
                    <span>ç­¾åˆ°</span>
                    <svg class="w-2.5 h-2.5 ml-1" xmlns="http:
                  </button>
                  <div class="hidden group-hover:block absolute right-0 z-[1051] pt-1 w-28 bg-white/90 backdrop-blur-sm rounded-lg shadow-xl border border-slate-200 p-1 space-y-1">
                    <button class="btn btn-success !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleAttendance(event, '${n.id}', ${targetCoords})">éšæœºç­¾åˆ°</button>
                    <button class="btn btn-secondary !py-1 !px-3 !text-xs !w-full !justify-start" onclick="handleManualAttendance(event, '${n.id}', ${targetCoords})">æ‰‹åŠ¨é€‰ç‚¹</button>
                  </div>
                </div>
                <button class="btn btn-warning !py-0 !px-2 !text-xs" onclick="handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                  è¡¥ç­¾
                </button>
              `;
                }
                break;
              default:
                statusText = 'çŠ¶æ€æœªçŸ¥'; statusClass = 'text-slate-400';
            }

            
            if (n.attendance_status_text && n.attendance_status_text.includes('å¤±è´¥')) {
              statusText = n.attendance_status_text;
              statusClass = 'text-red-700 font-bold';
            }

            
            item.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-sm font-semibold text-slate-700">${n.title}</span>
            <span class="text-xs ${statusClass} flex-shrink-0">${statusText}</span>
          </div>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-slate-500">${n.content}</span>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-slate-400">${n.createtime}</span>
              ${buttonHtml}
            </div>
          </div>
        `;
            attList.appendChild(item);
          });
        }
      }

      
      const modal = $('notifications-modal');
      

      
      
      

      
      
      syncMobileAttendanceList();
    }

    
    async function handleAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      logMessage_Info(`æ­£åœ¨ä¸ºæ‚¨è‡ªåŠ¨ç­¾åˆ°... æ´»åŠ¨ID: ${rollCallId}`);
      
      const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'random', null, false);
      if (result.success) {
        logMessage_Info(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
        showModalAlert(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
      } else {
        logMessage_Info(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
        showModalAlert(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
      }
      
      await fetchNotifications();
      showNotifications();
    }

    const svgIconNormal = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http:
    <path fill="#22d3ee" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

    const svgIconMakeup = `<div style="pointer-events: none;">
  <svg width="28" height="36" viewBox="0 0 1024 1024" xmlns="http:
    <path fill="#f59e0b" d="M512 0C321.6 0 160 161.6 160 352c0 89.6 35.2 172.8 96 233.6l249.6 432c6.4 12.8 19.2 19.2 32 19.2s25.6-6.4 32-19.2l249.6-432c60.8-60.8 96-144 96-233.6C864 161.6 702.4 0 512 0z m0 512c-89.6 0-160-70.4-160-160s70.4-160 160-160 160 70.4 160 160-70.4 160-160 160z"></path>
  </svg>
</div>`;

    async function handleManualAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      
      toggleNotifications(false, true);

      
      selectedTaskIndex = -1;
      renderTaskList();
      drawOnMap();

      logMessage_Info("è¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰æ‹©ç­¾åˆ°ç‚¹...");

      
      if (tempAttendanceMarker && map) {
        map.remove(tempAttendanceMarker);
        tempAttendanceMarker = null;
      }
      if (tempAttendanceCircle && map) {
        map.remove(tempAttendanceCircle);
        tempAttendanceCircle = null;
      }

      
      const radius = (currentUserData && currentUserData.server_attendance_radius_m) ? currentUserData.server_attendance_radius_m : 0.0;
      const position = new AMapInstance.LngLat(targetCoords[0], targetCoords[1]);


      
      tempAttendanceMarker = new AMapInstance.Marker({
        position: position,
        content: svgIconNormal,
        clickable: false,
        anchor: 'bottom-center',
        zIndex: 200
      });

      
      tempAttendanceCircle = new AMapInstance.Circle({
        center: position,
        radius: radius,
        strokeColor: "#00BFFF",
        strokeOpacity: 1,
        strokeWeight: 2,
        fillColor: "#00BFFF",
        fillOpacity: 0.2,
        zIndex: 199,
        bubble: true,
        clickable: false
      });

      map.add(tempAttendanceMarker);
      map.add(tempAttendanceCircle);

      
      map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);

      
      const infoMarker = new AMapInstance.Text({
        text: 'å·²æ˜¾ç¤ºç­¾åˆ°åŒºåŸŸï¼Œè¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹',
        position: position,
        anchor: 'bottom-center',
        offset: new AMapInstance.Pixel(0, -40),
        clickable: false,
        style: {
          'background-color': '#fff',
          'padding': '5px 10px',
          'border-radius': '5px',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
          'pointer-events': 'none'
        }
      });
      map.add(infoMarker);

      
      const onMapClick = async (e) => {
        map.off('click', onMapClick);
        map.remove(infoMarker);

        const clickedLngLat = e.lnglat;
        const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];

        
        const distance = fastDistanceMeters(clickedLngLat.lng, clickedLngLat.lat, targetCoords[0], targetCoords[1]);

        if (distance > radius) {
          logMessage_Info(`é€‰ç‚¹å¤±è´¥ï¼šè·ç¦» ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`);
          showModalAlert('æ‚¨é€‰æ‹©çš„ç‚¹ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼Œè¯·é‡æ–°åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ã€‚', 'é€‰ç‚¹æ— æ•ˆ');

          
          map.add(infoMarker);
          map.on('click', onMapClick);
          return;
        }
        

        logMessage_Info(`å·²é€‰æ‹©ç­¾åˆ°ç‚¹: ${specificCoords.join(', ')} (è·ç¦» ${distance.toFixed(1)}m)`);

        try {
          const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'specific', specificCoords, false);
          if (result.success) {
            logMessage_Info(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
            showModalAlert(`ç­¾åˆ°æˆåŠŸ: ${result.message}`);
          } else {
            logMessage_Info(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
            showModalAlert(`ç­¾åˆ°å¤±è´¥: ${result.message}`);
          }
        } catch (err) {
          logMessage_Info(`ç­¾åˆ°æ—¶å‘ç”ŸJSé”™è¯¯: ${err}`);
        } finally {
          
          if (tempAttendanceMarker && map) {
            map.remove(tempAttendanceMarker);
            tempAttendanceMarker = null;
          }
          if (tempAttendanceCircle && map) {
            map.remove(tempAttendanceCircle);
            tempAttendanceCircle = null;
          }

          
          if (map) {
            map.setStatus({
              dragEnable: true,
              scrollWheel: true,
              doubleClickZoom: true
            });
          }

          await fetchNotifications();
        }
      };

      map.on('click', onMapClick);
    }


    async function handleMakeupAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      logMessage_Info(`æ­£åœ¨ä¸ºæ‚¨ [è¡¥ç­¾]... æ´»åŠ¨ID: ${rollCallId}`);

      
      
      const result = await callPythonAPI('trigger_attendance',
        rollCallId,
        targetCoords,
        'random',   
        null,       
        true        
      );

      if (result.success) {
        logMessage_Info(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
        showModalAlert(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
      } else {
        logMessage_Info(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
        showModalAlert(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
      }
      
      await fetchNotifications();
      
      
    }

    
    async function handleManualMakeupAttendance(event, rollCallId, targetCoords) {
      event.stopPropagation();
      
      toggleNotifications(false, true);

      
      selectedTaskIndex = -1;
      renderTaskList();
      drawOnMap();

      logMessage_Info("è¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰æ‹© [è¡¥ç­¾] ç‚¹...");

      
      if (tempAttendanceMarker && map) {
        map.remove(tempAttendanceMarker);
        tempAttendanceMarker = null;
      }
      if (tempAttendanceCircle && map) {
        map.remove(tempAttendanceCircle);
        tempAttendanceCircle = null;
      }

      
      const radius = (currentUserData && currentUserData.server_attendance_radius_m) ? currentUserData.server_attendance_radius_m : 0.0;
      const position = new AMapInstance.LngLat(targetCoords[0], targetCoords[1]);
      logMessage_Info(`ç³»ç»Ÿç­¾åˆ°ç‚¹: ${targetCoords[0]}, ${targetCoords[1]} (åŠå¾„: ${radius}ç±³)`);

      
      tempAttendanceMarker = new AMapInstance.Marker({
        position: position,
        content: svgIconMakeup, 
        clickable: false,
        anchor: 'bottom-center',
        zIndex: 200
      });

      
      tempAttendanceCircle = new AMapInstance.Circle({
        center: position,
        radius: radius,
        strokeColor: "#F7B731",
        strokeOpacity: 1,
        strokeWeight: 2,
        fillColor: "#F7B731",
        fillOpacity: 0.2,
        zIndex: 199,
        bubble: true,
        clickable: false
      });

      map.add(tempAttendanceMarker);
      map.add(tempAttendanceCircle);

      
      map.setFitView([tempAttendanceCircle], false, [120, 120, 120, 120]);

      
      const infoMarker = new AMapInstance.Text({
        text: 'å·²æ˜¾ç¤ºç­¾åˆ°åŒºåŸŸï¼Œè¯·åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ [è¡¥ç­¾]',
        position: position,
        anchor: 'bottom-center',
        offset: new AMapInstance.Pixel(0, -40),
        clickable: false,
        style: {
          'background-color': '#fff',
          'padding': '5px 10px',
          'border-radius': '5px',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
          'pointer-events': 'none'
        }
      });
      map.add(infoMarker);

      
      const onMapClick = async (e) => {
        map.off('click', onMapClick);
        map.remove(infoMarker);

        const clickedLngLat = e.lnglat;
        const specificCoords = [clickedLngLat.lng, clickedLngLat.lat];

        
        const distance = fastDistanceMeters(clickedLngLat.lng, clickedLngLat.lat, targetCoords[0], targetCoords[1]);

        if (distance > radius) {
          logMessage_Info(`[è¡¥ç­¾] é€‰ç‚¹å¤±è´¥ï¼šè·ç¦» ${distance.toFixed(1)}m > ${radius.toFixed(1)}m`);
          showModalAlert('æ‚¨é€‰æ‹©çš„ç‚¹ä¸åœ¨ç­¾åˆ°èŒƒå›´å†…ï¼Œè¯·é‡æ–°åœ¨åœ°å›¾ä¸Šå•å‡»é€‰ç‚¹ã€‚', 'é€‰ç‚¹æ— æ•ˆ');

          
          map.add(infoMarker);
          map.on('click', onMapClick);
          return;
        }
        

        logMessage_Info(`å·²é€‰æ‹© [è¡¥ç­¾] ç‚¹: ${specificCoords.join(', ')} (è·ç¦» ${distance.toFixed(1)}m)`);

        try {
          const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'specific', specificCoords, true);
          if (result.success) {
            logMessage_Info(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
            showModalAlert(`è¡¥ç­¾æˆåŠŸ: ${result.message}`);
          } else {
            logMessage_Info(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
            showModalAlert(`è¡¥ç­¾å¤±è´¥: ${result.message}`);
          }
        } catch (err) {
          logMessage_Info(`è¡¥ç­¾æ—¶å‘ç”ŸJSé”™è¯¯: ${err}`);
        } finally {
          
          if (tempAttendanceMarker && map) {
            map.remove(tempAttendanceMarker);
            tempAttendanceMarker = null;
          }
          if (tempAttendanceCircle && map) {
            map.remove(tempAttendanceCircle);
            tempAttendanceCircle = null;
          }

          
          if (map) {
            map.setStatus({
              dragEnable: true,
              scrollWheel: true,
              doubleClickZoom: true
            });
          }

          await fetchNotifications();
        }
      };

      map.on('click', onMapClick);
    }


    async function markAsRead(event, noticeId) {
      event.stopPropagation(); 

      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '...';

      try {
        const result = await callPythonAPI('mark_notification_read', noticeId);
        if (result.success) {
          
          
          await fetchNotifications();
          
          showNotifications();
        } else {
          showModalAlert(result.message || 'æ ‡è®°å·²è¯»å¤±è´¥');
          btn.disabled = false;
          btn.textContent = 'è®¾ä¸ºå·²è¯»';
        }
      } catch (e) {
        logMessage_Error("markAsRead failed:", e);
        btn.disabled = false;
        btn.textContent = 'è®¾ä¸ºå·²è¯»';
      }
    }

    
    async function markAllAsRead() {
      const btn = $('mark-all-read-btn');
      btn.disabled = true;
      btn.textContent = 'å¤„ç†ä¸­...';

      
      const unreadNotices = (window.currentNotifications || []).filter(n => !n.isRead);
      if (unreadNotices.length === 0) {
        btn.textContent = 'ä¸€é”®å·²è¯»';
        return;
      }

      try {
        
        const promises = unreadNotices.map(n =>
          callPythonAPI('mark_notification_read', n.id)
        );
        await Promise.all(promises);

        
        logMessage_Info(`â€œä¸€é”®å·²è¯»â€æ“ä½œå®Œæˆï¼Œå…±å¤„ç† ${unreadNotices.length} æ¡ã€‚`);

      } catch (e) {
        logMessage_Error("markAllAsRead failed:", e);
        logMessage_Info(`â€œä¸€é”®å·²è¯»â€æ—¶å‘ç”Ÿé”™è¯¯: ${e}`);
      } finally {
        
        await fetchNotifications();
        
        showNotifications();
        
        btn.disabled = (window.currentNotifications || []).filter(n => !n.isRead).length === 0;
        btn.textContent = 'ä¸€é”®å·²è¯»';
      }
    }

    $('multi-remove-all-btn').addEventListener('click', multi_removeAll);
    $('multi-remove-selected-btn').addEventListener('click', multi_removeSelected);
    $('multi-refresh-all-btn').addEventListener('click', multi_refreshAll);
    $('multi-select-all-check').addEventListener('change', multi_toggleSelectAll);
    $('multi-start-selected-btn').addEventListener('click', multi_startSelected);
    $('multi-stop-selected-btn').addEventListener('click', multi_stopSelected);
    $('multi-refresh-selected-btn').addEventListener('click', multi_refreshSelected);

  </script>

  
  <div id="modify-phone-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-slate-800">ä¿®æ”¹ç»‘å®šæ‰‹æœºå·</h3>
        <button onclick="closeModifyPhoneModal()" class="text-slate-400 hover:text-slate-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">å½“å‰æ‰‹æœºå·</label>
          
          <div class="phone-input-wrapper">
            
            <span class="phone-prefix">+86 </span>
            
            <input type="tel" id="modify-phone-current" class="input-field" readonly>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">æ–°æ‰‹æœºå·</label>
          
          <div class="phone-input-wrapper">
            
            <span class="phone-prefix">+86 </span>
            
            <input type="tel" id="modify-phone-new" class="input-field" placeholder="è¯·è¾“å…¥æ–°æ‰‹æœºå·" inputmode="numeric"
              pattern="[0-9]*" style="min-height: 44px;">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">çŸ­ä¿¡éªŒè¯ç </label>
          <div class="flex gap-2">
            <input type="text" id="modify-phone-code" class="input-field flex-1" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6"
              inputmode="numeric" pattern="[0-9]{6}" style="min-height: 44px;">
            <button onclick="sendModifyPhoneCode()" id="modify-phone-send-btn" class="btn btn-primary whitespace-nowrap"
              style="min-height: 44px;">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>

        <div class="flex gap-3 pt-4">
          <button onclick="confirmModifyPhone()" class="btn btn-success flex-1" style="min-height: 44px;">
            ç¡®è®¤ä¿®æ”¹
          </button>
          <button onclick="closeModifyPhoneModal()" class="btn btn-ghost flex-1" style="min-height: 44px;">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </div>


  <script>
    
    
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function switchMobileNotifTab(tabName) {
      
      const allTab = document.getElementById('mobile-notif-tab-all');
      const attTab = document.getElementById('mobile-notif-tab-attendance');
      
      const allList = document.getElementById('mobile-all-notifications-list');
      const attList = document.getElementById('mobile-attendance-notifications-list');

      
      if (tabName === 'all') {
        
        allTab.className = 'flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition';
        attTab.className = 'flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition';
        
        allList.classList.remove('hidden');
        attList.classList.add('hidden');
      } else {
        
        attTab.className = 'flex-1 py-2 text-sm font-semibold text-sky-600 border-b-2 border-sky-600 transition';
        allTab.className = 'flex-1 py-2 text-sm font-semibold text-slate-400 border-b-2 border-transparent transition';
        
        attList.classList.remove('hidden');
        allList.classList.add('hidden');
      }
    }

    
    async function mobileRefreshNotifications() {
      
      const btn = document.getElementById('mobile-refresh-notifications-btn');
      if (btn) {
        
        btn.disabled = true;
        
        const originalText = (btn.textContent || '').trim();
        
        
      }

      try {
        
        
        await fetchNotifications();
        
        updateMobileNotificationUI();
      } catch (error) {
        
        console.error('åˆ·æ–°é€šçŸ¥å¤±è´¥:', error);
        showTempMessage('åˆ·æ–°é€šçŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      } finally {
        
        if (btn) {
          btn.disabled = false;
          
          btn.textContent = typeof originalText !== 'undefined' ? originalText : 'åˆ·æ–°';
        }
      }
    }

    
    function updateMobileNotificationUI() {
      
      const notifications = window.currentNotifications || [];

      
      const badge = document.getElementById('mobile-notification-badge');
      const unreadCount = notifications.filter(n => !n.isRead).length;
      if (badge) {
        if (unreadCount > 0) {
          
          badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
          badge.classList.remove('hidden');
        } else {
          
          badge.classList.add('hidden');
        }
      }

      
      const attendanceNotices = notifications.filter(n =>
        n.image === 'attendance' || (n.title && n.title.includes('ç­¾åˆ°'))
      );
      const regularNotices = notifications;

      
      const allList = document.getElementById('mobile-all-notifications-list');
      if (allList) {
        if (regularNotices.length === 0) {
          
          allList.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">æš‚æ— é€šçŸ¥</p>';
        } else {
          
          allList.innerHTML = '';
          
          regularNotices.forEach(notice => {
            const item = document.createElement('div');
            
            item.className = 'mobile-list-item ' + (notice.isRead ? 'opacity-60' : '');
            item.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${escapeHtml(notice.title)}</span>
                  <span class="text-xs text-slate-400">${escapeHtml(notice.createtime)}</span>
                </div>
                <p class="text-xs text-slate-600">${escapeHtml(notice.content)}</p>
              </div>
              ${!notice.isRead ? '<span class="ml-2 w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></span>' : ''}
            `;
            
            item.addEventListener('click', () => markMobileNotificationRead(notice.id));
            allList.appendChild(item);
          });
        }
      }

      
      const attList = document.getElementById('mobile-attendance-notifications-list');
      if (attList) {
        if (attendanceNotices.length === 0) {
          attList.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>';
        } else {
          attList.innerHTML = '';
          attendanceNotices.forEach(notice => {
            const item = document.createElement('div');
            item.className = 'mobile-list-item';

            
            let statusBadge = '';
            let actionButtons = '';

            if (notice.attendance_code === -1) {
              
              statusBadge = '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-600">å·²è¿‡æœŸ</span>';
            } else if (notice.attendance_code === 1) {
              
              statusBadge = '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-600">å·²ç­¾åˆ°</span>';
            } else if (notice.attendance_code === 0) {
              
              statusBadge = '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-600">å¾…ç­¾åˆ°</span>';
              
              actionButtons = `
                <button class="py-1 px-3 bg-sky-500 text-white rounded-lg text-xs font-medium hover:bg-sky-600 transition" onclick="event.stopPropagation(); mobileHandleAttendance('${notice.id}')">
                  ç­¾åˆ°
                </button>
              `;
            }

            item.innerHTML = `
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-semibold text-slate-800">${escapeHtml(notice.title)}</span>
                  ${statusBadge}
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">${escapeHtml(notice.content)}</span>
                  <span class="text-xs text-slate-400 ml-2">${escapeHtml(notice.createtime)}</span>
                </div>
              </div>
              ${actionButtons}
            `;
            attList.appendChild(item);
          });
        }
      }
    }

    
    function syncMobileAttendanceList() {
      
      const mobileAttList = document.getElementById('mobile-attendance-list');

      
      if (!mobileAttList) return;

      
      const notifications = window.currentNotifications || [];

      
      
      const attendanceNotices = notifications.filter(n =>
        n.image === 'attendance' || (n.title && n.title.includes('ç­¾åˆ°'))
      );

      
      mobileAttList.innerHTML = '';

      
      if (attendanceNotices.length === 0) {
        mobileAttList.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">æš‚æ— ç­¾åˆ°ä»»åŠ¡</p>';
        return;
      }

      
      attendanceNotices.forEach(n => {
        
        const item = document.createElement('div');
        
        item.className = 'bg-white rounded-lg p-3 border border-slate-200 mb-2';

        
        let statusText = 'æœªçŸ¥';
        let statusClass = 'text-slate-500';
        let buttonHtml = '';

        
        let targetCoords = 'null';
        let canSign = false;  
        try {
          
          const coordsStr = (n.updateBy || "").trim();
          const [lat, lon] = coordsStr.split(',').map(Number);
          
          if (!isNaN(lon) && !isNaN(lat)) {
            targetCoords = `[${lon}, ${lat}]`;  
            canSign = true;
          }
        } catch (e) {
          
        }

        
        switch (n.attendance_code) {
          case -1:
            
            statusText = 'å·²è¿‡æœŸ';
            statusClass = 'text-red-600 font-semibold';
            
            if (canSign) {
              buttonHtml = `
                <button class="w-full mt-2 py-2 px-4 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition" 
                  onclick="event.stopPropagation(); handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                  éšæœºè¡¥ç­¾
                </button>
              `;
            }
            break;
          case 1:
            
            statusText = 'å·²ç­¾åˆ°';
            statusClass = 'text-emerald-600 font-semibold';
            
            break;
          case 0:
            
            statusText = 'å¾…ç­¾åˆ°';
            statusClass = 'text-sky-600 font-bold';
            
            if (canSign) {
              buttonHtml = `
                <div class="space-y-2 mt-2">
                  
                  <div class="flex gap-2">
                    <button class="flex-1 py-2 px-4 bg-sky-500 text-white rounded-lg text-sm font-medium hover:bg-sky-600 transition" 
                      onclick="event.stopPropagation(); handleAttendance(event, '${n.id}', ${targetCoords})">
                      éšæœºç­¾åˆ°
                    </button>
                    <button class="flex-1 py-2 px-4 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition" 
                      onclick="event.stopPropagation(); handleMakeupAttendance(event, '${n.id}', ${targetCoords})">
                      éšæœºè¡¥ç­¾
                    </button>
                  </div>
                  
                  <button class="w-full py-2 px-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg text-sm font-bold hover:from-purple-600 hover:to-purple-700 transition-all shadow-md flex items-center justify-center gap-2" 
                    onclick="event.stopPropagation(); openMobileMapAttendanceModal('${n.id}', ${targetCoords})">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    ğŸ“ åœ°å›¾é€‰ç‚¹ç­¾åˆ°
                  </button>
                </div>
              `;
            }
            break;
          default:
            
            statusText = 'çŠ¶æ€æœªçŸ¥';
            statusClass = 'text-slate-400';
        }

        
        if (n.attendance_status_text && n.attendance_status_text.includes('å¤±è´¥')) {
          statusText = n.attendance_status_text;
          statusClass = 'text-red-700 font-bold';
        }

        
        item.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <p class="text-sm font-semibold text-slate-800 mb-1">${n.title}</p>
              <p class="text-xs text-slate-600">${n.content}</p>
            </div>
            <span class="text-xs ${statusClass} ml-2 flex-shrink-0">${statusText}</span>
          </div>
          <div class="text-xs text-slate-400">${n.createtime}</div>
          ${buttonHtml}
        `;

        
        mobileAttList.appendChild(item);
      });
    }

    
    async function markMobileNotificationRead(noticeId) {
      try {
        
        const result = await callPythonAPI('mark_notification_read', noticeId);
        if (result.success) {
          
          await mobileRefreshNotifications();
        }
      } catch (error) {
        console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
      }
    }

    
    async function mobileMarkAllAsRead() {
      const notifications = window.currentNotifications || [];
      const unreadNotices = notifications.filter(n => !n.isRead);

      if (unreadNotices.length === 0) {
        showTempMessage('æ²¡æœ‰æœªè¯»é€šçŸ¥', 'info');
        return;
      }

      try {
        
        const promises = unreadNotices.map(n =>
          callPythonAPI('mark_notification_read', n.id)
        );
        await Promise.all(promises);

        
        await mobileRefreshNotifications();
        showTempMessage('å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»', 'success');
      } catch (error) {
        console.error('ä¸€é”®å·²è¯»å¤±è´¥:', error);
        showTempMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    
    function expandMobileNotifications() {
      
      showNotifications();
    }

    
    async function mobileHandleAttendance(rollCallId) {
      
      const notifications = window.currentNotifications || [];
      const notice = notifications.find(n => n.id === rollCallId);

      if (!notice) {
        showTempMessage('æœªæ‰¾åˆ°ç­¾åˆ°æ´»åŠ¨ä¿¡æ¯', 'error');
        return;
      }

      
      try {
        const coordsStr = (notice.updateBy || "").trim();
        const [lat, lon] = coordsStr.split(',').map(Number);

        if (isNaN(lon) || isNaN(lat)) {
          showTempMessage('ç­¾åˆ°åæ ‡æ— æ•ˆ', 'error');
          return;
        }

        const targetCoords = [lon, lat];

        
        const result = await callPythonAPI('trigger_attendance', rollCallId, targetCoords, 'random', null, false);

        if (result.success) {
          showTempMessage('ç­¾åˆ°æˆåŠŸï¼', 'success');
          
          await mobileRefreshNotifications();
        } else {
          showTempMessage('ç­¾åˆ°å¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('ç­¾åˆ°å¤±è´¥:', error);
        showTempMessage('ç­¾åˆ°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    
    async function mobileRefreshTasks() {
      try {
        showTempMessage('æ­£åœ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...', 'info');
        await refreshTasks();
        showTempMessage('ä»»åŠ¡åˆ—è¡¨å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
        showTempMessage('åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥', 'error');
      }
    }

    

    
    let mobileTaskRunning = false;
    let mobileTaskPaused = false;

    
    function updateMobileTaskUI(status, detail = '') {
      const statusIndicator = $('mobile-status-indicator');
      const statusDetail = $('mobile-status-detail');
      const startBtn = $('mobile-start-btn');
      const stopBtn = $('mobile-stop-btn');

      if (statusIndicator) {
        statusIndicator.textContent = status;
        
        statusIndicator.className = 'text-xs font-semibold px-2 py-1 rounded-full';
        if (status === 'è¿è¡Œä¸­') {
          statusIndicator.className += ' bg-green-200 text-green-600';
        } else if (status === 'å·²æš‚åœ') {
          statusIndicator.className += ' bg-yellow-200 text-yellow-600';
        } else if (status === 'å·²åœæ­¢') {
          statusIndicator.className += ' bg-red-200 text-red-600';
          
        } else if (status === 'å·²å®Œæˆ') {
          statusIndicator.className += ' bg-blue-200 text-blue-600';
        } else {
          statusIndicator.className += ' bg-slate-200 text-slate-600';
        }
      }

      if (statusDetail) {
        statusDetail.textContent = detail || 'ç­‰å¾…æ‰§è¡Œä»»åŠ¡';
      }

      
      
      if (startBtn && stopBtn) {
        if (status === 'è¿è¡Œä¸­') {
          
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } else if (status === 'å·²æš‚åœ') {
          
          startBtn.disabled = false;
          stopBtn.disabled = false;
        } else if (status === 'å·²å®Œæˆ') {
          
          
          startBtn.disabled = false;
          stopBtn.disabled = true;
          
          mobileTaskRunning = false;
          mobileTaskPaused = false;
        } else {
          
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      }
    }

    
    function updateMobileProgress(percent, text) {
      const progressBar = $('mobile-progress-bar');
      const progressText = $('mobile-progress-text');

      if (progressBar) {
        progressBar.style.width = percent + '%';
      }
      if (progressText) {
        progressText.textContent = text || (percent + '%');
      }
    }

    
    function mobileAddTask() {
      
      addTask();
    }

    
    async function mobileStartTask() {
      try {
        
        if (selectedTaskIndex < 0 || selectedTaskIndex === -1) {
          showModalAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡å†å¼€å§‹æ‰§è¡Œ', 'æœªé€‰æ‹©ä»»åŠ¡');
          return;
        }

        const statusRes = await callPythonAPI_raw('/api/background_task/status', 'GET', null);
        const isBackendRunning = statusRes.success && statusRes.task_status && statusRes.task_status.status === 'running';

        if (isBackendRunning) {
          
          mobileTaskRunning = true;
          mobileTaskPaused = false;
          updateMobileTaskUI('è¿è¡Œä¸­', 'åå°å·²æœ‰ä»»åŠ¡åœ¨è¿è¡Œ');
          showTempMessage('åå°å·²æœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œæ— æ³•å¯åŠ¨æ–°ä»»åŠ¡', 'warning');
          
          if (!backgroundTaskPollInterval) {
            startBackgroundTaskPolling();
          }
          return;
        }

        
        if (mobileTaskRunning && !mobileTaskPaused) {
          showTempMessage('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­', 'info');
          return;
        }

        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        updateMobileTaskUI('å‡†å¤‡ä¸­', 'æ­£åœ¨å¯åŠ¨ä»»åŠ¡...');

        
        if (currentRunData) {
          currentRunData.target_sequence = 1;
          currentRunData.isInTargetZone = false;
        }

        
        
        const result = await callPythonAPI_raw('/api/background_task/start', 'POST', {
          task_indices: [selectedTaskIndex],
          auto_generate: true
        });

        if (result && result.success) {
          mobileTaskRunning = true;
          mobileTaskPaused = false;
          
          updateMobileTaskUI('è¿è¡Œä¸­', 'ä»»åŠ¡æ‰§è¡Œä¸­');
          updateMobileProgress(0, '0%');
          showTempMessage('ä»»åŠ¡å·²å¯åŠ¨', 'success');

          
          setTimeout(() => startBackgroundTaskPolling(), 500);
        } else {
          
          const isRunning = await syncMobileBtnStateFromBackend();
          if (!isRunning) {
            updateMobileTaskUI('æœªå¯åŠ¨', result?.message || 'å¯åŠ¨å¤±è´¥');
          }
          showTempMessage(result?.message || 'å¯åŠ¨å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] å¯åŠ¨ä»»åŠ¡å¤±è´¥:', error);
        
        const isRunning = await syncMobileBtnStateFromBackend();
        if (!isRunning) {
          updateMobileTaskUI('é”™è¯¯', 'å¯åŠ¨å¤±è´¥');
        }
        showTempMessage('å¯åŠ¨ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }

    
    async function syncMobileBtnStateFromBackend() {
      try {
        const res = await callPythonAPI_raw('/api/background_task/status', 'GET', null);
        
        if (res.success && res.task_status && res.task_status.status === 'running') {
          mobileTaskRunning = true;
          mobileTaskPaused = false;
          
          updateMobileTaskUI('è¿è¡Œä¸­', 'ä»»åŠ¡æ‰§è¡Œä¸­ (å·²æ¢å¤)');
          
          if (!backgroundTaskPollInterval) {
            startBackgroundTaskPolling();
          }
          return true;
        }
      } catch (e) { console.error("åŒæ­¥çŠ¶æ€å¤±è´¥:", e); }

      
      mobileTaskRunning = false;
      
      return false;
    }
    
    async function mobileStopTask() {
      try {
        
        const statusRes = await callPythonAPI_raw('/api/background_task/status', 'GET', null);
        const isBackendRunning = statusRes.success && statusRes.task_status && statusRes.task_status.status === 'running';

        if (!isBackendRunning) {
          
          mobileTaskRunning = false;
          updateMobileTaskUI('æœªå¯åŠ¨', 'æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡');
          showTempMessage('æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡', 'info');
          return;
        }

        
        updateMobileTaskUI('åœæ­¢ä¸­', 'æ­£åœ¨åœæ­¢ä»»åŠ¡...');

        const result = await callPythonAPI_raw('/api/background_task/stop', 'POST', {});

        if (result && result.success) {
          mobileTaskRunning = false;
          mobileTaskPaused = false;
          updateMobileTaskUI('å·²åœæ­¢', 'ä»»åŠ¡å·²åœæ­¢');
          showTempMessage('ä»»åŠ¡å·²åœæ­¢', 'success');
          stopBackgroundTaskPolling();
        } else {
          
          const isRunning = await syncMobileBtnStateFromBackend();
          if (isRunning) {
            
            updateMobileTaskUI('è¿è¡Œä¸­', result?.message || 'åœæ­¢å¤±è´¥');
          } else {
            
            updateMobileTaskUI('å·²åœæ­¢', 'ä»»åŠ¡å·²åœæ­¢ (ä¿®æ­£çŠ¶æ€)');
          }
          showTempMessage(result?.message || 'åœæ­¢å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åœæ­¢ä»»åŠ¡å¤±è´¥:', error);
        
        const isRunning = await syncMobileBtnStateFromBackend();
        if (isRunning) {
          updateMobileTaskUI('è¿è¡Œä¸­', 'åœæ­¢è¯·æ±‚å¼‚å¸¸');
        } else {
          updateMobileTaskUI('å·²åœæ­¢', 'è¿æ¥å¼‚å¸¸ (å‡è®¾å·²åœ)');
        }
        showTempMessage('åœæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }

    
    async function mobilePauseTask() {
      try {
        if (!mobileTaskRunning) {
          showTempMessage('æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡', 'info');
          return;
        }

        if (mobileTaskPaused) {
          showTempMessage('ä»»åŠ¡å·²æš‚åœ', 'info');
          return;
        }

        const result = await callPythonAPI('pause_run');
        if (result && result.success) {
          mobileTaskPaused = true;
          updateMobileTaskUI('å·²æš‚åœ', 'ä»»åŠ¡å·²æš‚åœ');
          showTempMessage('ä»»åŠ¡å·²æš‚åœ', 'success');
        } else {
          showTempMessage(result?.message || 'æš‚åœå¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æš‚åœä»»åŠ¡å¤±è´¥:', error);
        showTempMessage('æš‚åœä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }

    
    async function mobileResumeTask() {
      try {
        if (!mobileTaskPaused) {
          showTempMessage('ä»»åŠ¡æœªæš‚åœ', 'info');
          return;
        }

        const result = await callPythonAPI('resume_run');
        if (result && result.success) {
          mobileTaskPaused = false;
          updateMobileTaskUI('è¿è¡Œä¸­', 'ä»»åŠ¡ç»§ç»­æ‰§è¡Œ');
          showTempMessage('ä»»åŠ¡å·²ç»§ç»­', 'success');
        } else {
          showTempMessage(result?.message || 'ç»§ç»­å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] ç»§ç»­ä»»åŠ¡å¤±è´¥:', error);
        showTempMessage('ç»§ç»­ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }

    
    async function mobileResetTask() {
      try {
        
        showMobileConfirm(
          'é‡ç½®ä»»åŠ¡', 
          'ç¡®å®šè¦é‡ç½®ä»»åŠ¡å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰è¿›åº¦ã€‚', 
          async () => {
            
            const result = await callPythonAPI('reset_run');
            if (result && result.success) {
              mobileTaskRunning = false;
              mobileTaskPaused = false;
              updateMobileTaskUI('æœªå¯åŠ¨', 'ä»»åŠ¡å·²é‡ç½®');
              updateMobileProgress(0, '0%');
              showTempMessage('ä»»åŠ¡å·²é‡ç½®', 'success');
            } else {
              showTempMessage(result?.message || 'é‡ç½®å¤±è´¥', 'error');
            }
          }
        );
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] é‡ç½®ä»»åŠ¡å¤±è´¥:', error);
        showTempMessage('é‡ç½®ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }

    
    async function exitMobileMultiAccount() {
      
      
      try {
        
        const statusRes = await callPythonAPI_raw('/api/background_task/status', 'GET', null);
        const isTaskRunning = statusRes.success &&
          statusRes.task_status &&
          statusRes.task_status.status === 'running';

        
        if (isTaskRunning || mobileTaskRunning) {
          
          showMobileConfirm(
            'è­¦å‘Šï¼šä»»åŠ¡æ­£åœ¨è¿è¡Œ', 
            'æ£€æµ‹åˆ°æœ‰è·‘æ­¥ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ã€‚é€€å‡ºå¤šè´¦å·æ¨¡å¼å°†åœæ­¢å½“å‰ä»»åŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸å®Œæ•´ã€‚\n\nç¡®å®šè¦ç»§ç»­é€€å‡ºå—ï¼Ÿ', 
            async () => {
              
              try {
                
                await callPythonAPI_raw('/api/background_task/stop', 'POST', {});
                
                stopBackgroundTaskPolling();
                
                updateMobileTaskUI('å·²åœæ­¢', 'ä»»åŠ¡å·²åœæ­¢ï¼ˆé€€å‡ºå¤šè´¦å·æ¨¡å¼ï¼‰');
                
                mobileTaskRunning = false;
                mobileTaskPaused = false;

                
                performExitMobileMultiAccount();
              } catch (error) {
                console.error('[ç§»åŠ¨ç«¯] åœæ­¢ä»»åŠ¡å¤±è´¥:', error);
                
                showTempMessage('åœæ­¢ä»»åŠ¡æ—¶å‡ºé”™ï¼Œä½†ä»å°†é€€å‡ºå¤šè´¦å·æ¨¡å¼', 'warning');
                performExitMobileMultiAccount();
              }
            },
            () => {
              
              showTempMessage('å·²å–æ¶ˆé€€å‡ºå¤šè´¦å·æ¨¡å¼', 'info');
            }
          );
          return; 
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
        
        showTempMessage('æ— æ³•æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œå°†ç»§ç»­é€€å‡º', 'warning');
      }

      
      performExitMobileMultiAccount();
    }

    
    async function performExitMobileMultiAccount() {
      
      
      
      stopMultiAccountAutoRefresh();

      
      await callPythonAPI('exit_multi_account_mode');

      
      document.getElementById('mobile-multi-account-app').classList.add('hidden');
      
      document.getElementById('mobile-login-container').classList.remove('hidden');
      
      updateMobileNavVisibility(false);
    }

    
    async function exitMobileSingleAccount() {
      try {
        console.log('[ç§»åŠ¨ç«¯] å¼€å§‹é€€å‡ºå•è´¦å·æ¨¡å¼...');

        
        
        const result = await callPythonAPI('exit_single_account_mode');

        
        if (!result || !result.success) {
          console.error('[ç§»åŠ¨ç«¯] é€€å‡ºå•è´¦å·æ¨¡å¼å¤±è´¥:', result?.message || 'æœªçŸ¥é”™è¯¯');
          showTempMessage('é€€å‡ºå¤±è´¥: ' + (result?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          return;
        }

        console.log('[ç§»åŠ¨ç«¯] é€€å‡ºå•è´¦å·æ¨¡å¼æˆåŠŸï¼Œå¼€å§‹åˆ‡æ¢ç•Œé¢...');

        
        
        if (typeof destroyMobileSingleMap === 'function') {
          destroyMobileSingleMap();
          console.log('[é€€å‡ºå•è´¦å·] ç§»åŠ¨ç«¯ï¼šå·²é”€æ¯å•è´¦å·åœ°å›¾');
        }

        
        const mobileMainApp = document.getElementById('mobile-main-app');
        if (mobileMainApp) {
          mobileMainApp.classList.add('hidden');
        }

        
        const loginContainer = document.getElementById('mobile-login-container');
        if (loginContainer) {
          loginContainer.classList.remove('hidden');
        }

        
        updateMobileNavVisibility(false);

        
        
        setTimeout(async () => {
          console.log('[ç§»åŠ¨ç«¯] å¼€å§‹åˆ·æ–°ä¼šè¯åˆ—è¡¨...');

          
          
          if (typeof refreshMobileSessions === 'function') {
            await refreshMobileSessions();
            console.log('[ç§»åŠ¨ç«¯] ä¼šè¯åˆ—è¡¨åˆ·æ–°å®Œæˆ');
          } else if (typeof refreshSessionList === 'function') {
            
            await refreshSessionList();
            console.log('[ç§»åŠ¨ç«¯] ä¼šè¯åˆ—è¡¨åˆ·æ–°å®Œæˆï¼ˆä½¿ç”¨PCç«¯å‡½æ•°ï¼‰');
          } else {
            console.warn('[ç§»åŠ¨ç«¯] æœªæ‰¾åˆ°åˆ·æ–°ä¼šè¯åˆ—è¡¨çš„å‡½æ•°');
          }
        }, 200);

        
        showTempMessage('å·²é€€å‡ºå•è´¦å·æ¨¡å¼', 'success');
        console.log('[ç§»åŠ¨ç«¯] é€€å‡ºå•è´¦å·æ¨¡å¼æµç¨‹å®Œæˆ');

      } catch (error) {
        
        console.error('[ç§»åŠ¨ç«¯] é€€å‡ºå•è´¦å·æ¨¡å¼æ—¶å‘ç”Ÿé”™è¯¯:', error);
        showTempMessage('é€€å‡ºæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
      }
    }

    
    async function exitMobileMultiAccountToSessions() {
      try {
        console.log('[ç§»åŠ¨ç«¯] å¼€å§‹é€€å‡ºå¤šè´¦å·æ¨¡å¼...');

        
        
        
        stopMultiAccountAutoRefresh();

        
        
        const result = await callPythonAPI('exit_multi_account_mode');

        
        if (!result || !result.success) {
          console.error('[ç§»åŠ¨ç«¯] é€€å‡ºå¤šè´¦å·æ¨¡å¼å¤±è´¥:', result?.message || 'æœªçŸ¥é”™è¯¯');
          showTempMessage('é€€å‡ºå¤±è´¥: ' + (result?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          return;
        }

        console.log('[ç§»åŠ¨ç«¯] é€€å‡ºå¤šè´¦å·æ¨¡å¼æˆåŠŸï¼Œå¼€å§‹åˆ‡æ¢ç•Œé¢...');

        
        const mobileMultiApp = document.getElementById('mobile-multi-account-app');
        if (mobileMultiApp) {
          mobileMultiApp.classList.add('hidden');
        }

        
        const loginContainer = document.getElementById('mobile-login-container');
        if (loginContainer) {
          loginContainer.classList.remove('hidden');
        }

        
        updateMobileNavVisibility(false);

        
        
        setTimeout(async () => {
          console.log('[ç§»åŠ¨ç«¯] å¼€å§‹åˆ·æ–°ä¼šè¯åˆ—è¡¨...');

          
          if (typeof refreshMobileSessions === 'function') {
            await refreshMobileSessions();
            console.log('[ç§»åŠ¨ç«¯] ä¼šè¯åˆ—è¡¨åˆ·æ–°å®Œæˆ');
          } else if (typeof refreshSessionList === 'function') {
            
            await refreshSessionList();
            console.log('[ç§»åŠ¨ç«¯] ä¼šè¯åˆ—è¡¨åˆ·æ–°å®Œæˆï¼ˆä½¿ç”¨PCç«¯å‡½æ•°ï¼‰');
          } else {
            console.warn('[ç§»åŠ¨ç«¯] æœªæ‰¾åˆ°åˆ·æ–°ä¼šè¯åˆ—è¡¨çš„å‡½æ•°');
          }
        }, 200);

        
        showTempMessage('å·²é€€å‡ºå¤šè´¦å·æ¨¡å¼', 'success');
        console.log('[ç§»åŠ¨ç«¯] é€€å‡ºå¤šè´¦å·æ¨¡å¼æµç¨‹å®Œæˆ');

      } catch (error) {
        
        console.error('[ç§»åŠ¨ç«¯] é€€å‡ºå¤šè´¦å·æ¨¡å¼æ—¶å‘ç”Ÿé”™è¯¯:', error);
        showTempMessage('é€€å‡ºæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
      }
    }

    
    function mobileToggleSelectAllAccounts() {
      const checkbox = document.getElementById('mobile-select-all-accounts');
      const accountCheckboxes = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]');

      
      accountCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
    }

    
    async function mobileStartSelectedAccounts() {
      try {
        
        const selected = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]:checked');
        if (selected.length === 0) {
          showTempMessage('è¯·å…ˆé€‰æ‹©è¦å¯åŠ¨çš„è´¦å·', 'error');
          return;
        }

        await multi_startSelected();
        showTempMessage(`æ­£åœ¨å¯åŠ¨ ${selected.length} ä¸ªè´¦å·`, 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] å¯åŠ¨é€‰ä¸­è´¦å·å¤±è´¥:', error);
        showTempMessage('å¯åŠ¨é€‰ä¸­è´¦å·å¤±è´¥', 'error');
      }
    }

    
    async function mobileStopSelectedAccounts() {
      try {
        const selected = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]:checked');
        if (selected.length === 0) {
          showTempMessage('è¯·å…ˆé€‰æ‹©è¦åœæ­¢çš„è´¦å·', 'error');
          return;
        }

        await multi_stopSelected();
        showTempMessage(`æ­£åœ¨åœæ­¢ ${selected.length} ä¸ªè´¦å·`, 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åœæ­¢é€‰ä¸­è´¦å·å¤±è´¥:', error);
        showTempMessage('åœæ­¢é€‰ä¸­è´¦å·å¤±è´¥', 'error');
      }
    }

    
    function mobileAddMultiAccount() {
      try {
        
        multi_addFromConfig();
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ·»åŠ è´¦å·å¤±è´¥:', error);
        showTempMessage('æ·»åŠ è´¦å·å¤±è´¥', 'error');
      }
    }

    
    async function mobileRefreshMultiAccounts() {
      try {
        showTempMessage('æ­£åœ¨åˆ·æ–°è´¦å·åˆ—è¡¨...', 'info');
        await multi_refreshAll();
        showTempMessage('è´¦å·åˆ—è¡¨å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ·æ–°è´¦å·åˆ—è¡¨å¤±è´¥:', error);
        showTempMessage('åˆ·æ–°è´¦å·åˆ—è¡¨å¤±è´¥', 'error');
      }
    }

    
    
    async function mobileStartAllAccounts() {
      try {
        const count = parseInt($('multi-account-count')?.textContent || '0', 10);
        if (!count || count <= 0) {
          showTempMessage('è´¦å·åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¯åŠ¨', 'error');
          return;
        }

        
        const randomDelayCheck = document.getElementById('mobile-multi-random-delay-check');
        const onlyIncompleteCheck = document.getElementById('mobile-multi-only-incomplete-check');

        
        const use_delay = randomDelayCheck ? randomDelayCheck.checked : true;
        
        const min_delay = 0;
        const max_delay = 300;
        
        const run_only_incomplete = onlyIncompleteCheck ? onlyIncompleteCheck.checked : true;

        showTempMessage(`æ­£åœ¨å¯åŠ¨å…¨éƒ¨ ${count} ä¸ªè´¦å·...`, 'info');

        
        const result = await callPythonAPI('multi_start_all_accounts', min_delay, max_delay, use_delay, run_only_incomplete);

        
        if (!result || !result.success) {
          showTempMessage(result?.message || 'å¯åŠ¨å…¨éƒ¨è´¦å·å¤±è´¥', 'error');
          return;
        }

        showTempMessage('å·²å‘é€å…¨éƒ¨å¯åŠ¨æŒ‡ä»¤', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] å¯åŠ¨å…¨éƒ¨è´¦å·å¤±è´¥:', error);
        showTempMessage('å¯åŠ¨å…¨éƒ¨è´¦å·å¤±è´¥', 'error');
      }
    }

    
    async function mobileStopAllAccounts() {
      try {
        await multi_stopAll();
        showTempMessage('å·²å‘é€å…¨éƒ¨åœæ­¢æŒ‡ä»¤', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åœæ­¢å…¨éƒ¨è´¦å·å¤±è´¥:', error);
        showTempMessage('åœæ­¢å…¨éƒ¨è´¦å·å¤±è´¥', 'error');
      }
    }

    
    async function mobileRefreshAllAccounts() {
      try {
        showTempMessage('æ­£åœ¨åˆ·æ–°æ‰€æœ‰è´¦å·...', 'info');
        await multi_refreshAll();
        showTempMessage('æ‰€æœ‰è´¦å·å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ·æ–°æ‰€æœ‰è´¦å·å¤±è´¥:', error);
        showTempMessage('åˆ·æ–°æ‰€æœ‰è´¦å·å¤±è´¥', 'error');
      }
    }

    
    async function mobileRemoveSelectedAccounts() {
      try {
        
        const selected = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]:checked');
        if (selected.length === 0) {
          showTempMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è´¦å·', 'error');
          return;
        }

        
        showMobileConfirm(
          'åˆ é™¤è´¦å·', 
          `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selected.length} ä¸ªè´¦å·å—ï¼Ÿ`, 
          async () => {
            
            await multi_removeSelected();
            showTempMessage(`å·²åˆ é™¤ ${selected.length} ä¸ªè´¦å·`, 'success');
          }
        );
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ é™¤é€‰ä¸­è´¦å·å¤±è´¥:', error);
        showTempMessage('åˆ é™¤é€‰ä¸­è´¦å·å¤±è´¥', 'error');
      }
    }

    

    
    function toggleMobileMoreMenu(show) {
      
      const modal = document.getElementById('mobile-more-menu-modal');

      
      if (modal) {
        
        if (show) {
          
          modal.classList.remove('hidden');
        } else {
          
          modal.classList.add('hidden');
        }
      }
    }

    
    function toggleMobileAdminPanel(show) {
      
      const modal = document.getElementById('mobile-admin-panel-modal');

      
      if (modal) {
        
        if (show) {
          
          modal.classList.remove('hidden');
          
          initMobileAdminPanel('mobile-admin');
        } else {
          
          modal.classList.add('hidden');
        }
      }
    }

    
    function toggleMobileUserDetails(show) {
      
      
      if (!isMobileMode) {
        
        toggleUserDetails(show);
        return;
      }

      
      const modal = document.getElementById('mobile-user-details-modal');

      
      if (modal) {
        
        if (show) {
          
          modal.classList.remove('hidden');
          
          
        } else {
          
          modal.classList.add('hidden');
        }
      }
    }

    
    function toggleMobileTaskDetails(show) {
      
      const modal = document.getElementById('mobile-task-details-modal');

      
      if (modal) {
        
        if (show) {
          
          modal.classList.remove('hidden');
        } else {
          
          modal.classList.add('hidden');
        }
      }
    }

    
    function toggleMobileNotifications(show) {
      
      const modal = document.getElementById('mobile-notifications-modal');

      
      if (modal) {
        
        if (show) {
          
          modal.classList.remove('hidden');
          
          
        } else {
          
          modal.classList.add('hidden');
        }
      }
    }

    
    function showMobileConfirm(title, message, onConfirm, onCancel) {
      
      const modal = document.getElementById('mobile-confirm-modal');
      if (!modal) {
        console.error('æ‰¾ä¸åˆ°ç§»åŠ¨ç«¯ç¡®è®¤å¯¹è¯æ¡†å…ƒç´ ');
        return;
      }

      
      const titleElement = document.getElementById('mobile-confirm-title');
      if (titleElement) {
        titleElement.textContent = title;
      }

      
      const messageElement = document.getElementById('mobile-confirm-message');
      if (messageElement) {
        messageElement.textContent = message;
      }

      
      const cancelBtn = document.getElementById('mobile-confirm-cancel-btn');
      const okBtn = document.getElementById('mobile-confirm-ok-btn');

      
      const closeModal = () => {
        modal.classList.add('hidden');
      };

      
      
      const newCancelBtn = cancelBtn.cloneNode(true);
      const newOkBtn = okBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
      okBtn.parentNode.replaceChild(newOkBtn, okBtn);

      
      newCancelBtn.addEventListener('click', () => {
        closeModal(); 
        if (onCancel && typeof onCancel === 'function') {
          onCancel(); 
        }
      });

      
      newOkBtn.addEventListener('click', () => {
        closeModal(); 
        if (onConfirm && typeof onConfirm === 'function') {
          onConfirm(); 
        }
      });

      
      modal.onclick = (e) => {
        if (e.target === modal) {
          closeModal();
          if (onCancel && typeof onCancel === 'function') {
            onCancel(); 
          }
        }
      };

      
      modal.classList.remove('hidden');
    }

    
    async function mobileLogout() {
      
      
      try {
        
        const statusRes = await callPythonAPI_raw('/api/background_task/status', 'GET', null);
        const isTaskRunning = statusRes.success &&
          statusRes.task_status &&
          statusRes.task_status.status === 'running';

        
        if (isTaskRunning || mobileTaskRunning) {
          
          showMobileConfirm(
            'è­¦å‘Šï¼šä»»åŠ¡æ­£åœ¨è¿è¡Œ', 
            'æ£€æµ‹åˆ°æœ‰è·‘æ­¥ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ã€‚é€€å‡ºç™»å½•å°†åœæ­¢å½“å‰ä»»åŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸å®Œæ•´ã€‚\n\nç¡®å®šè¦ç»§ç»­é€€å‡ºå—ï¼Ÿ', 
            async () => {
              
              try {
                
                await callPythonAPI_raw('/api/background_task/stop', 'POST', {});
                
                stopBackgroundTaskPolling();
                
                updateMobileTaskUI('å·²åœæ­¢', 'ä»»åŠ¡å·²åœæ­¢ï¼ˆé€€å‡ºç™»å½•ï¼‰');
                
                mobileTaskRunning = false;
                mobileTaskPaused = false;

                
                performMobileLogout();
              } catch (error) {
                console.error('[ç§»åŠ¨ç«¯] åœæ­¢ä»»åŠ¡å¤±è´¥:', error);
                
                showTempMessage('åœæ­¢ä»»åŠ¡æ—¶å‡ºé”™ï¼Œä½†ä»å°†é€€å‡ºç™»å½•', 'warning');
                performMobileLogout();
              }
            },
            () => {
              
              showTempMessage('å·²å–æ¶ˆé€€å‡ºç™»å½•', 'info');
            }
          );
          return; 
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
        
        showTempMessage('æ— æ³•æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œå°†ç»§ç»­é€€å‡º', 'warning');
      }

      
      performMobileLogout();
    }

    
    function performMobileLogout() {
      
      
      showMobileConfirm(
        'é€€å‡ºç™»å½•', 
        'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 
        () => {
          
          
          const mobileMainApp = document.getElementById('mobile-main-app');
          if (mobileMainApp) {
            mobileMainApp.classList.add('hidden');
          }

          
          const loginContainer = document.getElementById('mobile-login-container');
          if (loginContainer) {
            loginContainer.classList.remove('hidden');
          }

          
          updateMobileNavVisibility(false);

          
          
          

          
          showTempMessage('å·²é€€å‡ºç™»å½•', 'success');
        }
      );
    }

    
    
    async function loadMobileUserDetails() {
      try {
        
        
        if (!currentUserData || !currentUserData.student_id) {
          
          const emptyDiv = document.getElementById('mobile-user-details-empty');
          const avatarDiv = document.getElementById('mobile-user-details-avatar');
          const basicDiv = document.getElementById('mobile-user-details-basic');
          const schoolDiv = document.getElementById('mobile-user-details-school');
          const loginDiv = document.getElementById('mobile-user-details-login');
          const uaDiv = document.getElementById('mobile-user-details-ua');

          
          if (emptyDiv) emptyDiv.classList.remove('hidden');
          if (avatarDiv) avatarDiv.classList.add('hidden');
          if (basicDiv) basicDiv.classList.add('hidden');
          if (schoolDiv) schoolDiv.classList.add('hidden');
          if (loginDiv) loginDiv.classList.add('hidden');
          if (uaDiv) uaDiv.classList.add('hidden');

          
          showTempMessage('è¯·å…ˆç™»å½•', 'warning');
          return;
        }

        
        const user_data = currentUserData;

        
        const emptyDiv = document.getElementById('mobile-user-details-empty');
        const avatarDiv = document.getElementById('mobile-user-details-avatar');
        const basicDiv = document.getElementById('mobile-user-details-basic');
        const schoolDiv = document.getElementById('mobile-user-details-school');
        const loginDiv = document.getElementById('mobile-user-details-login');
        const uaDiv = document.getElementById('mobile-user-details-ua');

        
        if (emptyDiv) emptyDiv.classList.add('hidden');
        
        if (avatarDiv) avatarDiv.classList.remove('hidden');
        if (basicDiv) basicDiv.classList.remove('hidden');
        if (schoolDiv) schoolDiv.classList.remove('hidden');
        if (loginDiv) loginDiv.classList.remove('hidden');
        if (uaDiv) uaDiv.classList.remove('hidden');

        
        const avatarImg = document.getElementById('mobile-user-details-avatar-img');
        const nameText = document.getElementById('mobile-user-details-name');

        if (avatarImg && user_data.avatar) {
          avatarImg.src = user_data.avatar;
        }
        if (nameText) {
          nameText.textContent = user_data.name || 'æœªçŸ¥ç”¨æˆ·';
        }

        
        const basicList = document.getElementById('mobile-user-details-basic-list');
        if (basicList) {
          
          basicList.innerHTML = '';

          
          const basicInfo = {
            'å­¦å·': user_data.student_id,
            'ç”¨æˆ·å': user_data.username,
            'æ€§åˆ«': user_data.gender,
            'æ‰‹æœºå·': user_data.phone,
            'ç”¨æˆ·ID': user_data.id,
            'èº«ä»½è¯å·': user_data.id_card
          };

          
          Object.entries(basicInfo).forEach(([label, value]) => {
            
            const p = document.createElement('div');
            p.className = 'flex items-start gap-2';
            
            p.innerHTML = `
              <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
              <span class="text-slate-800 break-all flex-1">${value || 'NULL'}</span>
            `;
            basicList.appendChild(p);
          });
        }

        
        const schoolList = document.getElementById('mobile-user-details-school-list');
        if (schoolList) {
          
          schoolList.innerHTML = '';

          
          const schoolInfo = {
            'å­¦æ ¡': user_data.school_name,
            'å±æ€§': user_data.attribute_type
          };

          
          Object.entries(schoolInfo).forEach(([label, value]) => {
            const p = document.createElement('div');
            p.className = 'flex items-start gap-2';
            p.innerHTML = `
              <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
              <span class="text-slate-800 break-all flex-1">${value || 'NULL'}</span>
            `;
            schoolList.appendChild(p);
          });
        }

        
        const loginList = document.getElementById('mobile-user-details-login-list');
        if (loginList) {
          
          loginList.innerHTML = '';

          
          const loginInfo = {
            'æ³¨å†Œæ—¶é—´': user_data.registration_time,
            'é¦–æ¬¡ç™»å½•': user_data.first_login_time,
            'ä¸Šæ¬¡ç™»å½•': user_data.last_login_time,
            'å½“å‰ç™»å½•': user_data.current_login_time
          };

          
          Object.entries(loginInfo).forEach(([label, value]) => {
            const p = document.createElement('div');
            p.className = 'flex items-start gap-2';
            p.innerHTML = `
              <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
              <span class="text-slate-800 break-all flex-1">${value || 'NULL'}</span>
            `;
            loginList.appendChild(p);
          });
        }

        
        const uaText = document.getElementById('mobile-user-details-ua-text');
        if (uaText) {
          
          const uaString = IS_OFFLINE ? 'NULL' : (currentSessionUA || 'NULL');
          uaText.textContent = uaString;
        }

        
        showTempMessage('ç”¨æˆ·è¯¦æƒ…åŠ è½½æˆåŠŸ', 'success');
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
        showTempMessage('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
      }
    }

    
    async function loadMobileProfile() {
      
      await loadMobileUserDetails();
    }

    
    function loadMobileTaskDetails() {
      
      
      if (!currentRunData || !currentRunData.run_name) {
        
        const emptyDiv = document.getElementById('mobile-task-details-empty');
        const basicDiv = document.getElementById('mobile-task-details-basic');
        const timeDiv = document.getElementById('mobile-task-details-time');
        const pointsDiv = document.getElementById('mobile-task-details-points');
        const historyDiv = document.getElementById('mobile-task-details-history');

        
        if (emptyDiv) emptyDiv.classList.remove('hidden');
        if (basicDiv) basicDiv.classList.add('hidden');
        if (timeDiv) timeDiv.classList.add('hidden');
        if (pointsDiv) pointsDiv.classList.add('hidden');
        if (historyDiv) historyDiv.classList.add('hidden');

        
        showTempMessage('è¯·å…ˆåœ¨ä»»åŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä»»åŠ¡', 'warning');
        return;
      }

      
      const emptyDiv = document.getElementById('mobile-task-details-empty');
      const basicDiv = document.getElementById('mobile-task-details-basic');
      const timeDiv = document.getElementById('mobile-task-details-time');
      const pointsDiv = document.getElementById('mobile-task-details-points');
      const historyDiv = document.getElementById('mobile-task-details-history');

      
      if (emptyDiv) emptyDiv.classList.add('hidden');
      
      if (basicDiv) basicDiv.classList.remove('hidden');
      if (timeDiv) timeDiv.classList.remove('hidden');
      if (pointsDiv) pointsDiv.classList.remove('hidden');
      if (historyDiv) historyDiv.classList.remove('hidden');

      
      const basicList = document.getElementById('mobile-task-details-basic-list');
      if (basicList) {
        
        basicList.innerHTML = '';

        
        const basicInfo = {
          'ä»»åŠ¡åç§°': currentRunData.run_name,
          'ä»»åŠ¡çŠ¶æ€': currentRunData.status == 1 ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ',
          'ä»»åŠ¡ID': currentRunData.errand_id,
          'è®¡åˆ’ID': currentRunData.errand_schedule
        };

        
        Object.entries(basicInfo).forEach(([label, value]) => {
          
          const p = document.createElement('div');
          p.className = 'flex items-start gap-2';
          
          p.innerHTML = `
            <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
            <span class="text-slate-800 break-all flex-1">${value || 'NULL'}</span>
          `;
          basicList.appendChild(p);
        });
      }

      
      const timeList = document.getElementById('mobile-task-details-time-list');
      if (timeList) {
        
        timeList.innerHTML = '';

        
        const timeInfo = {
          'å¼€å§‹æ—¶é—´': currentRunData.start_time,
          'ç»“æŸæ—¶é—´': currentRunData.end_time,
          'ä¸Šä¼ æ—¶é—´': currentRunData.upload_time
        };

        
        Object.entries(timeInfo).forEach(([label, value]) => {
          const p = document.createElement('div');
          p.className = 'flex items-start gap-2';
          p.innerHTML = `
            <span class="font-semibold text-slate-600 min-w-[80px]">${label}:</span>
            <span class="text-slate-800 break-all flex-1">${value || 'NULL'}</span>
          `;
          timeList.appendChild(p);
        });
      }

      
      const pointsList = document.getElementById('mobile-task-details-points-list');
      if (pointsList) {
        
        pointsList.innerHTML = '';

        
        const targetPoints = currentRunData.target_points || [];
        const pointNames = (currentRunData.target_point_names || "").split('|');

        
        if (targetPoints.length > 0) {
          
          targetPoints.forEach((point, index) => {
            
            const name = pointNames[index] || `æ‰“å¡ç‚¹${index + 1}`;

            
            const pointCard = document.createElement('div');
            pointCard.className = 'bg-white border border-purple-200 rounded-lg p-3 space-y-1';
            pointCard.innerHTML = `
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-6 h-6 bg-purple-500 text-white rounded-full text-xs font-bold">${index + 1}</span>
                <span class="font-medium text-slate-800">${name}</span>
              </div>
              <div class="text-xs text-slate-500 pl-8">
                åæ ‡: ${point[0].toFixed(5)}, ${point[1].toFixed(5)}
              </div>
            `;
            pointsList.appendChild(pointCard);
          });
        } else {
          
          pointsList.innerHTML = '<p class="text-slate-400 text-center py-4 text-sm">è¯¥ä»»åŠ¡æš‚æ— æ‰“å¡ç‚¹æ•°æ®</p>';
        }
      }

      
      const historyList = document.getElementById('mobile-task-details-history-list');
      if (historyList) {
        
        historyList.innerHTML = '';

        
        if (currentRunData.history && currentRunData.history.length > 0) {
          
          currentRunData.history.forEach((record, index) => {
            const p = document.createElement('div');
            p.className = 'flex items-start gap-2 pb-2 border-b border-amber-200 last:border-0';
            p.innerHTML = `
              <span class="font-semibold text-slate-600">${index + 1}.</span>
              <span class="text-slate-800 break-all flex-1">${record.time || 'NULL'} - ${record.status || 'æœªçŸ¥çŠ¶æ€'}</span>
            `;
            historyList.appendChild(p);
          });
        } else {
          
          historyList.innerHTML = '<p class="text-slate-400 text-center py-4 text-sm">æš‚æ— å†å²è®°å½•</p>';
        }
      }

      
      showTempMessage('ä»»åŠ¡è¯¦æƒ…åŠ è½½æˆåŠŸ', 'success');
    }

    
    

    
    
    function destroyMobileSingleMap() {
      try {
        if (map) {
          map.destroy();
          map = null;
          console.log('[ç§»åŠ¨ç«¯] å•è´¦å·åœ°å›¾å·²é”€æ¯');
        }
        
        window.mobile_map_panel_initialize_mark = false;

        
        const container = document.getElementById('mobile-map-container');
        if (container) container.innerHTML = '';
      } catch (e) {
        console.warn('[ç§»åŠ¨ç«¯] é”€æ¯å•è´¦å·åœ°å›¾å¤±è´¥:', e);
      }
    }

    
    function destroyMobileMultiMap() {
      try {
        if (multiAccountMap) {
          multiAccountMap.destroy();
          multiAccountMap = null;
          console.log('[ç§»åŠ¨ç«¯] å¤šè´¦å·åœ°å›¾å·²é”€æ¯');
        }
        
        window.mobile_multi_map_panel_initialize_mark = false;

        
        const container = document.getElementById('mobile-multi-map-container');
        if (container) container.innerHTML = '';
      } catch (e) {
        console.warn('[ç§»åŠ¨ç«¯] é”€æ¯å¤šè´¦å·åœ°å›¾å¤±è´¥:', e);
      }
    }
    
    async function initMobileMap(containerId, isMultiAccount = false, retryCount = 0) {
      
      const MAX_RETRIES = 3;
      
      const RETRY_DELAY = 1000;

      
      const container = document.getElementById(containerId);
      if (!container) {
        logMessage_Warning(`[ç§»åŠ¨ç«¯åœ°å›¾] å®¹å™¨ ${containerId} ä¸å­˜åœ¨`);
        
        if (retryCount < MAX_RETRIES) {
          logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å°†åœ¨ ${RETRY_DELAY}ms åé‡è¯• (${retryCount + 1}/${MAX_RETRIES})`);
          setTimeout(() => {
            initMobileMap(containerId, isMultiAccount, retryCount + 1);
          }, RETRY_DELAY);
        }
        return false;
      }

      
      
      const containerStyle = window.getComputedStyle(container);
      const containerWidth = container.offsetWidth;
      const containerHeight = container.offsetHeight;

      if (containerWidth === 0 || containerHeight === 0 || containerStyle.display === 'none') {
        logMessage_Warning(`[ç§»åŠ¨ç«¯åœ°å›¾] å®¹å™¨ ${containerId} ä¸å¯è§æˆ–å°ºå¯¸ä¸º0 (${containerWidth}x${containerHeight})`);
        
        if (retryCount < MAX_RETRIES) {
          logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å°†åœ¨ ${RETRY_DELAY}ms åé‡è¯• (${retryCount + 1}/${MAX_RETRIES})`);
          setTimeout(() => {
            initMobileMap(containerId, isMultiAccount, retryCount + 1);
          }, RETRY_DELAY);
        }
        return false;
      }

      
      if (typeof AMapInstance === 'undefined') {
        logMessage_Error('[ç§»åŠ¨ç«¯åœ°å›¾] é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
        
        container.innerHTML = `
          <div class="absolute inset-0 flex items-center justify-center text-slate-400">
            <div class="text-center">
              <svg class="w-12 h-12 mx-auto mb-2 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p class="text-sm">åœ°å›¾åŠ è½½å¤±è´¥</p>
              <p class="text-xs mt-1">é«˜å¾·åœ°å›¾APIæœªåŠ è½½</p>
            </div>
          </div>
        `;

        
        if (retryCount < MAX_RETRIES) {
          logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å°†åœ¨ ${RETRY_DELAY}ms åé‡è¯•åŠ è½½ (${retryCount + 1}/${MAX_RETRIES})`);
          setTimeout(() => {
            initMobileMap(containerId, isMultiAccount, retryCount + 1);
          }, RETRY_DELAY);
        }
        return false;
      }

      
      container.innerHTML = `
        <div class="absolute inset-0 flex items-center justify-center text-slate-400">
          <div class="text-center">
            <svg class="w-12 h-12 mx-auto mb-2 text-blue-300 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <p class="text-sm">åœ°å›¾åˆå§‹åŒ–ä¸­...</p>
          </div>
        </div>
      `;

      
      if (isMultiAccount) {
        
        
        if (multiAccountMap && multiAccountMap.getZoom) {
          
          const currentContainer = multiAccountMap.getContainer();
          if (currentContainer && currentContainer.id === containerId) {
            logMessage_Info('[ç§»åŠ¨ç«¯åœ°å›¾] å¤šè´¦å·åœ°å›¾å·²åˆå§‹åŒ–ä¸”å®¹å™¨åŒ¹é…ï¼Œæ‰§è¡ŒResizeåˆ·æ–°');
            container.innerHTML = '';
            
            setTimeout(() => {
              multiAccountMap.resize();
            }, 200);
            return true;
          } else {
            logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å¤šè´¦å·åœ°å›¾å®¹å™¨ä¸åŒ¹é… (æ—§: ${currentContainer?.id}, æ–°: ${containerId})ï¼Œæ­£åœ¨é”€æ¯æ—§å®ä¾‹...`);
            try {
              multiAccountMap.destroy();
            } catch (e) {
              console.warn('é”€æ¯å¤šè´¦å·åœ°å›¾å¤±è´¥:', e);
            }
            multiAccountMap = null;
            multiAccountMarkers = {}; 
          }
        }

        logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] åˆå§‹åŒ–å¤šè´¦å·åœ°å›¾å®¹å™¨: ${containerId}`);

        try {
          
          multiAccountMap = new AMapInstance.Map(containerId, {
            zoom: 15, 
            center: [113.390342, 22.527403], 
            mapStyle: 'amap:
          });

          
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('åœ°å›¾åŠ è½½è¶…æ—¶'));
            }, 5000);

            multiAccountMap.on('complete', () => {
              clearTimeout(timeout);
              resolve();
            });
          });

          
          const ctrlBar = new AMapInstance.ControlBar({
            position: { top: '10px', right: '10px' }
          });
          multiAccountMap.addControl(ctrlBar);

          
          try {
            const buildings = new AMapInstance.BuildingLayer();
            buildings.setMap(multiAccountMap);
          } catch (e) {
            logMessage_Warning('[ç§»åŠ¨ç«¯åœ°å›¾] 3Då»ºç­‘å›¾å±‚ä¸å¯ç”¨:', e);
          }

          logMessage_Info('[ç§»åŠ¨ç«¯åœ°å›¾] å¤šè´¦å·åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
          return true;
        } catch (error) {
          logMessage_Error('[ç§»åŠ¨ç«¯åœ°å›¾] å¤šè´¦å·åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);

          
          container.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-sm">åœ°å›¾åˆå§‹åŒ–å¤±è´¥</p>
                <p class="text-xs mt-1">${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
              </div>
            </div>
          `;

          
          if (retryCount < MAX_RETRIES) {
            logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å°†åœ¨ ${RETRY_DELAY}ms åé‡è¯• (${retryCount + 1}/${MAX_RETRIES})`);
            setTimeout(() => {
              initMobileMap(containerId, isMultiAccount, retryCount + 1);
            }, RETRY_DELAY);
          }
          return false;
        }
      } else {
        
        
        if (map && map.getZoom) {
          
          const currentContainer = map.getContainer();
          if (currentContainer && currentContainer.id === containerId) {
            logMessage_Info('[ç§»åŠ¨ç«¯åœ°å›¾] å•è´¦å·åœ°å›¾å·²åˆå§‹åŒ–ä¸”å®¹å™¨åŒ¹é…ï¼Œæ‰§è¡ŒResizeåˆ·æ–°');
            
            container.innerHTML = '';
            
            setTimeout(() => {
              map.resize();
              
              if (typeof drawOnMap === 'function') {
                
              }
            }, 200);
            return true;
          } else {
            logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å•è´¦å·åœ°å›¾å®¹å™¨ä¸åŒ¹é… (æ—§: ${currentContainer?.id}, æ–°: ${containerId})ï¼Œæ­£åœ¨é”€æ¯æ—§å®ä¾‹...`);
            try {
              
              if (runnerMarker) runnerMarker = null;
              
              map.destroy();
            } catch (e) {
              console.warn('é”€æ¯å•è´¦å·åœ°å›¾å¤±è´¥:', e);
            }
            map = null;
            
            markers = [];
            polylines = { recommended: [], draft: null, run: null, history: null };
          }
        }

        logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] åˆå§‹åŒ–å•è´¦å·åœ°å›¾å®¹å™¨: ${containerId}`);

        try {
          
          
          
          if (runnerMarker) {
            runnerMarker = null;
            logMessage_Info('[ç§»åŠ¨ç«¯åœ°å›¾] å·²æ¸…é™¤æ—§çš„runner markerï¼Œå‡†å¤‡ä¸ºæ–°åœ°å›¾åˆ›å»º');
          }

          map = new AMapInstance.Map(containerId, {
            zoom: 15, 
            center: [113.390342, 22.527403], 
            mapStyle: 'amap:
          });

          
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('åœ°å›¾åŠ è½½è¶…æ—¶'));
            }, 5000);

            map.on('complete', () => {
              clearTimeout(timeout);
              resolve();
            });
          });

          
          const ctrlBar = new AMapInstance.ControlBar({
            position: { top: '10px', right: '10px' }
          });
          map.addControl(ctrlBar);

          
          try {
            const buildings = new AMapInstance.BuildingLayer();
            buildings.setMap(map);
          } catch (e) {
            logMessage_Warning('[ç§»åŠ¨ç«¯åœ°å›¾] 3Då»ºç­‘å›¾å±‚ä¸å¯ç”¨:', e);
          }

          logMessage_Info('[ç§»åŠ¨ç«¯åœ°å›¾] å•è´¦å·åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
          return true;
        } catch (error) {
          logMessage_Error('[ç§»åŠ¨ç«¯åœ°å›¾] å•è´¦å·åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);

          
          container.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center text-slate-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-sm">åœ°å›¾åˆå§‹åŒ–å¤±è´¥</p>
                <p class="text-xs mt-1">${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
              </div>
            </div>
          `;

          
          if (retryCount < MAX_RETRIES) {
            logMessage_Info(`[ç§»åŠ¨ç«¯åœ°å›¾] å°†åœ¨ ${RETRY_DELAY}ms åé‡è¯• (${retryCount + 1}/${MAX_RETRIES})`);
            setTimeout(() => {
              initMobileMap(containerId, isMultiAccount, retryCount + 1);
            }, RETRY_DELAY);
          }
          return false;
        }
      }
    }




    
    async function loadMobileTaskHistoryPanel() {
      const listContainer = document.getElementById('mobile-task-history-list');
      const infoDiv = document.getElementById('mobile-history-task-info');

      if (!listContainer) return;

      
      if (selectedTaskIndex === -1 || !currentRunData || !currentRunData.run_name) {
        listContainer.innerHTML = '<p class="text-slate-400 text-center py-8 text-sm">è¯·å…ˆåœ¨ä»»åŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä»»åŠ¡</p>';
        if (infoDiv) infoDiv.textContent = 'æœªé€‰æ‹©ä»»åŠ¡';
        return;
      }

      
      if (infoDiv) infoDiv.textContent = `ä»»åŠ¡: ${currentRunData.run_name}`;

      listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const result = await callPythonAPI('get_task_history', selectedTaskIndex);

        if (result.success && result.history && result.history.length > 0) {
          listContainer.innerHTML = '';

          result.history.forEach((rec, idx) => {
            const item = document.createElement('div');
            item.className = 'bg-white rounded-lg p-3 border border-amber-100 shadow-sm mb-2';
            item.innerHTML = `
              <div class="flex justify-between items-center mb-1">
                <span class="text-xs font-bold text-slate-600">#${idx + 1}</span>
                <span class="text-xs text-slate-400">${rec.time}</span>
              </div>
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-xs text-slate-500">è·ç¦»</p>
                  <p class="text-sm font-bold text-emerald-600">${rec.len}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500">ç”¨æ—¶</p>
                  <p class="text-sm font-bold text-sky-600">${rec.used_time}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500">é…é€Ÿ</p>
                  <p class="text-sm font-bold text-purple-600">${rec.speed}</p>
                </div>
              </div>
              <button class="w-full mt-2 py-1 text-xs bg-slate-50 text-slate-600 rounded border border-slate-200 hover:bg-slate-100" 
                onclick="showHistoricalTrack('${rec.trid}')">
                æŸ¥çœ‹è½¨è¿¹
              </button>
            `;
            listContainer.appendChild(item);
          });
        } else {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10 text-sm">æš‚æ— å†å²è®°å½•</p>';
        }
      } catch (e) {
        console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:", e);
        listContainer.innerHTML = `<p class="text-red-500 text-center py-8 text-sm">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }





    
    function switchMobileSinglePanel(panelId) {
      
      
      
      const singleModePanels = [
        'mobile-control-panel',
        'mobile-map-panel',
        'mobile-task-panel',
        'mobile-task-details-panel',
        'mobile-notification-panel',
        'mobile-log-panel',
        'mobile-checkpoints-panel',
        'mobile-attendance-panel',
        'mobile-admin-panel',
        'mobile-settings-panel',
        'mobile-profile-panel',
        'mobile-task-history-panel' 
      ];

      
      
      
      
      
      
      
      singleModePanels.forEach(id => {
        
        const panel = document.getElementById(id);
        
        if (panel) {
          
          
          panel.style.display = 'none';
        }
      });

      
      
      const targetPanel = document.getElementById(panelId);
      
      if (targetPanel) {
        
        
        
        targetPanel.style.display = '';

        
        
        
        if (panelId === 'mobile-control-panel') {
          
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»æ§åˆ¶é¢æ¿');
          if (!window.mobile_map_panel_initialize_mark) {
            switchMobileSinglePanel('mobile-map-panel');
            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] é¦–æ¬¡æ¿€æ´»æ§åˆ¶é¢æ¿ï¼Œåˆå§‹åŒ–åœ°å›¾...');
            setTimeout(function () {

              
              window.mobile_map_panel_initialize_mark = true;

              initMobileMap('mobile-map-container', false);
            }, 200);
            setTimeout(function () {
              switchMobileSinglePanel('mobile-control-panel');
            }, 400);
            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œè¿”å›æ§åˆ¶é¢æ¿');
          }
        }

        
        
        
        if (panelId === 'mobile-settings-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»è®¾ç½®é¢æ¿ï¼Œå¼€å§‹åŠ è½½é…ç½®...');
          
          const mobileParamsContainer = document.getElementById('mobile-params-container');
          
          if (mobileParamsContainer && typeof pythonParams !== 'undefined' && typeof updateParamInputs === 'function') {
            
            
            
            
            
            updateParamInputs(mobileParamsContainer, 'mobile-param', pythonParams);
            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] è®¾ç½®é¢æ¿é…ç½®å·²è‡ªåŠ¨åŠ è½½');
          } else {
            
            logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] æ— æ³•åŠ è½½é…ç½®ï¼šå®¹å™¨æˆ–å‡½æ•°æœªå®šä¹‰');
          }

          
          if (typeof refreshMobileSettings === 'function') {
            refreshMobileSettings();
            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] è®¾ç½®é¢æ¿å·²è‡ªåŠ¨åˆ·æ–°');
          } else {
            logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] refreshMobileSettingså‡½æ•°æœªå®šä¹‰');
          }
        }

        
        
        
        if (panelId === 'mobile-map-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»åœ°å›¾é¢æ¿ï¼Œåˆå§‹åŒ–åœ°å›¾...');
          
          
          
          
          
          
          




          
          
          
          
          
          if (currentRunData && currentRunData.run_coords && currentRunData.run_coords.length > 0) {
            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] å¼€å§‹ç»˜åˆ¶ä»»åŠ¡è·¯å¾„å’Œæ‰“å¡ç‚¹...');
            if (typeof drawOnMap === 'function') {

              drawOnMap();

              drawOnMap(); 
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] ä»»åŠ¡è·¯å¾„å’Œæ‰“å¡ç‚¹å·²ç»˜åˆ¶');
              ensureRunnerMarker();
            }
          } else {
            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ— ä»»åŠ¡æ•°æ®ï¼Œè·³è¿‡ç»˜åˆ¶');
          }

          
          
          
          
          
          
          
          
        }

        
        
        
        if (panelId === 'mobile-attendance-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»ç­¾åˆ°é¢æ¿ï¼Œå¼€å§‹åŠ è½½é…ç½®...');
          
          setTimeout(() => {
            
            
            const attendanceEnabled = document.getElementById('mobile-attendance-enabled');
            if (attendanceEnabled && typeof pythonParams !== 'undefined') {
              
              
              attendanceEnabled.checked = pythonParams.attendance_enabled !== false;
            }

            
            
            const attendanceTime = document.getElementById('mobile-attendance-time');
            if (attendanceTime && typeof pythonParams !== 'undefined') {
              
              attendanceTime.value = pythonParams.attendance_time || '08:00';
            }

            
            
            
            const attendanceDelayMin = document.getElementById('mobile-attendance-delay-min');
            const attendanceDelayMax = document.getElementById('mobile-attendance-delay-max');
            if (attendanceDelayMin && attendanceDelayMax && typeof pythonParams !== 'undefined') {
              
              
              attendanceDelayMin.value = pythonParams.attendance_delay_min || 0;
              attendanceDelayMax.value = pythonParams.attendance_delay_max || 300;
            }

            
            
            const autoRefreshInterval = document.getElementById('mobile-param-auto_attendance_refresh_s');
            if (autoRefreshInterval && typeof pythonParams !== 'undefined') {
              
              autoRefreshInterval.value = pythonParams.auto_attendance_refresh_s || 60;
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] è‡ªåŠ¨åˆ·æ–°é—´éš”å·²åŠ è½½:', autoRefreshInterval.value, 'ç§’');
            }

            
            
            const userRadius = document.getElementById('mobile-param-attendance_user_radius_m');
            if (userRadius && typeof pythonParams !== 'undefined') {
              
              userRadius.value = pythonParams.attendance_user_radius_m || 0;
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] ç­¾åˆ°éšæœºåŠå¾„å·²åŠ è½½:', userRadius.value, 'ç±³');
            }

            logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] ç­¾åˆ°é¢æ¿é…ç½®å·²è‡ªåŠ¨åŠ è½½');

            refreshNotificationsUI(true, true);
          }, 50); 
        }

        
        
        
        if (panelId === 'mobile-task-details-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»ä»»åŠ¡è¯¦æƒ…é¢æ¿ï¼Œå¼€å§‹åŠ è½½ä»»åŠ¡è¯¦æƒ…...');
          
          setTimeout(() => {
            
            if (typeof loadMobileTaskDetails === 'function') {
              
              loadMobileTaskDetails();
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] ä»»åŠ¡è¯¦æƒ…å·²è‡ªåŠ¨åŠ è½½');
            } else {
              
              logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] loadMobileTaskDetailså‡½æ•°æœªå®šä¹‰');
            }
          }, 50);
        }

        
        
        
        if (panelId === 'mobile-profile-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»ç”¨æˆ·è¯¦æƒ…é¢æ¿ï¼Œå¼€å§‹åŠ è½½ç”¨æˆ·è¯¦æƒ…...');
          
          setTimeout(() => {
            
            if (typeof loadMobileUserDetails === 'function') {
              
              loadMobileUserDetails();
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] ç”¨æˆ·è¯¦æƒ…å·²è‡ªåŠ¨åŠ è½½');
            } else {
              
              logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] loadMobileUserDetailså‡½æ•°æœªå®šä¹‰');
            }
          }, 50);
        }

        
        
        
        if (panelId === 'mobile-admin-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»ç®¡ç†é¢æ¿ï¼Œå¼€å§‹åˆå§‹åŒ–...');
          
          
          if (typeof initMobileAdminPanel === 'function') {
            initMobileAdminPanel('mobile-admin-panel');
          } else {
            logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] initMobileAdminPanelå‡½æ•°æœªå®šä¹‰');
          }
        }

        
        if (panelId === 'mobile-notification-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»é€šçŸ¥é¢æ¿ï¼Œè‡ªåŠ¨åˆ·æ–°...');
          setTimeout(() => {
            mobileRefreshNotifications();
          }, 50);
        }

        if (panelId === 'mobile-task-history-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»å†å²è®°å½•é¢æ¿...');
          setTimeout(() => {
            loadMobileTaskHistoryPanel();
          }, 50);
        }

        
        if (panelId === 'mobile-task-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»ä»»åŠ¡åˆ—è¡¨é¢æ¿ï¼Œè‡ªåŠ¨åˆ·æ–°ä»»åŠ¡...');
          setTimeout(() => {
            if (typeof mobileRefreshTasks === 'function') {
              mobileRefreshTasks();
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] ä»»åŠ¡åˆ—è¡¨å·²è‡ªåŠ¨åˆ·æ–°');
            } else {
              logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] mobileRefreshTaskså‡½æ•°æœªå®šä¹‰');
            }
          }, 50);
        }

        
        if (panelId === 'mobile-checkpoints-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ¿€æ´»æ‰“å¡ç‚¹é¢æ¿ï¼Œè‡ªåŠ¨æ¸²æŸ“æ‰“å¡ç‚¹åˆ—è¡¨...');
          setTimeout(() => {
            if (typeof renderMobileCheckpointsList === 'function') {
              renderMobileCheckpointsList();
              logMessage_Info('[ç§»åŠ¨ç«¯å•è´¦å·] æ‰“å¡ç‚¹åˆ—è¡¨å·²è‡ªåŠ¨æ¸²æŸ“');
            } else {
              logMessage_Warning('[ç§»åŠ¨ç«¯å•è´¦å·] renderMobileCheckpointsListå‡½æ•°æœªå®šä¹‰');
            }
          }, 50);
        }

        
        
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        
        
        logMessage_Warning(`[ç§»åŠ¨ç«¯å•è´¦å·] æ‰¾ä¸åˆ°IDä¸º ${panelId} çš„é¢æ¿`);
      }

      
      
      
      updateMobileNavActiveState(panelId);   
      updateMobileSidebarActive(panelId);     
    }

    
    function switchMobileMulitPanel(panelId, mode = 'multi') {
      
      const singleModePanels = [
        'mobile-control-panel',
        'mobile-map-panel',
        'mobile-task-panel',
        'mobile-task-details-panel',   
        'mobile-notification-panel',
        'mobile-log-panel',            
        'mobile-checkpoints-panel',    
        'mobile-attendance-panel',
        'mobile-admin-panel',          
        'mobile-settings-panel',
        'mobile-profile-panel'         
      ];

      const multiModePanels = [
        'mobile-multi-account-panel',
        'mobile-multi-map-panel',
        'mobile-multi-control-panel',
        'mobile-multi-admin-panel',    
        'mobile-multi-settings-panel',
        'mobile-multi-log-panel'       
      ];

      
      
      const panelList = mode === 'single' ? singleModePanels : multiModePanels;

      
      
      
      
      
      
      panelList.forEach(id => {
        
        const panel = document.getElementById(id);
        
        if (panel) {
          
          
          panel.style.display = 'none';
        }
      });

      
      
      const targetPanel = document.getElementById(panelId);
      
      if (targetPanel) {
        
        
        
        
        
        targetPanel.style.display = '';

        if (panelId === 'mobile-multi-control-panel') {
          logMessage_Info('[ç§»åŠ¨ç«¯å¤šè´¦å·] æ¿€æ´»å¤šè´¦å·æ§åˆ¶é¢æ¿');
          if (!window.mobile_multi_map_panel_initialize_mark) {
            switchMobileMulitPanel('mobile-multi-map-panel');
            logMessage_Info('[ç§»åŠ¨ç«¯å¤šè´¦å·] é¦–æ¬¡æ¿€æ´»å¤šè´¦å·æ§åˆ¶é¢æ¿ï¼Œåˆå§‹åŒ–åœ°å›¾...');
            setTimeout(function () {

              
              window.mobile_multi_map_panel_initialize_mark = true;

              initMobileMap('mobile-multi-map-container', true);
            }, 200);
            setTimeout(function () {
              switchMobileMulitPanel('mobile-multi-control-panel');
            }, 400);
            logMessage_Info('[ç§»åŠ¨ç«¯å¤šè´¦å·] å¤šè´¦å·åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œè¿”å›æ§åˆ¶é¢æ¿');
          }
        }

        
        
        if (panelId === 'mobile-settings-panel') {
          console.log('[ç§»åŠ¨ç«¯] æ¿€æ´»è®¾ç½®é¢æ¿ï¼Œå¼€å§‹åŠ è½½é…ç½®...');
          const mobileParamsContainer = document.getElementById('mobile-params-container');
          
          if (mobileParamsContainer && typeof pythonParams !== 'undefined' && typeof updateParamInputs === 'function') {
            
            updateParamInputs(mobileParamsContainer, 'mobile-param', pythonParams);
            console.log('[ç§»åŠ¨ç«¯] è®¾ç½®é¢æ¿é…ç½®å·²è‡ªåŠ¨åŠ è½½');
          } else {
            console.warn('[ç§»åŠ¨ç«¯] æ— æ³•åŠ è½½é…ç½®ï¼šå®¹å™¨æˆ–å‡½æ•°æœªå®šä¹‰');
          }
        }

        
        if (panelId === 'mobile-multi-settings-panel') {
          console.log('[ç§»åŠ¨ç«¯] æ¿€æ´»å¤šè´¦å·å…¨å±€è®¾ç½®é¢æ¿ï¼Œå¼€å§‹åŠ è½½é…ç½®...');
          const mobileMultiParamsContainer = document.getElementById('mobile-multi-global-params-container');
          if (mobileMultiParamsContainer && typeof pythonParams !== 'undefined' && typeof updateParamInputs === 'function') {
            updateParamInputs(mobileMultiParamsContainer, 'mobile-multi-param', pythonParams);
            console.log('[ç§»åŠ¨ç«¯] å¤šè´¦å·å…¨å±€è®¾ç½®é¢æ¿é…ç½®å·²è‡ªåŠ¨åŠ è½½');
          }
        }

        
        
        
        
        
        
        
        
        
        
        
        
        

        
        if (panelId === 'mobile-multi-map-panel') {
          console.log('[ç§»åŠ¨ç«¯] æ¿€æ´»å¤šè´¦å·åœ°å›¾é¢æ¿ï¼Œåˆå§‹åŒ–åœ°å›¾...');
          setTimeout(() => {
            
            
            
            
            
            
            
            
          }, 100);
        }

        
        
        
        
        
        
        
        
        
        
        

        
        
        
        
        
        

        
        
        
        
        
        
        
        

        
        
        
        
        
        
        
        

        
        
        
        
        
        
        
        

        
        
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        if (panelId === 'mobile-admin-panel') {
          console.log('[ç§»åŠ¨ç«¯] æ¿€æ´»ç®¡ç†é¢æ¿ï¼Œå¼€å§‹åˆå§‹åŒ–...');
          
          
          if (typeof initMobileAdminPanel === 'function') {
            initMobileAdminPanel('mobile-admin-panel');
          } else {
            console.warn('[ç§»åŠ¨ç«¯] initMobileAdminPanelå‡½æ•°æœªå®šä¹‰');
          }
        }

        
        
        
        
        
        
        if (panelId === 'mobile-multi-admin-panel') {
          console.log('[ç§»åŠ¨ç«¯] æ¿€æ´»å¤šè´¦å·ç®¡ç†é¢æ¿ï¼Œå¼€å§‹åˆå§‹åŒ–...');
          
          
          if (typeof initMobileAdminPanel === 'function') {
            initMobileAdminPanel('mobile-multi-admin-panel');
          } else {
            console.warn('[ç§»åŠ¨ç«¯] initMobileAdminPanelå‡½æ•°æœªå®šä¹‰');
          }
        }

        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        console.warn(`æ‰¾ä¸åˆ°IDä¸º ${panelId} çš„é¢æ¿`);
      }

      
      updateMobileNavActiveState(panelId);

      
      updateMobileSidebarActive(panelId);
    }

    
    function switchMobilePanel(panelId, mode = 'multi') {
      return switchMobileMulitPanel(panelId, mode);
    }

    
    function scrollToMobileSection(sectionId) {
      
      const section = document.getElementById(sectionId);

      
      if (section) {
        
        
        
        section.scrollIntoView({
          behavior: 'smooth',  
          block: 'start'       
        });

        
        updateMobileNavActiveState(sectionId);
      } else {
        
        console.warn(`æ‰¾ä¸åˆ°IDä¸º ${sectionId} çš„é¢æ¿`);
      }
    }

    
    function updateMobileNavActiveState(activeSectionId) {
      
      const navButtons = document.querySelectorAll('.mobile-nav-btn');

      
      const sectionNavMap = {
        'mobile-control-panel': 'control',
        'mobile-map-panel': 'map',
        'mobile-task-panel': 'task',
        'mobile-notification-panel': 'notifications',
        'mobile-attendance-panel': 'attendance',
        'mobile-settings-panel': 'settings',
        'mobile-multi-account-panel': 'accounts',
        'mobile-multi-control-panel': 'control',
        'mobile-multi-map-panel': 'map',
        'mobile-multi-settings-panel': 'settings'
      };

      
      const targetNav = sectionNavMap[activeSectionId];

      
      navButtons.forEach(btn => {
        
        const navType = btn.getAttribute('data-nav');

        
        if (navType === targetNav) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    
    function updateMobileSidebarActive(panelId) {
      
      
      
      const panelToMenuText = {
        
        'mobile-control-panel': 'æ§åˆ¶',
        'mobile-map-panel': 'åœ°å›¾',
        'mobile-task-panel': 'ä»»åŠ¡',
        'mobile-notification-panel': 'é€šçŸ¥',
        'mobile-log-panel': 'æ—¥å¿—',
        'mobile-checkpoints-panel': 'æ‰“å¡ç‚¹',
        'mobile-attendance-panel': 'ç­¾åˆ°',
        'mobile-admin-panel': 'ç®¡ç†',
        'mobile-settings-panel': 'è®¾ç½®',
        'mobile-profile-panel': 'æˆ‘çš„',
        'mobile-task-details-panel': 'ä»»åŠ¡è¯¦æƒ…',
        'mobile-task-history-panel': 'å†å²è®°å½•',
        
        'mobile-multi-control-panel': 'æ§åˆ¶',
        'mobile-multi-map-panel': 'åœ°å›¾',
        'mobile-multi-account-panel': 'è´¦å·',
        'mobile-multi-admin-panel': 'ç®¡ç†',
        'mobile-multi-settings-panel': 'è®¾ç½®',
        'mobile-multi-log-panel': 'æ—¥å¿—'
      };

      
      const targetMenuText = panelToMenuText[panelId];

      
      if (!targetMenuText) {
        console.log(`[ä¾§è¾¹æ active] é¢æ¿ ${panelId} æ²¡æœ‰å¯¹åº”çš„ä¾§è¾¹æ èœå•é¡¹`);
        
        const sidebarItems = document.querySelectorAll('.mobile-sidebar-item');
        sidebarItems.forEach(item => {
          item.classList.remove('mobile-sidebar-active');
          item.style.backgroundColor = '';
          item.style.color = '';
          item.style.fontWeight = '';
        });
        return;
      }

      
      
      
      let targetSidebar;
      if (panelId.includes('multi')) {
        
        targetSidebar = document.getElementById('mobile-sidebar-multi-account');
      } else {
        
        targetSidebar = document.getElementById('mobile-sidebar-single-account');
      }

      if (!targetSidebar) {
        console.warn(`[ä¾§è¾¹æ active] æ‰¾ä¸åˆ°å¯¹åº”çš„ä¾§è¾¹æ å®¹å™¨`);
        return;
      }

      
      const sidebarItems = targetSidebar.querySelectorAll('.mobile-sidebar-item');

      
      sidebarItems.forEach(item => {
        
        const span = item.querySelector('span');
        if (span) {
          const menuText = span.textContent.trim();

          
          if (menuText === targetMenuText) {
            item.classList.add('mobile-sidebar-active');
            
            item.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'; 
            item.style.color = '#3b82f6'; 
            item.style.fontWeight = '600'; 
          } else {
            
            item.classList.remove('mobile-sidebar-active');
            item.style.backgroundColor = '';
            item.style.color = '';
            item.style.fontWeight = '';
          }
        }
      });

      console.log(`[ä¾§è¾¹æ active] å·²æ›´æ–°activeçŠ¶æ€: ${targetMenuText} (é¢æ¿: ${panelId})`);
    }


    
    async function openMobileAccountParams(username) {
      if (!username) return;

      
      const modal = document.getElementById('mobile-account-params-modal');
      const titleEl = document.getElementById('mobile-account-params-title');
      const container = document.getElementById('mobile-account-params-container');
      const saveBtn = document.getElementById('mobile-save-account-params-btn');

      if (!modal || !container) return;

      
      container.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';
      modal.classList.remove('hidden');

      if (titleEl) titleEl.textContent = `[${username}] å‚æ•°è®¾ç½®`;

      try {
        
        const result = await callPythonAPI('multi_get_account_params', username);
        if (!result.success) {
          showModalAlert(result.message);
          modal.classList.add('hidden');
          return;
        }

        
        
        
        createParamInputs(container, 'mobile-acc-param', () => { }, ['ä¸»é¢˜ä¸å¤–è§‚']);
        updateParamInputs(container, 'mobile-acc-param', result.params);

        
        if (saveBtn) {
          saveBtn.onclick = async () => {
            showTempMessage('æ­£åœ¨ä¿å­˜...', 'info');
            const inputs = container.querySelectorAll('input, select');
            try {
              for (const input of inputs) {
                const key = input.dataset.key;
                if (!key) continue;
                const value = input.type === 'checkbox' ? input.checked : input.value;
                await callPythonAPI('multi_update_account_param', username, key, value);
              }
              showTempMessage('è®¾ç½®å·²ä¿å­˜', 'success');
              closeMobileAccountParams();
            } catch (e) {
              showTempMessage('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
          };
        }

      } catch (e) {
        container.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${e.message}</p>`;
      }
    }

    

    
    function mobileZoomIn() {
      if (map) {
        map.zoomIn();
      }
    }

    
    function mobileZoomOut() {
      if (map) {
        map.zoomOut();
      }
    }

    
    function mobileFitView() {
      if (map && markers && markers.length > 0) {
        map.setFitView(markers, false, [50, 50, 50, 50]);
      }
    }

    
    function resetMobileMapView() {
      
      if (map) {
        
        if (markers && markers.length > 0) {
          
          map.setFitView(markers, false, [50, 50, 50, 50]);
          console.log('[å•è´¦å·åœ°å›¾] å¤ä½è§†è§’ï¼šè‡ªåŠ¨é€‚åº”æ‰€æœ‰æ ‡è®°ç‚¹');
        } else {
          
          
          const defaultCenter = [116.397128, 39.916527]; 
          const defaultZoom = 11; 

          
          map.setCenter(defaultCenter);
          map.setZoom(defaultZoom);
          console.log('[å•è´¦å·åœ°å›¾] å¤ä½è§†è§’ï¼šé‡ç½®åˆ°é»˜è®¤ä½ç½®');
        }
      } else {
        
        console.warn('[å•è´¦å·åœ°å›¾] æ— æ³•å¤ä½è§†è§’ï¼šåœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–');
      }
    }

    
    function mobileMultiZoomIn() {
      if (multiAccountMap) {
        multiAccountMap.zoomIn();
      }
    }

    
    function mobileMultiZoomOut() {
      if (multiAccountMap) {
        multiAccountMap.zoomOut();
      }
    }

    
    function mobileMultiFitView() {
      if (multiAccountMap) {
        const allOverlays = multiAccountMap.getAllOverlays();
        if (allOverlays && allOverlays.length > 0) {
          multiAccountMap.setFitView(allOverlays, false, [50, 50, 50, 50]);
        }
      }
    }

    
    function resetMultiMapView() {
      
      if (multiAccountMap) {
        
        const allOverlays = multiAccountMap.getAllOverlays();

        
        if (allOverlays && allOverlays.length > 0) {
          
          multiAccountMap.setFitView(allOverlays, false, [50, 50, 50, 50]);
          console.log('[å¤šè´¦å·åœ°å›¾] å¤ä½è§†è§’ï¼šè‡ªåŠ¨é€‚åº”æ‰€æœ‰è·¯çº¿');
        } else {
          
          
          
          const defaultCenter = [113.390342, 22.527403]; 
          const defaultZoom = 11; 

          
          multiAccountMap.setCenter(defaultCenter);
          multiAccountMap.setZoom(defaultZoom);
          console.log('[å¤šè´¦å·åœ°å›¾] å¤ä½è§†è§’ï¼šé‡ç½®åˆ°æŒ‡å®šä½ç½® [113.390342, 22.527403]');
        }
      } else {
        
        console.warn('[å¤šè´¦å·åœ°å›¾] æ— æ³•å¤ä½è§†è§’ï¼šåœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–');
      }
    }

    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    

    
    function clearMobileLog() {
      
      const mobileLogText = document.getElementById('mobile-log-text');
      if (mobileLogText) {
        
        mobileLogText.value = '';
        console.log('[ç§»åŠ¨ç«¯] æ—¥å¿—å·²æ¸…ç©º');
      }
    }

    
    function syncUAToMobile(uaText) {
      
      const mobileUALabel = document.getElementById('mobile-ua-label');
      if (mobileUALabel) {
        
        mobileUALabel.textContent = uaText || '(æœªåŠ è½½)';
        console.log('[ç§»åŠ¨ç«¯] UAå·²åŒæ­¥:', uaText);
      }
    }

    
    
    async function loadMobileCaptcha(formType) {
      
      
      
      const displayId = formType === 'login' ? 'mobile-login-captcha-display' : 'mobile-register-captcha-display';
      const displayElement = document.getElementById(displayId);

      
      
      if (!displayElement) {
        console.log(`[ç§»åŠ¨ç«¯éªŒè¯ç ] æœªæ‰¾åˆ°éªŒè¯ç æ˜¾ç¤ºå…ƒç´ : ${displayId}`);
        return;
      }

      
      const captchaId = captchaIds[formType];

      if (!captchaId) {
        
        
        displayElement.innerHTML = '<span class="text-slate-400 text-xs">ç­‰å¾…åŠ è½½...</span>';
        console.log(`[ç§»åŠ¨ç«¯éªŒè¯ç ] captchaIdå°šæœªç”Ÿæˆï¼Œç­‰å¾…PCç«¯åŠ è½½: ${formType}`);
        return;
      }

      
      const captchaDims = captchaDimensions[formType] || { width: 343, height: 119 };

      
      
      

      const viewportWidth = window.innerWidth || document.documentElement.clientWidth; 
      const padding = 80 + 40; 
      const availableWidth = viewportWidth - padding; 

      
      
      const needsScaling = availableWidth < captchaDims.width;
      const targetWidth = needsScaling ? Math.floor(availableWidth) : captchaDims.width;
      const scaleFactor = needsScaling ? (targetWidth / captchaDims.width) : 1;
      const targetHeight = Math.floor(captchaDims.height * scaleFactor);

      console.log(`[ç§»åŠ¨ç«¯éªŒè¯ç ç¼©æ”¾] å±å¹•å®½åº¦${viewportWidth}pxï¼Œå¯ç”¨${availableWidth}pxï¼ŒéªŒè¯ç åŸå§‹${captchaDims.width}x${captchaDims.height}pxï¼Œç›®æ ‡${targetWidth}x${targetHeight}px`);

      
      
      
      
      
      const timestamp = Date.now();  
      let iframeSrc = `/api/captcha/html/${captchaId}?t=${timestamp}`;

      
      if (needsScaling) {
        iframeSrc += `&width=${targetWidth}`;
      }

      
      
      
      
      
      const iframeHtml = `
        <iframe 
          src="${iframeSrc}"
          style="width: ${targetWidth}px; height: ${targetHeight}px; border: none; overflow: hidden; display: block; max-width: 100%;"
          scrolling="no"
          frameborder="0"
          title="éªŒè¯ç ">
        </iframe>
      `;

      
      displayElement.innerHTML = iframeHtml;

      console.log(`[ç§»åŠ¨ç«¯éªŒè¯ç ] ã€CDNç¼“å­˜ä¿®å¤ã€‘${formType}è¡¨å•éªŒè¯ç åŒæ­¥æˆåŠŸï¼Œå¤ç”¨ID: ${captchaId.substring(0, 8)}... (æ—¶é—´æˆ³: ${timestamp})`);
    }

    

    
    
    let isPhoneLogin = false;

    document.addEventListener('DOMContentLoaded', function () {
      
      const usernameBtn = document.getElementById('auth-login-username-btn');
      const phoneBtn = document.getElementById('auth-login-phone-btn');
      
      const authInput = document.getElementById('auth-username');
      
      const authLabel = document.getElementById('auth-login-label');
      
      const authUsernameContainer = document.getElementById('auth-username-container');

      if (usernameBtn && phoneBtn) {
        
        usernameBtn.addEventListener('click', function () {
          
          isPhoneLogin = false;
          
          usernameBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          phoneBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          
          authInput.type = 'text';
          authInput.placeholder = 'è¯·è¾“å…¥ç”¨æˆ·å';
          authInput.removeAttribute('inputmode'); 
          authInput.removeAttribute('maxlength'); 
          
          if (authLabel) authLabel.textContent = 'ç”¨æˆ·å';

          
          
          if (authUsernameContainer) {
            
            const currentValue = authInput.value;
            
            authUsernameContainer.innerHTML = `
              <input type="text" id="auth-username" class="input-field mt-1" 
                     placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
            `;
            
            const newAuthInput = document.getElementById('auth-username');
            newAuthInput.value = currentValue;
            newAuthInput.removeAttribute('maxlength'); 
          }

          
          const switchToSms = document.getElementById('auth-switch-to-sms');
          if (switchToSms) switchToSms.classList.add('hidden');

          
          const passwordSection = document.getElementById('auth-password-section');
          const smsSection = document.getElementById('auth-sms-section');
          if (passwordSection) passwordSection.classList.remove('hidden');
          if (smsSection) smsSection.classList.add('hidden');
        });

        
        phoneBtn.addEventListener('click', function () {
          
          isPhoneLogin = true;
          
          phoneBtn.className = 'px-4 py-2 rounded-lg bg-sky-100 text-sky-700 font-semibold text-sm';
          usernameBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm';

          
          authInput.type = 'tel';
          authInput.placeholder = 'è¯·è¾“å…¥æ‰‹æœºå·';
          authInput.setAttribute('inputmode', 'numeric'); 
          authInput.setAttribute('maxlength', '11'); 
          
          if (authLabel) authLabel.textContent = 'æ‰‹æœºå·';

          
          
          if (authUsernameContainer) {
            
            const currentValue = authInput.value;
            
            authUsernameContainer.innerHTML = `
              <div class="phone-input-wrapper mt-1">
                <span class="phone-prefix">+86 </span>
                <input type="tel" id="auth-username" class="input-field" 
                       placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel" inputmode="numeric" maxlength="11">
              </div>
            `; 
            
            document.getElementById('auth-username').value = currentValue;
          }

          
          const switchToSms = document.getElementById('auth-switch-to-sms');
          if (switchToSms) switchToSms.classList.remove('hidden');
        });
      }

      
      const switchToSms = document.getElementById('auth-switch-to-sms');
      const switchToPassword = document.getElementById('auth-switch-to-password');
      const passwordSection = document.getElementById('auth-password-section');
      const smsSection = document.getElementById('auth-sms-section');

      if (switchToSms) {
        switchToSms.addEventListener('click', function () {
          passwordSection.classList.add('hidden');
          smsSection.classList.remove('hidden');
        });
      }

      if (switchToPassword) {
        switchToPassword.addEventListener('click', function () {
          smsSection.classList.add('hidden');
          passwordSection.classList.remove('hidden');
        });
      }

      
      const sendLoginCodeBtn = document.getElementById('auth-send-login-code');
      if (sendLoginCodeBtn) {
        sendLoginCodeBtn.addEventListener('click', async function () {
          const phone = document.getElementById('auth-username').value;
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
            return;
          }

          sendLoginCodeBtn.disabled = true;
          const originalText = sendLoginCodeBtn.textContent;

          try {
            
            const response = await fetch('/api/sms/send_code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': sessionUUID
              },
              body: JSON.stringify({
                phone: phone,
                scene: 'login' 
              })
            });
            const result = await response.json();

            if (result && result.success) {
              const expireMin = result.expire_minutes || 5;
              const retryAfter = result.retry_after || 180;
              showTempMessage(`éªŒè¯ç å·²å‘é€ï¼Œ${expireMin}åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

              let countdown = retryAfter;
              const timer = setInterval(() => {
                countdown--;
                sendLoginCodeBtn.textContent = countdown + 'ç§’';
                if (countdown <= 0) {
                  clearInterval(timer);
                  sendLoginCodeBtn.disabled = false;
                  sendLoginCodeBtn.textContent = originalText;
                }
              }, 1000);
            } else {
              if (result?.retry_after) {
                const retrySeconds = result.retry_after;
                let countdown = retrySeconds;
                sendLoginCodeBtn.textContent = countdown + 'ç§’';
                const timer = setInterval(() => {
                  countdown--;
                  sendLoginCodeBtn.textContent = countdown + 'ç§’';
                  if (countdown <= 0) {
                    clearInterval(timer);
                    sendLoginCodeBtn.disabled = false;
                    sendLoginCodeBtn.textContent = originalText;
                  }
                }, 1000);
              } else {
                sendLoginCodeBtn.disabled = false;
              }
              showModalAlert(result?.message || 'å‘é€å¤±è´¥');
            }
          } catch (error) {
            sendLoginCodeBtn.disabled = false;
            showModalAlert('å‘é€å¤±è´¥: ' + error.message);
          }
        });
      }

      
      const regUsernameInput = document.getElementById('auth-reg-username');
      if (regUsernameInput) {
        regUsernameInput.addEventListener('input', function (e) {
          
          const value = e.target.value;
          const noChinese = value.replace(/[ä¸€-é¾¥]/g, '');
          if (value !== noChinese) {
            e.target.value = noChinese;
            showTempMessage('ç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦', 'warning');
          }
        });
      }

      
      const avatarInput = document.getElementById('auth-reg-avatar');
      if (avatarInput) {
        
        avatarInput.addEventListener('change', function (e) {
          if (typeof previewAvatarForRegistration === 'function') {
            previewAvatarForRegistration(e);
          } else {
            console.error("previewAvatarForRegistration å‡½æ•°å°šæœªåŠ è½½");
          }
        });
      }

      
      const sendCodeBtn = document.getElementById('auth-reg-send-code-btn');
      if (sendCodeBtn) {
        sendCodeBtn.addEventListener('click', async function () {
          const phone = document.getElementById('auth-reg-phone').value;

          
          if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
            return;
          }

          
          openCaptchaModal({
            phone: phone,
            button: sendCodeBtn,
            originalText: sendCodeBtn.textContent
          });
        });
      }

      
      
      

      
      const loginCaptchaRefreshBtn = document.getElementById('auth-login-captcha-refresh');
      if (loginCaptchaRefreshBtn) {
        loginCaptchaRefreshBtn.addEventListener('click', function (e) {
          e.preventDefault();  
          refreshCaptcha('login');
        });
      }

      
      const loginCaptchaDisplay = document.getElementById('auth-login-captcha-display');
      if (loginCaptchaDisplay) {
        loginCaptchaDisplay.addEventListener('click', function () {
          refreshCaptcha('login');
        });
      }

      
      const registerCaptchaRefreshBtn = document.getElementById('auth-register-captcha-refresh');
      if (registerCaptchaRefreshBtn) {
        registerCaptchaRefreshBtn.addEventListener('click', function (e) {
          e.preventDefault();  
          refreshCaptcha('register');
        });
      }

      
      const registerCaptchaDisplay = document.getElementById('auth-register-captcha-display');
      if (registerCaptchaDisplay) {
        registerCaptchaDisplay.addEventListener('click', function () {
          refreshCaptcha('register');
        });
      }

      
      
      const authLoginContainer = document.getElementById('auth-login-container');
      if (authLoginContainer && !authLoginContainer.classList.contains('hidden')) {
        
        setTimeout(() => {
          loadCaptcha('login');
          loadCaptcha('register');
        }, 100);
      }
    });

    
    function modifyPhone() {
      const currentPhone = document.getElementById('profile-phone').value;
      document.getElementById('modify-phone-current').value = currentPhone;
      document.getElementById('modify-phone-new').value = '';
      document.getElementById('modify-phone-code').value = '';
      document.getElementById('modify-phone-modal').style.display = 'flex';
      document.body.classList.add('modal-visible'); 


      const currentPhoneInput = document.getElementById('modify-phone-current');
      const currentPhoneWrapper = currentPhoneInput ? currentPhoneInput.closest('.phone-input-wrapper') : null;
      if (currentPhoneWrapper) {
        const prefix = currentPhoneWrapper.querySelector('.phone-prefix');
        
        const isUnbound = (!currentPhoneInput.value || currentPhoneInput.value === 'æœªç»‘å®š');

        if (prefix) {
          prefix.style.display = isUnbound ? 'none' : 'inline';
        }
        
        currentPhoneWrapper.classList.toggle('prefix-hidden', isUnbound);
      }

    }

    function closeModifyPhoneModal() {
      document.getElementById('modify-phone-modal').style.display = 'none';
      
    }

    
    async function sendModifyPhoneCode() {
      
      const newPhone = document.getElementById('modify-phone-new').value;

      
      if (!newPhone || !/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ–°æ‰‹æœºå·');
        return;
      }

      
      
      
      const btn = document.getElementById('modify-phone-send-btn');
      const originalText = btn.textContent;

      
      
      openCaptchaModal({
        phone: newPhone,
        button: btn,
        originalText: originalText,
        scene: 'modify' 
      });

      logMessage_Info('[ä¿®æ”¹æ‰‹æœºå·] å·²æ‰“å¼€å›¾å½¢éªŒè¯ç æ¨¡æ€æ¡†');
    }




    async function confirmModifyPhone() {
      const newPhone = document.getElementById('modify-phone-new').value;
      const code = document.getElementById('modify-phone-code').value;



      
      if (!/^1[3-9]\d{9}$/.test(newPhone)) {
        showModalAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ–°æ‰‹æœºå·æ ¼å¼');
        return;
      }

      
      try {
        
        const bindResult = await callPythonAPI_raw('/api/auth/check_phone', 'POST', { phone: newPhone });

        
        if (bindResult && bindResult.is_bound && bindResult.bound_to_user !== currentAuthUsername) {
          
          const confirmed = await jsShowConfirm(
            'æ‰‹æœºå·å·²è¢«ç»‘å®š',
            `æ‚¨è¾“å…¥çš„æ–°æ‰‹æœºå· ${newPhone} å·²è¢«ç”¨æˆ· ${bindResult.bound_to_user} ç»‘å®šã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ\n\nå¦‚æœç»§ç»­ï¼Œè¯¥æ‰‹æœºå·å°†ä»åŸè´¦å·ä¸Šå¼ºåˆ¶è§£ç»‘å¹¶ç»‘å®šåˆ°æ‚¨çš„è´¦å·ä¸Šã€‚`
          );

          if (!confirmed) {
            logMessage_Info("[ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œå› ä¸ºæ‰‹æœºå·å·²è¢«ç»‘å®šã€‚");
            return; 
          }
          logMessage_Info("[ä¿®æ”¹æ‰‹æœºå·] ç”¨æˆ·å·²ç¡®è®¤å¼ºåˆ¶è§£ç»‘ï¼Œç»§ç»­æ“ä½œ...");
        } else if (bindResult && bindResult.is_bound && bindResult.bound_to_user === currentAuthUsername) {
          
          showModalAlert('æ­¤æ‰‹æœºå·å·²ç»‘å®šåˆ°æ‚¨çš„è´¦å·ã€‚', 'æç¤º');
          closeModifyPhoneModal();
          return;
        }
        

        if (!newPhone || !code) {
          showModalAlert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
          return;
        }

      } catch (e) {
        logMessage_Error('æ£€æŸ¥æ‰‹æœºå·ç»‘å®šå¤±è´¥:', e);
        showModalAlert(`æ£€æŸ¥æ‰‹æœºå·å¤±è´¥: ${e.message}ï¼Œè¯·ç¨åé‡è¯•`, 'ç½‘ç»œé”™è¯¯');
        return; 
      }


      try {
        
        const result = await callPythonAPI_raw('/api/user/update_phone', 'POST', {
          new_phone: newPhone,
          sms_code: code
        });

        if (result && result.success) {
          showModalAlert('æ‰‹æœºå·ä¿®æ”¹æˆåŠŸ');
          document.getElementById('profile-phone').value = newPhone;
          closeModifyPhoneModal();
        } else {
          showModalAlert(result?.message || 'ä¿®æ”¹å¤±è´¥');
        }
      } catch (error) {
        showModalAlert('ä¿®æ”¹å¤±è´¥: ' + error.message);
      }
    }

    async function loadSystemConfig() {
      const formContainer = $('admin-config-form');
      formContainer.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        const response = await fetch('/api/admin/config/load', {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (!result.success) {
          formContainer.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½é…ç½®å¤±è´¥: ${result.message}</p>`;
          return;
        }

        const config = result.config;
        formContainer.innerHTML = ''; 

        
        const createInput = (section, key, label, type = 'text', help = '') => {
          const value = config[section]?.[key];
          let inputHtml = '';
          if (type === 'boolean') {
            inputHtml = `
              <select id="config-${section}-${key}" class="select-field">
                <option value="true" ${value === true ? 'selected' : ''}>å¯ç”¨</option>
                <option value="false" ${value === false ? 'selected' : ''}>ç¦ç”¨</option>
              </select>
            `;
          } else if (type === 'number') {
            inputHtml = `<input type="number" id="config-${section}-${key}" value="${value}" class="input-field">`;
          } else if (type === 'password_storage') {
            inputHtml = `
              <select id="config-${section}-${key}" class="select-field">
                <option value="plaintext" ${value === 'plaintext' ? 'selected' : ''}>æ˜æ–‡</option>
                <option value="sha256" ${value === 'sha256' ? 'selected' : ''}>sha256</option>
                <option value="bcrypt" ${value === 'bcrypt' ? 'selected' : ''}>bcrypt(è‡ªåŠ¨åŠ ç›)</option>
              </select>
            `;
          } else {
            inputHtml = `<input type="text" id="config-${section}-${key}" value="${value}" class="input-field">`;
          }

          return `
            <div class="mb-3">
              <label for="config-${section}-${key}" class="block text-sm font-semibold text-slate-700">${label} </label>
              ${inputHtml}
              ${help ? `<p class="text-xs text-slate-500 mt-1">${help}</p>` : ''}
            </div>
          `;
        };

        let html = '';

        
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mb-2">æ¸¸å®¢é…ç½®</h5>';
        html += createInput('Guest', 'allow_guest_login', 'å…è®¸æ¸¸å®¢ç™»å½•', 'boolean', 'æ˜¯å¦å…è®¸æœªæ³¨å†Œç”¨æˆ·ä»¥æ¸¸å®¢èº«ä»½ä½¿ç”¨ç³»ç»Ÿã€‚');

        
        html += '<h5 class="font-bold text-base text-sky-800 border-b pb-1 mt-4 mb-2">ç³»ç»Ÿé…ç½®</h5>';
        html += createInput('System', 'session_expiry_days', 'ä¼šè¯è¿‡æœŸæ—¶é—´ (å¤©)', 'number', 'è¶…è¿‡æ­¤æ—¶é—´æœªè®¿é—®çš„ä¼šè¯å°†è¢«è‡ªåŠ¨æ¸…ç†ã€‚');
        html += createInput('System', 'school_accounts_dir', 'å­¦æ ¡è´¦å·ç›®å½•', 'text', 'å­˜å‚¨ school_accounts
    async function loadCaptchaSettings() {
      try {
        console.log('[éªŒè¯ç è®¾ç½®] å¼€å§‹åŠ è½½éªŒè¯ç é…ç½®å‚æ•°...');

        
        
        if (window.initialData && window.initialData.captcha_settings) {
          
          const settings = window.initialData.captcha_settings;
          $('captcha-length').value = settings.length || 4;
          $('captcha-scale-factor').value = settings.scale_factor || 2;
          $('captcha-noise-level').value = settings.noise_level || 0.08;

          console.log('[éªŒè¯ç è®¾ç½®] å·²ä»ç¼“å­˜åŠ è½½é…ç½®:', settings);
        } else {
          
          const response = await callPythonAPI('get_initial_data');
          if (response && response.captcha_settings) {
            const settings = response.captcha_settings;
            $('captcha-length').value = settings.length || 4;
            $('captcha-scale-factor').value = settings.scale_factor || 2;
            $('captcha-noise-level').value = settings.noise_level || 0.08;

            console.log('[éªŒè¯ç è®¾ç½®] å·²ä»APIåŠ è½½é…ç½®:', settings);
          } else {
            console.warn('[éªŒè¯ç è®¾ç½®] æœªèƒ½è·å–é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
          }
        }
      } catch (error) {
        console.error('[éªŒè¯ç è®¾ç½®] åŠ è½½é…ç½®å¤±è´¥:', error);
        
      }
    }

    
    async function saveCaptchaSettings() {
      try {
        console.log('[éªŒè¯ç è®¾ç½®] å¼€å§‹ä¿å­˜éªŒè¯ç é…ç½®...');

        
        const length = parseInt($('captcha-length').value);
        const scale_factor = parseInt($('captcha-scale-factor').value);
        const noise_level = parseFloat($('captcha-noise-level').value);

        
        if (isNaN(length) || length < 3 || length > 6) {
          Swal.fire({
            icon: 'error',
            title: 'å‚æ•°é”™è¯¯',
            text: 'éªŒè¯ç é•¿åº¦å¿…é¡»åœ¨3-6ä¹‹é—´'
          });
          return;
        }

        if (isNaN(scale_factor) || scale_factor < 2 || scale_factor > 4) {
          Swal.fire({
            icon: 'error',
            title: 'å‚æ•°é”™è¯¯',
            text: 'ç»†åˆ†å€æ•°å¿…é¡»åœ¨2-4ä¹‹é—´'
          });
          return;
        }

        if (isNaN(noise_level) || noise_level < 0 || noise_level > 0.3) {
          Swal.fire({
            icon: 'error',
            title: 'å‚æ•°é”™è¯¯',
            text: 'å™ªç‚¹æ¯”ä¾‹å¿…é¡»åœ¨0.0-0.3ä¹‹é—´'
          });
          return;
        }

        console.log('[éªŒè¯ç è®¾ç½®] å‚æ•°éªŒè¯é€šè¿‡:', { length, scale_factor, noise_level });

        
        const response = await fetch('/api/captcha/save_settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          credentials: 'include',
          body: JSON.stringify({
            length,
            scale_factor,
            noise_level
          })
        });

        const result = await response.json();

        
        if (result && result.success) {
          console.log('[éªŒè¯ç è®¾ç½®] ä¿å­˜æˆåŠŸ');
          Swal.fire({
            icon: 'success',
            title: 'ä¿å­˜æˆåŠŸ',
            text: 'éªŒè¯ç è®¾ç½®å·²ä¿å­˜',
            timer: 2000,
            showConfirmButton: false
          });

          
          if (window.initialData) {
            window.initialData.captcha_settings = { length, scale_factor, noise_level };
          }
        } else {
          throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        console.error('[éªŒè¯ç è®¾ç½®] ä¿å­˜å¤±è´¥:', error);
        Swal.fire({
          icon: 'error',
          title: 'ä¿å­˜å¤±è´¥',
          text: error.message || 'æ— æ³•ä¿å­˜éªŒè¯ç è®¾ç½®'
        });
      }
    }

    
    async function testGenerateCaptcha() {
      try {
        console.log('[éªŒè¯ç è®¾ç½®] å¼€å§‹æµ‹è¯•ç”ŸæˆéªŒè¯ç ...');

        
        const length = parseInt($('captcha-length').value);
        const scale_factor = parseInt($('captcha-scale-factor').value);
        const noise_level = parseFloat($('captcha-noise-level').value);

        
        if (isNaN(length) || length < 3 || length > 6) {
          Swal.fire({
            icon: 'error',
            title: 'å‚æ•°é”™è¯¯',
            text: 'éªŒè¯ç é•¿åº¦å¿…é¡»åœ¨3-6ä¹‹é—´'
          });
          return;
        }

        if (isNaN(scale_factor) || scale_factor < 2 || scale_factor > 4) {
          Swal.fire({
            icon: 'error',
            title: 'å‚æ•°é”™è¯¯',
            text: 'ç»†åˆ†å€æ•°å¿…é¡»åœ¨2-4ä¹‹é—´'
          });
          return;
        }

        if (isNaN(noise_level) || noise_level < 0 || noise_level > 0.3) {
          Swal.fire({
            icon: 'error',
            title: 'å‚æ•°é”™è¯¯',
            text: 'å™ªç‚¹æ¯”ä¾‹å¿…é¡»åœ¨0.0-0.3ä¹‹é—´'
          });
          return;
        }

        

        
        const response = await fetch('/api/captcha/test_generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          credentials: 'include',
          body: JSON.stringify({
            length,
            scale_factor,
            noise_level
          })
        });

        const result = await response.json();

        
        if (result && result.success) {
          console.log('[éªŒè¯ç è®¾ç½®] æµ‹è¯•ç”ŸæˆæˆåŠŸï¼ŒéªŒè¯ç :', result.code);

          
          $('captcha-test-preview').classList.remove('hidden');

          
          const displayContainer = $('captcha-preview-display');

          
          const captchaWidth = result.width || 343;   
          const captchaHeight = result.height || 119; 

          const timestamp = Date.now();

          const iframeHtml = `
            <iframe 
              src="/api/captcha/html/${result.captcha_id}?t=${timestamp}"
              style="max-width: ${captchaWidth}px; max-height: ${captchaHeight}px; width: 100%; height: ${captchaHeight}px; border: none; overflow: hidden; display: block; margin: 0 auto;"
              scrolling="no"
              frameborder="0"
              title="éªŒè¯ç é¢„è§ˆ">
            </iframe>
          `;

          displayContainer.innerHTML = iframeHtml;

          
          $('captcha-preview-answer').textContent = result.code;

          console.log('[éªŒè¯ç è®¾ç½®] é¢„è§ˆåŒºåŸŸå·²æ›´æ–° (iframeæ¨¡å¼)');
        } else {
          throw new Error(result?.message || 'ç”Ÿæˆå¤±è´¥');
        }
      } catch (error) {
        console.error('[éªŒè¯ç è®¾ç½®] æµ‹è¯•ç”Ÿæˆå¤±è´¥:', error);
        Swal.fire({
          icon: 'error',
          title: 'ç”Ÿæˆå¤±è´¥',
          text: error.message || 'æ— æ³•ç”Ÿæˆæµ‹è¯•éªŒè¯ç '
        });
      }
    }

    
    
    
    
    document.addEventListener('DOMContentLoaded', function () {
      
      const saveCaptchaSettingsBtn = $('save-captcha-settings-btn');
      if (saveCaptchaSettingsBtn) {
        saveCaptchaSettingsBtn.addEventListener('click', saveCaptchaSettings);
        console.log('[éªŒè¯ç è®¾ç½®] å·²æ³¨å†Œä¿å­˜æŒ‰é’®äº‹ä»¶');
      }

      
      const testCaptchaBtn = $('test-captcha-btn');
      if (testCaptchaBtn) {
        testCaptchaBtn.addEventListener('click', testGenerateCaptcha);
        console.log('[éªŒè¯ç è®¾ç½®] å·²æ³¨å†Œæµ‹è¯•æŒ‰é’®äº‹ä»¶');
      }

      
      const refreshCaptchaHistoryBtn = $('refresh-captcha-history-btn');
      if (refreshCaptchaHistoryBtn) {
        refreshCaptchaHistoryBtn.addEventListener('click', loadCaptchaHistory);
        console.log('[éªŒè¯ç å†å²] å·²æ³¨å†Œåˆ·æ–°æŒ‰é’®äº‹ä»¶');
      }
    });

    
    async function loadCaptchaHistory() {
      const listContainer = $('admin-captcha-list_modal'); 
      if (!listContainer) {
        console.error("æ‰¾ä¸åˆ°å®¹å™¨ admin-captcha-list_modal");
        return;
      }
      listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const dateInput = $('captcha-history-date');
        const statusSelect = $('captcha-history-status');

        if (!dateInput || !statusSelect) return;

        const date = dateInput.value.replace(/-/g, ''); 
        const status = statusSelect.value;

        
        const params = new URLSearchParams({ date });
        if (status) {
          params.append('status', status);
        }

        const response = await fetch(`/api/captcha/history?${params}`, {
          headers: { 'X-Session-ID': sessionUUID }
        });
        const result = await response.json();

        if (!result.success) {
          listContainer.innerHTML = `<p class="text-red-500 text-center py-10">${result.message}</p>`;
          return;
        }

        const records = result.data || [];

        
        const total = records.length;
        const success = records.filter(r => r.status === 'verified_success').length;
        const failed = records.filter(r => r.status === 'verified_failed').length;
        const pending = records.filter(r => r.status === 'created').length;
        const expired = records.filter(r => r.status === 'expired').length;
        const testGenerated = records.filter(r => r.status === 'test_generated').length;

        const statTotal = $('captcha-stat-total');
        const statSuccess = $('captcha-stat-success');
        const statFailed = $('captcha-stat-failed');
        const statPending = $('captcha-stat-pending');
        const statExpired = $('captcha-stat-expired');
        const statTestGenerated = $('captcha-stat-test');

        if (statTotal) statTotal.textContent = total;
        if (statSuccess) statSuccess.textContent = success;
        if (statFailed) statFailed.textContent = failed;
        if (statPending) statPending.textContent = pending;
        if (statExpired) statExpired.textContent = expired;
        if (statTestGenerated) statTestGenerated.textContent = testGenerated;

        if (records.length === 0) {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">è¯¥æ—¥æœŸæ²¡æœ‰éªŒè¯ç è®°å½•</p>';
          return;
        }

        
        listContainer.innerHTML = '';
        records.forEach(record => {
          
          const statusClass = {
            'created': 'bg-yellow-100 text-yellow-800',
            'verified_success': 'bg-green-100 text-green-800',
            'verified_failed': 'bg-red-100 text-red-800',
            'expired': 'bg-gray-100 text-gray-800'
          }[record.status] || 'bg-gray-100 text-gray-800';

          const statusText = {
            'created': 'å¾…éªŒè¯',
            'verified_success': 'éªŒè¯æˆåŠŸ',
            'verified_failed': 'éªŒè¯å¤±è´¥',
            'expired': 'å·²è¿‡æœŸ',
            'test_generated': 'æµ‹è¯•ç”Ÿæˆ'
          }[record.status] || record.status;

          const itemDiv = document.createElement('div');
          itemDiv.className = 'p-3 bg-white border border-slate-200 rounded-lg hover:shadow-md transition-shadow mb-2';
          itemDiv.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-mono text-sm text-slate-600">ID: ${record.captcha_id ? record.captcha_id : 'N/A'}</span>
                  <span class="px-2 py-0.5 text-xs rounded ${statusClass}">${statusText}</span>
                </div>
                <div class="text-xs text-slate-500 space-y-0.5">
                  <div>éªŒè¯ç : <span class="font-semibold text-slate-700 font-mono">${record.code}</span></div>
                  <div>åˆ›å»ºæ—¶é—´: ${record.timestamp_readable || new Date(record.timestamp * 1000).toLocaleString('zh-CN')}</div>
                  ${record.verified_at_readable ? `<div>éªŒè¯æ—¶é—´: ${record.verified_at_readable}</div>` : ''}
                  ${record.verified_input ? `<div>ç”¨æˆ·è¾“å…¥: <span class="${record.status === 'verified_success' ? 'text-green-600' : 'text-red-600'} font-semibold">${record.verified_input}</span></div>` : ''}
                  <div>å®¢æˆ·ç«¯IP: ${record.client_ip || 'N/A'}</div>
                </div>
              </div>
              <button onclick="showCaptchaDetail('${record.captcha_id}')" 
                class="text-sm text-blue-600 hover:text-blue-800 ml-2 bg-blue-50 px-2 py-1 rounded">
                è¯¦æƒ…
              </button>
            </div>
            ${record.html ? `
              <div class="mt-2 pt-2 border-t border-slate-100">
                <div class="text-xs text-slate-500 mb-1">éªŒè¯ç å›¾ç‰‡:</div>
                <div class="flex items-center justify-center bg-slate-50 p-2 rounded overflow-hidden">
                  <div class="scale-75 origin-center">${record.html}</div>
                </div>
              </div>
            ` : ''}
          `;
          listContainer.appendChild(itemDiv);
        });

        console.log(`[éªŒè¯ç å†å²] å·²åŠ è½½ ${records.length} æ¡è®°å½•`);
      } catch (e) {
        console.error('[éªŒè¯ç å†å²] åŠ è½½å¤±è´¥:', e);
        listContainer.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½éªŒè¯ç å†å²æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}</p>`;
      }
    }


    
    function showCaptchaDetail(captchaId) {
      console.log('æ˜¾ç¤ºéªŒè¯ç è¯¦æƒ…:', captchaId);

      
      

      fetch(`/api/captcha/detail/${captchaId}`, { 
        headers: {
          'X-Session-ID': sessionUUID
        }
      })
        .then(response => response.json())
        .then(result => {
          
          if (result.success && result.data) {
            
            const captcha = result.data; 

            if (captcha) {
              
              populateCaptchaDetailModal(captcha);
              
              const modal = $('captcha-detail-modal');
              if (modal) {
                modal.classList.remove('hidden');
                document.body.classList.add('modal-visible');
              }
            } else {
              
              showModalAlert('æœªæ‰¾åˆ°è¯¥éªŒè¯ç çš„è¯¦ç»†ä¿¡æ¯');
            }
          } else {
            showModalAlert('è·å–éªŒè¯ç è¯¦æƒ…å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
          }
        })
        .catch(error => {
          console.error('[éªŒè¯ç è¯¦æƒ…] è·å–å¤±è´¥:', error);
          showModalAlert('è·å–éªŒè¯ç è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error.message);
        });
    }
    
    function populateCaptchaDetailModal(captcha) {
      
      $('detail-captcha-id').textContent = captcha.captcha_id || '-';
      $('detail-code').textContent = captcha.code || '-';

      
      const statusElement = $('detail-status');
      const statusConfig = {
        'created': { text: 'å¾…éªŒè¯', class: 'bg-yellow-100 text-yellow-800' },
        'verified_success': { text: 'éªŒè¯æˆåŠŸ', class: 'bg-green-100 text-green-800' },
        'verified_failed': { text: 'éªŒè¯å¤±è´¥', class: 'bg-red-100 text-red-800' },
        'expired': { text: 'å·²è¿‡æœŸ', class: 'bg-gray-100 text-gray-800' },
        'test_generated': { text: 'æµ‹è¯•ç”Ÿæˆ', class: 'bg-blue-100 text-blue-800' }
      };
      const statusInfo = statusConfig[captcha.status] || { text: captcha.status, class: 'bg-gray-100 text-gray-800' };
      statusElement.textContent = statusInfo.text;
      statusElement.className = `px-2 py-1 text-xs rounded ${statusInfo.class}`;

      
      $('detail-created-time').textContent = captcha.timestamp_readable ||
        new Date(captcha.timestamp * 1000).toLocaleString('zh-CN');

      
      const verifiedTimeContainer = $('detail-verified-time-container');
      if (captcha.verified_at_readable) {
        $('detail-verified-time').textContent = captcha.verified_at_readable;
        verifiedTimeContainer.classList.remove('hidden');
      } else {
        verifiedTimeContainer.classList.add('hidden');
      }

      
      const expiredTimeContainer = $('detail-expired-time-container');
      if (captcha.expired_at_readable) {
        $('detail-expired-time').textContent = captcha.expired_at_readable;
        expiredTimeContainer.classList.remove('hidden');
      } else {
        expiredTimeContainer.classList.add('hidden');
      }

      
      const verificationCard = $('detail-verification-card');
      if (captcha.verified_input) {
        $('detail-user-input').textContent = captcha.verified_input;
        $('detail-user-input').className = captcha.status === 'verified_success'
          ? 'font-mono font-bold text-green-600'
          : 'font-mono font-bold text-red-600';

        const resultText = captcha.status === 'verified_success'
          ? 'âœ… éªŒè¯æˆåŠŸ'
          : 'âŒ éªŒè¯å¤±è´¥';
        const resultClass = captcha.status === 'verified_success'
          ? 'text-green-600 font-semibold'
          : 'text-red-600 font-semibold';
        $('detail-verification-result').textContent = resultText;
        $('detail-verification-result').className = resultClass;

        verificationCard.classList.remove('hidden');
      } else {
        verificationCard.classList.add('hidden');
      }

      
      $('detail-client-ip').textContent = captcha.client_ip || 'N/A';
      $('detail-user-agent').textContent = captcha.user_agent || 'N/A';

      
      const imageCard = $('detail-captcha-image-card');
      const htmlContainer = $('detail-captcha-html');
      if (captcha.html) {
        htmlContainer.innerHTML = captcha.html;
        imageCard.classList.remove('hidden');
      } else {
        htmlContainer.innerHTML = '<p class="text-slate-400">éªŒè¯ç å›¾ç‰‡ä¸å¯ç”¨</p>';
        imageCard.classList.add('hidden');
      }
    }

    
    function closeCaptchaDetailModal() {
      const modal = $('captcha-detail-modal');
      if (modal) {
        modal.classList.add('hidden');
        
      }
    }

    
    
    
    

    
    async function loadReminders() {
      
      const listContainer = $('admin-reminders-list_modal');

      
      listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';

      try {
        
        const response = await fetch('/api/reminders/list', {
          method: 'GET',
          headers: {
            'X-Session-ID': sessionUUID  
          }
        });

        
        const result = await response.json();

        
        if (!result.success) {
          
          listContainer.innerHTML = `<p class="text-red-500 text-center py-10">${result.message || 'åŠ è½½å¤±è´¥'}</p>`;
          return;
        }

        
        const reminders = result.reminders || [];

        
        const total = reminders.length;
        const enabled = reminders.filter(r => r.enabled).length;
        const disabled = total - enabled;

        
        $('reminder-stat-total').textContent = total;
        $('reminder-stat-enabled').textContent = enabled;
        $('reminder-stat-disabled').textContent = disabled;

        
        if (reminders.length === 0) {
          listContainer.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— æé†’ï¼Œç‚¹å‡»"æ·»åŠ æé†’"åˆ›å»ºæ–°æé†’</p>';
          return;
        }

        
        listContainer.innerHTML = '';

        
        reminders.forEach(reminder => {
          
          const itemDiv = document.createElement('div');
          itemDiv.className = 'p-4 bg-white border border-slate-200 rounded-lg hover:shadow-md transition-shadow';

          
          const isCrossDay = reminder.start_time > reminder.end_time;
          const timeRangeClass = isCrossDay ? 'text-purple-600' : 'text-blue-600';
          const timeRangeIcon = isCrossDay ? 'ğŸŒ™' : 'â˜€ï¸';
          const timeRangeHint = isCrossDay ? 'ï¼ˆè·¨å¤©ï¼‰' : '';

          
          itemDiv.innerHTML = `
            <div class="flex justify-between items-start">
              
              <div class="flex-1">
                
                <div class="flex items-center gap-2 mb-2">
                  <h5 class="font-semibold text-slate-800 text-base">${escapeHtml(reminder.title)}</h5>
                  ${reminder.enabled
              ? '<span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded">å¯ç”¨</span>'
              : '<span class="px-2 py-0.5 text-xs bg-slate-100 text-slate-600 rounded">ç¦ç”¨</span>'}
                </div>

                
                <p class="text-sm text-slate-600 mb-3 line-clamp-2">${escapeHtml(reminder.message)}</p>

                
                <div class="flex items-center gap-2 text-sm ${timeRangeClass}">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>${timeRangeIcon} ${reminder.start_time} - ${reminder.end_time} ${timeRangeHint}</span>
                </div>

                
                <div class="mt-2 text-xs text-slate-400 space-y-0.5">
                  <div>åˆ›å»ºæ—¶é—´: ${formatTimestamp(reminder.created_at)}</div>
                  ${reminder.updated_at && reminder.updated_at !== reminder.created_at
              ? `<div>æ›´æ–°æ—¶é—´: ${formatTimestamp(reminder.updated_at)}</div>`
              : ''}
                </div>
              </div>

              
              <div class="flex flex-col gap-2 ml-4">
                
                <button onclick="openReminderEditModal('${reminder.id}')" 
                  class="btn btn-ghost !py-1 !px-3 text-xs whitespace-nowrap hover:bg-sky-50 hover:text-sky-600"
                  title="ç¼–è¾‘æé†’">
                  <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  ç¼–è¾‘
                </button>

                
                <button onclick="toggleReminderEnabled('${reminder.id}', ${!reminder.enabled})" 
                  class="btn btn-ghost !py-1 !px-3 text-xs whitespace-nowrap ${reminder.enabled ? 'hover:bg-yellow-50 hover:text-yellow-600' : 'hover:bg-green-50 hover:text-green-600'}"
                  title="${reminder.enabled ? 'ç¦ç”¨æé†’' : 'å¯ç”¨æé†’'}">
                  <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="${reminder.enabled ? 'M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}"></path>
                  </svg>
                  ${reminder.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                </button>

                
                <button onclick="deleteReminder('${reminder.id}', '${escapeHtml(reminder.title)}')" 
                  class="btn btn-ghost !py-1 !px-3 text-xs whitespace-nowrap hover:bg-red-50 hover:text-red-600"
                  title="åˆ é™¤æé†’">
                  <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  åˆ é™¤
                </button>
              </div>
            </div>
          `;

          
          listContainer.appendChild(itemDiv);
        });

        console.log(`[å®šæ—¶æé†’] å·²åŠ è½½ ${reminders.length} æ¡æé†’`);

      } catch (error) {
        
        console.error('[å®šæ—¶æé†’] åŠ è½½å¤±è´¥:', error);
        listContainer.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½æé†’æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}</p>`;
      }
    }

    
    async function openReminderEditModal(reminderId = '') {
      
      const modal = $('reminder-edit-modal');
      const title = $('reminder-modal-title');

      
      const idField = $('reminder-id-field');
      const titleField = $('reminder-title-field');
      const messageField = $('reminder-message-field');
      const startTimeField = $('reminder-start-time-field');
      const endTimeField = $('reminder-end-time-field');
      const enabledField = $('reminder-enabled-field');

      if (reminderId) {
        
        title.textContent = 'âœï¸ ç¼–è¾‘å®šæ—¶æé†’';

        try {
          
          const response = await fetch('/api/reminders/list', {
            method: 'GET',
            headers: { 'X-Session-ID': sessionUUID }
          });
          const result = await response.json();

          if (result.success) {
            
            const reminder = result.reminders.find(r => r.id === reminderId);

            if (reminder) {
              
              idField.value = reminder.id;
              titleField.value = reminder.title;
              messageField.value = reminder.message;
              startTimeField.value = reminder.start_time;
              endTimeField.value = reminder.end_time;
              enabledField.checked = reminder.enabled;
            } else {
              showModalAlert('æé†’ä¸å­˜åœ¨', 'é”™è¯¯');
              return;
            }
          }
        } catch (error) {
          console.error('[å®šæ—¶æé†’] åŠ è½½æé†’æ•°æ®å¤±è´¥:', error);
          showModalAlert('åŠ è½½æé†’æ•°æ®å¤±è´¥', 'é”™è¯¯');
          return;
        }
      } else {
        
        title.textContent = 'â° æ·»åŠ å®šæ—¶æé†’';
        idField.value = '';
        titleField.value = '';
        messageField.value = '';
        startTimeField.value = '';
        endTimeField.value = '';
        enabledField.checked = true;
      }

      
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      
      titleField.focus();
    }

    
    function closeReminderEditModal() {
      const modal = $('reminder-edit-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    
    async function saveReminder() {
      
      const id = $('reminder-id-field').value.trim();
      const title = $('reminder-title-field').value.trim();
      const message = $('reminder-message-field').value.trim();
      const startTime = $('reminder-start-time-field').value;
      const endTime = $('reminder-end-time-field').value;
      const enabled = $('reminder-enabled-field').checked;

      

      
      if (!title) {
        showModalAlert('è¯·è¾“å…¥æé†’æ ‡é¢˜', 'é”™è¯¯');
        return;
      }
      if (title.length > 50) {
        showModalAlert('æé†’æ ‡é¢˜ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      
      if (!message) {
        showModalAlert('è¯·è¾“å…¥æé†’å†…å®¹', 'é”™è¯¯');
        return;
      }
      if (message.length > 500) {
        showModalAlert('æé†’å†…å®¹ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦', 'é”™è¯¯');
        return;
      }

      
      if (!startTime || !endTime) {
        showModalAlert('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´', 'é”™è¯¯');
        return;
      }

      
      const timePattern = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timePattern.test(startTime) || !timePattern.test(endTime)) {
        showModalAlert('æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º HH:MMï¼ˆå¦‚ 19:00ï¼‰', 'é”™è¯¯');
        return;
      }

      try {
        
        const isUpdate = !!id;
        const apiUrl = isUpdate ? '/api/reminders/update' : '/api/reminders/add';

        
        const requestData = {
          title: title,
          message: message,
          start_time: startTime,
          end_time: endTime,
          enabled: enabled
        };

        
        if (isUpdate) {
          requestData.id = id;
        }

        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(requestData)
        });

        
        const result = await response.json();

        if (result.success) {
          
          showModalAlert(
            isUpdate ? 'æé†’æ›´æ–°æˆåŠŸ' : 'æé†’æ·»åŠ æˆåŠŸ',
            'æˆåŠŸ',
            'success'
          );

          
          closeReminderEditModal();

          
          loadReminders();
        } else {
          
          showModalAlert(result.message || 'ä¿å­˜å¤±è´¥', 'é”™è¯¯');
        }

      } catch (error) {
        
        console.error('[å®šæ—¶æé†’] ä¿å­˜å¤±è´¥:', error);
        showModalAlert('ä¿å­˜æé†’æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'é”™è¯¯');
      }
    }

    
    async function toggleReminderEnabled(reminderId, newEnabledState) {
      try {
        
        const response = await fetch('/api/reminders/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({
            id: reminderId,
            enabled: newEnabledState
          })
        });

        
        const result = await response.json();

        if (result.success) {
          
          console.log(`[å®šæ—¶æé†’] æé†’çŠ¶æ€å·²æ›´æ–°: ID=${reminderId}, enabled=${newEnabledState}`);
          loadReminders();
        } else {
          
          showModalAlert(result.message || 'æ›´æ–°çŠ¶æ€å¤±è´¥', 'é”™è¯¯');
        }

      } catch (error) {
        
        console.error('[å®šæ—¶æé†’] æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
        showModalAlert('æ›´æ–°æé†’çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'é”™è¯¯');
      }
    }

    
    async function deleteReminder(reminderId, reminderTitle) {
      
      const confirmed = await Swal.fire({
        title: 'ç¡®è®¤åˆ é™¤ï¼Ÿ',
        html: `ç¡®å®šè¦åˆ é™¤æé†’ <strong>${escapeHtml(reminderTitle)}</strong> å—ï¼Ÿ<br><span class="text-sm text-slate-500">æ­¤æ“ä½œä¸å¯æ¢å¤</span>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ç¡®è®¤åˆ é™¤',
        cancelButtonText: 'å–æ¶ˆ',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b'
      });

      
      if (!confirmed.isConfirmed) {
        return;
      }

      try {
        
        const response = await fetch('/api/reminders/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify({ id: reminderId })
        });

        
        const result = await response.json();

        if (result.success) {
          
          showModalAlert('æé†’å·²åˆ é™¤', 'æˆåŠŸ', 'success');

          
          loadReminders();
        } else {
          
          showModalAlert(result.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
        }

      } catch (error) {
        
        console.error('[å®šæ—¶æé†’] åˆ é™¤å¤±è´¥:', error);
        showModalAlert('åˆ é™¤æé†’æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'é”™è¯¯');
      }
    }

    
    function formatTimestamp(timestamp) {
      
      const date = new Date(timestamp * 1000);

      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');

      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    
    
    
    

    
    let shownReminders = new Set();

    
    async function checkAndShowReminders() {
      if (!sessionUUID) {
        sessionUUID = getUUIDFromURL();
        if (!sessionUUID) {
          logMessage_Error("è·³è¿‡æé†’æ£€æŸ¥: sessionUUID æœªå®šä¹‰");
          return;
        }
      }

      try {
        
        const response = await fetch('/api/reminders/check', {
          method: 'GET',
          headers: {
            'X-Session-ID': sessionUUID
          }
        });

        
        const result = await response.json();

        
        if (!result.success) {
          console.error('[å®šæ—¶æé†’] æ£€æŸ¥å¤±è´¥:', result.message);
          return;
        }

        
        const reminders = result.reminders || [];

        
        for (const reminder of reminders) {
          
          if (shownReminders.has(reminder.id)) {
            
            continue;
          }

          
          shownReminders.add(reminder.id);

          
          Swal.fire({
            title: reminder.title,
            html: reminder.message.replace(/\n/g, '<br>'),  
            icon: 'info',
            confirmButtonText: 'çŸ¥é“äº†',
            allowOutsideClick: true,  
            allowEscapeKey: true,     
            customClass: {
              popup: 'reminder-alert-popup',
              title: 'reminder-alert-title',
              htmlContainer: 'reminder-alert-content'
            }
          });

          console.log(`[å®šæ—¶æé†’] å·²æ˜¾ç¤ºæé†’: ${reminder.title}`);
        }

      } catch (error) {
        
        console.error('[å®šæ—¶æé†’] æ£€æŸ¥æé†’æ—¶å‘ç”Ÿé”™è¯¯:', error);
      }
    }

    
    
    
    
    

    
    async function loadSSLInfo() {
      try {
        
        const response = await fetch('/api/admin/ssl/info', {
          method: 'GET',
          headers: {
            'X-Session-ID': sessionUUID,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          
          const sslEnabledToggle = $('ssl-enabled-toggle');
          const httpsOnlyToggle = $('https-only-toggle');

          if (sslEnabledToggle) {
            sslEnabledToggle.checked = data.config.ssl_enabled || false;
          }

          if (httpsOnlyToggle) {
            httpsOnlyToggle.checked = data.config.https_only || false;
          }

          
          updateSSLStatusBadge(data.config.ssl_enabled);

          
          const certInfoContent = $('ssl-cert-info-content');

          if (certInfoContent) {
            
            
            if (data.cert_info && Object.keys(data.cert_info).length > 0 && !data.cert_info.error) {

              let html = '<div class="space-y-2">';

              
              
              if (data.cert_info.error) {
                html += `<div class="text-red-600">âš ï¸ ${data.cert_info.error}</div>`;
                if (data.cert_info.install_hint) {
                  html += `<div class="text-sm text-slate-500">${data.cert_info.install_hint}</div>`;
                }
              } else if (!data.cert_info.subject) {
                
                html += '<p class="text-amber-600 text-center py-4">æ— æ³•è§£æè¯ä¹¦ï¼Œè¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚</p>';
              } else {
                
                if (data.cert_info.subject) {
                  html += `<div class="flex justify-between">
                    <span class="text-slate-600">ä¸»é¢˜ (Subject):</span>
                    <span class="font-mono text-sm">${escapeHtml(data.cert_info.subject)}</span>
                  </div>`;
                }

                if (data.cert_info.issuer) {
                  html += `<div class="flex justify-between">
                    <span class="text-slate-600">é¢å‘è€… (Issuer):</span>
                    <span class="font-mono text-sm">${escapeHtml(data.cert_info.issuer)}</span>
                  </div>`;
                }

                if (data.cert_info.not_before) {
                  html += `<div class="flex justify-between">
                    <span class="text-slate-600">ç”Ÿæ•ˆæ—¥æœŸ:</span>
                    <span class="text-sm">${formatDate(data.cert_info.not_before)}</span>
                  </div>`;
                }

                if (data.cert_info.not_after) {
                  const isExpired = data.cert_info.is_expired || false;
                  const expiryClass = isExpired ? 'text-red-600' : 'text-green-600';
                  html += `<div class="flex justify-between">
                    <span class="text-slate-600">è¿‡æœŸæ—¥æœŸ:</span>
                    <span class="text-sm ${expiryClass}">${formatDate(data.cert_info.not_after)}</span>
                  </div>`;

                  if (isExpired) {
                    html += `<div class="text-red-600 text-sm mt-2">âš ï¸ è¯ä¹¦å·²è¿‡æœŸ</div>`;
                  }
                }

                if (data.cert_info.san && data.cert_info.san.length > 0) {
                  html += `<div class="mt-2">
                    <span class="text-slate-600">åŸŸå (SAN):</span>
                    <div class="mt-1 flex flex-wrap gap-1">`;
                  data.cert_info.san.forEach(domain => {
                    html += `<span class="px-2 py-1 bg-slate-100 rounded text-xs">${escapeHtml(domain)}</span>`;
                  });
                  html += `</div></div>`;
                }
              }

              html += '</div>';
              certInfoContent.innerHTML = html;

            }
            
            else {
              if (data.config.ssl_enabled) {
                
                let errorMsg = "SSLå·²å¯ç”¨ï¼Œä½†è¯ä¹¦è·¯å¾„ä¸ºç©ºæˆ–è¯ä¹¦æ— æ•ˆã€‚";
                if (data.cert_info && data.cert_info.error) {
                  errorMsg = `SSLå·²å¯ç”¨ï¼Œä½†è¯ä¹¦åŠ è½½å¤±è´¥: ${data.cert_info.error}`;
                }
                certInfoContent.innerHTML = `<p class="text-amber-600 text-center py-4">${escapeHtml(errorMsg)}</p>`;
              } else {
                
                certInfoContent.innerHTML = '<p class="text-slate-400 text-center py-4">HTTPS/SSL æœªå¯ç”¨</p>';
              }
            }
          }

          console.log('[SSLç®¡ç†] SSLä¿¡æ¯åŠ è½½æˆåŠŸ');
        } else {
          showTempMessage(data.message || 'SSLä¿¡æ¯åŠ è½½å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('[SSLç®¡ç†] åŠ è½½SSLä¿¡æ¯å¤±è´¥:', error);
        showTempMessage('åŠ è½½SSLä¿¡æ¯å¤±è´¥', 'error');
      }
    }

    
    function updateSSLStatusBadge(sslEnabled) {
      const badge = $('ssl-status-badge');
      if (!badge) return;

      if (sslEnabled) {
        badge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700';
        badge.textContent = 'âœ“ HTTPS å·²å¯ç”¨';
      } else {
        badge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-slate-100 text-slate-600';
        badge.textContent = 'HTTP æ¨¡å¼';
      }
    }

    
    async function uploadSSLCertificate() {
      
      const certFileInput = $('ssl-cert-file-input');
      const keyFileInput = $('ssl-key-file-input');
      const uploadBtn = $('ssl-upload-btn');

      
      if (!certFileInput.files || certFileInput.files.length === 0) {
        showTempMessage('è¯·é€‰æ‹©è¯ä¹¦æ–‡ä»¶', 'error');
        return;
      }
      if (!keyFileInput.files || keyFileInput.files.length === 0) {
        showTempMessage('è¯·é€‰æ‹©å¯†é’¥æ–‡ä»¶', 'error');
        return;
      }

      
      setButtonLoading(uploadBtn, true, 'ä¸Šä¼ ä¸­...');

      try {
        
        const formData = new FormData();
        formData.append('cert_file', certFileInput.files[0]);
        formData.append('key_file', keyFileInput.files[0]);

        
        const response = await fetch('/api/admin/ssl/upload', {
          method: 'POST',
          headers: {
            'X-Session-ID': sessionUUID
          },
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showTempMessage('è¯ä¹¦ä¸Šä¼ æˆåŠŸ', 'success');
          
          certFileInput.value = '';
          keyFileInput.value = '';
          
          await loadSSLInfo();
        } else {
          showTempMessage(data.message || 'è¯ä¹¦ä¸Šä¼ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('[SSLç®¡ç†] ä¸Šä¼ è¯ä¹¦å¤±è´¥:', error);
        showTempMessage('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
      } finally {
        setButtonLoading(uploadBtn, false, 'ä¸Šä¼ è¯ä¹¦');
      }
    }

    
    async function saveSSLConfig() {
      const saveBtn = $('ssl-save-config-btn');
      const sslEnabledToggle = $('ssl-enabled-toggle');
      const httpsOnlyToggle = $('https-only-toggle');

      
      setButtonLoading(saveBtn, true, 'ä¿å­˜ä¸­...');

      try {
        
        const configData = {
          ssl_enabled: sslEnabledToggle.checked,
          https_only: httpsOnlyToggle.checked
        };

        
        const response = await fetch('/api/admin/ssl/config', {
          method: 'POST',
          headers: {
            'X-Session-ID': sessionUUID,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(configData)
        });

        const data = await response.json();

        if (data.success) {
          
          showModalAlert('é…ç½®å·²ä¿å­˜ï¼Œéœ€è¦é‡å¯æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆ', 'ä¿å­˜æˆåŠŸ');
          
          updateSSLStatusBadge(configData.ssl_enabled);
        } else {
          
          showModalAlert(data.message || 'ä¿å­˜é…ç½®å¤±è´¥', 'ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        console.error('[SSLç®¡ç†] ä¿å­˜é…ç½®å¤±è´¥:', error);
        
        showModalAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'ç½‘ç»œé”™è¯¯');
      } finally {
        setButtonLoading(saveBtn, false, 'ä¿å­˜é…ç½®');
      }
    }

    
    function formatDate(isoString) {
      try {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return isoString;
      }
    }

    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    
    
    

    function startReminderChecker() {
      
      checkAndShowReminders();

      
      setInterval(checkAndShowReminders, 60 * 1000);

      console.log('[å®šæ—¶æé†’] å®šæ—¶æ£€æŸ¥å·²å¯åŠ¨ï¼Œæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡');
    }

    
    
    

    
    async function saveSystemConfig() {
      const btn = $('admin-save-config_modal');
      setButtonLoading(btn, true, 'ä¿å­˜ä¸­...');

      try {
        
        const configData = {
          'Guest': {
            'allow_guest_login': $('config-Guest-allow_guest_login').value === 'true'
          },
          'System': {
            'session_expiry_days': parseInt($('config-System-session_expiry_days').value, 10),
            'school_accounts_dir': $('config-System-school_accounts_dir').value,
            'system_accounts_dir': $('config-System-system_accounts_dir').value,
            'permissions_file': $('config-System-permissions_file').value,
            'session_monitor_check_interval': parseInt($('config-System-session_monitor_check_interval').value, 10),
            'session_inactivity_timeout': parseInt($('config-System-session_inactivity_timeout').value, 10)
          },
          'Logging': {
            'log_rotation_size_mb': parseInt($('config-Logging-log_rotation_size_mb').value, 10),
            'archive_max_size_mb': parseInt($('config-Logging-archive_max_size_mb').value, 10),
            'log_dir': $('config-Logging-log_dir').value,
            'archive_dir': $('config-Logging-archive_dir').value
          },
          'Security': {
            'password_storage': $('config-Security-password_storage').value,
            'brute_force_protection': $('config-Security-brute_force_protection').value === 'true',
            'login_log_retention_days': parseInt($('config-Security-login_log_retention_days').value, 10)
          },
          'Map': {
            'amap_js_key': $('config-Map-amap_js_key').value
          },
          
          'API': {
            'ip_api_key': $('config-API-ip_api_key').value
            
          }
        };

        
        const response = await fetch('/api/admin/config/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionUUID
          },
          body: JSON.stringify(configData)
        });

        const result = await response.json();

        if (result.success) {
          showModalAlert('é…ç½®å·²ä¿å­˜ã€‚è¯·æ³¨æ„ï¼Œéƒ¨åˆ†é…ç½®ï¼ˆå¦‚è·¯å¾„ï¼‰éœ€è¦é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆã€‚', 'ä¿å­˜æˆåŠŸ');
          showButtonSuccess(btn, 'ä¿å­˜æˆåŠŸ', 2000);
        } else {
          showModalAlert(`ä¿å­˜å¤±è´¥: ${result.message}`, 'ä¿å­˜å¤±è´¥');
          showButtonError(btn, 'ä¿å­˜å¤±è´¥', 2000);
        }
      } catch (e) {
        showModalAlert(`ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}`, 'ä¿å­˜å¤±è´¥');
        showButtonError(btn, 'ä¿å­˜å¤±è´¥', 2000);
      } finally {
        setButtonLoading(btn, false, 'ä¿å­˜é…ç½®');
      }
    }



    function showTempMessage(msg, type = 'info') {
      
      const colors = {
        success: 'bg-green-100 text-green-700 border-green-300',
        warning: 'bg-amber-100 text-amber-700 border-amber-300',
        error: 'bg-red-100 text-red-700 border-red-300',
        info: 'bg-blue-100 text-blue-700 border-blue-300'
      };

      const div = document.createElement('div');
      div.className = `fixed top-4 right-4 px-4 py-2 rounded-lg border-2 ${colors[type]} z-50 shadow-lg`;
      div.textContent = msg;
      document.body.appendChild(div);

      setTimeout(() => {
        div.remove();
      }, 3000);
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      
      if (typeof window.APP_CONFIG === 'undefined') {
        console.error('APP_CONFIG æœªå®šä¹‰, UIåŠ¨æ€é…ç½®è„šæœ¬è·³è¿‡ã€‚');
        
        window.APP_CONFIG = { sms_enabled: false, reg_verify_enabled: false };
      }

      const config = window.APP_CONFIG;

      
      if (!config.sms_enabled) {
        console.log('çŸ­ä¿¡æœåŠ¡å·²ç¦ç”¨ï¼Œæ­£åœ¨éšè—ç›¸å…³UIå…ƒç´ ...');

        
        const switchToSmsBtn = document.getElementById('auth-switch-to-sms');
        if (switchToSmsBtn) switchToSmsBtn.style.display = 'none';

        
        const smsSection = document.getElementById('auth-sms-section');
        if (smsSection) smsSection.style.display = 'none';

        
        const adminModifySmsGroup = document.getElementById('admin-modify-phone-sms-group');
        if (adminModifySmsGroup) adminModifySmsGroup.style.display = 'none';

        
        const newUserSmsGroup = document.getElementById('newUserSmsGroup');
        if (newUserSmsGroup) newUserSmsGroup.style.display = 'none';
      }

      
      if (!config.reg_verify_enabled) {
        console.log('æ‰‹æœºæ³¨å†Œ/éªŒè¯å·²ç¦ç”¨ï¼Œæ­£åœ¨éšè—ç›¸å…³UIå…ƒç´ ...');

        
        const regPhoneDiv = document.getElementById('auth-reg-phone-wrapper');
        if (regPhoneDiv) regPhoneDiv.style.display = 'none';

        
        const regSmsDiv = document.getElementById('auth-reg-sms-wrapper');
        if (regSmsDiv) regSmsDiv.style.display = 'none';

        
        const profileModifyBtn = document.getElementById('profile-modify-phone-btn');
        if (profileModifyBtn) profileModifyBtn.style.display = 'none';
        const profilePhoneHint = document.getElementById('profile-phone-hint');
        if (profilePhoneHint) profilePhoneHint.style.display = 'none';
      }

      
      
      console.log('[å®šæ—¶æé†’] æ­£åœ¨å¯åŠ¨å®šæ—¶æé†’æ£€æŸ¥å™¨...');
      startReminderChecker();
    });

    
    document.addEventListener('DOMContentLoaded', function () {
      console.log('[ç§»åŠ¨ç«¯] å¼€å§‹ç»‘å®šPhase 4båŠŸèƒ½...');

      
      
      

      
      const mobileRandomUABtn = document.getElementById('mobile-random-ua-btn');
      if (mobileRandomUABtn) {
        mobileRandomUABtn.addEventListener('click', async () => {
          try {
            
            const newUA = await callPythonAPI('generate_new_ua');
            
            const mobileUALabel = document.getElementById('mobile-ua-label');
            if (mobileUALabel) {
              mobileUALabel.textContent = newUA || '(ç”Ÿæˆå¤±è´¥)';
            }
            
            const pcUALabel = document.getElementById('ua-label');
            if (pcUALabel) {
              pcUALabel.textContent = newUA || '(ç”Ÿæˆå¤±è´¥)';
            }
            console.log('[ç§»åŠ¨ç«¯] å·²ç”Ÿæˆæ–°çš„UA:', newUA);
          } catch (error) {
            console.error('[ç§»åŠ¨ç«¯] ç”ŸæˆUAå¤±è´¥:', error);
            showModalAlert('ç”ŸæˆUAå¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        });
        console.log('[ç§»åŠ¨ç«¯] éšæœºUAæŒ‰é’®å·²ç»‘å®š');
      }

      
      
      

      
      const mobileImportBtn = document.getElementById('mobile-import-button');
      if (mobileImportBtn) {
        mobileImportBtn.addEventListener('click', async (e) => {
          
          if (typeof checkButtonPermission === 'function') {
            if (!await checkButtonPermission('mobile-import-button', 'use_import_button')) {
              return;
            }
          }
          
          if (typeof importTask === 'function') {
            await importTask();
          } else {
            console.error('[ç§»åŠ¨ç«¯] importTaskå‡½æ•°æœªå®šä¹‰');
            showModalAlert('å¯¼å…¥åŠŸèƒ½æš‚ä¸å¯ç”¨');
          }
        });
        console.log('[ç§»åŠ¨ç«¯] å¯¼å…¥æŒ‰é’®å·²ç»‘å®š');
      }

      
      
      

      
      
      const mobileParamsContainer = document.getElementById('mobile-params-container');
      if (mobileParamsContainer && typeof createParamInputs === 'function') {
        
        const excludeGroups = ['ä¸»é¢˜è®¾ç½®', 'è‡ªåŠ¨ç­¾åˆ°'];

        
        
        
        createParamInputs(
          mobileParamsContainer,
          'mobile-param',
          function (e) {
            
            const input = e.target;
            const key = input.dataset.key;
            let value;

            
            if (input.type === 'checkbox') {
              value = input.checked;
            } else if (input.type === 'number') {
              value = parseFloat(input.value) || 0;
            } else {
              value = input.value;
            }

            
            if (typeof callPythonAPI === 'function') {
              callPythonAPI('update_param', key, value);
              console.log(`[ç§»åŠ¨ç«¯] å‚æ•°å·²æ›´æ–°: ${key} = ${value}`);
            }
          },
          excludeGroups
        );
        console.log('[ç§»åŠ¨ç«¯] å‚æ•°è®¾ç½®é¢æ¿å·²åˆå§‹åŒ–');
      }

      console.log('[ç§»åŠ¨ç«¯] Phase 4båŠŸèƒ½ç»‘å®šå®Œæˆ');
    });

    
    
    
    document.addEventListener('DOMContentLoaded', function () {
      console.log('[ç§»åŠ¨ç«¯] å¼€å§‹åˆå§‹åŒ–Phase 4då…¨å±€è®¾ç½®é¢æ¿...');

      
      
      const mobileMultiGlobalParamsContainer = document.getElementById('mobile-multi-global-params-container');
      if (mobileMultiGlobalParamsContainer && typeof createParamInputs === 'function') {
        
        const excludeGroups = ['ä¸»é¢˜è®¾ç½®'];

        
        
        
        createParamInputs(
          mobileMultiGlobalParamsContainer,
          'mobile-multi-param',
          function (e) {
            
            const input = e.target;
            const key = input.dataset.key;
            let value;

            
            if (input.type === 'checkbox') {
              value = input.checked;
            } else if (input.type === 'number') {
              value = parseFloat(input.value) || 0;
            } else {
              value = input.value;
            }

            
            if (typeof callPythonAPI === 'function') {
              callPythonAPI('update_param', key, value);
              console.log(`[ç§»åŠ¨ç«¯å¤šè´¦å·] å…¨å±€å‚æ•°å·²æ›´æ–°: ${key} = ${value}`);
            }
          },
          excludeGroups
        );

        
        
        if (typeof pythonParams !== 'undefined' && typeof updateParamInputs === 'function') {
          updateParamInputs(mobileMultiGlobalParamsContainer, 'mobile-multi-param', pythonParams);
          console.log('[ç§»åŠ¨ç«¯] å¤šè´¦å·å…¨å±€å‚æ•°å·²è‡ªåŠ¨å¡«å……é…ç½®æ•°å€¼');
        } else {
          console.warn('[ç§»åŠ¨ç«¯] pythonParamsæˆ–updateParamInputsæœªå®šä¹‰ï¼Œæ— æ³•è‡ªåŠ¨å¡«å……é…ç½®');
        }

        console.log('[ç§»åŠ¨ç«¯] å¤šè´¦å·å…¨å±€å‚æ•°é¢æ¿å·²åˆå§‹åŒ–');
      }

      
      const configSelect = document.getElementById('multi-config-user-select');
      if (configSelect) {
        
        
        if (!configSelect._refreshBound) {
          configSelect.addEventListener('focus', refreshUserList);
          configSelect.addEventListener('click', refreshUserList);
          configSelect._refreshBound = true; 
          console.log('[ç§»åŠ¨ç«¯] é…ç½®æ–‡ä»¶é€‰æ‹©å™¨å·²ç»‘å®šè‡ªåŠ¨åˆ·æ–°äº‹ä»¶');
        }

        
        if (typeof refreshUserList === 'function') {
          refreshUserList();
          console.log('[ç§»åŠ¨ç«¯] é…ç½®æ–‡ä»¶é€‰æ‹©å™¨å·²æ‰§è¡Œåˆå§‹åˆ·æ–°');
        }
      }

      console.log('[ç§»åŠ¨ç«¯] Phase 4då…¨å±€è®¾ç½®é¢æ¿åˆå§‹åŒ–å®Œæˆ');
    });

    

    

    
    function toggleMobileMultiAdminPanel(show) {
      
      const modal = document.getElementById('mobile-multi-admin-panel-modal');

      
      if (modal) {
        if (show) {
          
          modal.classList.remove('hidden');
          
          initMobileAdminPanel('mobile-multi-admin');
        } else {
          
          modal.classList.add('hidden');
        }
      }
    }

    
    function initMobileAdminPanel(prefix) {
      
      const userGroup = currentUserData?.group || 'user';

      
      
      
      
      
      
      let tabsNavId, contentId;

      if (prefix === 'mobile-multi-admin') {
        
        tabsNavId = 'mobile-multi-admin-tabs-nav';
        contentId = 'mobile-multi-admin-panel-content';
      } else if (prefix === 'mobile-multi-admin-panel') {
        
        
        tabsNavId = 'mobile-multi-admin-tabs-nav-panel';
        contentId = 'mobile-multi-admin-content-panel';
      } else if (prefix === 'mobile-admin-panel') {
        
        tabsNavId = 'mobile-admin-tabs-nav-panel';
        contentId = 'mobile-admin-panel-content-panel';
      } else {
        
        tabsNavId = 'mobile-admin-tabs-nav';
        contentId = 'mobile-admin-panel-content';
      }

      
      const tabsNav = document.getElementById(tabsNavId);
      if (!tabsNav) {
        console.error(`[ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿] æ‰¾ä¸åˆ°æ ‡ç­¾é¡µå¯¼èˆªå®¹å™¨: ${tabsNavId}`);
        return;
      }

      
      
      const allTabs = [
        {
          id: 'users',
          label: 'ç”¨æˆ·',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
          permission: 'admin'  
        },
        {
          id: 'groups',
          label: 'æƒé™ç»„',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>',
          permission: 'admin'  
        },
        {
          id: 'logs',
          label: 'æ—¥å¿—',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
          permission: 'admin'  
        },
        {
          id: 'health',
          label: 'çŠ¶æ€',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>',
          permission: 'all'    
        },
        {
          id: 'profile',
          label: 'èµ„æ–™',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',
          permission: 'all'    
        },
        {
          id: 'sessions',
          label: 'ä¼šè¯',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          permission: 'all'    
        },
        {
          id: 'messages',
          label: 'ç•™è¨€',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>',
          permission: 'all'    
        },
        {
          id: 'ipban',
          label: 'IPå°ç¦',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>',
          permission: 'admin'
        },
        {
          id: 'sms',
          label: 'çŸ­ä¿¡',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
          permission: 'admin'
        },
        {
          id: 'config',
          label: 'é…ç½®',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>',
          permission: 'admin'
        },
        {
          id: 'captcha',
          label: 'éªŒè¯ç ',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
          permission: 'admin'
        },
        {
          id: 'reminders',
          label: 'æé†’',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          permission: 'admin'
        },
        {
          id: 'ssl',
          label: 'HTTPS',
          icon: '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>',
          permission: 'admin'
        }
      ];

      
      
      
      const visibleTabs = allTabs.filter(tab => {
        if (tab.permission === 'all') return true;
        if (tab.permission === 'admin' && (userGroup === 'admin' || userGroup === 'superadmin')) return true;
        return false;
      });

      
      tabsNav.innerHTML = '';

      
      visibleTabs.forEach((tab, index) => {
        
        const button = document.createElement('button');
        
        const isActive = index === 0;
        
        button.className = `px-4 py-2 font-semibold text-xs whitespace-nowrap rounded-lg transition ${isActive
          ? 'text-sky-600 bg-sky-50 border-b-2 border-sky-600'
          : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'
          }`;
        
        button.innerHTML = `${tab.icon}${tab.label}`;
        
        button.onclick = () => switchMobileAdminTab(tab.id, prefix);
        
        tabsNav.appendChild(button);
      });

      
      if (visibleTabs.length > 0) {
        switchMobileAdminTab(visibleTabs[0].id, prefix);
      }
    }

    
    function switchMobileAdminTab(tabId, prefix) {
      
      let tabsNavId, contentId;

      if (prefix === 'mobile-multi-admin') {
        
        tabsNavId = 'mobile-multi-admin-tabs-nav';
        contentId = 'mobile-multi-admin-panel-content';
      } else if (prefix === 'mobile-multi-admin-panel') {
        
        tabsNavId = 'mobile-multi-admin-tabs-nav-panel';
        contentId = 'mobile-multi-admin-content-panel';
      } else if (prefix === 'mobile-admin-panel') {
        
        tabsNavId = 'mobile-admin-tabs-nav-panel';
        contentId = 'mobile-admin-panel-content-panel';
      } else {
        
        tabsNavId = 'mobile-admin-tabs-nav';
        contentId = 'mobile-admin-panel-content';
      }

      
      const tabsNav = document.getElementById(tabsNavId);
      const content = document.getElementById(contentId);

      if (!tabsNav || !content) {
        console.error(`[ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿] æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ : tabsNavId=${tabsNavId}, contentId=${contentId}`);
        return;
      }

      
      
      Array.from(tabsNav.children).forEach(button => {
        
        const buttonText = button.textContent.trim();
        const tabMap = {
          'ç”¨æˆ·': 'users',
          'æƒé™ç»„': 'groups',
          'æ—¥å¿—': 'logs',
          'çŠ¶æ€': 'health',
          'èµ„æ–™': 'profile',
          'ä¼šè¯': 'sessions',
          'ç•™è¨€': 'messages',
          'IPå°ç¦': 'ipban',
          'çŸ­ä¿¡': 'sms',
          'é…ç½®': 'config',
          'éªŒè¯ç ': 'captcha',
          'æé†’': 'reminders',
          'HTTPS': 'ssl'
        };
        const buttonTabId = tabMap[buttonText];

        
        if (buttonTabId === tabId) {
          button.className = 'px-4 py-2 font-semibold text-xs whitespace-nowrap rounded-lg transition text-sky-600 bg-sky-50 border-b-2 border-sky-600';
        } else {
          
          button.className = 'px-4 py-2 font-semibold text-xs whitespace-nowrap rounded-lg transition text-slate-400 hover:text-slate-600 hover:bg-slate-50';
        }
      });

      
      if (prefix === 'mobile-admin-panel') {
        
        const allPanels = [
          'mobile-admin-users-panel-panel',
          'mobile-admin-groups-panel-panel',
          'mobile-admin-logs-panel-panel',
          'mobile-admin-health-panel-panel',
          'mobile-admin-profile-panel-panel',
          'mobile-admin-sessions-panel-panel',
          'mobile-admin-messages-panel-panel',
          'mobile-admin-ipban-panel-panel',
          'mobile-admin-sms-panel-panel',
          'mobile-admin-config-panel-panel',
          'mobile-admin-captcha-panel-panel',
          'mobile-admin-reminders-panel-panel',
          'mobile-admin-ssl-panel-panel'
        ];

        allPanels.forEach(panelId => {
          const panel = document.getElementById(panelId);
          if (panel) panel.classList.add('hidden');
        });

        
        const captchaHistoryPanelMobile = document.getElementById('admin-captcha-history-panel_modal'); 
        if (captchaHistoryPanelMobile) captchaHistoryPanelMobile.classList.add('hidden');
        

        
        const targetPanelId = `mobile-admin-${tabId}-panel-panel`;
        const targetPanel = document.getElementById(targetPanelId);
        if (targetPanel) {
          targetPanel.classList.remove('hidden');
        } else {
          console.warn(`[ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿] æ‰¾ä¸åˆ°ç›®æ ‡é¢æ¿: ${targetPanelId}`);
        }

        
        switch (tabId) {
          case 'users':
            loadAdminUsers();
            setTimeout(() => copyAdminContentToPanelVersion('users'), 500);
            break;
          case 'groups':
            loadAdminGroups();
            setTimeout(() => copyAdminContentToPanelVersion('groups'), 500);
            break;
          case 'logs':
            loadAdminLogs(1);
            setTimeout(() => copyAdminContentToPanelVersion('logs'), 500);
            break;
          case 'health':
            loadHealthStatus();
            setTimeout(() => copyAdminContentToPanelVersion('health'), 500);
            break;
          case 'profile':
            loadPersonalInfo();
            setTimeout(() => copyAdminContentToPanelVersion('profile'), 500);
            break;
          case 'sessions':
            loadAdminSessions();
            setTimeout(() => copyAdminContentToPanelVersion('sessions'), 500);
            break;
          case 'messages':
            loadMessages();
            setTimeout(() => copyAdminContentToPanelVersion('messages'), 600);
            break;
          case 'ipban':
            loadIPBans();
            setTimeout(() => copyAdminContentToPanelVersion('ipban'), 500);
            break;
          case 'sms':
            loadSMSConfig();
            setTimeout(() => copyAdminContentToPanelVersion('sms'), 500);
            break;
          case 'config':
            loadSystemConfig();
            setTimeout(() => copyAdminContentToPanelVersion('config'), 500);
            break;
          case 'captcha':
            
            
            loadCaptchaSettings();

            
            const dateInput = $('captcha-history-date');
            if (dateInput) {
              const today = new Date().toISOString().split('T')[0];
              dateInput.value = today;
            }

            
            loadCaptchaHistory();

            
            setTimeout(() => copyAdminContentToPanelVersion('captcha'), 500);
            break;
          case 'reminders':
            loadReminders();
            setTimeout(() => copyAdminContentToPanelVersion('reminders'), 500);
            break;
          case 'ssl':
            loadSSLInfo();
            setTimeout(() => copyAdminContentToPanelVersion('ssl'), 500);
            break;
        }
        return;
      }

      
      content.innerHTML = '<p class="text-slate-400 text-center py-10 text-sm">åŠ è½½ä¸­...</p>';

      
      
      switch (tabId) {
        case 'users':
          
          
          
          loadAdminUsers();
          
          setTimeout(() => copyAdminContentToMobile('users', contentId), 500);
          break;
        case 'groups':
          
          loadAdminGroups();
          setTimeout(() => copyAdminContentToMobile('groups', contentId), 500);
          break;
        case 'logs':
          
          loadAdminLogs(1);  
          setTimeout(() => copyAdminContentToMobile('logs', contentId), 500);
          break;
        case 'health':
          
          loadHealthStatus();
          setTimeout(() => copyAdminContentToMobile('health', contentId), 500);
          break;
        case 'profile':
          
          loadPersonalInfo();
          setTimeout(() => copyAdminContentToMobile('profile', contentId), 500);
          break;
        case 'sessions':
          
          loadAdminSessions();
          setTimeout(() => copyAdminContentToMobile('sessions', contentId), 500);
          break;
        case 'messages':
          
          loadMessages();
          setTimeout(() => copyAdminContentToMobile('messages', contentId), 600);
          break;
        case 'ipban':
          loadIPBans();
          setTimeout(() => copyAdminContentToMobile('ipban', contentId), 500);
          break;
        case 'sms':
          loadSMSConfig();
          setTimeout(() => copyAdminContentToMobile('sms', contentId), 500);
          break;
        case 'config':
          loadSystemConfig();
          setTimeout(() => copyAdminContentToMobile('config', contentId), 500);
          break;
        case 'captcha':
          
          loadCaptchaSettings();

          
          const dateInputEl = $('captcha-history-date');
          if (dateInputEl) {
            dateInputEl.value = new Date().toISOString().split('T')[0];
          }
          
          loadCaptchaHistory();

          setTimeout(() => copyAdminContentToMobile('captcha', contentId), 500);
          break;
        case 'reminders':
          loadReminders();
          setTimeout(() => copyAdminContentToMobile('reminders', contentId), 500);
          break;
        case 'ssl':
          loadSSLInfo();
          setTimeout(() => copyAdminContentToMobile('ssl', contentId), 500);
          break;
        default:
          content.innerHTML = '<p class="text-slate-400 text-center py-10 text-sm">æœªçŸ¥çš„æ ‡ç­¾é¡µ</p>';
      }
    }

    
    function copyAdminContentToMobile(tabType, mobileContentId) {
      
      const pcContainerMap = {
        'users': 'admin-users-panel_modal',
        'groups': 'admin-groups-panel_modal',
        'logs': 'admin-logs-panel_modal',
        'health': 'admin-health-panel_modal',
        'profile': 'admin-profile-panel_modal',
        'sessions': 'admin-sessions-panel_modal',
        'messages': 'admin-messages-panel_modal',
        'ipban': 'admin-ip-ban-modal',
        'sms': 'admin-sms-config-modal',
        'config': 'admin-config-panel_modal',
        'captcha': 'admin-captcha-panel_modal',
        'reminders': 'admin-reminders-panel_modal',
        'ssl': 'admin-ssl-panel_modal'
      };

      
      const pcContainerId = pcContainerMap[tabType];
      const pcContainer = document.getElementById(pcContainerId);
      const mobileContainer = document.getElementById(mobileContentId);

      if (!pcContainer || !mobileContainer) {
        console.error(`[ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿] æ‰¾ä¸åˆ°å®¹å™¨: PC=${pcContainerId}, Mobile=${mobileContentId}`);
        mobileContainer.innerHTML = '<p class="text-red-500 text-center py-10 text-sm">åŠ è½½å¤±è´¥</p>';
        return;
      }

      
      
      mobileContainer.innerHTML = pcContainer.innerHTML;

      
      mobileContainer.querySelectorAll('button').forEach(btn => {
        
        btn.classList.add('!text-xs', '!py-1', '!px-2');
      });
      mobileContainer.querySelectorAll('h4, h5').forEach(heading => {
        
        heading.classList.add('!text-sm');
      });
    }

    
    function copyAdminContentToPanelVersion(tabType) {
      
      const pcToMobileMap = {
        'users': { pc: 'admin-users-list_modal', mobile: 'mobile-admin-users-list-panel' },
        'groups': { pc: 'admin-groups-list_modal', mobile: 'mobile-admin-groups-list-panel' },
        'logs': { pc: 'admin-logs-content_modal', mobile: 'mobile-admin-logs-content-panel' },
        'health': { pc: 'admin-health-content_modal', mobile: 'mobile-admin-health-content-panel' },
        'profile': { pc: 'admin-profile-content_modal', mobile: 'mobile-admin-profile-content-panel' },
        'sessions': { pc: 'admin-sessions-list_modal', mobile: 'mobile-admin-sessions-list-panel' },
        'messages': { pc: 'admin-messages-list_modal', mobile: 'mobile-admin-messages-list-panel' },
        'ipban': { pc: 'ip-ban-list', mobile: 'mobile-ip-ban-list-panel' },
        'sms': { pc: 'admin-sms-config-modal', mobile: 'mobile-admin-sms-content-panel' },
        'config': { pc: 'admin-config-panel_modal', mobile: 'mobile-admin-config-content-panel' },
        'captcha': { pc: 'admin-captcha-list_modal', mobile: 'mobile-admin-captcha-list-panel' },
        'reminders': { pc: 'admin-reminders-panel_modal', mobile: 'mobile-admin-reminders-content-panel' },
        'ssl': { pc: 'admin-ssl-panel_modal', mobile: 'mobile-admin-ssl-content-panel' }
      };

      const mapping = pcToMobileMap[tabType];
      if (!mapping) {
        logMessage_Error(`[ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿] æœªå®šä¹‰çš„æ ‡ç­¾é¡µç±»å‹: ${tabType}`);
        return;
      }

      
      const pcContainer = document.getElementById(mapping.pc);
      const mobileContainer = document.getElementById(mapping.mobile);

      if (!pcContainer || !mobileContainer) {
        logMessage_Error(`[ç§»åŠ¨ç«¯ç®¡ç†é¢æ¿] æ‰¾ä¸åˆ°å®¹å™¨: PC=${mapping.pc}, Mobile=${mapping.mobile}`);
        if (mobileContainer) {
          mobileContainer.innerHTML = '<p class="text-red-500 text-center py-10 text-xs">åŠ è½½å¤±è´¥</p>';
        }
        return;
      }

      
      mobileContainer.innerHTML = pcContainer.innerHTML;

      
      mobileContainer.querySelectorAll('button').forEach(btn => {
        btn.classList.add('!text-xs', '!py-1', '!px-2');
      });
      mobileContainer.querySelectorAll('h4, h5').forEach(heading => {
        heading.classList.add('!text-xs');
      });
      mobileContainer.querySelectorAll('input, select, textarea').forEach(input => {
        input.classList.add('!text-xs');
      });
    }

    

    
    function addMobileSelectedConfig() {
      
      const select = document.getElementById('multi-config-user-select');
      if (!select || !select.value) {
        showTempMessage('è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„é…ç½®æ–‡ä»¶', 'error');
        return;
      }

      try {
        
        multi_addFromConfig();
        showTempMessage('é…ç½®å·²æ·»åŠ ', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ·»åŠ é…ç½®å¤±è´¥:', error);
        showTempMessage('æ·»åŠ é…ç½®å¤±è´¥', 'error');
      }
    }

    
    async function addMobileAllConfigs() {
      
      const select = document.getElementById('multi-config-user-select');
      if (!select) {
        showTempMessage('æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶é€‰æ‹©å™¨', 'error');
        return;
      }

      
      const options = Array.from(select.options).filter(opt => opt.value);
      if (options.length === 0) {
        showTempMessage('æ²¡æœ‰å¯æ·»åŠ çš„é…ç½®æ–‡ä»¶', 'error');
        return;
      }

      try {
        showTempMessage(`æ­£åœ¨æ·»åŠ  ${options.length} ä¸ªé…ç½®...`, 'info');

        
        for (const option of options) {
          select.value = option.value;  
          await multi_addFromConfig();  
          
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        showTempMessage(`å·²æ·»åŠ  ${options.length} ä¸ªé…ç½®`, 'success');
        
        await mobileRefreshMultiAccounts();
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ‰¹é‡æ·»åŠ é…ç½®å¤±è´¥:', error);
        showTempMessage('æ‰¹é‡æ·»åŠ é…ç½®å¤±è´¥', 'error');
      }
    }

    
    function openManualAccountModal() {
      
      const modal = document.getElementById('mobile-manual-account-modal');
      if (!modal) {
        console.error('[ç§»åŠ¨ç«¯] æ‰¾ä¸åˆ°æ‰‹åŠ¨è´¦å·è¾“å…¥æ¨¡æ€æ¡†');
        return;
      }

      
      const usernameInput = document.getElementById('manual-account-username');
      const passwordInput = document.getElementById('manual-account-password');
      if (usernameInput) usernameInput.value = '';
      if (passwordInput) passwordInput.value = '';

      
      modal.classList.remove('hidden');
      modal.classList.add('show');

      
      setTimeout(() => {
        if (usernameInput) usernameInput.focus();
      }, 100);

      console.log('[ç§»åŠ¨ç«¯] å·²æ‰“å¼€æ‰‹åŠ¨è´¦å·è¾“å…¥æ¨¡æ€æ¡†');
    }

    
    function closeManualAccountModal() {
      
      const modal = document.getElementById('mobile-manual-account-modal');
      if (!modal) {
        return;
      }

      
      modal.classList.add('hidden');
      modal.classList.remove('show');

      
      const usernameInput = document.getElementById('manual-account-username');
      const passwordInput = document.getElementById('manual-account-password');
      if (usernameInput) usernameInput.value = '';
      if (passwordInput) passwordInput.value = '';

      console.log('[ç§»åŠ¨ç«¯] å·²å…³é—­æ‰‹åŠ¨è´¦å·è¾“å…¥æ¨¡æ€æ¡†');
    }

    
    async function confirmManualAccountAdd() {
      
      const usernameInput = document.getElementById('manual-account-username');
      const passwordInput = document.getElementById('manual-account-password');

      if (!usernameInput || !passwordInput) {
        showTempMessage('æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ', 'error');
        return;
      }

      
      const username = usernameInput.value.trim();
      if (!username) {
        showTempMessage('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        usernameInput.focus();
        return;
      }

      
      const password = passwordInput.value;
      if (!password) {
        showTempMessage('è¯·è¾“å…¥å¯†ç ', 'error');
        passwordInput.focus();
        return;
      }

      try {
        
        showTempMessage('æ­£åœ¨æ·»åŠ è´¦å·...', 'info');

        
        
        const result = await callPythonAPI('multi_add_account', {
          username: username,
          password: password,
          
          params: {}
        });

        if (result.success) {
          
          showTempMessage('è´¦å·æ·»åŠ æˆåŠŸ', 'success');

          
          closeManualAccountModal();

          
          await mobileRefreshMultiAccounts();

          console.log(`[ç§»åŠ¨ç«¯] æ‰‹åŠ¨æ·»åŠ è´¦å·æˆåŠŸ: ${username}`);
        } else {
          
          showTempMessage(`æ·»åŠ å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
          console.error('[ç§»åŠ¨ç«¯] æ‰‹åŠ¨æ·»åŠ è´¦å·å¤±è´¥:', result);
        }
      } catch (error) {
        
        console.error('[ç§»åŠ¨ç«¯] æ‰‹åŠ¨æ·»åŠ è´¦å·å¼‚å¸¸:', error);
        showTempMessage('æ·»åŠ è´¦å·æ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }

    
    
    function importMobileAccountList() {
      try {
        
        if (typeof importMultiAccountList === 'function') {
          importMultiAccountList();
          
          
        } else {
          showTempMessage('å¯¼å…¥åŠŸèƒ½æœªå®ç°', 'error');
          console.error('[ç§»åŠ¨ç«¯] importMultiAccountListå‡½æ•°æœªå®šä¹‰');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] å¯¼å…¥è´¦å·åˆ—è¡¨å¤±è´¥:', error);
        showTempMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
      }
    }

    
    async function downloadMobileAccountTemplate() {
      try {
        
        if (typeof multi_downloadTemplate === 'function') {
          await multi_downloadTemplate();
          showTempMessage('æ¨¡æ¿ä¸‹è½½æˆåŠŸ', 'success');
        } else {
          showTempMessage('ä¸‹è½½æ¨¡æ¿åŠŸèƒ½æœªå®ç°', 'error');
          console.error('[ç§»åŠ¨ç«¯] multi_downloadTemplateå‡½æ•°æœªå®šä¹‰');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] ä¸‹è½½æ¨¡æ¿å¤±è´¥:', error);
        showTempMessage('ä¸‹è½½æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
      }
    }

    
    function exportMobileAccountList() {
      try {
        
        if (typeof exportMultiAccountList === 'function') {
          exportMultiAccountList();
        } else {
          showTempMessage('å¯¼å‡ºåŠŸèƒ½æœªå®ç°', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] å¯¼å‡ºè´¦å·åˆ—è¡¨å¤±è´¥:', error);
        showTempMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    
    async function mobileRefreshSelectedAccounts() {
      try {
        
        const selected = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]:checked');
        if (selected.length === 0) {
          showTempMessage('è¯·å…ˆé€‰æ‹©è¦åˆ·æ–°çš„è´¦å·', 'error');
          return;
        }

        showTempMessage(`æ­£åœ¨åˆ·æ–° ${selected.length} ä¸ªè´¦å·...`, 'info');
        
        if (typeof multi_refreshSelected === 'function') {
          await multi_refreshSelected();
          showTempMessage('å·²åˆ·æ–°é€‰ä¸­è´¦å·', 'success');
        } else {
          showTempMessage('åˆ·æ–°åŠŸèƒ½æœªå®ç°', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ·æ–°é€‰ä¸­è´¦å·å¤±è´¥:', error);
        showTempMessage('åˆ·æ–°å¤±è´¥', 'error');
      }
    }

    
    async function deleteMobileSelectedAccounts() {
      try {
        
        const selected = document.querySelectorAll('#mobile-multi-account-list input[type="checkbox"]:checked');
        if (selected.length === 0) {
          showTempMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è´¦å·', 'error');
          return;
        }

        
        showMobileConfirm(
          'ç¡®è®¤åˆ é™¤',
          `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selected.length} ä¸ªè´¦å·å—ï¼Ÿ`,
          async () => {
            try {
              
              if (typeof multi_removeSelected === 'function') {
                await multi_removeSelected(true);
                showTempMessage('å·²åˆ é™¤é€‰ä¸­è´¦å·', 'success');
                
                await mobileRefreshMultiAccounts();
              } else {
                showTempMessage('åˆ é™¤åŠŸèƒ½æœªå®ç°', 'error');
              }
            } catch (error) {
              console.error('[ç§»åŠ¨ç«¯] åˆ é™¤é€‰ä¸­è´¦å·å¤±è´¥:', error);
              showTempMessage('åˆ é™¤å¤±è´¥', 'error');
            }
          }
        );
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ é™¤é€‰ä¸­è´¦å·å¤±è´¥:', error);
        showTempMessage('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    
    async function deleteMobileAllAccounts() {
      try {
        
        showMobileConfirm(
          'ç¡®è®¤åˆ é™¤',
          'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
          async () => {
            try {
              
              if (typeof multi_removeAll === 'function') {
                await multi_removeAll(true);
                showTempMessage('å·²åˆ é™¤æ‰€æœ‰è´¦å·', 'success');
                
                await mobileRefreshMultiAccounts();
              } else {
                showTempMessage('åˆ é™¤åŠŸèƒ½æœªå®ç°', 'error');
              }
            } catch (error) {
              console.error('[ç§»åŠ¨ç«¯] åˆ é™¤æ‰€æœ‰è´¦å·å¤±è´¥:', error);
              showTempMessage('åˆ é™¤å¤±è´¥', 'error');
            }
          }
        );
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åˆ é™¤æ‰€æœ‰è´¦å·å¤±è´¥:', error);
        showTempMessage('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    

    
    function saveMobileMultiGlobalSettings() {
      try {
        
        const container = document.getElementById('mobile-multi-global-params-container');
        if (!container) {
          showTempMessage('æ‰¾ä¸åˆ°å…¨å±€å‚æ•°å®¹å™¨', 'error');
          return;
        }

        
        const params = {};
        container.querySelectorAll('input, select, textarea').forEach(input => {
          const key = input.dataset.key;
          if (!key) return;

          
          if (input.type === 'checkbox') {
            params[key] = input.checked;
          } else if (input.type === 'number') {
            params[key] = parseFloat(input.value) || 0;
          } else {
            params[key] = input.value;
          }
        });

        
        if (typeof callPythonAPI === 'function') {
          Object.keys(params).forEach(key => {
            callPythonAPI('update_param', key, params[key]);
          });
          showTempMessage('å…¨å±€è®¾ç½®å·²ä¿å­˜', 'success');
          console.log('[ç§»åŠ¨ç«¯] å…¨å±€å‚æ•°å·²ä¿å­˜:', params);
        } else {
          showTempMessage('APIä¸å¯ç”¨', 'error');
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] ä¿å­˜å…¨å±€è®¾ç½®å¤±è´¥:', error);
        showTempMessage('ä¿å­˜å¤±è´¥', 'error');
      }
    }

    

    
    function clearMobileMultiLog() {
      try {
        
        const mobileLog = document.getElementById('mobile-multi-log-text');
        if (mobileLog) {
          mobileLog.value = '';
        }

        
        const pcLog = document.getElementById('multi-log-text');
        if (pcLog) {
          pcLog.value = '';
        }

        showTempMessage('æ—¥å¿—å·²æ¸…ç©º', 'success');
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ¸…ç©ºæ—¥å¿—å¤±è´¥:', error);
        showTempMessage('æ¸…ç©ºæ—¥å¿—å¤±è´¥', 'error');
      }
    }

    
    function scrollMobileMultiLogToBottom() {
      try {
        
        const mobileLog = document.getElementById('mobile-multi-log-text');
        if (mobileLog) {
          
          mobileLog.scrollTop = mobileLog.scrollHeight;
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] æ»šåŠ¨æ—¥å¿—å¤±è´¥:', error);
      }
    }

    
    function syncMultiLogToMobile() {
      try {
        
        const pcLog = document.getElementById('multi-log-text');
        const mobileLog = document.getElementById('mobile-multi-log-text');

        
        if (pcLog && mobileLog) {
          
          if (pcLog.value !== mobileLog.value) {
            mobileLog.value = pcLog.value;
            
            
          }
        }
      } catch (error) {
        console.error('[ç§»åŠ¨ç«¯] åŒæ­¥æ—¥å¿—å¤±è´¥:', error);
      }
    }

    
    
    setInterval(syncMultiLogToMobile, 1000);

    console.log('[ç§»åŠ¨ç«¯] Phase 4dåŠŸèƒ½å·²åŠ è½½å®Œæˆ');

    

    

    
    let currentHistoryTaskId = null;

    
    async function openMobileHistoryModal(taskId, taskName) {
      
      currentHistoryTaskId = taskId;

      
      const modal = document.getElementById('mobile-history-modal');
      const taskNameEl = document.getElementById('mobile-history-task-name');
      const listContent = document.getElementById('mobile-history-list-content');

      if (!modal) return;

      
      modal.classList.remove('hidden');

      
      if (taskNameEl) {
        taskNameEl.textContent = taskName || 'æœªçŸ¥ä»»åŠ¡';
      }

      
      if (listContent) {
        listContent.innerHTML = '<p class="text-slate-400 text-center py-10">åŠ è½½ä¸­...</p>';
      }

      try {
        
        const response = await fetch(`/api/history/${taskId}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('è·å–å†å²è®°å½•å¤±è´¥');
        }

        const data = await response.json();

        
        if (data && data.history && data.history.length > 0) {
          let html = '';
          data.history.forEach((record, index) => {
            
            const date = new Date(record.timestamp);
            const timeStr = date.toLocaleString('zh-CN');

            
            const distKm = (record.distance / 1000).toFixed(2);
            const minutes = Math.floor(record.duration / 60);
            const seconds = record.duration % 60;
            const durationStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            
            const statusColors = {
              'completed': 'green',
              'failed': 'red',
              'partial': 'orange'
            };
            const statusColor = statusColors[record.status] || 'slate';

            
            const statusTexts = {
              'completed': 'å·²å®Œæˆ',
              'failed': 'å¤±è´¥',
              'partial': 'éƒ¨åˆ†å®Œæˆ'
            };
            const statusText = statusTexts[record.status] || record.status;

            
            html += `
              <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 transition"
                onclick="openMobileTrackModal('${record.id}', '${record.task_id}')">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-slate-600">${timeStr}</span>
                  <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${statusColor}-100 text-${statusColor}-700">${statusText}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center">
                  <div>
                    <p class="text-xs text-slate-500">è·ç¦»</p>
                    <p class="font-bold text-sm text-blue-600">${distKm} km</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-500">æ—¶é•¿</p>
                    <p class="font-bold text-sm text-green-600">${durationStr}</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-500">é…é€Ÿ</p>
                    <p class="font-bold text-sm text-purple-600">${record.pace || '--:--'}</p>
                  </div>
                </div>
              </div>
            `;
          });
          listContent.innerHTML = html;
        } else {
          listContent.innerHTML = '<p class="text-slate-400 text-center py-10">æš‚æ— å†å²è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
        if (listContent) {
          listContent.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥: ${error.message}</p>`;
        }
      }
    }

    
    function closeMobileHistoryModal() {
      const modal = document.getElementById('mobile-history-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
      currentHistoryTaskId = null;
    }

    

    
    let mobileTrackMapInstance = null;
    let mobileTrackPolyline = null;
    let mobileTrackMarkers = [];

    
    async function openMobileTrackModal(recordId, taskId) {
      
      const modal = document.getElementById('mobile-track-modal');
      if (!modal) return;

      
      modal.classList.remove('hidden');
      
      
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);

      
      await initMobileTrackMap();

      try {
        
        const response = await fetch(`/api/get_historical_track?task_id=${taskId}&record_id=${recordId}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('è·å–è·¯å¾„æ•°æ®å¤±è´¥');
        }

        const data = await response.json();

        
        const timeEl = document.getElementById('mobile-track-time');
        const distEl = document.getElementById('mobile-track-distance');
        const durEl = document.getElementById('mobile-track-duration');
        const paceEl = document.getElementById('mobile-track-pace');

        if (timeEl && data.timestamp) {
          const date = new Date(data.timestamp);
          timeEl.textContent = date.toLocaleString('zh-CN');
        }

        if (distEl && data.distance) {
          distEl.textContent = `${(data.distance / 1000).toFixed(2)} km`;
        }

        if (durEl && data.duration) {
          const min = Math.floor(data.duration / 60);
          const sec = data.duration % 60;
          durEl.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        if (paceEl && data.pace) {
          paceEl.textContent = data.pace;
        }

        
        if (mobileTrackMapInstance && data.path && data.path.length > 0) {
          
          clearMobileTrackMap();

          
          const path = data.path.map(p => new AMapInstance.LngLat(p[0], p[1]));

          
          mobileTrackPolyline = new AMapInstance.Polyline({
            path: path,
            strokeColor: '#3b82f6',
            strokeWeight: 4,
            strokeOpacity: 0.8,
            map: mobileTrackMapInstance
          });

          
          if (path.length > 0) {
            const startMarker = new AMapInstance.Marker({
              position: path[0],
              icon: new AMapInstance.Icon({
                image: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http:
                size: new AMapInstance.Size(32, 32)
              }),
              map: mobileTrackMapInstance
            });
            mobileTrackMarkers.push(startMarker);
          }

          
          if (path.length > 1) {
            const endMarker = new AMapInstance.Marker({
              position: path[path.length - 1],
              icon: new AMapInstance.Icon({
                image: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http:
                size: new AMapInstance.Size(32, 32)
              }),
              map: mobileTrackMapInstance
            });
            mobileTrackMarkers.push(endMarker);
          }

          
          if (data.checkpoints && data.checkpoints.length > 0) {
            data.checkpoints.forEach((cp, idx) => {
              const marker = new AMapInstance.Marker({
                position: new AMapInstance.LngLat(cp[0], cp[1]),
                icon: new AMapInstance.Icon({
                  image: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http:
                  size: new AMapInstance.Size(28, 28)
                }),
                map: mobileTrackMapInstance
              });
              mobileTrackMarkers.push(marker);
            });
          }

          
          mobileTrackMapInstance.setFitView();
        }
      } catch (error) {
        console.error('åŠ è½½è·¯å¾„å¤±è´¥:', error);
        showTempMessage('åŠ è½½è·¯å¾„å¤±è´¥: ' + error.message, 'error');
      }
    }

    
    async function initMobileTrackMap() {
      
      if (mobileTrackMapInstance) return;

      
      if (!AMapInstance) {

        console.error('é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
        return;
      }

      try {
        
        mobileTrackMapInstance = new AMapInstance.Map('mobile-track-map-container', {
          viewMode: '2D',
          zoom: 15,
          center: [113.390342, 22.527403]
        });
      } catch (error) {
        console.error('åˆå§‹åŒ–è·¯å¾„åœ°å›¾å¤±è´¥:', error);
      }
    }

    
    function clearMobileTrackMap() {
      
      if (mobileTrackPolyline) {
        mobileTrackPolyline.setMap(null);
        mobileTrackPolyline = null;
      }

      
      mobileTrackMarkers.forEach(marker => {
        marker.setMap(null);
      });
      mobileTrackMarkers = [];
    }

    
    function closeMobileTrackModal() {
      const modal = document.getElementById('mobile-track-modal');
      if (modal) {
        
        modal.classList.remove('show');
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 300); 
      }

      
      clearMobileTrackMap();

      
      if (mobileTrackMapInstance) {
        mobileTrackMapInstance.destroy();
        mobileTrackMapInstance = null;
      }
    }

    
    function mobileTrackZoomIn() {
      if (mobileTrackMapInstance) {
        mobileTrackMapInstance.zoomIn();
      }
    }

    function mobileTrackZoomOut() {
      if (mobileTrackMapInstance) {
        mobileTrackMapInstance.zoomOut();
      }
    }

    function mobileTrackFitView() {
      if (mobileTrackMapInstance) {
        mobileTrackMapInstance.setFitView();
      }
    }

    

    
    let mobileMapAttendanceInstance = null;  
    let mobileMapAttendanceMarker = null;    
    let mobileMapAttendanceNoticeId = null;  
    let mobileMapAttendanceTarget = null;    
    let mobileMapAttendanceSelected = null;  

    
    async function openMobileMapAttendanceModal(noticeId, targetCoords) {
      console.log('[åœ°å›¾é€‰ç‚¹] æ‰“å¼€æ¨¡æ€æ¡†', { noticeId, targetCoords });

      
      mobileMapAttendanceNoticeId = noticeId;
      mobileMapAttendanceTarget = targetCoords;
      mobileMapAttendanceSelected = null;

      
      const modal = document.getElementById('mobile-map-attendance-modal');
      if (!modal) {
        console.error('[åœ°å›¾é€‰ç‚¹] æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
        return;
      }
      modal.classList.remove('hidden');

      
      const coordsDisplay = document.getElementById('mobile-map-attendance-coords');
      const confirmBtn = document.getElementById('mobile-map-attendance-confirm-btn');
      if (coordsDisplay) coordsDisplay.textContent = 'æœªé€‰æ‹©';
      if (confirmBtn) confirmBtn.disabled = true;

      
      setTimeout(() => {
        initMobileMapAttendance(targetCoords);
      }, 300);
    }

    
    async function initMobileMapAttendance(targetCoords) {
      console.log('[åœ°å›¾é€‰ç‚¹] åˆå§‹åŒ–åœ°å›¾', targetCoords);

      
      if (mobileMapAttendanceInstance) {
        mobileMapAttendanceInstance.destroy();
        mobileMapAttendanceInstance = null;
      }

      
      if (typeof AMap === 'undefined') {
        console.error('[åœ°å›¾é€‰ç‚¹] é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
        showTempMessage('åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }

      
      const container = document.getElementById('mobile-map-attendance-container');
      if (!container) {
        console.error('[åœ°å›¾é€‰ç‚¹] åœ°å›¾å®¹å™¨ä¸å­˜åœ¨');
        return;
      }

      
      container.innerHTML = '';

      try {
        
        mobileMapAttendanceInstance = new AMap.Map('mobile-map-attendance-container', {
          zoom: 17,  
          center: targetCoords,  
          mapStyle: 'amap:
          showLabel: true,  
          viewMode: '2D'  
        });

        console.log('[åœ°å›¾é€‰ç‚¹] åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸ');

        
        const targetMarker = new AMap.Marker({
          position: targetCoords,
          icon: new AMap.Icon({
            size: new AMap.Size(32, 32),  
            image: 'data:image/svg+xml;base64,' + btoa(`
              <svg xmlns="http:
                <circle cx="16" cy="16" r="14" fill="#3b82f6" stroke="white" stroke-width="3"/>
                <text x="16" y="21" text-anchor="middle" fill="white" font-size="18" font-weight="bold">ğŸ¯</text>
              </svg>
            `),
            imageSize: new AMap.Size(32, 32)
          }),
          title: 'ç›®æ ‡ç­¾åˆ°ä½ç½®',
          zIndex: 100
        });

        
        mobileMapAttendanceInstance.add(targetMarker);

        
        mobileMapAttendanceInstance.on('click', (e) => {
          const lng = e.lnglat.getLng();
          const lat = e.lnglat.getLat();
          console.log('[åœ°å›¾é€‰ç‚¹] ç”¨æˆ·ç‚¹å‡»ä½ç½®', { lng, lat });

          
          mobileMapAttendanceSelected = [lng, lat];

          
          const coordsDisplay = document.getElementById('mobile-map-attendance-coords');
          if (coordsDisplay) {
            coordsDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          }

          
          const confirmBtn = document.getElementById('mobile-map-attendance-confirm-btn');
          if (confirmBtn) {
            confirmBtn.disabled = false;
          }

          
          if (mobileMapAttendanceMarker) {
            mobileMapAttendanceInstance.remove(mobileMapAttendanceMarker);
          }

          
          mobileMapAttendanceMarker = new AMap.Marker({
            position: [lng, lat],
            icon: new AMap.Icon({
              size: new AMap.Size(40, 40),
              image: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http:
                  <circle cx="20" cy="20" r="18" fill="#ef4444" stroke="white" stroke-width="4"/>
                  <text x="20" y="26" text-anchor="middle" fill="white" font-size="22" font-weight="bold">ğŸ“</text>
                </svg>
              `),
              imageSize: new AMap.Size(40, 40)
            }),
            title: 'é€‰ä¸­çš„ç­¾åˆ°ä½ç½®',
            zIndex: 110
          });

          
          mobileMapAttendanceInstance.add(mobileMapAttendanceMarker);
        });

        console.log('[åœ°å›¾é€‰ç‚¹] åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·é€‰ç‚¹');

      } catch (error) {
        console.error('[åœ°å›¾é€‰ç‚¹] åœ°å›¾åˆå§‹åŒ–å¤±è´¥', error);
        showTempMessage('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
      }
    }

    
    async function confirmMobileMapAttendance() {
      console.log('[åœ°å›¾é€‰ç‚¹] ç¡®è®¤ç­¾åˆ°', {
        noticeId: mobileMapAttendanceNoticeId,
        selected: mobileMapAttendanceSelected
      });

      
      if (!mobileMapAttendanceSelected) {
        showTempMessage('è¯·å…ˆåœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ç­¾åˆ°ä½ç½®', 'warning');
        return;
      }

      
      const confirmBtn = document.getElementById('mobile-map-attendance-confirm-btn');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="animate-pulse">ç­¾åˆ°ä¸­...</span>';
      }

      try {
        
        const result = await callPythonAPI('sign_in', {
          notice_id: mobileMapAttendanceNoticeId,
          longitude: mobileMapAttendanceSelected[0],
          latitude: mobileMapAttendanceSelected[1]
        });

        console.log('[åœ°å›¾é€‰ç‚¹] ç­¾åˆ°APIè¿”å›', result);

        if (result.success) {
          showTempMessage('âœ… ç­¾åˆ°æˆåŠŸï¼', 'success');

          
          closeMobileMapAttendanceModal();

          
          setTimeout(() => {
            refreshNotificationsUI(true, true);
          }, 1000);
        } else {
          showTempMessage('âŒ ç­¾åˆ°å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');

          
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = `
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                ç¡®è®¤ç­¾åˆ°
              </span>
            `;
          }
        }
      } catch (error) {
        console.error('[åœ°å›¾é€‰ç‚¹] ç­¾åˆ°å¤±è´¥', error);
        showTempMessage('ç­¾åˆ°å¤±è´¥ï¼š' + error.message, 'error');

        
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = `
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
              ç¡®è®¤ç­¾åˆ°
            </span>
          `;
        }
      }
    }

    
    function closeMobileMapAttendanceModal() {
      console.log('[åœ°å›¾é€‰ç‚¹] å…³é—­æ¨¡æ€æ¡†');

      
      const modal = document.getElementById('mobile-map-attendance-modal');
      if (modal) {
        modal.classList.add('hidden');
      }

      
      if (mobileMapAttendanceMarker) {
        if (mobileMapAttendanceInstance) {
          mobileMapAttendanceInstance.remove(mobileMapAttendanceMarker);
        }
        mobileMapAttendanceMarker = null;
      }

      if (mobileMapAttendanceInstance) {
        mobileMapAttendanceInstance.destroy();
        mobileMapAttendanceInstance = null;
      }

      
      mobileMapAttendanceNoticeId = null;
      mobileMapAttendanceTarget = null;
      mobileMapAttendanceSelected = null;
    }

    

    
    let taskLongPressTimer = null;
    let taskLongPressed = false;

    
    function attachTaskTouchHandlers(taskItem, taskData) {
      if (!taskItem) return;

      
      taskItem.addEventListener('touchstart', (e) => {
        taskLongPressed = false;

        
        taskLongPressTimer = setTimeout(() => {
          taskLongPressed = true;
          
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          
          openMobileHistoryModal(taskData.id, taskData.name);
        }, 500);
      });

      
      taskItem.addEventListener('touchmove', () => {
        if (taskLongPressTimer) {
          clearTimeout(taskLongPressTimer);
          taskLongPressTimer = null;
        }
      });

      
      taskItem.addEventListener('touchend', (e) => {
        
        if (taskLongPressTimer) {
          clearTimeout(taskLongPressTimer);
          taskLongPressTimer = null;
        }

        
        if (taskLongPressed) {
          e.preventDefault();
          return;
        }

        
        showMobileTaskDetails(taskData);
      });

      
      taskItem.addEventListener('touchcancel', () => {
        if (taskLongPressTimer) {
          clearTimeout(taskLongPressTimer);
          taskLongPressTimer = null;
        }
      });
    }

    
    function showMobileTaskDetails(taskData) {
      const modal = document.getElementById('mobile-task-details-modal');
      const content = document.getElementById('mobile-task-details-content');

      if (!modal || !content) return;

      
      let html = `
        <div class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-sky-50 rounded-lg">
            <span class="text-sm text-slate-600">ä»»åŠ¡åç§°</span>
            <span class="font-semibold text-slate-800">${taskData.name || 'æœªå‘½å'}</span>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div class="p-3 bg-blue-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">è·ç¦»</p>
              <p class="font-bold text-lg text-blue-600">${taskData.distance ? (taskData.distance / 1000).toFixed(2) : '--'} km</p>
            </div>
            <div class="p-3 bg-green-50 rounded-lg text-center">
              <p class="text-xs text-slate-500 mb-1">æ—¶é•¿</p>
              <p class="font-bold text-lg text-green-600">${taskData.duration || '--:--'}</p>
            </div>
          </div>
          
          <div class="p-3 bg-slate-50 rounded-lg">
            <p class="text-xs text-slate-500 mb-1">çŠ¶æ€</p>
            <p class="font-semibold text-slate-800">${taskData.status || 'æœªçŸ¥'}</p>
          </div>
          
          ${taskData.description ? `
          <div class="p-3 bg-slate-50 rounded-lg">
            <p class="text-xs text-slate-500 mb-1">æè¿°</p>
            <p class="text-sm text-slate-700">${taskData.description}</p>
          </div>
          ` : ''}
        </div>
      `;

      content.innerHTML = html;

      
      modal.classList.remove('hidden');
    }

    
    function toggleMobileTaskDetails(show) {
      const modal = document.getElementById('mobile-task-details-modal');
      if (!modal) return;

      if (show) {
        modal.classList.remove('hidden');
      } else {
        modal.classList.add('hidden');
      }
    }

    console.log('[ç§»åŠ¨ç«¯] Phase 4cåŠŸèƒ½å·²åŠ è½½');
  </script>

  <script>
    
    window.addEventListener('beforeunload', () => {
      
      
      if (multiAccountAutoRefreshInterval) {
        clearInterval(multiAccountAutoRefreshInterval);
        multiAccountAutoRefreshInterval = null;
      }
    });
  </script>



</body>

</html>